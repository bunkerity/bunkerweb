
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation of BunkerWeb, the open source and next generation WAF.">
      
      
      
        <link rel="canonical" href="https://docs.bunkerweb.io/latest/print_page/">
      
      
      
      
      <link rel="icon" href="../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Print Site - BunkerWeb 文档</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
    <script async
            defer
            data-domain="docs.bunkerweb.io"
            src="https://data.bunkerity.com/js/script.js"></script>

    <script defer>
      window.addEventListener('DOMContentLoaded', (e) => {

        const customHeaders = document.querySelectorAll('[data-custom-header]')
        customHeaders.forEach(header => {
          const getHeaders = document.querySelectorAll(`#${header.getAttribute('id')}`);
          getHeaders.forEach(el => {

            if(!el.hasAttribute('data-custom-header')) el.remove()
        })})
      })
    </script>

    <script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script>

    <script defer>
  // Lazy load images and embed youtube videos
  window.addEventListener("load", () => {
    document.querySelectorAll("[data-src]").forEach((el) => {
      el.setAttribute("src", el.getAttribute("data-src"));
    });
  });
  // Add missing label
  try {
    document
      .querySelector('div.md-search[data-md-component="search"][role="dialog"]')
      .setAttribute("aria-label", "Search in documentation");
  } catch (err) {}
    </script>

    <script defer>
      window.addEventListener('DOMContentLoaded', () => {
        const bannerEl = document.querySelector('aside.md-banner');
        let defaultContent = [{ "content" : '<p>Get the most of BunkerWeb by upgrading to the PRO version. Click <a style="text-decoration:underline; color :  white;" href="https://panel.bunkerweb.io/store/bunkerweb-pro?utm_campaign=self&utm_source=doc">here</a> and use the <strong>freetrial</strong> promo code to get started.</p>'},
        { "content" : '<p>Need premium support or tailored consulting around BunkerWeb ? Check out our <a style="text-decoration:underline; color :  white;" href="https://panel.bunkerweb.io/?utm_campaign=self&utm_source=doc#services">professional services</a>.</p>'},
        { "content" : '<p>Be part of the Bunker community by joining the <a style="text-decoration:underline; color: white;" href="https://discord.bunkerweb.io">Discord chat</a> and following us on <a style="text-decoration:underline; color: white;" href="https://www.linkedin.com/company/bunkerity/">LinkedIn</a>.</p>'}
        ]

      function setBannerStyle() {
        const bannerItem = bannerEl.querySelector('.md-banner__inner');
        bannerEl.style.backgroundColor = "#2eac68";
        bannerItem.style.textAlign = "center";
        bannerItem.style.transition = "all 0.5s ease-out";
      }

      function setDefault() {
        const bannerItem = bannerEl.querySelector('.md-banner__inner');
        const clone = bannerItem.cloneNode(true);
        clone.innerHTML = defaultContent[0]["content"];
        bannerEl.replaceChild(clone, bannerItem);
      }

      function startBannerLoop() {
        const switchDelay = 7000;
        let i = 0;

        setInterval(() => {
          // Update or reset index
          if(i + 1 === defaultContent.length) {
            i = 0;
          } else {
            i++;
          }

          // Prepare data with next el with opacity 0 too
          const currItem = bannerEl.querySelector('.md-banner__inner');
          currItem.style.opacity = 0;
          const clone = currItem.cloneNode(true);
          clone.innerHTML = defaultContent[i]["content"];
          setTimeout(() => {
            bannerEl.replaceChild(clone, currItem);
            setTimeout(() => {
              const newItem = bannerEl.querySelector('.md-banner__inner');
              newItem.style.opacity = 1;
            }, 20);
          }, 600);

        }, switchDelay);
      }

      function runBanner() {
        startBannerLoop();
        // Try to get dynamic content
        // Else keep static ones
        // fetch("https://www.bunkerweb.io/api/bw-ui-news")
        // .then((res) => {
        //   return res.json();
        // })
        // .then((res) => {
        //   defaultContent = res.data[0].data;
        //   startBannerLoop();
        // })
        // .catch((e) => {
        //   startBannerLoop();
        // });
      }

        setBannerStyle();
        setDefault();
        runBanner()

      })
    </script>

    
      
    
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
      <link rel="stylesheet" href="../assets/extra.css">
    
    <script>__md_scope=new URL("/latest",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            remove_material_navigation();remove_mkdocs_theme_navigation();generate_toc();
        })
        </script>
        </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#zh" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
    📢 Looking for BunkerWeb PRO version, technical support or tailored services ? Visit the
    <a href="https://panel.bunkerweb.io/?utm_campaign=self&utm_source=doc"
       style="color: #3f6ec6;
              text-decoration: underline">BunkerWeb Panel</a>
    for more information on our enterprise offers.

          </div>
          
        </aside>
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
    You're not viewing the
    documentation of the latest version.
    <a href="..//latest">
        <strong>Click here to view latest.</strong>
    </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),base=new URL("/latest"),outdated=__md_get("__outdated",sessionStorage,base);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../zh/" title="BunkerWeb 文档" class="md-header__button md-logo" aria-label="BunkerWeb 文档" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BunkerWeb 文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Print Site
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../web-ui/" hreflang="en" class="md-select__link">
              English - 🇬🇧
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../fr/web-ui/" hreflang="fr" class="md-select__link">
              Français - 🇫🇷
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../de/web-ui/" hreflang="de" class="md-select__link">
              Deutsch - 🇩🇪
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../es/web-ui/" hreflang="es" class="md-select__link">
              Español - 🇪🇸
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../zh/web-ui/" hreflang="zh" class="md-select__link">
              中文 - 🇨🇳
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/bunkerity/bunkerweb" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/" class="md-tabs__link">
        
  
  
    
  
  介绍

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/concepts/" class="md-tabs__link">
        
  
  
    
  
  概念

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/integrations/" class="md-tabs__link">
        
  
  
    
  
  集成

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/quickstart-guide/" class="md-tabs__link">
        
  
  
    
  
  快速入门指南

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/features/" class="md-tabs__link">
        
  
  
    
  
  功能

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/advanced/" class="md-tabs__link">
        
  
  
    
  
  高级用法

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/web-ui/" class="md-tabs__link">
        
  
  
    
  
  Web 界面

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/api/" class="md-tabs__link">
        
  
  
    
  
  API

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/upgrading/" class="md-tabs__link">
        
  
  
    
  
  升级

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/troubleshooting/" class="md-tabs__link">
        
  
  
    
  
  故障排除

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/plugins/" class="md-tabs__link">
        
  
  
    
  
  插件

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/professional-services/" class="md-tabs__link">
        
  
  
    
  
  专业服务

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../zh/about/" class="md-tabs__link">
        
  
  
    
  
  关于

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../zh/" title="BunkerWeb 文档" class="md-nav__button md-logo" aria-label="BunkerWeb 文档" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    BunkerWeb 文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bunkerity/bunkerweb" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    介绍
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    概念
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/integrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    集成
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/quickstart-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速入门指南
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    功能
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/advanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    高级用法
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/web-ui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Web 界面
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/upgrading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    升级
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    故障排除
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/plugins/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    插件
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/professional-services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    专业服务
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关于
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<div id="print-site-page" class="print-site-enumerate-headings print-site-enumerate-figures">
        <section class="print-page">
            <div id="print-page-toc" data-toc-depth="3">
                <nav role='navigation' class='print-page-toc-nav'>
                <h1 class='print-page-toc-title'>Table of Contents</h1>
                </nav>
            </div>
        </section>
        <section class="print-page" id="zh" heading-number="1"><h1 id="zh-_1">简介</h1>
<h2 id="zh-_2">概述</h2>
<figure>
<p><img align="center," alt="概述" src="../assets/img/intro-overview.svg" width="800" />
  </p>
<figcaption>让您的网络服务默认安全！</figcaption>
</figure>
<p>BunkerWeb 是新一代的开源 Web 应用程序防火墙 (WAF)。</p>
<p>作为一款功能齐全的 Web 服务器（底层基于 <a href="https://nginx.org/">NGINX</a>），它能保护您的 Web 服务，使其“默认安全”。BunkerWeb 能够无缝集成到您现有的环境中（<a href="#zh-integrations-linux">Linux</a>、<a href="#zh-integrations-docker">Docker</a>、<a href="#zh-integrations-swarm">Swarm</a>、<a href="#zh-integrations-kubernetes">Kubernetes</a> 等），作为反向代理运行，并且完全可配置（别担心，如果您不喜欢命令行，我们有一个<a href="#zh-web-ui">出色的 Web UI</a>）以满足您的特定用例。换句话说，网络安全不再是件麻烦事。</p>
<p>BunkerWeb 的核心包含主要的<a href="#zh-advanced-security-tuning">安全功能</a>，但借助<a href="#zh-plugins">插件系统</a>，可以轻松扩展其他功能。</p>
<h2 id="zh-bunkerweb">为何选择 BunkerWeb？</h2>
<p align="center">
    <iframe style="display: block;" width="560" height="315" data-src="https://www.youtube-nocookie.com/embed/oybLtyhWJIo" title="BunkerWeb 概述" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>

<ul>
<li>
<p><strong>轻松集成到现有环境</strong>：无缝地将 BunkerWeb 集成到 Linux、Docker、Swarm、Kubernetes 等各种环境中。享受平滑过渡和无忧实施。</p>
</li>
<li>
<p><strong>高度可定制</strong>：轻松地根据您的特定需求定制 BunkerWeb。毫不费力地启用、禁用和配置功能，让您能够根据自己独特的用例自定义安全设置。</p>
</li>
<li>
<p><strong>默认安全</strong>：BunkerWeb 为您的 Web 服务提供开箱即用、无忧的最低限度安全保障。从一开始就体验安心和增强的保护。</p>
</li>
<li>
<p><strong>出色的 Web UI</strong>：通过卓越的 Web 用户界面 (UI) 更有效地控制 BunkerWeb。通过用户友好的图形界面轻松导航设置和配置，无需使用命令行界面 (CLI)。</p>
</li>
<li>
<p><strong>插件系统</strong>：扩展 BunkerWeb 的功能以满足您自己的用例。无缝集成额外的安全措施，并根据您的特定要求自定义 BunkerWeb 的功能。</p>
</li>
<li>
<p><strong>“自由”软件</strong>：BunkerWeb 采用自由的 <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">AGPLv3 许可证</a>，拥抱自由和开放的原则。享受使用、修改和分发该软件的自由，并得到一个支持性社区的支持。</p>
</li>
<li>
<p><strong>专业服务</strong>：直接从 BunkerWeb 的维护者那里获得技术支持、量身定制的咨询和自定义开发。请访问 <a href="https://panel.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板</a>获取更多信息。</p>
</li>
</ul>
<h2 id="zh-_3">安全特性</h2>
<p>探索 BunkerWeb 提供的令人印象深刻的安全特性。虽然并非详尽无遗，但以下是一些值得注意的亮点：</p>
<ul>
<li>
<p><strong>HTTPS</strong> 支持及透明的 <strong>Let's Encrypt</strong> 自动化：通过自动化的 Let's Encrypt 集成，轻松保护您的 Web 服务，确保客户端与服务器之间的通信加密。</p>
</li>
<li>
<p><strong>顶尖的网络安全</strong>：受益于前沿的网络安全措施，包括全面的 HTTP 安全标头、防止数据泄露和 TLS 加固技术。</p>
</li>
<li>
<p>集成 <strong>ModSecurity WAF</strong> 和 <strong>OWASP 核心规则集</strong>：通过集成 ModSecurity，并由著名的 OWASP 核心规则集加固，享受针对 Web 应用程序攻击的增强保护。</p>
</li>
<li>
<p><strong>根据 HTTP 状态码自动封禁</strong>异常行为：BunkerWeb 通过自动封禁触发异常 HTTP 状态码的行为，智能地识别和阻止可疑活动。</p>
</li>
<li>
<p>对客户端施加<strong>连接和请求限制</strong>：对来自客户端的连接和请求数量设置限制，防止资源耗尽，并确保服务器资源的公平使用。</p>
</li>
<li>
<p>通过<strong>基于挑战的验证拦截机器人</strong>：通过挑战机器人解决诸如 Cookie、JavaScript 测试、验证码、hCaptcha、reCAPTCHA 或 Turnstile 等谜题，有效地阻止恶意机器人，防止未经授权的访问。</p>
</li>
<li>
<p>通过外部黑名单和 <strong>DNSBL 拦截已知的恶意 IP</strong>：利用外部黑名单和基于 DNS 的黑洞列表 (DNSBL) 来主动拦截已知的恶意 IP 地址，加强您对潜在威胁的防御。</p>
</li>
<li>
<p><strong>以及更多...</strong>：BunkerWeb 还包含了许多超出此列表的其他安全特性，为您提供全面的保护和安心。</p>
</li>
</ul>
<p>要更深入地了解核心安全特性，我们邀请您探索文档的<a href="#zh-advanced-security-tuning">安全调整</a>部分。了解 BunkerWeb 如何使您能够根据自己的特定需求微调和优化安全措施。</p>
<h2 id="zh-_4">演示</h2>
<p align="center">
    <iframe style="display: block;" width="560" height="315" data-src="https://www.youtube-nocookie.com/embed/ZhYV-QELzA4" title="欺骗自动化工具和扫描器" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>

<p>一个受 BunkerWeb 保护的演示网站可在 <a href="https://demo.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc">demo.bunkerweb.io</a> 访问。欢迎访问并进行一些安全测试。</p>
<h2 id="zh-web-ui">Web UI</h2>
<p align="center">
    <iframe style="display: block;" width="560" height="315" data-src="https://www.youtube-nocookie.com/embed/tGS3pzquEjY" title="BunkerWeb Web UI" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>

<p>BunkerWeb 提供了一个可选的<a href="#zh-web-ui">用户界面</a>来管理您的实例及其配置。一个在线的只读演示可在 <a href="https://demo-ui.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc">demo-ui.bunkerweb.io</a> 访问。欢迎您亲自试用。</p>
<h2 id="zh-bunkerweb_1">BunkerWeb 云</h2>
<figure>
<p><img align="center," alt="概述" src="../assets/img/bunkerweb-cloud.webp" width="600" />
  </p>
<figcaption>BunkerWeb 云</figcaption>
</figure>
<p>不想自己托管和管理您的 BunkerWeb 实例吗？您可能会对 BunkerWeb Cloud 感兴趣，这是我们为 BunkerWeb 提供的完全托管的 SaaS 产品。</p>
<p>试试我们的 <a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">BunkerWeb Cloud 服务</a>，您将获得：</p>
<ul>
<li>一个完全托管在我们云端的 BunkerWeb 实例</li>
<li>所有 BunkerWeb 功能，包括 PRO 功能</li>
<li>一个带有仪表板和警报的监控平台</li>
<li>协助您进行配置的技术支持</li>
</ul>
<p>如果您对 BunkerWeb Cloud 服务感兴趣，请随时<a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">联系我们</a>，以便我们讨论您的需求。</p>
<h2 id="zh-pro">PRO 版本</h2>
<div class="admonition tip">
<p class="admonition-title">BunkerWeb PRO 免费试用</p>
<p>想要快速试用 BunkerWeb PRO 一个月吗？在 <a href="https://panel.bunkerweb.io/store/bunkerweb-pro?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板</a>下单时使用代码 <code>freetrial</code>，或者点击<a href="https://panel.bunkerweb.io/cart.php?a=add&amp;pid=19&amp;promocode=freetrial&amp;utm_campaign=self&amp;utm_source=doc">这里</a>直接应用促销代码（将在结账时生效）。</p>
</div>
<p>使用 BunkerWeb 时，您可以选择您想要使用的版本：开源版或 PRO 版。</p>
<p>无论是增强的安全性、丰富的用户体验还是技术监控，BunkerWeb PRO 版本都能让您充分利用 BunkerWeb，满足您的专业需求。</p>
<p>在文档或用户界面中，PRO 功能会用一个皇冠图标 <img src="../zh/assets/img/pro-icon.svg" alt="crown pro icon" height="32px" width="32px"> 标注，以区别于集成在开源版本中的功能。</p>
<p>您可以随时轻松地从开源版本升级到 PRO 版本。过程非常简单：</p>
<ul>
<li>在结账时使用 <code>freetrial</code> 促销代码，在 <a href="https://panel.bunkerweb.io/store/bunkerweb-pro?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板上领取您的免费试用</a></li>
<li>连接到客户区后，复制您的 PRO 许可证密钥</li>
<li>使用 <a href="#zh-web-ui-upgrade-to-pro">Web UI</a> 或<a href="#zh-features-pro">特定设置</a>将您的私钥粘贴到 BunkerWeb 中</li>
</ul>
<p>如果您对 PRO 版本有任何疑问，请随时访问 <a href="https://panel.bunkerweb.io/knowledgebase?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板</a>或<a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">联系我们</a>。</p>
<h2 id="zh-_5">专业服务</h2>
<p>通过直接从项目维护者那里获得专业服务，充分利用 BunkerWeb。从技术支持到量身定制的咨询和开发，我们随时准备协助您保护您的 Web 服务。</p>
<p>您可以通过访问 <a href="https://panel.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板</a>找到更多信息，这是我们为专业服务设立的专用平台。</p>
<p>如果您有任何疑问，请随时<a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">联系我们</a>。我们将非常乐意满足您的需求。</p>
<h2 id="zh-_6">生态系统、社区和资源</h2>
<p>关于 BunkerWeb 的官方网站、工具和资源：</p>
<ul>
<li><a href="https://www.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc"><strong>网站</strong></a>：获取有关 BunkerWeb 的更多信息、新闻和文章。</li>
<li><a href="https://panel.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc"><strong>面板</strong></a>：一个专门用于订购和管理 BunkerWeb 周边专业服务（例如技术支持）的平台。</li>
<li><a href="https://docs.bunkerweb.io"><strong>文档</strong></a>：BunkerWeb 解决方案的技术文档。</li>
<li><a href="https://demo.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc"><strong>演示</strong></a>：BunkerWeb 的演示网站。欢迎尝试攻击以测试该解决方案的稳健性。</li>
<li><a href="https://demo-ui.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc"><strong>Web UI</strong></a>：BunkerWeb Web UI 的在线只读演示。</li>
<li><a href="https://threatmap.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc"><strong>威胁地图</strong></a>：全球 BunkerWeb 实例实时拦截的网络攻击。</li>
</ul>
<p>社区和社交网络：</p>
<ul>
<li><a href="https://discord.com/invite/fTf46FmtyD"><strong>Discord</strong></a></li>
<li><a href="https://www.linkedin.com/company/bunkerity/"><strong>LinkedIn</strong></a></li>
<li><a href="https://x.com/bunkerity"><strong>X (Formerly Twitter)</strong></a></li>
<li><a href="https://www.reddit.com/r/BunkerWeb/"><strong>Reddit</strong></a></li>
</ul></section><section class="print-page" id="zh-concepts" heading-number="2"><h1 id="zh-concepts-_1">概念</h1>
<h2 id="zh-concepts-_2">架构</h2>
<figure>
<p><img align="center," alt="概述" src="../assets/img/concepts.svg" width="600" /></p>
</figure>
<p>在您的基础设施中，BunkerWeb 扮演着位于您 Web 服务之前的反向代理的角色。典型的架构是从互联网访问 BunkerWeb，然后 BunkerWeb 将请求转发到安全网络上的相应应用程序服务。</p>
<p>以这种方式（经典的反向代理架构）使用 BunkerWeb，通过 TLS 卸载和集中式安全策略，可以降低后端服务器的加密开销，从而提高性能，同时确保所有服务的一致访问控制、威胁缓解和合规性强制执行。</p>
<h2 id="zh-concepts-_3">集成</h2>
<p>第一个概念是将 BunkerWeb 集成到目标环境中。我们更喜欢使用“集成”这个词而不是“安装”，因为 BunkerWeb 的目标之一是无缝地集成到现有环境中。</p>
<p>官方支持以下集成：</p>
<ul>
<li><a href="#zh-integrations-docker">Docker</a></li>
<li><a href="#zh-integrations-linux">Linux</a></li>
<li><a href="#zh-integrations-docker-autoconf">Docker autoconf</a></li>
<li><a href="#zh-integrations-kubernetes">Kubernetes</a></li>
<li><a href="#zh-integrations-swarm">Swarm</a></li>
</ul>
<p>如果您认为应该支持新的集成，请不要犹豫，在 GitHub 仓库上开启一个 <a href="https://github.com/bunkerity/bunkerweb/issues">新问题</a>。</p>
<div class="admonition info">
<p class="admonition-title">更进一步</p>
<p>所有 BunkerWeb 集成的技术细节都可以在文档的<a href="#zh-integrations">集成部分</a>中找到。</p>
</div>
<h2 id="zh-concepts-_4">设置</h2>
<div class="admonition tip">
<p class="admonition-title">BunkerWeb PRO 设置</p>
<p>某些插件是为 <strong>PRO 版本</strong>保留的。想快速测试 BunkerWeb PRO 一个月吗？在 <a href="https://panel.bunkerweb.io/store/bunkerweb-pro?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板</a>下单时使用代码 <code>freetrial</code>，或者点击<a href="https://panel.bunkerweb.io/cart.php?a=add&amp;pid=19&amp;promocode=freetrial&amp;utm_campaign=self&amp;utm_source=doc">这里</a>直接应用促销代码（将在结账时生效）。</p>
</div>
<p>一旦 BunkerWeb 集成到您的环境中，您将需要配置它来服务和保护您的 Web 应用程序。</p>
<p>BunkerWeb 的配置是通过我们称之为“设置”或“变量”的东西来完成的。每个设置都由一个名称来标识，例如 <code>AUTO_LETS_ENCRYPT</code> 或 <code>USE_ANTIBOT</code>。您可以为这些设置分配值来配置 BunkerWeb。</p>
<p>这是一个 BunkerWeb 配置的示例：</p>
<div class="highlight"><pre><span></span><code>SERVER_NAME=www.example.com
AUTO_LETS_ENCRYPT=yes
USE_ANTIBOT=captcha
REFERRER_POLICY=no-referrer
USE_MODSECURITY=no
USE_GZIP=yes
USE_BROTLI=no
</code></pre></div>
<p>请注意，如果您正在使用 Web 用户界面，除了“人性化”的标签外，还会显示设置名称：</p>
<figure>
<p><img align="center," alt="概述" src="../assets/img/settings-ui1.png" width="800" />
  </p>
<figcaption>Web UI 中的设置名称</figcaption>
</figure>
<p>您还可以使用搜索栏并直接指定一个设置名称：</p>
<figure>
<p><img align="center," alt="概述" src="../assets/img/settings-ui2.png" width="600" />
  </p>
<figcaption>Web UI 中的设置搜索</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">更进一步</p>
<p>包含描述和可能值的可用设置的完整列表可在文档的<a href="#zh-features">功能部分</a>中找到。</p>
</div>
<h2 id="zh-concepts-_5">多站点模式</h2>
<p>在使用 BunkerWeb 时，理解多站点模式至关重要。由于我们的主要重点是保护 Web 应用程序，我们的解决方案与“虚拟主机”或“vhosts”的概念紧密相连（更多信息请参见<a href="https://en.wikipedia.org/wiki/Virtual_hosting">此处</a>）。这些虚拟主机使得可以从单个实例或集群中提供多个 Web 应用程序。</p>
<p>默认情况下，BunkerWeb 禁用多站点模式。这意味着只提供一个 Web 应用程序，并且所有设置都将应用于它。当您只有一个应用程序需要保护时，这种设置是理想的，因为您不需要关心多站点配置。</p>
<p>然而，当启用多站点模式时，BunkerWeb 能够提供和保护多个 Web 应用程序。每个 Web 应用程序由一个唯一的服务器名称标识，并有自己的一组设置。当您有多个应用程序需要保护，并且您更喜欢使用单个实例（或集群）的 BunkerWeb 时，此模式被证明是有益的。</p>
<p>多站点模式的激活由 <code>MULTISITE</code> 设置控制，可以将其设置为 <code>yes</code> 来启用它，或者设置为 <code>no</code> 来禁用它（默认值）。</p>
<p>BunkerWeb 中的每个设置都有一个特定的上下文，决定了它可以应用在哪里。如果上下文设置为“global”，则该设置不能按服务器或站点应用，而是应用于整个配置。另一方面，如果上下文是“multisite”，则该设置可以全局和按服务器应用。要为特定服务器定义一个多站点设置，只需将服务器名称作为前缀添加到设置名称中。例如，<code>app1.example.com_AUTO_LETS_ENCRYPT</code> 或 <code>app2.example.com_USE_ANTIBOT</code> 是带有服务器名称前缀的设置名称示例。当一个多站点设置在没有服务器前缀的情况下全局定义时，所有服务器都会继承该设置。但是，如果为单个服务器定义了带有服务器名称前缀的相同设置，则该服务器仍然可以覆盖该设置。</p>
<p>理解多站点模式及其相关设置的复杂性，可以使您根据自己的特定要求定制 BunkerWeb 的行为，从而确保为您的 Web 应用程序提供最佳保护。</p>
<p>这是一个多站点 BunkerWeb 配置的示例：</p>
<div class="highlight"><pre><span></span><code>MULTISITE=yes
SERVER_NAME=app1.example.com app2.example.com app3.example.com
AUTO_LETS_ENCRYPT=yes
USE_GZIP=yes
USE_BROTLI=yes
app1.example.com_USE_ANTIBOT=javascript
app1.example.com_USE_MODSECURITY=no
app2.example.com_USE_ANTIBOT=cookie
app2.example.com_WHITELIST_COUNTRY=FR
app3.example.com_USE_BAD_BEHAVIOR=no
</code></pre></div>
<p>请注意，在使用 Web 用户界面时，多站点模式是隐式的。您可以选择直接将配置应用于您的服务，也可以设置一个全局配置，该配置将应用于所有服务（您仍然可以对特定服务直接应用例外）：</p>
<figure>
<p><img align="center," alt="概述" src="../assets/img/ui-multisite.png" width="600" />
  </p>
<figcaption>从 Web UI 将设置应用于所有服务</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">更进一步</p>
<p>您将在文档的<a href="#zh-advanced">高级用法</a>和仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/vtesting/examples">examples</a> 目录中找到多站点模式的具体示例。</p>
</div>
<h2 id="zh-concepts-_6">自定义配置</h2>
<p>为了应对独特的挑战并满足特定的用例，BunkerWeb 提供了自定义配置的灵活性。虽然提供的设置和<a href="#zh-plugins">外部插件</a>涵盖了广泛的场景，但可能存在需要额外定制的情况。</p>
<p>BunkerWeb 基于著名的 NGINX Web 服务器构建，该服务器提供了一个强大的配置系统。这意味着您可以利用 NGINX 的配置功能来满足您的特定需求。自定义 NGINX 配置可以包含在各种<a href="https://docs.nginx.com/nginx/admin-guide/basic-functionality/managing-configuration-files/#contexts">上下文</a>中，例如 HTTP 或服务器，从而允许您根据您的要求微调 BunkerWeb 的行为。无论您需要自定义全局设置还是将配置应用于特定的服务器块，BunkerWeb 都能让您优化其行为，使其与您的用例完美对齐。</p>
<p>BunkerWeb 的另一个不可或缺的组件是 ModSecurity Web 应用程序防火墙。通过自定义配置，您可以灵活地处理误报或添加自定义规则，以进一步增强 ModSecurity 提供的保护。这些自定义配置允许您微调防火墙的行为，并确保其与您的 Web 应用程序的特定要求保持一致。</p>
<p>通过利用自定义配置，您可以解锁一个充满可能性的世界，从而根据您的需求精确地定制 BunkerWeb 的行为和安全措施。无论是调整 NGINX 配置还是微调 ModSecurity，BunkerWeb 都提供了灵活性，以有效地应对您的独特挑战。</p>
<p>通过 Web 用户界面管理自定义配置是通过<strong>配置</strong>菜单完成的：</p>
<figure>
<p><img align="center," alt="概述" src="../assets/img/configs-ui.png" width="800" />
  </p>
<figcaption>从 Web UI 管理自定义配置</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">更进一步</p>
<p>您将在文档的<a href="#zh-advanced-custom-configurations">高级用法</a>和仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/vtesting/examples">examples</a> 目录中找到自定义配置的具体示例。</p>
</div>
<h2 id="zh-concepts-_7">数据库</h2>
<p>BunkerWeb 将其当前配置安全地存储在后端数据库中，该数据库包含平稳运行所需的基本数据。数据库中存储了以下信息：</p>
<ul>
<li>
<p><strong>所有服务的设置</strong>：数据库保存了 BunkerWeb 提供的所有服务的已定义设置。这确保了您的配置和首选项得以保留并随时可用。</p>
</li>
<li>
<p><strong>自定义配置</strong>：您创建的任何自定义配置也存储在后端数据库中。这包括根据您的特定要求量身定制的个性化设置和修改。</p>
</li>
<li>
<p><strong>BunkerWeb 实例</strong>：有关 BunkerWeb 实例的信息，包括其设置和相关详细信息，都存储在数据库中。这便于在适用时轻松管理和监控多个实例。</p>
</li>
<li>
<p><strong>关于作业执行的元数据</strong>：数据库存储与 BunkerWeb 中各种作业执行相关的元数据。这包括有关计划任务、维护过程和其他自动化活动的信息。</p>
</li>
<li>
<p><strong>缓存的文件</strong>：BunkerWeb 利用缓存机制来提高性能。数据库保存缓存的文件，确保高效检索和交付频繁访问的资源。</p>
</li>
</ul>
<p>在底层，每当您编辑设置或添加新配置时，BunkerWeb 都会自动将更改存储在数据库中，从而确保数据的持久性和一致性。BunkerWeb 支持多种后端数据库选项，包括 SQLite、MariaDB、MySQL 和 PostgreSQL。</p>
<p>使用 <code>DATABASE_URI</code> 设置配置数据库非常简单，该设置遵循每种支持的数据库的指定格式：</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>当使用 Docker 集成时，您必须在所有 BunkerWeb 容器（除了 BunkerWeb 容器本身）中设置 <code>DATABASE_URI</code> 环境变量，以确保所有组件都能正确访问数据库。这对于维护系统的完整性和功能至关重要。</p>
<p>在任何情况下，请确保在启动 BunkerWeb 之前设置 <code>DATABASE_URI</code>，因为这是正常运行所必需的。</p>
</div>
<ul>
<li><strong>SQLite</strong>: <code>sqlite:///var/lib/bunkerweb/db.sqlite3</code></li>
<li><strong>MariaDB</strong>: <code>mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db</code></li>
<li><strong>MySQL</strong>: <code>mysql+pymysql://bunkerweb:changeme@bw-db:3306/db</code></li>
<li><strong>PostgreSQL</strong>: <code>postgresql://bunkerweb:changeme@bw-db:5432/db</code></li>
</ul>
<p>通过在配置中指定适当的数据库 URI，您可以将 BunkerWeb 与您首选的数据库后端无缝集成，从而确保高效可靠地存储您的配置数据。</p>
<figure>
<p><img align="center," alt="概述" src="../assets/img/bunkerweb_db.svg" width="800" />
  </p>
<figcaption>数据库模式</figcaption>
</figure>
<h2 id="zh-concepts-_8">调度器</h2>
<p>为了实现无缝协调和自动化，BunkerWeb 采用了一个名为调度器的专门服务。调度器通过执行以下任务，在确保平稳运行方面发挥着至关重要的作用：</p>
<ul>
<li>
<p><strong>存储设置和自定义配置</strong>：调度器负责在后端数据库中存储所有设置和自定义配置。这将配置数据集中起来，使其易于访问和管理。</p>
</li>
<li>
<p><strong>执行各种任务（作业）</strong>：调度器处理各种任务的执行，这些任务被称为作业。这些作业涵盖了一系列活动，例如定期维护、计划更新或 BunkerWeb 所需的任何其他自动化任务。</p>
</li>
<li>
<p><strong>生成 BunkerWeb 配置</strong>：调度器生成一个 BunkerWeb 易于理解的配置。该配置源自存储的设置和自定义配置，确保整个系统协调一致地运行。</p>
</li>
<li>
<p><strong>充当其他服务的中介</strong>：调度器充当中介，促进 BunkerWeb 不同组件之间的通信和协调。它与 Web UI 或 autoconf 等服务接口，确保信息和数据交换的无缝流动。</p>
</li>
</ul>
<p>从本质上讲，调度器是 BunkerWeb 的大脑，负责协调各种操作并确保系统的平稳运行。</p>
<p>根据集成方法的不同，调度器的执行环境可能会有所不同。在基于容器的集成中，调度器在其专用容器中执行，提供了隔离性和灵活性。另一方面，对于基于 Linux 的集成，调度器自包含在 bunkerweb 服务中，简化了部署和管理过程。</p>
<p>通过使用调度器，BunkerWeb 简化了基本任务的自动化和协调，从而实现了整个系统的高效可靠运行。</p>
<p>如果您正在使用 Web 用户界面，您可以通过单击菜单中的<strong>作业</strong>来管理调度器作业：</p>
<figure>
<p><img align="center," alt="概述" src="../assets/img/jobs-ui.png" width="800" />
  </p>
<figcaption>从 Web UI 管理作业</figcaption>
</figure>
<h3 id="zh-concepts-_9">实例健康检查</h3>
<p>自 1.6.0 版本起，调度器内置了一个健康检查系统，用于监控实例的健康状况。如果一个实例变得不健康，调度器将停止向其发送配置。如果该实例恢复健康，调度器将恢复发送配置。</p>
<p>健康检查间隔由 <code>HEALTHCHECK_INTERVAL</code> 环境变量设置，默认值为 <code>30</code>，这意味着调度器将每 30 秒检查一次实例的健康状况。</p>
<h2 id="zh-concepts-_10">模板</h2>
<p>BunkerWeb 利用模板的强大功能来简化配置过程并增强灵活性。模板提供了一种结构化和标准化的方法来定义设置和自定义配置，确保了一致性和易用性。</p>
<ul>
<li>
<p><strong>预定义模板</strong>：社区版提供了三个预定义模板，其中封装了常见的自定义配置和设置。这些模板可作为配置 BunkerWeb 的起点，实现快速设置和部署。预定义的模板如下：</p>
<ul>
<li><strong>low</strong>：一个基本模板，提供 Web 应用程序保护的基本设置。</li>
<li><strong>medium</strong>：一个平衡的模板，提供安全功能和性能优化的组合。</li>
<li><strong>high</strong>：一个高级模板，专注于强大的安全措施和全面的保护。</li>
</ul>
</li>
<li>
<p><strong>自定义模板</strong>：除了预定义模板外，BunkerWeb 还允许用户创建根据其特定要求量身定制的自定义模板。自定义模板可以对设置和自定义配置进行微调，确保 BunkerWeb 与用户的需求完美契合。</p>
</li>
</ul>
<p>使用 Web 用户界面时，当您添加或编辑服务时，可以通过<strong>简单模式</strong>使用模板：</p>
<figure>
<p><img align="center," alt="概述" src="../assets/img/templates-ui.png" width="800" />
  </p>
<figcaption>从 Web UI 使用模板</figcaption>
</figure>
<p><strong>创建自定义模板</strong></p>
<p>创建一个自定义模板是一个简单的过程，涉及以结构化格式定义所需的设置、自定义配置和步骤。</p>
<ul>
<li><strong>模板结构</strong>：自定义模板由一个名称、一系列设置、自定义配置和可选步骤组成。模板结构在符合指定格式的 JSON 文件中定义。自定义模板的关键组件包括：<ul>
<li><strong>设置</strong>：设置由一个名称和相应的值定义。此值将覆盖设置的默认值。<strong>仅支持多站点设置。</strong></li>
<li><strong>配置</strong>：自定义配置是 NGINX 配置文件的路径，该文件将作为自定义配置包含在内。要知道将自定义配置文件放置在何处，请参阅下面插件树的示例。<strong>仅支持多站点配置类型。</strong></li>
<li><strong>步骤</strong>：一个步骤包含一个标题、副标题、设置和自定义配置。每个步骤代表一个配置步骤，用户可以按照该步骤在 Web UI 中根据自定义模板设置 BunkerWeb。</li>
</ul>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title">关于步骤的说明</p>
<p>如果声明了步骤，<strong>则不必在设置和配置部分中包含所有设置和自定义配置</strong>。请记住，当在步骤中声明了设置或自定义配置时，将允许用户在 Web UI 中对其进行编辑。</p>
</div>
<ul>
<li>
<p><strong>模板文件</strong>：自定义模板在插件目录内的 <code>templates</code> 文件夹中的一个符合指定结构的 JSON 文件中定义。模板文件包含一个名称、设置、自定义配置以及根据用户偏好配置 BunkerWeb 所需的步骤。</p>
</li>
<li>
<p><strong>选择模板</strong>：一旦定义了自定义模板，用户就可以在 Web UI 中服务的简单模式配置过程中选择它。也可以使用配置中的 <code>USE_TEMPLATE</code> 设置来选择模板。模板文件的名称（不带 <code>.json</code> 扩展名）应指定为 <code>USE_TEMPLATE</code> 设置的值。</p>
</li>
</ul>
<p>自定义模板文件示例：
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;模板名称&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// 可选</span>
<span class="w">    </span><span class="nt">&quot;settings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;SETTING_1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;值&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;SETTING_2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;值&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="c1">// 可选</span>
<span class="w">    </span><span class="nt">&quot;configs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;modsec/false_positives.conf&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;modsec/non_editable.conf&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;modsec-crs/custom_rules.conf&quot;</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="c1">// 可选</span>
<span class="w">    </span><span class="nt">&quot;steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;标题 1&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;subtitle&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;副标题 1&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;settings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;SETTING_1&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;configs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;modsec-crs/custom_rules.conf&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;标题 2&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;subtitle&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;副标题 2&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;settings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;SETTING_2&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;configs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;modsec/false_positives.conf&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></p>
<p>包含自定义模板的插件树示例：
<div class="highlight"><pre><span></span><code>.
├── plugin.json
└── templates
    ├── my_other_template.json
    ├── my_template
    │   └── configs
    │       ├── modsec
    │       │   ├── false_positives.conf
    │       │   └── non_editable.conf
    │       └── modsec-crs
    │           └── custom_rules.conf
    └── my_template.json
</code></pre></div></p></section><section class="print-page" id="zh-integrations" heading-number="3"><h1 id="zh-integrations-_1">集成</h1>
<h2 id="zh-integrations-bunkerweb">BunkerWeb 云</h2>
<figure>
<p><img align="center," alt="概述" src="../assets/img/bunkerweb-cloud.webp" width="600" />
  </p>
<figcaption>BunkerWeb 云</figcaption>
</figure>
<p>BunkerWeb Cloud 将是开始使用 BunkerWeb 的最简单方式。它为您提供一个完全托管的 BunkerWeb 服务，无需任何麻烦。可以把它想象成一个 BunkerWeb 即服务！</p>
<p>试试我们的 <a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">BunkerWeb Cloud 服务</a>，您将获得：</p>
<ul>
<li>一个完全托管在我们云端的 BunkerWeb 实例</li>
<li>所有 BunkerWeb 功能，包括 PRO 功能</li>
<li>一个带有仪表板和警报的监控平台</li>
<li>协助您进行配置的技术支持</li>
</ul>
<p>如果您对 BunkerWeb Cloud 服务感兴趣，请随时<a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">联系我们</a>，以便我们讨论您的需求。</p>
<h2 id="zh-integrations-aio">一体化 (AIO) 镜像</h2>
<figure>
<p><img align="center," alt="AIO 架构图占位符" src="../assets/img/aio-graph-placeholder.png" width="600" />
  </p>
<figcaption>BunkerWeb 一体化架构 (AIO)</figcaption>
</figure>
<h3 id="zh-integrations-_2">部署</h3>
<p>要部署一体化容器，您只需运行以下命令：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>bunkerity/bunkerweb-all-in-one:1.6.5-rc3
</code></pre></div>
<p>默认情况下，容器暴露：</p>
<ul>
<li>8080/tcp 用于 HTTP</li>
<li>8443/tcp 用于 HTTPS</li>
<li>8443/udp 用于 QUIC</li>
<li>7000/tcp 用于在没有 BunkerWeb 前置的情况下的 Web UI 访问（不建议在生产环境中使用）</li>
<li>当 <code>SERVICE_API=yes</code> 时，8888/tcp 用于 API（内部使用；建议通过 BunkerWeb 作为反向代理暴露，而不是直接发布）</li>
</ul>
<p>一体化镜像内置了几个服务，可以通过环境变量来控制：</p>
<ul>
<li><code>SERVICE_UI=yes</code> (默认) - 启用 Web UI 服务</li>
<li><code>SERVICE_SCHEDULER=yes</code> (默认) - 启用调度器服务</li>
<li><code>SERVICE_API=no</code> (默认) - 启用 API 服务 (FastAPI 控制平面)</li>
<li><code>AUTOCONF_MODE=no</code> (默认) - 启用自动配置服务</li>
<li><code>USE_REDIS=yes</code> (默认) - 启用内置的 <a href="#zh-integrations-redis-集成">Redis</a> 实例</li>
<li><code>USE_CROWDSEC=no</code> (默认) - <a href="#zh-integrations-crowdsec-集成">CrowdSec</a> 集成默认禁用</li>
</ul>
<h3 id="zh-integrations-api">API 集成</h3>
<p>一体化镜像内嵌了 BunkerWeb API。它默认是禁用的，可以通过设置 <code>SERVICE_API=yes</code> 来启用。</p>
<div class="admonition warning">
<p class="admonition-title">安全</p>
<p>API 是一个特权控制平面。不要直接将其暴露在互联网上。请将其保留在内部网络上，使用 <code>API_WHITELIST_IPS</code> 限制源 IP，要求身份验证（<code>API_TOKEN</code> 或 API 用户 + Biscuit），并最好通过 BunkerWeb 作为反向代理在一个难以猜测的路径上访问它。</p>
</div>
<p>快速启用（独立）— 发布 API 端口；仅用于测试：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">SERVICE_API</span><span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">API_WHITELIST_IPS</span><span class="o">=</span><span class="s2">&quot;127.0.0.0/8&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">API_TOKEN</span><span class="o">=</span><span class="s2">&quot;changeme&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">8888</span>:8888/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>bunkerity/bunkerweb-all-in-one:1.6.5-rc3
</code></pre></div>
<p>推荐（在 BunkerWeb 之后）— 不要发布 <code>8888</code>；而是反向代理它：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;www.example.com&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">DISABLE_DEFAULT_SERVER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">USE_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">REVERSE_PROXY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/api-&lt;unguessable&gt;&quot;</span>
<span class="w">      </span><span class="nt">REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://bunkerweb-aio:8888&quot;</span>

<span class="w">  </span><span class="nt">bunkerweb-aio</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-all-in-one:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">SERVICE_API</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">      </span><span class="c1"># 可选地设置一个管理员覆盖令牌</span>
<span class="w">      </span><span class="c1"># API_TOKEN: &quot;changeme&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
</code></pre></div>
<p>有关身份验证、权限 (ACL)、速率限制、TLS 和配置选项的详细信息，请参阅 <a href="#zh-api">API 文档</a>。</p>
<h3 id="zh-integrations-_3">访问设置向导</h3>
<p>默认情况下，当您首次运行 AIO 容器时，设置向导会自动启动。要访问它，请按照以下步骤操作：</p>
<ol>
<li><strong>启动 AIO 容器</strong>，如<a href="#zh-integrations-deployment">上文</a>所述，确保 <code>SERVICE_UI=yes</code> (默认)。</li>
<li>通过您的主要 BunkerWeb 端点<strong>访问 UI</strong>，例如 <code>https://your-domain</code>。</li>
</ol>
<blockquote>
<p>请按照<a href="#zh-quickstart-guide-complete-the-setup-wizard">快速入门指南</a>中的后续步骤设置 Web UI。</p>
</blockquote>
<h3 id="zh-integrations-redis">Redis 集成</h3>
<p>BunkerWeb <strong>一体化</strong>镜像开箱即用地包含了 Redis，用于<a href="#zh-advanced-persistence-of-bans-and-reports">持久化封禁和报告</a>。要管理 Redis：</p>
<ul>
<li>要禁用 Redis，请设置 <code>USE_REDIS=no</code> 或将 <code>REDIS_HOST</code> 指向一个外部主机。</li>
<li>Redis 日志在 Docker 日志和 <code>/var/log/bunkerweb/redis.log</code> 中以 <code>[REDIS]</code> 前缀出现。</li>
</ul>
<h3 id="zh-integrations-crowdsec">CrowdSec 集成</h3>
<p>BunkerWeb <strong>一体化</strong> Docker 镜像完全集成了 CrowdSec——无需额外的容器或手动设置。请按照以下步骤在您的部署中启用、配置和扩展 CrowdSec。</p>
<p>默认情况下，CrowdSec 是<strong>禁用</strong>的。要开启它，只需添加 <code>USE_CROWDSEC</code> 环境变量：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">USE_CROWDSEC</span><span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>bunkerity/bunkerweb-all-in-one:1.6.5-rc3
</code></pre></div>
<ul>
<li>
<p>当 <code>USE_CROWDSEC=yes</code> 时，入口点将：</p>
<ol>
<li><strong>注册</strong>并<strong>启动</strong>本地 CrowdSec 代理（通过 <code>cscli</code>）。</li>
<li><strong>安装或升级</strong>默认的集合和解析器。</li>
<li><strong>配置</strong> <code>crowdsec-bunkerweb-bouncer/v1.6</code> 拦截器。</li>
</ol>
</li>
</ul>
<hr />
<h4 id="zh-integrations-_4">默认集合和解析器</h4>
<p>在首次启动时（或升级后），这些资产会自动安装并保持最新：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>名称</th>
<th>目的</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>集合</strong></td>
<td><code>crowdsecurity/nginx</code></td>
<td>保护 Nginx 服务器免受各种基于 HTTP 的攻击，从暴力破解到注入尝试。</td>
</tr>
<tr>
<td><strong>集合</strong></td>
<td><code>crowdsecurity/appsec-virtual-patching</code></td>
<td>提供一个动态更新的 WAF 风格规则集，针对已知的 CVE，每日自动修补以保护 Web 应用程序免受新发现的漏洞影响。</td>
</tr>
<tr>
<td><strong>集合</strong></td>
<td><code>crowdsecurity/appsec-generic-rules</code></td>
<td>对 <code>crowdsecurity/appsec-virtual-patching</code> 进行补充，提供针对通用应用层攻击模式的启发式规则——例如枚举、路径遍历和自动化探测——填补了尚无 CVE 特定规则的空白。</td>
</tr>
<tr>
<td><strong>解析器</strong></td>
<td><code>crowdsecurity/geoip-enrich</code></td>
<td>用 GeoIP 上下文丰富事件</td>
</tr>
</tbody>
</table>
<details>
<summary><strong>内部工作原理</strong></summary>

入口点脚本调用：

<div class="highlight"><pre><span></span><code>cscli<span class="w"> </span>install<span class="w"> </span>collection<span class="w"> </span>crowdsecurity/nginx
cscli<span class="w"> </span>install<span class="w"> </span>collection<span class="w"> </span>crowdsecurity/appsec-virtual-patching
cscli<span class="w"> </span>install<span class="w"> </span>collection<span class="w"> </span>crowdsecurity/appsec-generic-rules
cscli<span class="w"> </span>install<span class="w"> </span>parser<span class="w">     </span>crowdsecurity/geoip-enrich
</code></pre></div>

</details>

<hr />
<h4 id="zh-integrations-_5">添加额外的集合</h4>
<p>需要更多的覆盖范围？使用一个以空格分隔的 Hub 集合列表来定义 <code>CROWDSEC_EXTRA_COLLECTIONS</code>：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">USE_CROWDSEC</span><span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">CROWDSEC_EXTRA_COLLECTIONS</span><span class="o">=</span><span class="s2">&quot;crowdsecurity/apache2 crowdsecurity/mysql&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>bunkerity/bunkerweb-all-in-one:1.6.5-rc3
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">内部工作原理</p>
<p>脚本会遍历每个名称并根据需要进行安装或升级——无需手动步骤。</p>
</div>
<hr />
<h4 id="zh-integrations-_6">禁用特定解析器</h4>
<p>如果您想保留默认设置但明确禁用一个或多个解析器，请通过 <code>CROWDSEC_DISABLED_PARSERS</code> 提供一个以空格分隔的列表：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">USE_CROWDSEC</span><span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">CROWDSEC_DISABLED_PARSERS</span><span class="o">=</span><span class="s2">&quot;crowdsecurity/geoip-enrich foo/bar-parser&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>bunkerity/bunkerweb-all-in-one:1.6.5-rc3
</code></pre></div>
<p>注意：
- 该列表在安装/更新所需项目后应用；只有您列出的解析器会被移除。
- 使用 <code>cscli parsers list</code> 显示的 hub slug（例如，<code>crowdsecurity/geoip-enrich</code>）。</p>
<hr />
<h4 id="zh-integrations-appsec">AppSec 开关</h4>
<p>CrowdSec <a href="https://docs.crowdsec.net/docs/appsec/intro/?utm_source=external-docs&amp;utm_medium=cta&amp;utm_campaign=bunker-web-docs">AppSec</a> 功能——由 <code>appsec-virtual-patching</code> 和 <code>appsec-generic-rules</code> 集合提供支持——<strong>默认启用</strong>。</p>
<p>要<strong>禁用</strong>所有 AppSec (WAF/虚拟补丁) 功能，请设置：</p>
<div class="highlight"><pre><span></span><code>-e<span class="w"> </span><span class="nv">CROWDSEC_APPSEC_URL</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
</code></pre></div>
<p>这实际上会关闭 AppSec 端点，因此不会应用任何规则。</p>
<hr />
<h4 id="zh-integrations-crowdsec-api">外部 CrowdSec API</h4>
<p>如果您操作一个远程 CrowdSec 实例，请将容器指向您的 API：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">USE_CROWDSEC</span><span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">CROWDSEC_API</span><span class="o">=</span><span class="s2">&quot;https://crowdsec.example.com:8000&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>bunkerity/bunkerweb-all-in-one:1.6.5-rc3<span class="sb">```</span>

*<span class="w">   </span>当<span class="w"> </span><span class="sb">`</span>CROWDSEC_API<span class="sb">`</span><span class="w"> </span>不是<span class="w"> </span><span class="sb">`</span><span class="m">127</span>.0.0.1<span class="sb">`</span><span class="w"> </span>或<span class="w"> </span><span class="sb">`</span>localhost<span class="sb">`</span><span class="w"> </span>时，将跳过**本地注册**。
*<span class="w">   </span>使用外部<span class="w"> </span>API<span class="w"> </span>时，**AppSec**<span class="w"> </span>默认是禁用的。要启用它，请将<span class="w"> </span><span class="sb">`</span>CROWDSEC_APPSEC_URL<span class="sb">`</span><span class="w"> </span>设置为您期望的端点。
*<span class="w">   </span>拦截器注册仍然会针对远程<span class="w"> </span>API<span class="w"> </span>进行。
*<span class="w">   </span>要重用现有的拦截器密钥，请提供<span class="w"> </span><span class="sb">`</span>CROWDSEC_API_KEY<span class="sb">`</span><span class="w"> </span>并附上您预先生成的令牌。

---

!!!<span class="w"> </span>tip<span class="w"> </span><span class="s2">&quot;更多选项&quot;</span>
<span class="w">    </span>有关所有<span class="w"> </span>CrowdSec<span class="w"> </span>选项的全面介绍（自定义场景、日志、故障排除等），请参阅<span class="w"> </span><span class="o">[</span>BunkerWeb<span class="w"> </span>CrowdSec<span class="w"> </span>插件文档<span class="o">](</span>features.md#crowdsec<span class="o">)</span>或访问<span class="o">[</span>官方<span class="w"> </span>CrowdSec<span class="w"> </span>网站<span class="o">](</span>https://www.crowdsec.net/?utm_source<span class="o">=</span>external-docs<span class="p">&amp;</span><span class="nv">utm_medium</span><span class="o">=</span>cta<span class="p">&amp;</span><span class="nv">utm_campaign</span><span class="o">=</span>bunker-web-docs<span class="o">)</span>。

<span class="c1">## Docker</span>

&lt;figure<span class="w"> </span>markdown&gt;
<span class="w">  </span>!<span class="o">[</span>概述<span class="o">](</span>assets/img/integration-docker.svg<span class="o">){</span><span class="w"> </span><span class="nv">align</span><span class="o">=</span>center,<span class="w"> </span><span class="nv">width</span><span class="o">=</span><span class="s2">&quot;600&quot;</span><span class="w"> </span><span class="o">}</span>
<span class="w">  </span>&lt;figcaption&gt;Docker<span class="w"> </span>集成&lt;/figcaption&gt;
&lt;/figure&gt;

使用<span class="w"> </span>BunkerWeb<span class="w"> </span>作为<span class="w"> </span><span class="o">[</span>Docker<span class="o">](</span>https://www.docker.com/<span class="o">)</span><span class="w"> </span>容器提供了一种方便直接的方法来测试和使用该解决方案，特别是如果您已经熟悉<span class="w"> </span>Docker<span class="w"> </span>技术。

为了方便您的<span class="w"> </span>Docker<span class="w"> </span>部署，我们在<span class="w"> </span><span class="o">[</span>Docker<span class="w"> </span>Hub<span class="o">](</span>https://hub.docker.com/r/bunkerity/bunkerweb<span class="o">)</span><span class="w"> </span>上提供了支持多种架构的预构建镜像。这些预构建镜像经过优化，可用于以下架构：

-<span class="w"> </span>x64<span class="w"> </span><span class="o">(</span>64位<span class="o">)</span>
-<span class="w"> </span>x86
-<span class="w"> </span>armv8<span class="w"> </span><span class="o">(</span>ARM<span class="w"> </span>64位<span class="o">)</span>
-<span class="w"> </span>armv7<span class="w"> </span><span class="o">(</span>ARM<span class="w"> </span>32位<span class="o">)</span>

通过从<span class="w"> </span>Docker<span class="w"> </span>Hub<span class="w"> </span>获取这些预构建镜像，您可以快速在您的<span class="w"> </span>Docker<span class="w"> </span>环境中拉取并运行<span class="w"> </span>BunkerWeb，无需进行广泛的配置或设置过程。这种简化的方法让您能够专注于利用<span class="w"> </span>BunkerWeb<span class="w"> </span>的功能，而无需不必要的复杂性。

无论您是进行测试、开发应用程序还是在生产中部署<span class="w"> </span>BunkerWeb，Docker<span class="w"> </span>容器化选项都提供了灵活性和易用性。采用这种方法使您能够充分利用<span class="w"> </span>BunkerWeb<span class="w"> </span>的功能，同时利用<span class="w"> </span>Docker<span class="w"> </span>技术的优势。

<span class="sb">```</span>shell
docker<span class="w"> </span>pull<span class="w"> </span>bunkerity/bunkerweb:1.6.5-rc3
</code></pre></div>
<p>Docker 镜像也可在 <a href="https://github.com/orgs/bunkerity/packages?repo_name=bunkerweb">GitHub packages</a> 上找到，可以使用 <code>ghcr.io</code> 仓库地址下载：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>pull<span class="w"> </span>ghcr.io/bunkerity/bunkerweb:1.6.5-rc3<span class="sb">```</span>

Docker<span class="w"> </span>集成的关键概念包括：

-<span class="w"> </span>**环境变量**：使用环境变量轻松配置<span class="w"> </span>BunkerWeb。这些变量允许您自定义<span class="w"> </span>BunkerWeb<span class="w"> </span>行为的各个方面，例如网络设置、安全选项和其他参数。
-<span class="w"> </span>**调度器容器**：使用一个名为<span class="o">[</span>调度器<span class="o">](</span>concepts.md#scheduler<span class="o">)</span>的专用容器来管理配置和执行作业。
-<span class="w"> </span>**网络**：Docker<span class="w"> </span>网络在<span class="w"> </span>BunkerWeb<span class="w"> </span>的集成中扮演着至关重要的角色。这些网络有两个主要目的：向客户端公开端口以及连接到上游<span class="w"> </span>Web<span class="w"> </span>服务。通过公开端口，BunkerWeb<span class="w"> </span>可以接受来自客户端的传入请求，允许他们访问受保护的<span class="w"> </span>Web<span class="w"> </span>服务。此外，通过连接到上游<span class="w"> </span>Web<span class="w"> </span>服务，BunkerWeb<span class="w"> </span>可以高效地路由和管理流量，提供增强的安全性和性能。

!!!<span class="w"> </span>info<span class="w"> </span><span class="s2">&quot;数据库后端&quot;</span>
<span class="w">    </span>请注意，我们的说明假设您正在使用<span class="w"> </span>SQLite<span class="w"> </span>作为默认的数据库后端，这是由<span class="w"> </span><span class="sb">`</span>DATABASE_URI<span class="sb">`</span><span class="w"> </span>设置配置的。但是，也支持其他数据库后端。有关更多信息，请参阅仓库的<span class="w"> </span><span class="o">[</span>misc/integrations<span class="w"> </span>文件夹<span class="o">](</span>https://github.com/bunkerity/bunkerweb/tree/v1.6.5-rc3/misc/integrations<span class="o">)</span>中的<span class="w"> </span>docker-compose<span class="w"> </span>文件。

<span class="c1">### 环境变量</span>

设置通过<span class="w"> </span>Docker<span class="w"> </span>环境变量传递给调度器：

<span class="sb">```</span>yaml
...
services:
<span class="w">  </span>bw-scheduler:
<span class="w">    </span>image:<span class="w"> </span>bunkerity/bunkerweb-scheduler:1.6.5-rc3
<span class="w">    </span>environment:
<span class="w">      </span>-<span class="w"> </span><span class="nv">MY_SETTING</span><span class="o">=</span>value
<span class="w">      </span>-<span class="w"> </span><span class="nv">ANOTHER_SETTING</span><span class="o">=</span>another<span class="w"> </span>value
<span class="w">    </span>volumes:
<span class="w">      </span>-<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
...
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">完整列表</p>
<p>有关环境变量的完整列表，请参阅文档的<a href="#zh-features">设置部分</a>。</p>
</div>
<h3 id="zh-integrations-docker-secrets">使用 Docker secrets</h3>
<p>与其通过环境变量传递敏感设置，不如将它们存储为 Docker secrets。对于每个您想要保护的设置，创建一个名称与设置键（大写）匹配的 Docker secret。BunkerWeb 的入口点脚本会自动从 <code>/run/secrets</code> 加载 secrets 并将它们导出为环境变量。</p>
<p>示例：
<div class="highlight"><pre><span></span><code><span class="c1"># 为 ADMIN_PASSWORD 创建一个 Docker secret</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;S3cr3tP@ssw0rd&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>docker<span class="w"> </span>secret<span class="w"> </span>create<span class="w"> </span>ADMIN_PASSWORD<span class="w"> </span>-
</code></pre></div></p>
<p>部署时挂载 secrets：
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">    </span><span class="nt">secrets</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ADMIN_PASSWORD</span>
<span class="nn">...</span>
<span class="nt">secrets</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ADMIN_PASSWORD</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div></p>
<p>这确保了敏感设置不会出现在环境和日志中。</p>
<h3 id="zh-integrations-_7">调度器</h3>
<p><a href="#zh-concepts-scheduler">调度器</a> 在其自己的容器中运行，该容器也可在 Docker Hub 上找到：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>pull<span class="w"> </span>bunkerity/bunkerweb-scheduler:1.6.5-rc3
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">BunkerWeb 设置</p>
<p>自 <code>1.6.0</code> 版本起，调度器容器是您定义 BunkerWeb 设置的地方。然后，调度器将配置推送到 BunkerWeb 容器。</p>
<p>⚠ <strong>重要提示</strong>：所有与 API 相关的设置（例如 <code>API_HTTP_PORT</code>、<code>API_LISTEN_IP</code>、<code>API_SERVER_NAME</code>、<code>API_WHITELIST_IP</code>，如果您使用 <code>API_TOKEN</code> 的话也包括它）<strong>也必须在 BunkerWeb 容器中定义</strong>。这些设置必须在两个容器中保持一致；否则，BunkerWeb 容器将不接受来自调度器的 API 请求。</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-api-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-api-env</span>
<span class="w">  </span><span class="c1"># 我们使用一个锚点来避免在两个容器中重复相同的设置</span>
<span class="w">  </span><span class="nt">API_HTTP_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5000&quot;</span><span class="w"> </span><span class="c1"># 默认值</span>
<span class="w">  </span><span class="nt">API_LISTEN_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0.0.0.0&quot;</span><span class="w"> </span><span class="c1"># 默认值</span>
<span class="w">  </span><span class="nt">API_SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bwapi&quot;</span><span class="w"> </span><span class="c1"># 默认值</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/24</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span><span class="w"> </span><span class="c1"># 根据您的网络设置来配置</span>
<span class="w">  </span><span class="c1"># 可选的令牌；如果设置，调度器会发送 Authorization: Bearer &lt;token&gt;</span>
<span class="w">  </span><span class="nt">API_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 这将为 BunkerWeb 容器设置 API</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 这将为调度器容器设置 API</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="nn">...</span>
</code></pre></div>
</div>
<p>需要一个卷来存储调度器使用的 SQLite 数据库和备份：</p>
<div class="highlight"><pre><span></span><code><span class="nn">...</span>
<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span>
<span class="nn">...</span>
<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">为持久化数据使用本地文件夹</p>
<p>调度器在容器内以<strong>UID 101 和 GID 101 的非特权用户</strong>身份运行。这增强了安全性：万一漏洞被利用，攻击者将不会拥有完全的 root (UID/GID 0) 权限。</p>
<p>但是，如果您为持久化数据使用<strong>本地文件夹</strong>，您必须<strong>设置正确的权限</strong>，以便非特权用户可以向其中写入数据。例如：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chown<span class="w"> </span>root:101<span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-data
</code></pre></div>
<p>或者，如果文件夹已经存在：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span>root:101<span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span>-R<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-data
</code></pre></div>
<p>如果您正在使用<a href="https://docs.docker.com/engine/security/rootless">无根模式的 Docker</a> 或 <a href="https://podman.io/">Podman</a>，容器中的 UID 和 GID 将映射到主机上不同的 UID 和 GID。您首先需要检查您的初始 subuid 和 subgid：</p>
<div class="highlight"><pre><span></span><code>grep<span class="w"> </span>^<span class="k">$(</span>whoami<span class="k">)</span>:<span class="w"> </span>/etc/subuid<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
grep<span class="w"> </span>^<span class="k">$(</span>whoami<span class="k">)</span>:<span class="w"> </span>/etc/subgid
</code></pre></div>
<p>例如，如果您的值为 <strong>100000</strong>，则映射的 UID/GID 将为 <strong>100100</strong> (100000 + 100)：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>chgrp<span class="w"> </span><span class="m">100100</span><span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-data
</code></pre></div>
<p>或者如果文件夹已经存在：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>chgrp<span class="w"> </span>-R<span class="w"> </span><span class="m">100100</span><span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>chmod<span class="w"> </span>-R<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-data
</code></pre></div>
</div>
<h3 id="zh-integrations-_8">网络</h3>
<p>默认情况下，BunkerWeb 容器在（容器内部）<strong>8080/tcp</strong> 端口上监听 <strong>HTTP</strong>，在 <strong>8443/tcp</strong> 端口上监听 <strong>HTTPS</strong>，在 <strong>8443/udp</strong> 端口上监听 <strong>QUIC</strong>。</p>
<div class="admonition warning">
<p class="admonition-title">在无根模式或使用 Podman 时的特权端口</p>
<p>如果您正在使用<a href="https://docs.docker.com/engine/security/rootless">无根模式的 Docker</a> 并希望将特权端口（&lt; 1024），如 80 和 443，重定向到 BunkerWeb，请参阅<a href="https://docs.docker.com/engine/security/rootless/#exposing-privileged-ports">此处</a>的先决条件。</p>
<p>如果您正在使用 <a href="https://podman.io/">Podman</a>，可以降低非特权端口的最小数量：
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>sysctl<span class="w"> </span>net.ipv4.ip_unprivileged_port_start<span class="o">=</span><span class="m">1</span>
</code></pre></div></p>
</div>
<p>使用 Docker 集成时，典型的 BunkerWeb 堆栈包含以下容器：</p>
<ul>
<li>BunkerWeb</li>
<li>调度器</li>
<li>您的服务</li>
</ul>
<p>出于深度防御的目的，我们强烈建议创建至少三个不同的 Docker 网络：</p>
<ul>
<li><code>bw-services</code>：用于 BunkerWeb 和您的 Web 服务</li>
<li><code>bw-universe</code>：用于 BunkerWeb 和调度器</li>
<li><code>bw-db</code>：用于数据库（如果您正在使用）</li>
</ul>
<p>为了保护调度器和 BunkerWeb API 之间的通信，<strong>请授权 API 调用</strong>。使用 <code>API_WHITELIST_IP</code> 设置来指定允许的 IP 地址和子网。为了更强的保护，请在两个容器中设置 <code>API_TOKEN</code>；调度器将自动包含 <code>Authorization: Bearer &lt;token&gt;</code>。</p>
<p><strong>强烈建议为 <code>bw-universe</code> 网络使用静态子网</strong>以增强安全性。通过实施这些措施，您可以确保只有授权的源才能访问 BunkerWeb API，从而降低未经授权的访问或恶意活动的风险：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-api-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-api-env</span>
<span class="w">  </span><span class="c1"># 我们使用一个锚点来避免在两个容器中重复相同的设置</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/24</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">  </span><span class="nt">API_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 可选的 API 令牌</span>
<span class="w">  </span><span class="c1"># 可选的 API 令牌，用于经过身份验证的 API 访问</span>
<span class="w">  </span><span class="nt">API_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w"> </span><span class="c1"># QUIC</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="nn">...</span>
<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span><span class="w"> </span><span class="c1"># 这个设置是强制性的，用来指定 BunkerWeb 实例</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="nn">...</span>
<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span><span class="w"> </span><span class="c1"># 静态子网，以便只有授权的源可以访问 BunkerWeb API</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
<h3 id="zh-integrations-compose">完整的 compose 文件</h3>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-api-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-api-env</span>
<span class="w">  </span><span class="c1"># 我们使用一个锚点来避免在两个容器中重复相同的设置</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/24</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w"> </span><span class="c1"># QUIC</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span><span class="w"> </span><span class="c1"># 这个设置是强制性的，用来指定 BunkerWeb 实例</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;www.example.com&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span><span class="w"> </span><span class="c1"># 静态子网，以便只有授权的源可以访问 BunkerWeb API</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
<h3 id="zh-integrations-_9">从源代码构建</h3>
<p>或者，如果您更喜欢亲自动手，您可以选择直接从<a href="https://github.com/bunkerity/bunkerweb">源代码</a>构建 Docker 镜像。从源代码构建镜像可以让您对部署过程有更大的控制和定制。但是，请注意，这种方法可能需要一些时间才能完成，具体取决于您的硬件配置（如果需要，您可以去喝杯咖啡 ☕）。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/bunkerity/bunkerweb.git<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">cd</span><span class="w"> </span>bunkerweb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>bw<span class="w"> </span>-f<span class="w"> </span>src/bw/Dockerfile<span class="w"> </span>.<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>bw-scheduler<span class="w"> </span>-f<span class="w"> </span>src/scheduler/Dockerfile<span class="w"> </span>.<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>bw-autoconf<span class="w"> </span>-f<span class="w"> </span>src/autoconf/Dockerfile<span class="w"> </span>.<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>bw-ui<span class="w"> </span>-f<span class="w"> </span>src/ui/Dockerfile<span class="w"> </span>.
</code></pre></div>
<h2 id="zh-integrations-linux">Linux</h2>
<figure>
<p><img align="center," alt="概述" src="../assets/img/integration-linux.svg" width="600" />
  </p>
<figcaption>Linux 集成</figcaption>
</figure>
<p>支持 BunkerWeb 的 Linux 发行版（amd64/x86_64 和 arm64/aarch64 架构）包括：</p>
<ul>
<li>Debian 12 "Bookworm"</li>
<li>Debian 13 "Trixie"</li>
<li>Ubuntu 22.04 "Jammy"</li>
<li>Ubuntu 24.04 "Noble"</li>
<li>Fedora 41 和 42</li>
<li>Red Hat Enterprise Linux (RHEL) 8, 9 和 10</li>
</ul>
<h3 id="zh-integrations-_10">简易安装脚本</h3>
<p>为了简化安装体验，BunkerWeb 提供了一个简易安装脚本，可以自动处理整个设置过程，包括 NGINX 安装、仓库配置和服务设置。</p>
<h4 id="zh-integrations-_11">快速开始</h4>
<p>要开始使用，请下载安装脚本及其校验和，然后在运行前验证脚本的完整性。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 下载脚本及其校验和</span>
wget<span class="w"> </span>https://github.com/bunkerity/bunkerweb/releases/download/v1.6.5-rc3/install-bunkerweb.sh
wget<span class="w"> </span>https://github.com/bunkerity/bunkerweb/releases/download/v1.6.5-rc3/install-bunkerweb.sh.sha256

<span class="c1"># 验证校验和</span>
sha256sum<span class="w"> </span>-c<span class="w"> </span>install-bunkerweb.sh.sha256

<span class="c1"># 如果检查成功，则运行脚本</span>
chmod<span class="w"> </span>+x<span class="w"> </span>install-bunkerweb.sh
sudo<span class="w"> </span>./install-bunkerweb.sh
</code></pre></div>
<div class="admonition danger">
<p class="admonition-title">安全提示</p>
<p><strong>在运行安装脚本之前，请务必验证其完整性。</strong></p>
<p>下载校验和文件，并使用像 <code>sha256sum</code> 这样的工具来确认脚本没有被更改或篡改。</p>
<p>如果校验和验证失败，<strong>请不要执行该脚本</strong>——它可能不安全。</p>
</div>
<h4 id="zh-integrations-_12">工作原理</h4>
<p>简易安装脚本是一个强大的工具，旨在简化在全新的 Linux 系统上设置 BunkerWeb 的过程。它会自动执行以下关键步骤：</p>
<ol>
<li><strong>系统分析</strong>：检测您的操作系统并对照支持的发行版列表进行验证。</li>
<li><strong>安装定制</strong>：在交互模式下，它会提示您选择安装类型（一体化、管理器、工作节点等），并决定是否启用基于 Web 的设置向导。</li>
<li><strong>可选集成</strong>：提供自动安装和配置 <a href="#zh-integrations-crowdsec-与脚本的集成">CrowdSec 安全引擎</a>的选项。</li>
<li><strong>依赖管理</strong>：从官方源安装 BunkerWeb 所需的正确版本的 NGINX，并锁定版本以防止意外升级。</li>
<li><strong>BunkerWeb 安装</strong>：添加 BunkerWeb 软件包仓库，安装必要的软件包，并锁定版本。</li>
<li><strong>服务配置</strong>：根据您选择的安装类型设置并启用 <code>systemd</code> 服务。</li>
<li><strong>安装后指导</strong>：提供清晰的后续步骤，帮助您开始使用新的 BunkerWeb 实例。</li>
</ol>
<h4 id="zh-integrations-_13">交互式安装</h4>
<p>当不带任何选项运行时，脚本会进入一个交互模式，引导您完成设置过程。您将被要求做出以下选择：</p>
<ol>
<li><strong>安装类型</strong>：选择您想要安装的组件。<ul>
<li><strong>完整堆栈（默认）</strong>：一个一体化的安装，包括 BunkerWeb、调度器和 Web UI。</li>
<li><strong>管理器</strong>：安装调度器和 Web UI，用于管理一个或多个远程 BunkerWeb 工作节点。</li>
<li><strong>工作节点</strong>：仅安装 BunkerWeb 实例，可由远程管理器管理。</li>
<li><strong>仅调度器</strong>：仅安装调度器组件。</li>
<li><strong>仅 Web UI</strong>：仅安装 Web UI 组件。</li>
</ul>
</li>
<li><strong>设置向导</strong>：选择是否启用基于 Web 的配置向导。强烈建议初次使用的用户选择此项。</li>
<li><strong>CrowdSec 集成</strong>：选择安装 CrowdSec 安全引擎，以获得先进的实时威胁防护。</li>
<li><strong>CrowdSec AppSec</strong>：如果您选择安装 CrowdSec，您还可以启用应用程序安全 (AppSec) 组件，它增加了 WAF 功能。</li>
<li><strong>API 服务</strong>：选择是否启用可选的 BunkerWeb API 服务。在 Linux 安装中，它默认是禁用的。</li>
</ol>
<div class="admonition info">
<p class="admonition-title">管理器和调度器安装</p>
<p>如果您选择<strong>管理器</strong>或<strong>仅调度器</strong>安装类型，系统还会提示您提供您的 BunkerWeb 工作节点实例的 IP 地址或主机名。</p>
</div>
<h4 id="zh-integrations-_14">命令行选项</h4>
<p>对于非交互式或自动化设置，可以使用命令行标志来控制脚本：</p>
<p><strong>通用选项：</strong></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-v, --version VERSION</code></td>
<td>指定要安装的 BunkerWeb 版本（例如 <code>1.6.5-rc3</code>）。</td>
</tr>
<tr>
<td><code>-w, --enable-wizard</code></td>
<td>启用设置向导。</td>
</tr>
<tr>
<td><code>-n, --no-wizard</code></td>
<td>禁用设置向导。</td>
</tr>
<tr>
<td><code>-y, --yes</code></td>
<td>以非交互模式运行，对所有提示使用默认答案。</td>
</tr>
<tr>
<td><code>-f, --force</code></td>
<td>即使在不受支持的操作系统版本上，也强制继续安装。</td>
</tr>
<tr>
<td><code>-q, --quiet</code></td>
<td>静默安装（抑制输出）。</td>
</tr>
<tr>
<td><code>--api</code>, <code>--enable-api</code></td>
<td>启用 API (FastAPI) systemd 服务（默认禁用）。</td>
</tr>
<tr>
<td><code>--no-api</code></td>
<td>明确禁用 API 服务。</td>
</tr>
<tr>
<td><code>-h, --help</code></td>
<td>显示包含所有可用选项的帮助信息。</td>
</tr>
<tr>
<td><code>--dry-run</code></td>
<td>显示将要安装的内容，但不实际执行。</td>
</tr>
</tbody>
</table>
<p><strong>安装类型：</strong></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--full</code></td>
<td>完整堆栈安装（BunkerWeb、调度器、UI）。这是默认选项。</td>
</tr>
<tr>
<td><code>--manager</code></td>
<td>安装调度器和 UI 以管理远程工作节点。</td>
</tr>
<tr>
<td><code>--worker</code></td>
<td>仅安装 BunkerWeb 实例。</td>
</tr>
<tr>
<td><code>--scheduler-only</code></td>
<td>仅安装调度器组件。</td>
</tr>
<tr>
<td><code>--ui-only</code></td>
<td>仅安装 Web UI 组件。</td>
</tr>
</tbody>
</table>
<p><strong>安全集成：</strong></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--crowdsec</code></td>
<td>安装并配置 CrowdSec 安全引擎。</td>
</tr>
<tr>
<td><code>--no-crowdsec</code></td>
<td>跳过 CrowdSec 安装。</td>
</tr>
<tr>
<td><code>--crowdsec-appsec</code></td>
<td>安装带有 AppSec 组件的 CrowdSec（包括 WAF 功能）。</td>
</tr>
</tbody>
</table>
<p><strong>高级选项：</strong></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--instances "IP1 IP2"</code></td>
<td>以空格分隔的 BunkerWeb 实例列表（在管理器/调度器模式下为必需）。</td>
</tr>
</tbody>
</table>
<p><strong>用法示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 以交互模式运行（推荐给大多数用户）</span>
sudo<span class="w"> </span>./install-bunkerweb.sh

<span class="c1"># 使用默认设置进行非交互式安装（完整堆栈，启用向导）</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>--yes

<span class="c1"># 安装一个不带设置向导的工作节点</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>--worker<span class="w"> </span>--no-wizard

<span class="c1"># 安装一个特定版本</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>--version<span class="w"> </span><span class="m">1</span>.6.5-rc3

<span class="c1"># 带有远程工作实例的管理器设置（需要 instances）</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>--manager<span class="w"> </span>--instances<span class="w"> </span><span class="s2">&quot;192.168.1.10 192.168.1.11&quot;</span>

<span class="c1"># 带有 CrowdSec 和 AppSec 的完整安装</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>--crowdsec-appsec

<span class="c1"># 静默非交互式安装</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>--quiet<span class="w"> </span>--yes

<span class="c1"># 预览安装而不执行</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>--dry-run

<span class="c1"># 在简易安装期间启用 API（非交互式）</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>--yes<span class="w"> </span>--api

<span class="c1"># 错误：CrowdSec 不能用于工作节点安装</span>
<span class="c1"># sudo ./install-bunkerweb.sh --worker --crowdsec  # 这将失败</span>

<span class="c1"># 错误：在非交互模式下，管理器需要 instances</span>
<span class="c1"># sudo ./install-bunkerweb.sh --manager --yes  # 如果没有 --instances，这将失败</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">关于选项兼容性的重要说明</p>
<p><strong>CrowdSec 限制：</strong>
- CrowdSec 选项（<code>--crowdsec</code>, <code>--crowdsec-appsec</code>）仅与 <code>--full</code>（默认）和 <code>--manager</code> 安装类型兼容
- 它们不能与 <code>--worker</code>, <code>--scheduler-only</code> 或 <code>--ui-only</code> 安装一起使用</p>
<p><strong>Instances 要求：</strong>
- <code>--instances</code> 选项仅对 <code>--manager</code> 和 <code>--scheduler-only</code> 安装类型有效
- 当使用 <code>--manager</code> 或 <code>--scheduler-only</code> 并带有 <code>--yes</code>（非交互模式）时，<code>--instances</code> 选项是强制性的
- 格式：<code>--instances "192.168.1.10 192.168.1.11 192.168.1.12"</code></p>
<p><strong>交互式与非交互式：</strong>
- 交互模式（默认）将提示输入缺失的必需值
- 非交互模式（<code>--yes</code>）要求通过命令行提供所有必要的选项</p>
</div>
<h4 id="zh-integrations-crowdsec_1">CrowdSec 与脚本的集成</h4>
<p>如果您选择在交互式设置过程中安装 CrowdSec，脚本会完全自动化其与 BunkerWeb 的集成：</p>
<ul>
<li>它会添加官方的 CrowdSec 仓库并安装代理。</li>
<li>它会创建一个新的采集文件，让 CrowdSec 解析 BunkerWeb 的日志（<code>access.log</code>、<code>error.log</code> 和 <code>modsec_audit.log</code>）。</li>
<li>它会安装必要的集合（<code>crowdsecurity/nginx</code>）和解析器（<code>crowdsecurity/geoip-enrich</code>）。</li>
<li>它会为 BunkerWeb 注册一个拦截器，并自动在 <code>/etc/bunkerweb/variables.env</code> 中配置 API 密钥。</li>
<li>如果您还选择了<strong>AppSec 组件</strong>，它会安装 <code>appsec-virtual-patching</code> 和 <code>appsec-generic-rules</code> 集合，并为 BunkerWeb 配置 AppSec 端点。</li>
</ul>
<p>这提供了一个无缝、开箱即用的集成，以实现强大的入侵防护。</p>
<h4 id="zh-integrations-rhel">RHEL 注意事项</h4>
<div class="admonition warning">
<p class="admonition-title">RHEL-based 系统上的外部数据库支持</p>
<p>如果您计划使用外部数据库（推荐用于生产环境），您必须安装相应的数据库客户端软件包：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 对于 MariaDB</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>mariadb

<span class="c1"># 对于 MySQL</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>mysql

<span class="c1"># 对于 PostgreSQL</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>postgresql
</code></pre></div>
<p>这是 BunkerWeb 调度器连接到您的外部数据库所必需的。</p>
</div>
<h4 id="zh-integrations-_15">安装后</h4>
<p>根据您在安装过程中的选择：</p>
<p><strong>启用设置向导：</strong></p>
<ol>
<li>在以下地址访问设置向导：<code>https://your-server-ip/setup</code></li>
<li>按照引导配置来设置您的第一个受保护的服务</li>
<li>配置 SSL/TLS 证书和其他安全设置</li>
</ol>
<p><strong>未启用设置向导：</strong></p>
<ol>
<li>编辑 <code>/etc/bunkerweb/variables.env</code> 来手动配置 BunkerWeb</li>
<li>添加您的服务器设置和受保护的服务</li>
<li>重启调度器：<code>sudo systemctl restart bunkerweb-scheduler</code></li>
</ol>
<h3 id="zh-integrations-_16">使用包管理器安装</h3>
<p>请确保在安装 BunkerWeb 之前<strong>已经安装了 NGINX 1.28.0</strong>。对于除 Fedora 之外的所有发行版，强制要求使用来自<a href="https://nginx.org/en/linux_packages.html">官方 NGINX 仓库</a>的预构建包。从源代码编译 NGINX 或使用来自不同仓库的包将无法与 BunkerWeb 的官方预构建包一起工作。但是，您可以选择从源代码构建 BunkerWeb。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="zh-integrations-__tabbed_1_1" name="zh-integrations-__tabbed_1" type="radio" /><input id="zh-integrations-__tabbed_1_2" name="zh-integrations-__tabbed_1" type="radio" /><input id="zh-integrations-__tabbed_1_3" name="zh-integrations-__tabbed_1" type="radio" /><input id="zh-integrations-__tabbed_1_4" name="zh-integrations-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="zh-integrations-__tabbed_1_1">Debian Bookworm/Trixie</label><label for="zh-integrations-__tabbed_1_2">Ubuntu</label><label for="zh-integrations-__tabbed_1_3">Fedora</label><label for="zh-integrations-__tabbed_1_4">RedHat</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>第一步是添加 NGINX 官方仓库：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>curl<span class="w"> </span>gnupg2<span class="w"> </span>ca-certificates<span class="w"> </span>lsb-release<span class="w"> </span>debian-archive-keyring<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
curl<span class="w"> </span>https://nginx.org/keys/nginx_signing.key<span class="w"> </span><span class="p">|</span><span class="w"> </span>gpg<span class="w"> </span>--dearmor<span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/usr/share/keyrings/nginx-archive-keyring.gpg<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] \</span>
<span class="s2">http://nginx.org/packages/debian `lsb_release -cs` nginx&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/nginx.list
</code></pre></div>
<p>您现在应该能够安装 NGINX 1.28.0：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--allow-downgrades<span class="w"> </span><span class="nv">nginx</span><span class="o">=</span><span class="m">1</span>.28.0-1~<span class="k">$(</span>lsb_release<span class="w"> </span>-cs<span class="k">)</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">测试/开发版本</p>
<p>如果您使用 <code>testing</code> 或 <code>dev</code> 版本，您需要在安装 BunkerWeb 之前将 <code>force-bad-version</code> 指令添加到您的 <code>/etc/dpkg/dpkg.cfg</code> 文件中。</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;force-bad-version&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/dpkg/dpkg.cfg
</code></pre></div>
</div>
<div class="admonition example">
<p class="admonition-title">禁用设置向导</p>
<p>如果您不希望在安装 BunkerWeb 时使用 Web UI 的设置向导，请导出以下变量：</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">UI_WIZARD</span><span class="o">=</span>no
</code></pre></div>
</div>
<p>最后安装 BunkerWeb 1.6.5-rc3：</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>https://repo.bunkerweb.io/install/script.deb.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>bash<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>-E<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--allow-downgrades<span class="w"> </span><span class="nv">bunkerweb</span><span class="o">=</span><span class="m">1</span>.6.5-rc3
</code></pre></div>
<p>要防止在执行 <code>apt upgrade</code> 时升级 NGINX 和/或 BunkerWeb 包，您可以使用以下命令：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-mark<span class="w"> </span>hold<span class="w"> </span>nginx<span class="w"> </span>bunkerweb
</code></pre></div>
</div>
<div class="tabbed-block">
<p>第一步是添加 NGINX 官方仓库：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>curl<span class="w"> </span>gnupg2<span class="w"> </span>ca-certificates<span class="w"> </span>lsb-release<span class="w"> </span>ubuntu-keyring<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
curl<span class="w"> </span>https://nginx.org/keys/nginx_signing.key<span class="w"> </span><span class="p">|</span><span class="w"> </span>gpg<span class="w"> </span>--dearmor<span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/usr/share/keyrings/nginx-archive-keyring.gpg<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] \</span>
<span class="s2">http://nginx.org/packages/ubuntu `lsb_release -cs` nginx&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/nginx.list
</code></pre></div>
<p>您现在应该能够安装 NGINX 1.28.0：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--allow-downgrades<span class="w"> </span><span class="nv">nginx</span><span class="o">=</span><span class="m">1</span>.28.0-1~<span class="k">$(</span>lsb_release<span class="w"> </span>-cs<span class="k">)</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">测试/开发版本</p>
<p>如果您使用 <code>testing</code> 或 <code>dev</code> 版本，您需要在安装 BunkerWeb 之前将 <code>force-bad-version</code> 指令添加到您的 <code>/etc/dpkg/dpkg.cfg</code> 文件中。</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;force-bad-version&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/dpkg/dpkg.cfg
</code></pre></div>
</div>
<div class="admonition example">
<p class="admonition-title">禁用设置向导</p>
<p>如果您不希望在安装 BunkerWeb 时使用 Web UI 的设置向导，请导出以下变量：</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">UI_WIZARD</span><span class="o">=</span>no
</code></pre></div>
</div>
<p>最后安装 BunkerWeb 1.6.5-rc3：</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>https://repo.bunkerweb.io/install/script.deb.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>bash<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>-E<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--allow-downgrades<span class="w"> </span><span class="nv">bunkerweb</span><span class="o">=</span><span class="m">1</span>.6.5-rc3
</code></pre></div>
<p>要防止在执行 <code>apt upgrade</code> 时升级 NGINX 和/或 BunkerWeb 包，您可以使用以下命令：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-mark<span class="w"> </span>hold<span class="w"> </span>nginx<span class="w"> </span>bunkerweb
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition info">
<p class="admonition-title">Fedora 更新测试</p>
<p>如果您在稳定仓库中找不到列出的 NGINX 版本，可以启用 <code>updates-testing</code> 仓库：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>config-manager<span class="w"> </span>setopt<span class="w"> </span>updates-testing.enabled<span class="o">=</span><span class="m">1</span>
</code></pre></div>
</div>
<p>Fedora 已经提供了我们支持的 NGINX 1.28.0</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--allowerasing<span class="w"> </span>nginx-1.28.0
</code></pre></div>
<div class="admonition example">
<p class="admonition-title">禁用设置向导</p>
<p>如果您不希望在安装 BunkerWeb 时使用 Web UI 的设置向导，请导出以下变量：</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">UI_WIZARD</span><span class="o">=</span>no
</code></pre></div>
</div>
<p>最后安装 BunkerWeb 1.6.5-rc3：</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>https://repo.bunkerweb.io/install/script.rpm.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>bash<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>makecache<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>-E<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--allowerasing<span class="w"> </span>bunkerweb-1.6.5-rc3
</code></pre></div>
<p>要防止在执行 <code>dnf upgrade</code> 时升级 NGINX 和/或 BunkerWeb 包，您可以使用以下命令：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>add<span class="w"> </span>nginx<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>add<span class="w"> </span>bunkerweb
</code></pre></div>
</div>
<div class="tabbed-block">
<p>第一步是添加 NGINX 官方仓库。在 <code>/etc/yum.repos.d/nginx.repo</code> 处创建以下文件：</p>
<div class="highlight"><pre><span></span><code>[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true

[nginx-mainline]
name=nginx mainline repo
baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/
gpgcheck=1
enabled=0
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
</code></pre></div>
<p>您现在应该能够安装 NGINX 1.28.0：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>--allowerasing<span class="w"> </span>nginx-1.28.0
</code></pre></div>
<div class="admonition example">
<p class="admonition-title">禁用设置向导</p>
<p>如果您不希望在安装 BunkerWeb 时使用 Web UI 的设置向导，请导出以下变量：</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">UI_WIZARD</span><span class="o">=</span>no
</code></pre></div>
</div>
<p>最后安装 BunkerWeb 1.6.5-rc3：</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span>https://repo.bunkerweb.io/install/script.rpm.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>bash<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>check-update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>-E<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--allowerasing<span class="w"> </span>bunkerweb-1.6.5-rc3
</code></pre></div>
<p>要防止在执行 <code>dnf upgrade</code> 时升级 NGINX 和/或 BunkerWeb 包，您可以使用以下命令：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>add<span class="w"> </span>nginx<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>add<span class="w"> </span>bunkerweb
</code></pre></div>
</div>
</div>
</div>
<h3 id="zh-integrations-_17">配置和服务</h3>
<p>BunkerWeb 的手动配置是通过编辑 <code>/etc/bunkerweb/variables.env</code> 文件来完成的：</p>
<div class="highlight"><pre><span></span><code>MY_SETTING_1=value1
MY_SETTING_2=value2
...
</code></pre></div>
<p>安装后，BunkerWeb 带有三个服务 <code>bunkerweb</code>、<code>bunkerweb-scheduler</code> 和 <code>bunkerweb-ui</code>，您可以使用 <code>systemctl</code> 来管理它们。</p>
<p>如果您手动编辑了 BunkerWeb 的配置（使用 <code>/etc/bunkerweb/variables.env</code>），重启 <code>bunkerweb-scheduler</code> 服务就足以生成并重新加载配置，而不会有任何停机时间。但在某些情况下（例如更改监听端口），您可能需要重启 <code>bunkerweb</code> 服务。</p>
<h3 id="zh-integrations-_18">高可用性</h3>
<p>调度器可以与 BunkerWeb 实例分离，以提供高可用性。在这种情况下，调度器将安装在一台独立的服务器上，并能够管理多个 BunkerWeb 实例。</p>
<h4 id="zh-integrations-_19">管理器</h4>
<p>要仅在服务器上安装调度器，您可以在执行 BunkerWeb 安装之前导出以下变量：</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">MANAGER_MODE</span><span class="o">=</span>yes
<span class="nb">export</span><span class="w"> </span><span class="nv">UI_WIZARD</span><span class="o">=</span>no
</code></pre></div>
<p>或者，您也可以导出以下变量以仅启用调度器：</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">SERVICE_SCHEDULER</span><span class="o">=</span>yes
<span class="nb">export</span><span class="w"> </span><span class="nv">SERVICE_BUNKERWEB</span><span class="o">=</span>no
<span class="nb">export</span><span class="w"> </span><span class="nv">SERVICE_UI</span><span class="o">=</span>no
</code></pre></div>
<h4 id="zh-integrations-_20">工作节点</h4>
<p>在另一台服务器上，要仅安装 BunkerWeb，您可以在执行 BunkerWeb 安装之前导出以下变量：</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">WORKER_MODE</span><span class="o">=</span>yes
</code></pre></div>
<p>或者，您也可以导出以下变量以仅启用 BunkerWeb：</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">SERVICE_BUNKERWEB</span><span class="o">=</span>yes
<span class="nb">export</span><span class="w"> </span><span class="nv">SERVICE_SCHEDULER</span><span class="o">=</span>no
<span class="nb">export</span><span class="w"> </span><span class="nv">SERVICE_UI</span><span class="o">=</span>no
</code></pre></div>
<h4 id="zh-integrations-web-ui">Web UI</h4>
<p>Web UI 可以安装在一台独立的服务器上，以提供一个专门用于管理 BunkerWeb 实例的界面。要仅安装 Web UI，您可以在执行 BunkerWeb 安装之前导出以下变量：</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">SERVICE_BUNKERWEB</span><span class="o">=</span>no
<span class="nb">export</span><span class="w"> </span><span class="nv">SERVICE_SCHEDULER</span><span class="o">=</span>no
<span class="nb">export</span><span class="w"> </span><span class="nv">SERVICE_UI</span><span class="o">=</span>yes
</code></pre></div>
<h2 id="zh-integrations-docker">Docker 自动配置</h2>
<figure>
<p><img align="center," alt="概述" src="../assets/img/integration-autoconf.svg" width="600" />
  </p>
<figcaption>Docker 自动配置集成</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">Docker 集成</p>
<p>Docker 自动配置集成是 Docker 集成的一个“演进”。如果需要，请先阅读<a href="#zh-integrations-docker">Docker 集成部分</a>。</p>
</div>
<p>有一种替代方法可以解决每次更新时都需要重新创建容器的不便。通过使用另一个名为 <strong>autoconf</strong> 的镜像，您可以自动实时重新配置 BunkerWeb，而无需重新创建容器。</p>
<p>要利用此功能，您可以为您的 Web 应用程序容器添加<strong>标签</strong>，而不是为 BunkerWeb 容器定义环境变量。然后，<strong>autoconf</strong> 镜像将监听 Docker 事件，并无缝处理 BunkerWeb 的配置更新。</p>
<p>这个“<em>自动化</em>”过程简化了 BunkerWeb 配置的管理。通过为您的 Web 应用程序容器添加标签，您可以将重新配置任务委托给 <strong>autoconf</strong>，而无需手动干预容器的重新创建。这简化了更新过程并增强了便利性。</p>
<p>通过采用这种方法，您可以享受 BunkerWeb 的实时重新配置，而无需重新创建容器的麻烦，使其更高效、更用户友好。</p>
<div class="admonition info">
<p class="admonition-title">多站点模式</p>
<p>Docker 自动配置集成意味着使用<strong>多站点模式</strong>。有关更多信息，请参阅文档的<a href="#zh-concepts-multisite-mode">多站点部分</a>。</p>
</div>
<div class="admonition info">
<p class="admonition-title">数据库后端</p>
<p>请注意，我们的说明假设您正在使用 MariaDB 作为默认的数据库后端，这是由 <code>DATABASE_URI</code> 设置配置的。但是，我们理解您可能更喜欢为您的 Docker 集成使用其他后端。如果是这样，请放心，其他数据库后端仍然是可行的。有关更多信息，请参阅仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/v1.6.5-rc3/misc/integrations">misc/integrations 文件夹</a>中的 docker-compose 文件。</p>
</div>
<p>要启用自动配置更新，请在堆栈中包含一个名为 <code>bw-autoconf</code> 的额外容器。此容器承载自动配置服务，该服务管理 BunkerWeb 的动态配置更改。</p>
<p>为了支持此功能，请使用一个专用的“真实”数据库后端（例如，MariaDB、MySQL 或 PostgreSQL）进行同步配置存储。通过集成 <code>bw-autoconf</code> 和合适的数据库后端，您为 BunkerWeb 中无缝的自动配置管理建立了基础设施。</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-env</span>
<span class="w">  </span><span class="c1"># 我们使用一个锚点来避免在两个容器中重复相同的设置</span>
<span class="w">  </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w"> </span><span class="c1"># QUIC</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.INSTANCE=yes&quot;</span><span class="w"> </span><span class="c1"># 自动配置服务识别 BunkerWeb 实例的强制性标签</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 我们不需要在这里指定 BunkerWeb 实例，因为它们由自动配置服务自动检测</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 服务器名称将由服务标签填充</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="c1"># 自动配置的强制性设置</span>
<span class="w">      </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">      </span><span class="nt">DOCKER_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tcp://bw-docker:2375&quot;</span><span class="w"> </span><span class="c1"># Docker 套接字</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tecnativa/docker-socket-proxy:nightly</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock:ro</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CONTAINERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warning&quot;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">数据库在 <code>bw-db</code> 网络中</p>
<p>数据库容器有意未包含在 <code>bw-universe</code> 网络中。它由 <code>bw-autoconf</code> 和 <code>bw-scheduler</code> 容器使用，而不是直接由 BunkerWeb 使用。因此，数据库容器是 <code>bw-db</code> 网络的一部分，这通过使对数据库的外部访问更具挑战性来增强安全性。<strong>这种刻意的设计选择有助于保护数据库并加强系统的整体安全视角</strong>。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">在无根模式下使用 Docker</p>
<p>如果您正在使用<a href="https://docs.docker.com/engine/security/rootless">无根模式的 Docker</a>，您需要将 docker 套接字的挂载替换为以下值：<code>$XDG_RUNTIME_DIR/docker.sock:/var/run/docker.sock:ro</code>。</p>
</div>
<h3 id="zh-integrations-_21">自动配置服务</h3>
<p>一旦堆栈设置好，您将能够创建 Web 应用程序容器，并使用“bunkerweb.”前缀将设置添加为标签，以便自动设置 BunkerWeb：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">myapp</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mywebapp:4.2</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.MY_SETTING_1=value1&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.MY_SETTING_2=value2&quot;</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
<h3 id="zh-integrations-_22">命名空间</h3>
<p>从 <code>1.6.0</code> 版本开始，BunkerWeb 的自动配置堆栈现在支持命名空间。此功能使您能够在同一个 Docker 主机上管理多个 BunkerWeb 实例和服务的“<em>集群</em>”。要利用命名空间，只需在您的服务上设置 <code>NAMESPACE</code> 标签。这是一个示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">myapp</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mywebapp:4.2</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.NAMESPACE=my-namespace&quot;</span><span class="w"> </span><span class="c1"># 为服务设置命名空间</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.MY_SETTING_1=value1&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.MY_SETTING_2=value2&quot;</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">命名空间行为</p>
<p>默认情况下，所有自动配置堆栈都监听所有命名空间。如果您想将一个堆栈限制在特定的命名空间，可以在 <code>bw-autoconf</code> 服务中设置 <code>NAMESPACES</code> 环境变量：</p>
<div class="highlight"><pre><span></span><code><span class="nn">...</span>
<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.INSTANCE=yes&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.NAMESPACE=my-namespace&quot;</span><span class="w"> </span><span class="c1"># 为 BunkerWeb 实例设置命名空间，以便自动配置服务可以检测到它</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">NAMESPACES</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;my-namespace</span><span class="nv"> </span><span class="s">my-other-namespace&quot;</span><span class="w"> </span><span class="c1"># 只监听这些命名空间</span>
<span class="nn">...</span>
</code></pre></div>
<p>请记住，<code>NAMESPACES</code> 环境变量是一个以空格分隔的命名空间列表。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">命名空间规范</p>
<p>每个命名空间只能有<strong>一个数据库</strong>和<strong>一个调度器</strong>。如果您尝试在同一个命名空间中创建多个数据库或调度器，配置最终会相互冲突。</p>
<p>调度器不需要 <code>NAMESPACE</code> 标签即可正常工作。它只需要正确配置 <code>DATABASE_URI</code> 设置，以便它可以访问与自动配置服务相同的数据库。</p>
</div>
<h2 id="zh-integrations-kubernetes">Kubernetes</h2>
<figure>
<p><img align="center," alt="概述" src="../assets/img/integration-kubernetes.svg" width="600" />
  </p>
<figcaption>Kubernetes 集成</figcaption>
</figure>
<p>为了在 Kubernetes 环境中自动化 BunkerWeb 实例的配置，autoconf 服务充当一个 <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">Ingress 控制器</a>。它根据 <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress 资源</a>配置 BunkerWeb 实例，并监控其他 Kubernetes 对象，例如 <a href="https://kubernetes.io/docs/concepts/configuration/configmap/">ConfigMap</a>，以获取自定义配置。</p>
<p>为了获得最佳设置，建议将 BunkerWeb 定义为一个 <strong><a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/">DaemonSet</a></strong>，这样可以确保在所有节点上都创建一个 pod，而将 <strong>autoconf 和 scheduler</strong> 定义为<strong>单个副本的 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a></strong>。</p>
<p>鉴于存在多个 BunkerWeb 实例，有必要建立一个共享数据存储，实现为一个 <a href="https://redis.io/">Redis</a> 或 <a href="https://valkey.io/">Valkey</a> 服务。这些实例将利用该服务来缓存和共享彼此之间的数据。有关 Redis/Valkey 设置的更多信息，请参见<a href="#zh-features-redis">此处</a>。</p>
<div class="admonition info">
<p class="admonition-title">数据库后端</p>
<p>请注意，我们的说明假设您正在使用 MariaDB 作为默认的数据库后端，这是由 <code>DATABASE_URI</code> 设置配置的。但是，我们理解您可能更喜欢为您的 Docker 集成使用其他后端。如果是这样，请放心，其他数据库后端仍然是可行的。有关更多信息，请参阅仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/v1.6.5-rc3/misc/integrations">misc/integrations 文件夹</a>中的 docker-compose 文件。</p>
<p>集群数据库后端的设置超出了本文档的范围。</p>
</div>
<p>请确保自动配置服务有权访问 Kubernetes API。建议为此目的利用 <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">RBAC 授权</a>。</p>
<div class="admonition warning">
<p class="admonition-title">Kubernetes API 的自定义 CA</p>
<p>如果您为您的 Kubernetes API 使用自定义 CA，您可以在 ingress 控制器上挂载一个包含您的中间证书和根证书的捆绑文件，并将 <code>KUBERNETES_SSL_CA_CERT</code> 环境变量的值设置为容器内捆绑文件的路径。或者，即使不推荐，您也可以通过将 ingress 控制器的 <code>KUBERNETES_SSL_VERIFY</code> 环境变量设置为 <code>no</code>（默认为 <code>yes</code>）来禁用证书验证。</p>
</div>
<p>此外，<strong>在使用 Kubernetes 集成时，将 <code>KUBERNETES_MODE</code> 环境变量设置为 <code>yes</code> 至关重要</strong>。此变量是正常运行所必需的。</p>
<h3 id="zh-integrations-_23">安装方法</h3>
<h4 id="zh-integrations-helm-chart">使用 helm chart（推荐）</h4>
<p>安装 Kubernetes 的推荐方法是使用位于 <code>https://repo.bunkerweb.io/charts</code> 的 Helm chart：</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>bunkerweb<span class="w"> </span>https://repo.bunkerweb.io/charts
</code></pre></div>
<p>然后您可以使用该仓库中的 bunkerweb helm chart：</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>-f<span class="w"> </span>myvalues.yaml<span class="w"> </span>mybunkerweb<span class="w"> </span>bunkerweb/bunkerweb
</code></pre></div>
<p>值的完整列表在 <a href="https://github.com/bunkerity/bunkerweb-helm">bunkerity/bunkerweb-helm 仓库</a> 的 <a href="https://github.com/bunkerity/bunkerweb-helm/blob/main/charts/bunkerweb/values.yaml">charts/bunkerweb/values.yaml 文件</a> 中列出。</p>
<h4 id="zh-integrations-yaml">完整的 YAML 文件</h4>
<p>除了使用 helm chart，您还可以使用 GitHub 仓库中 <a href="https://github.com/bunkerity/bunkerweb/tree/v1.6.5-rc3/misc/integrations">misc/integrations 文件夹</a>内的 YAML 样板文件。请注意，我们强烈建议您改用 helm chart。</p>
<h3 id="zh-integrations-ingress">Ingress 资源</h3>
<p>一旦 BunkerWeb Kubernetes 堆栈成功设置并运行（有关详细信息，请参阅自动配置日志），您就可以继续在集群内部署 Web 应用程序并声明您的 Ingress 资源。</p>
<p>需要注意的是，BunkerWeb 设置需要作为 Ingress 资源的注解来指定。对于域部分，请使用特殊值 <strong><code>bunkerweb.io</code></strong>。通过包含适当的注解，您可以相应地为 Ingress 资源配置 BunkerWeb。</p>
<div class="admonition info">
<p class="admonition-title">TLS 支持</p>
<p>BunkerWeb ingress 控制器完全支持使用 tls 规范的自定义 HTTPS 证书，如示例所示。配置诸如 <code>cert-manager</code> 之类的解决方案以自动生成 tls secret 超出了本文档的范围。</p>
</div>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-ingress</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 将应用于此 ingress 中的所有主机</span>
<span class="w">    </span><span class="nt">bunkerweb.io/MY_SETTING</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;value&quot;</span>
<span class="w">    </span><span class="c1"># 将仅应用于 www.example.com 主机</span>
<span class="w">    </span><span class="nt">bunkerweb.io/www.example.com_MY_SETTING</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;value&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># TLS 是可选的，您也可以使用内置的 Let&#39;s Encrypt 等</span>
<span class="w">  </span><span class="c1"># tls:</span>
<span class="w">  </span><span class="c1">#   - hosts:</span>
<span class="w">  </span><span class="c1">#       - www.example.com</span>
<span class="w">  </span><span class="c1">#     secretName: secret-example-tls</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.example.com</span>
<span class="w">      </span><span class="nt">http</span><span class="p">:</span>
<span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">              </span><span class="nt">service</span><span class="p">:</span>
<span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc-my-app</span>
<span class="w">                </span><span class="nt">port</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="nn">...</span>
</code></pre></div>
<h3 id="zh-integrations-_24">命名空间</h3>
<p>从 <code>1.6.0</code> 版本开始，BunkerWeb 的自动配置堆栈现在支持命名空间。此功能使您能够在同一个 Kubernetes 集群上管理多个 BunkerWeb 实例和服务的集群。要利用命名空间，只需在您的 BunkerWeb 实例和服务上设置 <code>namespace</code> 元数据字段。这是一个示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-namespace</span><span class="w"> </span><span class="c1"># 为 BunkerWeb 实例设置命名空间</span>
<span class="nn">...</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">命名空间行为</p>
<p>默认情况下，所有自动配置堆栈都监听所有命名空间。如果您想将一个堆栈限制在特定的命名空间，可以在 <code>bunkerweb-controller</code> 部署中设置 <code>NAMESPACES</code> 环境变量：</p>
<div class="highlight"><pre><span></span><code><span class="nn">...</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb-controller</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-namespace</span><span class="w"> </span><span class="c1"># 为控制器设置命名空间</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Recreate</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb-controller</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb-controller</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sa-bunkerweb</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb-controller</span>
<span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:1.6.5-rc3</span>
<span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">          </span><span class="nt">env</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NAMESPACES</span>
<span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my-namespace</span><span class="nv"> </span><span class="s">my-other-namespace&quot;</span><span class="w"> </span><span class="c1"># 只监听这些命名空间</span>
<span class="w">            </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nn">...</span>
</code></pre></div>
<p>请记住，<code>NAMESPACES</code> 环境变量是一个以空格分隔的命名空间列表。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">命名空间规范</p>
<p>每个命名空间只能有<strong>一个数据库</strong>和<strong>一个调度器</strong>。如果您尝试在同一个命名空间中创建多个数据库或调度器，配置最终会相互冲突。</p>
<p>调度器不需要 <code>NAMESPACE</code> 注解即可正常工作。它只需要正确配置 <code>DATABASE_URI</code> 设置，以便它可以访问与自动配置服务相同的数据库。</p>
</div>
<h3 id="zh-integrations-ingress_1">Ingress 类</h3>
<p>当使用文档中的官方方法安装时，BunkerWeb 带有以下 <code>IngressClass</code> 定义：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IngressClass</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb.io/ingress-controller</span>
</code></pre></div>
<p>为了限制 ingress 控制器监控的 <code>Ingress</code> 资源，您可以将 <code>KUBERNETES_INGRESS_CLASS</code> 环境变量的值设置为 <code>bunkerweb</code>。然后，您可以在您的 <code>Ingress</code> 定义中利用 <code>ingressClassName</code> 指令：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-ingress</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bunkerweb.io/MY_SETTING</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;value&quot;</span>
<span class="w">    </span><span class="nt">bunkerweb.io/www.example.com_MY_SETTING</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;value&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.example.com</span>
<span class="w">      </span><span class="nt">http</span><span class="p">:</span>
<span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">              </span><span class="nt">service</span><span class="p">:</span>
<span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc-my-app</span>
<span class="w">                </span><span class="nt">port</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
</code></pre></div>
<h3 id="zh-integrations-_25">自定义域名</h3>
<p>如果您为您的 Kubernetes 集群使用不同于默认 <code>kubernetes.local</code> 的自定义域名，您可以在调度器容器上使用 <code>KUBERNETES_DOMAIN_NAME</code> 环境变量来设置该值。</p>
<h3 id="zh-integrations-ingress_2">与现有 ingress 控制器一起使用</h3>
<div class="admonition info">
<p class="admonition-title">同时保留现有 ingress 控制器和 BunkerWeb</p>
<p>这是一个您希望保留现有 ingress 控制器（例如 nginx）的用例。典型的流量流将是：负载均衡器 =&gt; Ingress 控制器 =&gt; BunkerWeb =&gt; 应用程序。</p>
</div>
<h4 id="zh-integrations-nginx-ingress">nginx ingress 控制器安装</h4>
<p>安装 ingress nginx helm 仓库：</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>ingress-nginx<span class="w"> </span>https://kubernetes.github.io/ingress-nginx
helm<span class="w"> </span>repo<span class="w"> </span>update
</code></pre></div>
<p>使用默认值安装 nginx ingress 控制器（可能无法在您自己的集群上开箱即用，请查看<a href="https://kubernetes.github.io/ingress-nginx/">文档</a>）：</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>--namespace<span class="w"> </span>nginx<span class="w"> </span>--create-namespace<span class="w"> </span>nginx<span class="w"> </span>ingress-nginx/ingress-nginx
</code></pre></div>
<p>提取 LB 的 IP 地址：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>nginx-ingress-nginx-controller<span class="w"> </span>-n<span class="w"> </span>nginx<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span>
</code></pre></div>
<p>设置 DNS 条目指向 LB 的 IP（例如 <code>bunkerweb</code> 子域用于 BW UI，<code>myapp</code> 用于应用程序）：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>nslookup<span class="w"> </span>bunkerweb.example.com
Server:<span class="w">         </span><span class="m">172</span>.26.112.1
Address:<span class="w">        </span><span class="m">172</span>.26.112.1#53

Non-authoritative<span class="w"> </span>answer:
Name:<span class="w">   </span>bunkerweb.example.com
Address:<span class="w"> </span><span class="m">1</span>.2.3.4
$<span class="w"> </span>nslookup<span class="w"> </span>myapp.example.com
Server:<span class="w">         </span><span class="m">172</span>.26.112.1
Address:<span class="w">        </span><span class="m">172</span>.26.112.1#53

Non-authoritative<span class="w"> </span>answer:
Name:<span class="w">   </span>myapp.example.com
Address:<span class="w"> </span><span class="m">1</span>.2.3.4
</code></pre></div>
<p><strong>BunkerWeb 安装</strong></p>
<p>安装 BunkerWeb helm 仓库：</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>bunkerweb<span class="w"> </span>https://repo.bunkerweb.io/charts
helm<span class="w"> </span>repo<span class="w"> </span>update
</code></pre></div>
<p>创建 <code>values.yaml</code> 文件：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 这里我们将设置在现有 ingress 控制器后面设置 BunkerWeb 所需的值</span>
<span class="c1"># 带 BW 的流量流：LB =&gt; 现有 Ingress 控制器 =&gt; BunkerWeb =&gt; 服务</span>
<span class="c1"># 不带 BW 的流量流：LB =&gt; 现有 Ingress 控制器 =&gt; 服务</span>

<span class="c1"># 全局设置</span>
<span class="nt">settings</span><span class="p">:</span>
<span class="w">  </span><span class="nt">misc</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 替换为您的 DNS 解析器</span>
<span class="w">    </span><span class="c1"># 获取方法：在任意 pod 中执行 kubectl exec，然后 cat /etc/resolv.conf</span>
<span class="w">    </span><span class="c1"># 如果您的 nameserver 是一个 IP，则执行反向 DNS 查找：nslookup &lt;IP&gt;</span>
<span class="w">    </span><span class="c1"># 大多数情况下是 coredns.kube-system.svc.cluster.local 或 kube-dns.kube-system.svc.cluster.local</span>
<span class="w">    </span><span class="nt">dnsResolvers</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;kube-dns.kube-system.svc.cluster.local&quot;</span>
<span class="w">  </span><span class="nt">kubernetes</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 我们只考虑带有 ingressClass bunkerweb 的 Ingress 资源，以避免与现有 ingress 控制器冲突</span>
<span class="w">    </span><span class="nt">ingressClass</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">    </span><span class="c1"># 可选：您可以选择 BunkerWeb 将监听 Ingress/ConfigMap 更改的命名空间</span>
<span class="w">    </span><span class="c1"># 默认值（空白）是所有命名空间</span>
<span class="w">    </span><span class="nt">namespaces</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>

<span class="c1"># 覆盖 bunkerweb-external 服务类型为 ClusterIP</span>
<span class="c1"># 因为我们不需要将其暴露给外部世界</span>
<span class="c1"># 我们将使用现有的 ingress 控制器将流量路由到 BunkerWeb</span>
<span class="nt">service</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>

<span class="c1"># BunkerWeb 设置</span>
<span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.6.5-rc3</span>

<span class="c1"># 调度器设置</span>
<span class="nt">scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.6.5-rc3</span>
<span class="w">  </span><span class="nt">extraEnvs</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 启用 real IP 模块以获取客户端的真实 IP</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">USE_REAL_IP</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>

<span class="c1"># 控制器设置</span>
<span class="nt">controller</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.6.5-rc3</span>

<span class="c1"># UI 设置</span>
<span class="nt">ui</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.6.5-rc3</span>
</code></pre></div>
<p>使用自定义值安装 BunkerWeb：</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>--namespace<span class="w"> </span>bunkerweb<span class="w"> </span>--create-namespace<span class="w"> </span>-f<span class="w"> </span>values.yaml<span class="w"> </span>bunkerweb<span class="w"> </span>bunkerweb/bunkerweb
</code></pre></div>
<p>检查日志并等待一切就绪。</p>
<p><strong>Web UI 安装</strong></p>
<p>设置以下 ingress（假设已安装 nginx 控制器）：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ui-bunkerweb</span>
<span class="w">  </span><span class="c1"># 如果需要，替换为您的 BW 命名空间</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 即使流量是内部的，Web UI 也必须使用 HTTPS</span>
<span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/backend-protocol</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HTTPS&quot;</span>
<span class="w">    </span><span class="c1"># 我们必须设置 SNI，以便 BW 可以提供正确的虚拟主机</span>
<span class="w">    </span><span class="c1"># 替换为您的域名</span>
<span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/proxy-ssl-name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb.example.com&quot;</span>
<span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/proxy-ssl-server-name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;on&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 仅由 nginx 控制器提供服务，而不是 BW</span>
<span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">  </span><span class="c1"># 如果要使用自己的证书，请取消注释并进行编辑</span>
<span class="w">  </span><span class="c1"># tls:</span>
<span class="w">  </span><span class="c1"># - hosts:</span>
<span class="w">  </span><span class="c1">#   - bunkerweb.example.com</span>
<span class="w">  </span><span class="c1">#   secretName: tls-secret</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 替换为您的域名</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb.example.com</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># 由 Helm chart 创建</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb-external</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="c1"># UI 必须使用 HTTPS 端口</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</code></pre></div>
<p>现在您可以通过浏览 <code>https://bunkerweb.example.com/setup</code> 进入设置向导。</p>
<p><strong>保护现有应用程序</strong></p>
<p><strong>首先，您需要进入全局配置，选择 SSL 插件，然后禁用自动将 HTTP 重定向到 HTTPS。请注意，您只需要执行一次。</strong></p>
<p>假设您在 <code>myapp</code> 命名空间中有一个应用程序，该应用程序可以通过 <code>myapp-service</code> 服务在端口 <code>5000</code> 上访问。</p>
<p>您需要在 Web UI 上添加一个新服务并填写所需信息：</p>
<ul>
<li>服务器名称：您的应用程序的公共域名（例如 <code>myapp.example.com</code>）</li>
<li>SSL/TLS：您的 ingress 控制器负责该部分，因此不要在 BunkerWeb 上启用它，因为流量在集群内部</li>
<li>反向代理主机：您在集群内的应用程序的完整 URL（例如 <code>http://myapp-service.myapp.svc.cluster.local:5000</code>）</li>
</ul>
<p>添加新服务后，您现在可以为该服务声明一个 Ingress 资源，并将其路由到 BunkerWeb 服务的 HTTP 端口：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">  </span><span class="c1"># 如果需要，替换为您的 BW 命名空间</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 仅由 nginx 控制器提供服务，而不是 BW</span>
<span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">  </span><span class="c1"># 如果要使用自己的证书，请取消注释并进行编辑</span>
<span class="w">  </span><span class="c1"># tls:</span>
<span class="w">  </span><span class="c1"># - hosts:</span>
<span class="w">  </span><span class="c1">#   - myapp.example.com</span>
<span class="w">  </span><span class="c1">#   secretName: tls-secret</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 替换为您的域名</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp.example.com</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># 由 Helm chart 创建</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb-external</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
<p>您可以访问 <code>http(s)://myapp.example.com</code>，现在它已受到 BunkerWeb 的保护 🛡️</p>
<h2 id="zh-integrations-swarm">Swarm</h2>
<figure>
<p><img align="center," alt="概述" src="../assets/img/integration-swarm.svg" width="600" />
  </p>
<figcaption>Docker Swarm 集成</figcaption>
</figure>
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">PRO 支持</p>
<p><strong>如果您需要 Swarm 支持</strong>，请通过 <a href="mailto:contact@bunkerity.com">contact@bunkerity.com</a> 或<a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">联系表单</a>与我们联系。</p>
</div>
<div class="admonition info">
<p class="admonition-title">Docker 自动配置</p>
<p>Swarm 集成与 Docker 自动配置集成类似（但使用服务而不是容器）。如果需要，请先阅读<a href="#zh-integrations-docker-autoconf">Docker 自动配置集成部分</a>。</p>
</div>
<p>为了实现 BunkerWeb 实例的自动配置，<strong>autoconf</strong> 服务需要访问 Docker API。该服务监听 Docker Swarm 事件，例如服务的创建或删除，并实时无缝地配置 <strong>BunkerWeb 实例</strong>，而不会造成任何停机。它还监控其他 Swarm 对象，例如用于自定义配置的 <a href="https://docs.docker.com/engine/swarm/configs/">configs</a>。</p>
<p>与 <a href="#zh-integrations-docker-autoconf">Docker autoconf 集成</a>类似，Web 服务的配置是使用以 <strong>bunkerweb</strong> 前缀开头的标签来定义的。</p>
<p>为了获得最佳设置，建议将 <strong>BunkerWeb 服务</strong>调度为所有节点上的<strong><em>全局服务</em></strong>，而将 <strong>autoconf、scheduler 和 Docker API 代理服务</strong>调度为<strong><em>单个副本的服务</em></strong>。请注意，Docker API 代理服务需要调度在管理器节点上，除非您将其配置为使用远程 API（这不在文档的讨论范围内）。</p>
<p>由于运行着多个 BunkerWeb 实例，必须创建一个共享数据存储，实现为 <a href="https://redis.io/">Redis</a> 或 <a href="https://valkey.io/">Valkey</a> 服务。这些实例将利用 Redis/Valkey 服务来缓存和共享数据。有关 Redis/Valkey 设置的更多详细信息，请参见<a href="#zh-features-redis">此处</a>。</p>
<p>至于数据库卷，文档并未指定具体的方法。为数据库卷选择共享文件夹或特定驱动程序取决于您的独特用例，留给读者自行决定。</p>
<div class="admonition info">
<p class="admonition-title">数据库后端</p>
<p>请注意，我们的说明假设您正在使用 MariaDB 作为默认的数据库后端，这是由 <code>DATABASE_URI</code> 设置配置的。但是，我们理解您可能更喜欢为您的 Docker 集成使用其他后端。如果是这样，请放心，其他数据库后端仍然是可行的。有关更多信息，请参阅仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/v1.6.5-rc3/misc/integrations">misc/integrations 文件夹</a>中的 docker-compose 文件。</p>
<p>集群数据库后端的设置超出了本文档的范围。</p>
</div>
<p>这是您可以使用 <code>docker stack deploy</code> 部署的堆栈样板：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-env</span>
<span class="w">  </span><span class="c1"># 我们使用一个锚点来避免在两个服务中重复相同的设置</span>
<span class="w">  </span><span class="nt">SWARM_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">udp</span><span class="w"> </span><span class="c1"># QUIC</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">global</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">worker&quot;</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.INSTANCE=yes&quot;</span><span class="w"> </span><span class="c1"># autoconf 服务识别 BunkerWeb 实例的强制性标签</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 我们不需要在这里指定 BunkerWeb 实例，因为它们由 autoconf 服务自动检测</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 服务器名称将由服务标签填充</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="c1"># autoconf 的强制性设置</span>
<span class="w">      </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">      </span><span class="nt">USE_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bw-redis&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">worker&quot;</span>

<span class="w">  </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">SWARM_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">      </span><span class="nt">DOCKER_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tcp://bw-docker:2375&quot;</span><span class="w"> </span><span class="c1"># Docker 套接字</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">worker&quot;</span>

<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tecnativa/docker-socket-proxy:nightly</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CONFIGS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">CONTAINERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">SERVICES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">SWARM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">TASKS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warning&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock:ro</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">manager&quot;</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">worker&quot;</span>

<span class="w">  </span><span class="nt">bw-redis</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:7-alpine</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">worker&quot;</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Swarm 强制设置</p>
<p>请注意，在使用 Swarm 集成时，<code>SWARM_MODE: "yes"</code> 环境变量是强制性的。</p>
</div>
<h3 id="zh-integrations-swarm_1">Swarm 服务</h3>
<p>一旦 BunkerWeb Swarm 堆栈设置并运行（有关更多信息，请参阅 autoconf 和 scheduler 日志），您将能够在该集群中部署 Web 应用程序，并使用标签来动态配置 BunkerWeb：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">myapp</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mywebapp:4.2</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role==worker&quot;</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.MY_SETTING_1=value1&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.MY_SETTING_2=value2&quot;</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
<h3 id="zh-integrations-_26">命名空间</h3>
<p>从 <code>1.6.0</code> 版本开始，BunkerWeb 的自动配置堆栈现在支持命名空间。此功能使您能够在同一个 Docker 主机上管理多个 BunkerWeb 实例和服务的“<em>集群</em>”。要利用命名空间，只需在您的服务上设置 <code>NAMESPACE</code> 标签。这是一个示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">myapp</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mywebapp:4.2</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role==worker&quot;</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.NAMESPACE=my-namespace&quot;</span><span class="w"> </span><span class="c1"># 为服务设置命名空间</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.MY_SETTING_1=value1&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.MY_SETTING_2=value2&quot;</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">命名空间行为</p>
<p>默认情况下，所有自动配置堆栈都监听所有命名空间。如果您想将一个堆栈限制在特定的命名空间，可以在 <code>bw-autoconf</code> 服务中设置 <code>NAMESPACES</code> 环境变量：</p>
<div class="highlight"><pre><span></span><code><span class="nn">...</span>
<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:1.6.5-rc3</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">global</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">worker&quot;</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.INSTANCE=yes&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.NAMESPACE=my-namespace&quot;</span><span class="w"> </span><span class="c1"># 为 BunkerWeb 实例设置命名空间</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:1.6.5-rc3</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">NAMESPACES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my-namespace</span><span class="nv"> </span><span class="s">my-other-namespace&quot;</span><span class="w"> </span><span class="c1"># 只监听这些命名空间</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">worker&quot;</span>
<span class="nn">...</span>
</code></pre></div>
<p>请记住，<code>NAMESPACES</code> 环境变量是一个以空格分隔的命名空间列表。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">命名空间规范</p>
<p>每个命名空间只能有<strong>一个数据库</strong>和<strong>一个调度器</strong>。如果您尝试在同一个命名空间中创建多个数据库或调度器，配置最终会相互冲突。</p>
<p>调度器不需要 <code>NAMESPACE</code> 标签即可正常工作。它只需要正确配置 <code>DATABASE_URI</code> 设置，以便它可以访问与自动配置服务相同的数据库。</p>
</div>
<h2 id="zh-integrations-microsoft-azure">Microsoft Azure</h2>
<figure>
<p><img align="center," alt="概述" src="../assets/img/integration-azure.webp" width="600" />
  </p>
<figcaption>Azure 集成</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">推荐的虚拟机大小</p>
<p>请在选择虚拟机的 SKU 时注意。您必须选择与 Gen2 虚拟机兼容的 SKU，我们建议从 B2s 或 Ds2 系列开始以获得最佳使用效果。</p>
</div>
<p>您可以轻松地通过多种方式在您的 Azure 订阅上部署 BunkerWeb：</p>
<ul>
<li>Cloud Shell 中的 Azure CLI</li>
<li>Azure ARM 模板</li>
<li>通过 Marketplace 的 Azure 门户</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="2:3"><input checked="checked" id="zh-integrations-__tabbed_2_1" name="zh-integrations-__tabbed_2" type="radio" /><input id="zh-integrations-__tabbed_2_2" name="zh-integrations-__tabbed_2" type="radio" /><input id="zh-integrations-__tabbed_2_3" name="zh-integrations-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="zh-integrations-__tabbed_2_1">Cloud Shell</label><label for="zh-integrations-__tabbed_2_2">ARM 模板</label><label for="zh-integrations-__tabbed_2_3">Marketplace</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>创建一个资源组。替换值 <code>RG_NAME</code></p>
<div class="highlight"><pre><span></span><code>az<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span><span class="s2">&quot;RG_NAME&quot;</span><span class="w"> </span>--location<span class="w"> </span><span class="s2">&quot;LOCATION&quot;</span>
</code></pre></div>
<p>在资源组的位置创建一个 <code>Standard_B2s</code> SKU 的虚拟机。替换值 <code>RG_NAME</code>, <code>VM_NAME</code>, <code>VNET_NAME</code>, <code>SUBNET_NAME</code></p>
<div class="highlight"><pre><span></span><code>az<span class="w"> </span>vm<span class="w"> </span>create<span class="w"> </span>--resource-group<span class="w"> </span><span class="s2">&quot;RG_NAME&quot;</span><span class="w"> </span>--name<span class="w"> </span><span class="s2">&quot;VM_NAME&quot;</span><span class="w"> </span>--image<span class="w"> </span>bunkerity:bunkerweb:bunkerweb:latest<span class="w"> </span>--accept-term<span class="w"> </span>--generate-ssh-keys<span class="w"> </span>--vnet-name<span class="w"> </span><span class="s2">&quot;VNET_NAME&quot;</span><span class="w"> </span>--size<span class="w"> </span>Standard_B2s<span class="w"> </span>--subnet<span class="w"> </span><span class="s2">&quot;SUBNET_NAME&quot;</span>
</code></pre></div>
<p>完整命令。替换值 <code>RG_NAME</code>, <code>VM_NAME</code>, <code>LOCATION</code>, <code>HOSTNAME</code>, <code>USERNAME</code>, <code>PUBLIC_IP</code>, <code>VNET_NAME</code>, <code>SUBNET_NAME</code>, <code>NSG_NAME</code></p>
<div class="highlight"><pre><span></span><code>az<span class="w"> </span>vm<span class="w"> </span>create<span class="w"> </span>--resource-group<span class="w"> </span><span class="s2">&quot;RG_NAME&quot;</span><span class="w"> </span>--name<span class="w"> </span><span class="s2">&quot;VM_NAME&quot;</span><span class="w"> </span>--location<span class="w"> </span><span class="s2">&quot;LOCATION&quot;</span><span class="w"> </span>--image<span class="w"> </span>bunkerity:bunkerweb:bunkerweb:latest<span class="w"> </span>--accept-term<span class="w"> </span>--generate-ssh-keys<span class="w"> </span>--computer-name<span class="w"> </span><span class="s2">&quot;HOSTNAME&quot;</span><span class="w"> </span>--admin-username<span class="w"> </span><span class="s2">&quot;USERNAME&quot;</span><span class="w"> </span>--public-ip-address<span class="w"> </span><span class="s2">&quot;PUBLIC_IP&quot;</span><span class="w"> </span>--public-ip-address-allocation<span class="w"> </span>Static<span class="w"> </span>--size<span class="w"> </span>Standard_B2s<span class="w"> </span>--public-ip-sku<span class="w"> </span>Standard<span class="w"> </span>--os-disk-delete-option<span class="w"> </span>Delete<span class="w"> </span>--nic-delete-option<span class="w"> </span>Delete<span class="w"> </span>--vnet-name<span class="w"> </span><span class="s2">&quot;VNET_NAME&quot;</span><span class="w"> </span>--subnet<span class="w"> </span><span class="s2">&quot;SUBNET_NAME&quot;</span><span class="w"> </span>--nsg<span class="w"> </span><span class="s2">&quot;NSG_NAME&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition info">
<p class="admonition-title">权限要求</p>
<p>要部署 ARM 模板，您需要对您正在部署的资源具有写入权限，并有权访问 Microsoft.Resources/deployments 资源类型的所有操作。
要部署虚拟机，您需要 Microsoft.Compute/virtualMachines/write 和 Microsoft.Resources/deployments/* 权限。what-if 操作具有相同的权限要求。</p>
</div>
<p>部署 ARM 模板：</p>
<p><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fbunkerity%2Fbunkerweb%2Fmaster%2Fmisc%2Fintegrations%2Fazure-arm-template.json" target="_blank"><img alt="部署到 Azure" src="../assets/img/integration-azure-deploy.svg" /></a></p>
</div>
<div class="tabbed-block">
<p>登录到 <a href="https://portal.azure.com" target="_blank">Azure 门户</a>。</p>
<p>从<a href="https://portal.azure.com/#view/Microsoft_Azure_Marketplace/GalleryItemDetailsBladeNopdl/id/bunkerity.bunkerweb" target="_blank">创建资源菜单</a>获取 BunkerWeb。</p>
<p>您也可以通过 <a href="https://azuremarketplace.microsoft.com/fr-fr/marketplace/apps/bunkerity.bunkerweb?tab=Overview" target="_blank">Marketplace</a>。</p>
</div>
</div>
</div>
<p>您可以通过浏览虚拟机的 <code>https://your-ip-address/setup</code> URI 来访问设置向导。</p></section><section class="print-page" id="zh-quickstart-guide" heading-number="4"><h1 id="zh-quickstart-guide-_1">快速入门指南</h1>
<div class="admonition info">
<p class="admonition-title">先决条件</p>
<p>我们希望您已经熟悉<a href="#zh-concepts">核心概念</a>并已按照<a href="#zh-integrations">集成说明</a>为您的环境进行了操作。</p>
<p>本快速入门指南假设 BunkerWeb 可以从互联网访问，并且您已经配置了至少两个域：一个用于 Web UI，一个用于您的 Web 服务。</p>
<p><strong>系统要求</strong></p>
<p>BunkerWeb 的最低推荐规格是具有 2 个（虚拟）CPU 和 8 GB RAM 的机器。请注意，这对于测试环境或服务很少的设置应该足够了。</p>
<p>对于需要保护大量服务的生产环境，我们建议至少配备 4 个（虚拟）CPU 和 16 GB RAM。应根据您的用例、网络流量以及您可能面临的潜在 DDoS 攻击来调整资源。</p>
<p>如果您处于 RAM 有限的环境中或在拥有大量服务的生产环境中，强烈建议启用 CRS 规则的全局加载（通过将 <code>USE_MODSECURITY_GLOBAL_CRS</code> 参数设置为 <code>yes</code>）。更多详细信息可以在文档的<a href="#zh-advanced-running-many-services-in-production">高级用法</a>部分找到。</p>
</div>
<p>本快速入门指南将帮助您快速安装 BunkerWeb 并使用 Web 用户界面保护 Web 服务。</p>
<p>保护已经可以通过 HTTP(S) 协议访问的现有 Web 应用程序是 BunkerWeb 的主要目标：它将充当一个带有额外安全功能的经典<a href="https://en.wikipedia.org/wiki/Reverse_proxy">反向代理</a>。</p>
<p>有关真实世界的示例，请参阅仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/vtesting/examples">examples 文件夹</a>。</p>
<h2 id="zh-quickstart-guide-_2">基本设置</h2>
<div class="tabbed-set tabbed-alternate" data-tabs="1:6"><input checked="checked" id="zh-quickstart-guide-__tabbed_1_1" name="zh-quickstart-guide-__tabbed_1" type="radio" /><input id="zh-quickstart-guide-__tabbed_1_2" name="zh-quickstart-guide-__tabbed_1" type="radio" /><input id="zh-quickstart-guide-__tabbed_1_3" name="zh-quickstart-guide-__tabbed_1" type="radio" /><input id="zh-quickstart-guide-__tabbed_1_4" name="zh-quickstart-guide-__tabbed_1" type="radio" /><input id="zh-quickstart-guide-__tabbed_1_5" name="zh-quickstart-guide-__tabbed_1" type="radio" /><input id="zh-quickstart-guide-__tabbed_1_6" name="zh-quickstart-guide-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="zh-quickstart-guide-__tabbed_1_1">一体化</label><label for="zh-quickstart-guide-__tabbed_1_2">Linux</label><label for="zh-quickstart-guide-__tabbed_1_3">Docker</label><label for="zh-quickstart-guide-__tabbed_1_4">Docker autoconf</label><label for="zh-quickstart-guide-__tabbed_1_5">Kubernetes</label><label for="zh-quickstart-guide-__tabbed_1_6">Swarm</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>要部署一体化容器，请运行以下命令：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>bunkerity/bunkerweb-all-in-one:testing
</code></pre></div>
<p>默认情况下，容器暴露：</p>
<ul>
<li>8080/tcp 用于 HTTP</li>
<li>8443/tcp 用于 HTTPS</li>
<li>8443/udp 用于 QUIC</li>
<li>7000/tcp 用于在没有 BunkerWeb 前置的情况下的 Web UI 访问（不建议在生产环境中使用）</li>
</ul>
<p>一体化镜像内置了几个服务，可以通过环境变量来控制。有关更多详细信息，请参阅集成页面的<a href="#zh-integrations-all-in-one-aio-image">一体化 (AIO) 镜像部分</a>。</p>
</div>
<div class="tabbed-block">
<p>使用简易安装脚本在支持的 Linux 发行版上设置 BunkerWeb。它会自动安装和配置 NGINX，添加 BunkerWeb 仓库，并设置所需的服务。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 下载脚本及其校验和</span>
wget<span class="w"> </span>https://github.com/bunkerity/bunkerweb/releases/download/vtesting/install-bunkerweb.sh
wget<span class="w"> </span>https://github.com/bunkerity/bunkerweb/releases/download/vtesting/install-bunkerweb.sh.sha256

<span class="c1"># 验证校验和</span>
sha256sum<span class="w"> </span>-c<span class="w"> </span>install-bunkerweb.sh.sha256

<span class="c1"># 如果检查成功，则运行脚本</span>
chmod<span class="w"> </span>+x<span class="w"> </span>install-bunkerweb.sh
sudo<span class="w"> </span>./install-bunkerweb.sh
</code></pre></div>
<div class="admonition danger">
<p class="admonition-title">安全提示</p>
<p>在执行脚本之前，请务必使用提供的校验和验证脚本的完整性。</p>
</div>
<p>有关高级安装方法（包管理器、安装类型、非交互式标志、CrowdSec 集成等），请参阅<a href="#zh-integrations-linux">Linux 集成</a>。</p>
</div>
<div class="tabbed-block">
<p>这是您可以使用的完整 docker compose 文件；请注意，我们稍后会将 Web 服务连接到 <code>bw-services</code> 网络：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-env</span>
<span class="w">  </span><span class="c1"># 我们使用一个锚点来避免在两个服务中重复相同的设置</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span><span class="w"> </span><span class="c1"># 确保设置正确的 IP 范围，以便调度器可以将配置发送到实例</span>
<span class="w">  </span><span class="c1"># 可选：设置一个 API 令牌并在两个容器中镜像它</span>
<span class="w">  </span><span class="nt">API_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">  </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 这是将用于在调度器中识别实例的名称</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w"> </span><span class="c1"># 用于 QUIC / HTTP3 支持</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span><span class="w"> </span><span class="c1"># 我们使用锚点来避免为所有服务重复相同的设置</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span><span class="w"> </span><span class="c1"># 确保设置正确的实例名称</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">UI_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://bw-ui:7000&quot;</span><span class="w"> </span><span class="c1"># 如果需要，请更改它</span>
<span class="w">      </span><span class="nt">USE_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;redis&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w"> </span><span class="c1"># Redis 服务用于持久化报告/封禁/统计数据</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:7-alpine</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">      </span><span class="no">redis-server</span>
<span class="w">      </span><span class="no">--maxmemory 256mb</span>
<span class="w">      </span><span class="no">--maxmemory-policy allkeys-lru</span>
<span class="w">      </span><span class="no">--save 60 1000</span>
<span class="w">      </span><span class="no">--appendonly yes</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis-data:/data</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">redis-data</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span><span class="w"> </span><span class="c1"># 确保设置正确的 IP 范围，以便调度器可以将配置发送到实例</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>这是您可以使用的完整 docker compose 文件；请注意，我们稍后会将 Web 服务连接到 <code>bw-services</code> 网络：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-ui-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-ui-env</span>
<span class="w">  </span><span class="c1"># 我们锚定环境变量以避免重复</span>
<span class="w">  </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">  </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w"> </span><span class="c1"># 用于 QUIC / HTTP3 支持</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.INSTANCE=yes&quot;</span><span class="w"> </span><span class="c1"># 我们设置实例标签以允许 autoconf 检测实例</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-ui-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">UI_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://bw-ui:7000&quot;</span><span class="w"> </span><span class="c1"># 如果需要，请更改它</span>
<span class="w">      </span><span class="nt">USE_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;redis&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:testing</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-ui-env</span>
<span class="w">      </span><span class="nt">DOCKER_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tcp://bw-docker:2375&quot;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tecnativa/docker-socket-proxy:nightly</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock:ro</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CONTAINERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warning&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>

<span class="w">  </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-ui-env</span>
<span class="w">      </span><span class="nt">TOTP_ENCRYPTION_KEYS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mysecret&quot;</span><span class="w"> </span><span class="c1"># 记得设置一个更强的密钥（请参阅先决条件部分）</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w"> </span><span class="c1"># Redis 服务用于持久化报告/封禁/统计数据</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:7-alpine</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">      </span><span class="no">redis-server</span>
<span class="w">      </span><span class="no">--maxmemory 256mb</span>
<span class="w">      </span><span class="no">--maxmemory-policy allkeys-lru</span>
<span class="w">      </span><span class="no">--save 60 1000</span>
<span class="w">      </span><span class="no">--appendonly yes</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis-data:/data</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">redis-data</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>安装 Kubernetes 的推荐方法是使用位于 <code>https://repo.bunkerweb.io/charts</code> 的 Helm chart：</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>bunkerweb<span class="w"> </span>https://repo.bunkerweb.io/charts
</code></pre></div>
<p>然后您可以使用该仓库中的 <code>bunkerweb</code> helm chart：</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>mybw<span class="w"> </span>bunkerweb/bunkerweb<span class="w"> </span>--namespace<span class="w"> </span>bunkerweb<span class="w"> </span>--create-namespace
</code></pre></div>
<p>安装后，您可以获取 <code>LoadBalancer</code> 的 IP 地址来设置您的域：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>-n<span class="w"> </span>bunkerweb<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>mybw-external<span class="w"> </span>-o<span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
<p><strong>更多信息可以在 <a href="#zh-integrations-swarm">Swarm 集成文档</a>中找到。</strong></p>
</div>
<p>这是您可以使用的完整 docker compose 堆栈文件；请注意，我们稍后会将 Web 服务连接到 <code>bw-services</code> 网络：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-ui-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-ui-env</span>
<span class="w">  </span><span class="c1"># 我们锚定环境变量以避免重复</span>
<span class="w">  </span><span class="nt">SWARM_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">  </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">udp</span><span class="w"> </span><span class="c1"># 用于 QUIC / HTTP3 支持</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">SWARM_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">global</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">worker&quot;</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.INSTANCE=yes&quot;</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-ui-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">USE_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bw-redis&quot;</span>
<span class="w">      </span><span class="nt">UI_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://bw-ui:7000&quot;</span><span class="w"> </span><span class="c1"># 如果需要，请更改它</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-ui-env</span>
<span class="w">      </span><span class="nt">DOCKER_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tcp://bw-docker:2375&quot;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tecnativa/docker-socket-proxy:nightly</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock:ro</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CONFIGS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">CONTAINERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">SERVICES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">SWARM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">TASKS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warning&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">manager&quot;</span>

<span class="w">  </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-ui-env</span>
<span class="w">      </span><span class="nt">TOTP_ENCRYPTION_KEYS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mysecret&quot;</span><span class="w"> </span><span class="c1"># 记得设置一个更强的密钥（请参阅先决条件部分）</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-redis</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:7-alpine</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-quickstart-guide-_3">完成设置向导</h2>
<div class="admonition tip">
<p class="admonition-title">访问设置向导</p>
<p>您可以通过浏览服务器的 <code>https://your-fqdn-or-ip-addresss/setup</code> URI 来访问设置向导。</p>
</div>
<h3 id="zh-quickstart-guide-_4">创建一个管理员帐户</h3>
<p>您应该会看到一个像这样的设置页面：</p>
<figure>
<p><img align="center" alt="设置向导登录页面" src="../assets/img/ui-wizard-step1.png" />
  </p>
<figcaption>设置向导登录页面</figcaption>
</figure>
<p>进入设置页面后，您可以输入<strong>管理员用户名、电子邮件和密码</strong>，然后点击“下一步”按钮。</p>
<h3 id="zh-quickstart-guide-https">配置反向代理、HTTPS 和其他高级设置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="zh-quickstart-guide-__tabbed_2_1" name="zh-quickstart-guide-__tabbed_2" type="radio" /><input id="zh-quickstart-guide-__tabbed_2_2" name="zh-quickstart-guide-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="zh-quickstart-guide-__tabbed_2_1">基本设置</label><label for="zh-quickstart-guide-__tabbed_2_2">高级设置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>下一步将要求您输入 Web UI 将使用的<strong>服务器名称</strong>（域名/FQDN）。</p>
<p>您还可以选择启用 <a href="#zh-features-lets-encrypt">Let's Encrypt</a></p>
<p><figure markdown>
  <img align="center" alt="设置向导第 2 步" src="../assets/img/ui-wizard-step2.png" />
  <figcaption>设置向导第 2 步</figcaption>
</figure></p>
</div>
<div class="tabbed-block">
<p>下一步将要求您输入 Web UI 将使用的<strong>服务器名称</strong>（域名/FQDN）。</p>
<p>您还可以选择启用 <a href="#zh-features-lets-encrypt">Let's Encrypt</a>。</p>
<p>如果您展开 <code>高级设置</code> 部分，您还可以配置以下选项：</p>
<ul>
<li><strong>反向代理</strong>：调整您的管理员界面的反向代理设置（例如，如果您想使用一个路径）。</li>
<li><a href="#zh-features-real-ip"><strong>真实 IP</strong></a>：配置真实 IP 设置以正确识别客户端的 IP 地址（例如，如果您位于负载均衡器或 CDN 之后）。</li>
<li><a href="#zh-features-custom-ssl-certificate"><strong>自定义证书</strong></a>：如果您不想使用 Let's Encrypt，可以上传自定义 TLS 证书。</li>
</ul>
<p><figure markdown>
  <img align="center" alt="设置向导第 2 步" src="../assets/img/ui-wizard-step2-advanced.png" />
  <figcaption>设置向导第 2 步（高级）</figcaption>
</figure></p>
</div>
</div>
</div>
<h3 id="zh-quickstart-guide-pro">PRO 激活</h3>
<p>如果您拥有 PRO 许可证，可以在 <code>升级到 PRO</code> 部分输入您的许可证密钥来激活它。这将启用 BunkerWeb 的 PRO 功能。</p>
<figure>
<p><img align="center" alt="设置向导 PRO 步骤" src="../assets/img/ui-wizard-step3.png" />
  </p>
<figcaption>设置向导 PRO 步骤</figcaption>
</figure>
<h3 id="zh-quickstart-guide-_5">您的设置概览</h3>
<p>最后一步将为您提供您所输入设置的概览。您可以点击“设置”按钮来完成设置。</p>
<figure>
<p><img align="center" alt="设置向导最后一步" src="../assets/img/ui-wizard-step4.png" />
  </p>
<figcaption>设置向导最后一步</figcaption>
</figure>
<h2 id="zh-quickstart-guide-web">访问 Web 界面</h2>
<p>您现在可以通过浏览您在上一步中配置的域以及如果您更改了 URI（默认为 <code>https://your-domain/</code>）来访问 Web 界面。</p>
<figure>
<p><img align="center" alt="Web 界面登录页面" src="../assets/img/ui-login.png" />
  </p>
<figcaption>Web 界面登录页面</figcaption>
</figure>
<p>您现在可以使用您在设置向导期间创建的管理员帐户登录。</p>
<figure>
<p><img align="center" alt="Web 界面主页" src="../assets/img/ui-home.png" />
  </p>
<figcaption>Web 界面主页</figcaption>
</figure>
<h2 id="zh-quickstart-guide-_6">创建一个新服务</h2>
<div class="tabbed-set tabbed-alternate" data-tabs="3:7"><input checked="checked" id="zh-quickstart-guide-__tabbed_3_1" name="zh-quickstart-guide-__tabbed_3" type="radio" /><input id="zh-quickstart-guide-__tabbed_3_2" name="zh-quickstart-guide-__tabbed_3" type="radio" /><input id="zh-quickstart-guide-__tabbed_3_3" name="zh-quickstart-guide-__tabbed_3" type="radio" /><input id="zh-quickstart-guide-__tabbed_3_4" name="zh-quickstart-guide-__tabbed_3" type="radio" /><input id="zh-quickstart-guide-__tabbed_3_5" name="zh-quickstart-guide-__tabbed_3" type="radio" /><input id="zh-quickstart-guide-__tabbed_3_6" name="zh-quickstart-guide-__tabbed_3" type="radio" /><input id="zh-quickstart-guide-__tabbed_3_7" name="zh-quickstart-guide-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="zh-quickstart-guide-__tabbed_3_1">Web UI</label><label for="zh-quickstart-guide-__tabbed_3_2">一体化</label><label for="zh-quickstart-guide-__tabbed_3_3">Linux variables.env 文件</label><label for="zh-quickstart-guide-__tabbed_3_4">Docker</label><label for="zh-quickstart-guide-__tabbed_3_5">Docker autoconf 标签</label><label for="zh-quickstart-guide-__tabbed_3_6">Kubernetes 注解</label><label for="zh-quickstart-guide-__tabbed_3_7">Swarm 标签</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>您可以通过导航到 Web 界面的 <code>服务</code> 部分并点击 <code>➕ 创建新服务</code> 按钮来创建一个新服务。</p>
<p>使用 Web 界面创建服务有多种方式：</p>
<ul>
<li><strong>简单模式</strong>将引导您完成创建新服务的过程。</li>
<li><strong>高级模式</strong>将允许您使用更多选项来配置服务。</li>
<li><strong>原始模式</strong>将允许您直接输入配置，就像编辑 <code>variables.env</code> 文件一样。</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">草稿服务</p>
<p>您可以创建一个草稿服务来保存您的进度，并在以后返回。只需点击 <code>🌐 在线</code> 按钮即可将服务切换到草稿模式。</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="4:3"><input checked="checked" id="zh-quickstart-guide-__tabbed_4_1" name="zh-quickstart-guide-__tabbed_4" type="radio" /><input id="zh-quickstart-guide-__tabbed_4_2" name="zh-quickstart-guide-__tabbed_4" type="radio" /><input id="zh-quickstart-guide-__tabbed_4_3" name="zh-quickstart-guide-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="zh-quickstart-guide-__tabbed_4_1">简单模式</label><label for="zh-quickstart-guide-__tabbed_4_2">高级模式</label><label for="zh-quickstart-guide-__tabbed_4_3">原始模式</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>在此模式下，您可以从可用模板中选择并填写必填字段。</p>
<p><figure markdown>
  <img align="center" alt="Web 界面创建服务简单模式" src="../assets/img/ui-create-service-easy.png" />
  <figcaption>Web 界面创建服务简单模式</figcaption>
</figure></p>
<ul>
<li>选择模板后，您可以填写必填字段并按照说明创建服务。</li>
<li>配置完服务后，您可以点击 <code>💾 保存</code> 按钮保存配置。</li>
</ul>
</div>
<div class="tabbed-block">
<p>在此模式下，您可以使用更多选项来配置服务，同时可以看到所有不同插件的所有可用设置。</p>
<p><figure markdown>
  <img align="center" alt="Web 界面创建服务高级模式" src="../assets/img/ui-create-service-advanced.png" />
  <figcaption>Web 界面创建服务高级模式</figcaption>
</figure></p>
<ul>
<li>要在不同插件之间导航，您可以使用页面左侧的导航菜单。</li>
<li>每个设置都有一小段信息，可以帮助您了解它的作用。</li>
<li>配置完服务后，您可以点击 <code>💾 保存</code> 按钮保存配置。</li>
</ul>
</div>
<div class="tabbed-block">
<p>在此模式下，您可以直接输入配置，就像编辑 <code>variables.env</code> 文件一样。</p>
<p><figure markdown>
  <img align="center" alt="Web 界面创建服务原始模式" src="../assets/img/ui-create-service-raw.png" />
  <figcaption>Web 界面创建服务原始模式</figcaption>
</figure></p>
<ul>
<li>配置完服务后，您可以点击 <code>💾 保存</code> 按钮保存配置。</li>
</ul>
</div>
</div>
</div>
<p>🚀 保存配置后，您应该会在服务列表中看到您的新服务。</p>
<p><figure markdown>
  <img align="center" alt="Web 界面服务页面" src="../assets/img/ui-services.png" />
  <figcaption>Web 界面服务页面</figcaption>
</figure></p>
<p>如果您希望编辑服务，可以点击服务名称或 <code>📝 编辑</code> 按钮。</p>
</div>
<div class="tabbed-block">
<p>当使用一体化镜像时，新服务是通过向 <code>bunkerweb-aio</code> 容器的 <code>docker run</code> 命令添加环境变量来配置的。如果容器已经在运行，您必须停止并删除它，然后用更新的环境变量重新运行它。</p>
<p>假设您想保护一个应用程序 <code>myapp</code>（在另一个容器中运行，并可以从 BunkerWeb 作为 <code>http://myapp:8080</code> 访问），并使其在 <code>www.example.com</code> 上可用。您将在您的 <code>docker run</code> 命令中添加或修改以下环境变量：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 首先，如果现有容器正在运行，请停止并删除它：</span>
<span class="c1"># docker stop bunkerweb-aio</span>
<span class="c1"># docker rm bunkerweb-aio</span>

<span class="c1"># 然后，用额外/更新的环境变量重新运行 bunkerweb-aio 容器：</span>
docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="c1"># --- 为您的新服务添加/修改这些环境变量 ---</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">MULTISITE</span><span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">SERVER_NAME</span><span class="o">=</span><span class="s2">&quot;www.example.com&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="s2">&quot;www.example.com_USE_REVERSE_PROXY=yes&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="s2">&quot;www.example.com_REVERSE_PROXY_HOST=http://myapp:8080&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="s2">&quot;www.example.com_REVERSE_PROXY_URL=/&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="c1"># --- 包括任何其他现有的用于 UI、Redis、CrowdSec 等的环境变量 ---</span>
<span class="w">  </span>bunkerity/bunkerweb-all-in-one:testing
</code></pre></div>
<p>您的应用程序容器 (<code>myapp</code>) 和 <code>bunkerweb-aio</code> 容器必须在同一个 Docker 网络上，以便 BunkerWeb 能够使用主机名 <code>myapp</code> 访问它。</p>
<p><strong>网络设置示例：</strong>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 创建一个自定义 Docker 网络（如果还没有的话）：</span>
docker<span class="w"> </span>network<span class="w"> </span>create<span class="w"> </span>my-app-network

<span class="c1"># 2. 在此网络上运行您的应用程序容器：</span>
docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--name<span class="w"> </span>myapp<span class="w"> </span>--network<span class="w"> </span>my-app-network<span class="w"> </span>your-app-image

<span class="c1"># 3. 将 --network my-app-network 添加到 bunkerweb-aio 的 docker run 命令中：</span>
docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--network<span class="w"> </span>my-app-network<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="c1">#   ... （如上主示例所示的所有其他相关环境变量）...</span>
<span class="w">  </span>bunkerity/bunkerweb-all-in-one:testing
</code></pre></div></p>
<p>请确保将 <code>myapp</code> 替换为您的应用程序容器的实际名称或 IP，并将 <code>http://myapp:8080</code> 替换为其正确的地址和端口。</p>
</div>
<div class="tabbed-block">
<p>我们假设您已经按照<a href="#zh-quickstart-guide-__tabbed_1_2">基本设置</a>进行了操作，并且 Linux 集成正在您的机器上运行。</p>
<p>您可以通过编辑位于 <code>/etc/bunkerweb/</code> 目录中的 <code>variables.env</code> 文件来创建一个新服务。</p>
<div class="highlight"><pre><span></span><code>nano<span class="w"> </span>/etc/bunkerweb/variables.env
</code></pre></div>
<p>然后您可以添加以下配置：</p>
<div class="highlight"><pre><span></span><code><span class="nv">SERVER_NAME</span><span class="o">=</span>www.example.com
<span class="nv">MULTISITE</span><span class="o">=</span>yes
www.example.com_USE_REVERSE_PROXY<span class="o">=</span>yes
www.example.com_REVERSE_PROXY_URL<span class="o">=</span>/
www.example.com_REVERSE_PROXY_HOST<span class="o">=</span>http://myapp:8080
</code></pre></div>
<p>然后您可以重新加载 <code>bunkerweb-scheduler</code> 服务以应用更改。</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>reload<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</div>
<div class="tabbed-block">
<p>我们假设您已经按照<a href="#zh-quickstart-guide-__tabbed_1_3">基本设置</a>进行了操作，并且 Docker 集成正在您的机器上运行。</p>
<p>您必须有一个名为 <code>bw-services</code> 的网络，以便您可以连接您现有的应用程序并配置 BunkerWeb：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">myapp</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginxdemos/nginx-hello</span>
<span class="w">      </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
<p>之后，您可以在您在上一步中创建的 docker compose 文件中手动添加服务：</p>
<div class="highlight"><pre><span></span><code><span class="nn">...</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">bw-scheduler</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">SERVER_NAME</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;www.example.com&quot;</span><span class="w"> </span><span class="c1"># 当使用 Docker 集成时，您可以直接在调度器中设置配置，确保设置正确的域名</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="c1"># 启用多站点模式，以便您可以添加多个服务</span>
<span class="w">      </span><span class="nt">www.example.com_USE_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">www.example.com_REVERSE_PROXY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="w">      </span><span class="nt">www.example.com_REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://myapp:8080&quot;</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<p>然后您可以重启 <code>bw-scheduler</code> 服务以应用更改。</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>down<span class="w"> </span>bw-scheduler<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>-d<span class="w"> </span>bw-scheduler
</code></pre></div>
</div>
<div class="tabbed-block">
<p>我们假设您已经按照<a href="#zh-quickstart-guide-__tabbed_1_4">基本设置</a>进行了操作，并且 Docker autoconf 集成正在您的机器上运行。</p>
<p>您必须有一个名为 <code>bw-services</code> 的网络，以便您可以连接您现有的应用程序并使用标签配置 BunkerWeb：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">myapp</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginxdemos/nginx-hello</span>
<span class="w">      </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=www.example.com&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_REVERSE_PROXY=yes&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_URL=/&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_HOST=http://myapp:8080&quot;</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
<p>这样做将自动创建一个新服务，并使用提供的标签作为配置。</p>
</div>
<div class="tabbed-block">
<p>我们假设您已经按照<a href="#zh-quickstart-guide-__tabbed_1_5">基本设置</a>进行了操作，并且 Kubernetes 堆栈正在您的集群上运行。</p>
<p>假设您有一个典型的 Deployment，并带有一个 Service，以便从集群内部访问 Web 应用程序：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginxdemos/nginx-hello</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc-app</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</code></pre></div>
<p>这是相应的 Ingress 定义，用于服务和保护 Web 应用程序：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bunkerweb.io/DUMMY_SETTING</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;value&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.example.com</span>
<span class="w">      </span><span class="nt">http</span><span class="p">:</span>
<span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">              </span><span class="nt">service</span><span class="p">:</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc-app</span>
<span class="w">              </span><span class="nt">port</span><span class="p">:</span>
<span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
<p><strong>更多信息可以在 <a href="#zh-integrations-swarm">Swarm 集成文档</a>中找到。</strong></p>
</div>
<p>我们假设您已经按照<a href="#zh-quickstart-guide-__tabbed_1_5">基本设置</a>进行了操作，并且 Swarm 堆栈正在您的集群上运行，并连接到一个名为 <code>bw-services</code> 的网络，以便您可以连接您现有的应用程序并使用标签配置 BunkerWeb：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">myapp</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginxdemos/nginx-hello</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role==worker&quot;</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=www.example.com&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_REVERSE_PROXY=yes&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_URL=/&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_HOST=http://myapp:8080&quot;</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-quickstart-guide-_7">更进一步</h2>
<p>恭喜！您刚刚安装了 BunkerWeb 并保护了您的第一个 Web 服务。请注意，BunkerWeb 在安全性和与其他系统和解决方案的集成方面提供了更多功能。以下是一些资源和行动，可以帮助您继续加深对该解决方案的了解：</p>
<ul>
<li>加入 Bunker 社区：<a href="https://discord.com/invite/fTf46FmtyD">Discord</a>、<a href="https://www.linkedin.com/company/bunkerity/">LinkedIn</a>、<a href="https://github.com/bunkerity">GitHub</a>、<a href="https://x.com/bunkerity">X (Formerly Twitter)</a></li>
<li>查看<a href="https://www.bunkerweb.io/blog?utm_campaign=self&amp;utm_source=doc">官方博客</a></li>
<li>探索文档中的<a href="#zh-advanced">高级用例</a></li>
<li><a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">与我们联系</a>讨论您组织的需求</li>
</ul></section><section class="print-page" id="zh-features" heading-number="5"><h1 id="zh-features-_1">功能</h1>
<p>本节包含 BunkerWeb 支持的完整设置列表。若尚未熟悉 BunkerWeb，建议先阅读文档中的<a href="#zh-concepts">概念</a>部分。请根据您的<a href="#zh-integrations">集成</a>说明应用相应的设置。</p>
<h2 id="zh-features-_2">全局设置</h2>
<p>STREAM 支持 <img alt="⚠" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/26a0.svg" title=":warning:" /></p>
<p>通用插件为 BunkerWeb 提供了核心配置框架，允许您定义控制 Web 服务如何受保护和交付的基本设置。这个基础插件管理着整个 BunkerWeb 生态系统的基本方面，如安全模式、服务器默认值、日志记录行为和关键操作参数。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当 BunkerWeb 启动时，通用插件会加载并应用您的核心配置设置。</li>
<li>安全模式可以全局设置或按站点设置，以确定应用
    的保护级别。</li>
<li>默认服务器设置为任何未指定的多站点配置建立
    了回退值。</li>
<li>日志记录参数控制记录哪些信息以及如何格式化。</li>
<li>这些设置构成了所有其他 BunkerWeb 插件和功能运行的基础。</li>
</ol>
<h3 id="zh-features-_3">多站点模式</h3>
<p>当 <code>MULTISITE</code> 设置为 <code>yes</code> 时，BunkerWeb 可以托管和保护多个网站，每个网站都有其独特的配置。此功能在以下场景中特别有用：</p>
<ul>
<li>托管具有不同配置的多个域</li>
<li>运行具有不同安全要求的多个应用程序</li>
<li>对不同服务应用量身定制的安全策略</li>
</ul>
<p>在多站点模式下，每个站点都由一个唯一的 <code>SERVER_NAME</code> 标识。要应用特定于站点的设置，请将主 <code>SERVER_NAME</code> 作为前缀添加到设置名称中。例如：</p>
<ul>
<li><code>www.example.com_USE_ANTIBOT=captcha</code> 为 <code>www.example.com</code> 启用验证码。</li>
<li><code>myapp.example.com_USE_GZIP=yes</code> 为 <code>myapp.example.com</code> 启用 GZIP 压缩。</li>
</ul>
<p>这种方法可确保在多站点环境中将设置应用于正确的站点。</p>
<h3 id="zh-features-_4">多个设置</h3>
<p>BunkerWeb 中的某些设置支持同一功能的多个配置。要定义多组设置，请在设置名称后附加一个数字后缀。例如：</p>
<ul>
<li><code>REVERSE_PROXY_URL_1=/subdir</code> 和 <code>REVERSE_PROXY_HOST_1=http://myhost1</code> 配置第一个反向代理。</li>
<li><code>REVERSE_PROXY_URL_2=/anotherdir</code> 和 <code>REVERSE_PROXY_HOST_2=http://myhost2</code> 配置第二个反向代理。</li>
</ul>
<p>这种模式允许您为需要不同用例的不同值的功能（如反向代理、端口或其他设置）管理多个配置。</p>
<h3 id="zh-features-_5">安全模式</h3>
<p><code>SECURITY_MODE</code> 设置决定了 BunkerWeb 如何处理检测到的威胁。这个灵活的功能允许您根据具体需求在监控或主动阻止可疑活动之间进行选择：</p>
<ul>
<li><strong><code>detect</code></strong>：记录潜在威胁而不阻止访问。此模式对于以安全、无干扰的方式识别和分析误报非常有用。</li>
<li><strong><code>block</code></strong>（默认）：主动阻止检测到的威胁，同时记录事件以防止未经授权的访问并保护您的应用程序。</li>
</ul>
<p>切换到 <code>detect</code> 模式可以帮助您识别和解决潜在的误报，而不会干扰合法客户端。一旦这些问题得到解决，您就可以自信地切换回 <code>block</code> 模式以获得全面保护。</p>
<h3 id="zh-features-_6">配置设置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="1:9"><input checked="checked" id="zh-features-__tabbed_1_1" name="zh-features-__tabbed_1" type="radio" /><input id="zh-features-__tabbed_1_2" name="zh-features-__tabbed_1" type="radio" /><input id="zh-features-__tabbed_1_3" name="zh-features-__tabbed_1" type="radio" /><input id="zh-features-__tabbed_1_4" name="zh-features-__tabbed_1" type="radio" /><input id="zh-features-__tabbed_1_5" name="zh-features-__tabbed_1" type="radio" /><input id="zh-features-__tabbed_1_6" name="zh-features-__tabbed_1" type="radio" /><input id="zh-features-__tabbed_1_7" name="zh-features-__tabbed_1" type="radio" /><input id="zh-features-__tabbed_1_8" name="zh-features-__tabbed_1" type="radio" /><input id="zh-features-__tabbed_1_9" name="zh-features-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_1_1">核心设置</label><label for="zh-features-__tabbed_1_2">API 设置</label><label for="zh-features-__tabbed_1_3">网络和端口设置</label><label for="zh-features-__tabbed_1_4">流服务器设置</label><label for="zh-features-__tabbed_1_5">工作进程设置</label><label for="zh-features-__tabbed_1_6">内存设置</label><label for="zh-features-__tabbed_1_7">日志设置</label><label for="zh-features-__tabbed_1_8">集成设置</label><label for="zh-features-__tabbed_1_9">Nginx 设置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SERVER_NAME</code></td>
<td><code>www.example.com</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>主域名：</strong> 此站点的主域名。在多站点模式下为必需。</td>
</tr>
<tr>
<td><code>BUNKERWEB_INSTANCES</code></td>
<td><code>127.0.0.1</code></td>
<td>global</td>
<td>否</td>
<td><strong>BunkerWeb 实例：</strong> 以空格分隔的 BunkerWeb 实例列表。</td>
</tr>
<tr>
<td><code>MULTISITE</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>多站点：</strong> 设置为 <code>yes</code> 以启用托管具有不同配置的多个网站。</td>
</tr>
<tr>
<td><code>SECURITY_MODE</code></td>
<td><code>block</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>安全级别：</strong> 控制安全强制执行的级别。选项：<code>detect</code> 或 <code>block</code>。</td>
</tr>
<tr>
<td><code>SERVER_TYPE</code></td>
<td><code>http</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>服务器类型：</strong> 定义服务器是 <code>http</code> 还是 <code>stream</code> 类型。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_API</code></td>
<td><code>yes</code></td>
<td>global</td>
<td>否</td>
<td><strong>激活 API：</strong> 激活 API 以控制 BunkerWeb。</td>
</tr>
<tr>
<td><code>API_HTTP_PORT</code></td>
<td><code>5000</code></td>
<td>global</td>
<td>否</td>
<td><strong>API 端口：</strong> API 的监听端口号。</td>
</tr>
<tr>
<td><code>API_HTTPS_PORT</code></td>
<td><code>6000</code></td>
<td>global</td>
<td>否</td>
<td><strong>API HTTPS 端口：</strong> API 的监听端口号 (TLS)。</td>
</tr>
<tr>
<td><code>API_LISTEN_HTTP</code></td>
<td><code>yes</code></td>
<td>global</td>
<td>否</td>
<td><strong>API 监听 HTTP：</strong> 启用 API 的 HTTP 监听器。</td>
</tr>
<tr>
<td><code>API_LISTEN_HTTPS</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>API 监听 HTTPS：</strong> 启用 API 的 HTTPS (TLS) 监听器。</td>
</tr>
<tr>
<td><code>API_LISTEN_IP</code></td>
<td><code>0.0.0.0</code></td>
<td>global</td>
<td>否</td>
<td><strong>API 监听 IP：</strong> API 的监听 IP 地址。</td>
</tr>
<tr>
<td><code>API_SERVER_NAME</code></td>
<td><code>bwapi</code></td>
<td>global</td>
<td>否</td>
<td><strong>API 服务器名称：</strong> API 的服务器名称（虚拟主机）。</td>
</tr>
<tr>
<td><code>API_WHITELIST_IP</code></td>
<td><code>127.0.0.0/8</code></td>
<td>global</td>
<td>否</td>
<td><strong>API 白名单 IP：</strong> 允许联系 API 的 IP/网络列表。</td>
</tr>
<tr>
<td><code>API_TOKEN</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>API 访问令牌（可选）：</strong> 如果设置，所有 API 请求都必须包含 <code>Authorization: Bearer &lt;token&gt;</code>。</td>
</tr>
</tbody>
</table>
<p>注意：出于引导原因，如果您启用 <code>API_TOKEN</code>，您必须在 BunkerWeb 实例和调度程序的<strong>两个</strong>环境中都设置它。当 <code>API_TOKEN</code> 存在于其环境中时，调度程序会自动包含 <code>Authorization</code> 标头。如果未设置，则不发送标头，BunkerWeb 将不强制执行令牌身份验证。您可以通过设置 <code>API_LISTEN_HTTPS=yes</code>（端口：<code>API_HTTPS_PORT</code>，默认 <code>6000</code>）通过 HTTPS 公开 API。</p>
<p>使用 curl 的测试示例（替换令牌和主机）：</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Host: bwapi&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$API_TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>http://&lt;bunkerweb-host&gt;:5000/ping

curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Host: bwapi&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$API_TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>--insecure<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>https://&lt;bunkerweb-host&gt;:6000/ping
</code></pre></div>
</div>
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HTTP_PORT</code></td>
<td><code>8080</code></td>
<td>global</td>
<td>是</td>
<td><strong>HTTP 端口：</strong> HTTP 流量的端口号。</td>
</tr>
<tr>
<td><code>HTTPS_PORT</code></td>
<td><code>8443</code></td>
<td>global</td>
<td>是</td>
<td><strong>HTTPS 端口：</strong> HTTPS 流量的端口号。</td>
</tr>
<tr>
<td><code>USE_IPV6</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>IPv6 支持：</strong> 启用 IPv6 连接。</td>
</tr>
<tr>
<td><code>DNS_RESOLVERS</code></td>
<td><code>127.0.0.11</code></td>
<td>global</td>
<td>否</td>
<td><strong>DNS 解析器：</strong> 要使用的解析器的 DNS 地址。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LISTEN_STREAM</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>监听流：</strong> 启用对非 SSL（直通）的监听。</td>
</tr>
<tr>
<td><code>LISTEN_STREAM_PORT</code></td>
<td><code>1337</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>流端口：</strong> 非 SSL（直通）的监听端口。</td>
</tr>
<tr>
<td><code>LISTEN_STREAM_PORT_SSL</code></td>
<td><code>4242</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>流 SSL 端口：</strong> SSL（直通）的监听端口。</td>
</tr>
<tr>
<td><code>USE_TCP</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>TCP 监听：</strong> 启用 TCP 监听（流）。</td>
</tr>
<tr>
<td><code>USE_UDP</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>UDP 监听：</strong> 启用 UDP 监听（流）。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WORKER_PROCESSES</code></td>
<td><code>auto</code></td>
<td>global</td>
<td>否</td>
<td><strong>工作进程数：</strong> 工作进程的数量。设置为 <code>auto</code> 以使用可用核心数。</td>
</tr>
<tr>
<td><code>WORKER_CONNECTIONS</code></td>
<td><code>1024</code></td>
<td>global</td>
<td>否</td>
<td><strong>工作连接数：</strong> 每个工作进程的最大连接数。</td>
</tr>
<tr>
<td><code>WORKER_RLIMIT_NOFILE</code></td>
<td><code>2048</code></td>
<td>global</td>
<td>否</td>
<td><strong>文件描述符限制：</strong> 每个工作进程的最大打开文件数。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WORKERLOCK_MEMORY_SIZE</code></td>
<td><code>48k</code></td>
<td>global</td>
<td>否</td>
<td><strong>工作锁内存大小：</strong> 用于初始化工作进程的 lua_shared_dict 大小。</td>
</tr>
<tr>
<td><code>DATASTORE_MEMORY_SIZE</code></td>
<td><code>64m</code></td>
<td>global</td>
<td>否</td>
<td><strong>数据存储内存大小：</strong> 内部数据存储的大小。</td>
</tr>
<tr>
<td><code>CACHESTORE_MEMORY_SIZE</code></td>
<td><code>64m</code></td>
<td>global</td>
<td>否</td>
<td><strong>缓存存储内存大小：</strong> 内部缓存存储的大小。</td>
</tr>
<tr>
<td><code>CACHESTORE_IPC_MEMORY_SIZE</code></td>
<td><code>16m</code></td>
<td>global</td>
<td>否</td>
<td><strong>缓存存储 IPC 内存大小：</strong> 内部缓存存储 (ipc) 的大小。</td>
</tr>
<tr>
<td><code>CACHESTORE_MISS_MEMORY_SIZE</code></td>
<td><code>16m</code></td>
<td>global</td>
<td>否</td>
<td><strong>缓存存储未命中内存大小：</strong> 内部缓存存储（未命中）的大小。</td>
</tr>
<tr>
<td><code>CACHESTORE_LOCKS_MEMORY_SIZE</code></td>
<td><code>16m</code></td>
<td>global</td>
<td>否</td>
<td><strong>缓存存储锁内存大小：</strong> 内部缓存存储（锁）的大小。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LOG_FORMAT</code></td>
<td><code>$host $remote_addr - $request_id $remote_user [$time_local] \"$request\" $status $body_bytes_sent \"$http_referer\" \"$http_user_agent\"</code></td>
<td>global</td>
<td>否</td>
<td><strong>日志格式：</strong> 用于访问日志的格式。</td>
</tr>
<tr>
<td><code>LOG_LEVEL</code></td>
<td><code>notice</code></td>
<td>global</td>
<td>否</td>
<td><strong>日志级别：</strong> 错误日志的详细程度。选项：<code>debug</code>, <code>info</code>, <code>notice</code>, <code>warn</code>, <code>error</code>, <code>crit</code>, <code>alert</code>, <code>emerg</code>。</td>
</tr>
<tr>
<td><code>TIMERS_LOG_LEVEL</code></td>
<td><code>debug</code></td>
<td>global</td>
<td>否</td>
<td><strong>计时器日志级别：</strong> 计时器的日志级别。选项：<code>debug</code>, <code>info</code>, <code>notice</code>, <code>warn</code>, <code>err</code>, <code>crit</code>, <code>alert</code>, <code>emerg</code>。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">日志记录最佳实践</p>
<ul>
<li>对于生产环境，请使用 <code>notice</code>、<code>warn</code> 或 <code>error</code> 日志级别以最小化日志量。</li>
<li>为了调试问题，请暂时将日志级别设置为 <code>debug</code> 以获取更详细的信息。</li>
</ul>
</div>
</div>
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AUTOCONF_MODE</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>自动配置模式：</strong> 启用 Autoconf Docker 集成。</td>
</tr>
<tr>
<td><code>SWARM_MODE</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>Swarm 模式：</strong> 启用 Docker Swarm 集成。</td>
</tr>
<tr>
<td><code>KUBERNETES_MODE</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>Kubernetes 模式：</strong> 启用 Kubernetes 集成。</td>
</tr>
<tr>
<td><code>USE_TEMPLATE</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>使用模板：</strong> 要使用的配置模板，它将覆盖特定设置的默认值。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NGINX_PREFIX</code></td>
<td><code>/etc/nginx/</code></td>
<td>global</td>
<td>否</td>
<td><strong>Nginx 前缀：</strong> nginx 将搜索配置的位置。</td>
</tr>
<tr>
<td><code>SERVER_NAMES_HASH_BUCKET_SIZE</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>服务器名称哈希桶大小：</strong> <code>server_names_hash_bucket_size</code> 指令的值。</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<h3 id="zh-features-_7">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="2:4"><input checked="checked" id="zh-features-__tabbed_2_1" name="zh-features-__tabbed_2" type="radio" /><input id="zh-features-__tabbed_2_2" name="zh-features-__tabbed_2" type="radio" /><input id="zh-features-__tabbed_2_3" name="zh-features-__tabbed_2" type="radio" /><input id="zh-features-__tabbed_2_4" name="zh-features-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_2_1">基本生产设置</label><label for="zh-features-__tabbed_2_2">开发模式</label><label for="zh-features-__tabbed_2_3">多站点配置</label><label for="zh-features-__tabbed_2_4">流服务器配置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个具有严格安全性的生产站点的标准配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">SECURITY_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;block&quot;</span>
<span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;example.com&quot;</span>
<span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;notice&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个带有额外日志记录的开发环境的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">SECURITY_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;detect&quot;</span>
<span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;dev.example.com&quot;</span>
<span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;debug&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>用于托管多个网站的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>

<span class="c1"># 第一个站点</span>
<span class="nt">site1.example.com_SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;site1.example.com&quot;</span>
<span class="nt">site1.example.com_SECURITY_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;block&quot;</span>

<span class="c1"># 第二个站点</span>
<span class="nt">site2.example.com_SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;site2.example.com&quot;</span>
<span class="nt">site2.example.com_SECURITY_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;detect&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>用于 TCP/UDP 服务器的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">SERVER_TYPE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;stream&quot;</span>
<span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;stream.example.com&quot;</span>
<span class="nt">LISTEN_STREAM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">LISTEN_STREAM_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1337&quot;</span>
<span class="nt">USE_TCP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">USE_UDP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-anti-ddos-pro">Anti DDoS <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style='transform : translateY(3px);'> (PRO)</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>Provides enhanced protection against DDoS attacks by analyzing and filtering suspicious traffic.</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>上下文</th>
<th>可重复</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_ANTIDDOS</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td>Enable or disable anti DDoS protection to mitigate high traffic spikes.</td>
</tr>
<tr>
<td><code>ANTIDDOS_METRICS_DICT_SIZE</code></td>
<td><code>10M</code></td>
<td>global</td>
<td>否</td>
<td>Size of in-memory storage for DDoS metrics (e.g., 10M, 500k).</td>
</tr>
<tr>
<td><code>ANTIDDOS_THRESHOLD</code></td>
<td><code>100</code></td>
<td>global</td>
<td>否</td>
<td>Maximum suspicious requests allowed from a single IP before blocking.</td>
</tr>
<tr>
<td><code>ANTIDDOS_WINDOW_TIME</code></td>
<td><code>10</code></td>
<td>global</td>
<td>否</td>
<td>Time window (seconds) to detect abnormal request patterns.</td>
</tr>
<tr>
<td><code>ANTIDDOS_STATUS_CODES</code></td>
<td><code>429 403 444</code></td>
<td>global</td>
<td>否</td>
<td>HTTP status codes treated as suspicious for DDoS analysis.</td>
</tr>
<tr>
<td><code>ANTIDDOS_DISTINCT_IP</code></td>
<td><code>5</code></td>
<td>global</td>
<td>否</td>
<td>Minimum distinct IP count before enabling anti DDoS measures.</td>
</tr>
</tbody>
</table>
<h2 id="zh-features-antibot">Antibot</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>攻击者通常使用自动化工具（机器人）来尝试利用您的网站。为了防止这种情况，BunkerWeb 包含一个“Antibot”功能，它会挑战用户以证明他们是人类。如果用户成功完成挑战，他们将被授予访问您网站的权限。此功能默认禁用。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当用户访问您的网站时，BunkerWeb 会检查他们是否已经通过了 antibot 挑战。</li>
<li>如果没有，用户将被重定向到一个挑战页面。</li>
<li>用户必须完成挑战（例如，解决一个 CAPTCHA，运行 JavaScript）。</li>
<li>如果挑战成功，用户将被重定向回他们最初试图访问的页面，并可以正常浏览您的网站。</li>
</ol>
<h3 id="zh-features-_8">如何使用</h3>
<p>请按照以下步骤启用和配置 Antibot 功能：</p>
<ol>
<li><strong>选择一个挑战类型：</strong> 决定使用哪种类型的 antibot 挑战（例如，<a href="#zh-features-__tabbed_3_3">captcha</a>、<a href="#zh-features-__tabbed_3_5">hcaptcha</a>、<a href="#zh-features-__tabbed_3_2">javascript</a>）。</li>
<li><strong>启用该功能：</strong> 在您的 BunkerWeb 配置中将 <code>USE_ANTIBOT</code> 设置为您选择的挑战类型。</li>
<li><strong>配置设置：</strong> 根据需要调整其他 <code>ANTIBOT_*</code> 设置。对于 reCAPTCHA、hCaptcha、Turnstile 和 mCaptcha，您必须在相应的服务上创建一个帐户并获取 API 密钥。</li>
<li><strong>重要提示：</strong> 确保 <code>ANTIBOT_URI</code> 是您网站上一个未被使用的唯一 URL。</li>
</ol>
<div class="admonition important">
<p class="admonition-title">关于 <code>ANTIBOT_URI</code> 设置</p>
<p>确保 <code>ANTIBOT_URI</code> 是您网站上一个未被使用的唯一 URL。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">集群环境中的会话配置</p>
<p>antibot 功能使用 cookie 来跟踪用户是否已完成挑战。如果您在集群环境中运行 BunkerWeb（多个 BunkerWeb 实例），您<strong>必须</strong>正确配置会话管理。这涉及在所有 BunkerWeb 实例中将 <code>SESSIONS_SECRET</code> 和 <code>SESSIONS_NAME</code> 设置设置为<strong>相同的值</strong>。如果您不这样做，用户可能会被反复提示完成 antibot 挑战。您可以在<a href="#zh-features-sessions">此处</a>找到有关会话配置的更多信息。</p>
</div>
<h3 id="zh-features-_9">通用设置</h3>
<p>以下设置在所有挑战机制中共享：</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ANTIBOT_URI</code></td>
<td><code>/challenge</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>挑战 URL：</strong> 用户将被重定向到以完成挑战的 URL。确保此 URL 未用于您网站上的任何其他内容。</td>
</tr>
<tr>
<td><code>ANTIBOT_TIME_RESOLVE</code></td>
<td><code>60</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>挑战时间限制：</strong> 用户完成挑战的最长时间（以秒为单位）。此时间过后，将生成新的挑战。</td>
</tr>
<tr>
<td><code>ANTIBOT_TIME_VALID</code></td>
<td><code>86400</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>挑战有效期：</strong> 已完成的挑战的有效时间（以秒为单位）。此时间过后，用户将必须解决新的挑战。</td>
</tr>
</tbody>
</table>
<h3 id="zh-features-_10">从挑战中排除流量</h3>
<p>BunkerWeb 允许您指定某些用户、IP 或请求应完全绕过 antibot 挑战。这对于将受信任的服务、内部网络或应始终无需挑战即可访问的特定页面列入白名单非常有用：</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ANTIBOT_IGNORE_URI</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>排除的 URL：</strong> 应绕过挑战的以空格分隔的 URI 正则表达式模式列表。</td>
</tr>
<tr>
<td><code>ANTIBOT_IGNORE_IP</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>排除的 IP：</strong> 应绕过挑战的以空格分隔的 IP 地址或 CIDR 范围列表。</td>
</tr>
<tr>
<td><code>ANTIBOT_IGNORE_RDNS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>排除的反向 DNS：</strong> 应绕过挑战的以空格分隔的反向 DNS 后缀列表。</td>
</tr>
<tr>
<td><code>ANTIBOT_RDNS_GLOBAL</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>仅限全局 IP：</strong> 如果设置为 <code>yes</code>，则仅对公共 IP 地址执行反向 DNS 检查。</td>
</tr>
<tr>
<td><code>ANTIBOT_IGNORE_ASN</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>排除的 ASN：</strong> 应绕过挑战的以空格分隔的 ASN 编号列表。</td>
</tr>
<tr>
<td><code>ANTIBOT_IGNORE_USER_AGENT</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>排除的用户代理：</strong> 应绕过挑战的以空格分隔的用户代理正则表达式模式列表。</td>
</tr>
</tbody>
</table>
<p><strong>示例：</strong></p>
<ul>
<li>
<p><code>ANTIBOT_IGNORE_URI: "^/api/ ^/webhook/ ^/assets/"</code>
  这将从 antibot 挑战中排除所有以 <code>/api/</code>、<code>/webhook/</code> 或 <code>/assets/</code> 开头的 URI。</p>
</li>
<li>
<p><code>ANTIBOT_IGNORE_IP: "192.168.1.0/24 10.0.0.1"</code>
  这将从 antibot 挑战中排除内部网络 <code>192.168.1.0/24</code> 和特定 IP <code>10.0.0.1</code>。</p>
</li>
<li>
<p><code>ANTIBOT_IGNORE_RDNS: ".googlebot.com .bingbot.com"</code>
  这将从 antibot 挑战中排除来自反向 DNS 以 <code>googlebot.com</code> 或 <code>bingbot.com</code> 结尾的主机的请求。</p>
</li>
<li>
<p><code>ANTIBOT_IGNORE_ASN: "15169 8075"</code>
  这将从 antibot 挑战中排除来自 ASN 15169 (Google) 和 ASN 8075 (Microsoft) 的请求。</p>
</li>
<li>
<p><code>ANTIBOT_IGNORE_USER_AGENT: "^Mozilla.+Chrome.+Safari"</code>
  这将从 antibot 挑战中排除用户代理与指定正则表达式模式匹配的请求。</p>
</li>
</ul>
<h3 id="zh-features-_11">支持的挑战机制</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="3:7"><input checked="checked" id="zh-features-__tabbed_3_1" name="zh-features-__tabbed_3" type="radio" /><input id="zh-features-__tabbed_3_2" name="zh-features-__tabbed_3" type="radio" /><input id="zh-features-__tabbed_3_3" name="zh-features-__tabbed_3" type="radio" /><input id="zh-features-__tabbed_3_4" name="zh-features-__tabbed_3" type="radio" /><input id="zh-features-__tabbed_3_5" name="zh-features-__tabbed_3" type="radio" /><input id="zh-features-__tabbed_3_6" name="zh-features-__tabbed_3" type="radio" /><input id="zh-features-__tabbed_3_7" name="zh-features-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_3_1">Cookie</label><label for="zh-features-__tabbed_3_2">JavaScript</label><label for="zh-features-__tabbed_3_3">Captcha</label><label for="zh-features-__tabbed_3_4">reCAPTCHA</label><label for="zh-features-__tabbed_3_5">hCaptcha</label><label for="zh-features-__tabbed_3_6">Turnstile</label><label for="zh-features-__tabbed_3_7">mCaptcha</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Cookie 挑战是一种轻量级的机制，它依赖于在用户的浏览器中设置一个 cookie。当用户访问网站时，服务器会向客户端发送一个 cookie。在后续的请求中，服务器会检查这个 cookie 是否存在，以验证用户是否是合法的。这种方法对于基本的机器人防护简单有效，无需额外的用户交互。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>服务器生成一个唯一的 cookie 并将其发送给客户端。</li>
<li>客户端必须在后续的请求中返回该 cookie。</li>
<li>如果 cookie 缺失或无效，用户将被重定向到挑战页面。</li>
</ol>
<p><strong>配置设置：</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_ANTIBOT</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>启用 Antibot：</strong> 设置为 <code>cookie</code> 以启用 Cookie 挑战。</td>
</tr>
</tbody>
</table>
<p>有关其他配置选项，请参阅<a href="#zh-features-common-settings">通用设置</a>。</p>
</div>
<div class="tabbed-block">
<p>JavaScript 挑战要求客户端使用 JavaScript 解决一个计算任务。这种机制确保客户端启用了 JavaScript 并且可以执行所需的代码，这通常超出了大多数机器人的能力。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>服务器向客户端发送一个 JavaScript 脚本。</li>
<li>该脚本执行一个计算任务（例如，哈希）并将结果提交回服务器。</li>
<li>服务器验证结果以确认客户端的合法性。</li>
</ol>
<p><strong>主要特点：</strong></p>
<ul>
<li>该挑战为每个客户端动态生成一个独特的任务。</li>
<li>计算任务涉及具有特定条件的哈希（例如，找到具有某个前缀的哈希）。</li>
</ul>
<p><strong>配置设置：</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_ANTIBOT</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>启用 Antibot：</strong> 设置为 <code>javascript</code> 以启用 JavaScript 挑战。</td>
</tr>
</tbody>
</table>
<p>有关其他配置选项，请参阅<a href="#zh-features-common-settings">通用设置</a>。</p>
</div>
<div class="tabbed-block">
<p>Captcha 挑战是一种自制的机制，它可以在您的 BunkerWeb 环境中完全托管生成基于图像的挑战。它测试用户识别和解释随机字符的能力，确保在不依赖外部服务的情况下有效阻止自动化机器人。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>服务器生成一个包含随机字符的 CAPTCHA 图像。</li>
<li>用户必须将图像中显示的字符输入文本字段。</li>
<li>服务器根据生成的 CAPTCHA 验证用户的输入。</li>
</ol>
<p><strong>主要特点：</strong></p>
<ul>
<li>完全自托管，无需第三方 API。</li>
<li>动态生成的挑战确保每个用户会话的唯一性。</li>
<li>使用可自定义的字符集生成 CAPTCHA。</li>
</ul>
<p><strong>支持的字符：</strong></p>
<p>CAPTCHA 系统支持以下字符类型：</p>
<ul>
<li><strong>字母：</strong> 所有小写 (a-z) 和大写 (A-Z) 字母</li>
<li><strong>数字：</strong> 2, 3, 4, 5, 6, 7, 8, 9（不包括 0 和 1 以避免混淆）</li>
<li><strong>特殊字符：</strong> <code>+-/=%"'&amp;_(),.;:?!§`^ÄÖÜßäöüé''‚""„</code></li>
</ul>
<p>要获取支持的完整字符集，请参阅用于 CAPTCHA 的字体的<a href="https://www.dafont.com/moms-typewriter.charmap?back=theme">字体字符映射</a>。</p>
<p><strong>配置设置：</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_ANTIBOT</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>启用 Antibot：</strong> 设置为 <code>captcha</code> 以启用 Captcha 挑战。</td>
</tr>
<tr>
<td><code>ANTIBOT_CAPTCHA_ALPHABET</code></td>
<td><code>abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>Captcha 字母表：</strong> 用于生成 CAPTCHA 的字符字符串。支持的字符：所有字母 (a-z, A-Z)、数字 2-9（不包括 0 和 1）以及特殊字符：<code>+-/=%"'&amp;_(),.;:?!§`^ÄÖÜßäöüé''‚""„</code></td>
</tr>
</tbody>
</table>
<p>有关其他配置选项，请参阅<a href="#zh-features-common-settings">通用设置</a>。</p>
</div>
<div class="tabbed-block">
<p>启用后，reCAPTCHA 会在后台运行 (v3)，根据用户行为分配一个分数。低于配置阈值的分数将提示进一步验证或阻止请求。对于可见的挑战 (v2)，用户必须与 reCAPTCHA 小部件交互才能继续。</p>
<p>现在有两种集成 reCAPTCHA 的方法：
- 经典版本（站点/密钥，v2/v3 验证端点）
- 使用 Google Cloud 的新版本（项目 ID + API 密钥）。经典版本仍然可用，可以通过 <code>ANTIBOT_RECAPTCHA_CLASSIC</code> 进行切换。</p>
<p>对于经典版本，请从 <a href="https://www.google.com/recaptcha/admin">Google reCAPTCHA 管理控制台</a>获取您的站点和密钥。
对于新版本，请在您的 Google Cloud 项目中创建一个 reCAPTCHA 密钥，并使用项目 ID 和一个 API 密钥（请参阅 <a href="https://console.cloud.google.com/security/recaptcha">Google Cloud reCAPTCHA 控制台</a>）。仍然需要一个站点密钥。</p>
<p><strong>配置设置：</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_ANTIBOT</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>no</td>
<td>启用 antibot；设置为 <code>recaptcha</code> 以启用 reCAPTCHA。</td>
</tr>
<tr>
<td><code>ANTIBOT_RECAPTCHA_CLASSIC</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>no</td>
<td>使用经典 reCAPTCHA。设置为 <code>no</code> 以使用新的基于 Google Cloud 的版本。</td>
</tr>
<tr>
<td><code>ANTIBOT_RECAPTCHA_SITEKEY</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td>reCAPTCHA 站点密钥。经典版和新版都需要。</td>
</tr>
<tr>
<td><code>ANTIBOT_RECAPTCHA_SECRET</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td>reCAPTCHA 密钥。仅经典版需要。</td>
</tr>
<tr>
<td><code>ANTIBOT_RECAPTCHA_PROJECT_ID</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td>Google Cloud 项目 ID。仅新版需要。</td>
</tr>
<tr>
<td><code>ANTIBOT_RECAPTCHA_API_KEY</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td>用于调用 reCAPTCHA Enterprise API 的 Google Cloud API 密钥。仅新版需要。</td>
</tr>
<tr>
<td><code>ANTIBOT_RECAPTCHA_JA3</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td>可选的 JA3 TLS 指纹，包含在企业评估中。</td>
</tr>
<tr>
<td><code>ANTIBOT_RECAPTCHA_JA4</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td>可选的 JA4 TLS 指纹，包含在企业评估中。</td>
</tr>
<tr>
<td><code>ANTIBOT_RECAPTCHA_SCORE</code></td>
<td><code>0.7</code></td>
<td>multisite</td>
<td>no</td>
<td>通过所需的最低分数（适用于经典 v3 和新版本）。</td>
</tr>
</tbody>
</table>
<p>有关其他配置选项，请参阅<a href="#zh-features-common-settings">通用设置</a>。</p>
</div>
<div class="tabbed-block">
<p>启用后，hCaptcha 提供了一个有效的 reCAPTCHA 替代方案，它通过验证用户交互而无需依赖评分机制。它用一个简单的交互式测试来挑战用户，以确认他们的合法性。</p>
<p>要将 hCaptcha 与 BunkerWeb 集成，您必须从 hCaptcha 仪表板 <a href="https://www.hcaptcha.com">hCaptcha</a> 获取必要的凭据。这些凭据包括一个站点密钥和一个密钥。</p>
<p><strong>配置设置：</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_ANTIBOT</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>启用 Antibot：</strong> 设置为 <code>hcaptcha</code> 以启用 hCaptcha 挑战。</td>
</tr>
<tr>
<td><code>ANTIBOT_HCAPTCHA_SITEKEY</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td><strong>hCaptcha 站点密钥：</strong> 您的 hCaptcha 站点密钥（从 hCaptcha 获取）。</td>
</tr>
<tr>
<td><code>ANTIBOT_HCAPTCHA_SECRET</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td><strong>hCaptcha 密钥：</strong> 您的 hCaptcha 密钥（从 hCaptcha 获取）。</td>
</tr>
</tbody>
</table>
<p>有关其他配置选项，请参阅<a href="#zh-features-common-settings">通用设置</a>。</p>
</div>
<div class="tabbed-block">
<p>Turnstile 是一种现代、注重隐私的挑战机制，它利用 Cloudflare 的技术来检测和阻止自动化流量。它以一种无缝、后台的方式验证用户交互，为合法用户减少了摩擦，同时有效地阻止了机器人。</p>
<p>要将 Turnstile 与 BunkerWeb 集成，请确保您从 <a href="https://www.cloudflare.com/turnstile">Cloudflare Turnstile</a> 获取了必要的凭据。</p>
<p><strong>配置设置：</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_ANTIBOT</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>启用 Antibot：</strong> 设置为 <code>turnstile</code> 以启用 Turnstile 挑战。</td>
</tr>
<tr>
<td><code>ANTIBOT_TURNSTILE_SITEKEY</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td><strong>Turnstile 站点密钥：</strong> 您的 Turnstile 站点密钥（从 Cloudflare 获取）。</td>
</tr>
<tr>
<td><code>ANTIBOT_TURNSTILE_SECRET</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td><strong>Turnstile 密钥：</strong> 您的 Turnstile 密钥（从 Cloudflare 获取）。</td>
</tr>
</tbody>
</table>
<p>有关其他配置选项，请参阅<a href="#zh-features-common-settings">通用设置</a>。</p>
</div>
<div class="tabbed-block">
<p>mCaptcha 是一种替代的 CAPTCHA 挑战机制，它通过呈现一个与其他 antibot 解决方案类似的交互式测试来验证用户的合法性。启用后，它会用 mCaptcha 提供的 CAPTCHA 来挑战用户，确保只有真正的用户才能绕过自动安全检查。</p>
<p>mCaptcha 的设计考虑了隐私。它完全符合 GDPR，确保挑战过程中涉及的所有用户数据都遵守严格的数据保护标准。此外，mCaptcha 提供了自托管的灵活性，允许组织完全控制其数据和基础设施。这种自托管能力不仅增强了隐私，还优化了性能和定制，以适应特定的部署需求。</p>
<p>要将 mCaptcha 与 BunkerWeb 集成，您必须从 <a href="https://mcaptcha.org/">mCaptcha</a> 平台或您自己的提供商那里获取必要的凭据。这些凭据包括用于验证的站点密钥和密钥。</p>
<p><strong>配置设置：</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_ANTIBOT</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>启用 Antibot：</strong> 设置为 <code>mcaptcha</code> 以启用 mCaptcha 挑战。</td>
</tr>
<tr>
<td><code>ANTIBOT_MCAPTCHA_SITEKEY</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td><strong>mCaptcha 站点密钥：</strong> 您的 mCaptcha 站点密钥（从 mCaptcha 获取）。</td>
</tr>
<tr>
<td><code>ANTIBOT_MCAPTCHA_SECRET</code></td>
<td></td>
<td>multisite</td>
<td>no</td>
<td><strong>mCaptcha 密钥：</strong> 您的 mCaptcha 密钥（从 mCaptcha 获取）。</td>
</tr>
<tr>
<td><code>ANTIBOT_MCAPTCHA_URL</code></td>
<td><code>https://demo.mcaptcha.org</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>mCaptcha 域：</strong> 用于 mCaptcha 挑战的域。</td>
</tr>
</tbody>
</table>
<p>有关其他配置选项，请参阅<a href="#zh-features-common-settings">通用设置</a>。</p>
</div>
</div>
</div>
<h3 id="zh-features-_12">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="4:8"><input checked="checked" id="zh-features-__tabbed_4_1" name="zh-features-__tabbed_4" type="radio" /><input id="zh-features-__tabbed_4_2" name="zh-features-__tabbed_4" type="radio" /><input id="zh-features-__tabbed_4_3" name="zh-features-__tabbed_4" type="radio" /><input id="zh-features-__tabbed_4_4" name="zh-features-__tabbed_4" type="radio" /><input id="zh-features-__tabbed_4_5" name="zh-features-__tabbed_4" type="radio" /><input id="zh-features-__tabbed_4_6" name="zh-features-__tabbed_4" type="radio" /><input id="zh-features-__tabbed_4_7" name="zh-features-__tabbed_4" type="radio" /><input id="zh-features-__tabbed_4_8" name="zh-features-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_4_1">Cookie 挑战</label><label for="zh-features-__tabbed_4_2">JavaScript 挑战</label><label for="zh-features-__tabbed_4_3">Captcha 挑战</label><label for="zh-features-__tabbed_4_4">reCAPTCHA 经典版</label><label for="zh-features-__tabbed_4_5">reCAPTCHA (新)</label><label for="zh-features-__tabbed_4_6">hCaptcha 挑战</label><label for="zh-features-__tabbed_4_7">Turnstile 挑战</label><label for="zh-features-__tabbed_4_8">mCaptcha 挑战</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>启用 Cookie 挑战的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_ANTIBOT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cookie&quot;</span>
<span class="nt">ANTIBOT_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/challenge&quot;</span>
<span class="nt">ANTIBOT_TIME_RESOLVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">ANTIBOT_TIME_VALID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>启用 JavaScript 挑战的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_ANTIBOT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;javascript&quot;</span>
<span class="nt">ANTIBOT_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/challenge&quot;</span>
<span class="nt">ANTIBOT_TIME_RESOLVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">ANTIBOT_TIME_VALID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>启用 Captcha 挑战的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_ANTIBOT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;captcha&quot;</span>
<span class="nt">ANTIBOT_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/challenge&quot;</span>
<span class="nt">ANTIBOT_TIME_RESOLVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">ANTIBOT_TIME_VALID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
<span class="nt">ANTIBOT_CAPTCHA_ALPHABET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;23456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>
</code></pre></div>
<p>注意：上面的示例使用了数字 2-9 和所有字母，这是 CAPTCHA 挑战最常用的字符。您可以根据需要自定义字母表以包含特殊字符。</p>
</div>
<div class="tabbed-block">
<p>经典 reCAPTCHA（站点/密钥）的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_ANTIBOT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;recaptcha&quot;</span>
<span class="nt">ANTIBOT_RECAPTCHA_CLASSIC</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">ANTIBOT_RECAPTCHA_SITEKEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-site-key&quot;</span>
<span class="nt">ANTIBOT_RECAPTCHA_SECRET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-secret-key&quot;</span>
<span class="nt">ANTIBOT_RECAPTCHA_SCORE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0.7&quot;</span>
<span class="nt">ANTIBOT_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/challenge&quot;</span>
<span class="nt">ANTIBOT_TIME_RESOLVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">ANTIBOT_TIME_VALID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>新的基于 Google Cloud 的 reCAPTCHA（项目 ID + API 密钥）的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_ANTIBOT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;recaptcha&quot;</span>
<span class="nt">ANTIBOT_RECAPTCHA_CLASSIC</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
<span class="nt">ANTIBOT_RECAPTCHA_SITEKEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-site-key&quot;</span>
<span class="nt">ANTIBOT_RECAPTCHA_PROJECT_ID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-gcp-project-id&quot;</span>
<span class="nt">ANTIBOT_RECAPTCHA_API_KEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-gcp-api-key&quot;</span>
<span class="c1"># 可选的指纹以改善企业评估</span>
<span class="c1"># ANTIBOT_RECAPTCHA_JA3: &quot;&lt;ja3-fingerprint&gt;&quot;</span>
<span class="c1"># ANTIBOT_RECAPTCHA_JA4: &quot;&lt;ja4-fingerprint&gt;&quot;</span>
<span class="nt">ANTIBOT_RECAPTCHA_SCORE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0.7&quot;</span>
<span class="nt">ANTIBOT_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/challenge&quot;</span>
<span class="nt">ANTIBOT_TIME_RESOLVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">ANTIBOT_TIME_VALID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>启用 hCaptcha 挑战的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_ANTIBOT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;hcaptcha&quot;</span>
<span class="nt">ANTIBOT_HCAPTCHA_SITEKEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-site-key&quot;</span>
<span class="nt">ANTIBOT_HCAPTCHA_SECRET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-secret-key&quot;</span>
<span class="nt">ANTIBOT_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/challenge&quot;</span>
<span class="nt">ANTIBOT_TIME_RESOLVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">ANTIBOT_TIME_VALID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>启用 Turnstile 挑战的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_ANTIBOT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;turnstile&quot;</span>
<span class="nt">ANTIBOT_TURNSTILE_SITEKEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-site-key&quot;</span>
<span class="nt">ANTIBOT_TURNSTILE_SECRET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-secret-key&quot;</span>
<span class="nt">ANTIBOT_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/challenge&quot;</span>
<span class="nt">ANTIBOT_TIME_RESOLVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">ANTIBOT_TIME_VALID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>启用 mCaptcha 挑战的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_ANTIBOT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mcaptcha&quot;</span>
<span class="nt">ANTIBOT_MCAPTCHA_SITEKEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-site-key&quot;</span>
<span class="nt">ANTIBOT_MCAPTCHA_SECRET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-secret-key&quot;</span>
<span class="nt">ANTIBOT_MCAPTCHA_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://demo.mcaptcha.org&quot;</span>
<span class="nt">ANTIBOT_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/challenge&quot;</span>
<span class="nt">ANTIBOT_TIME_RESOLVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">ANTIBOT_TIME_VALID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-auth-basic">Auth basic</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>Auth Basic 插件提供 HTTP 基本认证来保护您的网站或特定资源。此功能通过要求用户在访问受保护内容之前输入用户名和密码来增加额外的安全层。这种类型的身份验证实现简单，并得到浏览器的广泛支持。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当用户尝试访问您网站的受保护区域时，服务器会发送一个身份验证质询。</li>
<li>浏览器会显示一个登录对话框，提示用户输入用户名和密码。</li>
<li>用户输入他们的凭据，这些凭据将被发送到服务器。</li>
<li>如果凭据有效，用户将被授予访问所请求内容的权限。</li>
<li>如果凭据无效，将向用户提供一个错误消息，状态码为 401 Unauthorized。</li>
</ol>
<h3 id="zh-features-_13">如何使用</h3>
<p>请按照以下步骤启用和配置 Auth Basic 身份验证：</p>
<ol>
<li><strong>启用该功能：</strong> 在您的 BunkerWeb 配置中将 <code>USE_AUTH_BASIC</code> 设置为 <code>yes</code>。</li>
<li><strong>选择保护范围：</strong> 通过配置 <code>AUTH_BASIC_LOCATION</code> 设置，决定是保护整个网站还是仅保护特定 URL。</li>
<li><strong>定义凭据：</strong> 使用 <code>AUTH_BASIC_USER</code> 和 <code>AUTH_BASIC_PASSWORD</code> 设置至少设置一对用户名和密码。</li>
<li><strong>自定义消息：</strong> 可选地更改 <code>AUTH_BASIC_TEXT</code> 以在登录提示中显示自定义消息。</li>
</ol>
<h3 id="zh-features-_14">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_AUTH_BASIC</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用基本认证：</strong> 设置为 <code>yes</code> 以启用基本身份验证。</td>
</tr>
<tr>
<td><code>AUTH_BASIC_LOCATION</code></td>
<td><code>sitewide</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>保护范围：</strong> 设置为 <code>sitewide</code> 以保护整个站点，或指定一个 URL 路径（例如 <code>/admin</code>）以仅保护特定区域。</td>
</tr>
<tr>
<td><code>AUTH_BASIC_USER</code></td>
<td><code>changeme</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>用户名：</strong> 身份验证所需的用户名。您可以定义多个用户名/密码对。</td>
</tr>
<tr>
<td><code>AUTH_BASIC_PASSWORD</code></td>
<td><code>changeme</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>密码：</strong> 身份验证所需的密码。每个密码对应一个用户名。</td>
</tr>
<tr>
<td><code>AUTH_BASIC_TEXT</code></td>
<td><code>Restricted area</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>提示文本：</strong> 显示给用户的身份验证提示中的消息。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">安全注意事项</p>
<p>HTTP 基本认证以 Base64 编码（非加密）传输凭据。虽然在通过 HTTPS 使用时这是可以接受的，但在普通 HTTP 上不应被认为是安全的。使用基本身份验证时，请务必启用 SSL/TLS。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">使用多个凭据</p>
<p>您可以为访问配置多个用户名/密码对。每个 <code>AUTH_BASIC_USER</code> 设置都应有一个对应的 <code>AUTH_BASIC_PASSWORD</code> 设置。</p>
</div>
<h3 id="zh-features-_15">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="zh-features-__tabbed_5_1" name="zh-features-__tabbed_5" type="radio" /><input id="zh-features-__tabbed_5_2" name="zh-features-__tabbed_5" type="radio" /><input id="zh-features-__tabbed_5_3" name="zh-features-__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_5_1">全站保护</label><label for="zh-features-__tabbed_5_2">保护特定区域</label><label for="zh-features-__tabbed_5_3">多个用户</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>要用一组凭据保护您的整个网站：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_AUTH_BASIC</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">AUTH_BASIC_LOCATION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sitewide&quot;</span>
<span class="nt">AUTH_BASIC_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin&quot;</span>
<span class="nt">AUTH_BASIC_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;secure_password&quot;</span>
<span class="nt">AUTH_BASIC_TEXT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Admin</span><span class="nv"> </span><span class="s">Access</span><span class="nv"> </span><span class="s">Only&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>仅保护特定路径，例如管理面板：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_AUTH_BASIC</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">AUTH_BASIC_LOCATION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/admin/&quot;</span>
<span class="nt">AUTH_BASIC_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin&quot;</span>
<span class="nt">AUTH_BASIC_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;secure_password&quot;</span>
<span class="nt">AUTH_BASIC_TEXT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Admin</span><span class="nv"> </span><span class="s">Access</span><span class="nv"> </span><span class="s">Only&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>为多个用户设置不同的凭据：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_AUTH_BASIC</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">AUTH_BASIC_LOCATION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sitewide&quot;</span>
<span class="nt">AUTH_BASIC_TEXT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Staff</span><span class="nv"> </span><span class="s">Area&quot;</span>

<span class="c1"># 第一个用户</span>
<span class="nt">AUTH_BASIC_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin&quot;</span>
<span class="nt">AUTH_BASIC_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin_password&quot;</span>

<span class="c1"># 第二个用户</span>
<span class="nt">AUTH_BASIC_USER_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;editor&quot;</span>
<span class="nt">AUTH_BASIC_PASSWORD_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;editor_password&quot;</span>

<span class="c1"># 第三个用户</span>
<span class="nt">AUTH_BASIC_USER_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;viewer&quot;</span>
<span class="nt">AUTH_BASIC_PASSWORD_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;viewer_password&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-backup">Backup</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>备份插件提供了一个自动备份解决方案来保护您的 BunkerWeb 数据。此功能通过根据您首选的时间表创建定期备份，确保您重要数据库的安全性和可用性。备份存储在指定位置，并且可以通过自动化流程和手动命令轻松管理。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>您的数据库会根据您设置的时间表（每日、每周或每月）自动备份。</li>
<li>备份存储在您系统上的指定目录中。</li>
<li>旧的备份会根据您的保留设置自动轮换。</li>
<li>您可以随时手动创建备份、列出现有备份或从备份中恢复。</li>
<li>在任何恢复操作之前，当前状态都会自动备份作为安全措施。</li>
</ol>
<h3 id="zh-features-_16">如何使用</h3>
<p>请按照以下步骤配置和使用备份功能：</p>
<ol>
<li><strong>启用该功能：</strong> 备份功能默认启用。如果需要，您可以使用 <code>USE_BACKUP</code> 设置来控制此功能。</li>
<li><strong>配置备份计划：</strong> 通过设置 <code>BACKUP_SCHEDULE</code> 参数选择备份的频率。</li>
<li><strong>设置保留策略：</strong> 使用 <code>BACKUP_ROTATION</code> 设置指定要保留的备份数量。</li>
<li><strong>定义存储位置：</strong> 使用 <code>BACKUP_DIRECTORY</code> 设置选择备份的存储位置。</li>
<li><strong>使用 CLI 命令：</strong> 需要时，使用 <code>bwcli plugin backup</code> 命令手动管理备份。</li>
</ol>
<h3 id="zh-features-_17">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_BACKUP</code></td>
<td><code>yes</code></td>
<td>全局</td>
<td>否</td>
<td><strong>启用备份：</strong> 设置为 <code>yes</code> 以启用自动备份。</td>
</tr>
<tr>
<td><code>BACKUP_SCHEDULE</code></td>
<td><code>daily</code></td>
<td>全局</td>
<td>否</td>
<td><strong>备份频率：</strong> 执行备份的频率。选项：<code>daily</code>、<code>weekly</code> 或 <code>monthly</code>。</td>
</tr>
<tr>
<td><code>BACKUP_ROTATION</code></td>
<td><code>7</code></td>
<td>全局</td>
<td>否</td>
<td><strong>备份保留：</strong> 要保留的备份文件数量。超过此数量的旧备份将被自动删除。</td>
</tr>
<tr>
<td><code>BACKUP_DIRECTORY</code></td>
<td><code>/var/lib/bunkerweb/backups</code></td>
<td>全局</td>
<td>否</td>
<td><strong>备份位置：</strong> 备份文件将存储的目录。</td>
</tr>
</tbody>
</table>
<h3 id="zh-features-_18">命令行界面</h3>
<p>备份插件提供了几个 CLI 命令来管理您的备份：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 列出所有可用的备份</span>
bwcli<span class="w"> </span>plugin<span class="w"> </span>backup<span class="w"> </span>list

<span class="c1"># 创建一个手动备份</span>
bwcli<span class="w"> </span>plugin<span class="w"> </span>backup<span class="w"> </span>save

<span class="c1"># 在自定义位置创建一个备份</span>
bwcli<span class="w"> </span>plugin<span class="w"> </span>backup<span class="w"> </span>save<span class="w"> </span>--directory<span class="w"> </span>/path/to/custom/location

<span class="c1"># 从最近的备份恢复</span>
bwcli<span class="w"> </span>plugin<span class="w"> </span>backup<span class="w"> </span>restore

<span class="c1"># 从特定的备份文件恢复</span>
bwcli<span class="w"> </span>plugin<span class="w"> </span>backup<span class="w"> </span>restore<span class="w"> </span>/path/to/backup/backup-sqlite-2023-08-15_12-34-56.zip
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">安全第一</p>
<p>在任何恢复操作之前，备份插件会自动在临时位置创建您当前数据库状态的备份。如果您需要还原恢复操作，这提供了一个额外的保障。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">数据库兼容性</p>
<p>备份插件支持 SQLite、MySQL/MariaDB 和 PostgreSQL 数据库。目前不支持 Oracle 数据库的备份和恢复操作。</p>
</div>
<h3 id="zh-features-_19">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="6:3"><input checked="checked" id="zh-features-__tabbed_6_1" name="zh-features-__tabbed_6" type="radio" /><input id="zh-features-__tabbed_6_2" name="zh-features-__tabbed_6" type="radio" /><input id="zh-features-__tabbed_6_3" name="zh-features-__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_6_1">每日备份，保留 7 天</label><label for="zh-features-__tabbed_6_2">每周备份，延长保留期</label><label for="zh-features-__tabbed_6_3">每月备份到自定义位置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>默认配置，创建每日备份并保留最近的 7 个文件：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BACKUP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BACKUP_SCHEDULE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;daily&quot;</span>
<span class="nt">BACKUP_ROTATION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;7&quot;</span>
<span class="nt">BACKUP_DIRECTORY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/lib/bunkerweb/backups&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>用于频率较低但保留时间较长的备份的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BACKUP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BACKUP_SCHEDULE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;weekly&quot;</span>
<span class="nt">BACKUP_ROTATION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;12&quot;</span>
<span class="nt">BACKUP_DIRECTORY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/lib/bunkerweb/backups&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>用于每月备份并存储在自定义位置的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BACKUP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BACKUP_SCHEDULE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;monthly&quot;</span>
<span class="nt">BACKUP_ROTATION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;24&quot;</span>
<span class="nt">BACKUP_DIRECTORY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/mnt/backup-drive/bunkerweb-backups&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-backup-s3-pro">Backup S3 <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style='transform : translateY(3px);'> (PRO)</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>Automatically backup your data to an S3 bucket</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>上下文</th>
<th>可重复</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_BACKUP_S3</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td>Enable or disable the S3 backup feature</td>
</tr>
<tr>
<td><code>BACKUP_S3_SCHEDULE</code></td>
<td><code>daily</code></td>
<td>global</td>
<td>否</td>
<td>The frequency of the backup</td>
</tr>
<tr>
<td><code>BACKUP_S3_ROTATION</code></td>
<td><code>7</code></td>
<td>global</td>
<td>否</td>
<td>The number of backups to keep</td>
</tr>
<tr>
<td><code>BACKUP_S3_ENDPOINT</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>The S3 endpoint</td>
</tr>
<tr>
<td><code>BACKUP_S3_BUCKET</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>The S3 bucket</td>
</tr>
<tr>
<td><code>BACKUP_S3_DIR</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>The S3 directory</td>
</tr>
<tr>
<td><code>BACKUP_S3_REGION</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>The S3 region</td>
</tr>
<tr>
<td><code>BACKUP_S3_ACCESS_KEY_ID</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>The S3 access key ID</td>
</tr>
<tr>
<td><code>BACKUP_S3_ACCESS_KEY_SECRET</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>The S3 access key secret</td>
</tr>
<tr>
<td><code>BACKUP_S3_COMP_LEVEL</code></td>
<td><code>6</code></td>
<td>global</td>
<td>否</td>
<td>The compression level of the backup zip file</td>
</tr>
</tbody>
</table>
<h2 id="zh-features-bad-behavior">Bad behavior</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>不良行为插件通过自动检测并封禁在指定时间段内产生过多错误或“不良”HTTP 状态码的 IP 地址来保护您的网站。这有助于防御暴力破解攻击、网络爬虫、漏洞扫描器以及其他可能产生大量错误响应的恶意活动。</p>
<p>攻击者在探测或利用漏洞时，通常会产生“可疑”的 HTTP 状态码——这些代码是普通用户在给定时间范围内不太可能触发的。通过检测这种行为，BunkerWeb 可以自动封禁违规的 IP 地址，迫使攻击者使用新的 IP 地址才能继续尝试。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>该插件会监控您网站的 HTTP 响应。</li>
<li>当访问者收到一个“不良”的 HTTP 状态码（例如 400、401、403、404 等）时，该 IP 地址的计数器会增加。</li>
<li>如果一个 IP 地址在指定的时间段内超过了配置的不良状态码阈值，该 IP 将被自动封禁。</li>
<li>根据您的配置，被封禁的 IP 可以在服务级别（仅针对特定站点）或全局级别（跨所有站点）被阻止。</li>
<li>封禁会在配置的封禁持续时间后自动过期，或者如果配置为 <code>0</code> 则永久有效。</li>
</ol>
<div class="admonition success">
<p class="admonition-title">主要优点</p>
<ol>
<li><strong>自动保护：</strong> 自动检测并阻止潜在的恶意客户端，无需人工干预。</li>
<li><strong>可定制的规则：</strong> 根据您的具体需求，微调构成“不良行为”的定义。</li>
<li><strong>资源节约：</strong> 防止恶意行为者通过重复的无效请求消耗服务器资源。</li>
<li><strong>灵活的范围：</strong> 选择封禁是仅适用于当前服务还是全局适用于所有服务。</li>
<li><strong>封禁持续时间控制：</strong> 设置临时封禁，在配置的持续时间后自动过期，或设置永久封禁，直到手动移除。</li>
</ol>
</div>
<h3 id="zh-features-_20">如何使用</h3>
<p>请按照以下步骤配置和使用“不良行为”功能：</p>
<ol>
<li><strong>启用该功能：</strong> “不良行为”功能默认启用。如果需要，您可以使用 <code>USE_BAD_BEHAVIOR</code> 设置来控制此功能。</li>
<li><strong>配置状态码：</strong> 使用 <code>BAD_BEHAVIOR_STATUS_CODES</code> 设置定义哪些 HTTP 状态码应被视为“不良”。</li>
<li><strong>设置阈值：</strong> 使用 <code>BAD_BEHAVIOR_THRESHOLD</code> 设置确定多少次“不良”响应会触发封禁。</li>
<li><strong>配置时间段：</strong> 使用 <code>BAD_BEHAVIOR_COUNT_TIME</code> 和 <code>BAD_BEHAVIOR_BAN_TIME</code> 设置指定计算不良响应的持续时间和封禁持续时间。</li>
<li><strong>选择封禁范围：</strong> 使用 <code>BAD_BEHAVIOR_BAN_SCOPE</code> 设置决定封禁是仅适用于当前服务还是全局适用于所有服务。</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">流模式</p>
<p>在<strong>流模式</strong>下，只有 <code>444</code> 状态码被视为“不良”并会触发此行为。</p>
</div>
<h3 id="zh-features-_21">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_BAD_BEHAVIOR</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用不良行为检测：</strong> 设置为 <code>yes</code> 以启用不良行为检测和封禁功能。</td>
</tr>
<tr>
<td><code>BAD_BEHAVIOR_STATUS_CODES</code></td>
<td><code>400 401 403 404 405 429 444</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>不良状态码：</strong> 当返回给客户端时，将被计为“不良”行为的 HTTP 状态码列表。</td>
</tr>
<tr>
<td><code>BAD_BEHAVIOR_THRESHOLD</code></td>
<td><code>10</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>阈值：</strong> 一个 IP 在计数周期内可以生成的“不良”状态码的数量，超过该数量将被封禁。</td>
</tr>
<tr>
<td><code>BAD_BEHAVIOR_COUNT_TIME</code></td>
<td><code>60</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>计数周期：</strong> 计算不良状态码以达到阈值的时间窗口（以秒为单位）。</td>
</tr>
<tr>
<td><code>BAD_BEHAVIOR_BAN_TIME</code></td>
<td><code>86400</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>封禁持续时间：</strong> 一个 IP 超过阈值后将被封禁的时间（以秒为单位）。默认为 24 小时（86400 秒）。设置为 <code>0</code> 表示永不解封的永久封禁。</td>
</tr>
<tr>
<td><code>BAD_BEHAVIOR_BAN_SCOPE</code></td>
<td><code>service</code></td>
<td>global</td>
<td>否</td>
<td><strong>封禁范围：</strong> 决定封禁是仅适用于当前服务 (<code>service</code>) 还是所有服务 (<code>global</code>)。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">误报</p>
<p>在设置阈值和计数时间时要小心。将这些值设置得太低可能会无意中封禁在浏览您网站时遇到错误的合法用户。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">调整您的配置</p>
<p>从保守的设置开始（更高的阈值，更短的封禁时间），并根据您的具体需求和流量模式进行调整。监控您的日志以确保合法用户不会被错误地封禁。</p>
</div>
<h3 id="zh-features-_22">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="7:4"><input checked="checked" id="zh-features-__tabbed_7_1" name="zh-features-__tabbed_7" type="radio" /><input id="zh-features-__tabbed_7_2" name="zh-features-__tabbed_7" type="radio" /><input id="zh-features-__tabbed_7_3" name="zh-features-__tabbed_7" type="radio" /><input id="zh-features-__tabbed_7_4" name="zh-features-__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_7_1">默认配置</label><label for="zh-features-__tabbed_7_2">严格配置</label><label for="zh-features-__tabbed_7_3">宽松配置</label><label for="zh-features-__tabbed_7_4">永久封禁配置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>默认配置提供了一种适用于大多数网站的平衡方法：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BAD_BEHAVIOR</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BAD_BEHAVIOR_STATUS_CODES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;400</span><span class="nv"> </span><span class="s">401</span><span class="nv"> </span><span class="s">403</span><span class="nv"> </span><span class="s">404</span><span class="nv"> </span><span class="s">405</span><span class="nv"> </span><span class="s">429</span><span class="nv"> </span><span class="s">444&quot;</span>
<span class="nt">BAD_BEHAVIOR_THRESHOLD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span>
<span class="nt">BAD_BEHAVIOR_COUNT_TIME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">BAD_BEHAVIOR_BAN_TIME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
<span class="nt">BAD_BEHAVIOR_BAN_SCOPE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;service&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>对于高安全性应用程序，您希望更积极地封禁潜在威胁：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BAD_BEHAVIOR</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BAD_BEHAVIOR_STATUS_CODES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;400</span><span class="nv"> </span><span class="s">401</span><span class="nv"> </span><span class="s">403</span><span class="nv"> </span><span class="s">404</span><span class="nv"> </span><span class="s">405</span><span class="nv"> </span><span class="s">429</span><span class="nv"> </span><span class="s">444</span><span class="nv"> </span><span class="s">500</span><span class="nv"> </span><span class="s">502</span><span class="nv"> </span><span class="s">503&quot;</span>
<span class="nt">BAD_BEHAVIOR_THRESHOLD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5&quot;</span>
<span class="nt">BAD_BEHAVIOR_COUNT_TIME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;120&quot;</span>
<span class="nt">BAD_BEHAVIOR_BAN_TIME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;604800&quot;</span><span class="w">  </span><span class="c1"># 7 天</span>
<span class="nt">BAD_BEHAVIOR_BAN_SCOPE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;global&quot;</span><span class="w"> </span><span class="c1"># 在所有服务中封禁</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>对于具有高合法流量且您希望避免误报的网站：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BAD_BEHAVIOR</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BAD_BEHAVIOR_STATUS_CODES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;401</span><span class="nv"> </span><span class="s">403</span><span class="nv"> </span><span class="s">429&quot;</span><span class="w">  </span><span class="c1"># 仅计算未经授权、禁止和速率受限的请求</span>
<span class="nt">BAD_BEHAVIOR_THRESHOLD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;20&quot;</span>
<span class="nt">BAD_BEHAVIOR_COUNT_TIME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30&quot;</span>
<span class="nt">BAD_BEHAVIOR_BAN_TIME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3600&quot;</span><span class="w">  </span><span class="c1"># 1 小时</span>
<span class="nt">BAD_BEHAVIOR_BAN_SCOPE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;service&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>对于您希望检测到的攻击者被永久封禁，直到手动解封的情况：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BAD_BEHAVIOR</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BAD_BEHAVIOR_STATUS_CODES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;400</span><span class="nv"> </span><span class="s">401</span><span class="nv"> </span><span class="s">403</span><span class="nv"> </span><span class="s">404</span><span class="nv"> </span><span class="s">405</span><span class="nv"> </span><span class="s">429</span><span class="nv"> </span><span class="s">444&quot;</span>
<span class="nt">BAD_BEHAVIOR_THRESHOLD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span>
<span class="nt">BAD_BEHAVIOR_COUNT_TIME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">BAD_BEHAVIOR_BAN_TIME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="w">  </span><span class="c1"># 永久封禁（永不失效）</span>
<span class="nt">BAD_BEHAVIOR_BAN_SCOPE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;global&quot;</span><span class="w"> </span><span class="c1"># 在所有服务中封禁</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-blacklist">Blacklist</h2>
<p>STREAM 支持 <img alt="⚠" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/26a0.svg" title=":warning:" /></p>
<p>黑名单插件通过根据各种客户端属性阻止访问来为您的网站提供强大的保护。此功能通过根据 IP 地址、网络、反向 DNS 条目、ASN、用户代理和特定的 URI 模式拒绝访问来防御已知的恶意实体、扫描器和可疑访问者。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>该插件会根据多个黑名单标准（IP 地址、网络、rDNS、ASN、用户代理或 URI 模式）检查传入的请求。</li>
<li>黑名单可以直接在您的配置中指定，也可以从外部 URL 加载。</li>
<li>如果访问者匹配任何黑名单规则（并且不匹配任何忽略规则），访问将被拒绝。</li>
<li>黑名单会根据配置的 URL 定期自动更新。</li>
<li>您可以根据您的特定安全需求自定义要检查和忽略的确切标准。</li>
</ol>
<h3 id="zh-features-_23">如何使用</h3>
<p>请按照以下步骤配置和使用黑名单功能：</p>
<ol>
<li><strong>启用该功能：</strong> 黑名单功能默认启用。如果需要，您可以使用 <code>USE_BLACKLIST</code> 设置来控制此功能。</li>
<li><strong>配置阻止规则：</strong> 定义应阻止的 IP、网络、rDNS 模式、ASN、用户代理或 URI。</li>
<li><strong>设置忽略规则：</strong> 指定应绕过黑名单检查的任何例外情况。</li>
<li><strong>添加外部源：</strong> 配置 URL 以自动下载和更新黑名单数据。</li>
<li><strong>监控有效性：</strong> 查看 <a href="#zh-web-ui">web UI</a> 以查看有关被阻止请求的统计信息。</li>
</ol>
<div class="admonition info">
<p class="admonition-title">流模式</p>
<p>当使用流模式时，只会执行 IP、rDNS 和 ASN 检查。</p>
</div>
<h3 id="zh-features-_24">配置设置</h3>
<p><strong>通用</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_BLACKLIST</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用黑名单：</strong> 设置为 <code>yes</code> 以启用黑名单功能。</td>
</tr>
<tr>
<td><code>BLACKLIST_COMMUNITY_LISTS</code></td>
<td><code>ip:danmeuk-tor-exit ua:mitchellkrogza-bad-user-agents</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>社区黑名单：</strong> 选择预配置的社区维护的黑名单以包含在阻止中。</td>
</tr>
</tbody>
</table>
<div class="tabbed-set tabbed-alternate" data-tabs="8:6"><input checked="checked" id="zh-features-__tabbed_8_1" name="zh-features-__tabbed_8" type="radio" /><input id="zh-features-__tabbed_8_2" name="zh-features-__tabbed_8" type="radio" /><input id="zh-features-__tabbed_8_3" name="zh-features-__tabbed_8" type="radio" /><input id="zh-features-__tabbed_8_4" name="zh-features-__tabbed_8" type="radio" /><input id="zh-features-__tabbed_8_5" name="zh-features-__tabbed_8" type="radio" /><input id="zh-features-__tabbed_8_6" name="zh-features-__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_8_1">社区黑名单</label><label for="zh-features-__tabbed_8_2">IP 地址</label><label for="zh-features-__tabbed_8_3">反向 DNS</label><label for="zh-features-__tabbed_8_4">ASN</label><label for="zh-features-__tabbed_8_5">用户代理</label><label for="zh-features-__tabbed_8_6">URI</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><strong>这是做什么的：</strong> 使您能够快速添加维护良好的、来自社区的黑名单，而无需手动配置 URL。</p>
<p><code>BLACKLIST_COMMUNITY_LISTS</code> 设置允许您从精选的黑名单源中进行选择。可用选项包括：</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>描述</th>
<th>来源</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ip:laurent-minne-data-shield-aggressive</code></td>
<td>Data-Shield IPv4 黑名单。DST = 欧洲</td>
<td></td>
</tr>
<tr>
<td><code>https://raw.githubusercontent.com/duggytuxy/Data-Shield_IPv4_Blocklist/refs/heads/main/prod_data-shield_ipv4_blocklist.txt</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>ip:danmeuk-tor-exit</code></td>
<td>Tor 出口节点 IP (dan.me.uk)</td>
<td><code>https://www.dan.me.uk/torlist/?exit</code></td>
</tr>
<tr>
<td><code>ua:mitchellkrogza-bad-user-agents</code></td>
<td>Nginx 阻止不良机器人、垃圾邮件引荐来源、漏洞扫描器、用户代理、恶意软件、广告软件、勒索软件、恶意网站，具有反 DDOS、Wordpress 主题检测器阻止和针对重复违规者的 Fail2Ban Jail</td>
<td><code>https://raw.githubusercontent.com/mitchellkrogza/nginx-ultimate-bad-bot-blocker/master/_generator_lists/bad-user-agents.list</code></td>
</tr>
</tbody>
</table>
<p><strong>配置：</strong> 指定多个列表，以空格分隔。例如：
<div class="highlight"><pre><span></span><code><span class="nt">BLACKLIST_COMMUNITY_LISTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ip:danmeuk-tor-exit</span><span class="nv"> </span><span class="s">ua:mitchellkrogza-bad-user-agents&quot;</span>
</code></pre></div></p>
<div class="admonition tip">
<p class="admonition-title">社区与手动配置</p>
<p>社区黑名单提供了一种方便的方式来开始使用经过验证的黑名单源。您可以将它们与手动 URL 配置一起使用，以实现最大的灵活性。</p>
</div>
</div>
<div class="tabbed-block">
<p><strong>这是做什么的：</strong> 根据访问者的 IP 地址或网络阻止访问。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BLACKLIST_IP</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>IP 黑名单：</strong> 要阻止的 IP 地址或网络（CIDR 表示法）列表，以空格分隔。</td>
</tr>
<tr>
<td><code>BLACKLIST_IGNORE_IP</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>IP 忽略列表：</strong> 应绕过 IP 黑名单检查的 IP 地址或网络列表。</td>
</tr>
<tr>
<td><code>BLACKLIST_IP_URLS</code></td>
<td><code>https://www.dan.me.uk/torlist/?exit</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>IP 黑名单 URL：</strong> 包含要阻止的 IP 地址或网络的 URL 列表，以空格分隔。</td>
</tr>
<tr>
<td><code>BLACKLIST_IGNORE_IP_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>IP 忽略列表 URL：</strong> 包含要忽略的 IP 地址或网络的 URL 列表。</td>
</tr>
</tbody>
</table>
<p>默认的 <code>BLACKLIST_IP_URLS</code> 设置包含一个提供<strong>已知 Tor 出口节点列表</strong>的 URL。这是恶意流量的常见来源，对于许多网站来说是一个很好的起点。</p>
</div>
<div class="tabbed-block">
<p><strong>这是做什么的：</strong> 根据访问者的反向域名阻止访问。这对于根据其组织域名阻止已知的扫描器和爬虫非常有用。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BLACKLIST_RDNS</code></td>
<td><code>.shodan.io .censys.io</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>rDNS 黑名单：</strong> 要阻止的反向 DNS 后缀列表，以空格分隔。</td>
</tr>
<tr>
<td><code>BLACKLIST_RDNS_GLOBAL</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>仅限 rDNS 全局：</strong> 当设置为 <code>yes</code> 时，仅对全局 IP 地址执行 rDNS 检查。</td>
</tr>
<tr>
<td><code>BLACKLIST_IGNORE_RDNS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>rDNS 忽略列表：</strong> 应绕过 rDNS 黑名单检查的反向 DNS 后缀列表。</td>
</tr>
<tr>
<td><code>BLACKLIST_RDNS_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>rDNS 黑名单 URL：</strong> 包含要阻止的反向 DNS 后缀的 URL 列表，以空格分隔。</td>
</tr>
<tr>
<td><code>BLACKLIST_IGNORE_RDNS_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>rDNS 忽略列表 URL：</strong> 包含要忽略的反向 DNS 后缀的 URL 列表。</td>
</tr>
</tbody>
</table>
<p>默认的 <code>BLACKLIST_RDNS</code> 设置包括常见的扫描器域名，如 <strong>Shodan</strong> 和 <strong>Censys</strong>。这些通常被安全研究人员和扫描器用来识别易受攻击的网站。</p>
</div>
<div class="tabbed-block">
<p><strong>这是做什么的：</strong> 阻止来自特定网络提供商的访问者。ASN 就像互联网的邮政编码——它们标识一个 IP 属于哪个提供商或组织。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BLACKLIST_ASN</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>ASN 黑名单：</strong> 要阻止的自治系统号列表，以空格分隔。</td>
</tr>
<tr>
<td><code>BLACKLIST_IGNORE_ASN</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>ASN 忽略列表：</strong> 应绕过 ASN 黑名单检查的 ASN 列表。</td>
</tr>
<tr>
<td><code>BLACKLIST_ASN_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>ASN 黑名单 URL：</strong> 包含要阻止的 ASN 的 URL 列表，以空格分隔。</td>
</tr>
<tr>
<td><code>BLACKLIST_IGNORE_ASN_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>ASN 忽略列表 URL：</strong> 包含要忽略的 ASN 的 URL 列表。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<p><strong>这是做什么的：</strong> 根据访问者声称使用的浏览器或工具来阻止访问。这对于诚实地表明自己身份的机器人（例如“ScannerBot”或“WebHarvestTool”）是有效的。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BLACKLIST_USER_AGENT</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>用户代理黑名单：</strong> 要阻止的用户代理模式（PCRE 正则表达式）列表，以空格分隔。</td>
</tr>
<tr>
<td><code>BLACKLIST_IGNORE_USER_AGENT</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>用户代理忽略列表：</strong> 应绕过用户代理黑名单检查的用户代理模式列表。</td>
</tr>
<tr>
<td><code>BLACKLIST_USER_AGENT_URLS</code></td>
<td><code>https://raw.githubusercontent.com/mitchellkrogza/nginx-ultimate-bad-bot-blocker/master/_generator_lists/bad-user-agents.list</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>用户代理黑名单 URL：</strong> 包含要阻止的用户代理模式的 URL 列表。</td>
</tr>
<tr>
<td><code>BLACKLIST_IGNORE_USER_AGENT_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>用户代理忽略列表 URL：</strong> 包含要忽略的用户代理模式的 URL 列表。</td>
</tr>
</tbody>
</table>
<p>默认的 <code>BLACKLIST_USER_AGENT_URLS</code> 设置包含一个提供<strong>已知恶意用户代理列表</strong>的 URL。这些通常被恶意机器人和扫描器用来识别易受攻击的网站。</p>
</div>
<div class="tabbed-block">
<p><strong>这是做什么的：</strong> 阻止对您网站上特定 URL 的请求。这对于阻止尝试访问管理页面、登录表单或其他可能成为攻击目标的敏感区域非常有用。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BLACKLIST_URI</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>URI 黑名单：</strong> 要阻止的 URI 模式（PCRE 正则表达式）列表，以空格分隔。</td>
</tr>
<tr>
<td><code>BLACKLIST_IGNORE_URI</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>URI 忽略列表：</strong> 应绕过 URI 黑名单检查的 URI 模式列表。</td>
</tr>
<tr>
<td><code>BLACKLIST_URI_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>URI 黑名单 URL：</strong> 包含要阻止的 URI 模式的 URL 列表，以空格分隔。</td>
</tr>
<tr>
<td><code>BLACKLIST_IGNORE_URI_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>URI 忽略列表 URL：</strong> 包含要忽略的 URI 模式的 URL 列表。</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="admonition info">
<p class="admonition-title">URL 格式支持</p>
<p>所有 <code>*_URLS</code> 设置都支持 HTTP/HTTPS URL 以及使用 <code>file:///</code> 前缀的本地文件路径。使用 <code>http://user:pass@url</code> 格式支持基本身份验证。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">定期更新</p>
<p>来自 URL 的黑名单会每小时自动下载和更新，以确保您的保护措施始终能应对最新的威胁。</p>
</div>
<h3 id="zh-features-_25">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="9:3"><input checked="checked" id="zh-features-__tabbed_9_1" name="zh-features-__tabbed_9" type="radio" /><input id="zh-features-__tabbed_9_2" name="zh-features-__tabbed_9" type="radio" /><input id="zh-features-__tabbed_9_3" name="zh-features-__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_9_1">基本的 IP 和用户代理保护</label><label for="zh-features-__tabbed_9_2">带有自定义规则的高级保护</label><label for="zh-features-__tabbed_9_3">使用本地文件</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个简单的配置，使用社区黑名单阻止已知的 Tor 出口节点和常见的恶意用户代理：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BLACKLIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BLACKLIST_COMMUNITY_LISTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ip:danmeuk-tor-exit</span><span class="nv"> </span><span class="s">ua:mitchellkrogza-bad-user-agents&quot;</span>
</code></pre></div>
<p>或者，您可以使用手动 URL 配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BLACKLIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BLACKLIST_IP_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://www.dan.me.uk/torlist/?exit&quot;</span>
<span class="nt">BLACKLIST_USER_AGENT_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://raw.githubusercontent.com/mitchellkrogza/nginx-ultimate-bad-bot-blocker/master/_generator_lists/bad-user-agents.list&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个更全面的配置，带有自定义黑名单条目和例外情况：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BLACKLIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>

<span class="c1"># 自定义黑名单条目</span>
<span class="nt">BLACKLIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.1.100</span><span class="nv"> </span><span class="s">203.0.113.0/24&quot;</span>
<span class="nt">BLACKLIST_RDNS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;.shodan.io</span><span class="nv"> </span><span class="s">.censys.io</span><span class="nv"> </span><span class="s">.scanner.com&quot;</span>
<span class="nt">BLACKLIST_ASN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;16509</span><span class="nv"> </span><span class="s">14618&quot;</span><span class="w">  </span><span class="c1"># AWS 和 Amazon 的 ASN</span>
<span class="nt">BLACKLIST_USER_AGENT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;(?:\b)SemrushBot(?:\b)</span><span class="nv"> </span><span class="s">(?:\b)AhrefsBot(?:\b)&quot;</span>
<span class="nt">BLACKLIST_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^/wp-login</span><span class="err">\</span><span class="s">.php$</span><span class="nv"> </span><span class="s">^/administrator/&quot;</span>

<span class="c1"># 自定义忽略规则</span>
<span class="nt">BLACKLIST_IGNORE_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.1.200</span><span class="nv"> </span><span class="s">203.0.113.42&quot;</span>

<span class="c1"># 外部黑名单源</span>
<span class="nt">BLACKLIST_IP_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://www.dan.me.uk/torlist/?exit</span><span class="nv"> </span><span class="s">https://www.spamhaus.org/drop/drop.txt&quot;</span>
<span class="nt">BLACKLIST_USER_AGENT_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://raw.githubusercontent.com/mitchellkrogza/nginx-ultimate-bad-bot-blocker/master/_generator_lists/bad-user-agents.list&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用本地文件作为黑名单的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BLACKLIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BLACKLIST_IP_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/ip-blacklist.txt&quot;</span>
<span class="nt">BLACKLIST_RDNS_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/rdns-blacklist.txt&quot;</span>
<span class="nt">BLACKLIST_ASN_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/asn-blacklist.txt&quot;</span>
<span class="nt">BLACKLIST_USER_AGENT_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/user-agent-blacklist.txt&quot;</span>
<span class="nt">BLACKLIST_URI_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/uri-blacklist.txt&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-brotli">Brotli</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>Brotli 插件使用 Brotli 算法实现对 HTTP 响应的高效压缩。此功能通过在将 Web 内容发送到客户端浏览器之前对其进行压缩，帮助减少带宽使用并缩短页面加载时间。</p>
<p>与其他压缩方法（如 gzip）相比，Brotli 通常能实现更高的压缩率，从而减小文件大小，加快内容交付速度。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当客户端从您的网站请求内容时，BunkerWeb 会检查客户端是否支持 Brotli 压缩。</li>
<li>如果支持，BunkerWeb 会在您配置的压缩级别下使用 Brotli 算法对响应进行压缩。</li>
<li>压缩后的内容会连同指示 Brotli 压缩的适当标头一起发送给客户端。</li>
<li>客户端的浏览器在向用户呈现内容之前会对其进行解压缩。</li>
<li>带宽使用量和页面加载时间都得到了减少，从而改善了整体用户体验。</li>
</ol>
<h3 id="zh-features-_26">如何使用</h3>
<p>请按照以下步骤配置和使用 Brotli 压缩功能：</p>
<ol>
<li><strong>启用该功能：</strong> Brotli 功能默认禁用。通过将 <code>USE_BROTLI</code> 设置为 <code>yes</code> 来启用它。</li>
<li><strong>配置 MIME 类型：</strong> 使用 <code>BROTLI_TYPES</code> 设置指定应压缩的内容类型。</li>
<li><strong>设置最小大小：</strong> 使用 <code>BROTLI_MIN_LENGTH</code> 定义压缩的最小响应大小，以避免压缩过小的文件。</li>
<li><strong>选择压缩级别：</strong> 使用 <code>BROTLI_COMP_LEVEL</code> 选择您偏好的速度与压缩率之间的平衡。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 配置完成后，压缩会自动对符合条件的响应进行。</li>
</ol>
<h3 id="zh-features-_27">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_BROTLI</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用 Brotli：</strong> 设置为 <code>yes</code> 以启用 Brotli 压缩。</td>
</tr>
<tr>
<td><code>BROTLI_TYPES</code></td>
<td><code>application/atom+xml application/javascript application/json application/rss+xml application/vnd.ms-fontobject application/x-font-opentype application/x-font-truetype application/x-font-ttf application/x-javascript application/xhtml+xml application/xml font/eot font/opentype font/otf font/truetype image/svg+xml image/vnd.microsoft.icon image/x-icon image/x-win-bitmap text/css text/javascript text/plain text/xml</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>MIME 类型：</strong> 将使用 Brotli 压缩的内容类型列表。</td>
</tr>
<tr>
<td><code>BROTLI_MIN_LENGTH</code></td>
<td><code>1000</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>最小大小：</strong> 应用 Brotli 压缩的最小响应大小（以字节为单位）。</td>
</tr>
<tr>
<td><code>BROTLI_COMP_LEVEL</code></td>
<td><code>6</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>压缩级别：</strong> 压缩级别从 0（不压缩）到 11（最大压缩）。较高的值会使用更多的 CPU。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">优化压缩级别</p>
<p>默认的压缩级别 (6) 在压缩率和 CPU 使用率之间提供了良好的平衡。对于静态内容或服务器 CPU 资源充足的情况，可以考虑增加到 9-11 以获得最大压缩。对于动态内容或 CPU 资源有限的情况，您可能希望使用 4-5 以实现更快的压缩和合理的尺寸减小。</p>
</div>
<div class="admonition info">
<p class="admonition-title">浏览器支持</p>
<p>所有现代浏览器，包括 Chrome、Firefox、Edge、Safari 和 Opera，都支持 Brotli。旧版浏览器会自动接收未压缩的内容，以确保兼容性。</p>
</div>
<h3 id="zh-features-_28">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="10:3"><input checked="checked" id="zh-features-__tabbed_10_1" name="zh-features-__tabbed_10" type="radio" /><input id="zh-features-__tabbed_10_2" name="zh-features-__tabbed_10" type="radio" /><input id="zh-features-__tabbed_10_3" name="zh-features-__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_10_1">基本配置</label><label for="zh-features-__tabbed_10_2">最大压缩</label><label for="zh-features-__tabbed_10_3">平衡性能</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个使用默认设置启用 Brotli 的标准配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BROTLI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BROTLI_TYPES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;application/javascript</span><span class="nv"> </span><span class="s">application/json</span><span class="nv"> </span><span class="s">application/xml</span><span class="nv"> </span><span class="s">application/xhtml+xml</span><span class="nv"> </span><span class="s">text/css</span><span class="nv"> </span><span class="s">text/html</span><span class="nv"> </span><span class="s">text/javascript</span><span class="nv"> </span><span class="s">text/plain</span><span class="nv"> </span><span class="s">text/xml&quot;</span>
<span class="nt">BROTLI_MIN_LENGTH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1000&quot;</span>
<span class="nt">BROTLI_COMP_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;6&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>为实现最大压缩节省而优化的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BROTLI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BROTLI_TYPES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;application/atom+xml</span><span class="nv"> </span><span class="s">application/javascript</span><span class="nv"> </span><span class="s">application/json</span><span class="nv"> </span><span class="s">application/rss+xml</span><span class="nv"> </span><span class="s">application/vnd.ms-fontobject</span><span class="nv"> </span><span class="s">application/x-font-opentype</span><span class="nv"> </span><span class="s">application/x-font-truetype</span><span class="nv"> </span><span class="s">application/x-font-ttf</span><span class="nv"> </span><span class="s">application/x-javascript</span><span class="nv"> </span><span class="s">application/xhtml+xml</span><span class="nv"> </span><span class="s">application/xml</span><span class="nv"> </span><span class="s">font/eot</span><span class="nv"> </span><span class="s">font/opentype</span><span class="nv"> </span><span class="s">font/otf</span><span class="nv"> </span><span class="s">font/truetype</span><span class="nv"> </span><span class="s">image/svg+xml</span><span class="nv"> </span><span class="s">image/vnd.microsoft.icon</span><span class="nv"> </span><span class="s">image/x-icon</span><span class="nv"> </span><span class="s">image/x-win-bitmap</span><span class="nv"> </span><span class="s">text/css</span><span class="nv"> </span><span class="s">text/javascript</span><span class="nv"> </span><span class="s">text/plain</span><span class="nv"> </span><span class="s">text/xml&quot;</span>
<span class="nt">BROTLI_MIN_LENGTH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500&quot;</span>
<span class="nt">BROTLI_COMP_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;11&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>在压缩率和 CPU 使用率之间取得平衡的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BROTLI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BROTLI_TYPES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;application/javascript</span><span class="nv"> </span><span class="s">application/json</span><span class="nv"> </span><span class="s">text/css</span><span class="nv"> </span><span class="s">text/html</span><span class="nv"> </span><span class="s">text/javascript</span><span class="nv"> </span><span class="s">text/plain&quot;</span>
<span class="nt">BROTLI_MIN_LENGTH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1000&quot;</span>
<span class="nt">BROTLI_COMP_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-bunkernet">BunkerNet</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>BunkerNet 插件通过 BunkerWeb 实例之间的集体威胁情报共享，创建了一个强大的恶意行为者防护网络。通过参与 BunkerNet，您的实例不仅受益于全球已知威胁数据库，同时也为其做出贡献，从而增强了整个 BunkerWeb 社区的安全性。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>您的 BunkerWeb 实例会自动向 BunkerNet API 注册，以获取一个唯一标识符。</li>
<li>当您的实例检测并阻止了恶意 IP 地址或行为时，它会匿名地向 BunkerNet 报告该威胁。</li>
<li>BunkerNet 聚合来自所有参与实例的威胁情报，并分发整合后的数据库。</li>
<li>您的实例会定期从 BunkerNet 下载更新的已知威胁数据库。</li>
<li>这种集体情报使您的实例能够主动阻止在其他 BunkerWeb 实例上表现出恶意行为的 IP 地址。</li>
</ol>
<div class="admonition success">
<p class="admonition-title">主要优点</p>
<ol>
<li><strong>集体防御：</strong> 利用全球成千上万个其他 BunkerWeb 实例的安全发现。</li>
<li><strong>主动防护：</strong> 根据恶意行为者在别处的行为，在他们攻击您的网站之前就将其阻止。</li>
<li><strong>社区贡献：</strong> 通过分享关于攻击者的匿名威胁数据，帮助保护其他 BunkerWeb 用户。</li>
<li><strong>零配置：</strong> 开箱即用，带有合理的默认值，只需最少的设置。</li>
<li><strong>注重隐私：</strong> 只分享必要的威胁信息，不损害您或您用户的隐私。</li>
</ol>
</div>
<h3 id="zh-features-_29">如何使用</h3>
<p>请按照以下步骤配置和使用 BunkerNet 功能：</p>
<ol>
<li><strong>启用该功能：</strong> BunkerNet 功能默认启用。如果需要，您可以使用 <code>USE_BUNKERNET</code> 设置来控制此功能。</li>
<li><strong>初始注册：</strong> 首次启动时，您的实例将自动向 BunkerNet API 注册并收到一个唯一标识符。</li>
<li><strong>自动更新：</strong> 您的实例将按常规计划自动下载最新的威胁数据库。</li>
<li><strong>自动报告：</strong> 当您的实例阻止了一个恶意 IP 地址时，它会自动将此数据贡献给社区。</li>
<li><strong>监控保护：</strong> 查看 <a href="#zh-web-ui">web UI</a> 以查看由 BunkerNet 情报阻止的威胁统计信息。</li>
</ol>
<h3 id="zh-features-_30">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_BUNKERNET</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用 BunkerNet：</strong> 设置为 <code>yes</code> 以启用 BunkerNet 威胁情报共享。</td>
</tr>
<tr>
<td><code>BUNKERNET_SERVER</code></td>
<td><code>https://api.bunkerweb.io</code></td>
<td>global</td>
<td>否</td>
<td><strong>BunkerNet 服务器：</strong> 用于共享威胁情报的 BunkerNet API 服务器地址。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">网络保护</p>
<p>当 BunkerNet 检测到某个 IP 地址在多个 BunkerWeb 实例中参与了恶意活动时，它会将该 IP 添加到集体黑名单中。这提供了一个主动的防御层，在威胁直接攻击您之前就保护您的网站。</p>
</div>
<div class="admonition info">
<p class="admonition-title">匿名报告</p>
<p>在向 BunkerNet 报告威胁信息时，您的实例只分享识别威胁所需的数据：IP 地址、阻止原因和最少的上下文数据。不会分享有关您的用户的个人信息或有关您网站的敏感详细信息。</p>
</div>
<h3 id="zh-features-_31">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="11:3"><input checked="checked" id="zh-features-__tabbed_11_1" name="zh-features-__tabbed_11" type="radio" /><input id="zh-features-__tabbed_11_2" name="zh-features-__tabbed_11" type="radio" /><input id="zh-features-__tabbed_11_3" name="zh-features-__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_11_1">默认配置（推荐）</label><label for="zh-features-__tabbed_11_2">禁用配置</label><label for="zh-features-__tabbed_11_3">自定义服务器配置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>默认配置使用官方 BunkerWeb API 服务器启用 BunkerNet：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BUNKERNET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BUNKERNET_SERVER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://api.bunkerweb.io&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>如果您不想参与 BunkerNet 威胁情报网络：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BUNKERNET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>对于运行自己的 BunkerNet 服务器的组织（不常见）：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_BUNKERNET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">BUNKERNET_SERVER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://bunkernet.example.com&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="zh-features-crowdsec">CrowdSec 控制台集成</h3>
<p>如果您还不熟悉 CrowdSec 控制台集成，<a href="https://www.crowdsec.net/?utm_campaign=bunkerweb&amp;utm_source=doc">CrowdSec</a> 利用众包情报来对抗网络威胁。可以把它想象成“网络安全界的 Waze”——当一台服务器受到攻击时，全球其他系统都会收到警报，并受到保护，免受同一攻击者的侵害。您可以在<a href="https://www.crowdsec.net/about?utm_campaign=bunkerweb&amp;utm_source=blog">这里</a>了解更多信息。</p>
<p>通过我们与 CrowdSec 的合作，您可以将您的 BunkerWeb 实例注册到您的 <a href="https://app.crowdsec.net/signup?utm_source=external-blog&amp;utm_medium=cta&amp;utm_campaign=bunker-web-integration">CrowdSec 控制台</a>。这意味着由 BunkerWeb 阻止的攻击将与由 CrowdSec 安全引擎阻止的攻击一起显示在您的 CrowdSec 控制台中，为您提供统一的威胁视图。</p>
<p>重要的是，此集成无需安装 CrowdSec（尽管我们强烈建议您使用 <a href="https://github.com/bunkerity/bunkerweb-plugins/tree/main/crowdsec">BunkerWeb 的 CrowdSec 插件</a>来进一步增强您的 Web 服务的安全性）。此外，您可以将您的 CrowdSec 安全引擎注册到同一个控制台帐户，以实现更大的协同作用。</p>
<p><strong>步骤 1：创建您的 CrowdSec 控制台帐户</strong></p>
<p>前往 <a href="https://app.crowdsec.net/signup?utm_source=external-blog&amp;utm_medium=cta&amp;utm_campaign=bunker-web-integration">CrowdSec 控制台</a>注册，如果您还没有帐户的话。完成后，记下在“安全引擎”下点击“添加安全引擎”后找到的注册密钥：</p>
<figure>
<p><img align="center" alt="概述" src="../assets/img/crowdity1.png" />
  </p>
<figcaption>获取您的 Crowdsec 控制台注册密钥</figcaption>
</figure>
<p><strong>步骤 2：获取您的 BunkerNet ID</strong></p>
<p>如果您想将您的 BunkerWeb 实例注册到您的 CrowdSec 控制台中，激活 BunkerNet 功能（默认启用）是强制性的。通过将 <code>USE_BUNKERNET</code> 设置为 <code>yes</code> 来启用它。</p>
<p>对于 Docker，使用以下命令获取您的 BunkerNet ID：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>my-bw-scheduler<span class="w"> </span>cat<span class="w"> </span>/var/cache/bunkerweb/bunkernet/instance.id
</code></pre></div>
<p>对于 Linux，使用：</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span>/var/cache/bunkerweb/bunkernet/instance.id
</code></pre></div>
<p><strong>步骤 3：使用面板注册您的实例</strong></p>
<p>一旦您有了您的 BunkerNet ID 和 CrowdSec 控制台注册密钥，请在<a href="https://panel.bunkerweb.io/store/bunkernet?utm_campaign=self&amp;utm_source=doc">面板上订购免费产品“BunkerNet / CrowdSec”</a>。如果您还没有帐户，可能会提示您创建一个。</p>
<p>您现在可以选择“BunkerNet / CrowdSec”服务并填写表格，粘贴您的 BunkerNet ID 和 CrowdSec 控制台注册密钥：</p>
<figure>
<p><img align="center" alt="概述" src="../assets/img/crowdity2.png" />
  </p>
<figcaption>将您的 BunkerWeb 实例注册到 CrowdSec 控制台</figcaption>
</figure>
<p><strong>步骤 4：在控制台上接受新的安全引擎</strong></p>
<p>然后，返回您的 CrowdSec 控制台并接受新的安全引擎：</p>
<figure>
<p><img align="center" alt="概述" src="../assets/img/crowdity3.png" />
  </p>
<figcaption>接受注册到 CrowdSec 控制台</figcaption>
</figure>
<p><strong>恭喜，您的 BunkerWeb 实例现已注册到您的 CrowdSec 控制台！</strong></p>
<p>专业提示：查看警报时，点击“列”选项并勾选“上下文”复选框，以访问 BunkerWeb 特定的数据。</p>
<figure>
<p><img align="center" alt="概述" src="../assets/img/crowdity4.png" />
  </p>
<figcaption>在上下文列中显示的 BunkerWeb 数据</figcaption>
</figure>
<h2 id="zh-features-cors">CORS</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>CORS 插件为您的网站启用跨源资源共享，允许从不同域受控地访问您的资源。此功能通过明确定义允许哪些源、方法和标头，帮助您安全地与受信任的第三方网站共享您的内容，同时维护安全性。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当浏览器向您的网站发出跨源请求时，它首先会发送一个带有 <code>OPTIONS</code> 方法的预检请求。</li>
<li>BunkerWeb 会根据您的配置检查请求的源是否被允许。</li>
<li>如果允许，BunkerWeb 会响应适当的 CORS 标头，这些标头定义了请求站点可以执行的操作。</li>
<li>对于不允许的源，请求可以被完全拒绝，也可以不带 CORS 标头地提供服务。</li>
<li>可以配置其他跨源策略，例如 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Embedder-Policy">COEP</a>、<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Opener-Policy">COOP</a> 和 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Resource-Policy">CORP</a>，以进一步增强安全性。</li>
</ol>
<h3 id="zh-features-_32">如何使用</h3>
<p>请按照以下步骤配置和使用 CORS 功能：</p>
<ol>
<li><strong>启用该功能：</strong> CORS 功能默认禁用。将 <code>USE_CORS</code> 设置为 <code>yes</code> 以启用它。</li>
<li><strong>配置允许的源：</strong> 使用 <code>CORS_ALLOW_ORIGIN</code> 设置指定哪些域可以访问您的资源。</li>
<li><strong>设置允许的方法：</strong> 使用 <code>CORS_ALLOW_METHODS</code> 定义允许用于跨源请求的 HTTP 方法。</li>
<li><strong>配置允许的标头：</strong> 使用 <code>CORS_ALLOW_HEADERS</code> 指定可以在请求中使用的标头。</li>
<li><strong>控制凭据：</strong> 使用 <code>CORS_ALLOW_CREDENTIALS</code> 决定跨源请求是否可以包含凭据。</li>
</ol>
<h3 id="zh-features-_33">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_CORS</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用 CORS：</strong> 设置为 <code>yes</code> 以启用跨源资源共享。</td>
</tr>
<tr>
<td><code>CORS_ALLOW_ORIGIN</code></td>
<td><code>self</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>允许的来源：</strong> 表示允许来源的 PCRE 正则表达式；使用 <code>*</code> 表示任何来源，或 <code>self</code> 表示仅限同源。</td>
</tr>
<tr>
<td><code>CORS_ALLOW_METHODS</code></td>
<td><code>GET, POST, OPTIONS</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>允许的方法：</strong> 可在跨源请求中使用的 HTTP 方法。</td>
</tr>
<tr>
<td><code>CORS_ALLOW_HEADERS</code></td>
<td><code>DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>允许的标头：</strong> 可在跨源请求中使用的 HTTP 标头。</td>
</tr>
<tr>
<td><code>CORS_ALLOW_CREDENTIALS</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>允许凭据：</strong> 设置为 <code>yes</code> 以允许在 CORS 请求中使用凭据（cookie、HTTP 身份验证）。</td>
</tr>
<tr>
<td><code>CORS_EXPOSE_HEADERS</code></td>
<td><code>Content-Length,Content-Range</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>公开的标头：</strong> 浏览器允许从跨源响应中访问的 HTTP 标头。</td>
</tr>
<tr>
<td><code>CROSS_ORIGIN_OPENER_POLICY</code></td>
<td><code>same-origin</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>跨源打开器策略：</strong> 控制浏览上下文之间的通信。</td>
</tr>
<tr>
<td><code>CROSS_ORIGIN_EMBEDDER_POLICY</code></td>
<td><code>require-corp</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>跨源嵌入器策略：</strong> 控制文档是否可以加载来自其他来源的资源。</td>
</tr>
<tr>
<td><code>CROSS_ORIGIN_RESOURCE_POLICY</code></td>
<td><code>same-site</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>跨源资源策略：</strong> 控制哪些网站可以嵌入您的资源。</td>
</tr>
<tr>
<td><code>CORS_MAX_AGE</code></td>
<td><code>86400</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>预检缓存持续时间：</strong> 浏览器应缓存预检响应的时间（以秒为单位）。</td>
</tr>
<tr>
<td><code>CORS_DENY_REQUEST</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>拒绝未经授权的来源：</strong> 当为 <code>yes</code> 时，来自未经授权来源的请求将被拒绝并返回错误代码。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">优化预检请求</p>
<p><code>CORS_MAX_AGE</code> 设置决定了浏览器缓存预检请求结果的时间。将其设置为一个较高的值（例如默认的 86400 秒/24 小时）可以减少预检请求的数量，从而提高频繁访问资源的性能。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">安全注意事项</p>
<p>在将 <code>CORS_ALLOW_ORIGIN</code> 设置为 <code>*</code>（所有来源）或将 <code>CORS_ALLOW_CREDENTIALS</code> 设置为 <code>yes</code> 时要小心，因为如果管理不当，这些配置可能会引入安全风险。通常更安全的做法是明确列出受信任的来源，并限制允许的方法和标头。</p>
</div>
<h3 id="zh-features-_34">示例配置</h3>
<p>以下是 <code>CORS_ALLOW_ORIGIN</code> 设置的可能值及其行为的示例：</p>
<ul>
<li><strong><code>*</code></strong>：允许来自所有来源的请求。</li>
<li><strong><code>self</code></strong>：自动允许来自与配置的 server_name 相同的来源的请求。</li>
<li><strong><code>^https://www\.example\.com$</code></strong>：仅允许来自 <code>https://www.example.com</code> 的请求。</li>
<li><strong><code>^https://.+\.example\.com$</code></strong>：允许来自以 <code>.example.com</code> 结尾的任何子域的请求。</li>
<li><strong><code>^https://(www\.example1\.com|www\.example2\.com)$</code></strong>：允许来自 <code>https://www.example1.com</code> 或 <code>https://www.example2.com</code> 的请求。</li>
<li><strong><code>^https?://www\.example\.com$</code></strong>：允许来自 <code>https://www.example.com</code> 和 <code>http://www.example.com</code> 的请求。</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="12:5"><input checked="checked" id="zh-features-__tabbed_12_1" name="zh-features-__tabbed_12" type="radio" /><input id="zh-features-__tabbed_12_2" name="zh-features-__tabbed_12" type="radio" /><input id="zh-features-__tabbed_12_3" name="zh-features-__tabbed_12" type="radio" /><input id="zh-features-__tabbed_12_4" name="zh-features-__tabbed_12" type="radio" /><input id="zh-features-__tabbed_12_5" name="zh-features-__tabbed_12" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_12_1">基本配置</label><label for="zh-features-__tabbed_12_2">公共 API 配置</label><label for="zh-features-__tabbed_12_3">多个受信任的域</label><label for="zh-features-__tabbed_12_4">子域通配符</label><label for="zh-features-__tabbed_12_5">多个域模式</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个简单的配置，允许来自同一域的跨源请求：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CORS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CORS_ALLOW_ORIGIN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;self&quot;</span>
<span class="nt">CORS_ALLOW_METHODS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GET,</span><span class="nv"> </span><span class="s">POST,</span><span class="nv"> </span><span class="s">OPTIONS&quot;</span>
<span class="nt">CORS_ALLOW_HEADERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Content-Type,</span><span class="nv"> </span><span class="s">Authorization&quot;</span>
<span class="nt">CORS_ALLOW_CREDENTIALS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
<span class="nt">CORS_DENY_REQUEST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>需要从任何来源访问的公共 API 的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CORS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CORS_ALLOW_ORIGIN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*&quot;</span>
<span class="nt">CORS_ALLOW_METHODS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GET,</span><span class="nv"> </span><span class="s">OPTIONS&quot;</span>
<span class="nt">CORS_ALLOW_HEADERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Content-Type,</span><span class="nv"> </span><span class="s">X-API-Key&quot;</span>
<span class="nt">CORS_ALLOW_CREDENTIALS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
<span class="nt">CORS_MAX_AGE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3600&quot;</span>
<span class="nt">CORS_DENY_REQUEST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用单个 PCRE 正则表达式模式允许多个特定域的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CORS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CORS_ALLOW_ORIGIN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^https://(app|api|dashboard)\\.example\\.com$&quot;</span>
<span class="nt">CORS_ALLOW_METHODS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GET,</span><span class="nv"> </span><span class="s">POST,</span><span class="nv"> </span><span class="s">PUT,</span><span class="nv"> </span><span class="s">DELETE,</span><span class="nv"> </span><span class="s">OPTIONS&quot;</span>
<span class="nt">CORS_ALLOW_HEADERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Content-Type,</span><span class="nv"> </span><span class="s">Authorization,</span><span class="nv"> </span><span class="s">X-Requested-With&quot;</span>
<span class="nt">CORS_ALLOW_CREDENTIALS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CORS_EXPOSE_HEADERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Content-Length,</span><span class="nv"> </span><span class="s">Content-Range,</span><span class="nv"> </span><span class="s">X-RateLimit-Remaining&quot;</span>
<span class="nt">CORS_MAX_AGE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
<span class="nt">CORS_DENY_REQUEST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用 PCRE 正则表达式模式允许主域的所有子域的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CORS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CORS_ALLOW_ORIGIN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^https://.*\\.example\\.com$&quot;</span>
<span class="nt">CORS_ALLOW_METHODS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GET,</span><span class="nv"> </span><span class="s">POST,</span><span class="nv"> </span><span class="s">OPTIONS&quot;</span>
<span class="nt">CORS_ALLOW_HEADERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Content-Type,</span><span class="nv"> </span><span class="s">Authorization&quot;</span>
<span class="nt">CORS_ALLOW_CREDENTIALS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
<span class="nt">CORS_MAX_AGE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
<span class="nt">CORS_DENY_REQUEST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用交替允许多个域模式的请求的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CORS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CORS_ALLOW_ORIGIN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^https://(.*\\.example\\.com|.*\\.trusted-partner\\.org|api\\.third-party\\.net)$&quot;</span>
<span class="nt">CORS_ALLOW_METHODS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GET,</span><span class="nv"> </span><span class="s">POST,</span><span class="nv"> </span><span class="s">PUT,</span><span class="nv"> </span><span class="s">OPTIONS&quot;</span>
<span class="nt">CORS_ALLOW_HEADERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Content-Type,</span><span class="nv"> </span><span class="s">Authorization,</span><span class="nv"> </span><span class="s">X-Custom-Header&quot;</span>
<span class="nt">CORS_ALLOW_CREDENTIALS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
<span class="nt">CORS_MAX_AGE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
<span class="nt">CORS_DENY_REQUEST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-client-cache">Client cache</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>客户端缓存插件通过控制浏览器如何缓存静态内容来优化网站性能。它通过指示浏览器在本地存储和重用静态资产（例如图像、CSS 和 JavaScript 文件），而不是在每次页面访问时都请求它们，从而减少了带宽使用量，降低了服务器负载，并缩短了页面加载时间。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>启用后，BunkerWeb 会向静态文件的响应中添加 Cache-Control 标头。</li>
<li>这些标头会告诉浏览器应在本地缓存内容多长时间。</li>
<li>对于具有指定扩展名的文件（例如图像、CSS、JavaScript），BunkerWeb 会应用配置的缓存策略。</li>
<li>可选的 ETag 支持提供了一个额外的验证机制，以确定缓存的内容是否仍然是新鲜的。</li>
<li>当访问者返回您的网站时，他们的浏览器可以使用本地缓存的文件，而不是再次下载它们，从而缩短了页面加载时间。</li>
</ol>
<h3 id="zh-features-_35">如何使用</h3>
<p>请按照以下步骤配置和使用客户端缓存功能：</p>
<ol>
<li><strong>启用该功能：</strong> 客户端缓存功能默认禁用；将 <code>USE_CLIENT_CACHE</code> 设置为 <code>yes</code> 以启用它。</li>
<li><strong>配置扩展名：</strong> 使用 <code>CLIENT_CACHE_EXTENSIONS</code> 设置指定应缓存的文件类型。</li>
<li><strong>设置缓存控制指令：</strong> 使用 <code>CLIENT_CACHE_CONTROL</code> 设置自定义客户端应如何缓存内容。</li>
<li><strong>配置 ETag 支持：</strong> 使用 <code>CLIENT_CACHE_ETAG</code> 设置决定是否启用 ETag 来验证缓存新鲜度。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 配置完成后，缓存标头会自动应用于符合条件的响应。</li>
</ol>
<h3 id="zh-features-_36">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_CLIENT_CACHE</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用客户端缓存：</strong> 设置为 <code>yes</code> 以启用静态文件的客户端缓存。</td>
</tr>
<tr>
<td><code>CLIENT_CACHE_EXTENSIONS</code></td>
<td><code>jpg                       | jpeg      | png  | bmp                                                                       | ico | svg | tif | css | js | otf | ttf | eot | woff | woff2</code></td>
<td>全局</td>
<td>否</td>
<td><strong>可缓存的扩展名：</strong> 应由客户端缓存的文件扩展名列表（以管道符分隔）。</td>
</tr>
<tr>
<td><code>CLIENT_CACHE_CONTROL</code></td>
<td><code>public, max-age=15552000</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>Cache-Control 标头：</strong> 用于控制缓存行为的 Cache-Control HTTP 标头的值。</td>
</tr>
<tr>
<td><code>CLIENT_CACHE_ETAG</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用 ETags：</strong> 设置为 <code>yes</code> 以发送静态资源的 HTTP ETag 标头。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">优化缓存设置</p>
<p>对于频繁更新的内容，请考虑使用较短的 max-age 值。对于很少更改的内容（如带版本的 JavaScript 库或徽标），请使用较长的缓存时间。默认值 15552000 秒（180 天）适用于大多数静态资产。</p>
</div>
<div class="admonition info">
<p class="admonition-title">浏览器行为</p>
<p>不同的浏览器对缓存的实现略有不同，但所有现代浏览器都遵循标准的 Cache-Control 指令。ETags 提供了一个额外的验证机制，可以帮助浏览器确定缓存的内容是否仍然有效。</p>
</div>
<h3 id="zh-features-_37">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="13:3"><input checked="checked" id="zh-features-__tabbed_13_1" name="zh-features-__tabbed_13" type="radio" /><input id="zh-features-__tabbed_13_2" name="zh-features-__tabbed_13" type="radio" /><input id="zh-features-__tabbed_13_3" name="zh-features-__tabbed_13" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_13_1">基本配置</label><label for="zh-features-__tabbed_13_2">积极缓存</label><label for="zh-features-__tabbed_13_3">混合内容策略</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个简单的配置，为常见的静态资产启用缓存：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CLIENT_CACHE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CLIENT_CACHE_EXTENSIONS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;jpg|jpeg|png|gif|css|js|svg|woff|woff2&quot;</span>
<span class="nt">CLIENT_CACHE_CONTROL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;public,</span><span class="nv"> </span><span class="s">max-age=86400&quot;</span><span class="w">  </span><span class="c1"># 1 天</span>
<span class="nt">CLIENT_CACHE_ETAG</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>为实现最大缓存而优化的配置，适用于静态内容更新不频繁的网站：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CLIENT_CACHE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CLIENT_CACHE_EXTENSIONS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;jpg|jpeg|png|bmp|ico|svg|tif|gif|css|js|otf|ttf|eot|woff|woff2|pdf|xml|txt&quot;</span>
<span class="nt">CLIENT_CACHE_CONTROL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;public,</span><span class="nv"> </span><span class="s">max-age=31536000,</span><span class="nv"> </span><span class="s">immutable&quot;</span><span class="w">  </span><span class="c1"># 1 年</span>
<span class="nt">CLIENT_CACHE_ETAG</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>对于同时包含频繁更新和不频繁更新内容的网站，请考虑在您的应用程序中使用文件版本控制，并采用如下配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CLIENT_CACHE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CLIENT_CACHE_EXTENSIONS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;jpg|jpeg|png|bmp|ico|svg|tif|gif|css|js|otf|ttf|eot|woff|woff2&quot;</span>
<span class="nt">CLIENT_CACHE_CONTROL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;public,</span><span class="nv"> </span><span class="s">max-age=604800&quot;</span><span class="w">  </span><span class="c1"># 1 周</span>
<span class="nt">CLIENT_CACHE_ETAG</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-country">Country</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>国家/地区插件为您的网站启用地理封锁功能，允许您根据访问者的地理位置限制访问。此功能可帮助您遵守区域法规、防止通常与高风险地区相关的欺诈活动，并根据地理边界实施内容限制。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当访问者访问您的网站时，BunkerWeb 会根据他们的 IP 地址确定他们的国家/地区。</li>
<li>您的配置指定了白名单（允许的国家/地区）或黑名单（被阻止的国家/地区）。</li>
<li>如果您设置了白名单，只有来自该列表中国家/地区的访问者才会被授予访问权限。</li>
<li>如果您设置了黑名单，来自该列表中国家/地区的访问者将被拒绝访问。</li>
<li>结果会被缓存，以提高来自同一 IP 地址的重复访问者的性能。</li>
</ol>
<h3 id="zh-features-_38">如何使用</h3>
<p>请按照以下步骤配置和使用国家/地区功能：</p>
<ol>
<li><strong>定义您的策略：</strong> 决定您是想使用白名单方法（仅允许特定国家/地区）还是黑名单方法（阻止特定国家/地区）。</li>
<li><strong>配置国家/地区代码：</strong> 将 ISO 3166-1 alpha-2 国家/地区代码（例如 US、GB、FR 等两位字母代码）添加到 <code>WHITELIST_COUNTRY</code> 或 <code>BLACKLIST_COUNTRY</code> 设置中。</li>
<li><strong>应用设置：</strong> 配置完成后，基于国家/地区的限制将适用于您网站的所有访问者。</li>
<li><strong>监控有效性：</strong> 查看 <a href="#zh-web-ui">web UI</a> 以查看按国家/地区阻止的请求统计信息。</li>
</ol>
<h3 id="zh-features-_39">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WHITELIST_COUNTRY</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>国家/地区白名单：</strong> 以空格分隔的国家/地区代码（ISO 3166-1 alpha-2 格式）列表。只允许这些国家/地区。</td>
</tr>
<tr>
<td><code>BLACKLIST_COUNTRY</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>国家/地区黑名单：</strong> 以空格分隔的国家/地区代码（ISO 3166-1 alpha-2 格式）列表。这些国家/地区将被阻止。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">白名单与黑名单</p>
<p>选择最适合您需求的方法：</p>
<ul>
<li>当您想将访问限制在少数几个国家/地区时，请使用白名单。</li>
<li>当您想阻止来自特定问题地区的访问，同时允许其他所有地区时，请使用黑名单。</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">优先规则</p>
<p>如果同时配置了白名单和黑名单，则白名单优先。这意味着系统首先检查一个国家/地区是否在白名单中；如果不在，无论黑名单配置如何，访问都将被拒绝。</p>
</div>
<div class="admonition info">
<p class="admonition-title">国家/地区检测</p>
<p>BunkerWeb 使用 <a href="https://db-ip.com/db/download/ip-to-country-lite">lite db-ip mmdb 数据库</a>根据 IP 地址确定来源国家/地区。</p>
</div>
<h3 id="zh-features-_40">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="14:4"><input checked="checked" id="zh-features-__tabbed_14_1" name="zh-features-__tabbed_14" type="radio" /><input id="zh-features-__tabbed_14_2" name="zh-features-__tabbed_14" type="radio" /><input id="zh-features-__tabbed_14_3" name="zh-features-__tabbed_14" type="radio" /><input id="zh-features-__tabbed_14_4" name="zh-features-__tabbed_14" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_14_1">仅白名单</label><label for="zh-features-__tabbed_14_2">仅黑名单</label><label for="zh-features-__tabbed_14_3">仅限欧盟访问</label><label for="zh-features-__tabbed_14_4">高风险国家/地区被阻止</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>仅允许来自美国、加拿大和英国的访问：</p>
<div class="highlight"><pre><span></span><code><span class="nt">WHITELIST_COUNTRY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;US</span><span class="nv"> </span><span class="s">CA</span><span class="nv"> </span><span class="s">GB&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>阻止来自特定国家/地区的访问，同时允许所有其他国家/地区：</p>
<div class="highlight"><pre><span></span><code><span class="nt">BLACKLIST_COUNTRY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;RU</span><span class="nv"> </span><span class="s">CN</span><span class="nv"> </span><span class="s">KP&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>仅允许来自欧盟成员国的访问：</p>
<div class="highlight"><pre><span></span><code><span class="nt">WHITELIST_COUNTRY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;AT</span><span class="nv"> </span><span class="s">BE</span><span class="nv"> </span><span class="s">BG</span><span class="nv"> </span><span class="s">HR</span><span class="nv"> </span><span class="s">CY</span><span class="nv"> </span><span class="s">CZ</span><span class="nv"> </span><span class="s">DK</span><span class="nv"> </span><span class="s">EE</span><span class="nv"> </span><span class="s">FI</span><span class="nv"> </span><span class="s">FR</span><span class="nv"> </span><span class="s">DE</span><span class="nv"> </span><span class="s">GR</span><span class="nv"> </span><span class="s">HU</span><span class="nv"> </span><span class="s">IE</span><span class="nv"> </span><span class="s">IT</span><span class="nv"> </span><span class="s">LV</span><span class="nv"> </span><span class="s">LT</span><span class="nv"> </span><span class="s">LU</span><span class="nv"> </span><span class="s">MT</span><span class="nv"> </span><span class="s">NL</span><span class="nv"> </span><span class="s">PL</span><span class="nv"> </span><span class="s">PT</span><span class="nv"> </span><span class="s">RO</span><span class="nv"> </span><span class="s">SK</span><span class="nv"> </span><span class="s">SI</span><span class="nv"> </span><span class="s">ES</span><span class="nv"> </span><span class="s">SE&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>阻止来自通常与某些网络威胁相关的国家/地区的访问：</p>
<div class="highlight"><pre><span></span><code><span class="nt">BLACKLIST_COUNTRY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;RU</span><span class="nv"> </span><span class="s">CN</span><span class="nv"> </span><span class="s">KP</span><span class="nv"> </span><span class="s">IR</span><span class="nv"> </span><span class="s">SY&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-crowdsec_1">CrowdSec</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<figure>
<p><img align="center," alt="概述" src="../assets/img/crowdsec.svg" width="600" /></p>
</figure>
<p>CrowdSec 插件将 BunkerWeb 与 CrowdSec 安全引擎集成，为抵御各种网络威胁提供额外的保护层。此插件充当 <a href="https://crowdsec.net/?utm_source=external-docs&amp;utm_medium=cta&amp;utm_campaign=bunker-web-docs">CrowdSec</a> 拦截器，根据 CrowdSec API 的决策拒绝请求。</p>
<p>CrowdSec 是一种现代的开源安全引擎，它基于行为分析和社区的集体情报来检测和阻止恶意 IP 地址。您还可以配置<a href="https://docs.crowdsec.net/docs/concepts?utm_source=external-docs&amp;utm_medium=cta&amp;utm_campaign=bunker-web-docs#scenarios">场景</a>来根据可疑行为自动封禁 IP 地址，从而受益于一个众包的黑名单。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>CrowdSec 引擎会分析日志并检测您基础设施上的可疑活动。</li>
<li>当检测到恶意活动时，CrowdSec 会创建一个决策来阻止违规的 IP 地址。</li>
<li>BunkerWeb 作为拦截器，会向 CrowdSec 本地 API 查询有关传入请求的决策。</li>
<li>如果客户端的 IP 地址有活动的阻止决策，BunkerWeb 会拒绝其访问受保护的服务。</li>
<li>可选地，应用程序安全组件可以执行深度请求检查以增强安全性。</li>
</ol>
<div class="admonition success">
<p class="admonition-title">主要优点</p>
<ol>
<li><strong>社区驱动的安全：</strong> 受益于整个 CrowdSec 用户社区共享的威胁情报。</li>
<li><strong>行为分析：</strong> 基于行为模式而不是签名来检测复杂的攻击。</li>
<li><strong>轻量级集成：</strong> 对您的 BunkerWeb 实例的性能影响最小。</li>
<li><strong>多层次保护：</strong> 结合边界防御（IP 阻止）和应用程序安全，实现深度保护。</li>
</ol>
</div>
<h3 id="zh-features-_41">设置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="15:3"><input checked="checked" id="zh-features-__tabbed_15_1" name="zh-features-__tabbed_15" type="radio" /><input id="zh-features-__tabbed_15_2" name="zh-features-__tabbed_15" type="radio" /><input id="zh-features-__tabbed_15_3" name="zh-features-__tabbed_15" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_15_1">Docker</label><label for="zh-features-__tabbed_15_2">Linux</label><label for="zh-features-__tabbed_15_3">All-in-one</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><strong>采集文件</strong></p>
<p>您需要运行一个 CrowdSec 实例，并将其配置为解析 BunkerWeb 日志。由于 BunkerWeb 基于 NGINX，您可以在采集文件中为 <code>type</code> 参数使用 <code>nginx</code> 值（假设 BunkerWeb 日志按原样存储，没有附加数据）：</p>
<div class="highlight"><pre><span></span><code><span class="nt">filenames</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log/bunkerweb.log</span>
<span class="nt">labels</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<p><strong>应用程序安全组件（<em>可选</em>）</strong></p>
<p>CrowdSec 还提供了一个<a href="https://docs.crowdsec.net/docs/appsec/intro?utm_source=external-docs&amp;utm_medium=cta&amp;utm_campaign=bunker-web-docs">应用程序安全组件</a>，可用于保护您的应用程序免受攻击。如果您想使用它，必须为 AppSec 组件创建另一个采集文件：</p>
<div class="highlight"><pre><span></span><code><span class="nt">appsec_config</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crowdsecurity/appsec-default</span>
<span class="nt">labels</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">appsec</span>
<span class="nt">listen_addr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0:7422</span>
<span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">appsec</span>
</code></pre></div>
<p><strong>Syslog</strong></p>
<p>对于基于容器的集成，我们建议将 BunkerWeb 容器的日志重定向到 syslog 服务，以便 CrowdSec 可以轻松访问它们。这是一个 syslog-ng 的示例配置，它会将来自 BunkerWeb 的原始日志存储到本地的 <code>/var/log/bunkerweb.log</code> 文件中：</p>
<div class="highlight"><pre><span></span><code>@version: 4.8

source s_net {
    udp(
        ip(&quot;0.0.0.0&quot;)
    );
};

template t_imp {
    template(&quot;$MSG\n&quot;);
    template_escape(no);
};

destination d_file {
    file(&quot;/var/log/bunkerweb.log&quot; template(t_imp));
};

log {
    source(s_net);
    destination(d_file);
};
</code></pre></div>
<p><strong>Docker Compose</strong></p>
<p>这是您可以使用的 docker-compose 样板（不要忘记更新 bouncer 密钥）：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-env</span>
<span class="w">  </span><span class="c1"># 我们使用一个锚点来避免在两个服务中重复相同的设置</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span><span class="w"> </span><span class="c1"># 确保设置正确的 IP 范围，以便调度器可以将配置发送到实例</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># 这是将用于在调度器中识别实例的名称</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w"> </span><span class="c1"># 用于 QUIC / HTTP3 支持</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span><span class="w"> </span><span class="c1"># 我们使用锚点来避免为所有服务重复相同的设置</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">logging</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syslog</span><span class="w"> </span><span class="c1"># 将日志发送到 syslog</span>
<span class="w">      </span><span class="nt">options</span><span class="p">:</span>
<span class="w">        </span><span class="nt">syslog-address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;udp://10.20.30.254:514&quot;</span><span class="w"> </span><span class="c1"># syslog 服务的 IP 地址</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span><span class="w"> </span><span class="c1"># 确保设置正确的实例名称</span>
<span class="w">      </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">USE_CROWDSEC</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">CROWDSEC_API</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://crowdsec:8080&quot;</span><span class="w"> </span><span class="c1"># 这是同一网络中 CrowdSec 容器 API 的地址</span>
<span class="w">      </span><span class="nt">CROWDSEC_APPSEC_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://crowdsec:7422&quot;</span><span class="w"> </span><span class="c1"># 如果您不想使用 AppSec 组件，请注释掉此行</span>
<span class="w">      </span><span class="nt">CROWDSEC_API_KEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;s3cr3tb0unc3rk3y&quot;</span><span class="w"> </span><span class="c1"># 记得为 bouncer 设置一个更强的密钥</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">crowdsec</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crowdsecurity/crowdsec:v1.7.0</span><span class="w"> </span><span class="c1"># 使用最新版本，但为了更好的稳定性和安全性，请始终固定版本</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cs-data:/var/lib/crowdsec/data</span><span class="w"> </span><span class="c1"># 持久化 CrowdSec 数据</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-logs:/var/log:ro</span><span class="w"> </span><span class="c1"># BunkerWeb 的日志，供 CrowdSec 解析</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./acquis.yaml:/etc/crowdsec/acquis.yaml</span><span class="w"> </span><span class="c1"># BunkerWeb 日志的采集文件</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./appsec.yaml:/etc/crowdsec/acquis.d/appsec.yaml</span><span class="w"> </span><span class="c1"># 如果您不想使用 AppSec 组件，请注释掉此行</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">BOUNCER_KEY_bunkerweb</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;s3cr3tb0unc3rk3y&quot;</span><span class="w"> </span><span class="c1"># 记得为 bouncer 设置一个更强的密钥</span>
<span class="w">      </span><span class="nt">COLLECTIONS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;crowdsecurity/nginx</span><span class="nv"> </span><span class="s">crowdsecurity/appsec-virtual-patching</span><span class="nv"> </span><span class="s">crowdsecurity/appsec-generic-rules&quot;</span>
<span class="w">      </span><span class="c1">#   COLLECTIONS: &quot;crowdsecurity/nginx&quot; # 如果您不想使用 AppSec 组件，请改用此行</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>

<span class="w">  </span><span class="nt">syslog</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">balabit/syslog-ng:4.9.0</span>
<span class="w">    </span><span class="nt">cap_add</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_BIND_SERVICE</span><span class="w">  </span><span class="c1"># 绑定到低端口</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_BROADCAST</span><span class="w">  </span><span class="c1"># 发送广播</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_RAW</span><span class="w">  </span><span class="c1"># 使用原始套接字</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DAC_READ_SEARCH</span><span class="w">  </span><span class="c1"># 绕过权限读取文件</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DAC_OVERRIDE</span><span class="w">  </span><span class="c1"># 覆盖文件权限</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CHOWN</span><span class="w">  </span><span class="c1"># 更改所有权</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SYSLOG</span><span class="w">  </span><span class="c1"># 写入系统日志</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-logs:/var/log/bunkerweb</span><span class="w"> </span><span class="c1"># 用于存储日志的卷</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./syslog-ng.conf:/etc/syslog-ng/syslog-ng.conf</span><span class="w"> </span><span class="c1"># syslog-ng 配置文件</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">        </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.254</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-logs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cs-data</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span><span class="w"> </span><span class="c1"># 确保设置正确的 IP 范围，以便调度器可以将配置发送到实例</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>您需要安装 CrowdSec 并将其配置为解析 BunkerWeb 日志。请按照<a href="https://doc.crowdsec.net/docs/getting_started/install_crowdsec?utm_source=external-docs&amp;utm_medium=cta&amp;utm_campaign=bunker-web-docs#scenarios">官方文档</a>进行操作。</p>
<p>要使 CrowdSec 能够解析 BunkerWeb 日志，请将以下行添加到位于 <code>/etc/crowdsec/acquis.yaml</code> 的采集文件中：</p>
<div class="highlight"><pre><span></span><code><span class="nt">filenames</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log/bunkerweb/access.log</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log/bunkerweb/error.log</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log/bunkerweb/modsec_audit.log</span>
<span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<p>现在，使用 <code>cscli</code> 工具将您的自定义 bouncer 添加到 CrowdSec API：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>cscli<span class="w"> </span>bouncers<span class="w"> </span>add<span class="w"> </span>crowdsec-bunkerweb-bouncer/v1.6
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">API 密钥</p>
<p>请保留 <code>cscli</code> 命令生成的密钥；稍后您将需要它。</p>
</div>
<p>然后重启 CrowdSec 服务：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>crowdsec
</code></pre></div>
<p><strong>应用程序安全组件（<em>可选</em>）</strong></p>
<p>如果您想使用 AppSec 组件，您必须为其创建一个位于 <code>/etc/crowdsec/acquis.d/appsec.yaml</code> 的另一个采集文件：</p>
<div class="highlight"><pre><span></span><code><span class="nt">appsec_config</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crowdsecurity/appsec-default</span>
<span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">appsec</span>
<span class="nt">listen_addr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1:7422</span>
<span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">appsec</span>
</code></pre></div>
<p>您还需要安装 AppSec 组件的集合：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>cscli<span class="w"> </span>collections<span class="w"> </span>install<span class="w"> </span>crowdsecurity/appsec-virtual-patching
sudo<span class="w"> </span>cscli<span class="w"> </span>collections<span class="w"> </span>install<span class="w"> </span>crowdsecurity/appsec-generic-rules
</code></pre></div>
<p>最后，重启 CrowdSec 服务：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>crowdsec
</code></pre></div>
<p><strong>设置</strong></p>
<p>通过将以下设置添加到您的 BunkerWeb 配置文件来配置插件：</p>
<div class="highlight"><pre><span></span><code>USE_CROWDSEC=yes
CROWDSEC_API=http://127.0.0.1:8080
CROWDSEC_API_KEY=&lt;The key provided by cscli&gt;
# 如果您不想使用 AppSec 组件，请注释掉
CROWDSEC_APPSEC_URL=http://127.0.0.1:7422
</code></pre></div>
<p>最后，重新加载 BunkerWeb 服务：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>bunkerweb
</code></pre></div>
</div>
<div class="tabbed-block">
<p>BunkerWeb All-In-One (AIO) Docker 镜像完全集成了 CrowdSec。当使用内部 CrowdSec 代理时，您无需为 BunkerWeb 日志设置单独的 CrowdSec 实例或手动配置文件。</p>
<p>请参阅<a href="#zh-integrations-crowdsec-integration">一体化 (AIO) 镜像集成文档</a>。</p>
</div>
</div>
</div>
<h3 id="zh-features-_42">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_CROWDSEC</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用 CrowdSec：</strong> 设置为 <code>yes</code> 以启用 CrowdSec 拦截器。</td>
</tr>
<tr>
<td><code>CROWDSEC_API</code></td>
<td><code>http://crowdsec:8080</code></td>
<td>global</td>
<td>否</td>
<td><strong>CrowdSec API URL：</strong> CrowdSec 本地 API 服务的地址。</td>
</tr>
<tr>
<td><code>CROWDSEC_API_KEY</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>CrowdSec API 密钥：</strong> 用于向 CrowdSec API 进行身份验证的 API 密钥，使用 <code>cscli bouncers add</code> 获取。</td>
</tr>
<tr>
<td><code>CROWDSEC_MODE</code></td>
<td><code>live</code></td>
<td>global</td>
<td>否</td>
<td><strong>操作模式：</strong> <code>live</code>（为每个请求查询 API）或 <code>stream</code>（定期缓存所有决策）。</td>
</tr>
<tr>
<td><code>CROWDSEC_ENABLE_INTERNAL</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>内部流量：</strong> 设置为 <code>yes</code> 以根据 CrowdSec 决策检查内部流量。</td>
</tr>
<tr>
<td><code>CROWDSEC_REQUEST_TIMEOUT</code></td>
<td><code>1000</code></td>
<td>global</td>
<td>否</td>
<td><strong>请求超时：</strong> 在实时模式下向 CrowdSec 本地 API 发出 HTTP 请求的超时时间（以毫秒为单位）。</td>
</tr>
<tr>
<td><code>CROWDSEC_EXCLUDE_LOCATION</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>排除的位置：</strong> 从 CrowdSec 检查中排除的位置（URI）列表，以逗号分隔。</td>
</tr>
<tr>
<td><code>CROWDSEC_CACHE_EXPIRATION</code></td>
<td><code>1</code></td>
<td>global</td>
<td>否</td>
<td><strong>缓存过期时间：</strong> 在实时模式下，IP 决策的缓存过期时间（以秒为单位）。</td>
</tr>
<tr>
<td><code>CROWDSEC_UPDATE_FREQUENCY</code></td>
<td><code>10</code></td>
<td>global</td>
<td>否</td>
<td><strong>更新频率：</strong> 在流模式下，从 CrowdSec API 拉取新的/过期的决策的频率（以秒为单位）。</td>
</tr>
</tbody>
</table>
<h4 id="zh-features-_43">应用程序安全组件设置</h4>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CROWDSEC_APPSEC_URL</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>AppSec URL：</strong> CrowdSec 应用程序安全组件的 URL。留空以禁用 AppSec。</td>
</tr>
<tr>
<td><code>CROWDSEC_APPSEC_FAILURE_ACTION</code></td>
<td><code>passthrough</code></td>
<td>global</td>
<td>否</td>
<td><strong>失败操作：</strong> 当 AppSec 返回错误时要采取的操作。可以是 <code>passthrough</code> 或 <code>deny</code>。</td>
</tr>
<tr>
<td><code>CROWDSEC_APPSEC_CONNECT_TIMEOUT</code></td>
<td><code>100</code></td>
<td>global</td>
<td>否</td>
<td><strong>连接超时：</strong> 连接到 AppSec 组件的超时时间（以毫秒为单位）。</td>
</tr>
<tr>
<td><code>CROWDSEC_APPSEC_SEND_TIMEOUT</code></td>
<td><code>100</code></td>
<td>global</td>
<td>否</td>
<td><strong>发送超时：</strong> 向 AppSec 组件发送数据的超时时间（以毫秒为单位）。</td>
</tr>
<tr>
<td><code>CROWDSEC_APPSEC_PROCESS_TIMEOUT</code></td>
<td><code>500</code></td>
<td>global</td>
<td>否</td>
<td><strong>处理超时：</strong> 在 AppSec 组件中处理请求的超时时间（以毫秒为单位）。</td>
</tr>
<tr>
<td><code>CROWDSEC_ALWAYS_SEND_TO_APPSEC</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>始终发送：</strong> 设置为 <code>yes</code> 以始终将请求发送到 AppSec，即使存在 IP 级别的决策。</td>
</tr>
<tr>
<td><code>CROWDSEC_APPSEC_SSL_VERIFY</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>SSL 验证：</strong> 设置为 <code>yes</code> 以验证 AppSec 组件的 SSL 证书。</td>
</tr>
</tbody>
</table>
<div class="admonition info">
<p class="admonition-title">关于操作模式</p>
<ul>
<li><strong>实时模式</strong>会为每个传入的请求查询 CrowdSec API，提供实时的保护，但会增加延迟。</li>
<li><strong>流模式</strong>会定期从 CrowdSec API 下载所有决策并将其本地缓存，从而减少延迟，但应用新决策会略有延迟。</li>
</ul>
</div>
<h3 id="zh-features-_44">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="16:2"><input checked="checked" id="zh-features-__tabbed_16_1" name="zh-features-__tabbed_16" type="radio" /><input id="zh-features-__tabbed_16_2" name="zh-features-__tabbed_16" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_16_1">基本配置</label><label for="zh-features-__tabbed_16_2">带有 AppSec 的高级配置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>这是一个当 CrowdSec 在同一台主机上运行时的一个简单配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CROWDSEC</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CROWDSEC_API</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://crowdsec:8080&quot;</span>
<span class="nt">CROWDSEC_API_KEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-api-key-here&quot;</span>
<span class="nt">CROWDSEC_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;live&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个更全面的配置，包括应用程序安全组件：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CROWDSEC</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CROWDSEC_API</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://crowdsec:8080&quot;</span>
<span class="nt">CROWDSEC_API_KEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-api-key-here&quot;</span>
<span class="nt">CROWDSEC_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;stream&quot;</span>
<span class="nt">CROWDSEC_UPDATE_FREQUENCY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30&quot;</span>
<span class="nt">CROWDSEC_EXCLUDE_LOCATION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/health,/metrics&quot;</span>

<span class="c1"># AppSec 配置</span>
<span class="nt">CROWDSEC_APPSEC_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://crowdsec:7422&quot;</span>
<span class="nt">CROWDSEC_APPSEC_FAILURE_ACTION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;deny&quot;</span>
<span class="nt">CROWDSEC_ALWAYS_SEND_TO_APPSEC</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CROWDSEC_APPSEC_SSL_VERIFY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-custom-ssl-certificate">Custom SSL certificate</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>自定义 SSL 证书插件允许您在 BunkerWeb 中使用您自己的 SSL/TLS 证书，而不是自动生成的证书。如果您拥有来自受信任的证书颁发机构 (CA) 的现有证书、需要使用具有特定配置的证书，或者希望在整个基础设施中保持一致的证书管理，此功能特别有用。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>您通过指定文件路径或以 base64 编码或纯文本 PEM 格式提供数据的方式，向 BunkerWeb 提供您的证书和私钥文件。</li>
<li>BunkerWeb 会验证您的证书和密钥，以确保它们的格式正确且可用。</li>
<li>建立安全连接时，BunkerWeb 会提供您的自定义证书，而不是自动生成的证书。</li>
<li>BunkerWeb 会自动监控您的证书的有效性，并在其即将到期时显示警告。</li>
<li>您可以完全控制证书管理，允许您使用来自您偏好的任何颁发机构的证书。</li>
</ol>
<div class="admonition info">
<p class="admonition-title">自动证书监控</p>
<p>当您通过将 <code>USE_CUSTOM_SSL</code> 设置为 <code>yes</code> 来启用自定义 SSL/TLS 时，BunkerWeb 会自动监控 <code>CUSTOM_SSL_CERT</code> 中指定的自定义证书。它会每天检查更改，并在检测到任何修改时重新加载 NGINX，确保始终使用最新的证书。</p>
</div>
<h3 id="zh-features-_45">如何使用</h3>
<p>请按照以下步骤配置和使用自定义 SSL 证书功能：</p>
<ol>
<li><strong>启用该功能：</strong> 将 <code>USE_CUSTOM_SSL</code> 设置为 <code>yes</code> 以启用自定义证书支持。</li>
<li><strong>选择一种方法：</strong> 决定是通过文件路径还是以 base64 编码/纯文本数据提供证书，并使用 <code>CUSTOM_SSL_CERT_PRIORITY</code> 设置优先级。</li>
<li><strong>提供证书文件：</strong> 如果使用文件路径，请指定您的证书和私钥文件的位置。</li>
<li><strong>或者提供证书数据：</strong> 如果使用数据，请以 base64 编码的字符串或纯文本 PEM 格式提供您的证书和密钥。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 配置完成后，BunkerWeb 会自动将您的自定义证书用于所有 HTTPS 连接。</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">流模式配置</p>
<p>对于流模式，您必须配置 <code>LISTEN_STREAM_PORT_SSL</code> 设置以指定 SSL/TLS 监听端口。此步骤对于在流模式下正常运行至关重要。</p>
</div>
<h3 id="zh-features-_46">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_CUSTOM_SSL</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用自定义 SSL：</strong> 设置为 <code>yes</code> 以使用您自己的证书而不是自动生成的证书。</td>
</tr>
<tr>
<td><code>CUSTOM_SSL_CERT_PRIORITY</code></td>
<td><code>file</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>证书优先级：</strong> 选择优先使用文件路径中的证书还是 base64 数据中的证书（<code>file</code> 或 <code>data</code>）。</td>
</tr>
<tr>
<td><code>CUSTOM_SSL_CERT</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>证书路径：</strong> 您的 SSL 证书或证书捆绑包文件的完整路径。</td>
</tr>
<tr>
<td><code>CUSTOM_SSL_KEY</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>私钥路径：</strong> 您的 SSL 私钥文件的完整路径。</td>
</tr>
<tr>
<td><code>CUSTOM_SSL_CERT_DATA</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>证书数据：</strong> 以 base64 格式编码或以纯文本 PEM 格式表示的您的证书。</td>
</tr>
<tr>
<td><code>CUSTOM_SSL_KEY_DATA</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>私钥数据：</strong> 以 base64 格式编码或以纯文本 PEM 格式表示的您的私钥。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">安全注意事项</p>
<p>使用自定义证书时，请确保您的私钥得到妥善保护并具有适当的权限。文件必须可由 BunkerWeb 调度器读取。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">证书格式</p>
<p>BunkerWeb 需要 PEM 格式的证书。如果您的证书是其他格式，您可能需要先进行转换。</p>
</div>
<div class="admonition info">
<p class="admonition-title">证书链</p>
<p>如果您的证书包含一个链（中间证书），您应该按正确的顺序提供完整的证书链，首先是您的证书，然后是任何中间证书。</p>
</div>
<h3 id="zh-features-_47">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="17:4"><input checked="checked" id="zh-features-__tabbed_17_1" name="zh-features-__tabbed_17" type="radio" /><input id="zh-features-__tabbed_17_2" name="zh-features-__tabbed_17" type="radio" /><input id="zh-features-__tabbed_17_3" name="zh-features-__tabbed_17" type="radio" /><input id="zh-features-__tabbed_17_4" name="zh-features-__tabbed_17" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_17_1">使用文件路径</label><label for="zh-features-__tabbed_17_2">使用 Base64 数据</label><label for="zh-features-__tabbed_17_3">使用纯文本 PEM 数据</label><label for="zh-features-__tabbed_17_4">回退配置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个使用磁盘上的证书和密钥文件的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CUSTOM_SSL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CUSTOM_SSL_CERT_PRIORITY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file&quot;</span>
<span class="nt">CUSTOM_SSL_CERT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/path/to/your/certificate.pem&quot;</span>
<span class="nt">CUSTOM_SSL_KEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/path/to/your/private-key.pem&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个使用 base64 编码的证书和密钥数据的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CUSTOM_SSL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CUSTOM_SSL_CERT_PRIORITY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;data&quot;</span>
<span class="nt">CUSTOM_SSL_CERT_DATA</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR...base64</span><span class="nv"> </span><span class="s">encoded</span><span class="nv"> </span><span class="s">certificate...Cg==&quot;</span>
<span class="nt">CUSTOM_SSL_KEY_DATA</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSEV...base64</span><span class="nv"> </span><span class="s">encoded</span><span class="nv"> </span><span class="s">key...Cg==&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个使用 PEM 格式的纯文本证书和密钥数据的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CUSTOM_SSL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CUSTOM_SSL_CERT_PRIORITY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;data&quot;</span>
<span class="nt">CUSTOM_SSL_CERT_DATA</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">  </span><span class="no">-----BEGIN CERTIFICATE-----</span>
<span class="w">  </span><span class="no">MIIDdzCCAl+gAwIBAgIUJH...certificate content...AAAA</span>
<span class="w">  </span><span class="no">-----END CERTIFICATE-----</span>
<span class="nt">CUSTOM_SSL_KEY_DATA</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">  </span><span class="no">-----BEGIN PRIVATE KEY-----</span>
<span class="w">  </span><span class="no">MIIEvQIBADAN...key content...AAAA</span>
<span class="w">  </span><span class="no">-----END PRIVATE KEY-----</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个优先使用文件，但如果文件不可用则回退到 base64 数据的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_CUSTOM_SSL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">CUSTOM_SSL_CERT_PRIORITY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file&quot;</span>
<span class="nt">CUSTOM_SSL_CERT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/path/to/your/certificate.pem&quot;</span>
<span class="nt">CUSTOM_SSL_KEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/path/to/your/private-key.pem&quot;</span>
<span class="nt">CUSTOM_SSL_CERT_DATA</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR...base64</span><span class="nv"> </span><span class="s">encoded</span><span class="nv"> </span><span class="s">certificate...Cg==&quot;</span>
<span class="nt">CUSTOM_SSL_KEY_DATA</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSEV...base64</span><span class="nv"> </span><span class="s">encoded</span><span class="nv"> </span><span class="s">key...Cg==&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-dnsbl">DNSBL</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>DNSBL（域名系统黑名单）插件通过对照外部 DNSBL 服务器检查客户端 IP 地址，为您的网站提供针对已知恶意 IP 地址的保护。此功能通过利用社区维护的有问题的 IP 地址列表，帮助保护您的网站免受垃圾邮件、僵尸网络和各种类型的网络威胁。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当客户端连接到您的网站时，BunkerWeb 会使用 DNS 协议查询您选择的 DNSBL 服务器。</li>
<li>通过向每个 DNSBL 服务器发送带有客户端 IP 地址的反向 DNS 查询来执行检查。</li>
<li>如果任何 DNSBL 服务器确认客户端的 IP 地址被列为恶意，BunkerWeb 将自动封禁该客户端，防止潜在威胁到达您的应用程序。</li>
<li>结果会被缓存，以提高来自同一 IP 地址的重复访问者的性能。</li>
<li>使用异步查询高效地执行查找，以最大限度地减少对页面加载时间的影响。</li>
</ol>
<h3 id="zh-features-_48">如何使用</h3>
<p>请按照以下步骤配置和使用 DNSBL 功能：</p>
<ol>
<li><strong>启用该功能：</strong> DNSBL 功能默认禁用。将 <code>USE_DNSBL</code> 设置为 <code>yes</code> 以启用它。</li>
<li><strong>配置 DNSBL 服务器：</strong> 将您要使用的 DNSBL 服务的域名添加到 <code>DNSBL_LIST</code> 设置中。</li>
<li><strong>应用设置：</strong> 配置完成后，BunkerWeb 将自动对照指定的 DNSBL 服务器检查传入的连接。</li>
<li><strong>监控有效性：</strong> 查看 <a href="#zh-web-ui">web UI</a> 以查看因 DNSBL 检查而被阻止的请求的统计信息。</li>
</ol>
<h3 id="zh-features-_49">配置设置</h3>
<p><strong>通用</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_DNSBL</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td>启用 DNSBL：设置为 <code>yes</code> 以启用对传入连接的 DNSBL 检查。</td>
</tr>
<tr>
<td><code>DNSBL_LIST</code></td>
<td><code>bl.blocklist.de sbl.spamhaus.org xbl.spamhaus.org</code></td>
<td>global</td>
<td>否</td>
<td>DNSBL 服务器：要检查的 DNSBL 服务器域名列表，以空格分隔。</td>
</tr>
</tbody>
</table>
<p><strong>忽略列表</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DNSBL_IGNORE_IP</code></td>
<td>``</td>
<td>multisite</td>
<td>是</td>
<td>以空格分隔的 IP/CIDR，用于跳过 DNSBL 检查（白名单）。</td>
</tr>
<tr>
<td><code>DNSBL_IGNORE_IP_URLS</code></td>
<td>``</td>
<td>multisite</td>
<td>是</td>
<td>以空格分隔的 URL，提供要跳过的 IP/CIDR。支持 <code>http(s)://</code> 和 <code>file://</code> 方案。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">选择 DNSBL 服务器</p>
<p>选择信誉良好的 DNSBL 提供商以最大限度地减少误报。默认列表包括适合大多数网站的成熟服务：</p>
<ul>
<li><strong>bl.blocklist.de：</strong> 列出被检测到攻击其他服务器的 IP。</li>
<li><strong>sbl.spamhaus.org：</strong> 专注于垃圾邮件源和其他恶意活动。</li>
<li><strong>xbl.spamhaus.org：</strong> 针对受感染的系统，例如被入侵的机器或开放代理。</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">DNSBL 的工作原理</p>
<p>DNSBL 服务器通过响应特殊格式的 DNS 查询来工作。当 BunkerWeb 检查一个 IP 地址时，它会反转该 IP 并附加 DNSBL 域名。如果生成的 DNS 查询返回“成功”响应，则该 IP 被视为已列入黑名单。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">性能考虑</p>
<p>虽然 BunkerWeb 优化了 DNSBL 查找的性能，但添加大量 DNSBL 服务器可能会影响响应时间。从几个信誉良好的 DNSBL 服务器开始，并在添加更多服务器之前监控性能。</p>
</div>
<h3 id="zh-features-_50">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="18:5"><input checked="checked" id="zh-features-__tabbed_18_1" name="zh-features-__tabbed_18" type="radio" /><input id="zh-features-__tabbed_18_2" name="zh-features-__tabbed_18" type="radio" /><input id="zh-features-__tabbed_18_3" name="zh-features-__tabbed_18" type="radio" /><input id="zh-features-__tabbed_18_4" name="zh-features-__tabbed_18" type="radio" /><input id="zh-features-__tabbed_18_5" name="zh-features-__tabbed_18" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_18_1">基本配置</label><label for="zh-features-__tabbed_18_2">最小配置</label><label for="zh-features-__tabbed_18_3">排除受信任的 IP</label><label for="zh-features-__tabbed_18_4">使用远程 URL</label><label for="zh-features-__tabbed_18_5">使用本地文件</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个使用默认 DNSBL 服务器的简单配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_DNSBL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">DNSBL_LIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bl.blocklist.de</span><span class="nv"> </span><span class="s">sbl.spamhaus.org</span><span class="nv"> </span><span class="s">xbl.spamhaus.org&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个专注于最可靠的 DNSBL 服务的最小配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_DNSBL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">DNSBL_LIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;zen.spamhaus.org&quot;</span>
</code></pre></div>
<p>此配置仅使用：</p>
<ul>
<li><strong>zen.spamhaus.org</strong>：Spamhaus 的组合列表通常被认为是独立的解决方案，因为它覆盖范围广，准确性高。它在一个查询中结合了 SBL、XBL 和 PBL 列表，使其高效而全面。</li>
</ul>
</div>
<div class="tabbed-block">
<p>您可以使用静态值和/或远程文件从 DNSBL 检查中排除特定的客户端：</p>
<ul>
<li><code>DNSBL_IGNORE_IP</code>：添加以空格分隔的 IP 和 CIDR 范围。示例：<code>192.0.2.10 203.0.113.0/24 2001:db8::/32</code>。</li>
<li><code>DNSBL_IGNORE_IP_URLS</code>：提供 URL，其内容每行列出一个 IP/CIDR。以 <code>#</code> 或 <code>;</code> 开头的注释将被忽略。重复的条目将被去重。</li>
</ul>
<p>当传入的客户端 IP 匹配忽略列表时，BunkerWeb 会跳过 DNSBL 查找并将结果缓存为“ok”，以便后续请求更快。</p>
</div>
<div class="tabbed-block">
<p><code>dnsbl-download</code> 作业每小时下载并缓存忽略的 IP：</p>
<ul>
<li>协议：<code>https://</code>、<code>http://</code> 和本地 <code>file://</code> 路径。</li>
<li>带校验和的每个 URL 缓存可防止冗余下载（1 小时宽限期）。</li>
<li>每个服务的合并文件：<code>/var/cache/bunkerweb/dnsbl/&lt;service&gt;/IGNORE_IP.list</code>。</li>
<li>在启动时加载并与 <code>DNSBL_IGNORE_IP</code> 合并。</li>
</ul>
<p>结合静态和 URL 源的示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_DNSBL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">DNSBL_LIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;zen.spamhaus.org&quot;</span>
<span class="nt">DNSBL_IGNORE_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.0.0.0/8</span><span class="nv"> </span><span class="s">192.168.0.0/16</span><span class="nv"> </span><span class="s">2001:db8::/32&quot;</span>
<span class="nt">DNSBL_IGNORE_IP_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/allow-cidrs.txt</span><span class="nv"> </span><span class="s">file:///etc/bunkerweb/dnsbl/ignore.txt&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用 <code>file://</code> URL 从本地文件加载忽略的 IP：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_DNSBL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">DNSBL_LIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;zen.spamhaus.org&quot;</span>
<span class="nt">DNSBL_IGNORE_IP_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///etc/bunkerweb/dnsbl/ignore.txt</span><span class="nv"> </span><span class="s">file:///opt/data/allow-cidrs.txt&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-database">Database</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>数据库插件通过启用配置数据、日志和其他基本信息的集中存储和管理，为 BunkerWeb 提供了强大的数据库集成。</p>
<p>这个核心组件支持多种数据库引擎，包括 SQLite、PostgreSQL、MySQL/MariaDB 和 Oracle，让您可以选择最适合您的环境和需求的数据库解决方案。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>BunkerWeb 使用 SQLAlchemy 格式提供的 URI 连接到您配置的数据库。</li>
<li>关键配置数据、运行时信息和作业日志都安全地存储在数据库中。</li>
<li>自动维护流程通过管理数据增长和清理多余记录来优化您的数据库。</li>
<li>对于高可用性场景，您可以配置一个只读数据库 URI，它既可以作为故障转移，也可以作为分流读取操作的方法。</li>
<li>数据库操作会根据您指定的日志级别进行记录，为数据库交互提供适当的可见性。</li>
</ol>
<h3 id="zh-features-_51">如何使用</h3>
<p>请按照以下步骤配置和使用数据库功能：</p>
<ol>
<li><strong>选择一个数据库引擎：</strong> 根据您的需求，从 SQLite（默认）、PostgreSQL、MySQL/MariaDB 或 Oracle 中选择。</li>
<li><strong>配置数据库 URI：</strong> 使用 SQLAlchemy 格式设置 <code>DATABASE_URI</code> 以连接到您的主数据库。</li>
<li><strong>可选的只读数据库：</strong> 对于高可用性设置，配置一个 <code>DATABASE_URI_READONLY</code> 作为后备或用于读取操作。</li>
</ol>
<h3 id="zh-features-_52">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DATABASE_URI</code></td>
<td><code>sqlite:////var/lib/bunkerweb/db.sqlite3</code></td>
<td>global</td>
<td>否</td>
<td><strong>数据库 URI：</strong> SQLAlchemy 格式的主数据库连接字符串。</td>
</tr>
<tr>
<td><code>DATABASE_URI_READONLY</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>只读数据库 URI：</strong> 用于只读操作或在主数据库宕机时作为故障转移的可选数据库。</td>
</tr>
<tr>
<td><code>DATABASE_LOG_LEVEL</code></td>
<td><code>warning</code></td>
<td>global</td>
<td>否</td>
<td><strong>日志级别：</strong> 数据库日志的详细程度。选项：<code>debug</code>、<code>info</code>、<code>warn</code>、<code>warning</code> 或 <code>error</code>。</td>
</tr>
<tr>
<td><code>DATABASE_MAX_JOBS_RUNS</code></td>
<td><code>10000</code></td>
<td>global</td>
<td>否</td>
<td><strong>最大作业运行次数：</strong> 在自动清理之前，数据库中保留的作业执行记录的最大数量。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">数据库选择</p>
<ul>
<li><strong>SQLite</strong>（默认）：由于其简单和基于文件的特性，非常适合单节点部署或测试环境。</li>
<li><strong>PostgreSQL</strong>：由于其健壮性和并发支持，推荐用于具有多个 BunkerWeb 实例的生产环境。</li>
<li><strong>MySQL/MariaDB</strong>：是 PostgreSQL 的一个很好的替代品，具有类似的生产级功能。</li>
<li><strong>Oracle</strong>：适用于 Oracle 已经是标准数据库平台的企业环境。</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">SQLAlchemy URI 格式</p>
<p>数据库 URI 遵循 SQLAlchemy 格式：</p>
<ul>
<li>SQLite: <code>sqlite:////path/to/database.sqlite3</code></li>
<li>PostgreSQL: <code>postgresql://username:password@hostname:port/database</code></li>
<li>MySQL/MariaDB: <code>mysql://username:password@hostname:port/database</code> 或 <code>mariadb://username:password@hostname:port/database</code></li>
<li>Oracle: <code>oracle://username:password@hostname:port/database</code></li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">数据库维护</p>
<p>该插件会自动运行一个每日作业，根据 <code>DATABASE_MAX_JOBS_RUNS</code> 设置清理多余的作业运行记录。这可以防止数据库无限增长，同时保留有用的作业执行历史记录。</p>
</div>
<h2 id="zh-features-easy-resolve-pro">Easy Resolve <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style='transform : translateY(3px);'> (PRO)</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>Provides a simpler way to fix false positives in reports.</p>
<h2 id="zh-features-errors">Errors</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>错误插件为您的网站提供了可定制的错误处理，让您可以配置 HTTP 错误响应如何向用户显示。此功能通过呈现用户友好、带有品牌标识的错误页面，在错误场景中增强了用户体验，而不是显示默认的服务器错误页面，后者对访问者来说可能显得技术性且令人困惑。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当客户端遇到 HTTP 错误（例如，400、404 或 500）时，BunkerWeb 会拦截错误响应。</li>
<li>BunkerWeb 会显示一个自定义的、专业设计的错误页面，而不是显示默认的错误页面。</li>
<li>错误页面可以通过您的配置完全定制，允许您为特定的错误代码指定自定义页面。<strong>自定义错误页面文件必须放置在由 <code>ROOT_FOLDER</code> 设置定义的目录中（请参阅杂项插件文档）。</strong><ul>
<li>默认情况下，<code>ROOT_FOLDER</code> 是 <code>/var/www/html/{server_name}</code>（其中 <code>{server_name}</code> 会被实际的服务器名称替换）。</li>
<li>在多站点模式下，每个站点都可以有自己的 <code>ROOT_FOLDER</code>，因此自定义错误页面必须放置在每个站点的相应目录中。</li>
</ul>
</li>
<li>默认的错误页面提供了清晰的解释，帮助用户了解出了什么问题以及他们接下来可以做什么。</li>
</ol>
<h3 id="zh-features-_53">如何使用</h3>
<p>请按照以下步骤配置和使用错误功能：</p>
<ol>
<li><strong>定义自定义错误页面：</strong> 使用 <code>ERRORS</code> 设置指定哪些 HTTP 错误代码应使用自定义错误页面。自定义错误页面文件必须位于为该站点指定的 <code>ROOT_FOLDER</code> 设置的文件夹中。在多站点模式下，这意味着每个站点/服务器都可以有自己的自定义错误页面文件夹。</li>
<li><strong>配置您的错误页面：</strong> 对于每个错误代码，您可以使用默认的 BunkerWeb 错误页面或提供您自己的自定义 HTML 页面（放置在相应的 <code>ROOT_FOLDER</code> 中）。</li>
<li><strong>设置拦截的错误代码：</strong> 使用 <code>INTERCEPTED_ERROR_CODES</code> 设置选择哪些错误代码应始终由 BunkerWeb 处理。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 配置完成后，错误处理会自动对所有指定的错误代码进行。</li>
</ol>
<h3 id="zh-features-_54">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ERRORS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>自定义错误页面：</strong> 使用 <code>ERROR_CODE=/path/to/file.html</code> 的格式将特定的错误代码映射到自定义 HTML 文件。</td>
</tr>
<tr>
<td><code>INTERCEPTED_ERROR_CODES</code></td>
<td><code>400 401 403 404 405 413 429 500 501 502 503 504</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>拦截的错误：</strong> 当未指定自定义页面时，BunkerWeb 应使用其默认错误页面处理的 HTTP 错误代码列表。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">错误页面设计</p>
<p>默认的 BunkerWeb 错误页面旨在提供信息、用户友好且外观专业。它们包括：</p>
<ul>
<li>清晰的错误描述</li>
<li>关于可能导致错误原因的信息</li>
<li>建议用户解决问题的操作</li>
<li>帮助用户了解问题是出在客户端还是服务器端的视觉指示器</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">错误类型</p>
<p>错误代码按类型分类：</p>
<ul>
<li><strong>4xx 错误（客户端）：</strong> 这些表示客户端请求存在问题，例如试图访问不存在的页面或缺少适当的身份验证。</li>
<li><strong>5xx 错误（服务器端）：</strong> 这些表示服务器无法满足有效请求，例如内部服务器错误或暂时不可用。</li>
</ul>
</div>
<h3 id="zh-features-_55">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="19:3"><input checked="checked" id="zh-features-__tabbed_19_1" name="zh-features-__tabbed_19" type="radio" /><input id="zh-features-__tabbed_19_2" name="zh-features-__tabbed_19" type="radio" /><input id="zh-features-__tabbed_19_3" name="zh-features-__tabbed_19" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_19_1">默认错误处理</label><label for="zh-features-__tabbed_19_2">自定义错误页面</label><label for="zh-features-__tabbed_19_3">选择性错误处理</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>让 BunkerWeb 使用其默认的错误页面处理常见的错误代码：</p>
<div class="highlight"><pre><span></span><code><span class="nt">INTERCEPTED_ERROR_CODES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;400</span><span class="nv"> </span><span class="s">401</span><span class="nv"> </span><span class="s">403</span><span class="nv"> </span><span class="s">404</span><span class="nv"> </span><span class="s">405</span><span class="nv"> </span><span class="s">413</span><span class="nv"> </span><span class="s">429</span><span class="nv"> </span><span class="s">500</span><span class="nv"> </span><span class="s">501</span><span class="nv"> </span><span class="s">502</span><span class="nv"> </span><span class="s">503</span><span class="nv"> </span><span class="s">504&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>为特定的错误代码使用自定义错误页面：</p>
<div class="highlight"><pre><span></span><code><span class="nt">ERRORS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;404=/custom/404.html</span><span class="nv"> </span><span class="s">500=/custom/500.html&quot;</span>
<span class="nt">INTERCEPTED_ERROR_CODES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;400</span><span class="nv"> </span><span class="s">401</span><span class="nv"> </span><span class="s">403</span><span class="nv"> </span><span class="s">404</span><span class="nv"> </span><span class="s">405</span><span class="nv"> </span><span class="s">413</span><span class="nv"> </span><span class="s">429</span><span class="nv"> </span><span class="s">500</span><span class="nv"> </span><span class="s">501</span><span class="nv"> </span><span class="s">502</span><span class="nv"> </span><span class="s">503</span><span class="nv"> </span><span class="s">504&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>仅使用 BunkerWeb 处理特定的错误代码：</p>
<div class="highlight"><pre><span></span><code><span class="nt">INTERCEPTED_ERROR_CODES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;404</span><span class="nv"> </span><span class="s">500&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-greylist">Greylist</h2>
<p>STREAM 支持 <img alt="⚠" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/26a0.svg" title=":warning:" /></p>
<p>Greylist 插件提供了一种灵活的安全方法，允许访问者访问，同时仍然保持必要的安全功能。</p>
<p>与传统的<a href="#zh-features-blacklist">黑名单</a>/<a href="#zh-features-whitelist">白名单</a>方法——完全阻止或允许访问——不同，灰名单通过授予某些访问者访问权限，同时仍然对他们进行安全检查，创造了一个中间地带。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>您定义了要被列入灰名单的访问者的标准（<em>IP 地址、网络、rDNS、ASN、用户代理或 URI 模式</em>）。</li>
<li>当访问者匹配这些标准中的任何一个时，他们将被授予访问您网站的权限，而其他安全功能仍然有效。</li>
<li>如果访问者不匹配任何灰名单标准，他们的访问将被拒绝。</li>
<li>灰名单数据可以定期从外部来源自动更新。</li>
</ol>
<h3 id="zh-features-_56">如何使用</h3>
<p>请按照以下步骤配置和使用灰名单功能：</p>
<ol>
<li><strong>启用该功能：</strong> 灰名单功能默认禁用。将 <code>USE_GREYLIST</code> 设置为 <code>yes</code> 以启用它。</li>
<li><strong>配置灰名单规则：</strong> 定义哪些 IP、网络、rDNS 模式、ASN、用户代理或 URI 应被列入灰名单。</li>
<li><strong>添加外部源：</strong> 可选地，配置用于自动下载和更新灰名单数据的 URL。</li>
<li><strong>监控访问：</strong> 查看 <a href="#zh-web-ui">web UI</a> 以查看哪些访问者被允许或拒绝。</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">访问控制行为</p>
<p>当使用 <code>USE_GREYLIST</code> 设置为 <code>yes</code> 启用灰名单功能时：</p>
<ol>
<li><strong>灰名单中的访问者：</strong> 允许访问，但仍会受到所有安全检查。</li>
<li><strong>非灰名单中的访问者：</strong> 完全拒绝访问。</li>
</ol>
</div>
<div class="admonition info">
<p class="admonition-title">流模式</p>
<p>当使用流模式时，只会执行 IP、rDNS 和 ASN 检查。</p>
</div>
<h3 id="zh-features-_57">配置设置</h3>
<p><strong>通用</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_GREYLIST</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用灰名单：</strong> 设置为 <code>yes</code> 以启用灰名单。</td>
</tr>
</tbody>
</table>
<div class="tabbed-set tabbed-alternate" data-tabs="20:5"><input checked="checked" id="zh-features-__tabbed_20_1" name="zh-features-__tabbed_20" type="radio" /><input id="zh-features-__tabbed_20_2" name="zh-features-__tabbed_20" type="radio" /><input id="zh-features-__tabbed_20_3" name="zh-features-__tabbed_20" type="radio" /><input id="zh-features-__tabbed_20_4" name="zh-features-__tabbed_20" type="radio" /><input id="zh-features-__tabbed_20_5" name="zh-features-__tabbed_20" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_20_1">IP 地址</label><label for="zh-features-__tabbed_20_2">反向 DNS</label><label for="zh-features-__tabbed_20_3">ASN</label><label for="zh-features-__tabbed_20_4">用户代理</label><label for="zh-features-__tabbed_20_5">URI</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><strong>这是做什么的：</strong> 根据访问者的 IP 地址或网络将访问者列入灰名单。这些访问者可以获得访问权限，但仍会受到安全检查。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GREYLIST_IP</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>IP 灰名单：</strong> 要列入灰名单的 IP 地址或网络（CIDR 表示法）列表，以空格分隔。</td>
</tr>
<tr>
<td><code>GREYLIST_IP_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>IP 灰名单 URL：</strong> 包含要列入灰名单的 IP 地址或网络的 URL 列表，以空格分隔。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<p><strong>这是做什么的：</strong> 根据访问者的域名（反向）将访问者列入灰名单。对于允许来自特定组织或网络的访问者有条件地访问非常有用。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GREYLIST_RDNS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>rDNS 灰名单：</strong> 要列入灰名单的反向 DNS 后缀列表，以空格分隔。</td>
</tr>
<tr>
<td><code>GREYLIST_RDNS_GLOBAL</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>仅限 rDNS 全局：</strong> 当设置为 <code>yes</code> 时，仅对全局 IP 地址执行 rDNS 灰名单检查。</td>
</tr>
<tr>
<td><code>GREYLIST_RDNS_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>rDNS 灰名单 URL：</strong> 包含要列入灰名单的反向 DNS 后缀的 URL 列表，以空格分隔。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<p><strong>这是做什么的：</strong> 使用自治系统号将来自特定网络提供商的访问者列入灰名单。ASN 标识一个 IP 属于哪个提供商或组织。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GREYLIST_ASN</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>ASN 灰名单：</strong> 要列入灰名单的自治系统号列表，以空格分隔。</td>
</tr>
<tr>
<td><code>GREYLIST_ASN_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>ASN 灰名单 URL：</strong> 包含要列入灰名单的 ASN 的 URL 列表，以空格分隔。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<p><strong>这是做什么的：</strong> 根据访问者声称使用的浏览器或工具将访问者列入灰名单。这允许对特定工具进行受控访问，同时保持安全检查。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GREYLIST_USER_AGENT</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>用户代理灰名单：</strong> 要列入灰名单的用户代理模式（PCRE 正则表达式）列表，以空格分隔。</td>
</tr>
<tr>
<td><code>GREYLIST_USER_AGENT_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>用户代理灰名单 URL：</strong> 包含要列入灰名单的用户代理模式的 URL 列表。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<p><strong>这是做什么的：</strong> 将对您网站上特定 URL 的请求列入灰名单。这允许有条件地访问某些端点，同时保持安全检查。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GREYLIST_URI</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>URI 灰名单：</strong> 要列入灰名单的 URI 模式（PCRE 正则表达式）列表，以空格分隔。</td>
</tr>
<tr>
<td><code>GREYLIST_URI_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>URI 灰名单 URL：</strong> 包含要列入灰名单的 URI 模式的 URL 列表，以空格分隔。</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="admonition info">
<p class="admonition-title">URL 格式支持</p>
<p>所有 <code>*_URLS</code> 设置都支持 HTTP/HTTPS URL 以及使用 <code>file:///</code> 前缀的本地文件路径。使用 <code>http://user:pass@url</code> 格式支持基本身份验证。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">定期更新</p>
<p>来自 URL 的灰名单会每小时自动下载和更新，以确保您的保护始终与最新的受信任来源保持同步。</p>
</div>
<h3 id="zh-features-_58">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="21:4"><input checked="checked" id="zh-features-__tabbed_21_1" name="zh-features-__tabbed_21" type="radio" /><input id="zh-features-__tabbed_21_2" name="zh-features-__tabbed_21" type="radio" /><input id="zh-features-__tabbed_21_3" name="zh-features-__tabbed_21" type="radio" /><input id="zh-features-__tabbed_21_4" name="zh-features-__tabbed_21" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_21_1">基本配置</label><label for="zh-features-__tabbed_21_2">高级配置</label><label for="zh-features-__tabbed_21_3">使用本地文件</label><label for="zh-features-__tabbed_21_4">选择性 API 访问</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个简单的配置，将灰名单应用于公司的内部网络和爬虫：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_GREYLIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">GREYLIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.1.0/24</span><span class="nv"> </span><span class="s">10.0.0.0/8&quot;</span>
<span class="nt">GREYLIST_USER_AGENT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;(?:\b)CompanyCrawler(?:\b)&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个更全面的配置，具有多个灰名单标准：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_GREYLIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>

<span class="c1"># 公司资产和批准的爬虫</span>
<span class="nt">GREYLIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.1.0/24</span><span class="nv"> </span><span class="s">203.0.113.0/24&quot;</span>
<span class="nt">GREYLIST_RDNS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;.company.com</span><span class="nv"> </span><span class="s">.partner-company.org&quot;</span>
<span class="nt">GREYLIST_ASN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;12345</span><span class="nv"> </span><span class="s">67890&quot;</span><span class="w">  </span><span class="c1"># 公司和合作伙伴的 ASN</span>
<span class="nt">GREYLIST_USER_AGENT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;(?:\b)GoodBot(?:\b)</span><span class="nv"> </span><span class="s">(?:\b)PartnerCrawler(?:\b)&quot;</span>
<span class="nt">GREYLIST_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^/api/v1/&quot;</span>

<span class="c1"># 外部受信任的来源</span>
<span class="nt">GREYLIST_IP_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/trusted-networks.txt&quot;</span>
<span class="nt">GREYLIST_USER_AGENT_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/trusted-crawlers.txt&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用本地文件作为灰名单的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_GREYLIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">GREYLIST_IP_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/ip-greylist.txt&quot;</span>
<span class="nt">GREYLIST_RDNS_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/rdns-greylist.txt&quot;</span>
<span class="nt">GREYLIST_ASN_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/asn-greylist.txt&quot;</span>
<span class="nt">GREYLIST_USER_AGENT_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/user-agent-greylist.txt&quot;</span>
<span class="nt">GREYLIST_URI_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/uri-greylist.txt&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>允许访问特定 API 端点的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_GREYLIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">GREYLIST_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^/api/v1/public/</span><span class="nv"> </span><span class="s">^/api/v1/status&quot;</span>
<span class="nt">GREYLIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;203.0.113.0/24&quot;</span><span class="w">  </span><span class="c1"># 外部合作伙伴网络</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-gzip">Gzip</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>GZIP 插件通过使用 GZIP 算法压缩 HTTP 响应来增强网站性能。此功能通过在将 Web 内容发送到客户端浏览器之前对其进行压缩，减少了带宽使用并缩短了页面加载时间，从而实现了更快的交付和更好的用户体验。</p>
<h3 id="zh-features-_59">工作原理</h3>
<ol>
<li>当客户端从您的网站请求内容时，BunkerWeb 会检查客户端是否支持 GZIP 压缩。</li>
<li>如果支持，BunkerWeb 会在您配置的压缩级别下使用 GZIP 算法对响应进行压缩。</li>
<li>压缩后的内容会连同指示 GZIP 压缩的适当标头一起发送给客户端。</li>
<li>客户端的浏览器在呈现内容之前会对其进行解压缩。</li>
<li>带宽使用量和页面加载时间都得到了减少，从而增强了网站的整体性能和用户体验。</li>
</ol>
<h3 id="zh-features-_60">如何使用</h3>
<p>请按照以下步骤配置和使用 GZIP 压缩功能：</p>
<ol>
<li><strong>启用该功能：</strong> GZIP 功能默认禁用。通过将 <code>USE_GZIP</code> 设置为 <code>yes</code> 来启用它。</li>
<li><strong>配置 MIME 类型：</strong> 使用 <code>GZIP_TYPES</code> 设置指定应压缩的内容类型。</li>
<li><strong>设置最小大小：</strong> 使用 <code>GZIP_MIN_LENGTH</code> 设置定义压缩所需的最小响应大小，以避免压缩小文件。</li>
<li><strong>选择一个压缩级别：</strong> 使用 <code>GZIP_COMP_LEVEL</code> 设置在速度和压缩率之间选择您偏好的平衡。</li>
<li><strong>配置代理请求：</strong> 使用 <code>GZIP_PROXIED</code> 设置指定应压缩哪些代理请求。</li>
</ol>
<h3 id="zh-features-_61">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_GZIP</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用 GZIP：</strong> 设置为 <code>yes</code> 以启用 GZIP 压缩。</td>
</tr>
<tr>
<td><code>GZIP_TYPES</code></td>
<td><code>application/atom+xml application/javascript application/json application/rss+xml application/vnd.ms-fontobject application/x-font-opentype application/x-font-truetype application/x-font-ttf application/x-javascript application/xhtml+xml application/xml font/eot font/opentype font/otf font/truetype image/svg+xml image/vnd.microsoft.icon image/x-icon image/x-win-bitmap text/css text/javascript text/plain text/xml</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>MIME 类型：</strong> 将使用 GZIP 压缩的内容类型列表。</td>
</tr>
<tr>
<td><code>GZIP_MIN_LENGTH</code></td>
<td><code>1000</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>最小大小：</strong> 应用 GZIP 压缩的最小响应大小（以字节为单位）。</td>
</tr>
<tr>
<td><code>GZIP_COMP_LEVEL</code></td>
<td><code>5</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>压缩级别：</strong> 压缩级别从 1（最小压缩）到 9（最大压缩）。较高的值会使用更多的 CPU。</td>
</tr>
<tr>
<td><code>GZIP_PROXIED</code></td>
<td><code>no-cache no-store private expired auth</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>代理请求：</strong> 根据响应标头指定应压缩哪些代理请求。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">优化压缩级别</p>
<p>默认的压缩级别 (5) 在压缩率和 CPU 使用率之间提供了良好的平衡。对于静态内容或服务器 CPU 资源充足的情况，可以考虑增加到 7-9 以获得最大压缩。对于动态内容或 CPU 资源有限的情况，您可能希望使用 1-3 以实现更快的压缩和合理的尺寸减小。</p>
</div>
<div class="admonition info">
<p class="admonition-title">浏览器支持</p>
<p>所有现代浏览器都支持 GZIP，并且多年来一直是 HTTP 响应的标准压缩方法，确保了在设备和浏览器之间具有出色的兼容性。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">压缩与 CPU 使用率</p>
<p>虽然 GZIP 压缩减少了带宽并缩短了加载时间，但更高的压缩级别会消耗更多的 CPU 资源。对于高流量的网站，请在压缩效率和服务器性能之间找到适当的平衡。</p>
</div>
<h3 id="zh-features-_62">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="22:4"><input checked="checked" id="zh-features-__tabbed_22_1" name="zh-features-__tabbed_22" type="radio" /><input id="zh-features-__tabbed_22_2" name="zh-features-__tabbed_22" type="radio" /><input id="zh-features-__tabbed_22_3" name="zh-features-__tabbed_22" type="radio" /><input id="zh-features-__tabbed_22_4" name="zh-features-__tabbed_22" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_22_1">基本配置</label><label for="zh-features-__tabbed_22_2">最大压缩</label><label for="zh-features-__tabbed_22_3">平衡性能</label><label for="zh-features-__tabbed_22_4">代理内容焦点</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个使用默认设置启用 GZIP 的标准配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_GZIP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">GZIP_TYPES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;application/javascript</span><span class="nv"> </span><span class="s">application/json</span><span class="nv"> </span><span class="s">application/xml</span><span class="nv"> </span><span class="s">text/css</span><span class="nv"> </span><span class="s">text/html</span><span class="nv"> </span><span class="s">text/javascript</span><span class="nv"> </span><span class="s">text/plain</span><span class="nv"> </span><span class="s">text/xml&quot;</span>
<span class="nt">GZIP_MIN_LENGTH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1000&quot;</span>
<span class="nt">GZIP_COMP_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>为实现最大压缩节省而优化的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_GZIP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">GZIP_TYPES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;application/atom+xml</span><span class="nv"> </span><span class="s">application/javascript</span><span class="nv"> </span><span class="s">application/json</span><span class="nv"> </span><span class="s">application/rss+xml</span><span class="nv"> </span><span class="s">application/vnd.ms-fontobject</span><span class="nv"> </span><span class="s">application/x-font-opentype</span><span class="nv"> </span><span class="s">application/x-font-truetype</span><span class="nv"> </span><span class="s">application/x-font-ttf</span><span class="nv"> </span><span class="s">application/x-javascript</span><span class="nv"> </span><span class="s">application/xhtml+xml</span><span class="nv"> </span><span class="s">application/xml</span><span class="nv"> </span><span class="s">font/eot</span><span class="nv"> </span><span class="s">font/opentype</span><span class="nv"> </span><span class="s">font/otf</span><span class="nv"> </span><span class="s">font/truetype</span><span class="nv"> </span><span class="s">image/svg+xml</span><span class="nv"> </span><span class="s">image/vnd.microsoft.icon</span><span class="nv"> </span><span class="s">image/x-icon</span><span class="nv"> </span><span class="s">image/x-win-bitmap</span><span class="nv"> </span><span class="s">text/css</span><span class="nv"> </span><span class="s">text/javascript</span><span class="nv"> </span><span class="s">text/plain</span><span class="nv"> </span><span class="s">text/xml&quot;</span>
<span class="nt">GZIP_MIN_LENGTH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500&quot;</span>
<span class="nt">GZIP_COMP_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;9&quot;</span>
<span class="nt">GZIP_PROXIED</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;any&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>在压缩率和 CPU 使用率之间取得平衡的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_GZIP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">GZIP_TYPES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;application/javascript</span><span class="nv"> </span><span class="s">application/json</span><span class="nv"> </span><span class="s">text/css</span><span class="nv"> </span><span class="s">text/html</span><span class="nv"> </span><span class="s">text/javascript</span><span class="nv"> </span><span class="s">text/plain&quot;</span>
<span class="nt">GZIP_MIN_LENGTH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1000&quot;</span>
<span class="nt">GZIP_COMP_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3&quot;</span>
<span class="nt">GZIP_PROXIED</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no-cache</span><span class="nv"> </span><span class="s">no-store</span><span class="nv"> </span><span class="s">private</span><span class="nv"> </span><span class="s">expired&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>专注于正确处理代理内容压缩的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_GZIP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">GZIP_TYPES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;application/javascript</span><span class="nv"> </span><span class="s">application/json</span><span class="nv"> </span><span class="s">text/css</span><span class="nv"> </span><span class="s">text/html</span><span class="nv"> </span><span class="s">text/javascript&quot;</span>
<span class="nt">GZIP_MIN_LENGTH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1000&quot;</span>
<span class="nt">GZIP_COMP_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
<span class="nt">GZIP_PROXIED</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;any&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-html-injection">HTML injection</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>HTML 注入插件允许您无缝地将自定义 HTML 代码添加到您网站页面的 <code>&lt;/body&gt;</code> 或 <code>&lt;/head&gt;</code> 结束标签之前。此功能对于添加分析脚本、跟踪像素、自定义 JavaScript、CSS 样式或其他第三方集成非常有用，而无需修改您网站的源代码。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当您的网站提供页面服务时，BunkerWeb 会检查 HTML 响应。</li>
<li>如果您配置了 body 注入，BunkerWeb 会在 <code>&lt;/body&gt;</code> 结束标签之前插入您的自定义 HTML 代码。</li>
<li>如果您配置了 head 注入，BunkerWeb 会在 <code>&lt;/head&gt;</code> 结束标签之前插入您的自定义 HTML 代码。</li>
<li>此插入操作会自动应用于您网站提供的所有 HTML 页面。</li>
<li>这使您无需修改应用程序代码即可添加脚本、样式或其他元素。</li>
</ol>
<h3 id="zh-features-_63">如何使用</h3>
<p>请按照以下步骤配置和使用 HTML 注入功能：</p>
<ol>
<li><strong>准备您的自定义 HTML：</strong> 决定要注入到页面中的 HTML 代码。</li>
<li><strong>选择注入位置：</strong> 确定您需要在 <code>&lt;head&gt;</code> 部分、<code>&lt;body&gt;</code> 部分还是两者都注入代码。</li>
<li><strong>配置设置：</strong> 将您的自定义 HTML 添加到适当的设置中 (<code>INJECT_HEAD</code> 和/或 <code>INJECT_BODY</code>)。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 配置完成后，HTML 将自动注入到所有提供的 HTML 页面中。</li>
</ol>
<h3 id="zh-features-_64">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>INJECT_HEAD</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>头部 HTML 代码：</strong> 在 <code>&lt;/head&gt;</code> 标签前注入的 HTML 代码。</td>
</tr>
<tr>
<td><code>INJECT_BODY</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>主体 HTML 代码：</strong> 在 <code>&lt;/body&gt;</code> 标签前注入的 HTML 代码。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">最佳实践</p>
<ul>
<li>出于性能考虑，请将 JavaScript 文件放在 body 的末尾，以防止渲染阻塞。</li>
<li>将 CSS 和关键的 JavaScript 放在 head 部分，以避免出现无样式内容的闪烁。</li>
<li>请谨慎处理可能破坏您网站功能的注入内容。</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">常见用例</p>
<ul>
<li>添加分析脚本（如 Google Analytics, Matomo）</li>
<li>集成聊天小部件或客户支持工具</li>
<li>为营销活动添加跟踪像素</li>
<li>添加自定义 CSS 样式或 JavaScript 功能</li>
<li>无需修改应用程序代码即可引入第三方库</li>
</ul>
</div>
<h3 id="zh-features-_65">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="23:4"><input checked="checked" id="zh-features-__tabbed_23_1" name="zh-features-__tabbed_23" type="radio" /><input id="zh-features-__tabbed_23_2" name="zh-features-__tabbed_23" type="radio" /><input id="zh-features-__tabbed_23_3" name="zh-features-__tabbed_23" type="radio" /><input id="zh-features-__tabbed_23_4" name="zh-features-__tabbed_23" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_23_1">谷歌分析</label><label for="zh-features-__tabbed_23_2">自定义样式</label><label for="zh-features-__tabbed_23_3">多个集成</label><label for="zh-features-__tabbed_23_4">Cookie 同意横幅</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>将谷歌分析跟踪添加到您的网站：</p>
<div class="highlight"><pre><span></span><code><span class="nt">INJECT_HEAD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="nt">INJECT_BODY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;script</span><span class="nv"> </span><span class="s">async</span><span class="nv"> </span><span class="s">src=\&quot;https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX\&quot;&gt;&lt;/script&gt;&lt;script&gt;window.dataLayer</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">window.dataLayer</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">[];function</span><span class="nv"> </span><span class="s">gtag(){dataLayer.push(arguments);}gtag(&#39;js&#39;,</span><span class="nv"> </span><span class="s">new</span><span class="nv"> </span><span class="s">Date());gtag(&#39;config&#39;,</span><span class="nv"> </span><span class="s">&#39;G-XXXXXXXXXX&#39;);&lt;/script&gt;&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>向您的网站添加自定义 CSS 样式：</p>
<div class="highlight"><pre><span></span><code><span class="nt">INJECT_HEAD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;style&gt;body</span><span class="nv"> </span><span class="s">{</span><span class="nv"> </span><span class="s">font-family:</span><span class="nv"> </span><span class="s">&#39;Arial&#39;,</span><span class="nv"> </span><span class="s">sans-serif;</span><span class="nv"> </span><span class="s">}</span><span class="nv"> </span><span class="s">.custom-element</span><span class="nv"> </span><span class="s">{</span><span class="nv"> </span><span class="s">color:</span><span class="nv"> </span><span class="s">blue;</span><span class="nv"> </span><span class="s">}&lt;/style&gt;&quot;</span>
<span class="nt">INJECT_BODY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>同时添加自定义样式和 JavaScript：</p>
<div class="highlight"><pre><span></span><code><span class="nt">INJECT_HEAD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;style&gt;body</span><span class="nv"> </span><span class="s">{</span><span class="nv"> </span><span class="s">font-family:</span><span class="nv"> </span><span class="s">&#39;Arial&#39;,</span><span class="nv"> </span><span class="s">sans-serif;</span><span class="nv"> </span><span class="s">}</span><span class="nv"> </span><span class="s">.notification-banner</span><span class="nv"> </span><span class="s">{</span><span class="nv"> </span><span class="s">background:</span><span class="nv"> </span><span class="s">#f8f9fa;</span><span class="nv"> </span><span class="s">padding:</span><span class="nv"> </span><span class="s">10px;</span><span class="nv"> </span><span class="s">text-align:</span><span class="nv"> </span><span class="s">center;</span><span class="nv"> </span><span class="s">}&lt;/style&gt;&quot;</span>
<span class="nt">INJECT_BODY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;script</span><span class="nv"> </span><span class="s">src=\&quot;https://cdn.example.com/js/widget.js\&quot;&gt;&lt;/script&gt;&lt;script&gt;initializeWidget(&#39;your-api-key&#39;);&lt;/script&gt;&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>添加一个简单的 Cookie 同意横幅：</p>
<div class="highlight"><pre><span></span><code><span class="nt">INJECT_HEAD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;style&gt;.cookie-banner</span><span class="nv"> </span><span class="s">{</span><span class="nv"> </span><span class="s">position:</span><span class="nv"> </span><span class="s">fixed;</span><span class="nv"> </span><span class="s">bottom:</span><span class="nv"> </span><span class="s">0;</span><span class="nv"> </span><span class="s">left:</span><span class="nv"> </span><span class="s">0;</span><span class="nv"> </span><span class="s">right:</span><span class="nv"> </span><span class="s">0;</span><span class="nv"> </span><span class="s">background:</span><span class="nv"> </span><span class="s">#f1f1f1;</span><span class="nv"> </span><span class="s">padding:</span><span class="nv"> </span><span class="s">20px;</span><span class="nv"> </span><span class="s">text-align:</span><span class="nv"> </span><span class="s">center;</span><span class="nv"> </span><span class="s">z-index:</span><span class="nv"> </span><span class="s">1000;</span><span class="nv"> </span><span class="s">}</span><span class="nv"> </span><span class="s">.cookie-banner</span><span class="nv"> </span><span class="s">button</span><span class="nv"> </span><span class="s">{</span><span class="nv"> </span><span class="s">background:</span><span class="nv"> </span><span class="s">#4CAF50;</span><span class="nv"> </span><span class="s">border:</span><span class="nv"> </span><span class="s">none;</span><span class="nv"> </span><span class="s">color:</span><span class="nv"> </span><span class="s">white;</span><span class="nv"> </span><span class="s">padding:</span><span class="nv"> </span><span class="s">10px</span><span class="nv"> </span><span class="s">20px;</span><span class="nv"> </span><span class="s">cursor:</span><span class="nv"> </span><span class="s">pointer;</span><span class="nv"> </span><span class="s">}&lt;/style&gt;&quot;</span>
<span class="nt">INJECT_BODY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&lt;div</span><span class="nv"> </span><span class="s">id=\&quot;cookie-banner\&quot;</span><span class="nv"> </span><span class="s">class=\&quot;cookie-banner\&quot;&gt;本网站使用</span><span class="nv"> </span><span class="s">Cookie</span><span class="nv"> </span><span class="s">以确保您获得最佳体验。</span><span class="nv"> </span><span class="s">&lt;button</span><span class="nv"> </span><span class="s">onclick=\&quot;acceptCookies()\&quot;&gt;接受&lt;/button&gt;&lt;/div&gt;&lt;script&gt;function</span><span class="nv"> </span><span class="s">acceptCookies()</span><span class="nv"> </span><span class="s">{</span><span class="nv"> </span><span class="s">document.getElementById(&#39;cookie-banner&#39;).style.display</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">&#39;none&#39;;</span><span class="nv"> </span><span class="s">localStorage.setItem(&#39;cookies-accepted&#39;,</span><span class="nv"> </span><span class="s">&#39;true&#39;);</span><span class="nv"> </span><span class="s">}</span><span class="nv"> </span><span class="s">if(localStorage.getItem(&#39;cookies-accepted&#39;)</span><span class="nv"> </span><span class="s">===</span><span class="nv"> </span><span class="s">&#39;true&#39;)</span><span class="nv"> </span><span class="s">{</span><span class="nv"> </span><span class="s">document.getElementById(&#39;cookie-banner&#39;).style.display</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">&#39;none&#39;;</span><span class="nv"> </span><span class="s">}&lt;/script&gt;&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-headers">Headers</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>请求头在 HTTP 安全中扮演着至关重要的角色。请求头插件提供了对标准和自定义 HTTP 请求头的强大管理功能——增强了安全性和功能性。它动态地应用安全措施，例如 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Strict-Transport-Security">HSTS</a>、<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Content-Security-Policy">CSP</a>（包括报告模式）和自定义请求头注入，同时防止信息泄露。</p>
<p><strong>工作原理</strong></p>
<ol>
<li>当客户端从您的网站请求内容时，BunkerWeb 会处理响应头。</li>
<li>安全头会根据您的配置进行应用。</li>
<li>可以添加自定义头来为客户端提供额外的信息或功能。</li>
<li>可能会泄露服务器信息的不需要的头会自动被移除。</li>
<li>Cookie 会根据您的设置被修改以包含适当的安全标志。</li>
<li>需要时，可以选择性地保留来自上游服务器的头。</li>
</ol>
<h3 id="zh-features-_66">如何使用</h3>
<p>请按照以下步骤配置和使用请求头功能：</p>
<ol>
<li><strong>配置安全头：</strong> 为常见的请求头设置值。</li>
<li><strong>添加自定义头：</strong> 使用 <code>CUSTOM_HEADER</code> 设置定义任何自定义请求头。</li>
<li><strong>移除不需要的头：</strong> 使用 <code>REMOVE_HEADERS</code> 确保可能会暴露服务器细节的请求头被剥离。</li>
<li><strong>设置 Cookie 安全：</strong> 通过配置 <code>COOKIE_FLAGS</code> 并将 <code>COOKIE_AUTO_SECURE_FLAG</code> 设置为 <code>yes</code> 来启用强大的 Cookie 安全，以便在 HTTPS 连接上自动添加 Secure 标志。</li>
<li><strong>保留上游头：</strong> 使用 <code>KEEP_UPSTREAM_HEADERS</code> 指定要保留的上游请求头。</li>
<li><strong>利用条件性头应用：</strong> 如果您希望在不中断的情况下测试策略，请通过 <code>CONTENT_SECURITY_POLICY_REPORT_ONLY</code> 启用 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Content-Security-Policy-Report-Only">CSP 仅报告</a>模式。</li>
</ol>
<h3 id="zh-features-_67">配置指南</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="24:3"><input checked="checked" id="zh-features-__tabbed_24_1" name="zh-features-__tabbed_24" type="radio" /><input id="zh-features-__tabbed_24_2" name="zh-features-__tabbed_24" type="radio" /><input id="zh-features-__tabbed_24_3" name="zh-features-__tabbed_24" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_24_1">安全头</label><label for="zh-features-__tabbed_24_2">Cookie 设置</label><label for="zh-features-__tabbed_24_3">自定义头</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><strong>概述</strong></p>
<p>安全头强制执行安全通信，限制资源加载，并防止诸如点击劫持和注入等攻击。正确配置的头为您的网站创建了一个强大的防御层。</p>
<div class="admonition success">
<p class="admonition-title">安全头的好处</p>
<ul>
<li><strong>HSTS：</strong> 确保所有连接都已加密，防止协议降级攻击。</li>
<li><strong>CSP：</strong> 防止恶意脚本执行，降低 XSS 攻击的风险。</li>
<li><strong>X-Frame-Options：</strong> 通过控制 iframe 嵌入来阻止点击劫持尝试。</li>
<li><strong>Referrer Policy：</strong> 通过 referrer 头限制敏感信息的泄露。</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>STRICT_TRANSPORT_SECURITY</code></td>
<td><code>max-age=63072000; includeSubDomains; preload</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>HSTS：</strong> 强制执行安全的 HTTPS 连接，降低中间人攻击的风险。</td>
</tr>
<tr>
<td><code>CONTENT_SECURITY_POLICY</code></td>
<td><code>object-src 'none'; form-action 'self'; frame-ancestors 'self';</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>CSP：</strong> 将资源加载限制在受信任的来源，减轻跨站脚本和数据注入攻击。</td>
</tr>
<tr>
<td><code>CONTENT_SECURITY_POLICY_REPORT_ONLY</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>CSP 报告模式：</strong> 报告违规行为而不阻止内容，有助于在测试安全策略的同时捕获日志。</td>
</tr>
<tr>
<td><code>X_FRAME_OPTIONS</code></td>
<td><code>SAMEORIGIN</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>X-Frame-Options：</strong> 通过控制您的网站是否可以被框架化来防止点击劫持。</td>
</tr>
<tr>
<td><code>X_CONTENT_TYPE_OPTIONS</code></td>
<td><code>nosniff</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>X-Content-Type-Options：</strong> 防止浏览器进行 MIME 嗅探，防止路过式下载攻击。</td>
</tr>
<tr>
<td><code>X_DNS_PREFETCH_CONTROL</code></td>
<td><code>off</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>X-DNS-Prefetch-Control：</strong> 调节 DNS 预取以减少无意的网络请求并增强隐私。</td>
</tr>
<tr>
<td><code>REFERRER_POLICY</code></td>
<td><code>strict-origin-when-cross-origin</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>Referrer Policy：</strong> 控制发送的引荐来源信息的数量，保护用户隐私。</td>
</tr>
<tr>
<td><code>PERMISSIONS_POLICY</code></td>
<td><code>accelerometer=(), ambient-light-sensor=(), attribution-reporting=(), autoplay=(), battery=(), ...</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>Permissions Policy：</strong> 限制浏览器功能访问，减少潜在的攻击向量。</td>
</tr>
<tr>
<td><code>KEEP_UPSTREAM_HEADERS</code></td>
<td><code>Content-Security-Policy Permissions-Policy X-Frame-Options</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>保留标头：</strong> 保留选定的上游标头，在保持安全性的同时帮助旧版集成。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">最佳实践</p>
<ul>
<li>定期审查和更新您的安全标头，以与不断发展的安全标准保持一致。</li>
<li>使用像 <a href="https://observatory.mozilla.org/">Mozilla Observatory</a> 这样的工具来验证您的标头配置。</li>
<li>在强制执行 CSP 之前，在 <code>Report-Only</code> 模式下进行测试，以避免破坏功能。</li>
</ul>
</div>
</div>
<div class="tabbed-block">
<p><strong>概述</strong></p>
<p>正确的 cookie 设置通过防止劫持、固定和跨站脚本攻击来确保安全的用户会话。安全的 cookie 在 HTTPS 上维护会话完整性，并增强整体用户数据保护。</p>
<div class="admonition success">
<p class="admonition-title">安全 Cookie 的好处</p>
<ul>
<li><strong>HttpOnly 标志：</strong> 防止客户端脚本访问 cookie，减轻 XSS 风险。</li>
<li><strong>SameSite 标志：</strong> 通过限制跨源 cookie 的使用来减少 CSRF 攻击。</li>
<li><strong>Secure 标志：</strong> 确保 cookie 仅通过加密的 HTTPS 连接传输。</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>COOKIE_FLAGS</code></td>
<td><code>* HttpOnly SameSite=Lax</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>Cookie 标志：</strong> 自动添加安全标志，如 HttpOnly 和 SameSite，保护 cookie 免受客户端脚本访问和 CSRF 攻击。</td>
</tr>
<tr>
<td><code>COOKIE_AUTO_SECURE_FLAG</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>自动安全标志：</strong> 通过自动附加 Secure 标志，确保 cookie 仅通过安全的 HTTPS 连接发送。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">最佳实践</p>
<ul>
<li>对敏感 cookie 使用 <code>SameSite=Strict</code> 以防止跨源访问。</li>
<li>定期审计您的 cookie 设置，以确保符合安全和隐私法规。</li>
<li>避免在生产环境中设置没有 Secure 标志的 cookie。</li>
</ul>
</div>
</div>
<div class="tabbed-block">
<p><strong>概述</strong></p>
<p>自定义标头允许您添加特定的 HTTP 标头以满足应用程序或性能要求。它们提供了灵活性，但必须仔细配置以避免暴露敏感的服务器详细信息。</p>
<div class="admonition success">
<p class="admonition-title">自定义标头的好处</p>
<ul>
<li>通过删除可能泄露服务器详细信息的不必要标头来增强安全性。</li>
<li>添加特定于应用程序的标头以改进功能或调试。</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CUSTOM_HEADER</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>自定义标头：</strong> 提供了以 <code>HeaderName: HeaderValue</code> 格式添加用户定义的标头的方法，用于专门的安全或性能增强。</td>
</tr>
<tr>
<td><code>REMOVE_HEADERS</code></td>
<td><code>Server Expect-CT X-Powered-By X-AspNet-Version X-AspNetMvc-Version Public-Key-Pins</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>删除标头：</strong> 指定要删除的标头，降低暴露内部服务器详细信息和已知漏洞的几率。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">安全注意事项</p>
<ul>
<li>避免通过自定义标头暴露敏感信息。</li>
<li>定期审查和更新自定义标头，以与您的应用程序的要求保持一致。</li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">最佳实践</p>
<ul>
<li>使用 <code>REMOVE_HEADERS</code> 去除像 <code>Server</code> 和 <code>X-Powered-By</code> 这样的标头，以减少指纹识别风险。</li>
<li>在将自定义标头部署到生产环境之前，在暂存环境中进行测试。</li>
</ul>
</div>
</div>
</div>
</div>
<h3 id="zh-features-_68">示例配置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="25:4"><input checked="checked" id="zh-features-__tabbed_25_1" name="zh-features-__tabbed_25" type="radio" /><input id="zh-features-__tabbed_25_2" name="zh-features-__tabbed_25" type="radio" /><input id="zh-features-__tabbed_25_3" name="zh-features-__tabbed_25" type="radio" /><input id="zh-features-__tabbed_25_4" name="zh-features-__tabbed_25" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_25_1">基本安全头</label><label for="zh-features-__tabbed_25_2">增强的 Cookie 安全性</label><label for="zh-features-__tabbed_25_3">API 的自定义头</label><label for="zh-features-__tabbed_25_4">内容安全策略 - 报告模式</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个带有基本安全头的标准配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">STRICT_TRANSPORT_SECURITY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;max-age=63072000;</span><span class="nv"> </span><span class="s">includeSubDomains;</span><span class="nv"> </span><span class="s">preload&quot;</span>
<span class="nt">CONTENT_SECURITY_POLICY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default-src</span><span class="nv"> </span><span class="s">&#39;self&#39;;</span><span class="nv"> </span><span class="s">script-src</span><span class="nv"> </span><span class="s">&#39;self&#39;;</span><span class="nv"> </span><span class="s">object-src</span><span class="nv"> </span><span class="s">&#39;none&#39;;</span><span class="nv"> </span><span class="s">frame-ancestors</span><span class="nv"> </span><span class="s">&#39;self&#39;&quot;</span>
<span class="nt">X_FRAME_OPTIONS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;SAMEORIGIN&quot;</span>
<span class="nt">X_CONTENT_TYPE_OPTIONS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nosniff&quot;</span>
<span class="nt">REFERRER_POLICY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;strict-origin-when-cross-origin&quot;</span>
<span class="nt">REMOVE_HEADERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Server</span><span class="nv"> </span><span class="s">X-Powered-By</span><span class="nv"> </span><span class="s">X-AspNet-Version&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>具有强大 cookie 安全设置的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">COOKIE_FLAGS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*</span><span class="nv"> </span><span class="s">HttpOnly</span><span class="nv"> </span><span class="s">SameSite=Strict&quot;</span>
<span class="nt">COOKIE_FLAGS_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;session_cookie</span><span class="nv"> </span><span class="s">Secure</span><span class="nv"> </span><span class="s">HttpOnly</span><span class="nv"> </span><span class="s">SameSite=Strict&quot;</span>
<span class="nt">COOKIE_FLAGS_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;auth_cookie</span><span class="nv"> </span><span class="s">Secure</span><span class="nv"> </span><span class="s">HttpOnly</span><span class="nv"> </span><span class="s">SameSite=Strict</span><span class="nv"> </span><span class="s">Max-Age=3600&quot;</span>
<span class="nt">COOKIE_AUTO_SECURE_FLAG</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个带有自定义头的 API 服务配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">CUSTOM_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;API-Version:</span><span class="nv"> </span><span class="s">1.2.3&quot;</span>
<span class="nt">CUSTOM_HEADER_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Access-Control-Max-Age:</span><span class="nv"> </span><span class="s">86400&quot;</span>
<span class="nt">CONTENT_SECURITY_POLICY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default-src</span><span class="nv"> </span><span class="s">&#39;none&#39;;</span><span class="nv"> </span><span class="s">frame-ancestors</span><span class="nv"> </span><span class="s">&#39;none&#39;&quot;</span>
<span class="nt">REMOVE_HEADERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Server</span><span class="nv"> </span><span class="s">X-Powered-By</span><span class="nv"> </span><span class="s">X-AspNet-Version</span><span class="nv"> </span><span class="s">X-Runtime&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>用于在不破坏功能的情况下测试 CSP 的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">CONTENT_SECURITY_POLICY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default-src</span><span class="nv"> </span><span class="s">&#39;self&#39;;</span><span class="nv"> </span><span class="s">script-src</span><span class="nv"> </span><span class="s">&#39;self&#39;</span><span class="nv"> </span><span class="s">https://trusted-cdn.example.com;</span><span class="nv"> </span><span class="s">img-src</span><span class="nv"> </span><span class="s">&#39;self&#39;</span><span class="nv"> </span><span class="s">data:</span><span class="nv"> </span><span class="s">https://*.example.com;</span><span class="nv"> </span><span class="s">style-src</span><span class="nv"> </span><span class="s">&#39;self&#39;</span><span class="nv"> </span><span class="s">&#39;unsafe-inline&#39;</span><span class="nv"> </span><span class="s">https://trusted-cdn.example.com;</span><span class="nv"> </span><span class="s">connect-src</span><span class="nv"> </span><span class="s">&#39;self&#39;</span><span class="nv"> </span><span class="s">https://api.example.com;</span><span class="nv"> </span><span class="s">object-src</span><span class="nv"> </span><span class="s">&#39;none&#39;;</span><span class="nv"> </span><span class="s">frame-ancestors</span><span class="nv"> </span><span class="s">&#39;self&#39;;</span><span class="nv"> </span><span class="s">form-action</span><span class="nv"> </span><span class="s">&#39;self&#39;;</span><span class="nv"> </span><span class="s">base-uri</span><span class="nv"> </span><span class="s">&#39;self&#39;;</span><span class="nv"> </span><span class="s">report-uri</span><span class="nv"> </span><span class="s">https://example.com/csp-reports&quot;</span>
<span class="nt">CONTENT_SECURITY_POLICY_REPORT_ONLY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-lets-encrypt">Let's Encrypt</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>Let's Encrypt 插件通过自动化创建、续订和配置来自 Let's Encrypt 的免费证书，简化了 SSL/TLS 证书管理。此功能可为您的网站启用安全的 HTTPS 连接，无需手动管理证书的复杂性，从而降低成本和管理开销。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>启用后，BunkerWeb 会自动检测为您的网站配置的域名。</li>
<li>BunkerWeb 从 Let's Encrypt 的证书颁发机构请求免费的 SSL/TLS 证书。</li>
<li>通过 HTTP 验证（证明您控制网站）或 DNS 验证（证明您控制域名的 DNS）来验证域名所有权。</li>
<li>证书会自动为您的域名安装和配置。</li>
<li>BunkerWeb 会在证书到期前在后台处理续订事宜，确保 HTTPS 的持续可用性。</li>
<li>整个过程完全自动化，初次设置后几乎无需干预。</li>
</ol>
<div class="admonition info">
<p class="admonition-title">先决条件</p>
<p>要使用此功能，请确保为每个域名配置了正确的 DNS <strong>A 记录</strong>，指向 BunkerWeb 可访问的公共 IP 地址。没有正确的 DNS 配置，域名验证过程将失败。</p>
</div>
<h3 id="zh-features-_69">如何使用</h3>
<p>请按照以下步骤配置和使用 Let's Encrypt 功能：</p>
<ol>
<li><strong>启用该功能：</strong> 将 <code>AUTO_LETS_ENCRYPT</code> 设置为 <code>yes</code> 以启用自动证书颁发和续订。</li>
<li><strong>提供联系电子邮件：</strong> 使用 <code>EMAIL_LETS_ENCRYPT</code> 设置输入您的电子邮件地址，以接收有关证书的重要通知。</li>
<li><strong>选择验证类型：</strong> 使用 <code>LETS_ENCRYPT_CHALLENGE</code> 设置选择 <code>http</code> 或 <code>dns</code> 验证。</li>
<li><strong>配置 DNS 提供商：</strong> 如果使用 DNS 验证，请指定您的 DNS 提供商和凭据。</li>
<li><strong>选择证书配置文件：</strong> 使用 <code>LETS_ENCRYPT_PROFILE</code> 设置选择您偏好的证书配置文件（classic、tlsserver 或 shortlived）。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 配置完成后，证书将根据需要自动颁发、安装和续订。</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">证书配置文件</p>
<p>Let's Encrypt 为不同的用例提供了不同的证书配置文件：
- <strong>classic</strong>：通用证书，有效期为 90 天（默认）
- <strong>tlsserver</strong>：针对 TLS 服务器身份验证进行了优化，有效期为 90 天，有效负载更小
- <strong>shortlived</strong>：增强安全性，有效期为 7 天，适用于自动化环境
- <strong>custom</strong>：如果您的 ACME 服务器支持不同的配置文件，请使用 <code>LETS_ENCRYPT_CUSTOM_PROFILE</code> 进行设置。</p>
</div>
<div class="admonition info">
<p class="admonition-title">配置文件可用性</p>
<p>请注意，<code>tlsserver</code> 和 <code>shortlived</code> 配置文件目前可能并非在所有环境或所有 ACME 客户端中都可用。<code>classic</code> 配置文件具有最广泛的兼容性，推荐给大多数用户。如果所选的配置文件不可用，系统将自动回退到 <code>classic</code> 配置文件。</p>
</div>
<h3 id="zh-features-_70">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AUTO_LETS_ENCRYPT</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用 Let's Encrypt：</strong> 设置为 <code>yes</code> 以启用自动证书颁发和续订。</td>
</tr>
<tr>
<td><code>LETS_ENCRYPT_PASSTHROUGH</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>传递 Let's Encrypt 请求：</strong> 设置为 <code>yes</code> 以将 Let's Encrypt 请求传递给 Web 服务器。当 BunkerWeb 位于处理 SSL 的另一个反向代理后面时，此功能很有用。</td>
</tr>
<tr>
<td><code>EMAIL_LETS_ENCRYPT</code></td>
<td><code>contact@{FIRST_SERVER}</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>联系电子邮件：</strong> 用于 Let's Encrypt 通知的电子邮件地址，并包含在证书中。</td>
</tr>
<tr>
<td><code>LETS_ENCRYPT_CHALLENGE</code></td>
<td><code>http</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>验证类型：</strong> 用于验证域名所有权的方法。选项：<code>http</code> 或 <code>dns</code>。</td>
</tr>
<tr>
<td><code>LETS_ENCRYPT_DNS_PROVIDER</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>DNS 提供商：</strong> 使用 DNS 验证时，要使用的 DNS 提供商（例如 cloudflare、route53、digitalocean）。</td>
</tr>
<tr>
<td><code>LETS_ENCRYPT_DNS_PROPAGATION</code></td>
<td><code>default</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>DNS 传播：</strong> 等待 DNS 传播的时间（秒）。如果未提供值，则使用提供商的默认传播时间。</td>
</tr>
<tr>
<td><code>LETS_ENCRYPT_DNS_CREDENTIAL_ITEM</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>凭证项：</strong> 用于 DNS 提供商身份验证的配置项（例如 <code>cloudflare_api_token 123456</code>）。值可以是原始文本、base64 编码或 JSON 对象。</td>
</tr>
<tr>
<td><code>USE_LETS_ENCRYPT_WILDCARD</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>通配符证书：</strong> 设置为 <code>yes</code> 时，为所有域名创建通配符证书。仅适用于 DNS 验证。</td>
</tr>
<tr>
<td><code>USE_LETS_ENCRYPT_STAGING</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>使用测试环境：</strong> 设置为 <code>yes</code> 时，使用 Let's Encrypt 的测试环境进行测试。测试环境的速率限制较高，但生成的证书不受浏览器信任。</td>
</tr>
<tr>
<td><code>LETS_ENCRYPT_CLEAR_OLD_CERTS</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>清除旧证书：</strong> 设置为 <code>yes</code> 时，在续订期间删除不再需要的旧证书。</td>
</tr>
<tr>
<td><code>LETS_ENCRYPT_PROFILE</code></td>
<td><code>classic</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>证书配置文件：</strong> 选择要使用的证书配置文件。选项：<code>classic</code>（通用）、<code>tlsserver</code>（针对 TLS 服务器优化）或 <code>shortlived</code>（7 天证书）。</td>
</tr>
<tr>
<td><code>LETS_ENCRYPT_CUSTOM_PROFILE</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>自定义证书配置文件：</strong> 如果您的 ACME 服务器支持非标准配置文件，请输入自定义证书配置文件。如果设置了此项，它将覆盖 <code>LETS_ENCRYPT_PROFILE</code>。</td>
</tr>
<tr>
<td><code>LETS_ENCRYPT_MAX_RETRIES</code></td>
<td><code>3</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>最大重试次数：</strong> 证书生成失败时重试的次数。设置为 <code>0</code> 以禁用重试。用于处理临时网络问题或 API 速率限制。</td>
</tr>
</tbody>
</table>
<div class="admonition info">
<p class="admonition-title">信息和行为</p>
<ul>
<li><code>LETS_ENCRYPT_DNS_CREDENTIAL_ITEM</code> 设置是一个多选设置，可用于为 DNS 提供商设置多个项目。这些项目将保存为缓存文件，Certbot 将从中读取凭据。</li>
<li>如果未提供 <code>LETS_ENCRYPT_DNS_PROPAGATION</code> 设置，则使用提供商的默认传播时间。</li>
<li>只要您从外部打开 <code>80/tcp</code> 端口，使用 <code>http</code> 验证的完全 Let's Encrypt 自动化就可以在流模式下工作。使用 <code>LISTEN_STREAM_PORT_SSL</code> 设置来选择您的侦听 SSL/TLS 端口。</li>
<li>如果 <code>LETS_ENCRYPT_PASSTHROUGH</code> 设置为 <code>yes</code>，BunkerWeb 将不会自行处理 ACME 验证请求，而是将它们传递给后端 Web 服务器。这在 BunkerWeb 作为反向代理位于已配置为处理 Let's Encrypt 验证的另一台服务器前面的场景中很有用。</li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">HTTP 与 DNS 验证</p>
<p><strong>HTTP 验证</strong> 更容易设置，并且适用于大多数网站：</p>
<ul>
<li>要求您的网站在端口 80 上可公开访问</li>
<li>由 BunkerWeb 自动配置</li>
<li>不能用于通配符证书</li>
</ul>
<p><strong>DNS 验证</strong> 提供更大的灵活性，并且是通配符证书所必需的：</p>
<ul>
<li>即使您的网站无法公开访问也能正常工作</li>
<li>需要 DNS 提供商的 API 凭据</li>
<li>通配符证书（例如 *.example.com）所必需</li>
<li>在端口 80 被阻止或不可用时很有用</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">通配符证书</p>
<p>通配符证书仅适用于 DNS 验证。如果要使用它们，必须将 <code>USE_LETS_ENCRYPT_WILDCARD</code> 设置为 <code>yes</code> 并正确配置您的 DNS 提供商凭据。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">速率限制</p>
<p>Let's Encrypt 对证书颁发施加速率限制。在测试配置时，通过将 <code>USE_LETS_ENCRYPT_STAGING</code> 设置为 <code>yes</code> 来使用测试环境，以避免达到生产环境的速率限制。测试证书不受浏览器信任，但对于验证您的设置很有用。</p>
</div>
<h3 id="zh-features-dns">支持的 DNS 提供商</h3>
<p>Let's Encrypt 插件支持广泛的 DNS 提供商进行 DNS 验证。每个提供商都需要使用 <code>LETS_ENCRYPT_DNS_CREDENTIAL_ITEM</code> 设置提供特定的凭据。</p>
<table>
<thead>
<tr>
<th>提供商</th>
<th>描述</th>
<th>强制性设置</th>
<th>可选设置</th>
<th>文档</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bunny</code></td>
<td>bunny.net</td>
<td><code>api_key</code></td>
<td></td>
<td><a href="https://github.com/mwt/certbot-dns-bunny/blob/main/README.rst">文档</a></td>
</tr>
<tr>
<td><code>cloudflare</code></td>
<td>Cloudflare</td>
<td><code>api_token</code> 或 <code>email</code> 和 <code>api_key</code></td>
<td></td>
<td><a href="https://certbot-dns-cloudflare.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>desec</code></td>
<td>deSEC</td>
<td><code>token</code></td>
<td></td>
<td><a href="https://github.com/desec-io/certbot-dns-desec/blob/main/README.md">文档</a></td>
</tr>
<tr>
<td><code>digitalocean</code></td>
<td>DigitalOcean</td>
<td><code>token</code></td>
<td></td>
<td><a href="https://certbot-dns-digitalocean.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>domainoffensive</code></td>
<td>Domain-Offensive</td>
<td><code>api_token</code></td>
<td></td>
<td><a href="https://github.com/domainoffensive/certbot-dns-domainoffensive/blob/master/README.md">文档</a></td>
</tr>
<tr>
<td><code>dnsimple</code></td>
<td>DNSimple</td>
<td><code>token</code></td>
<td></td>
<td><a href="https://certbot-dns-dnsimple.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>dnsmadeeasy</code></td>
<td>DNS Made Easy</td>
<td><code>api_key</code><br><code>secret_key</code></td>
<td></td>
<td><a href="https://certbot-dns-dnsmadeeasy.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>dynu</code></td>
<td>Dynu</td>
<td><code>auth_token</code></td>
<td></td>
<td><a href="https://github.com/bikram990/certbot-dns-dynu/blob/main/README.md">文档</a></td>
</tr>
<tr>
<td><code>gehirn</code></td>
<td>Gehirn DNS</td>
<td><code>api_token</code><br><code>api_secret</code></td>
<td></td>
<td><a href="https://certbot-dns-gehirn.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>google</code></td>
<td>Google Cloud</td>
<td><code>project_id</code><br><code>private_key_id</code><br><code>private_key</code><br><code>client_email</code><br><code>client_id</code><br><code>client_x509_cert_url</code></td>
<td><code>type</code> (默认: <code>service_account</code>)<br><code>auth_uri</code> (默认: <code>https://accounts.google.com/o/oauth2/auth</code>)<br><code>token_uri</code> (默认: <code>https://accounts.google.com/o/oauth2/token</code>)<br><code>auth_provider_x509_cert_url</code> (默认: <code>https://www.googleapis.com/oauth2/v1/certs</code>)</td>
<td><a href="https://certbot-dns-google.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>infomaniak</code></td>
<td>Infomaniak</td>
<td><code>token</code></td>
<td></td>
<td><a href="https://github.com/infomaniak/certbot-dns-infomaniak/blob/main/README.rst">文档</a></td>
</tr>
<tr>
<td><code>ionos</code></td>
<td>IONOS</td>
<td><code>prefix</code><br><code>secret</code></td>
<td><code>endpoint</code> (默认: <code>https://api.hosting.ionos.com</code>)</td>
<td><a href="https://github.com/helgeerbe/certbot-dns-ionos/blob/master/README.md">文档</a></td>
</tr>
<tr>
<td><code>linode</code></td>
<td>Linode</td>
<td><code>key</code></td>
<td></td>
<td><a href="https://certbot-dns-linode.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>luadns</code></td>
<td>LuaDNS</td>
<td><code>email</code><br><code>token</code></td>
<td></td>
<td><a href="https://certbot-dns-luadns.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>njalla</code></td>
<td>Njalla</td>
<td><code>token</code></td>
<td></td>
<td><a href="https://github.com/chaptergy/certbot-dns-njalla/blob/main/README.md">文档</a></td>
</tr>
<tr>
<td><code>nsone</code></td>
<td>NS1</td>
<td><code>api_key</code></td>
<td></td>
<td><a href="https://certbot-dns-nsone.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>ovh</code></td>
<td>OVH</td>
<td><code>application_key</code><br><code>application_secret</code><br><code>consumer_key</code></td>
<td><code>endpoint</code> (默认: <code>ovh-eu</code>)</td>
<td><a href="https://certbot-dns-ovh.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>rfc2136</code></td>
<td>RFC 2136</td>
<td><code>server</code><br><code>name</code><br><code>secret</code></td>
<td><code>port</code> (默认: <code>53</code>)<br><code>algorithm</code> (默认: <code>HMAC-SHA512</code>)<br><code>sign_query</code> (默认: <code>false</code>)</td>
<td><a href="https://certbot-dns-rfc2136.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>route53</code></td>
<td>Amazon Route 53</td>
<td><code>access_key_id</code><br><code>secret_access_key</code></td>
<td></td>
<td><a href="https://certbot-dns-route53.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>sakuracloud</code></td>
<td>Sakura Cloud</td>
<td><code>api_token</code><br><code>api_secret</code></td>
<td></td>
<td><a href="https://certbot-dns-sakuracloud.readthedocs.io/en/stable/">文档</a></td>
</tr>
<tr>
<td><code>scaleway</code></td>
<td>Scaleway</td>
<td><code>application_token</code></td>
<td></td>
<td><a href="https://github.com/vanonox/certbot-dns-scaleway/blob/main/README.rst">文档</a></td>
</tr>
</tbody>
</table>
<h3 id="zh-features-_71">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="26:6"><input checked="checked" id="zh-features-__tabbed_26_1" name="zh-features-__tabbed_26" type="radio" /><input id="zh-features-__tabbed_26_2" name="zh-features-__tabbed_26" type="radio" /><input id="zh-features-__tabbed_26_3" name="zh-features-__tabbed_26" type="radio" /><input id="zh-features-__tabbed_26_4" name="zh-features-__tabbed_26" type="radio" /><input id="zh-features-__tabbed_26_5" name="zh-features-__tabbed_26" type="radio" /><input id="zh-features-__tabbed_26_6" name="zh-features-__tabbed_26" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_26_1">基本 HTTP 验证</label><label for="zh-features-__tabbed_26_2">使用通配符的 Cloudflare DNS</label><label for="zh-features-__tabbed_26_3">AWS Route53 配置</label><label for="zh-features-__tabbed_26_4">使用测试环境和重试进行测试</label><label for="zh-features-__tabbed_26_5">具有自定义传播时间的 DigitalOcean</label><label for="zh-features-__tabbed_26_6">Google Cloud DNS</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>使用 HTTP 验证为单个域进行简单配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">AUTO_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">EMAIL_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin@example.com&quot;</span>
<span class="nt">LETS_ENCRYPT_CHALLENGE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用 Cloudflare DNS 为通配符证书进行配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">AUTO_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">EMAIL_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin@example.com&quot;</span>
<span class="nt">LETS_ENCRYPT_CHALLENGE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;dns&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_PROVIDER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cloudflare&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_CREDENTIAL_ITEM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;api_token</span><span class="nv"> </span><span class="s">YOUR_API_TOKEN&quot;</span>
<span class="nt">USE_LETS_ENCRYPT_WILDCARD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用 Amazon Route53 进行 DNS 验证的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">AUTO_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">EMAIL_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin@example.com&quot;</span>
<span class="nt">LETS_ENCRYPT_CHALLENGE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;dns&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_PROVIDER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;route53&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_CREDENTIAL_ITEM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;aws_access_key_id</span><span class="nv"> </span><span class="s">YOUR_ACCESS_KEY&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_CREDENTIAL_ITEM_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;aws_secret_access_key</span><span class="nv"> </span><span class="s">YOUR_SECRET_KEY&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用测试环境和增强的重试设置进行测试的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">AUTO_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">EMAIL_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin@example.com&quot;</span>
<span class="nt">LETS_ENCRYPT_CHALLENGE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http&quot;</span>
<span class="nt">USE_LETS_ENCRYPT_STAGING</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">LETS_ENCRYPT_MAX_RETRIES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用 DigitalOcean DNS 并设置更长传播等待时间的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">AUTO_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">EMAIL_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin@example.com&quot;</span>
<span class="nt">LETS_ENCRYPT_CHALLENGE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;dns&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_PROVIDER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;digitalocean&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_CREDENTIAL_ITEM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;token</span><span class="nv"> </span><span class="s">YOUR_API_TOKEN&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_PROPAGATION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;120&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用 Google Cloud DNS 和服务帐户凭据的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">AUTO_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">EMAIL_LETS_ENCRYPT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin@example.com&quot;</span>
<span class="nt">LETS_ENCRYPT_CHALLENGE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;dns&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_PROVIDER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;google&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_CREDENTIAL_ITEM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;project_id</span><span class="nv"> </span><span class="s">your-project-id&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_CREDENTIAL_ITEM_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;private_key_id</span><span class="nv"> </span><span class="s">your-private-key-id&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_CREDENTIAL_ITEM_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;private_key</span><span class="nv"> </span><span class="s">your-private-key&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_CREDENTIAL_ITEM_4</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;client_email</span><span class="nv"> </span><span class="s">your-service-account-email&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_CREDENTIAL_ITEM_5</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;client_id</span><span class="nv"> </span><span class="s">your-client-id&quot;</span>
<span class="nt">LETS_ENCRYPT_DNS_CREDENTIAL_ITEM_6</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;client_x509_cert_url</span><span class="nv"> </span><span class="s">your-cert-url&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-limit">Limit</h2>
<p>STREAM 支持 <img alt="⚠" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/26a0.svg" title=":warning:" /></p>
<p>BunkerWeb 中的限制插件提供了强大的功能来对您的网站强制执行限制策略，确保公平使用并保护您的资源免受滥用、拒绝服务攻击和过度的资源消耗。这些策略包括：</p>
<ul>
<li><strong>每个 IP 地址的连接数</strong> (流支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" />)</li>
<li><strong>在特定时间段内每个 IP 地址和 URL 的请求数</strong> (流支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" />)</li>
</ul>
<h3 id="zh-features-_72">工作原理</h3>
<ol>
<li><strong>速率限制：</strong> 跟踪来自每个客户端 IP 地址到特定 URL 的请求数。如果客户端超过配置的速率限制，后续请求将被暂时拒绝。</li>
<li><strong>连接限制：</strong> 监控并限制来自每个客户端 IP 地址的并发连接数。可以根据使用的协议（HTTP/1、HTTP/2、HTTP/3 或流）应用不同的连接限制。</li>
<li>在这两种情况下，超过定义限制的客户端都会收到一个 HTTP 状态码 <strong>“429 - 请求过多”</strong>，这有助于防止服务器过载。</li>
</ol>
<h3 id="zh-features-_73">使用步骤</h3>
<ol>
<li><strong>启用请求速率限制：</strong> 使用 <code>USE_LIMIT_REQ</code> 启用请求速率限制，并定义 URL 模式及其相应的速率限制。</li>
<li><strong>启用连接限制：</strong> 使用 <code>USE_LIMIT_CONN</code> 启用连接限制，并为不同协议设置最大并发连接数。</li>
<li><strong>应用精细控制：</strong> 为不同的 URL 创建多个速率限制规则，以便在您的网站上提供不同级别的保护。</li>
<li><strong>监控有效性：</strong> 使用<a href="#zh-web-ui">Web UI</a>查看有关受限请求和连接的统计信息。</li>
</ol>
<h3 id="zh-features-_74">配置设置</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="27:2"><input checked="checked" id="zh-features-__tabbed_27_1" name="zh-features-__tabbed_27" type="radio" /><input id="zh-features-__tabbed_27_2" name="zh-features-__tabbed_27" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_27_1">请求速率限制</label><label for="zh-features-__tabbed_27_2">连接限制</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_LIMIT_REQ</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用请求限制：</strong> 设置为 <code>yes</code> 以启用请求速率限制功能。</td>
</tr>
<tr>
<td><code>LIMIT_REQ_URL</code></td>
<td><code>/</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>URL 模式：</strong> 将应用速率限制的 URL 模式（PCRE 正则表达式）；使用 <code>/</code> 以应用于所有请求。</td>
</tr>
<tr>
<td><code>LIMIT_REQ_RATE</code></td>
<td><code>2r/s</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>速率限制：</strong> 最大请求速率，格式为 <code>Nr/t</code>，其中 N 是请求数，t 是时间单位：s（秒）、m（分钟）、h（小时）或 d（天）。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">速率限制格式</p>
<p>速率限制格式指定为 <code>Nr/t</code>，其中：</p>
<ul>
<li><code>N</code> 是允许的请求数</li>
<li><code>r</code> 是字面上的 'r'（代表 'requests'）</li>
<li><code>/</code> 是字面上的斜杠</li>
<li><code>t</code> 是时间单位：<code>s</code>（秒）、<code>m</code>（分钟）、<code>h</code>（小时）或 <code>d</code>（天）</li>
</ul>
<p>例如，<code>5r/m</code> 表示每个 IP 地址每分钟允许 5 个请求。</p>
</div>
</div>
<div class="tabbed-block">
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_LIMIT_CONN</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用连接限制：</strong> 设置为 <code>yes</code> 以启用连接限制功能。</td>
</tr>
<tr>
<td><code>LIMIT_CONN_MAX_HTTP1</code></td>
<td><code>10</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>HTTP/1.X 连接数：</strong> 每个 IP 地址的最大并发 HTTP/1.X 连接数。</td>
</tr>
<tr>
<td><code>LIMIT_CONN_MAX_HTTP2</code></td>
<td><code>100</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>HTTP/2 流数：</strong> 每个 IP 地址的最大并发 HTTP/2 流数。</td>
</tr>
<tr>
<td><code>LIMIT_CONN_MAX_HTTP3</code></td>
<td><code>100</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>HTTP/3 流数：</strong> 每个 IP 地址的最大并发 HTTP/3 流数。</td>
</tr>
<tr>
<td><code>LIMIT_CONN_MAX_STREAM</code></td>
<td><code>10</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>流连接数：</strong> 每个 IP 地址的最大并发流连接数。</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="admonition info">
<p class="admonition-title">连接限制与请求限制</p>
<ul>
<li><strong>连接限制</strong> 限制单个 IP 地址可以维持的并发连接数。</li>
<li><strong>请求速率限制</strong> 限制一个 IP 地址在定义的时间段内可以发出的请求数。</li>
</ul>
<p>同时使用这两种方法可以全面防护各种类型的滥用。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">设置适当的限制</p>
<p>设置过于严格的限制可能会影响合法用户，特别是对于 HTTP/2 和 HTTP/3，浏览器通常会使用多个流。默认值在大多数用例中是平衡的，但请考虑根据您的应用程序需求和用户行为进行调整。</p>
</div>
<h3 id="zh-features-_75">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="28:4"><input checked="checked" id="zh-features-__tabbed_28_1" name="zh-features-__tabbed_28" type="radio" /><input id="zh-features-__tabbed_28_2" name="zh-features-__tabbed_28" type="radio" /><input id="zh-features-__tabbed_28_3" name="zh-features-__tabbed_28" type="radio" /><input id="zh-features-__tabbed_28_4" name="zh-features-__tabbed_28" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_28_1">基本保护</label><label for="zh-features-__tabbed_28_2">保护特定端点</label><label for="zh-features-__tabbed_28_3">高流量网站配置</label><label for="zh-features-__tabbed_28_4">API 服务器配置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个使用默认设置来保护您整个网站的简单配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_LIMIT_REQ</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">LIMIT_REQ_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="nt">LIMIT_REQ_RATE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2r/s&quot;</span>

<span class="nt">USE_LIMIT_CONN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP1</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100&quot;</span>
<span class="nt">LIMIT_CONN_MAX_STREAM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>针对不同端点设置不同速率限制的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_LIMIT_REQ</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>

<span class="c1"># 针对所有请求的默认规则</span>
<span class="nt">LIMIT_REQ_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="nt">LIMIT_REQ_RATE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10r/s&quot;</span>

<span class="c1"># 对登录页面设置更严格的限制</span>
<span class="nt">LIMIT_REQ_URL_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^/login&quot;</span>
<span class="nt">LIMIT_REQ_RATE_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1r/s&quot;</span>

<span class="c1"># 对 API 设置更严格的限制</span>
<span class="nt">LIMIT_REQ_URL_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^/api/&quot;</span>
<span class="nt">LIMIT_REQ_RATE_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5r/s&quot;</span>

<span class="nt">USE_LIMIT_CONN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP1</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100&quot;</span>
<span class="nt">LIMIT_CONN_MAX_STREAM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>为高流量网站调整的配置，具有更宽松的限制：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_LIMIT_REQ</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>

<span class="c1"># 通用限制</span>
<span class="nt">LIMIT_REQ_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="nt">LIMIT_REQ_RATE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30r/s&quot;</span>

<span class="c1"># 管理区域保护</span>
<span class="nt">LIMIT_REQ_URL_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^/admin/&quot;</span>
<span class="nt">LIMIT_REQ_RATE_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5r/s&quot;</span>

<span class="nt">USE_LIMIT_CONN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP1</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;50&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;200&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;200&quot;</span>
<span class="nt">LIMIT_CONN_MAX_STREAM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>为 API 服务器优化的配置，速率限制以每分钟请求数表示：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_LIMIT_REQ</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>

<span class="c1"># 公共 API 端点</span>
<span class="nt">LIMIT_REQ_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^/api/public/&quot;</span>
<span class="nt">LIMIT_REQ_RATE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;120r/m&quot;</span>

<span class="c1"># 私有 API 端点</span>
<span class="nt">LIMIT_REQ_URL_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^/api/private/&quot;</span>
<span class="nt">LIMIT_REQ_RATE_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;300r/m&quot;</span>

<span class="c1"># 认证端点</span>
<span class="nt">LIMIT_REQ_URL_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^/api/auth&quot;</span>
<span class="nt">LIMIT_REQ_RATE_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10r/m&quot;</span>

<span class="nt">USE_LIMIT_CONN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP1</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;20&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100&quot;</span>
<span class="nt">LIMIT_CONN_MAX_HTTP3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100&quot;</span>
<span class="nt">LIMIT_CONN_MAX_STREAM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;20&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-load-balancer-pro">Load Balancer <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style='transform : translateY(3px);'> (PRO)</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>Provides load balancing feature to group of upstreams with optional healthchecks.</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>上下文</th>
<th>可重复</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LOADBALANCER_HEALTHCHECK_DICT_SIZE</code></td>
<td><code>10m</code></td>
<td>global</td>
<td>否</td>
<td>Shared dict size (datastore for all healthchecks).</td>
</tr>
<tr>
<td><code>LOADBALANCER_UPSTREAM_NAME</code></td>
<td></td>
<td>global</td>
<td>是</td>
<td>Name of the upstream (used in REVERSE_PROXY_HOST).</td>
</tr>
<tr>
<td><code>LOADBALANCER_UPSTREAM_SERVERS</code></td>
<td></td>
<td>global</td>
<td>是</td>
<td>List of servers/IPs in the server group.</td>
</tr>
<tr>
<td><code>LOADBALANCER_UPSTREAM_MODE</code></td>
<td><code>round-robin</code></td>
<td>global</td>
<td>是</td>
<td>Load balancing mode (round-robin or sticky).</td>
</tr>
<tr>
<td><code>LOADBALANCER_UPSTREAM_STICKY_METHOD</code></td>
<td><code>ip</code></td>
<td>global</td>
<td>是</td>
<td>Sticky session method (ip or cookie).</td>
</tr>
<tr>
<td><code>LOADBALANCER_UPSTREAM_RESOLVE</code></td>
<td><code>no</code></td>
<td>global</td>
<td>是</td>
<td>Dynamically resolve upstream hostnames.</td>
</tr>
<tr>
<td><code>LOADBALANCER_UPSTREAM_KEEPALIVE_TIMEOUT</code></td>
<td><code>60s</code></td>
<td>global</td>
<td>是</td>
<td>Keepalive timeout for upstream connections.</td>
</tr>
<tr>
<td><code>LOADBALANCER_UPSTREAM_KEEPALIVE_TIME</code></td>
<td><code>1h</code></td>
<td>global</td>
<td>是</td>
<td>Keepalive time for upstream connections.</td>
</tr>
<tr>
<td><code>LOADBALANCER_HEALTHCHECK_URL</code></td>
<td><code>/status</code></td>
<td>global</td>
<td>是</td>
<td>The healthcheck URL.</td>
</tr>
<tr>
<td><code>LOADBALANCER_HEALTHCHECK_INTERVAL</code></td>
<td><code>2000</code></td>
<td>global</td>
<td>是</td>
<td>Healthcheck interval in milliseconds.</td>
</tr>
<tr>
<td><code>LOADBALANCER_HEALTHCHECK_TIMEOUT</code></td>
<td><code>1000</code></td>
<td>global</td>
<td>是</td>
<td>Healthcheck timeout in milliseconds.</td>
</tr>
<tr>
<td><code>LOADBALANCER_HEALTHCHECK_FALL</code></td>
<td><code>3</code></td>
<td>global</td>
<td>是</td>
<td>Number of failed healthchecks before marking the server as down.</td>
</tr>
<tr>
<td><code>LOADBALANCER_HEALTHCHECK_RISE</code></td>
<td><code>1</code></td>
<td>global</td>
<td>是</td>
<td>Number of successful healthchecks before marking the server as up.</td>
</tr>
<tr>
<td><code>LOADBALANCER_HEALTHCHECK_VALID_STATUSES</code></td>
<td><code>200</code></td>
<td>global</td>
<td>是</td>
<td>HTTP status considered valid in healthchecks.</td>
</tr>
<tr>
<td><code>LOADBALANCER_HEALTHCHECK_CONCURRENCY</code></td>
<td><code>10</code></td>
<td>global</td>
<td>是</td>
<td>Maximum number of concurrent healthchecks.</td>
</tr>
<tr>
<td><code>LOADBALANCER_HEALTHCHECK_TYPE</code></td>
<td><code>http</code></td>
<td>global</td>
<td>是</td>
<td>Type of healthcheck (http or https).</td>
</tr>
<tr>
<td><code>LOADBALANCER_HEALTHCHECK_SSL_VERIFY</code></td>
<td><code>yes</code></td>
<td>global</td>
<td>是</td>
<td>Verify SSL certificate in healthchecks.</td>
</tr>
<tr>
<td><code>LOADBALANCER_HEALTHCHECK_HOST</code></td>
<td></td>
<td>global</td>
<td>是</td>
<td>Host header for healthchecks (useful for HTTPS).</td>
</tr>
</tbody>
</table>
<h2 id="zh-features-metrics">Metrics</h2>
<p>STREAM 支持 <img alt="⚠" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/26a0.svg" title=":warning:" /></p>
<p>指标插件为您的 BunkerWeb 实例提供全面的监控和数据收集功能。此功能使您能够跟踪各种性能指标、安全事件和系统统计信息，从而为您提供有关受保护网站和服务行为及健康状况的宝贵见解。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>BunkerWeb 在处理请求和响应期间收集关键指标。</li>
<li>这些指标包括被阻止请求的计数器、性能测量以及各种与安全相关的统计信息。</li>
<li>数据高效地存储在内存中，并具有可配置的限制以防止过多的资源使用。</li>
<li>对于多实例设置，可以使用 Redis 来集中和聚合指标数据。</li>
<li>收集到的指标可以通过 API 访问或在<a href="#zh-web-ui">Web UI</a>中可视化。</li>
<li>此信息可帮助您识别安全威胁、解决问题并优化您的配置。</li>
</ol>
<h3 id="zh-features-_76">技术实现</h3>
<p>指标插件的工作方式如下：</p>
<ul>
<li>在 NGINX 中使用共享字典，其中 <code>metrics_datastore</code> 用于 HTTP，<code>metrics_datastore_stream</code> 用于 TCP/UDP 流量</li>
<li>利用 LRU 缓存进行高效的内存存储</li>
<li>使用计时器在工作进程之间定期同步数据</li>
<li>存储有关被阻止请求的详细信息，包括客户端 IP 地址、国家/地区、时间戳、请求详情和阻止原因</li>
<li>通过通用的指标收集接口支持插件特定的指标</li>
<li>提供用于查询收集到的指标的 API 端点</li>
</ul>
<h3 id="zh-features-_77">如何使用</h3>
<p>请按照以下步骤配置和使用指标功能：</p>
<ol>
<li><strong>启用该功能：</strong> 指标收集默认启用。您可以使用 <code>USE_METRICS</code> 设置来控制此功能。</li>
<li><strong>配置内存分配：</strong> 使用 <code>METRICS_MEMORY_SIZE</code> 设置来设置用于指标存储的内存量。</li>
<li><strong>设置存储限制：</strong> 使用相应的设置定义每个工作进程和 Redis 中要存储的被阻止请求的数量。</li>
<li><strong>访问数据：</strong> 通过<a href="#zh-web-ui">Web UI</a>或 API 端点查看收集到的指标。</li>
<li><strong>分析信息：</strong> 使用收集到的数据来识别模式、检测安全问题并优化您的配置。</li>
</ol>
<h3 id="zh-features-_78">收集的指标</h3>
<p>指标插件收集以下信息：</p>
<ol>
<li>
<p><strong>被阻止的请求</strong>：对于每个被阻止的请求，将存储以下数据：</p>
<ul>
<li>请求 ID 和时间戳</li>
<li>客户端 IP 地址和国家/地区（如果可用）</li>
<li>HTTP 方法和 URL</li>
<li>HTTP 状态码</li>
<li>用户代理</li>
<li>阻止原因和安全模式</li>
<li>服务器名称</li>
<li>与阻止原因相关的其他数据</li>
</ul>
</li>
<li>
<p><strong>插件计数器</strong>：跟踪活动和事件的各种插件特定计数器。</p>
</li>
</ol>
<h3 id="zh-features-api">API 访问</h3>
<p>指标数据可以通过 BunkerWeb 的内部 API 端点访问：</p>
<ul>
<li><strong>端点</strong>：<code>/metrics/{filter}</code></li>
<li><strong>方法</strong>：GET</li>
<li><strong>描述</strong>：根据指定的过滤器检索指标数据</li>
<li><strong>响应格式</strong>：包含所请求指标的 JSON 对象</li>
</ul>
<p>例如，<code>/metrics/requests</code> 返回有关被阻止请求的信息。</p>
<div class="admonition info">
<p class="admonition-title">API 访问配置</p>
<p>要通过 API 访问指标，您必须确保：</p>
<ol>
<li>API 功能已通过 <code>USE_API: "yes"</code> 启用（默认启用）</li>
<li>您的客户端 IP 包含在 <code>API_WHITELIST_IP</code> 设置中（默认为 <code>127.0.0.0/8</code>）</li>
<li>您正在通过配置的端口访问 API（默认为 <code>5000</code>，通过 <code>API_HTTP_PORT</code> 设置）</li>
<li>您在 Host 标头中使用了正确的 <code>API_SERVER_NAME</code> 值（默认为 <code>bwapi</code>）</li>
<li>如果配置了 <code>API_TOKEN</code>，请在请求标头中包含 <code>Authorization: Bearer &lt;token&gt;</code>。</li>
</ol>
<p>典型请求：</p>
<p>不带令牌（当未设置 <code>API_TOKEN</code> 时）：
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Host: bwapi&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>http://your-bunkerweb-instance:5000/metrics/requests
</code></pre></div></p>
<p>带令牌（当设置了 <code>API_TOKEN</code> 时）：
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Host: bwapi&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$API_TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>http://your-bunkerweb-instance:5000/metrics/requests
</code></pre></div></p>
<p>如果您已将 <code>API_SERVER_NAME</code> 自定义为默认 <code>bwapi</code> 以外的值，请在 Host 标头中使用该值。</p>
<p>对于安全的生产环境，请将 API 访问限制为受信任的 IP，并启用 <code>API_TOKEN</code>。</p>
</div>
<h3 id="zh-features-_79">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_METRICS</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用指标：</strong> 设置为 <code>yes</code> 以启用指标的收集和检索。</td>
</tr>
<tr>
<td><code>METRICS_MEMORY_SIZE</code></td>
<td><code>16m</code></td>
<td>global</td>
<td>否</td>
<td><strong>内存大小：</strong> 指标内部存储的大小（例如，<code>16m</code>、<code>32m</code>）。</td>
</tr>
<tr>
<td><code>METRICS_MAX_BLOCKED_REQUESTS</code></td>
<td><code>1000</code></td>
<td>global</td>
<td>否</td>
<td><strong>最大被阻止请求数：</strong> 每个工作进程要存储的最大被阻止请求数。</td>
</tr>
<tr>
<td><code>METRICS_MAX_BLOCKED_REQUESTS_REDIS</code></td>
<td><code>100000</code></td>
<td>global</td>
<td>否</td>
<td><strong>Redis 最大被阻止请求数：</strong> 在 Redis 中要存储的最大被阻止请求数。</td>
</tr>
<tr>
<td><code>METRICS_SAVE_TO_REDIS</code></td>
<td><code>yes</code></td>
<td>global</td>
<td>否</td>
<td><strong>将指标保存到 Redis：</strong> 设置为 <code>yes</code> 以将指标（计数器和表）保存到 Redis，以实现集群范围的聚合。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">调整内存分配大小</p>
<p>应根据您的流量和实例数量调整 <code>METRICS_MEMORY_SIZE</code> 设置。对于高流量网站，请考虑增加此值以确保所有指标都能被捕获而不会丢失数据。</p>
</div>
<div class="admonition info">
<p class="admonition-title">Redis 集成</p>
<p>当 BunkerWeb 配置为使用<a href="#zh-features-redis">Redis</a>时，指标插件将自动将被阻止的请求数据同步到 Redis 服务器。这提供了跨多个 BunkerWeb 实例的安全事件的集中视图。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">性能注意事项</p>
<p>为 <code>METRICS_MAX_BLOCKED_REQUESTS</code> 或 <code>METRICS_MAX_BLOCKED_REQUESTS_REDIS</code> 设置非常高的值会增加内存使用量。请监控您的系统资源，并根据您的实际需求和可用资源调整这些值。</p>
</div>
<div class="admonition note">
<p class="admonition-title">工作进程特定存储</p>
<p>每个 NGINX 工作进程都在内存中维护自己的指标。通过 API 访问指标时，会自动聚合所有工作进程的数据以提供完整的视图。</p>
</div>
<h3 id="zh-features-_80">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="29:4"><input checked="checked" id="zh-features-__tabbed_29_1" name="zh-features-__tabbed_29" type="radio" /><input id="zh-features-__tabbed_29_2" name="zh-features-__tabbed_29" type="radio" /><input id="zh-features-__tabbed_29_3" name="zh-features-__tabbed_29" type="radio" /><input id="zh-features-__tabbed_29_4" name="zh-features-__tabbed_29" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_29_1">基本配置</label><label for="zh-features-__tabbed_29_2">低资源环境</label><label for="zh-features-__tabbed_29_3">高流量环境</label><label for="zh-features-__tabbed_29_4">禁用指标</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>适用于大多数部署的默认配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_METRICS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">METRICS_MEMORY_SIZE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;16m&quot;</span>
<span class="nt">METRICS_MAX_BLOCKED_REQUESTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1000&quot;</span>
<span class="nt">METRICS_MAX_BLOCKED_REQUESTS_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100000&quot;</span>
<span class="nt">METRICS_SAVE_TO_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>为资源有限的环境优化的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_METRICS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">METRICS_MEMORY_SIZE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8m&quot;</span>
<span class="nt">METRICS_MAX_BLOCKED_REQUESTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500&quot;</span>
<span class="nt">METRICS_MAX_BLOCKED_REQUESTS_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10000&quot;</span>
<span class="nt">METRICS_SAVE_TO_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>需要跟踪更多安全事件的高流量网站的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_METRICS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">METRICS_MEMORY_SIZE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;64m&quot;</span>
<span class="nt">METRICS_MAX_BLOCKED_REQUESTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5000&quot;</span>
<span class="nt">METRICS_MAX_BLOCKED_REQUESTS_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500000&quot;</span>
<span class="nt">METRICS_SAVE_TO_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>禁用指标收集的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_METRICS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-migration-pro">Migration <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style='transform : translateY(3px);'> (PRO)</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>Migration of BunkerWeb configuration between instances made easy via the web UI</p>
<h2 id="zh-features-miscellaneous">Miscellaneous</h2>
<p>STREAM 支持 <img alt="⚠" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/26a0.svg" title=":warning:" /></p>
<p>杂项插件提供了<strong>必要的基准设置</strong>，有助于维护您网站的安全性和功能性。这个核心组件提供了全面的控制，包括：</p>
<ul>
<li><strong>服务器行为</strong> - 配置您的服务器如何响应各种请求</li>
<li><strong>HTTP 设置</strong> - 管理方法、请求大小和协议选项</li>
<li><strong>文件管理</strong> - 控制静态文件的提供并优化交付</li>
<li><strong>协议支持</strong> - 启用现代 HTTP 协议以获得更好的性能</li>
<li><strong>系统配置</strong> - 扩展功能并提高安全性</li>
</ul>
<p>无论您是需要限制 HTTP 方法、管理请求大小、优化文件缓存，还是控制服务器如何响应各种请求，此插件都为您提供了<strong>微调 Web 服务行为</strong>的工具，同时优化了性能和安全性。</p>
<h3 id="zh-features-_81">主要功能</h3>
<table>
<thead>
<tr>
<th>功能类别</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>HTTP 方法控制</strong></td>
<td>定义您的应用程序可接受哪些 HTTP 方法</td>
</tr>
<tr>
<td><strong>默认服务器保护</strong></td>
<td>防止通过主机名不匹配进行未经授权的访问，并强制使用 SNI 以确保安全连接</td>
</tr>
<tr>
<td><strong>请求大小管理</strong></td>
<td>为客户端请求体和文件上传设置限制</td>
</tr>
<tr>
<td><strong>静态文件服务</strong></td>
<td>配置和优化从自定义根文件夹交付静态内容</td>
</tr>
<tr>
<td><strong>文件缓存</strong></td>
<td>通过具有可自定义设置的高级文件描述符缓存机制提高性能</td>
</tr>
<tr>
<td><strong>协议支持</strong></td>
<td>配置现代 HTTP 协议选项 (HTTP2/HTTP3) 和 Alt-Svc 端口设置</td>
</tr>
<tr>
<td><strong>匿名报告</strong></td>
<td>可选的使用统计报告，以帮助改进 BunkerWeb</td>
</tr>
<tr>
<td><strong>外部插件支持</strong></td>
<td>通过 URL 集成外部插件来扩展功能</td>
</tr>
<tr>
<td><strong>HTTP 状态控制</strong></td>
<td>配置您的服务器在拒绝请求时的响应方式（包括终止连接）</td>
</tr>
</tbody>
</table>
<h3 id="zh-features-_82">配置指南</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="30:8"><input checked="checked" id="zh-features-__tabbed_30_1" name="zh-features-__tabbed_30" type="radio" /><input id="zh-features-__tabbed_30_2" name="zh-features-__tabbed_30" type="radio" /><input id="zh-features-__tabbed_30_3" name="zh-features-__tabbed_30" type="radio" /><input id="zh-features-__tabbed_30_4" name="zh-features-__tabbed_30" type="radio" /><input id="zh-features-__tabbed_30_5" name="zh-features-__tabbed_30" type="radio" /><input id="zh-features-__tabbed_30_6" name="zh-features-__tabbed_30" type="radio" /><input id="zh-features-__tabbed_30_7" name="zh-features-__tabbed_30" type="radio" /><input id="zh-features-__tabbed_30_8" name="zh-features-__tabbed_30" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_30_1">默认服务器安全</label><label for="zh-features-__tabbed_30_2">拒绝 HTTP 状态</label><label for="zh-features-__tabbed_30_3">HTTP 方法</label><label for="zh-features-__tabbed_30_4">请求大小限制</label><label for="zh-features-__tabbed_30_5">协议支持</label><label for="zh-features-__tabbed_30_6">静态文件服务</label><label for="zh-features-__tabbed_30_7">系统设置</label><label for="zh-features-__tabbed_30_8">文件缓存</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><strong>默认服务器控制</strong></p>
<p>在 HTTP 中，<code>Host</code> 标头指定目标服务器，但它可能缺失或未知，这通常是由于机器人扫描漏洞造成的。</p>
<p>要阻止此类请求：</p>
<ul>
<li>将 <code>DISABLE_DEFAULT_SERVER</code> 设置为 <code>yes</code>，以使用 <a href="https://http.dev/444">NGINX 的 <code>444</code> 状态码</a> 静默拒绝此类请求。</li>
<li>为了更严格的安全性，启用 <code>DISABLE_DEFAULT_SERVER_STRICT_SNI</code> 以拒绝没有有效 SNI 的 SSL/TLS 连接。</li>
</ul>
<div class="admonition success">
<p class="admonition-title">安全优势</p>
<ul>
<li>阻止 Host 标头操纵和虚拟主机扫描</li>
<li>减轻 HTTP 请求走私风险</li>
<li>移除默认服务器作为攻击媒介</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DISABLE_DEFAULT_SERVER</code></td>
<td><code>no</code></td>
<td>global</td>
<td>no</td>
<td><strong>默认服务器：</strong> 设置为 <code>yes</code> 以在没有主机名与请求匹配时禁用默认服务器。</td>
</tr>
<tr>
<td><code>DISABLE_DEFAULT_SERVER_STRICT_SNI</code></td>
<td><code>no</code></td>
<td>global</td>
<td>no</td>
<td><strong>严格 SNI：</strong> 当设置为 <code>yes</code> 时，要求 HTTPS 连接使用 SNI，并拒绝没有有效 SNI 的连接。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">SNI 强制执行</p>
<p>启用严格的 SNI 验证可提供更强的安全性，但如果 BunkerWeb 位于一个转发 HTTPS 请求但未保留 SNI 信息的反向代理之后，可能会导致问题。在生产环境中启用之前请进行彻底测试。</p>
</div>
</div>
<div class="tabbed-block">
<p><strong>HTTP 状态控制</strong></p>
<p>处理被拒绝的客户端访问的第一步是定义适当的操作。这可以使用 <code>DENY_HTTP_STATUS</code> 设置进行配置。当 BunkerWeb 拒绝一个请求时，您可以使用此设置控制其响应。默认情况下，它返回一个 <code>403 Forbidden</code> 状态，并向客户端显示一个网页或自定义内容。</p>
<p>或者，将其设置为 <code>444</code> 会立即关闭连接而不发送任何响应。这个<a href="https://http.dev/444">非标准状态码</a>，特定于 NGINX，对于静默丢弃不需要的请求很有用。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DENY_HTTP_STATUS</code></td>
<td><code>403</code></td>
<td>global</td>
<td>no</td>
<td><strong>拒绝 HTTP 状态：</strong> 请求被拒绝时发送的 HTTP 状态码（403 或 444）。代码 444 会关闭连接。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">444 状态码的注意事项</p>
<p>由于客户端收不到任何反馈，故障排查可能会更具挑战性。只有在您已彻底解决误报问题、对 BunkerWeb 有丰富经验并需要更高安全级别时，才建议设置为 <code>444</code>。</p>
</div>
<div class="admonition info">
<p class="admonition-title">流模式</p>
<p>在<strong>流模式</strong>下，此设置始终强制为 <code>444</code>，这意味着无论配置的值如何，连接都将被关闭。</p>
</div>
</div>
<div class="tabbed-block">
<p><strong>HTTP 方法控制</strong></p>
<p>将 HTTP 方法限制为应用程序所需的那些方法，是遵循最小权限原则的一项基本安全措施。通过明确定义可接受的 HTTP 方法，您可以最大限度地降低通过未使用或危险的方法被利用的风险。</p>
<p>此功能使用 <code>ALLOWED_METHODS</code> 设置进行配置，其中方法用 <code>|</code> 分隔（默认值：<code>GET|POST|HEAD</code>）。如果客户端尝试使用未列出的方法，服务器将以 <strong>405 - Method Not Allowed</strong> 状态响应。</p>
<p>对于大多数网站，默认的 <code>GET|POST|HEAD</code> 就足够了。如果您的应用程序使用 RESTful API，您可能需要包含 <code>PUT</code> 和 <code>DELETE</code> 等方法。</p>
<div class="admonition success">
<p class="admonition-title">安全优势</p>
<ul>
<li>防止利用未使用或不必要的 HTTP 方法</li>
<li>通过禁用可能有害的方法来减少攻击面</li>
<li>阻止攻击者使用的 HTTP 方法枚举技术</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ALLOWED_METHODS</code></td>
<td><code>GET   | POST   | HEAD</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>HTTP 方法：</strong> 允许的 HTTP 方法列表，用竖线字符分隔。</td>
</tr>
</tbody>
</table>
<div class="admonition abstract">
<p class="admonition-title">CORS 和预检请求</p>
<p>如果您的应用程序支持<a href="#zh-features-cors">跨源资源共享 (CORS)</a>，您应该在 <code>ALLOWED_METHODS</code> 设置中包含 <code>OPTIONS</code> 方法以处理预检请求。这确保了浏览器发出跨源请求时的正常功能。</p>
</div>
<div class="admonition danger">
<p class="admonition-title">安全注意事项</p>
<ul>
<li><strong>避免启用 <code>TRACE</code> 或 <code>CONNECT</code>：</strong> 这些方法很少需要，并且可能引入重大的安全风险，例如启用跨站跟踪 (XST) 或隧道攻击。</li>
<li><strong>定期审查允许的方法：</strong> 定期审核 <code>ALLOWED_METHODS</code> 设置，以确保其与您应用程序的当前要求保持一致。</li>
<li><strong>部署前进行彻底测试：</strong> 对 HTTP 方法限制的更改可能会影响应用程序功能。在将其应用于生产环境之前，请在预演环境中验证您的配置。</li>
</ul>
</div>
</div>
<div class="tabbed-block">
<p><strong>请求大小限制</strong></p>
<p>最大请求体大小可以使用 <code>MAX_CLIENT_SIZE</code> 设置进行控制（默认值：<code>10m</code>）。接受的值遵循<a href="https://nginx.org/en/docs/syntax.html">此处</a>描述的语法。</p>
<div class="admonition success">
<p class="admonition-title">安全优势</p>
<ul>
<li>防止由过大负载大小引起的拒绝服务攻击</li>
<li>减轻缓冲区溢出漏洞</li>
<li>防止文件上传攻击</li>
<li>降低服务器资源耗尽的风险</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>MAX_CLIENT_SIZE</code></td>
<td><code>10m</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>最大请求大小：</strong> 客户端请求体（例如文件上传）允许的最大大小。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">请求大小配置最佳实践</p>
<p>如果您需要允许无限大小的请求体，可以将 <code>MAX_CLIENT_SIZE</code> 的值设置为 <code>0</code>。但是，由于潜在的安全和性能风险，<strong>不推荐</strong>这样做。</p>
<p><strong>最佳实践：</strong></p>
<ul>
<li>始终将 <code>MAX_CLIENT_SIZE</code> 配置为满足您应用程序合法要求的最小值。</li>
<li>定期审查和调整此设置，以适应您应用程序不断变化的需求。</li>
<li>除非绝对必要，否则避免设置为 <code>0</code>，因为它可能使您的服务器面临拒绝服务攻击和资源耗尽的风险。</li>
</ul>
<p>通过仔细管理此设置，您可以确保应用程序的最佳安全性和性能。</p>
</div>
</div>
<div class="tabbed-block">
<p><strong>HTTP 协议设置</strong></p>
<p>像 HTTP/2 和 HTTP/3 这样的现代 HTTP 协议可以提高性能和安全性。BunkerWeb 允许轻松配置这些协议。</p>
<div class="admonition success">
<p class="admonition-title">安全和性能优势</p>
<ul>
<li><strong>安全优势：</strong> 像 HTTP/2 和 HTTP/3 这样的现代协议默认强制使用 TLS/HTTPS，减少了对某些攻击的易感性，并通过加密头（HTTP/3）提高了隐私性。</li>
<li><strong>性能优势：</strong> 多路复用、头部压缩、服务器推送和二进制数据传输等功能提高了速度和效率。</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LISTEN_HTTP</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>HTTP 监听：</strong> 当设置为 <code>yes</code> 时，响应（不安全的）HTTP 请求。</td>
</tr>
<tr>
<td><code>HTTP2</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>HTTP2：</strong> 当启用 HTTPS 时，支持 HTTP2 协议。</td>
</tr>
<tr>
<td><code>HTTP3</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>HTTP3：</strong> 当启用 HTTPS 时，支持 HTTP3 协议。</td>
</tr>
<tr>
<td><code>HTTP3_ALT_SVC_PORT</code></td>
<td><code>443</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>HTTP3 Alt-Svc 端口：</strong> 在 Alt-Svc 标头中用于 HTTP3 的端口。</td>
</tr>
</tbody>
</table>
<div class="admonition example">
<p class="admonition-title">关于 HTTP/3</p>
<p>HTTP/3 是超文本传输协议的最新版本，它使用 QUIC over UDP 而不是 TCP，解决了诸如队头阻塞等问题，以实现更快、更可靠的连接。</p>
<p>NGINX 从 1.25.0 版本开始引入了对 HTTP/3 和 QUIC 的实验性支持。但是，此功能仍处于实验阶段，建议在生产中使用时保持谨慎。更多详情，请参阅 <a href="https://nginx.org/en/docs/quic.html">NGINX 的官方文档</a>。</p>
<p>建议在生产环境中启用 HTTP/3 之前进行彻底测试。</p>
</div>
</div>
<div class="tabbed-block">
<p><strong>文件服务配置</strong></p>
<p>BunkerWeb 可以直接提供静态文件，也可以作为应用程序服务器的反向代理。默认情况下，文件从 <code>/var/www/html/{server_name}</code> 提供。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SERVE_FILES</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>提供文件：</strong> 当设置为 <code>yes</code> 时，BunkerWeb 将从配置的根文件夹提供静态文件。</td>
</tr>
<tr>
<td><code>ROOT_FOLDER</code></td>
<td><code>/var/www/html/{server_name}</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>根文件夹：</strong> 提供静态文件的目录。为空表示使用默认位置。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">静态文件服务最佳实践</p>
<ul>
<li><strong>直接服务：</strong> 当 BunkerWeb 负责直接提供静态文件时，启用文件服务 (<code>SERVE_FILES=yes</code>)。</li>
<li><strong>反向代理：</strong> 如果 BunkerWeb 作为反向代理，<strong>停用文件服务</strong> (<code>SERVE_FILES=no</code>) 以减少攻击面并避免暴露不必要的目录。</li>
<li><strong>权限：</strong> 确保正确的文件权限和路径配置，以防止未经授权的访问。</li>
<li><strong>安全：</strong> 避免因配置不当而暴露敏感目录或文件。</li>
</ul>
<p>通过仔细管理静态文件服务，您可以在保持安全环境的同时优化性能。</p>
</div>
</div>
<div class="tabbed-block">
<p><strong>插件和系统管理</strong></p>
<p>这些设置管理 BunkerWeb 与外部系统的交互，并通过可选的匿名使用统计信息为改进产品做出贡献。</p>
<p><strong>匿名报告</strong></p>
<p>匿名报告为 BunkerWeb 团队提供了有关软件使用情况的见解。这有助于确定需要改进的领域并优先开发功能。报告严格是统计性的，不包含任何敏感或个人可识别信息。它们涵盖：</p>
<ul>
<li>启用的功能</li>
<li>通用配置模式</li>
</ul>
<p>如果您愿意，可以通过将 <code>SEND_ANONYMOUS_REPORT</code> 设置为 <code>no</code> 来禁用此功能。</p>
<p><strong>外部插件</strong></p>
<p>外部插件使您能够通过集成第三方模块来扩展 BunkerWeb 的功能。这允许进行额外的定制和高级用例。</p>
<div class="admonition danger">
<p class="admonition-title">外部插件安全</p>
<p><strong>如果未经适当审查，外部插件可能会引入安全风险。</strong> 请遵循以下最佳实践以最大限度地减少潜在威胁：</p>
<ul>
<li>仅使用来自可信来源的插件。</li>
<li>在可用时使用校验和验证插件的完整性。</li>
<li>定期审查和更新插件以确保安全性和兼容性。</li>
</ul>
<p>更多详情，请参阅<a href="#zh-plugins">插件文档</a>。</p>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SEND_ANONYMOUS_REPORT</code></td>
<td><code>yes</code></td>
<td>global</td>
<td>no</td>
<td><strong>匿名报告：</strong> 向 BunkerWeb 维护者发送匿名使用报告。</td>
</tr>
<tr>
<td><code>EXTERNAL_PLUGIN_URLS</code></td>
<td></td>
<td>global</td>
<td>no</td>
<td><strong>外部插件：</strong> 用于下载外部插件的 URL（以空格分隔）。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<p><strong>文件缓存优化</strong></p>
<p>打开文件缓存通过在内存中存储文件描述符和元数据来提高性能，减少了重复文件系统操作的需求。</p>
<div class="admonition success">
<p class="admonition-title">文件缓存的好处</p>
<ul>
<li><strong>性能：</strong> 减少文件系统 I/O，降低延迟，并降低文件操作的 CPU 使用率。</li>
<li><strong>安全：</strong> 通过缓存错误响应来减轻时序攻击，并减少针对文件系统的 DoS 攻击的影响。</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_OPEN_FILE_CACHE</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>启用缓存：</strong> 启用文件描述符和元数据的缓存以提高性能。</td>
</tr>
<tr>
<td><code>OPEN_FILE_CACHE</code></td>
<td><code>max=1000 inactive=20s</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>缓存配置：</strong> 配置打开文件缓存（例如，最大条目数和非活动超时）。</td>
</tr>
<tr>
<td><code>OPEN_FILE_CACHE_ERRORS</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>缓存错误：</strong> 缓存文件描述符查找错误以及成功查找。</td>
</tr>
<tr>
<td><code>OPEN_FILE_CACHE_MIN_USES</code></td>
<td><code>2</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>最少使用次数：</strong> 在非活动期间，文件保持缓存所需的最少访问次数。</td>
</tr>
<tr>
<td><code>OPEN_FILE_CACHE_VALID</code></td>
<td><code>30s</code></td>
<td>multisite</td>
<td>no</td>
<td><strong>缓存有效期：</strong> 缓存元素重新验证的时间。</td>
</tr>
</tbody>
</table>
<p><strong>配置指南</strong></p>
<p>要启用和配置文件缓存：
1.  将 <code>USE_OPEN_FILE_CACHE</code> 设置为 <code>yes</code> 以激活该功能。
2.  调整 <code>OPEN_FILE_CACHE</code> 参数以定义缓存条目的最大数量及其非活动超时。
3.  使用 <code>OPEN_FILE_CACHE_ERRORS</code> 缓存成功和失败的查找，以减少重复的文件系统操作。
4.  设置 <code>OPEN_FILE_CACHE_MIN_USES</code> 以指定文件保持缓存所需的最少访问次数。
5.  使用 <code>OPEN_FILE_CACHE_VALID</code> 定义缓存有效期，以控制缓存元素的重新验证频率。</p>
<div class="admonition tip">
<p class="admonition-title">最佳实践</p>
<ul>
<li>为具有大量静态文件的网站启用文件缓存以提高性能。</li>
<li>定期审查和微调缓存设置，以平衡性能和资源使用。</li>
<li>在文件频繁更改的动态环境中，考虑缩短缓存有效期或禁用该功能以确保内容新鲜度。</li>
</ul>
</div>
</div>
</div>
</div>
<h3 id="zh-features-_83">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="31:7"><input checked="checked" id="zh-features-__tabbed_31_1" name="zh-features-__tabbed_31" type="radio" /><input id="zh-features-__tabbed_31_2" name="zh-features-__tabbed_31" type="radio" /><input id="zh-features-__tabbed_31_3" name="zh-features-__tabbed_31" type="radio" /><input id="zh-features-__tabbed_31_4" name="zh-features-__tabbed_31" type="radio" /><input id="zh-features-__tabbed_31_5" name="zh-features-__tabbed_31" type="radio" /><input id="zh-features-__tabbed_31_6" name="zh-features-__tabbed_31" type="radio" /><input id="zh-features-__tabbed_31_7" name="zh-features-__tabbed_31" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_31_1">默认服务器安全</label><label for="zh-features-__tabbed_31_2">拒绝 HTTP 状态</label><label for="zh-features-__tabbed_31_3">HTTP 方法</label><label for="zh-features-__tabbed_31_4">请求大小限制</label><label for="zh-features-__tabbed_31_5">协议支持</label><label for="zh-features-__tabbed_31_6">静态文件服务</label><label for="zh-features-__tabbed_31_7">文件缓存</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>禁用默认服务器并强制执行严格 SNI 的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">DISABLE_DEFAULT_SERVER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">DISABLE_DEFAULT_SERVER_STRICT_SNI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>静默丢弃不需要的请求的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">DENY_HTTP_STATUS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;444&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>将 HTTP 方法限制为 RESTful API 所需方法的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">ALLOWED_METHODS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GET|POST|PUT|DELETE&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>限制最大请求体大小的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">MAX_CLIENT_SIZE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5m&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>启用 HTTP/2 和 HTTP/3 并使用自定义 Alt-Svc 端口的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">HTTP2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">HTTP3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">HTTP3_ALT_SVC_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;443&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>从自定义根文件夹提供静态文件的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">SERVE_FILES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">ROOT_FOLDER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/www/custom-folder&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>启用和优化文件缓存的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_OPEN_FILE_CACHE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">OPEN_FILE_CACHE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;max=2000</span><span class="nv"> </span><span class="s">inactive=30s&quot;</span>
<span class="nt">OPEN_FILE_CACHE_ERRORS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">OPEN_FILE_CACHE_MIN_USES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3&quot;</span>
<span class="nt">OPEN_FILE_CACHE_VALID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60s&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-modsecurity">ModSecurity</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>ModSecurity 插件将功能强大的 <a href="https://modsecurity.org">ModSecurity</a> Web 应用程序防火墙 (WAF) 集成到 BunkerWeb 中。通过利用 <a href="https://coreruleset.org">OWASP 核心规则集 (CRS)</a>，此集成可检测并阻止 SQL 注入、跨站脚本 (XSS)、本地文件包含等威胁，从而提供针对各种 Web 攻击的强大防护。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当收到请求时，ModSecurity 会根据活动规则集对其进行评估。</li>
<li>OWASP 核心规则集会检查标头、Cookie、URL 参数和正文内容。</li>
<li>每个检测到的违规行为都会增加总体异常分数。</li>
<li>如果此分数超过配置的阈值，则请求将被阻止。</li>
<li>创建详细的日志以帮助诊断触发了哪些规则以及原因。</li>
</ol>
<div class="admonition success">
<p class="admonition-title">主要优势</p>
<ol>
<li><strong>行业标准保护：</strong> 利用广泛使用的开源 ModSecurity 防火墙。</li>
<li><strong>OWASP 核心规则集：</strong> 采用社区维护的规则，涵盖 OWASP 十大漏洞及更多内容。</li>
<li><strong>可配置的安全级别：</strong> 调整偏执级别以在安全性与潜在的误报之间取得平衡。</li>
<li><strong>详细日志记录：</strong> 提供详尽的审计日志以进行攻击分析。</li>
<li><strong>插件支持：</strong> 通过为您的应用程序量身定制的可选 CRS 插件来扩展保护。</li>
</ol>
</div>
<h3 id="zh-features-_84">如何使用</h3>
<p>请按照以下步骤配置和使用 ModSecurity：</p>
<ol>
<li><strong>启用该功能：</strong> ModSecurity 默认启用。可以使用 <code>USE_MODSECURITY</code> 设置进行控制。</li>
<li><strong>选择 CRS 版本：</strong> 选择一个 OWASP 核心规则集版本（v3、v4 或 nightly）。</li>
<li><strong>添加插件：</strong> 可选择激活 CRS 插件以增强规则覆盖范围。</li>
<li><strong>监控和调整：</strong> 使用日志和 <a href="#zh-web-ui">Web UI</a> 识别误报并调整设置。</li>
</ol>
<h3 id="zh-features-_85">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_MODSECURITY</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用 ModSecurity：</strong> 开启 ModSecurity Web 应用程序防火墙保护。</td>
</tr>
<tr>
<td><code>USE_MODSECURITY_CRS</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>使用核心规则集：</strong> 为 ModSecurity 启用 OWASP 核心规则集。</td>
</tr>
<tr>
<td><code>MODSECURITY_CRS_VERSION</code></td>
<td><code>4</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>CRS 版本：</strong> 要使用的 OWASP 核心规则集版本。选项：<code>3</code>、<code>4</code> 或 <code>nightly</code>。</td>
</tr>
<tr>
<td><code>MODSECURITY_SEC_RULE_ENGINE</code></td>
<td><code>On</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>规则引擎：</strong> 控制是否强制执行规则。选项：<code>On</code>、<code>DetectionOnly</code> 或 <code>Off</code>。</td>
</tr>
<tr>
<td><code>MODSECURITY_SEC_AUDIT_ENGINE</code></td>
<td><code>RelevantOnly</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>审计引擎：</strong> 控制审计日志的工作方式。选项：<code>On</code>、<code>Off</code> 或 <code>RelevantOnly</code>。</td>
</tr>
<tr>
<td><code>MODSECURITY_SEC_AUDIT_LOG_PARTS</code></td>
<td><code>ABIJDEFHZ</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>审计日志部分：</strong> 审计日志中要包含的请求/响应的哪些部分。</td>
</tr>
<tr>
<td><code>MODSECURITY_REQ_BODY_NO_FILES_LIMIT</code></td>
<td><code>131072</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>请求体限制（无文件）：</strong> 不含文件上传的请求体的最大大小。接受纯字节或人类可读的后缀（<code>k</code>、<code>m</code>、<code>g</code>），例如 <code>131072</code>、<code>256k</code>、<code>1m</code>、<code>2g</code>。</td>
</tr>
<tr>
<td><code>USE_MODSECURITY_CRS_PLUGINS</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用 CRS 插件：</strong> 为核心规则集启用其他插件规则集。</td>
</tr>
<tr>
<td><code>MODSECURITY_CRS_PLUGINS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>CRS 插件列表：</strong> 要下载和安装的插件的空格分隔列表（<code>plugin-name[/tag]</code> 或 URL）。</td>
</tr>
<tr>
<td><code>USE_MODSECURITY_GLOBAL_CRS</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>全局 CRS：</strong> 启用后，在 HTTP 级别而不是每个服务器上全局应用 CRS 规则。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">ModSecurity 和 OWASP 核心规则集</p>
<p><strong>我们强烈建议同时启用 ModSecurity 和 OWASP 核心规则集 (CRS)</strong>，以提供针对常见 Web 漏洞的强大保护。虽然偶尔可能会出现误报，但可以通过微调规则或使用预定义的排除项来解决。</p>
<p>CRS 团队积极维护着针对 WordPress、Nextcloud、Drupal 和 Cpanel 等流行应用程序的排除项列表，从而更容易在不影响功能的情况下进行集成。其安全优势远远超过了解决误报所需的最低配置工作量。</p>
</div>
<h3 id="zh-features-crs">可用的 CRS 版本</h3>
<p>选择一个 CRS 版本以最符合您的安全需求：</p>
<ul>
<li><strong><code>3</code></strong>：稳定版 <a href="https://github.com/coreruleset/coreruleset/releases/tag/v3.3.7">v3.3.7</a>。</li>
<li><strong><code>4</code></strong>：稳定版 <a href="https://github.com/coreruleset/coreruleset/releases/tag/v4.18.0">v4.18.0</a> (<strong>默认</strong>)。</li>
<li><strong><code>nightly</code></strong>：<a href="https://github.com/coreruleset/coreruleset/releases/tag/nightly">每日构建版</a>，提供最新的规则更新。</li>
</ul>
<div class="admonition example">
<p class="admonition-title">每日构建版</p>
<p><strong>每日构建版</strong>包含最新的规则，提供针对新兴威胁的最新保护。然而，由于它每天更新，并且可能包含实验性或未经测试的更改，建议在将其部署到生产环境之前，首先在<strong>预演环境</strong>中使用每日构建版。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">偏执级别</p>
<p>OWASP 核心规则集使用“偏执级别”(PL) 来控制规则的严格性：</p>
<ul>
<li><strong>PL1 (默认):</strong> 基本保护，误报最少</li>
<li><strong>PL2:</strong> 更严格的安全性，具有更严格的模式匹配</li>
<li><strong>PL3:</strong> 增强的安全性，具有更严格的验证</li>
<li><strong>PL4:</strong> 最高安全性，规则非常严格（可能导致许多误报）</li>
</ul>
<p>您可以通过在 <code>/etc/bunkerweb/configs/modsec-crs/</code> 中添加自定义配置文件来设置偏执级别。</p>
</div>
<h3 id="zh-features-_86">自定义配置</h3>
<p>可以通过自定义配置来调整 ModSecurity 和 OWASP 核心规则集 (CRS)。这些配置允许您在安全规则处理的特定阶段自定义行为：</p>
<ul>
<li><strong><code>modsec-crs</code></strong>：在加载 OWASP 核心规则集<strong>之前</strong>应用。</li>
<li><strong><code>modsec</code></strong>：在加载 OWASP 核心规则集<strong>之后</strong>应用。如果根本没有加载 CRS，也会使用此配置。</li>
<li><strong><code>crs-plugins-before</code></strong>：在加载 CRS 插件<strong>之前</strong>应用。</li>
<li><strong><code>crs-plugins-after</code></strong>：在加载 CRS 插件<strong>之后</strong>应用。</li>
</ul>
<p>这种结构提供了灵活性，允许您根据应用程序的特定需求微调 ModSecurity 和 CRS 设置，同时保持清晰的配置流程。</p>
<h4 id="zh-features-modsec-crs-crs">使用 <code>modsec-crs</code> 添加 CRS 排除项</h4>
<p>您可以使用 <code>modsec-crs</code> 类型的自定义配置来为特定用例添加排除项，例如为 WordPress 启用预定义的排除项：</p>
<div class="highlight"><pre><span></span><code>SecAction \
 &quot;id:900130,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.crs_exclusions_wordpress=1&quot;
</code></pre></div>
<p>在此示例中：</p>
<ul>
<li>该操作在<strong>阶段 1</strong>（请求生命周期的早期）执行。</li>
<li>它通过设置变量 <code>tx.crs_exclusions_wordpress</code> 来启用 WordPress 特定的 CRS 排除项。</li>
</ul>
<h4 id="zh-features-modsec-crs">使用 <code>modsec</code> 更新 CRS 规则</h4>
<p>要微调已加载的 CRS 规则，您可以使用 <code>modsec</code> 类型的自定义配置。例如，您可以为某些请求路径删除特定的规则或标签：</p>
<div class="highlight"><pre><span></span><code>SecRule REQUEST_FILENAME &quot;/wp-admin/admin-ajax.php&quot; &quot;id:1,ctl:ruleRemoveByTag=attack-xss,ctl:ruleRemoveByTag=attack-rce&quot;
SecRule REQUEST_FILENAME &quot;/wp-admin/options.php&quot; &quot;id:2,ctl:ruleRemoveByTag=attack-xss&quot;
SecRule REQUEST_FILENAME &quot;^/wp-json/yoast&quot; &quot;id:3,ctl:ruleRemoveById=930120&quot;
</code></pre></div>
<p>在此示例中：</p>
<ul>
<li><strong>规则 1</strong>：为对 <code>/wp-admin/admin-ajax.php</code> 的请求删除标记为 <code>attack-xss</code> 和 <code>attack-rce</code> 的规则。</li>
<li><strong>规则 2</strong>：为对 <code>/wp-admin/options.php</code> 的请求删除标记为 <code>attack-xss</code> 的规则。</li>
<li><strong>规则 3</strong>：为匹配 <code>/wp-json/yoast</code> 的请求删除特定规则（ID <code>930120</code>）。</li>
</ul>
<div class="admonition info">
<p class="admonition-title">执行顺序</p>
<p>BunkerWeb 中 ModSecurity 的执行顺序如下，确保了规则应用的清晰和逻辑性：</p>
<ol>
<li><strong>OWASP CRS 配置</strong>：OWASP 核心规则集的基础配置。</li>
<li><strong>自定义插件配置 (<code>crs-plugins-before</code>)</strong>：特定于插件的设置，在任何 CRS 规则之前应用。</li>
<li><strong>自定义插件规则（在 CRS 规则之前）(<code>crs-plugins-before</code>)</strong>：在 CRS 规则之前执行的插件自定义规则。</li>
<li><strong>下载的插件配置</strong>：外部下载插件的配置。</li>
<li><strong>下载的插件规则（在 CRS 规则之前）</strong>：在 CRS 规则之前执行的下载插件规则。</li>
<li><strong>自定义 CRS 规则 (<code>modsec-crs</code>)</strong>：在加载 CRS 规则之前应用的用户定义规则。</li>
<li><strong>OWASP CRS 规则</strong>：由 OWASP 提供的核心安全规则集。</li>
<li><strong>自定义插件规则（在 CRS 规则之后）(<code>crs-plugins-after</code>)</strong>：在 CRS 规则之后执行的自定义插件规则。</li>
<li><strong>下载的插件规则（在 CRS 规则之后）</strong>：在 CRS 规则之后执行的下载插件规则。</li>
<li><strong>自定义规则 (<code>modsec</code>)</strong>：在所有 CRS 和插件规则之后应用的用户定义规则。</li>
</ol>
<p><strong>关键说明</strong>：</p>
<ul>
<li><strong>CRS 前的自定义</strong>（<code>crs-plugins-before</code>、<code>modsec-crs</code>）允许您在加载核心 CRS 规则之前定义例外或准备性规则。</li>
<li><strong>CRS 后的自定义</strong>（<code>crs-plugins-after</code>、<code>modsec</code>）是在应用 CRS 和插件规则之后覆盖或扩展规则的理想选择。</li>
<li>这种结构提供了最大的灵活性，能够在保持强大安全基线的同时，精确控制规则的执行和自定义。</li>
</ul>
</div>
<h3 id="zh-features-owasp-crs">OWASP CRS 插件</h3>
<p>OWASP 核心规则集还支持一系列<strong>插件</strong>，旨在扩展其功能并提高与特定应用程序或环境的兼容性。这些插件可以帮助微调 CRS，以用于 WordPress、Nextcloud 和 Drupal 等流行平台，甚至是自定义设置。有关更多信息和可用插件列表，请参阅 <a href="https://github.com/coreruleset/plugin-registry">OWASP CRS 插件注册表</a>。</p>
<div class="admonition tip">
<p class="admonition-title">插件下载</p>
<p><code>MODSECURITY_CRS_PLUGINS</code> 设置允许您下载和安装插件，以扩展 OWASP 核心规则集 (CRS) 的功能。此设置接受带有可选标签或 URL 的插件名称列表，从而可以轻松集成根据您的特定需求量身定制的其他安全功能。</p>
<p>以下是 <code>MODSECURITY_CRS_PLUGINS</code> 设置接受的值的非详尽列表：</p>
<ul>
<li><code>fake-bot</code> - 下载插件的最新版本。</li>
<li><code>wordpress-rule-exclusions/v1.0.0</code> - 下载插件的 1.0.0 版本。</li>
<li><code>https://github.com/coreruleset/dos-protection-plugin-modsecurity/archive/refs/heads/main.zip</code> - 直接从 URL 下载插件。</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">误报</p>
<p>较高的安全设置可能会阻止合法流量。请从默认设置开始，并在提高安全级别之前监控日志。请准备好为您的特定应用程序需求添加排除规则。</p>
</div>
<h3 id="zh-features-_87">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="32:6"><input checked="checked" id="zh-features-__tabbed_32_1" name="zh-features-__tabbed_32" type="radio" /><input id="zh-features-__tabbed_32_2" name="zh-features-__tabbed_32" type="radio" /><input id="zh-features-__tabbed_32_3" name="zh-features-__tabbed_32" type="radio" /><input id="zh-features-__tabbed_32_4" name="zh-features-__tabbed_32" type="radio" /><input id="zh-features-__tabbed_32_5" name="zh-features-__tabbed_32" type="radio" /><input id="zh-features-__tabbed_32_6" name="zh-features-__tabbed_32" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_32_1">基本配置</label><label for="zh-features-__tabbed_32_2">仅检测模式</label><label for="zh-features-__tabbed_32_3">带插件的高级配置</label><label for="zh-features-__tabbed_32_4">旧版配置</label><label for="zh-features-__tabbed_32_5">全局 ModSecurity</label><label for="zh-features-__tabbed_32_6">带自定义插件的每日构建版</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>启用 ModSecurity 和 CRS v4 的标准配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_MODSECURITY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">USE_MODSECURITY_CRS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">MODSECURITY_CRS_VERSION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
<span class="nt">MODSECURITY_SEC_RULE_ENGINE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;On&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>用于监控潜在威胁而不进行阻止的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_MODSECURITY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">USE_MODSECURITY_CRS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">MODSECURITY_CRS_VERSION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
<span class="nt">MODSECURITY_SEC_RULE_ENGINE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DetectionOnly&quot;</span>
<span class="nt">MODSECURITY_SEC_AUDIT_ENGINE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;On&quot;</span>
<span class="nt">MODSECURITY_SEC_AUDIT_LOG_PARTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ABIJDEFHZ&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>启用 CRS v4 和插件以提供额外保护的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_MODSECURITY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">USE_MODSECURITY_CRS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">MODSECURITY_CRS_VERSION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
<span class="nt">MODSECURITY_SEC_RULE_ENGINE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;On&quot;</span>
<span class="nt">USE_MODSECURITY_CRS_PLUGINS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">MODSECURITY_CRS_PLUGINS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;wordpress-rule-exclusions</span><span class="nv"> </span><span class="s">fake-bot&quot;</span>
<span class="nt">MODSECURITY_REQ_BODY_NO_FILES_LIMIT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;262144&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用 CRS v3 以与旧设置兼容的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_MODSECURITY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">USE_MODSECURITY_CRS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">MODSECURITY_CRS_VERSION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3&quot;</span>
<span class="nt">MODSECURITY_SEC_RULE_ENGINE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;On&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>在所有 HTTP 连接上全局应用 ModSecurity 的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_MODSECURITY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">USE_MODSECURITY_CRS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">MODSECURITY_CRS_VERSION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
<span class="nt">USE_MODSECURITY_GLOBAL_CRS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用 CRS 的每日构建版并带有自定义插件的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_MODSECURITY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">USE_MODSECURITY_CRS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">MODSECURITY_CRS_VERSION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nightly&quot;</span>
<span class="nt">USE_MODSECURITY_CRS_PLUGINS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">MODSECURITY_CRS_PLUGINS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;wordpress-rule-exclusions/v1.0.0</span><span class="nv"> </span><span class="s">https://github.com/coreruleset/dos-protection-plugin-modsecurity/archive/refs/heads/main.zip&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">人类可读的大小值</p>
<p>对于像 <code>MODSECURITY_REQ_BODY_NO_FILES_LIMIT</code> 这样的 大小设置，支持 <code>k</code>、<code>m</code> 和 <code>g</code>（不区分大小写）后缀，分别代表 kibibytes、mebibytes 和 gibibytes（1024 的倍数）。例如：<code>256k</code> = 262144，<code>1m</code> = 1048576，<code>2g</code> = 2147483648。</p>
</div>
<h2 id="zh-features-monitoring-pro">Monitoring <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style='transform : translateY(3px);'> (PRO)</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>BunkerWeb monitoring pro system. This plugin is a prerequisite for some other plugins.</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>上下文</th>
<th>可重复</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_MONITORING</code></td>
<td><code>yes</code></td>
<td>global</td>
<td>否</td>
<td>Enable monitoring of BunkerWeb.</td>
</tr>
<tr>
<td><code>MONITORING_METRICS_DICT_SIZE</code></td>
<td><code>10M</code></td>
<td>global</td>
<td>否</td>
<td>Size of the dict to store monitoring metrics.</td>
</tr>
<tr>
<td><code>MONITORING_IGNORE_URLS</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>List of URLs to ignore when monitoring separated with spaces (e.g. /health)</td>
</tr>
</tbody>
</table>
<h2 id="zh-features-php">PHP</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>PHP 插件为 BunkerWeb 提供了与 PHP-FPM 的无缝集成，从而为您的网站启用动态 PHP 处理。此功能支持在同一台机器上运行的本地 PHP-FPM 实例和远程 PHP-FPM 服务器，让您在配置 PHP 环境时拥有灵活性。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当客户端从您的网站请求 PHP 文件时，BunkerWeb 会将请求路由到已配置的 PHP-FPM 实例。</li>
<li>对于本地 PHP-FPM，BunkerWeb 通过 Unix 套接字文件与 PHP 解释器通信。</li>
<li>对于远程 PHP-FPM，BunkerWeb 使用 FastCGI 协议将请求转发到指定的主机和端口。</li>
<li>PHP-FPM 处理脚本并返回生成的内容给 BunkerWeb，然后由 BunkerWeb 将其交付给客户端。</li>
<li>URL 重写会自动配置，以支持使用“美观 URL”的常见 PHP 框架和应用程序。</li>
</ol>
<h3 id="zh-features-_88">如何使用</h3>
<p>请按照以下步骤配置和使用 PHP 功能：</p>
<ol>
<li><strong>选择您的 PHP-FPM 设置：</strong> 决定您将使用本地还是远程 PHP-FPM 实例。</li>
<li><strong>配置连接：</strong> 对于本地 PHP，请指定套接字路径；对于远程 PHP，请提供主机名和端口。</li>
<li><strong>设置文档根目录：</strong> 使用适当的路径设置，配置包含您的 PHP 文件的根文件夹。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 配置完成后，BunkerWeb 会自动将 PHP 请求路由到您的 PHP-FPM 实例。</li>
</ol>
<h3 id="zh-features-_89">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>REMOTE_PHP</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>远程 PHP 主机：</strong> 远程 PHP-FPM 实例的主机名。留空以使用本地 PHP。</td>
</tr>
<tr>
<td><code>REMOTE_PHP_PATH</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>远程路径：</strong> 远程 PHP-FPM 实例中包含文件的根文件夹。</td>
</tr>
<tr>
<td><code>REMOTE_PHP_PORT</code></td>
<td><code>9000</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>远程端口：</strong> 远程 PHP-FPM 实例的端口。</td>
</tr>
<tr>
<td><code>LOCAL_PHP</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>本地 PHP 套接字：</strong> PHP-FPM 套接字文件的路径。留空以使用远程 PHP-FPM 实例。</td>
</tr>
<tr>
<td><code>LOCAL_PHP_PATH</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>本地路径：</strong> 本地 PHP-FPM 实例中包含文件的根文件夹。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">本地与远程 PHP-FPM</p>
<p>选择最适合您基础架构的设置：</p>
<ul>
<li><strong>本地 PHP-FPM</strong> 由于基于套接字的通信而提供更好的性能，并且在 PHP 与 BunkerWeb 在同一台机器上运行时是理想选择。</li>
<li><strong>远程 PHP-FPM</strong> 通过允许在单独的服务器上进行 PHP 处理，提供了更大的灵活性和可伸缩性。</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">路径配置</p>
<p><code>REMOTE_PHP_PATH</code> 或 <code>LOCAL_PHP_PATH</code> 必须与存储 PHP 文件的实际文件系统路径匹配；否则，将发生“文件未找到”错误。</p>
</div>
<div class="admonition info">
<p class="admonition-title">URL 重写</p>
<p>PHP 插件会自动配置 URL 重写以支持现代 PHP 应用程序。对不存在的文件的请求将被定向到 <code>index.php</code>，原始请求 URI 将作为查询参数提供。</p>
</div>
<h3 id="zh-features-_90">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="33:4"><input checked="checked" id="zh-features-__tabbed_33_1" name="zh-features-__tabbed_33" type="radio" /><input id="zh-features-__tabbed_33_2" name="zh-features-__tabbed_33" type="radio" /><input id="zh-features-__tabbed_33_3" name="zh-features-__tabbed_33" type="radio" /><input id="zh-features-__tabbed_33_4" name="zh-features-__tabbed_33" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_33_1">本地 PHP-FPM 配置</label><label for="zh-features-__tabbed_33_2">远程 PHP-FPM 配置</label><label for="zh-features-__tabbed_33_3">自定义端口配置</label><label for="zh-features-__tabbed_33_4">WordPress 配置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>使用本地 PHP-FPM 实例的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">LOCAL_PHP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/run/php/php8.1-fpm.sock&quot;</span>
<span class="nt">LOCAL_PHP_PATH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/www/html&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用远程 PHP-FPM 实例的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">REMOTE_PHP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;php-server.example.com&quot;</span>
<span class="nt">REMOTE_PHP_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;9000&quot;</span>
<span class="nt">REMOTE_PHP_PATH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/www/html&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>在非标准端口上使用 PHP-FPM 的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">REMOTE_PHP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;php-server.example.com&quot;</span>
<span class="nt">REMOTE_PHP_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;9001&quot;</span>
<span class="nt">REMOTE_PHP_PATH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/www/html&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>为 WordPress 优化的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">LOCAL_PHP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/run/php/php8.1-fpm.sock&quot;</span>
<span class="nt">LOCAL_PHP_PATH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/www/html/wordpress&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-pro">Pro</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>Pro 插件为 BunkerWeb 的企业部署捆绑了高级功能和增强功能。它解锁了额外的功能、高级插件和扩展功能，以补充核心 BunkerWeb 平台。它为企业级部署提供了增强的安全性、性能和管理选项。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>使用有效的 Pro 许可证密钥，BunkerWeb 会连接到 Pro API 服务器以验证您的订阅。</li>
<li>一旦通过身份验证，该插件会自动下载并安装 Pro 专属插件和扩展。</li>
<li>您的 Pro 状态会定期验证，以确保您能持续访问高级功能。</li>
<li>高级插件会无缝集成到您现有的 BunkerWeb 配置中。</li>
<li>所有 Pro 功能都与开源核心协调工作，是增强而非取代功能。</li>
</ol>
<div class="admonition success">
<p class="admonition-title">主要优势</p>
<ol>
<li><strong>高级扩展：</strong> 访问社区版中没有的专属插件和功能。</li>
<li><strong>增强性能：</strong> 优化的配置和高级缓存机制。</li>
<li><strong>企业支持：</strong> 优先协助和专属支持渠道。</li>
<li><strong>无缝集成：</strong> Pro 功能与社区功能并行工作，不会产生配置冲突。</li>
<li><strong>自动更新：</strong> 高级插件会自动下载并保持最新状态。</li>
</ol>
</div>
<h3 id="zh-features-_91">如何使用</h3>
<p>请按照以下步骤配置和使用 Pro 功能：</p>
<ol>
<li><strong>获取许可证密钥：</strong> 从 <a href="https://panel.bunkerweb.io/store/bunkerweb-pro?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板</a> 购买 Pro 许可证。</li>
<li><strong>配置您的许可证密钥：</strong> 使用 <code>PRO_LICENSE_KEY</code> 设置来配置您的许可证。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 一旦配置了有效的许可证，Pro 插件将自动下载并激活。</li>
<li><strong>监控您的 Pro 状态：</strong> 在 <a href="#zh-web-ui">Web UI</a> 中检查健康指示器，以确认您的 Pro 订阅状态。</li>
</ol>
<h3 id="zh-features-_92">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PRO_LICENSE_KEY</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>Pro 许可证密钥：</strong> 用于身份验证的 BunkerWeb Pro 许可证密钥。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">许可证管理</p>
<p>您的 Pro 许可证与您的特定部署环境相关联。如果您需要转移许可证或对您的订阅有疑问，请通过 <a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板</a> 联系支持。</p>
</div>
<div class="admonition info">
<p class="admonition-title">Pro 功能</p>
<p>随着新功能的增加，可用的具体 Pro 功能可能会随时间演变。Pro 插件会自动处理所有可用功能的安装和配置。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">网络要求</p>
<p>Pro 插件需要出站互联网访问权限，以连接到 BunkerWeb API 进行许可证验证和下载高级插件。请确保您的防火墙允许连接到 <code>api.bunkerweb.io</code> 的 443 端口 (HTTPS)。</p>
</div>
<h3 id="zh-features-_93">常见问题解答</h3>
<p><strong>问：如果我的 Pro 许可证到期会怎样？</strong></p>
<p>答：如果您的 Pro 许可证到期，对高级功能和插件的访问将被禁用。但是，您的 BunkerWeb 安装将继续使用所有社区版功能正常运行。要重新获得对 Pro 功能的访问权限，只需续订您的许可证即可。</p>
<p><strong>问：Pro 功能会干扰我现有的配置吗？</strong></p>
<p>答：不会，Pro 功能旨在与您当前的 BunkerWeb 设置无缝集成。它们在不更改或干扰您现有配置的情况下增强功能，确保了平稳可靠的体验。</p>
<p><strong>问：我可以在购买前试用 Pro 功能吗？</strong></p>
<p>答：当然可以！BunkerWeb 提供两种 Pro 计划以满足您的需求：</p>
<ul>
<li><strong>BunkerWeb PRO Standard：</strong> 完全访问 Pro 功能，但不提供技术支持。</li>
<li><strong>BunkerWeb PRO Enterprise：</strong> 完全访问 Pro 功能，并提供专属技术支持。</li>
</ul>
<p>您可以使用促销码 <code>freetrial</code> 免费试用 Pro 功能 1 个月。请访问 <a href="https://panel.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板</a> 激活您的试用，并了解更多关于基于 BunkerWeb PRO 保护的服务数量的灵活定价选项。</p>
<h2 id="zh-features-prometheus-exporter-pro">Prometheus exporter <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style='transform : translateY(3px);'> (PRO)</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>Prometheus exporter for BunkerWeb internal metrics.</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>上下文</th>
<th>可重复</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_PROMETHEUS_EXPORTER</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td>Enable the Prometheus export.</td>
</tr>
<tr>
<td><code>PROMETHEUS_EXPORTER_IP</code></td>
<td><code>0.0.0.0</code></td>
<td>global</td>
<td>否</td>
<td>Listening IP of the Prometheus exporter.</td>
</tr>
<tr>
<td><code>PROMETHEUS_EXPORTER_PORT</code></td>
<td><code>9113</code></td>
<td>global</td>
<td>否</td>
<td>Listening port of the Prometheus exporter.</td>
</tr>
<tr>
<td><code>PROMETHEUS_EXPORTER_URL</code></td>
<td><code>/metrics</code></td>
<td>global</td>
<td>否</td>
<td>HTTP URL of the Prometheus exporter.</td>
</tr>
<tr>
<td><code>PROMETHEUS_EXPORTER_ALLOW_IP</code></td>
<td><code>127.0.0.0/8 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16</code></td>
<td>global</td>
<td>否</td>
<td>List of IP/networks allowed to contact the Prometheus exporter endpoint.</td>
</tr>
</tbody>
</table>
<h2 id="zh-features-real-ip">Real IP</h2>
<p>STREAM 支持 <img alt="⚠" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/26a0.svg" title=":warning:" /></p>
<p>Real IP 插件可确保 BunkerWeb 即使在代理后面也能正确识别客户端的 IP 地址。这对于正确应用安全规则、速率限制和日志记录至关重要；没有它，所有请求都将看起来来自您的代理 IP，而不是客户端的实际 IP。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>启用后，BunkerWeb 会检查传入请求中是否包含特定标头（如 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Headers/X-Forwarded-For"><code>X-Forwarded-For</code></a>），这些标头包含客户端的原始 IP 地址。</li>
<li>BunkerWeb 会检查传入的 IP 是否在您的受信任代理列表 (<code>REAL_IP_FROM</code>) 中，确保只有合法的代理才能传递客户端 IP。</li>
<li>从指定的标头 (<code>REAL_IP_HEADER</code>) 中提取原始客户端 IP，并用于所有安全评估和日志记录。</li>
<li>对于递归 IP 链，BunkerWeb 可以追溯多个代理跃点以确定始发客户端 IP。</li>
<li>此外，可以启用 <a href="https://netnut.io/what-is-proxy-protocol-and-how-does-it-work/">PROXY 协议</a> 支持，以直接从兼容的代理（如 <a href="https://www.haproxy.org/">HAProxy</a>）接收客户端 IP。</li>
<li>受信任的代理 IP 列表可以通过 URL 从外部源自动下载和更新。</li>
</ol>
<h3 id="zh-features-_94">如何使用</h3>
<p>请按照以下步骤配置和使用 Real IP 功能：</p>
<ol>
<li><strong>启用该功能：</strong> 将 <code>USE_REAL_IP</code> 设置为 <code>yes</code> 以启用真实 IP 检测。</li>
<li><strong>定义受信任的代理：</strong> 使用 <code>REAL_IP_FROM</code> 设置列出您受信任的代理的 IP 地址或网络。</li>
<li><strong>指定标头：</strong> 使用 <code>REAL_IP_HEADER</code> 设置配置哪个标头包含真实 IP。</li>
<li><strong>配置递归：</strong> 使用 <code>REAL_IP_RECURSIVE</code> 设置决定是否递归地追溯 IP 链。</li>
<li><strong>可选的 URL 源：</strong> 使用 <code>REAL_IP_FROM_URLS</code> 设置自动下载受信任的代理列表。</li>
<li><strong>PROXY 协议：</strong> 对于直接的代理通信，如果您的上游支持，请使用 <code>USE_PROXY_PROTOCOL</code> 启用。</li>
</ol>
<div class="admonition danger">
<p class="admonition-title">PROXY 协议警告</p>
<p>在未正确配置您的上游代理以发送 PROXY 协议标头的情况下启用 <code>USE_PROXY_PROTOCOL</code> 将<strong>破坏您的应用程序</strong>。仅当您确定您的上游代理已正确配置为发送 PROXY 协议信息时，才启用此设置。如果您的代理未发送 PROXY 协议标头，所有到 BunkerWeb 的连接都将因协议错误而失败。</p>
</div>
<h3 id="zh-features-_95">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_REAL_IP</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用真实 IP：</strong> 设置为 <code>yes</code> 以启用从标头或 PROXY 协议中检索客户端的真实 IP。</td>
</tr>
<tr>
<td><code>REAL_IP_FROM</code></td>
<td><code>192.168.0.0/16 172.16.0.0/12 10.0.0.0/8</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>受信任的代理：</strong> 代理请求来源的受信任 IP 地址或网络列表，以空格分隔。</td>
</tr>
<tr>
<td><code>REAL_IP_HEADER</code></td>
<td><code>X-Forwarded-For</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>真实 IP 标头：</strong> 包含真实 IP 的 HTTP 标头或用于 PROXY 协议的特殊值 <code>proxy_protocol</code>。</td>
</tr>
<tr>
<td><code>REAL_IP_RECURSIVE</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>递归搜索：</strong> 设置为 <code>yes</code> 时，在包含多个 IP 地址的标头中执行递归搜索。</td>
</tr>
<tr>
<td><code>REAL_IP_FROM_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>IP 列表 URL：</strong> 包含要下载的受信任代理 IP/网络的 URL，以空格分隔。支持 file:// URL。</td>
</tr>
<tr>
<td><code>USE_PROXY_PROTOCOL</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>PROXY 协议：</strong> 设置为 <code>yes</code> 以启用 PROXY 协议支持，用于直接的代理到 BunkerWeb 的通信。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">云提供商网络</p>
<p>如果您正在使用像 AWS、GCP 或 Azure 这样的云提供商，请考虑将其负载均衡器的 IP 范围添加到您的 <code>REAL_IP_FROM</code> 设置中，以确保正确的客户端 IP 识别。</p>
</div>
<div class="admonition danger">
<p class="admonition-title">安全注意事项</p>
<p>仅在您的配置中包含受信任的代理 IP。添加不受信任的源可能会允许 IP 欺骗攻击，恶意行为者可以通过操纵标头来伪造客户端 IP。</p>
</div>
<div class="admonition info">
<p class="admonition-title">多个 IP 地址</p>
<p>当 <code>REAL_IP_RECURSIVE</code> 启用并且标头包含多个 IP（例如，<code>X-Forwarded-For: client, proxy1, proxy2</code>）时，BunkerWeb 会将不在您受信任代理列表中的最左侧 IP 识别为客户端 IP。</p>
</div>
<h3 id="zh-features-_96">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="34:6"><input checked="checked" id="zh-features-__tabbed_34_1" name="zh-features-__tabbed_34" type="radio" /><input id="zh-features-__tabbed_34_2" name="zh-features-__tabbed_34" type="radio" /><input id="zh-features-__tabbed_34_3" name="zh-features-__tabbed_34" type="radio" /><input id="zh-features-__tabbed_34_4" name="zh-features-__tabbed_34" type="radio" /><input id="zh-features-__tabbed_34_5" name="zh-features-__tabbed_34" type="radio" /><input id="zh-features-__tabbed_34_6" name="zh-features-__tabbed_34" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_34_1">基本配置</label><label for="zh-features-__tabbed_34_2">云负载均衡器</label><label for="zh-features-__tabbed_34_3">PROXY 协议</label><label for="zh-features-__tabbed_34_4">带有 URL 的多个代理源</label><label for="zh-features-__tabbed_34_5">CDN 配置</label><label for="zh-features-__tabbed_34_6">位于 Cloudflare 后面</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个用于位于反向代理后面的站点的简单配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.1.0/24</span><span class="nv"> </span><span class="s">10.0.0.5&quot;</span>
<span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Forwarded-For&quot;</span>
<span class="nt">REAL_IP_RECURSIVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>用于位于云负载均衡器后面的站点的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.0.0/16</span><span class="nv"> </span><span class="s">172.16.0.0/12</span><span class="nv"> </span><span class="s">10.0.0.0/8&quot;</span>
<span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Forwarded-For&quot;</span>
<span class="nt">REAL_IP_RECURSIVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用 PROXY 协议与兼容的负载均衡器的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.1.0/24&quot;</span>
<span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;proxy_protocol&quot;</span>
<span class="nt">USE_PROXY_PROTOCOL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>具有自动更新的代理 IP 列表的高级配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.0.0/16</span><span class="nv"> </span><span class="s">172.16.0.0/12</span><span class="nv"> </span><span class="s">10.0.0.0/8&quot;</span>
<span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Real-IP&quot;</span>
<span class="nt">REAL_IP_RECURSIVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REAL_IP_FROM_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/proxy-ips.txt</span><span class="nv"> </span><span class="s">file:///etc/bunkerweb/custom-proxies.txt&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>用于位于 CDN 后面的网站的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.0.0/16</span><span class="nv"> </span><span class="s">172.16.0.0/12</span><span class="nv"> </span><span class="s">10.0.0.0/8&quot;</span>
<span class="nt">REAL_IP_FROM_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://cdn-provider.com/ip-ranges.txt&quot;</span>
<span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;CF-Connecting-IP&quot;</span><span class="w">  </span><span class="c1"># Cloudflare 示例</span>
<span class="nt">REAL_IP_RECURSIVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span><span class="w">  </span><span class="c1"># 对于单个 IP 标头不需要</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>用于位于 Cloudflare 后面的网站的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 我们只信任 Cloudflare 的 IP</span>
<span class="nt">REAL_IP_FROM_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://www.cloudflare.com/ips-v4/</span><span class="nv"> </span><span class="s">https://www.cloudflare.com/ips-v6/&quot;</span><span class="w"> </span><span class="c1"># 自动下载 Cloudflare IP</span>
<span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;CF-Connecting-IP&quot;</span><span class="w">  </span><span class="c1"># Cloudflare 用于客户端 IP 的标头</span>
<span class="nt">REAL_IP_RECURSIVE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-redirect">Redirect</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>重定向插件为受 BunkerWeb 保护的网站提供了简单高效的 HTTP 重定向功能。此功能使您能够轻松地将访问者从一个 URL 重定向到另一个 URL，支持全域名重定向、特定路径重定向和路径保留重定向。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当访问者访问您的网站时，BunkerWeb 会验证是否配置了重定向。</li>
<li>如果启用，BunkerWeb 会将访问者重定向到指定的目标 URL。</li>
<li>您可以配置是保留原始请求路径（自动将其附加到目标 URL）还是重定向到确切的目标 URL。</li>
<li>用于重定向的 HTTP 状态码可以在永久（301）和临时（302）重定向之间进行自定义。</li>
<li>此功能非常适用于域名迁移、建立规范域名或重定向已弃用的 URL。</li>
</ol>
<h3 id="zh-features-_97">如何使用</h3>
<p>请按照以下步骤配置和使用重定向功能：</p>
<ol>
<li><strong>设置源路径：</strong> 使用 <code>REDIRECT_FROM</code> 设置配置要重定向的路径（例如 <code>/</code>、<code>/old-page</code>）。</li>
<li><strong>设置目标 URL：</strong> 使用 <code>REDIRECT_TO</code> 设置配置访问者应被重定向到的目标 URL。</li>
<li><strong>选择重定向类型：</strong> 使用 <code>REDIRECT_TO_REQUEST_URI</code> 设置决定是否保留原始请求路径。</li>
<li><strong>选择状态码：</strong> 使用 <code>REDIRECT_TO_STATUS_CODE</code> 设置设置适当的 HTTP 状态码，以指示是永久重定向还是临时重定向。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 配置完成后，所有对该站点的请求都将根据您的设置自动重定向。</li>
</ol>
<h3 id="zh-features-_98">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>REDIRECT_FROM</code></td>
<td><code>/</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>要重定向的源路径：</strong> 将被重定向的路径。</td>
</tr>
<tr>
<td><code>REDIRECT_TO</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>目标 URL：</strong> 访问者将被重定向到的目标 URL。留空以禁用重定向。</td>
</tr>
<tr>
<td><code>REDIRECT_TO_REQUEST_URI</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>保留路径：</strong> 设置为 <code>yes</code> 时，将原始请求 URI 附加到目标 URL。</td>
</tr>
<tr>
<td><code>REDIRECT_TO_STATUS_CODE</code></td>
<td><code>301</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>HTTP 状态码：</strong> 用于重定向的 HTTP 状态码。选项：<code>301</code>（永久）或 <code>302</code>（临时）。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">选择正确的状态码</p>
<ul>
<li>当重定向是永久性的时，例如域名迁移或建立规范 URL，请使用 <code>301</code>（永久移动）。这有助于搜索引擎更新其索引。</li>
<li>当重定向是临时性的，或者如果您将来可能想重新使用原始 URL，请使用 <code>302</code>（找到/临时重定向）。</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">路径保留</p>
<p>当 <code>REDIRECT_TO_REQUEST_URI</code> 设置为 <code>yes</code> 时，BunkerWeb 会保留原始请求路径。例如，如果用户访问 <code>https://old-domain.com/blog/post-1</code>，并且您已设置为重定向到 <code>https://new-domain.com</code>，他们将被重定向到 <code>https://new-domain.com/blog/post-1</code>。</p>
</div>
<h3 id="zh-features-_99">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="35:5"><input checked="checked" id="zh-features-__tabbed_35_1" name="zh-features-__tabbed_35" type="radio" /><input id="zh-features-__tabbed_35_2" name="zh-features-__tabbed_35" type="radio" /><input id="zh-features-__tabbed_35_3" name="zh-features-__tabbed_35" type="radio" /><input id="zh-features-__tabbed_35_4" name="zh-features-__tabbed_35" type="radio" /><input id="zh-features-__tabbed_35_5" name="zh-features-__tabbed_35" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_35_1">多路径重定向</label><label for="zh-features-__tabbed_35_2">简单域名重定向</label><label for="zh-features-__tabbed_35_3">保留路径的重定向</label><label for="zh-features-__tabbed_35_4">临时重定向</label><label for="zh-features-__tabbed_35_5">子域名整合</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个将多个路径重定向到不同目标的配置：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 将 /blog 重定向到一个新的博客域名</span>
<span class="nt">REDIRECT_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/blog/&quot;</span>
<span class="nt">REDIRECT_TO</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://blog.example.com/&quot;</span>
<span class="nt">REDIRECT_TO_REQUEST_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REDIRECT_TO_STATUS_CODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;301&quot;</span>

<span class="c1"># 将 /shop 重定向到另一个域名</span>
<span class="nt">REDIRECT_FROM_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/shop/&quot;</span>
<span class="nt">REDIRECT_TO_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://shop.example.com/&quot;</span>
<span class="nt">REDIRECT_TO_REQUEST_URI_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
<span class="nt">REDIRECT_TO_STATUS_CODE_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;301&quot;</span>

<span class="c1"># 重定向网站的其余部分</span>
<span class="nt">REDIRECT_FROM_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="nt">REDIRECT_TO_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://new-domain.com&quot;</span>
<span class="nt">REDIRECT_TO_REQUEST_URI_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
<span class="nt">REDIRECT_TO_STATUS_CODE_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;301&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个将所有访问者重定向到一个新域名的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">REDIRECT_TO</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://new-domain.com&quot;</span>
<span class="nt">REDIRECT_TO_REQUEST_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
<span class="nt">REDIRECT_TO_STATUS_CODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;301&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个将访问者重定向到一个新域名，同时保留所请求路径的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">REDIRECT_TO</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://new-domain.com&quot;</span>
<span class="nt">REDIRECT_TO_REQUEST_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REDIRECT_TO_STATUS_CODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;301&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个用于临时重定向到维护站点的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">REDIRECT_TO</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://maintenance.example.com&quot;</span>
<span class="nt">REDIRECT_TO_REQUEST_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
<span class="nt">REDIRECT_TO_STATUS_CODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;302&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个将子域名重定向到主域名上特定路径的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">REDIRECT_TO</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/support&quot;</span>
<span class="nt">REDIRECT_TO_REQUEST_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REDIRECT_TO_STATUS_CODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;301&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-redis">Redis</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>Redis 插件将 <a href="https://redis.io/">Redis</a> 或 <a href="https://valkey.io/">Valkey</a> 集成到 BunkerWeb 中，用于缓存和快速数据检索。此功能对于在需要跨多个节点访问会话数据、指标和其他共享信息的高可用性环境中部署 BunkerWeb 至关重要。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>启用后，BunkerWeb 会与您配置的 Redis 或 Valkey 服务器建立连接。</li>
<li>会话信息、指标和安全相关数据等关键数据存储在 Redis/Valkey 中。</li>
<li>多个 BunkerWeb 实例可以共享这些数据，从而实现无缝集群和负载均衡。</li>
<li>该插件支持各种 Redis/Valkey 部署选项，包括独立服务器、密码验证、SSL/TLS 加密和用于高可用性的 Redis Sentinel。</li>
<li>自动重新连接和可配置的超时可确保在生产环境中的稳健性。</li>
</ol>
<h3 id="zh-features-_100">如何使用</h3>
<p>请按照以下步骤配置和使用 Redis 插件：</p>
<ol>
<li><strong>启用该功能：</strong> 将 <code>USE_REDIS</code> 设置为 <code>yes</code> 以启用 Redis/Valkey 集成。</li>
<li><strong>配置连接详细信息：</strong> 指定您的 Redis/Valkey 服务器的主机名/IP 地址和端口。</li>
<li><strong>设置安全选项：</strong> 如果您的 Redis/Valkey 服务器需要，请配置身份验证凭据。</li>
<li><strong>配置高级选项：</strong> 根据需要设置数据库选择、SSL 选项和超时。</li>
<li><strong>对于高可用性，</strong>如果您正在使用 Redis Sentinel，请配置 Sentinel 设置。</li>
</ol>
<h3 id="zh-features-_101">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_REDIS</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>启用 Redis：</strong> 设置为 <code>yes</code> 以启用 Redis/Valkey 集成以用于集群模式。</td>
</tr>
<tr>
<td><code>REDIS_HOST</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>Redis/Valkey 服务器：</strong> Redis/Valkey 服务器的 IP 地址或主机名。</td>
</tr>
<tr>
<td><code>REDIS_PORT</code></td>
<td><code>6379</code></td>
<td>global</td>
<td>否</td>
<td><strong>Redis/Valkey 端口：</strong> Redis/Valkey 服务器的端口号。</td>
</tr>
<tr>
<td><code>REDIS_DATABASE</code></td>
<td><code>0</code></td>
<td>global</td>
<td>否</td>
<td><strong>Redis/Valkey 数据库：</strong> 在 Redis/Valkey 服务器上使用的数据库编号 (0-15)。</td>
</tr>
<tr>
<td><code>REDIS_SSL</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td><strong>Redis/Valkey SSL：</strong> 设置为 <code>yes</code> 以启用 Redis/Valkey 连接的 SSL/TLS 加密。</td>
</tr>
<tr>
<td><code>REDIS_SSL_VERIFY</code></td>
<td><code>yes</code></td>
<td>global</td>
<td>否</td>
<td><strong>Redis/Valkey SSL 验证：</strong> 设置为 <code>yes</code> 以验证 Redis/Valkey 服务器的 SSL 证书。</td>
</tr>
<tr>
<td><code>REDIS_TIMEOUT</code></td>
<td><code>5</code></td>
<td>global</td>
<td>否</td>
<td><strong>Redis/Valkey 超时：</strong> Redis/Valkey 操作的连接超时时间（秒）。</td>
</tr>
<tr>
<td><code>REDIS_USERNAME</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>Redis/Valkey 用户名：</strong> 用于 Redis/Valkey 身份验证的用户名 (Redis 6.0+)。</td>
</tr>
<tr>
<td><code>REDIS_PASSWORD</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>Redis/Valkey 密码：</strong> 用于 Redis/Valkey 身份验证的密码。</td>
</tr>
<tr>
<td><code>REDIS_SENTINEL_HOSTS</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>Sentinel 主机：</strong> Redis Sentinel 主机的空格分隔列表 (hostname:port)。</td>
</tr>
<tr>
<td><code>REDIS_SENTINEL_USERNAME</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>Sentinel 用户名：</strong> 用于 Redis Sentinel 身份验证的用户名。</td>
</tr>
<tr>
<td><code>REDIS_SENTINEL_PASSWORD</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td><strong>Sentinel 密码：</strong> 用于 Redis Sentinel 身份验证的密码。</td>
</tr>
<tr>
<td><code>REDIS_SENTINEL_MASTER</code></td>
<td><code>mymaster</code></td>
<td>global</td>
<td>否</td>
<td><strong>Sentinel 主节点：</strong> Redis Sentinel 配置中主节点的名称。</td>
</tr>
<tr>
<td><code>REDIS_KEEPALIVE_IDLE</code></td>
<td><code>300</code></td>
<td>global</td>
<td>否</td>
<td><strong>Keepalive 空闲时间：</strong> 空闲连接的 TCP keepalive 探测之间的时间（秒）。</td>
</tr>
<tr>
<td><code>REDIS_KEEPALIVE_POOL</code></td>
<td><code>3</code></td>
<td>global</td>
<td>否</td>
<td><strong>Keepalive 池：</strong> 池中保留的最大 Redis/Valkey 连接数。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">使用 Redis Sentinel 实现高可用性</p>
<p>对于需要高可用性的生产环境，请配置 Redis Sentinel 设置。如果主 Redis 服务器不可用，这将提供自动故障转移功能。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">安全注意事项</p>
<p>在生产环境中使用 Redis 时：</p>
<ul>
<li>始终为 Redis 和 Sentinel 身份验证设置强密码</li>
<li>考虑为 Redis 连接启用 SSL/TLS 加密</li>
<li>确保您的 Redis 服务器未暴露于公共互联网</li>
<li>使用防火墙或网络分段限制对 Redis 端口的访问</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">集群要求</p>
<p>在集群中部署 BunkerWeb 时：</p>
<ul>
<li>所有 BunkerWeb 实例都应连接到相同的 Redis 或 Valkey 服务器或 Sentinel 集群</li>
<li>在所有实例中配置相同的数据库编号</li>
<li>确保所有 BunkerWeb 实例与 Redis/Valkey 服务器之间的网络连接</li>
</ul>
</div>
<h3 id="zh-features-_102">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="36:4"><input checked="checked" id="zh-features-__tabbed_36_1" name="zh-features-__tabbed_36" type="radio" /><input id="zh-features-__tabbed_36_2" name="zh-features-__tabbed_36" type="radio" /><input id="zh-features-__tabbed_36_3" name="zh-features-__tabbed_36" type="radio" /><input id="zh-features-__tabbed_36_4" name="zh-features-__tabbed_36" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_36_1">基本配置</label><label for="zh-features-__tabbed_36_2">安全配置</label><label for="zh-features-__tabbed_36_3">Redis Sentinel 配置</label><label for="zh-features-__tabbed_36_4">高级调优</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个用于连接到本地计算机上的 Redis 或 Valkey 服务器的简单配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span>
<span class="nt">REDIS_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;6379&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>启用了密码身份验证和 SSL 的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;redis.example.com&quot;</span>
<span class="nt">REDIS_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;6379&quot;</span>
<span class="nt">REDIS_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-strong-password&quot;</span>
<span class="nt">REDIS_SSL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REDIS_SSL_VERIFY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用 Redis Sentinel 实现高可用性的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REDIS_SENTINEL_HOSTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sentinel1:26379</span><span class="nv"> </span><span class="s">sentinel2:26379</span><span class="nv"> </span><span class="s">sentinel3:26379&quot;</span>
<span class="nt">REDIS_SENTINEL_MASTER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mymaster&quot;</span>
<span class="nt">REDIS_SENTINEL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sentinel-password&quot;</span>
<span class="nt">REDIS_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;redis-password&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>具有用于性能优化的高级连接参数的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;redis.example.com&quot;</span>
<span class="nt">REDIS_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;6379&quot;</span>
<span class="nt">REDIS_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-strong-password&quot;</span>
<span class="nt">REDIS_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3&quot;</span>
<span class="nt">REDIS_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3&quot;</span>
<span class="nt">REDIS_KEEPALIVE_IDLE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60&quot;</span>
<span class="nt">REDIS_KEEPALIVE_POOL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="zh-features-redis_1">Redis 最佳实践</h3>
<p>在使用 Redis 或 Valkey 与 BunkerWeb 时，请考虑以下最佳实践以确保最佳性能、安全性和可靠性：</p>
<h4 id="zh-features-_103">内存管理</h4>
<ul>
<li><strong>监控内存使用情况：</strong> 使用适当的 <code>maxmemory</code> 设置配置 Redis，以防止内存不足错误</li>
<li><strong>设置淘汰策略：</strong> 使用适合您用例的 <code>maxmemory-policy</code>（例如 <code>volatile-lru</code> 或 <code>allkeys-lru</code>）</li>
<li><strong>避免大键：</strong> 确保将单个 Redis 键保持在合理的大小，以防止性能下降</li>
</ul>
<h4 id="zh-features-_104">数据持久性</h4>
<ul>
<li><strong>启用 RDB 快照：</strong> 配置定期快照以实现数据持久性，而不会对性能产生重大影响</li>
<li><strong>考虑 AOF：</strong> 对于关键数据，启用具有适当 fsync 策略的 AOF（仅追加文件）持久性</li>
<li><strong>备份策略：</strong> 将定期 Redis 备份作为灾难恢复计划的一部分</li>
</ul>
<h4 id="zh-features-_105">性能优化</h4>
<ul>
<li><strong>连接池：</strong> BunkerWeb 已经实现了这一点，但请确保其他应用程序遵循此实践</li>
<li><strong>管道：</strong> 如果可能，请使用管道进行批量操作以减少网络开销</li>
<li><strong>避免昂贵的操作：</strong> 在生产环境中谨慎使用像 KEYS 这样的命令</li>
<li><strong>对您的工作负载进行基准测试：</strong> 使用 redis-benchmark 测试您的特定工作负载模式</li>
</ul>
<h3 id="zh-features-_106">更多资源</h3>
<ul>
<li><a href="https://redis.io/documentation">Redis 文档</a></li>
<li><a href="https://redis.io/topics/security">Redis 安全指南</a></li>
<li><a href="https://redis.io/topics/sentinel">Redis 高可用性</a></li>
<li><a href="https://redis.io/topics/persistence">Redis 持久性</a></li>
</ul>
<h2 id="zh-features-reporting-pro">Reporting <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style='transform : translateY(3px);'> (PRO)</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>Regular reporting of important data from BunkerWeb (global, attacks, bans, requests, reasons, AS...). Monitoring pro plugin needed to work.</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>上下文</th>
<th>可重复</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_REPORTING_SMTP</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td>Enable sending the report via email.</td>
</tr>
<tr>
<td><code>USE_REPORTING_WEBHOOK</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td>Enable sending the report via webhook.</td>
</tr>
<tr>
<td><code>REPORTING_SCHEDULE</code></td>
<td><code>weekly</code></td>
<td>global</td>
<td>否</td>
<td>The frequency at which reports are sent.</td>
</tr>
<tr>
<td><code>REPORTING_WEBHOOK_URLS</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>List of webhook URLs to receive the report in Markdown (separated by spaces).</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_EMAILS</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>List of email addresses to receive the report in HTML format (separated by spaces).</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_HOST</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>The host server used for SMTP sending.</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_PORT</code></td>
<td><code>465</code></td>
<td>global</td>
<td>否</td>
<td>The port used for SMTP. Please note that there are different standards depending on the type of connection (SSL = 465, TLS = 587).</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_FROM_EMAIL</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>The email address used as the sender. Note that 2FA must be disabled for this email address.</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_FROM_USER</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>The user authentication value for sending via the from email address.</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_FROM_PASSWORD</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>The password authentication value for sending via the from email address.</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_SSL</code></td>
<td><code>SSL</code></td>
<td>global</td>
<td>否</td>
<td>Determine whether or not to use a secure connection for SMTP.</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_SUBJECT</code></td>
<td><code>BunkerWeb Report</code></td>
<td>global</td>
<td>否</td>
<td>The subject line of the email.</td>
</tr>
</tbody>
</table>
<h2 id="zh-features-reverse-proxy">Reverse proxy</h2>
<p>STREAM 支持 <img alt="⚠" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/26a0.svg" title=":warning:" /></p>
<p>反向代理插件为 BunkerWeb 提供了无缝的代理功能，允许您将请求路由到后端服务器和服务。此功能使 BunkerWeb 能够充当您应用程序的安全前端，同时提供 SSL 终止和安全过滤等额外的好处。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当客户端向 BunkerWeb 发送请求时，反向代理插件会将请求转发到您配置的后端服务器。</li>
<li>在将请求传递给您的应用程序之前，BunkerWeb 会添加安全标头、应用 WAF 规则并执行其他安全检查。</li>
<li>后端服务器处理请求并向 BunkerWeb 返回响应。</li>
<li>BunkerWeb 在将响应发送回客户端之前，会对响应应用额外的安全措施。</li>
<li>该插件支持 HTTP 和 TCP/UDP 流代理，从而支持包括 WebSockets 和其他非 HTTP 协议在内的广泛应用。</li>
</ol>
<h3 id="zh-features-_107">如何使用</h3>
<p>请按照以下步骤配置和使用反向代理功能：</p>
<ol>
<li><strong>启用该功能：</strong> 将 <code>USE_REVERSE_PROXY</code> 设置为 <code>yes</code> 以启用反向代理功能。</li>
<li><strong>配置您的后端服务器：</strong> 使用 <code>REVERSE_PROXY_HOST</code> 设置指定上游服务器。</li>
<li><strong>调整代理设置：</strong> 使用超时、缓冲区大小和其他参数的可选设置来微调行为。</li>
<li><strong>配置特定于协议的选项：</strong> 对于 WebSockets 或特殊的 HTTP 要求，请调整相应的设置。</li>
<li><strong>设置缓存（可选）：</strong> 启用和配置代理缓存，以提高频繁访问内容的性能。</li>
</ol>
<h3 id="zh-features-_108">配置指南</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="37:8"><input checked="checked" id="zh-features-__tabbed_37_1" name="zh-features-__tabbed_37" type="radio" /><input id="zh-features-__tabbed_37_2" name="zh-features-__tabbed_37" type="radio" /><input id="zh-features-__tabbed_37_3" name="zh-features-__tabbed_37" type="radio" /><input id="zh-features-__tabbed_37_4" name="zh-features-__tabbed_37" type="radio" /><input id="zh-features-__tabbed_37_5" name="zh-features-__tabbed_37" type="radio" /><input id="zh-features-__tabbed_37_6" name="zh-features-__tabbed_37" type="radio" /><input id="zh-features-__tabbed_37_7" name="zh-features-__tabbed_37" type="radio" /><input id="zh-features-__tabbed_37_8" name="zh-features-__tabbed_37" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_37_1">基本配置</label><label for="zh-features-__tabbed_37_2">连接设置</label><label for="zh-features-__tabbed_37_3">SSL/TLS 配置</label><label for="zh-features-__tabbed_37_4">协议支持</label><label for="zh-features-__tabbed_37_5">标头管理</label><label for="zh-features-__tabbed_37_6">认证</label><label for="zh-features-__tabbed_37_7">高级配置</label><label for="zh-features-__tabbed_37_8">缓存配置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><strong>核心设置</strong></p>
<p>基本的配置设置启用并控制反向代理功能的基本功能。</p>
<div class="admonition success">
<p class="admonition-title">反向代理的好处</p>
<ul>
<li><strong>安全增强：</strong> 所有流量在到达您的应用程序之前都会经过 BunkerWeb 的安全层</li>
<li><strong>SSL 终止：</strong> 集中管理 SSL/TLS 证书，而后端服务可以使用未加密的连接</li>
<li><strong>协议处理：</strong> 支持 HTTP、HTTPS、WebSockets 和其他协议</li>
<li><strong>错误拦截：</strong> 自定义错误页面以获得一致的用户体验</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_REVERSE_PROXY</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用反向代理：</strong> 设置为 <code>yes</code> 以启用反向代理功能。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_HOST</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>后端主机：</strong> 代理资源的完整 URL (proxy_pass)。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_URL</code></td>
<td><code>/</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>位置 URL：</strong> 将被代理到后端服务器的路径。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_BUFFERING</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>响应缓冲：</strong> 启用或禁用来自代理资源的响应缓冲。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_KEEPALIVE</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>保持连接：</strong> 启用或禁用与代理资源的保持连接。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_CUSTOM_HOST</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>自定义主机：</strong> 覆盖发送到上游服务器的 Host 标头。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_INTERCEPT_ERRORS</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>拦截错误：</strong> 是否拦截和重写来自后端的错误响应。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">最佳实践</p>
<ul>
<li>始终在 <code>REVERSE_PROXY_HOST</code> 中指定完整的 URL，包括协议（http:// 或 https://）</li>
<li>使用 <code>REVERSE_PROXY_INTERCEPT_ERRORS</code> 在您所有服务中提供一致的错误页面</li>
<li>当配置多个后端时，使用带编号的后缀格式（例如，<code>REVERSE_PROXY_HOST_2</code>、<code>REVERSE_PROXY_URL_2</code>）</li>
</ul>
</div>
</div>
<div class="tabbed-block">
<p><strong>连接和超时配置</strong></p>
<p>这些设置控制代理连接的连接行为、缓冲和超时值。</p>
<div class="admonition success">
<p class="admonition-title">好处</p>
<ul>
<li><strong>优化性能：</strong> 根据您的应用程序需求调整缓冲区大小和连接设置</li>
<li><strong>资源管理：</strong> 通过适当的缓冲区配置控制内存使用</li>
<li><strong>可靠性：</strong> 配置适当的超时以处理慢速连接或后端问题</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>REVERSE_PROXY_CONNECT_TIMEOUT</code></td>
<td><code>60s</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>连接超时：</strong> 建立到后端服务器连接的最长时间。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_READ_TIMEOUT</code></td>
<td><code>60s</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>读取超时：</strong> 从后端服务器传输两个连续数据包之间的最长时间。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_SEND_TIMEOUT</code></td>
<td><code>60s</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>发送超时：</strong> 向后端服务器传输两个连续数据包之间的最长时间。</td>
</tr>
<tr>
<td><code>PROXY_BUFFERS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>缓冲区：</strong> 用于从后端服务器读取响应的缓冲区的数量和大小。</td>
</tr>
<tr>
<td><code>PROXY_BUFFER_SIZE</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>缓冲区大小：</strong> 用于从后端服务器读取响应第一部分的大小。</td>
</tr>
<tr>
<td><code>PROXY_BUSY_BUFFERS_SIZE</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>繁忙缓冲区大小：</strong> 可用于向客户端发送响应的繁忙缓冲区的大小。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">超时注意事项</p>
<ul>
<li>设置过低的超时可能会导致合法但缓慢的连接被终止</li>
<li>设置过高的超时可能会不必要地保持连接打开，从而可能耗尽资源</li>
<li>对于 WebSocket 应用程序，请显著增加读取和发送超时（建议 300 秒或更长）</li>
</ul>
</div>
</div>
<div class="tabbed-block">
<p><strong>后端连接的 SSL/TLS 设置</strong></p>
<p>这些设置控制 BunkerWeb 如何与后端服务器建立安全连接。</p>
<div class="admonition success">
<p class="admonition-title">好处</p>
<ul>
<li><strong>端到端加密：</strong> 保持从客户端到后端的加密连接</li>
<li><strong>证书验证：</strong> 控制如何验证后端服务器证书</li>
<li><strong>SNI 支持：</strong> 为托管多个站点的后端指定服务器名称指示</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>REVERSE_PROXY_SSL_SNI</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>SSL SNI：</strong> 启用或禁用向上游发送 SNI（服务器名称指示）。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_SSL_SNI_NAME</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>SSL SNI 名称：</strong> 当启用 SSL SNI 时，设置要发送到上游的 SNI 主机名。</td>
</tr>
</tbody>
</table>
<div class="admonition info">
<p class="admonition-title">SNI 解释</p>
<p>服务器名称指示 (SNI) 是 TLS 的一个扩展，它允许客户端在握手过程中指定它试图连接的主机名。这使服务器能够在同一个 IP 地址和端口上呈现多个证书，从而允许从单个 IP 地址提供多个安全 (HTTPS) 网站，而无需所有这些网站都使用相同的证书。</p>
</div>
</div>
<div class="tabbed-block">
<p><strong>协议特定配置</strong></p>
<p>配置特殊的协议处理，特别是对于 WebSockets 和其他非 HTTP 协议。</p>
<div class="admonition success">
<p class="admonition-title">好处</p>
<ul>
<li><strong>协议灵活性：</strong> 支持 WebSockets 使实时应用程序成为可能</li>
<li><strong>现代 Web 应用：</strong> 启用需要双向通信的交互式功能</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>REVERSE_PROXY_WS</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>WebSocket 支持：</strong> 在资源上启用 WebSocket 协议。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">WebSocket 配置</p>
<ul>
<li>当使用 <code>REVERSE_PROXY_WS: "yes"</code> 启用 WebSockets 时，请考虑增加超时值</li>
<li>WebSocket 连接的保持时间比典型的 HTTP 连接更长</li>
<li>对于 WebSocket 应用程序，推荐的配置是：
  <div class="highlight"><pre><span></span><code><span class="nt">REVERSE_PROXY_WS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REVERSE_PROXY_READ_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;300s&quot;</span>
<span class="nt">REVERSE_PROXY_SEND_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;300s&quot;</span>
</code></pre></div></li>
</ul>
</div>
</div>
<div class="tabbed-block">
<p><strong>HTTP 标头配置</strong></p>
<p>控制哪些标头发送到后端服务器和客户端，允许您添加、修改或保留 HTTP 标头。</p>
<div class="admonition success">
<p class="admonition-title">好处</p>
<ul>
<li><strong>信息控制：</strong> 精确管理在客户端和后端之间共享的信息</li>
<li><strong>安全增强：</strong> 添加与安全相关的标头或删除可能泄露敏感信息的标头</li>
<li><strong>集成支持：</strong> 为身份验证和正常的后端操作提供必要的标头</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>REVERSE_PROXY_HEADERS</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>自定义标头：</strong> 发送到后端的 HTTP 标头，用分号分隔。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_HIDE_HEADERS</code></td>
<td><code>Upgrade</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>隐藏标头：</strong> 从后端接收时向客户端隐藏的 HTTP 标头。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_HEADERS_CLIENT</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>客户端标头：</strong> 发送给客户端的 HTTP 标头，用分号分隔。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_UNDERSCORES_IN_HEADERS</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>标头中使用下划线：</strong> 启用或禁用 <code>underscores_in_headers</code> 指令。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">安全注意事项</p>
<p>使用反向代理功能时，请谨慎转发哪些标头到您的后端应用程序。某些标头可能会暴露有关您的基础架构的敏感信息或绕过安全控制。</p>
</div>
<div class="admonition example">
<p class="admonition-title">标头格式示例</p>
<p>发送到后端服务器的自定义标头：
<div class="highlight"><pre><span></span><code>REVERSE_PROXY_HEADERS: &quot;X-Real-IP $remote_addr;X-Forwarded-For $proxy_add_x_forwarded_for;X-Forwarded-Proto $scheme&quot;
</code></pre></div></p>
<p>发送给客户端的自定义标头：
<div class="highlight"><pre><span></span><code>REVERSE_PROXY_HEADERS_CLIENT: &quot;X-Powered-By BunkerWeb;X-Frame-Options SAMEORIGIN&quot;
</code></pre></div></p>
</div>
</div>
<div class="tabbed-block">
<p><strong>外部认证配置</strong></p>
<p>与外部认证系统集成，以集中管理您应用程序的授权逻辑。</p>
<div class="admonition success">
<p class="admonition-title">好处</p>
<ul>
<li><strong>集中式认证：</strong> 为多个应用程序实现单一认证点</li>
<li><strong>一致的安全性：</strong> 在不同服务之间应用统一的认证策略</li>
<li><strong>增强的控制：</strong> 通过标头或变量将认证详细信息转发到后端应用程序</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>REVERSE_PROXY_AUTH_REQUEST</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>认证请求：</strong> 使用外部提供商启用认证。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_AUTH_REQUEST_SIGNIN_URL</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>登录 URL：</strong> 当认证失败时，将客户端重定向到登录 URL。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_AUTH_REQUEST_SET</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>认证请求设置：</strong> 从认证提供商设置的变量。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">认证集成</p>
<ul>
<li>认证请求功能可以实现集中式认证微服务</li>
<li>您的认证服务应在成功认证时返回 200 状态码，失败时返回 401/403</li>
<li>使用 auth_request_set 指令从认证服务中提取并转发信息</li>
</ul>
</div>
</div>
<div class="tabbed-block">
<p><strong>附加配置选项</strong></p>
<p>这些设置为特殊场景提供了对反向代理行为的进一步定制。</p>
<div class="admonition success">
<p class="admonition-title">好处</p>
<ul>
<li><strong>定制化：</strong> 为复杂需求包含额外的配置片段</li>
<li><strong>性能优化：</strong> 针对特定用例微调请求处理</li>
<li><strong>灵活性：</strong> 通过专门的配置适应独特的应用程序需求</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>REVERSE_PROXY_INCLUDES</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>附加配置：</strong> 在 location 块中包含额外的配置。</td>
</tr>
<tr>
<td><code>REVERSE_PROXY_PASS_REQUEST_BODY</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>是</td>
<td><strong>传递请求体：</strong> 启用或禁用传递请求体。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">安全注意事项</p>
<p>包含自定义配置片段时请小心，因为如果配置不当，它们可能会覆盖 BunkerWeb 的安全设置或引入漏洞。</p>
</div>
</div>
<div class="tabbed-block">
<p><strong>响应缓存设置</strong></p>
<p>通过缓存来自后端服务器的响应来提高性能，减少负载并改善响应时间。</p>
<div class="admonition success">
<p class="admonition-title">好处</p>
<ul>
<li><strong>性能：</strong> 通过提供缓存内容来减少后端服务器的负载</li>
<li><strong>减少延迟：</strong> 对频繁请求的内容响应时间更快</li>
<li><strong>节省带宽：</strong> 通过缓存响应来最小化内部网络流量</li>
<li><strong>定制化：</strong> 精确配置缓存的内容、时间和方式</li>
</ul>
</div>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_PROXY_CACHE</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用缓存：</strong> 设置为 <code>yes</code> 以启用后端响应的缓存。</td>
</tr>
<tr>
<td><code>PROXY_CACHE_PATH_LEVELS</code></td>
<td><code>1:2</code></td>
<td>global</td>
<td>否</td>
<td><strong>缓存路径级别：</strong> 如何构建缓存目录层次结构。</td>
</tr>
<tr>
<td><code>PROXY_CACHE_PATH_ZONE_SIZE</code></td>
<td><code>10m</code></td>
<td>global</td>
<td>否</td>
<td><strong>缓存区域大小：</strong> 用于缓存元数据的共享内存区域的大小。</td>
</tr>
<tr>
<td><code>PROXY_CACHE_PATH_PARAMS</code></td>
<td><code>max_size=100m</code></td>
<td>global</td>
<td>否</td>
<td><strong>缓存路径参数：</strong> 缓存路径的附加参数。</td>
</tr>
<tr>
<td><code>PROXY_CACHE_METHODS</code></td>
<td><code>GET HEAD</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>缓存方法：</strong> 可以被缓存的 HTTP 方法。</td>
</tr>
<tr>
<td><code>PROXY_CACHE_MIN_USES</code></td>
<td><code>2</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>缓存最小使用次数：</strong> 响应被缓存前的最小请求次数。</td>
</tr>
<tr>
<td><code>PROXY_CACHE_KEY</code></td>
<td><code>$scheme$host$request_uri</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>缓存键：</strong> 用于唯一标识缓存响应的键。</td>
</tr>
<tr>
<td><code>PROXY_CACHE_VALID</code></td>
<td><code>200=24h 301=1h 302=24h</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>缓存有效期：</strong> 特定响应码的缓存时间。</td>
</tr>
<tr>
<td><code>PROXY_NO_CACHE</code></td>
<td><code>$http_pragma $http_authorization</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>不缓存：</strong> 即使通常可缓存也不缓存响应的条件。</td>
</tr>
<tr>
<td><code>PROXY_CACHE_BYPASS</code></td>
<td><code>0</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>绕过缓存：</strong> 绕过缓存的条件。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">缓存最佳实践</p>
<ul>
<li>只缓存不经常更改或非个性化的内容</li>
<li>根据内容类型使用适当的缓存持续时间（静态资源可以缓存更长时间）</li>
<li>配置 <code>PROXY_NO_CACHE</code> 以避免缓存敏感或个性化内容</li>
<li>监控缓存命中率并相应地调整设置</li>
</ul>
</div>
</div>
</div>
</div>
<div class="admonition danger">
<p class="admonition-title">Docker Compose 用户 - NGINX 变量</p>
<p>当在 Docker Compose 中使用 NGINX 变量进行配置时，您必须通过使用双美元符号 (<code>$$</code>) 来转义美元符号 (<code>$</code>)。这适用于所有包含 NGINX 变量的设置，如 <code>$remote_addr</code>、<code>$proxy_add_x_forwarded_for</code> 等。</p>
<p>如果不进行此转义，Docker Compose 将尝试用环境变量替换这些变量，而这些环境变量通常不存在，导致您的 NGINX 配置中出现空值。</p>
</div>
<h3 id="zh-features-_109">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="38:6"><input checked="checked" id="zh-features-__tabbed_38_1" name="zh-features-__tabbed_38" type="radio" /><input id="zh-features-__tabbed_38_2" name="zh-features-__tabbed_38" type="radio" /><input id="zh-features-__tabbed_38_3" name="zh-features-__tabbed_38" type="radio" /><input id="zh-features-__tabbed_38_4" name="zh-features-__tabbed_38" type="radio" /><input id="zh-features-__tabbed_38_5" name="zh-features-__tabbed_38" type="radio" /><input id="zh-features-__tabbed_38_6" name="zh-features-__tabbed_38" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_38_1">基本 HTTP 代理</label><label for="zh-features-__tabbed_38_2">WebSocket 应用</label><label for="zh-features-__tabbed_38_3">多个位置</label><label for="zh-features-__tabbed_38_4">缓存配置</label><label for="zh-features-__tabbed_38_5">高级标头管理</label><label for="zh-features-__tabbed_38_6">认证集成</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个用于将 HTTP 请求代理到后端应用服务器的简单配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://application:8080&quot;</span>
<span class="nt">REVERSE_PROXY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="nt">REVERSE_PROXY_CONNECT_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10s&quot;</span>
<span class="nt">REVERSE_PROXY_SEND_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60s&quot;</span>
<span class="nt">REVERSE_PROXY_READ_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60s&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>为 WebSocket 应用程序优化的配置，具有更长的超时时间：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://websocket-app:8080&quot;</span>
<span class="nt">REVERSE_PROXY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="nt">REVERSE_PROXY_WS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REVERSE_PROXY_CONNECT_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10s&quot;</span>
<span class="nt">REVERSE_PROXY_SEND_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;300s&quot;</span>
<span class="nt">REVERSE_PROXY_READ_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;300s&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>将不同路径路由到不同后端服务的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>

<span class="c1"># API 后端</span>
<span class="nt">REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://api-server:8080&quot;</span>
<span class="nt">REVERSE_PROXY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/api/&quot;</span>

<span class="c1"># 管理后端</span>
<span class="nt">REVERSE_PROXY_HOST_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://admin-server:8080&quot;</span>
<span class="nt">REVERSE_PROXY_URL_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/admin/&quot;</span>

<span class="c1"># 前端应用</span>
<span class="nt">REVERSE_PROXY_HOST_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://frontend:3000&quot;</span>
<span class="nt">REVERSE_PROXY_URL_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>启用了代理缓存以提高性能的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://application:8080&quot;</span>
<span class="nt">REVERSE_PROXY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="nt">USE_PROXY_CACHE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">PROXY_CACHE_VALID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;200=24h</span><span class="nv"> </span><span class="s">301=1h</span><span class="nv"> </span><span class="s">302=24h&quot;</span>
<span class="nt">PROXY_CACHE_METHODS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GET</span><span class="nv"> </span><span class="s">HEAD&quot;</span>
<span class="nt">PROXY_NO_CACHE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;$http_authorization&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>具有自定义标头操作的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://application:8080&quot;</span>
<span class="nt">REVERSE_PROXY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>

<span class="c1"># 发送到后端的自定义标头</span>
<span class="nt">REVERSE_PROXY_HEADERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Real-IP</span><span class="nv"> </span><span class="s">$remote_addr;X-Forwarded-For</span><span class="nv"> </span><span class="s">$proxy_add_x_forwarded_for;X-Forwarded-Proto</span><span class="nv"> </span><span class="s">$scheme&quot;</span>

<span class="c1"># 发送给客户端的自定义标头</span>
<span class="nt">REVERSE_PROXY_HEADERS_CLIENT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Powered-By</span><span class="nv"> </span><span class="s">BunkerWeb;X-Frame-Options</span><span class="nv"> </span><span class="s">SAMEORIGIN&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>与外部认证集成的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://application:8080&quot;</span>
<span class="nt">REVERSE_PROXY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/&quot;</span>

<span class="c1"># 认证配置</span>
<span class="nt">REVERSE_PROXY_AUTH_REQUEST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/auth&quot;</span>
<span class="nt">REVERSE_PROXY_AUTH_REQUEST_SIGNIN_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://login.example.com&quot;</span>
<span class="nt">REVERSE_PROXY_AUTH_REQUEST_SET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;$auth_user</span><span class="nv"> </span><span class="s">$upstream_http_x_user;$auth_role</span><span class="nv"> </span><span class="s">$upstream_http_x_role&quot;</span>

<span class="c1"># 认证服务后端</span>
<span class="nt">REVERSE_PROXY_HOST_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://auth-service:8080&quot;</span>
<span class="nt">REVERSE_PROXY_URL_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/auth&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-reverse-scan">Reverse scan</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>反向扫描插件通过扫描客户端端口来检测其是否正在运行代理服务器或其他网络服务，从而有力地防止代理绕过企图。此功能有助于识别和阻止可能试图隐藏其真实身份或来源的客户端带来的潜在威胁，从而增强您网站的安全状况。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当客户端连接到您的服务器时，BunkerWeb 会尝试扫描客户端 IP 地址上的特定端口。</li>
<li>该插件会检查客户端上是否有任何常见的代理端口（例如 80、443、8080 等）处于打开状态。</li>
<li>如果检测到打开的端口，表明客户端可能正在运行代理服务器，则连接将被拒绝。</li>
<li>这为防止自动化工具、机器人和试图掩盖其身份的恶意用户增加了一层额外的安全保障。</li>
</ol>
<div class="admonition success">
<p class="admonition-title">主要优势</p>
<ol>
<li><strong>增强安全性：</strong> 识别可能运行用于恶意目的的代理服务器的客户端。</li>
<li><strong>代理检测：</strong> 帮助检测并阻止试图隐藏其真实身份的客户端。</li>
<li><strong>可配置设置：</strong> 根据您的特定安全要求自定义要扫描的端口。</li>
<li><strong>性能优化：</strong> 智能扫描，具有可配置的超时，以最大限度地减少对合法用户的影响。</li>
<li><strong>无缝集成：</strong> 与您现有的安全层透明地协同工作。</li>
</ol>
</div>
<h3 id="zh-features-_110">如何使用</h3>
<p>请按照以下步骤配置和使用反向扫描功能：</p>
<ol>
<li><strong>启用该功能：</strong> 将 <code>USE_REVERSE_SCAN</code> 设置为 <code>yes</code> 以启用客户端端口扫描。</li>
<li><strong>配置要扫描的端口：</strong> 自定义 <code>REVERSE_SCAN_PORTS</code> 设置以指定应检查哪些客户端端口。</li>
<li><strong>设置扫描超时：</strong> 调整 <code>REVERSE_SCAN_TIMEOUT</code> 以在彻底扫描和性能之间取得平衡。</li>
<li><strong>监控扫描活动：</strong> 检查日志和 <a href="#zh-web-ui">Web UI</a> 以审查扫描结果和潜在的安全事件。</li>
</ol>
<h3 id="zh-features-_111">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_REVERSE_SCAN</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用反向扫描：</strong> 设置为 <code>yes</code> 以启用客户端端口扫描。</td>
</tr>
<tr>
<td><code>REVERSE_SCAN_PORTS</code></td>
<td><code>22 80 443 3128 8000 8080</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>要扫描的端口：</strong> 要在客户端检查的端口的空格分隔列表。</td>
</tr>
<tr>
<td><code>REVERSE_SCAN_TIMEOUT</code></td>
<td><code>500</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>扫描超时：</strong> 允许扫描端口的最长时间（毫秒）。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">性能注意事项</p>
<p>扫描多个端口会增加客户端连接的延迟。请使用适当的超时值并限制扫描的端口数量以保持良好的性能。</p>
</div>
<div class="admonition info">
<p class="admonition-title">常见代理端口</p>
<p>默认配置包括代理服务器（80、443、8080、3128）和 SSH（22）使用的常见端口。您可能需要根据您的威胁模型自定义此列表。</p>
</div>
<h3 id="zh-features-_112">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="39:4"><input checked="checked" id="zh-features-__tabbed_39_1" name="zh-features-__tabbed_39" type="radio" /><input id="zh-features-__tabbed_39_2" name="zh-features-__tabbed_39" type="radio" /><input id="zh-features-__tabbed_39_3" name="zh-features-__tabbed_39" type="radio" /><input id="zh-features-__tabbed_39_4" name="zh-features-__tabbed_39" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_39_1">基本配置</label><label for="zh-features-__tabbed_39_2">全面扫描</label><label for="zh-features-__tabbed_39_3">性能优化配置</label><label for="zh-features-__tabbed_39_4">高安全性配置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个用于启用客户端端口扫描的简单配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REVERSE_SCAN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REVERSE_SCAN_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500&quot;</span>
<span class="nt">REVERSE_SCAN_PORTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;80</span><span class="nv"> </span><span class="s">443</span><span class="nv"> </span><span class="s">8080&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个更彻底的配置，检查其他端口：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REVERSE_SCAN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REVERSE_SCAN_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1000&quot;</span>
<span class="nt">REVERSE_SCAN_PORTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;22</span><span class="nv"> </span><span class="s">80</span><span class="nv"> </span><span class="s">443</span><span class="nv"> </span><span class="s">3128</span><span class="nv"> </span><span class="s">8080</span><span class="nv"> </span><span class="s">8000</span><span class="nv"> </span><span class="s">8888</span><span class="nv"> </span><span class="s">1080</span><span class="nv"> </span><span class="s">3333</span><span class="nv"> </span><span class="s">8081&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>通过检查更少的端口和更低的超时来调整以获得更好性能的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REVERSE_SCAN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REVERSE_SCAN_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;250&quot;</span>
<span class="nt">REVERSE_SCAN_PORTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;80</span><span class="nv"> </span><span class="s">443</span><span class="nv"> </span><span class="s">8080&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>专注于最大安全性并进行扩展扫描的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_REVERSE_SCAN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REVERSE_SCAN_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1500&quot;</span>
<span class="nt">REVERSE_SCAN_PORTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;22</span><span class="nv"> </span><span class="s">25</span><span class="nv"> </span><span class="s">80</span><span class="nv"> </span><span class="s">443</span><span class="nv"> </span><span class="s">1080</span><span class="nv"> </span><span class="s">3128</span><span class="nv"> </span><span class="s">3333</span><span class="nv"> </span><span class="s">4444</span><span class="nv"> </span><span class="s">5555</span><span class="nv"> </span><span class="s">6588</span><span class="nv"> </span><span class="s">6666</span><span class="nv"> </span><span class="s">7777</span><span class="nv"> </span><span class="s">8000</span><span class="nv"> </span><span class="s">8080</span><span class="nv"> </span><span class="s">8081</span><span class="nv"> </span><span class="s">8800</span><span class="nv"> </span><span class="s">8888</span><span class="nv"> </span><span class="s">9999&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-robotstxt">Robots.txt</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>Robots.txt 插件为您的网站管理 <a href="https://www.robotstxt.org/">robots.txt</a> 文件。此文件告知网络爬虫和机器人它们可以或不可以访问您网站的哪些部分。</p>
<p><strong>工作原理：</strong></p>
<p>启用后，BunkerWeb 会在您网站的根目录下动态生成 <code>/robots.txt</code> 文件。此文件中的规则按以下顺序从多个来源聚合而成：</p>
<ol>
<li><strong>DarkVisitors API：</strong> 如果提供了 <code>ROBOTSTXT_DARKVISITORS_TOKEN</code>，规则将从 <a href="https://darkvisitors.com/">DarkVisitors</a> API 获取，从而可以根据配置的代理类型和不允许的用户代理动态阻止恶意机器人和 AI 爬虫。</li>
<li><strong>社区列表：</strong> 包含来自预定义、社区维护的 <code>robots.txt</code> 列表（由 <code>ROBOTSTXT_COMMUNITY_LISTS</code> 指定）的规则。</li>
<li><strong>自定义 URL：</strong> 规则从用户提供的 URL（由 <code>ROBOTSTXT_URLS</code> 指定）获取。</li>
<li><strong>手动规则：</strong> 添加直接通过 <code>ROBOTSTXT_RULE</code> 环境变量定义的规则。</li>
</ol>
<p>所有这些来源的规则都会被合并。聚合后，将应用 <code>ROBOTSTXT_IGNORE_RULE</code> 来使用 PCRE 正则表达式模式过滤掉任何不需要的规则。最后，如果整个过程后没有任何规则剩下，将自动应用默认的 <code>User-agent: *</code> 和 <code>Disallow: /</code> 规则，以确保基本级别的保护。可选的站点地图 URL（由 <code>ROBOTSTXT_SITEMAP</code> 指定）也会包含在最终的 <code>robots.txt</code> 输出中。</p>
<h3 id="zh-features-darkvisitors-api">使用 DarkVisitors API 动态规避机器人</h3>
<p><a href="https://darkvisitors.com/">DarkVisitors</a> 是一项提供动态 <code>robots.txt</code> 文件的服务，以帮助阻止已知的恶意机器人和 AI 爬虫。通过与 DarkVisitors 集成，BunkerWeb 可以自动获取并提供最新的 <code>robots.txt</code>，帮助保护您的网站免受不必要的自动化流量。</p>
<p>要启用此功能，您需要在 <a href="https://darkvisitors.com/docs/robots-txt">darkvisitors.com</a> 注册并获取一个 bearer 令牌。</p>
<h3 id="zh-features-_113">如何使用</h3>
<ol>
<li><strong>启用该功能：</strong> 将 <code>USE_ROBOTSTXT</code> 设置为 <code>yes</code>。</li>
<li><strong>配置规则：</strong> 选择一种或多种方法来定义您的 <code>robots.txt</code> 规则：<ul>
<li><strong>DarkVisitors API：</strong> 提供 <code>ROBOTSTXT_DARKVISITORS_TOKEN</code>，并可选择性地提供 <code>ROBOTSTXT_DARKVISITORS_AGENT_TYPES</code> 和 <code>ROBOTSTXT_DARKVISITORS_DISALLOW</code>。</li>
<li><strong>社区列表：</strong> 指定 <code>ROBOTSTXT_COMMUNITY_LISTS</code>（以空格分隔的 ID）。</li>
<li><strong>自定义 URL：</strong> 提供 <code>ROBOTSTXT_URLS</code>（以空格分隔的 URL）。</li>
<li><strong>手动规则：</strong> 使用 <code>ROBOTSTXT_RULE</code> 定义单个规则（可以使用 <code>ROBOTSTXT_RULE_N</code> 指定多个规则）。</li>
</ul>
</li>
<li><strong>过滤规则（可选）：</strong> 使用 <code>ROBOTSTXT_IGNORE_RULE_N</code> 通过正则表达式模式排除特定规则。</li>
<li><strong>添加站点地图（可选）：</strong> 使用 <code>ROBOTSTXT_SITEMAP_N</code> 定义站点地图 URL。</li>
<li><strong>获取生成的 robots.txt 文件：</strong> 在 BunkerWeb 使用上述设置运行后，您可以通过向 <code>http(s)://your-domain.com/robots.txt</code> 发出 HTTP GET 请求来访问动态生成的 <code>robots.txt</code> 文件。</li>
</ol>
<h3 id="zh-features-_114">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_ROBOTSTXT</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td>启用或禁用 <code>robots.txt</code> 功能。</td>
</tr>
<tr>
<td><code>ROBOTSTXT_DARKVISITORS_TOKEN</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td>用于 DarkVisitors API 的 Bearer 令牌。</td>
</tr>
<tr>
<td><code>ROBOTSTXT_DARKVISITORS_AGENT_TYPES</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td>从 DarkVisitors 包含的代理类型（例如 <code>AI Data Scraper</code>）的逗号分隔列表。</td>
</tr>
<tr>
<td><code>ROBOTSTXT_DARKVISITORS_DISALLOW</code></td>
<td><code>/</code></td>
<td>multisite</td>
<td>否</td>
<td>指定不允许哪些 URL 的字符串。在联系 DarkVisitors API 时，此值将作为 disallow 字段发送。</td>
</tr>
<tr>
<td><code>ROBOTSTXT_COMMUNITY_LISTS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td>要包含的社区维护规则集 ID 的空格分隔列表。</td>
</tr>
<tr>
<td><code>ROBOTSTXT_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td>用于获取额外 <code>robots.txt</code> 规则的 URL 的空格分隔列表。支持 <code>file://</code> 和基本身份验证 (<code>http://user:pass@url</code>)。</td>
</tr>
<tr>
<td><code>ROBOTSTXT_RULE</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><code>robots.txt</code> 的单条规则。</td>
</tr>
<tr>
<td><code>ROBOTSTXT_HEADER</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><code>robots.txt</code> 文件的页眉（在规则之前）。可以是 Base64 编码。</td>
</tr>
<tr>
<td><code>ROBOTSTXT_FOOTER</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><code>robots.txt</code> 文件的页脚（在规则之后）。可以是 Base64 编码。</td>
</tr>
<tr>
<td><code>ROBOTSTXT_IGNORE_RULE</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td>用于忽略规则的单个 PCRE 正则表达式模式。</td>
</tr>
<tr>
<td><code>ROBOTSTXT_SITEMAP</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td>单个站点地图 URL。</td>
</tr>
</tbody>
</table>
<h3 id="zh-features-_115">配置示例</h3>
<p><strong>基本手动规则</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_ROBOTSTXT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">ROBOTSTXT_RULE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;User-agent:</span><span class="nv"> </span><span class="s">*&quot;</span>
<span class="nt">ROBOTSTXT_RULE_1</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Disallow:</span><span class="nv"> </span><span class="s">/private&quot;</span>
<span class="nt">ROBOTSTXT_SITEMAP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/sitemap.xml&quot;</span><span class="err">```</span>

<span class="err">*</span><span class="nv">*使用动态源</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">(DarkVisitors &amp; 社区列表)**</span>

<span class="err">```</span><span class="l l-Scalar l-Scalar-Plain">yaml</span>
<span class="nt">USE_ROBOTSTXT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">ROBOTSTXT_DARKVISITORS_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-darkvisitors-token-here&quot;</span>
<span class="nt">ROBOTSTXT_DARKVISITORS_AGENT_TYPES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;AI</span><span class="nv"> </span><span class="s">Data</span><span class="nv"> </span><span class="s">Scraper&quot;</span>
<span class="nt">ROBOTSTXT_COMMUNITY_LISTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;robots-disallowed&quot;</span>
<span class="nt">ROBOTSTT_IGNORE_RULE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;User-agent:</span><span class="nv"> </span><span class="s">Googlebot-Image&quot;</span>
</code></pre></div>
<p><strong>组合配置</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_ROBOTSTXT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">ROBOTSTXT_DARKVISITORS_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-darkvisitors-token-here&quot;</span>
<span class="nt">ROBOTSTXT_COMMUNITY_LISTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ai-robots-txt&quot;</span>
<span class="nt">ROBOTSTXT_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/my-custom-rules.txt&quot;</span>
<span class="nt">ROBOTSTXT_RULE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;User-agent:</span><span class="nv"> </span><span class="s">MyOwnBot&quot;</span>
<span class="nt">ROBOTSTXT_RULE_1</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Disallow:</span><span class="nv"> </span><span class="s">/admin&quot;</span>
<span class="nt">ROBOTSTT_IGNORE_RULE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;User-agent:</span><span class="nv"> </span><span class="s">Googlebot-Image&quot;</span>
<span class="nt">ROBOTSTXT_SITEMAP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/sitemap.xml&quot;</span>
</code></pre></div>
<p><strong>带页眉和页脚</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_ROBOTSTXT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">ROBOTSTXT_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;#</span><span class="nv"> </span><span class="s">这是一个自定义页眉&quot;</span>
<span class="nt">ROBOTSTXT_RULE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;User-agent:</span><span class="nv"> </span><span class="s">*&quot;</span>
<span class="nt">ROBOTSTXT_RULE_1</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Disallow:</span><span class="nv"> </span><span class="s">/private&quot;</span>
<span class="nt">ROBOTSTXT_FOOTER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;#</span><span class="nv"> </span><span class="s">这是一个自定义页脚&quot;</span>
<span class="nt">ROBOTSTXT_SITEMAP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/sitemap.xml&quot;</span>
</code></pre></div>
<hr />
<p>更多信息，请参阅 <a href="https://www.robotstxt.org/robotstxt.html">robots.txt 文档</a>。</p>
<h2 id="zh-features-ssl">SSL</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>SSL 插件为您的 BunkerWeb 保护的网站提供强大的 SSL/TLS 加密功能。这个核心组件通过配置和优化加密协议、密码套件以及相关的安全设置来启用安全的 HTTPS 连接，以保护客户端和您的 Web 服务之间传输中的数据。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当客户端向您的网站发起 HTTPS 连接时，BunkerWeb 会使用您配置的设置处理 SSL/TLS 握手。</li>
<li>该插件强制使用现代加密协议和强大的密码套件，同时禁用已知的易受攻击的选项。</li>
<li>优化的 SSL 会话参数可在不牺牲安全性的情况下提高连接性能。</li>
<li>证书的呈现根据最佳实践进行配置，以确保兼容性和安全性。</li>
</ol>
<div class="admonition success">
<p class="admonition-title">安全优势</p>
<ul>
<li><strong>数据保护：</strong> 加密传输中的数据，防止窃听和中间人攻击</li>
<li><strong>身份验证：</strong> 向客户端验证您服务器的身份</li>
<li><strong>完整性：</strong> 确保数据在传输过程中未被篡改</li>
<li><strong>现代标准：</strong> 配置符合行业最佳实践和安全标准</li>
</ul>
</div>
<h3 id="zh-features-_116">如何使用</h3>
<p>请按照以下步骤配置和使用 SSL 功能：</p>
<ol>
<li><strong>配置协议：</strong> 使用 <code>SSL_PROTOCOLS</code> 设置选择要支持的 SSL/TLS 协议版本。</li>
<li><strong>选择密码套件：</strong> 使用 <code>SSL_CIPHERS_LEVEL</code> 设置指定加密强度，或使用 <code>SSL_CIPHERS_CUSTOM</code> 提供自定义密码。</li>
<li><strong>配置 HTTP 到 HTTPS 重定向：</strong> 使用 <code>AUTO_REDIRECT_HTTP_TO_HTTPS</code> 或 <code>REDIRECT_HTTP_TO_HTTPS</code> 设置来设置自动重定向。</li>
</ol>
<h3 id="zh-features-_117">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>REDIRECT_HTTP_TO_HTTPS</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>HTTP 重定向到 HTTPS：</strong> 当设置为 <code>yes</code> 时，所有 HTTP 请求都会重定向到 HTTPS。</td>
</tr>
<tr>
<td><code>AUTO_REDIRECT_HTTP_TO_HTTPS</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>自动 HTTP 重定向到 HTTPS：</strong> 当设置为 <code>yes</code> 时，如果检测到 HTTPS，则自动将 HTTP 重定向到 HTTPS。</td>
</tr>
<tr>
<td><code>SSL_PROTOCOLS</code></td>
<td><code>TLSv1.2 TLSv1.3</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>SSL 协议：</strong> 要支持的 SSL/TLS 协议的空格分隔列表。</td>
</tr>
<tr>
<td><code>SSL_CIPHERS_LEVEL</code></td>
<td><code>modern</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>SSL 密码级别：</strong> 密码套件的预设安全级别（<code>modern</code>、<code>intermediate</code> 或 <code>old</code>）。</td>
</tr>
<tr>
<td><code>SSL_CIPHERS_CUSTOM</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>自定义 SSL 密码：</strong> 用于 SSL/TLS 连接的密码套件的冒号分隔列表（覆盖级别）。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">SSL Labs 测试</p>
<p>配置 SSL 设置后，请使用 <a href="https://www.ssllabs.com/ssltest/">Qualys SSL Labs 服务器测试</a> 来验证您的配置并检查潜在的安全问题。一个正确的 BunkerWeb SSL 配置应该能获得 A+ 评级。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">协议选择</p>
<p>由于已知的漏洞，默认情况下有意禁用了对 SSLv3、TLSv1.0 和 TLSv1.1 等旧协议的支持。只有在您绝对需要支持旧版客户端并了解这样做的安全隐患时，才启用这些协议。</p>
</div>
<h3 id="zh-features-_118">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="40:4"><input checked="checked" id="zh-features-__tabbed_40_1" name="zh-features-__tabbed_40" type="radio" /><input id="zh-features-__tabbed_40_2" name="zh-features-__tabbed_40" type="radio" /><input id="zh-features-__tabbed_40_3" name="zh-features-__tabbed_40" type="radio" /><input id="zh-features-__tabbed_40_4" name="zh-features-__tabbed_40" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_40_1">现代安全（默认）</label><label for="zh-features-__tabbed_40_2">最高安全</label><label for="zh-features-__tabbed_40_3">旧版兼容性</label><label for="zh-features-__tabbed_40_4">自定义密码</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>默认配置提供了强大的安全性，同时保持了与现代浏览器的兼容性：</p>
<div class="highlight"><pre><span></span><code><span class="nt">LISTEN_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">SSL_PROTOCOLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;TLSv1.2</span><span class="nv"> </span><span class="s">TLSv1.3&quot;</span>
<span class="nt">SSL_CIPHERS_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;modern&quot;</span>
<span class="nt">AUTO_REDIRECT_HTTP_TO_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REDIRECT_HTTP_TO_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>专注于最高安全性的配置，可能会降低对旧版客户端的兼容性：</p>
<div class="highlight"><pre><span></span><code><span class="nt">LISTEN_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">SSL_PROTOCOLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;TLSv1.3&quot;</span>
<span class="nt">SSL_CIPHERS_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;modern&quot;</span>
<span class="nt">AUTO_REDIRECT_HTTP_TO_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">REDIRECT_HTTP_TO_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>为旧版客户端提供更广泛兼容性的配置（仅在必要时使用）：</p>
<div class="highlight"><pre><span></span><code><span class="nt">LISTEN_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">SSL_PROTOCOLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;TLSv1.2</span><span class="nv"> </span><span class="s">TLSv1.3&quot;</span>
<span class="nt">SSL_CIPHERS_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;old&quot;</span>
<span class="nt">AUTO_REDIRECT_HTTP_TO_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用自定义密码规范的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">LISTEN_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">SSL_PROTOCOLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;TLSv1.2</span><span class="nv"> </span><span class="s">TLSv1.3&quot;</span>
<span class="nt">SSL_CIPHERS_CUSTOM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305&quot;</span>
<span class="nt">AUTO_REDIRECT_HTTP_TO_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-securitytxt">Security.txt</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>Security.txt 插件为您的网站实施 <a href="https://securitytxt.org/">Security.txt</a> 标准 (<a href="https://www.rfc-editor.org/rfc/rfc9116">RFC 9116</a>)。此功能可帮助安全研究人员访问您的安全策略，并为他们提供一种标准化的方式来报告他们在您的系统中发现的安全漏洞。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>启用后，BunkerWeb 会在您网站的根目录下创建一个 <code>/.well-known/security.txt</code> 文件。</li>
<li>此文件包含有关您的安全策略、联系人和其他相关详细信息。</li>
<li>安全研究人员和自动化工具可以轻松地在标准位置找到此文件。</li>
<li>内容使用简单的设置进行配置，允许您指定联系信息、加密密钥、策略和致谢。</li>
<li>BunkerWeb 会自动根据 RFC 9116 格式化该文件。</li>
</ol>
<h3 id="zh-features-_119">如何使用</h3>
<p>请按照以下步骤配置和使用 Security.txt 功能：</p>
<ol>
<li><strong>启用该功能：</strong> 将 <code>USE_SECURITYTXT</code> 设置为 <code>yes</code> 以启用 security.txt 文件。</li>
<li><strong>配置联系信息：</strong> 使用 <code>SECURITYTXT_CONTACT</code> 设置至少指定一种联系方式。</li>
<li><strong>设置附加信息：</strong> 配置可选字段，如到期日期、加密、致谢和策略 URL。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 配置完成后，BunkerWeb 将自动在标准位置创建并提供 security.txt 文件。</li>
</ol>
<h3 id="zh-features-_120">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_SECURITYTXT</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用 Security.txt：</strong> 设置为 <code>yes</code> 以启用 security.txt 文件。</td>
</tr>
<tr>
<td><code>SECURITYTXT_URI</code></td>
<td><code>/.well-known/security.txt</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>Security.txt URI：</strong> 指示 security.txt 文件可访问的 URI。</td>
</tr>
<tr>
<td><code>SECURITYTXT_CONTACT</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>联系信息：</strong> 安全研究人员如何与您联系（例如，<code>mailto:security@example.com</code>）。</td>
</tr>
<tr>
<td><code>SECURITYTXT_EXPIRES</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>到期日期：</strong> 此 security.txt 文件应被视为到期的日期（ISO 8601 格式）。</td>
</tr>
<tr>
<td><code>SECURITYTXT_ENCRYPTION</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>加密：</strong> 指向用于安全通信的加密密钥的 URL。</td>
</tr>
<tr>
<td><code>SECURITYTXT_ACKNOWLEDGEMENTS</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>致谢：</strong> 认可安全研究人员报告的 URL。</td>
</tr>
<tr>
<td><code>SECURITYTXT_POLICY</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>安全策略：</strong> 指向描述如何报告漏洞的安全策略的 URL。</td>
</tr>
<tr>
<td><code>SECURITYTXT_HIRING</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>安全职位：</strong> 指向与安全相关的职位空缺的 URL。</td>
</tr>
<tr>
<td><code>SECURITYTXT_CANONICAL</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>规范 URL：</strong> 此 security.txt 文件的规范 URI。</td>
</tr>
<tr>
<td><code>SECURITYTXT_PREFERRED_LANG</code></td>
<td><code>en</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>首选语言：</strong> 通信中使用的语言。指定为 ISO 639-1 语言代码。</td>
</tr>
<tr>
<td><code>SECURITYTXT_CSAF</code></td>
<td></td>
<td>multisite</td>
<td>是</td>
<td><strong>CSAF：</strong> 指向您的通用安全咨询框架提供商的 provider-metadata.json 的链接。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">需要到期日期</p>
<p>根据 RFC 9116，<code>Expires</code> 字段是必需的。如果您没有为 <code>SECURITYTXT_EXPIRES</code> 提供值，BunkerWeb 会自动将到期日期设置为从当前日期算起的一年。</p>
</div>
<div class="admonition info">
<p class="admonition-title">联系信息至关重要</p>
<p><code>Contact</code> 字段是 security.txt 文件中最重要的部分。您应该至少提供一种方式让安全研究人员与您联系。这可以是电子邮件地址、Web 表单、电话号码或任何其他适合您组织的方式。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">URL 必须使用 HTTPS</p>
<p>根据 RFC 9116，security.txt 文件中的所有 URL（<code>mailto:</code> 和 <code>tel:</code> 链接除外）都必须使用 HTTPS。非 HTTPS URL 将被 BunkerWeb 自动转换为 HTTPS，以确保符合标准。</p>
</div>
<h3 id="zh-features-_121">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="41:3"><input checked="checked" id="zh-features-__tabbed_41_1" name="zh-features-__tabbed_41" type="radio" /><input id="zh-features-__tabbed_41_2" name="zh-features-__tabbed_41" type="radio" /><input id="zh-features-__tabbed_41_3" name="zh-features-__tabbed_41" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_41_1">基本配置</label><label for="zh-features-__tabbed_41_2">综合配置</label><label for="zh-features-__tabbed_41_3">多联系人配置</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个仅包含联系信息的最小配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_SECURITYTXT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">SECURITYTXT_CONTACT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mailto:security@example.com&quot;</span>
<span class="nt">SECURITYTXT_POLICY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/security-policy&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个包含所有字段的更完整的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_SECURITYTXT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">SECURITYTXT_CONTACT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mailto:security@example.com&quot;</span>
<span class="nt">SECURITYTXT_CONTACT_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/security-contact-form&quot;</span>
<span class="nt">SECURITYTXT_EXPIRES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-12-31T23:59:59+00:00&quot;</span>
<span class="nt">SECURITYTXT_ENCRYPTION</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/pgp-key.txt&quot;</span>
<span class="nt">SECURITYTXT_ACKNOWLEDGEMENTS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/hall-of-fame&quot;</span>
<span class="nt">SECURITYTXT_POLICY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/security-policy&quot;</span>
<span class="nt">SECURITYTXT_HIRING</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/jobs/security&quot;</span>
<span class="nt">SECURITYTXT_CANONICAL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/.well-known/security.txt&quot;</span>
<span class="nt">SECURITYTXT_PREFERRED_LANG</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;en&quot;</span>
<span class="nt">SECURITYTXT_CSAF</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/provider-metadata.json&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>具有多种联系方式的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_SECURITYTXT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">SECURITYTXT_CONTACT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mailto:security@example.com&quot;</span>
<span class="nt">SECURITYTXT_CONTACT_2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tel:+1-201-555-0123&quot;</span>
<span class="nt">SECURITYTXT_CONTACT_3</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/security-form&quot;</span>
<span class="nt">SECURITYTXT_POLICY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/security-policy&quot;</span>
<span class="nt">SECURITYTXT_EXPIRES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2024-06-30T23:59:59+00:00&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-self-signed-certificate">Self-signed certificate</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>自签名证书插件可直接在 BunkerWeb 中自动生成和管理 SSL/TLS 证书，无需外部证书颁发机构即可启用安全的 HTTPS 连接。此功能在开发环境、内部网络或需要快速部署 HTTPS 而无需配置外部证书时特别有用。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>启用后，BunkerWeb 会为您的已配置域名自动生成一个自签名 SSL/TLS 证书。</li>
<li>该证书包含您配置中定义的所有服务器名称，确保每个域名的 SSL 验证正确无误。</li>
<li>证书被安全地存储，并用于加密所有到您网站的 HTTPS 流量。</li>
<li>证书在到期前会自动续订，确保 HTTPS 的持续可用性。</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">浏览器安全警告</p>
<p>当用户访问使用自签名证书的网站时，浏览器会显示安全警告，因为这些证书未经受信任的证书颁发机构验证。对于生产环境，请考虑改用 <a href="#zh-features-lets-encrypt">Let's Encrypt</a>。</p>
</div>
<h3 id="zh-features-_122">如何使用</h3>
<p>请按照以下步骤配置和使用自签名证书功能：</p>
<ol>
<li><strong>启用该功能：</strong> 将 <code>GENERATE_SELF_SIGNED_SSL</code> 设置为 <code>yes</code> 以启用自签名证书生成。</li>
<li><strong>选择加密算法：</strong> 使用 <code>SELF_SIGNED_SSL_ALGORITHM</code> 设置选择您偏好的算法。</li>
<li><strong>配置有效期：</strong> 可选地使用 <code>SELF_SIGNED_SSL_EXPIRY</code> 设置证书的有效时长。</li>
<li><strong>设置证书主题：</strong> 使用 <code>SELF_SIGNED_SSL_SUBJ</code> 设置配置证书主题。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 配置完成后，证书会自动生成并应用于您的域名。</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">流模式配置</p>
<p>对于流模式，请配置 <code>LISTEN_STREAM_PORT_SSL</code> 设置以指定 SSL/TLS 监听端口。此步骤对于在流模式下正常运行至关重要。</p>
</div>
<h3 id="zh-features-_123">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GENERATE_SELF_SIGNED_SSL</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用自签名：</strong> 设置为 <code>yes</code> 以启用自动自签名证书生成。</td>
</tr>
<tr>
<td><code>SELF_SIGNED_SSL_ALGORITHM</code></td>
<td><code>ec-prime256v1</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>证书算法：</strong> 用于证书生成的算法：<code>ec-prime256v1</code>、<code>ec-secp384r1</code>、<code>rsa-2048</code> 或 <code>rsa-4096</code>。</td>
</tr>
<tr>
<td><code>SELF_SIGNED_SSL_EXPIRY</code></td>
<td><code>365</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>证书有效期：</strong> 自签名证书的有效天数（默认为 1 年）。</td>
</tr>
<tr>
<td><code>SELF_SIGNED_SSL_SUBJ</code></td>
<td><code>/CN=www.example.com/</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>证书主题：</strong> 证书的主题字段，用于标识域名。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">开发环境</p>
<p>自签名证书非常适合开发和测试环境，在这些环境中您需要 HTTPS，但不需要受公共浏览器信任的证书。</p>
</div>
<div class="admonition info">
<p class="admonition-title">证书信息</p>
<p>生成的自签名证书使用指定的算法（默认为使用 prime256v1 曲线的椭圆曲线加密），并包含配置的主题，确保您的域名功能正常。</p>
</div>
<h3 id="zh-features-_124">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="42:3"><input checked="checked" id="zh-features-__tabbed_42_1" name="zh-features-__tabbed_42" type="radio" /><input id="zh-features-__tabbed_42_2" name="zh-features-__tabbed_42" type="radio" /><input id="zh-features-__tabbed_42_3" name="zh-features-__tabbed_42" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_42_1">基本配置</label><label for="zh-features-__tabbed_42_2">短期证书</label><label for="zh-features-__tabbed_42_3">使用 RSA 证书进行测试</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个使用默认设置的自签名证书的简单配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">GENERATE_SELF_SIGNED_SSL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">SELF_SIGNED_SSL_ALGORITHM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ec-prime256v1&quot;</span>
<span class="nt">SELF_SIGNED_SSL_EXPIRY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;365&quot;</span>
<span class="nt">SELF_SIGNED_SSL_SUBJ</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/CN=mysite.local/&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>证书过期更频繁的配置（用于定期测试证书续订流程）：</p>
<div class="highlight"><pre><span></span><code><span class="nt">GENERATE_SELF_SIGNED_SSL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">SELF_SIGNED_SSL_ALGORITHM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ec-prime256v1&quot;</span>
<span class="nt">SELF_SIGNED_SSL_EXPIRY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;90&quot;</span>
<span class="nt">SELF_SIGNED_SSL_SUBJ</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/CN=dev.example.com/&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个测试环境的配置，其中域名使用自签名的 RSA 证书：</p>
<div class="highlight"><pre><span></span><code><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;test.example.com&quot;</span>
<span class="nt">GENERATE_SELF_SIGNED_SSL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">SELF_SIGNED_SSL_ALGORITHM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rsa-4096&quot;</span>
<span class="nt">SELF_SIGNED_SSL_EXPIRY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;365&quot;</span>
<span class="nt">SELF_SIGNED_SSL_SUBJ</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/CN=test.example.com/&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-sessions">Sessions</h2>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>会话插件为 BunkerWeb 提供了强大的 HTTP 会话管理功能，可在请求之间实现安全可靠的用户会话跟踪。此核心功能对于维护用户状态、身份验证持久性以及支持需要身份连续性的其他功能（例如<a href="#zh-features-antibot">反机器人</a>保护和用户身份验证系统）至关重要。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>当用户首次与您的网站互动时，BunkerWeb 会创建一个唯一的会话标识符。</li>
<li>此标识符安全地存储在用户浏览器的 Cookie 中。</li>
<li>在后续请求中，BunkerWeb 从 Cookie 中检索会话标识符，并使用它来访问用户的会话数据。</li>
<li>对于具有多个 BunkerWeb 实例的分布式环境，会话数据可以本地存储或存储在 <a href="#zh-features-redis">Redis</a> 中。</li>
<li>会话通过可配置的超时进行自动管理，在保持可用性的同时确保安全性。</li>
<li>会话的加密安全性通过用于签署会话 Cookie 的密钥来保证。</li>
</ol>
<h3 id="zh-features-_125">如何使用</h3>
<p>请按照以下步骤配置和使用会话功能：</p>
<ol>
<li><strong>配置会话安全性：</strong> 设置一个强大的、唯一的 <code>SESSIONS_SECRET</code>，以确保会话 Cookie 无法被伪造。（默认值为“random”，这会触发 BunkerWeb 生成一个随机的密钥。）</li>
<li><strong>选择会话名称：</strong> 可选地自定义 <code>SESSIONS_NAME</code>，以定义您的会话 Cookie 在浏览器中的名称。（默认值为“random”，这会触发 BunkerWeb 生成一个随机的名称。）</li>
<li><strong>设置会话超时：</strong> 使用超时设置（<code>SESSIONS_IDLING_TIMEOUT</code>、<code>SESSIONS_ROLLING_TIMEOUT</code>、<code>SESSIONS_ABSOLUTE_TIMEOUT</code>）配置会话的有效时长。</li>
<li><strong>配置 Redis 集成：</strong> 对于分布式环境，将 <code>USE_REDIS</code> 设置为“yes”，并配置您的 <a href="#zh-features-redis">Redis 连接</a> 以在多个 BunkerWeb 节点之间共享会话数据。</li>
<li><strong>让 BunkerWeb 处理其余部分：</strong> 配置完成后，您的网站会自动进行会话管理。</li>
</ol>
<h3 id="zh-features-_126">配置设置</h3>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SESSIONS_SECRET</code></td>
<td><code>random</code></td>
<td>global</td>
<td>否</td>
<td><strong>会话密钥：</strong> 用于签署会话 Cookie 的加密密钥。应该是一个强大的、随机的、对您的站点唯一的字符串。</td>
</tr>
<tr>
<td><code>SESSIONS_NAME</code></td>
<td><code>random</code></td>
<td>global</td>
<td>否</td>
<td><strong>Cookie 名称：</strong> 将存储会话标识符的 Cookie 的名称。</td>
</tr>
<tr>
<td><code>SESSIONS_IDLING_TIMEOUT</code></td>
<td><code>1800</code></td>
<td>global</td>
<td>否</td>
<td><strong>空闲超时：</strong> 会话在失效前不活动的最长时间（以秒为单位）。</td>
</tr>
<tr>
<td><code>SESSIONS_ROLLING_TIMEOUT</code></td>
<td><code>3600</code></td>
<td>global</td>
<td>否</td>
<td><strong>滚动超时：</strong> 会话必须续订前的最长时间（以秒为单位）。</td>
</tr>
<tr>
<td><code>SESSIONS_ABSOLUTE_TIMEOUT</code></td>
<td><code>86400</code></td>
<td>global</td>
<td>否</td>
<td><strong>绝对超时：</strong> 无论活动如何，会话被销毁前的最长时间（以秒为单位）。</td>
</tr>
<tr>
<td><code>SESSIONS_CHECK_IP</code></td>
<td><code>yes</code></td>
<td>global</td>
<td>否</td>
<td><strong>检查 IP：</strong> 设置为 <code>yes</code> 时，如果客户端 IP 地址发生变化，则销毁会话。</td>
</tr>
<tr>
<td><code>SESSIONS_CHECK_USER_AGENT</code></td>
<td><code>yes</code></td>
<td>global</td>
<td>否</td>
<td><strong>检查 User-Agent：</strong> 设置为 <code>yes</code> 时，如果客户端 User-Agent 发生变化，则销毁会话。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">安全注意事项</p>
<p><code>SESSIONS_SECRET</code> 设置对安全至关重要。在生产环境中：</p>
<ol>
<li>使用一个强大的、随机的值（至少 32 个字符）</li>
<li>对此值保密</li>
<li>在集群中的所有 BunkerWeb 实例中使用相同的值</li>
<li>考虑使用环境变量或密钥管理，以避免以纯文本形式存储此值</li>
</ol>
</div>
<div class="admonition tip">
<p class="admonition-title">集群环境</p>
<p>如果您在负载均衡器后面运行多个 BunkerWeb 实例：</p>
<ol>
<li>将 <code>USE_REDIS</code> 设置为 <code>yes</code> 并配置您的 Redis 连接</li>
<li>确保所有实例使用完全相同的 <code>SESSIONS_SECRET</code> 和 <code>SESSIONS_NAME</code></li>
<li>这确保了无论哪个 BunkerWeb 实例处理用户的请求，他们都能保持其会话</li>
</ol>
</div>
<h3 id="zh-features-_127">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="43:4"><input checked="checked" id="zh-features-__tabbed_43_1" name="zh-features-__tabbed_43" type="radio" /><input id="zh-features-__tabbed_43_2" name="zh-features-__tabbed_43" type="radio" /><input id="zh-features-__tabbed_43_3" name="zh-features-__tabbed_43" type="radio" /><input id="zh-features-__tabbed_43_4" name="zh-features-__tabbed_43" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_43_1">基本配置</label><label for="zh-features-__tabbed_43_2">增强安全性</label><label for="zh-features-__tabbed_43_3">带 Redis 的集群环境</label><label for="zh-features-__tabbed_43_4">长效会话</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>单个 BunkerWeb 实例的简单配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">SESSIONS_SECRET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-strong-random-secret-key-here&quot;</span>
<span class="nt">SESSIONS_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;myappsession&quot;</span>
<span class="nt">SESSIONS_IDLING_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1800&quot;</span>
<span class="nt">SESSIONS_ROLLING_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3600&quot;</span>
<span class="nt">SESSIONS_ABSOLUTE_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>具有更高安全设置的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">SESSIONS_SECRET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-very-strong-random-secret-key-here&quot;</span>
<span class="nt">SESSIONS_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;securesession&quot;</span>
<span class="nt">SESSIONS_IDLING_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;900&quot;</span><span class="w">  </span><span class="c1"># 15 分钟</span>
<span class="nt">SESSIONS_ROLLING_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1800&quot;</span><span class="w">  </span><span class="c1"># 30 分钟</span>
<span class="nt">SESSIONS_ABSOLUTE_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;43200&quot;</span><span class="w">  </span><span class="c1"># 12 小时</span>
<span class="nt">SESSIONS_CHECK_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">SESSIONS_CHECK_USER_AGENT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>用于多个 BunkerWeb 实例共享会话数据的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">SESSIONS_SECRET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-strong-random-secret-key-here&quot;</span>
<span class="nt">SESSIONS_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;clustersession&quot;</span>
<span class="nt">SESSIONS_IDLING_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1800&quot;</span>
<span class="nt">SESSIONS_ROLLING_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3600&quot;</span>
<span class="nt">SESSIONS_ABSOLUTE_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span>
<span class="nt">USE_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="c1"># 确保 Redis 连接配置正确</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>用于需要延长会话持久性的应用程序的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">SESSIONS_SECRET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;your-strong-random-secret-key-here&quot;</span>
<span class="nt">SESSIONS_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;persistentsession&quot;</span>
<span class="nt">SESSIONS_IDLING_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;86400&quot;</span><span class="w">  </span><span class="c1"># 1 天</span>
<span class="nt">SESSIONS_ROLLING_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;172800&quot;</span><span class="w">  </span><span class="c1"># 2 天</span>
<span class="nt">SESSIONS_ABSOLUTE_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;604800&quot;</span><span class="w">  </span><span class="c1"># 7 天</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-features-ui">UI</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>Integrate easily the BunkerWeb UI.</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>上下文</th>
<th>可重复</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_UI</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td>Use UI</td>
</tr>
<tr>
<td><code>UI_HOST</code></td>
<td></td>
<td>global</td>
<td>否</td>
<td>Address of the web UI used for initial setup</td>
</tr>
</tbody>
</table>
<h2 id="zh-features-user-manager-pro">User Manager <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style='transform : translateY(3px);'> (PRO)</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>Add the possibility to manage users on the web interface</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>上下文</th>
<th>可重复</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USERS_REQUIRE_2FA</code></td>
<td><code>no</code></td>
<td>global</td>
<td>否</td>
<td>Require two-factor authentication for all users</td>
</tr>
</tbody>
</table>
<h2 id="zh-features-whitelist">Whitelist</h2>
<p>STREAM 支持 <img alt="⚠" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/26a0.svg" title=":warning:" /></p>
<p>白名单插件允许您定义一个受信任的 IP 地址列表，这些地址可以绕过其他安全过滤器。
要阻止不需要的客户端，请参考 <a href="#zh-features-blacklist">黑名单插件</a>。</p>
<p>白名单插件提供了一种全面的方法，可以根据各种客户端属性明确允许访问您的网站。此功能提供了一种安全机制：符合特定条件的访问者将被授予立即访问权限，而所有其他访问者则必须通过常规的安全检查。</p>
<p><strong>工作原理：</strong></p>
<ol>
<li>您定义应被“列入白名单”的访问者的标准（<em>IP 地址、网络、反向 DNS、ASN、用户代理或 URI 模式</em>）。</li>
<li>当访问者尝试访问您的网站时，BunkerWeb 会检查他们是否符合任何这些白名单标准。</li>
<li>如果访问者符合任何白名单规则（并且不符合任何忽略规则），他们将被授予访问您网站的权限，并<strong>绕过所有其他安全检查</strong>。</li>
<li>如果访问者不符合任何白名单标准，他们将照常通过所有正常的安全检查。</li>
<li>白名单可以按计划从外部来源自动更新。</li>
</ol>
<h3 id="zh-features-_128">如何使用</h3>
<p>请按照以下步骤配置和使用白名单功能：</p>
<ol>
<li><strong>启用该功能：</strong> 白名单功能默认被禁用。将 <code>USE_WHITELIST</code> 设置为 <code>yes</code> 以启用它。</li>
<li><strong>配置允许规则：</strong> 定义哪些 IP、网络、反向 DNS 模式、ASN、用户代理或 URI 应被列入白名单。</li>
<li><strong>设置忽略规则：</strong> 指定任何应绕过白名单检查的例外情况。</li>
<li><strong>添加外部来源：</strong> 配置用于自动下载和更新白名单数据的 URL。</li>
<li><strong>监控访问：</strong> 检查 <a href="#zh-web-ui">Web UI</a> 以查看哪些访问者被允许或拒绝。</li>
</ol>
<div class="admonition info">
<p class="admonition-title">流模式</p>
<p>当使用流模式时，仅执行 IP、反向 DNS 和 ASN 检查。</p>
</div>
<h3 id="zh-features-_129">配置设置</h3>
<p><strong>通用</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_WHITELIST</code></td>
<td><code>no</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>启用白名单：</strong> 设置为 <code>yes</code> 以启用白名单功能。</td>
</tr>
</tbody>
</table>
<div class="tabbed-set tabbed-alternate" data-tabs="44:5"><input checked="checked" id="zh-features-__tabbed_44_1" name="zh-features-__tabbed_44" type="radio" /><input id="zh-features-__tabbed_44_2" name="zh-features-__tabbed_44" type="radio" /><input id="zh-features-__tabbed_44_3" name="zh-features-__tabbed_44" type="radio" /><input id="zh-features-__tabbed_44_4" name="zh-features-__tabbed_44" type="radio" /><input id="zh-features-__tabbed_44_5" name="zh-features-__tabbed_44" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_44_1">IP 地址</label><label for="zh-features-__tabbed_44_2">反向 DNS</label><label for="zh-features-__tabbed_44_3">ASN</label><label for="zh-features-__tabbed_44_4">用户代理</label><label for="zh-features-__tabbed_44_5">URI</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><strong>功能说明：</strong> 根据访问者的 IP 地址或网络将其列入白名单。这些访问者将绕过所有安全检查。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WHITELIST_IP</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>IP 白名单：</strong> 允许的 IP 地址或网络（CIDR 表示法）列表，以空格分隔。</td>
</tr>
<tr>
<td><code>WHITELIST_IGNORE_IP</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>IP 忽略列表：</strong> 应绕过 IP 白名单检查的 IP 地址或网络列表。</td>
</tr>
<tr>
<td><code>WHITELIST_IP_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>IP 白名单 URL：</strong> 包含要列入白名单的 IP 地址或网络的 URL 列表，以空格分隔。</td>
</tr>
<tr>
<td><code>WHITELIST_IGNORE_IP_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>IP 忽略列表 URL：</strong> 包含要忽略的 IP 地址或网络的 URL 列表。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<p><strong>功能说明：</strong> 根据访问者的域名（反向）将其列入白名单。这对于允许来自特定组织或网络的访问者按其域名访问非常有用。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WHITELIST_RDNS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>rDNS 白名单：</strong> 允许的反向 DNS 后缀列表，以空格分隔。</td>
</tr>
<tr>
<td><code>WHITELIST_RDNS_GLOBAL</code></td>
<td><code>yes</code></td>
<td>multisite</td>
<td>否</td>
<td><strong>仅限全局 rDNS：</strong> 当设置为 <code>yes</code> 时，仅对全局 IP 地址执行 rDNS 白名单检查。</td>
</tr>
<tr>
<td><code>WHITELIST_IGNORE_RDNS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>rDNS 忽略列表：</strong> 应绕过 rDNS 白名单检查的反向 DNS 后缀列表。</td>
</tr>
<tr>
<td><code>WHITELIST_RDNS_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>rDNS 白名单 URL：</strong> 包含要列入白名单的反向 DNS 后缀的 URL 列表，以空格分隔。</td>
</tr>
<tr>
<td><code>WHITELIST_IGNORE_RDNS_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>rDNS 忽略列表 URL：</strong> 包含要忽略的反向 DNS 后缀的 URL 列表。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<p><strong>功能说明：</strong> 使用自治系统编号（ASN）将来自特定网络提供商的访问者列入白名单。ASN 标识 IP 属于哪个提供商或组织。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WHITELIST_ASN</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>ASN 白名单：</strong> 允许的自治系统编号列表，以空格分隔。</td>
</tr>
<tr>
<td><code>WHITELIST_IGNORE_ASN</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>ASN 忽略列表：</strong> 应绕过 ASN 白名单检查的 ASN 列表。</td>
</tr>
<tr>
<td><code>WHITELIST_ASN_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>ASN 白名单 URL：</strong> 包含要列入白名单的 ASN 的 URL 列表，以空格分隔。</td>
</tr>
<tr>
<td><code>WHITELIST_IGNORE_ASN_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>ASN 忽略列表 URL：</strong> 包含要忽略的 ASN 的 URL 列表。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<p><strong>功能说明：</strong> 根据访问者声称使用的浏览器或工具将其列入白名单。这对于允许访问特定的已知工具或服务非常有效。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WHITELIST_USER_AGENT</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>用户代理白名单：</strong> 允许的用户代理模式（PCRE 正则表达式）列表，以空格分隔。</td>
</tr>
<tr>
<td><code>WHITELIST_IGNORE_USER_AGENT</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>用户代理忽略列表：</strong> 应绕过用户代理白名单检查的用户代理模式列表。</td>
</tr>
<tr>
<td><code>WHITELIST_USER_AGENT_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>用户代理白名单 URL：</strong> 包含要列入白名单的用户代理模式的 URL 列表。</td>
</tr>
<tr>
<td><code>WHITELIST_IGNORE_USER_AGENT_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>用户代理忽略列表 URL：</strong> 包含要忽略的用户代理模式的 URL 列表。</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<p><strong>功能说明：</strong> 将对您网站上特定 URL 的请求列入白名单。这对于允许访问特定端点而不考虑其他因素很有帮助。</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认值</th>
<th>上下文</th>
<th>多选</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WHITELIST_URI</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>URI 白名单：</strong> 允许的 URI 模式（PCRE 正则表达式）列表，以空格分隔。</td>
</tr>
<tr>
<td><code>WHITELIST_IGNORE_URI</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>URI 忽略列表：</strong> 应绕过 URI 白名单检查的 URI 模式列表。</td>
</tr>
<tr>
<td><code>WHITELIST_URI_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>URI 白名单 URL：</strong> 包含要列入白名单的 URI 模式的 URL 列表，以空格分隔。</td>
</tr>
<tr>
<td><code>WHITELIST_IGNORE_URI_URLS</code></td>
<td></td>
<td>multisite</td>
<td>否</td>
<td><strong>URI 忽略列表 URL：</strong> 包含要忽略的 URI 模式的 URL 列表。</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="admonition info">
<p class="admonition-title">URL 格式支持</p>
<p>所有 <code>*_URLS</code> 设置都支持 HTTP/HTTPS URL 以及使用 <code>file:///</code> 前缀的本地文件路径。支持使用 <code>http://user:pass@url</code> 格式进行基本身份验证。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">定期更新</p>
<p>从 URL 获取的白名单会每小时自动下载和更新，以确保您的保护与最新的受信任来源保持同步。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">安全绕过</p>
<p>被列入白名单的访问者将完全<strong>绕过 BunkerWeb 中的所有其他安全检查</strong>，包括 WAF 规则、速率限制、恶意机器人检测以及任何其他安全机制。仅对您绝对信任的来源使用白名单。</p>
</div>
<h3 id="zh-features-_130">配置示例</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="45:5"><input checked="checked" id="zh-features-__tabbed_45_1" name="zh-features-__tabbed_45" type="radio" /><input id="zh-features-__tabbed_45_2" name="zh-features-__tabbed_45" type="radio" /><input id="zh-features-__tabbed_45_3" name="zh-features-__tabbed_45" type="radio" /><input id="zh-features-__tabbed_45_4" name="zh-features-__tabbed_45" type="radio" /><input id="zh-features-__tabbed_45_5" name="zh-features-__tabbed_45" type="radio" /><div class="tabbed-labels"><label for="zh-features-__tabbed_45_1">基本组织访问</label><label for="zh-features-__tabbed_45_2">高级配置</label><label for="zh-features-__tabbed_45_3">使用本地文件</label><label for="zh-features-__tabbed_45_4">API 访问模式</label><label for="zh-features-__tabbed_45_5">知名爬虫</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一个简单的配置，将公司办公室的 IP 列入白名单：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_WHITELIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.1.0/24</span><span class="nv"> </span><span class="s">10.0.0.0/8</span><span class="nv"> </span><span class="s">203.0.113.42&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个更全面的配置，具有多个白名单标准：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_WHITELIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>

<span class="c1"># 公司和受信任的合作伙伴资产</span>
<span class="nt">WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.1.0/24</span><span class="nv"> </span><span class="s">203.0.113.0/24&quot;</span>
<span class="nt">WHITELIST_RDNS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;.company.com</span><span class="nv"> </span><span class="s">.partner-company.org&quot;</span>
<span class="nt">WHITELIST_ASN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;12345</span><span class="nv"> </span><span class="s">67890&quot;</span><span class="w">  </span><span class="c1"># 公司和合作伙伴的 ASN</span>
<span class="nt">WHITELIST_USER_AGENT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;(?:\b)CompanyBot(?:\b)</span><span class="nv"> </span><span class="s">(?:\b)PartnerCrawler(?:\b)&quot;</span>

<span class="c1"># 外部受信任的来源</span>
<span class="nt">WHITELIST_IP_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/trusted-networks.txt&quot;</span>
<span class="nt">WHITELIST_USER_AGENT_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://example.com/trusted-crawlers.txt&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>使用本地文件进行白名单的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_WHITELIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">WHITELIST_IP_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/ip-whitelist.txt&quot;</span>
<span class="nt">WHITELIST_RDNS_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/rdns-whitelist.txt&quot;</span>
<span class="nt">WHITELIST_ASN_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/asn-whitelist.txt&quot;</span>
<span class="nt">WHITELIST_USER_AGENT_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/user-agent-whitelist.txt&quot;</span>
<span class="nt">WHITELIST_URI_URLS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file:///path/to/uri-whitelist.txt&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个专注于仅允许访问特定 API 端点的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_WHITELIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="nt">WHITELIST_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^/api/v1/public/</span><span class="nv"> </span><span class="s">^/api/v1/status&quot;</span>
<span class="nt">WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.1.0/24&quot;</span><span class="w">  </span><span class="c1"># 适用于所有端点的内部网络</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>一个将常见的搜索引擎和社交媒体爬虫列入白名单的配置：</p>
<div class="highlight"><pre><span></span><code><span class="nt">USE_WHITELIST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>

<span class="c1"># 使用反向 DNS 进行验证以增加安全性</span>
<span class="nt">WHITELIST_RDNS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;.googlebot.com</span><span class="nv"> </span><span class="s">.search.msn.com</span><span class="nv"> </span><span class="s">.crawl.yahoo.net</span><span class="nv"> </span><span class="s">.yandex.com</span><span class="nv"> </span><span class="s">.baidu.com</span><span class="nv"> </span><span class="s">.facebook.com&quot;</span>
<span class="nt">WHITELIST_RDNS_GLOBAL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w">  </span><span class="c1"># 仅检查全局 IP</span>
</code></pre></div>
<p>此配置允许合法的爬虫索引您的网站，而不会受到可能阻止它们的速率限制或其他安全措施的影响。rDNS 检查有助于验证爬虫是否确实来自其声称的公司。</p>
</div>
</div>
</div></section><section class="print-page" id="zh-advanced" heading-number="6"><h1 id="zh-advanced-_1">高级用法</h1>
<p>GitHub 仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/vtesting/examples">examples</a> 文件夹中提供了许多真实世界的用例示例。</p>
<p>我们还提供了许多样板文件，例如用于各种集成和数据库类型的 YAML 文件。这些都可以在 <a href="https://github.com/bunkerity/bunkerweb/tree/vtesting/misc/integrations">misc/integrations</a> 文件夹中找到。</p>
<p>本节仅关注高级用法和安全调整，请参阅文档的<a href="#zh-features">功能部分</a>以查看所有可用的设置。</p>
<h2 id="zh-advanced-_2">用例</h2>
<div class="admonition tip">
<p class="admonition-title">测试</p>
<p>当启用多站点模式时（并且如果您没有为域设置正确的 DNS 条目），要执行快速测试，您可以使用 curl 并带上您选择的 HTTP 主机头：
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Host: app1.example.com&quot;</span><span class="w"> </span>http://ip-or-fqdn-of-server
</code></pre></div></p>
<p>如果您使用 HTTPS，您将需要处理 SNI：
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Host: app1.example.com&quot;</span><span class="w"> </span>--resolve<span class="w"> </span>example.com:443:ip-of-server<span class="w"> </span>https://example.com
</code></pre></div></p>
</div>
<h3 id="zh-advanced-_3">在负载均衡器或反向代理之后</h3>
<div class="admonition info">
<p class="admonition-title">真实 IP</p>
<p>当 BunkerWeb 本身位于负载均衡器或反向代理之后时，您需要对其进行配置，以便它可以获取客户端的真实 IP 地址。<strong>如果您不这样做，安全功能将阻止负载均衡器或反向代理的 IP 地址，而不是客户端的 IP 地址</strong>。</p>
</div>
<p>BunkerWeb 实际上支持两种方法来检索客户端的真实 IP 地址：</p>
<ul>
<li>使用 <code>PROXY 协议</code></li>
<li>使用像 <code>X-Forwarded-For</code> 这样的 HTTP 头</li>
</ul>
<p>可以使用以下设置：</p>
<ul>
<li><code>USE_REAL_IP</code>：启用/禁用真实 IP 检索</li>
<li><code>USE_PROXY_PROTOCOL</code>：启用/禁用 PROXY 协议支持。</li>
<li><code>REAL_IP_FROM</code>：允许向我们发送“真实 IP”的受信任 IP/网络地址列表</li>
<li><code>REAL_IP_HEADER</code>：包含真实 IP 的 HTTP 头或在使用 PROXY 协议时的特殊值 <code>proxy_protocol</code></li>
</ul>
<p>您将在文档的<a href="#zh-features-real-ip">功能部分</a>找到更多关于真实 IP 的设置。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="zh-advanced-__tabbed_1_1" name="zh-advanced-__tabbed_1" type="radio" /><input id="zh-advanced-__tabbed_1_2" name="zh-advanced-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_1_1">HTTP 头</label><label for="zh-advanced-__tabbed_1_2">Proxy protocol</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>我们将对负载均衡器或反向代理做出以下假设（您需要根据您的配置更新设置）：</p>
<ul>
<li>它们使用 <code>X-Forwarded-For</code> 头来设置真实 IP</li>
<li>它们的 IP 位于 <code>1.2.3.0/24</code> 和 <code>100.64.0.0/10</code> 网络中</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="2:7"><input checked="checked" id="zh-advanced-__tabbed_2_1" name="zh-advanced-__tabbed_2" type="radio" /><input id="zh-advanced-__tabbed_2_2" name="zh-advanced-__tabbed_2" type="radio" /><input id="zh-advanced-__tabbed_2_3" name="zh-advanced-__tabbed_2" type="radio" /><input id="zh-advanced-__tabbed_2_4" name="zh-advanced-__tabbed_2" type="radio" /><input id="zh-advanced-__tabbed_2_5" name="zh-advanced-__tabbed_2" type="radio" /><input id="zh-advanced-__tabbed_2_6" name="zh-advanced-__tabbed_2" type="radio" /><input id="zh-advanced-__tabbed_2_7" name="zh-advanced-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_2_1">Web UI</label><label for="zh-advanced-__tabbed_2_2">Linux</label><label for="zh-advanced-__tabbed_2_3">All-in-one</label><label for="zh-advanced-__tabbed_2_4">Docker</label><label for="zh-advanced-__tabbed_2_5">Docker autoconf</label><label for="zh-advanced-__tabbed_2_6">Kubernetes</label><label for="zh-advanced-__tabbed_2_7">Swarm</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>导航到<strong>全局配置</strong>页面，选择 <strong>Real IP</strong> 插件并填写以下设置：</p>
<p><figure markdown><img align="center" alt="使用 Web UI 的真实 IP 设置（HTTP 头）" src="../assets/img/advanced-proxy1.png" /><figcaption>使用 Web UI 的真实 IP 设置（HTTP 头）</figcaption></figure></p>
<p>请注意，当您更改与真实 IP 相关的设置时，建议重新启动 BunkerWeb。</p>
</div>
<div class="tabbed-block">
<p>您需要将设置添加到 <code>/etc/bunkerweb/variables.env</code> 文件中：</p>
<div class="highlight"><pre><span></span><code>...
USE_REAL_IP=yes
REAL_IP_FROM=1.2.3.0/24 100.64.0.0/16
REAL_IP_HEADER=X-Forwarded-For
...
</code></pre></div>
<p>请注意，在配置与真实 IP 相关的设置时，建议执行重启而不是重新加载：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>bunkerweb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</div>
<div class="tabbed-block">
<p>在运行 All-in-one 容器时，您需要将设置添加到环境变量中：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">USE_REAL_IP</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">REAL_IP_FROM</span><span class="o">=</span><span class="s2">&quot;1.2.3.0/24 100.64.0.0/10&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">REAL_IP_HEADER</span><span class="o">=</span><span class="s2">&quot;X-Forwarded-For&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>bunkerity/bunkerweb-all-in-one:testing
</code></pre></div>
<p>请注意，如果您的容器已经创建，您需要删除并重新创建它，以便更新新的环境变量。</p>
</div>
<div class="tabbed-block">
<p>您需要将设置添加到 BunkerWeb 和调度程序容器的环境变量中：</p>
<div class="highlight"><pre><span></span><code><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Forwarded-For&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Forwarded-For&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<p>请注意，如果您的容器已经创建，您需要删除并重新创建它，以便更新新的环境变量。</p>
</div>
<div class="tabbed-block">
<p>您需要将设置添加到 BunkerWeb 和调度程序容器的环境变量中：</p>
<div class="highlight"><pre><span></span><code><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Forwarded-For&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Forwarded-For&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<p>请注意，如果您的容器已经创建，您需要删除并重新创建它，以便更新新的环境变量。</p>
</div>
<div class="tabbed-block">
<p>您需要将设置添加到 BunkerWeb 和调度程序 Pod 的环境变量中。</p>
<p>这是您可以使用的 <code>values.yaml</code> 文件的相应部分：</p>
<div class="highlight"><pre><span></span><code><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">  </span><span class="nt">extraEnvs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">USE_REAL_IP</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REAL_IP_FROM</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REAL_IP_HEADER</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Forwarded-For&quot;</span>
<span class="nt">scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">extraEnvs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">USE_REAL_IP</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REAL_IP_FROM</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REAL_IP_HEADER</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Forwarded-For&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
<p><strong>更多信息可以在 <a href="#zh-integrations-swarm">Swarm 集成文档</a>中找到。</strong></p>
</div>
<p>您需要将设置添加到 BunkerWeb 和调度程序服务的环境变量中：</p>
<div class="highlight"><pre><span></span><code><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Forwarded-For&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;X-Forwarded-For&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<p>请注意，如果您的服务已经创建，您需要删除并重新创建它，以便更新新的环境变量。</p>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">请仔细阅读</p>
<p>只有在您确定您的负载均衡器或反向代理正在发送 PROXY 协议时才使用它。<strong>如果您启用它而未使用，将会出现错误</strong>。</p>
</div>
<p>我们将对负载均衡器或反向代理做出以下假设（您需要根据您的配置更新设置）：</p>
<ul>
<li>它们使用 <code>PROXY 协议</code> v1 或 v2 来设置真实 IP</li>
<li>它们的 IP 位于 <code>1.2.3.0/24</code> 和 <code>100.64.0.0/10</code> 网络中</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="3:7"><input checked="checked" id="zh-advanced-__tabbed_3_1" name="zh-advanced-__tabbed_3" type="radio" /><input id="zh-advanced-__tabbed_3_2" name="zh-advanced-__tabbed_3" type="radio" /><input id="zh-advanced-__tabbed_3_3" name="zh-advanced-__tabbed_3" type="radio" /><input id="zh-advanced-__tabbed_3_4" name="zh-advanced-__tabbed_3" type="radio" /><input id="zh-advanced-__tabbed_3_5" name="zh-advanced-__tabbed_3" type="radio" /><input id="zh-advanced-__tabbed_3_6" name="zh-advanced-__tabbed_3" type="radio" /><input id="zh-advanced-__tabbed_3_7" name="zh-advanced-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_3_1">Web UI</label><label for="zh-advanced-__tabbed_3_2">Linux</label><label for="zh-advanced-__tabbed_3_3">All-in-one</label><label for="zh-advanced-__tabbed_3_4">Docker</label><label for="zh-advanced-__tabbed_3_5">Docker autoconf</label><label for="zh-advanced-__tabbed_3_6">Kubernetes</label><label for="zh-advanced-__tabbed_3_7">Swarm</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>导航到<strong>全局配置</strong>页面，选择 <strong>Real IP</strong> 插件并填写以下设置：</p>
<p><figure markdown><img align="center" alt="使用 Web UI 的真实 IP 设置（PROXY 协议）" src="../assets/img/advanced-proxy2.png" /><figcaption>使用 Web UI 的真实 IP 设置（PROXY 协议）</figcaption></figure></p>
<p>请注意，当您更改与真实 IP 相关的设置时，建议重新启动 BunkerWeb。</p>
</div>
<div class="tabbed-block">
<p>您需要将设置添加到 <code>/etc/bunkerweb/variables.env</code> 文件中：</p>
<div class="highlight"><pre><span></span><code>...
USE_REAL_IP=yes
USE_PROXY_PROTOCOL=yes
REAL_IP_FROM=1.2.3.0/24 100.64.0.0/16
REAL_IP_HEADER=proxy_protocol
...
</code></pre></div>
<p>请注意，在配置与代理协议相关的设置时，建议执行重启而不是重新加载：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>bunkerweb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</div>
<div class="tabbed-block">
<p>在运行 All-in-one 容器时，您需要将设置添加到环境变量中：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">USE_REAL_IP</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">USE_PROXY_PROTOCOL</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">REAL_IP_FROM</span><span class="o">=</span><span class="s2">&quot;1.2.3.0/24 100.64.0.0/10&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">REAL_IP_HEADER</span><span class="o">=</span><span class="s2">&quot;X-Forwarded-For&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>bunkerity/bunkerweb-all-in-one:testing
</code></pre></div>
<p>请注意，如果您的容器已经创建，您需要删除并重新创建它，以便更新新的环境变量。</p>
</div>
<div class="tabbed-block">
<p>您需要将设置添加到 BunkerWeb 和调度程序容器的环境变量中：</p>
<div class="highlight"><pre><span></span><code><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">USE_PROXY_PROTOCOL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;proxy_protocol&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nn">...</span>
<span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">USE_PROXY_PROTOCOL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;proxy_protocol&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<p>请注意，如果您的容器已经创建，您需要删除并重新创建它，以便更新新的环境变量。</p>
</div>
<div class="tabbed-block">
<p>您需要将设置添加到 BunkerWeb 和调度程序容器的环境变量中：</p>
<div class="highlight"><pre><span></span><code><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">USE_PROXY_PROTOCOL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;proxy_protocol&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nn">...</span>
<span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">USE_PROXY_PROTOCOL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;proxy_protocol&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<p>请注意，如果您的容器已经创建，您需要删除并重新创建它，以便更新新的环境变量。</p>
</div>
<div class="tabbed-block">
<p>您需要将设置添加到 BunkerWeb 和调度程序 Pod 的环境变量中。</p>
<p>这是您可以使用的 <code>values.yaml</code> 文件的相应部分：</p>
<div class="highlight"><pre><span></span><code><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">  </span><span class="nt">extraEnvs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">USE_REAL_IP</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">USE_PROXY_PROTOCOL</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REAL_IP_FROM</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REAL_IP_HEADER</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;proxy_protocol&quot;</span>
<span class="nt">scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">extraEnvs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">USE_REAL_IP</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">USE_PROXY_PROTOCOL</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REAL_IP_FROM</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REAL_IP_HEADER</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;proxy_protocol&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
<p><strong>更多信息可以在 <a href="#zh-integrations-swarm">Swarm 集成文档</a>中找到。</strong></p>
</div>
<p>您需要将设置添加到 BunkerWeb 和调度程序服务的环境变量中。</p>
<div class="highlight"><pre><span></span><code><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">USE_PROXY_PROTOCOL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;proxy_protocol&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nn">...</span>
<span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">USE_REAL_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">USE_PROXY_PROTOCOL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_FROM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.0/24</span><span class="nv"> </span><span class="s">100.64.0.0/10&quot;</span>
<span class="w">    </span><span class="nt">REAL_IP_HEADER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;proxy_protocol&quot;</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<p>请注意，如果您的服务已经创建，您需要删除并重新创建它，以便更新新的环境变量。</p>
</div>
</div>
</div>
</div>
</div>
</div>
<h3 id="zh-advanced-dns">使用自定义 DNS 解析机制</h3>
<p>BunkerWeb 的 NGINX 配置可以根据您的需求定制，以使用不同的 DNS 解析器。这在各种场景中特别有用：</p>
<ol>
<li>为了遵循您本地 <code>/etc/hosts</code> 文件中的条目</li>
<li>当您需要为某些域使用自定义 DNS 服务器时</li>
<li>为了与本地 DNS 缓存解决方案集成</li>
</ol>
<h4 id="zh-advanced-systemd-resolved">使用 systemd-resolved</h4>
<p>许多现代 Linux 系统使用 <code>systemd-resolved</code> 进行 DNS 解析。如果您希望 BunkerWeb 遵循您 <code>/etc/hosts</code> 文件的内容并使用系统的 DNS 解析机制，您可以将其配置为使用本地的 systemd-resolved DNS 服务。</p>
<p>要验证 systemd-resolved 是否在您的系统上运行，您可以使用：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>status<span class="w"> </span>systemd-resolved
</code></pre></div>
<p>要在 BunkerWeb 中启用 systemd-resolved 作为您的 DNS 解析器，请将 <code>DNS_RESOLVERS</code> 设置为 <code>127.0.0.53</code>，这是 systemd-resolved 的默认监听地址：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="zh-advanced-__tabbed_4_1" name="zh-advanced-__tabbed_4" type="radio" /><input id="zh-advanced-__tabbed_4_2" name="zh-advanced-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_4_1">Web UI</label><label for="zh-advanced-__tabbed_4_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>导航到<strong>全局配置</strong>页面，并将 DNS 解析器设置为 <code>127.0.0.53</code></p>
<p><figure markdown><img align="center" alt="使用 Web UI 设置 DNS 解析器" src="../assets/img/advanced-dns-resolvers.png" /><figcaption>使用 Web UI 设置 DNS 解析器</figcaption></figure></p>
</div>
<div class="tabbed-block">
<p>您需要修改 <code>/etc/bunkerweb/variables.env</code> 文件：</p>
<div class="highlight"><pre><span></span><code>...
DNS_RESOLVERS=127.0.0.53
...
</code></pre></div>
<p>进行此更改后，重新加载调度程序以应用配置：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</div>
</div>
</div>
<h4 id="zh-advanced-dnsmasq">使用 dnsmasq</h4>
<p><a href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a> 是一个轻量级的 DNS、DHCP 和 TFTP 服务器，通常用于本地 DNS 缓存和定制。当您需要比 systemd-resolved 提供更多对 DNS 解析的控制时，它特别有用。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="zh-advanced-__tabbed_5_1" name="zh-advanced-__tabbed_5" type="radio" /><input id="zh-advanced-__tabbed_5_2" name="zh-advanced-__tabbed_5" type="radio" /><input id="zh-advanced-__tabbed_5_3" name="zh-advanced-__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_5_1">Linux</label><label for="zh-advanced-__tabbed_5_2">All-in-one</label><label for="zh-advanced-__tabbed_5_3">Docker</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>首先，在您的 Linux 系统上安装和配置 dnsmasq：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="zh-advanced-__tabbed_6_1" name="zh-advanced-__tabbed_6" type="radio" /><input id="zh-advanced-__tabbed_6_2" name="zh-advanced-__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_6_1">Debian/Ubuntu</label><label for="zh-advanced-__tabbed_6_2">RHEL/Fedora</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># 安装 dnsmasq</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>dnsmasq

<span class="c1"># 配置 dnsmasq 仅在 localhost 上监听</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;listen-address=127.0.0.1&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/dnsmasq.conf
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;bind-interfaces&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/dnsmasq.conf

<span class="c1"># 如果需要，添加自定义 DNS 条目</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;address=/custom.example.com/192.168.1.10&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/dnsmasq.conf

<span class="c1"># 重启 dnsmasq</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>dnsmasq
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>dnsmasq
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1"># 安装 dnsmasq</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>dnsmasq

<span class="c1"># 配置 dnsmasq 仅在 localhost 上监听</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;listen-address=127.0.0.1&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/dnsmasq.conf
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;bind-interfaces&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/dnsmasq.conf

<span class="c1"># 如果需要，添加自定义 DNS 条目</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;address=/custom.example.com/192.168.1.10&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/dnsmasq.conf

<span class="c1"># 重启 dnsmasq</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>dnsmasq
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>dnsmasq
</code></pre></div>
</div>
</div>
</div>
<p>然后配置 BunkerWeb 使用 dnsmasq，方法是将 <code>DNS_RESOLVERS</code> 设置为 <code>127.0.0.1</code>：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="zh-advanced-__tabbed_7_1" name="zh-advanced-__tabbed_7" type="radio" /><input id="zh-advanced-__tabbed_7_2" name="zh-advanced-__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_7_1">Web UI</label><label for="zh-advanced-__tabbed_7_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>导航到<strong>全局配置</strong>页面，选择 <strong>NGINX</strong> 插件并将 DNS 解析器设置为 <code>127.0.0.1</code>。</p>
<p><figure markdown><img align="center" alt="使用 Web UI 设置 DNS 解析器" src="../assets/img/advanced-dns-resolvers2.png" /><figcaption>使用 Web UI 设置 DNS 解析器</figcaption></figure></p>
</div>
<div class="tabbed-block">
<p>您需要修改 <code>/etc/bunkerweb/variables.env</code> 文件：</p>
<div class="highlight"><pre><span></span><code>...
DNS_RESOLVERS=127.0.0.1
...
</code></pre></div>
<p>进行此更改后，重新加载调度程序：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p>当使用 All-in-one 容器时，在单独的容器中运行 dnsmasq 并配置 BunkerWeb 使用它：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 为 DNS 通信创建一个自定义网络</span>
docker<span class="w"> </span>network<span class="w"> </span>create<span class="w"> </span>bw-dns

<span class="c1"># 使用 dockurr/dnsmasq 运行 dnsmasq 容器，并使用 Quad9 DNS</span>
<span class="c1"># Quad9 提供专注于安全的 DNS 解析，并带有恶意软件拦截功能</span>
docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--name<span class="w"> </span>dnsmasq<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--network<span class="w"> </span>bw-dns<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">DNS1</span><span class="o">=</span><span class="s2">&quot;9.9.9.9&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">DNS2</span><span class="o">=</span><span class="s2">&quot;149.112.112.112&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">53</span>:53/udp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">53</span>:53/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cap-add<span class="o">=</span>NET_ADMIN<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--restart<span class="o">=</span>always<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>dockurr/dnsmasq

<span class="c1"># 运行 BunkerWeb All-in-one 并使用 dnsmasq DNS 解析器</span>
docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--network<span class="w"> </span>bw-dns<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">DNS_RESOLVERS</span><span class="o">=</span><span class="s2">&quot;dnsmasq&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>bunkerity/bunkerweb-all-in-one:testing
</code></pre></div>
</div>
<div class="tabbed-block">
<p>将 dnsmasq 服务添加到您的 docker-compose 文件中，并配置 BunkerWeb 使用它：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">dnsmasq</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dockurr/dnsmasq</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dnsmasq</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 使用 Quad9 DNS 服务器以增强安全性和隐私</span>
<span class="w">      </span><span class="c1"># 主服务器：9.9.9.9 (Quad9，带恶意软件拦截)</span>
<span class="w">      </span><span class="c1"># 备用服务器：149.112.112.112 (Quad9 备用服务器)</span>
<span class="w">      </span><span class="nt">DNS1</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;9.9.9.9&quot;</span>
<span class="w">      </span><span class="nt">DNS2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;149.112.112.112&quot;</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">53:53/udp</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">53:53/tcp</span>
<span class="w">    </span><span class="nt">cap_add</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_ADMIN</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-dns</span>

<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">DNS_RESOLVERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;dnsmasq&quot;</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-dns</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">DNS_RESOLVERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;dnsmasq&quot;</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-dns</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ...现有网络...</span>
<span class="w">  </span><span class="nt">bw-dns</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-dns</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="zh-advanced-_4">自定义配置</h3>
<p>要自定义并向 BunkerWeb 添加自定义配置，您可以利用其 NGINX 基础。自定义 NGINX 配置可以添加到不同的 NGINX 上下文中，包括 ModSecurity Web 应用程序防火墙 (WAF) 的配置，这是 BunkerWeb 的核心组件。有关 ModSecurity 配置的更多详细信息，请参见<a href="#zh-features-custom-configurations">此处</a>。</p>
<p>以下是可用的自定义配置类型：</p>
<ul>
<li><strong>http</strong>：NGINX 的 HTTP 级别的配置。</li>
<li><strong>server-http</strong>：NGINX 的 HTTP/服务器级别的配置。</li>
<li><strong>default-server-http</strong>：NGINX 的服务器级别的配置，特别用于当提供的客户端名称与 <code>SERVER_NAME</code> 中的任何服务器名称都不匹配时的“默认服务器”。</li>
<li><strong>modsec-crs</strong>：在加载 OWASP 核心规则集之前应用的配置。</li>
<li><strong>modsec</strong>：在加载 OWASP 核心规则集之后应用的配置，或在未加载核心规则集时使用。</li>
<li><strong>crs-plugins-before</strong>：CRS 插件的配置，在加载 CRS 插件之前应用。</li>
<li><strong>crs-plugins-after</strong>：CRS 插件的配置，在加载 CRS 插件之后应用。</li>
<li><strong>stream</strong>：NGINX 的 Stream 级别的配置。</li>
<li><strong>server-stream</strong>：NGINX 的 Stream/服务器级别的配置。</li>
</ul>
<p>自定义配置可以全局应用，也可以针对特定服务器应用，具体取决于适用的上下文以及是否启用了<a href="#zh-concepts-multisite-mode">多站点模式</a>。</p>
<p>应用自定义配置的方法取决于所使用的集成。然而，其底层过程涉及将带有 <code>.conf</code> 后缀的文件添加到特定文件夹中。要为特定服务器应用自定义配置，该文件应放置在以主服务器名称命名的子文件夹中。</p>
<p>某些集成提供了更方便的应用配置方式，例如在 Docker Swarm 中使用 <a href="https://docs.docker.com/engine/swarm/configs/">Configs</a> 或在 Kubernetes 中使用 <a href="https://kubernetes.io/docs/concepts/configuration/configmap/">ConfigMap</a>。这些选项为管理和应用配置提供了更简单的方法。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:7"><input checked="checked" id="zh-advanced-__tabbed_8_1" name="zh-advanced-__tabbed_8" type="radio" /><input id="zh-advanced-__tabbed_8_2" name="zh-advanced-__tabbed_8" type="radio" /><input id="zh-advanced-__tabbed_8_3" name="zh-advanced-__tabbed_8" type="radio" /><input id="zh-advanced-__tabbed_8_4" name="zh-advanced-__tabbed_8" type="radio" /><input id="zh-advanced-__tabbed_8_5" name="zh-advanced-__tabbed_8" type="radio" /><input id="zh-advanced-__tabbed_8_6" name="zh-advanced-__tabbed_8" type="radio" /><input id="zh-advanced-__tabbed_8_7" name="zh-advanced-__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_8_1">Web UI</label><label for="zh-advanced-__tabbed_8_2">Linux</label><label for="zh-advanced-__tabbed_8_3">All-in-one</label><label for="zh-advanced-__tabbed_8_4">Docker</label><label for="zh-advanced-__tabbed_8_5">Docker autoconf</label><label for="zh-advanced-__tabbed_8_6">Kubernetes</label><label for="zh-advanced-__tabbed_8_7">Swarm</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>导航到<strong>配置</strong>页面，点击<strong>创建新的自定义配置</strong>，然后您可以选择是全局配置还是特定于服务的配置，以及配置类型和配置名称：</p>
<p><figure markdown><img align="center" alt="使用 Web UI 的自定义配置" src="../assets/img/advanced-config.png" /><figcaption>使用 Web UI 的自定义配置</figcaption></figure></p>
<p>别忘了点击 <code>💾 保存</code> 按钮。</p>
</div>
<div class="tabbed-block">
<p>当使用 <a href="#zh-integrations-linux">Linux 集成</a>时，自定义配置必须写入 <code>/etc/bunkerweb/configs</code> 文件夹。</p>
<p>这是一个 server-http/hello-world.conf 的示例：</p>
<div class="highlight"><pre><span></span><code><span class="k">location</span><span class="w"> </span><span class="s">/hello</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">default_type</span><span class="w"> </span><span class="s">&#39;text/plain&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kn">content_by_lua_block</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">ngx.say(&#39;world&#39;)</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span>
</code></pre></div>
<p>因为 BunkerWeb 以非特权用户 (nginx:nginx) 运行，您需要编辑权限：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span>root:nginx<span class="w"> </span>/etc/bunkerweb/configs<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span>-R<span class="w"> </span><span class="m">770</span><span class="w"> </span>/etc/bunkerweb/configs
</code></pre></div>
<p>现在让我们检查调度程序的状态：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>status<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
<p>如果它们已经在运行，我们可以重新加载它：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>reload<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
<p>否则，我们需要启动它：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</div>
<div class="tabbed-block">
<p>当使用 <a href="#zh-integrations-all-in-one-aio-image">All-in-one 镜像</a>时，您有两种选择来添加自定义配置：</p>
<ul>
<li>在运行容器时使用特定的 <code>*_CUSTOM_CONF_*</code> 设置作为环境变量（推荐）。</li>
<li>将 <code>.conf</code> 文件写入挂载到 <code>/data</code> 的卷内的 <code>/data/configs/</code> 目录。</li>
</ul>
<p><strong>使用设置（环境变量）</strong></p>
<p>要使用的设置必须遵循 <code>&lt;SITE&gt;_CUSTOM_CONF_&lt;TYPE&gt;_&lt;NAME&gt;</code> 的模式：</p>
<ul>
<li><code>&lt;SITE&gt;</code>：可选的主服务器名称，如果启用了多站点模式并且配置必须应用于特定服务。</li>
<li><code>&lt;TYPE&gt;</code>：配置的类型，可接受的值为 <code>HTTP</code>、<code>DEFAULT_SERVER_HTTP</code>、<code>SERVER_HTTP</code>、<code>MODSEC</code>、<code>MODSEC_CRS</code>、<code>CRS_PLUGINS_BEFORE</code>、<code>CRS_PLUGINS_AFTER</code>、<code>STREAM</code> 和 <code>SERVER_STREAM</code>。</li>
<li><code>&lt;NAME&gt;</code>：不带 <code>.conf</code> 后缀的配置名称。</li>
</ul>
<p>这是一个在运行 All-in-one 容器时的示例：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="s2">&quot;CUSTOM_CONF_SERVER_HTTP_hello-world=location /hello { \</span>
<span class="s2">        default_type &#39;text/plain&#39;; \</span>
<span class="s2">        content_by_lua_block { \</span>
<span class="s2">          ngx.say(&#39;world&#39;); \</span>
<span class="s2">        } \</span>
<span class="s2">      }&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>bunkerity/bunkerweb-all-in-one:testing
</code></pre></div>
<p>请注意，如果您的容器已经创建，您需要删除并重新创建它，以便应用新的环境变量。</p>
<p><strong>使用文件</strong></p>
<p>首先要做的是创建文件夹：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>./bw-data/configs/server-http
</code></pre></div>
<p>现在您可以编写您的配置了：</p>
<div class="highlight"><pre><span></span><code><span class="k">echo</span><span class="w"> </span><span class="s">&quot;location</span><span class="w"> </span><span class="s">/hello</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">default_type</span><span class="w"> </span><span class="s">&#39;text/plain&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kn">content_by_lua_block</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">ngx.say(&#39;world&#39;)</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span><span class="s">&quot;</span><span class="w"> </span><span class="s">&gt;</span><span class="w"> </span><span class="s">./bw-data/configs/server-http/hello-world.conf</span>
</code></pre></div>
<p>因为调度程序以 UID 和 GID 101 的非特权用户运行，您需要编辑权限：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span>root:101<span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span>-R<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-data
</code></pre></div>
<p>启动调度程序容器时，您需要将文件夹挂载到 /data 上：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>./bw-data:/data<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>bunkerity/bunkerweb-all-in-one:testing
</code></pre></div>
</div>
<div class="tabbed-block">
<p>当使用 <a href="#zh-integrations-docker">Docker 集成</a>时，您有两种选择来添加自定义配置：</p>
<ul>
<li>使用特定的 <code>*_CUSTOM_CONF_*</code> 设置作为环境变量（推荐）</li>
<li>将 .conf 文件写入挂载在调度程序 /data 上的卷中</li>
</ul>
<p><strong>使用设置</strong></p>
<p>要使用的设置必须遵循 <code>&lt;SITE&gt;_CUSTOM_CONF_&lt;TYPE&gt;_&lt;NAME&gt;</code> 的模式：</p>
<ul>
<li><code>&lt;SITE&gt;</code>：可选的主服务器名称，如果启用了多站点模式并且配置必须应用于特定服务</li>
<li><code>&lt;TYPE&gt;</code>：配置的类型，可接受的值为 <code>HTTP</code>、<code>DEFAULT_SERVER_HTTP</code>、<code>SERVER_HTTP</code>、<code>MODSEC</code>、<code>MODSEC_CRS</code>、<code>CRS_PLUGINS_BEFORE</code>、<code>CRS_PLUGINS_AFTER</code>、<code>STREAM</code> 和 <code>SERVER_STREAM</code></li>
<li><code>&lt;NAME&gt;</code>：不带 .conf 后缀的配置名称</li>
</ul>
<p>这是一个使用 docker-compose 文件的示例：</p>
<div class="highlight"><pre><span></span><code><span class="nn">...</span>
<span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">CUSTOM_CONF_SERVER_HTTP_hello-world=</span>
<span class="w">      </span><span class="no">location /hello {</span>
<span class="w">        </span><span class="no">default_type &#39;text/plain&#39;;</span>
<span class="w">        </span><span class="no">content_by_lua_block {</span>
<span class="w">          </span><span class="no">ngx.say(&#39;world&#39;)</span>
<span class="w">        </span><span class="no">}</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<p><strong>使用文件</strong></p>
<p>首先要做的是创建文件夹：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>./bw-data/configs/server-http
</code></pre></div>
<p>现在您可以编写您的配置了：</p>
<div class="highlight"><pre><span></span><code><span class="k">echo</span><span class="w"> </span><span class="s">&quot;location</span><span class="w"> </span><span class="s">/hello</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">default_type</span><span class="w"> </span><span class="s">&#39;text/plain&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kn">content_by_lua_block</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">ngx.say(&#39;world&#39;)</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span><span class="s">&quot;</span><span class="w"> </span><span class="s">&gt;</span><span class="w"> </span><span class="s">./bw-data/configs/server-http/hello-world.conf</span>
</code></pre></div>
<p>因为调度程序以 UID 和 GID 101 的非特权用户运行，您需要编辑权限：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span>root:101<span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span>-R<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-data
</code></pre></div>
<p>启动调度程序容器时，您需要将文件夹挂载到 /data 上：</p>
<div class="highlight"><pre><span></span><code><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./bw-data:/data</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>当使用 <a href="#zh-integrations-docker-autoconf">Docker autoconf 集成</a>时，您有两种选择来添加自定义配置：</p>
<ul>
<li>使用特定的 <code>*_CUSTOM_CONF_*</code> 设置作为标签（最简单）</li>
<li>将 .conf 文件写入挂载在调度程序 /data 上的卷中</li>
</ul>
<p><strong>使用标签</strong></p>
<div class="admonition warning">
<p class="admonition-title">使用标签的限制</p>
<p>当使用 Docker autoconf 集成的标签时，您只能为相应的 Web 服务应用自定义配置。应用 <strong>http</strong>、<strong>default-server-http</strong>、<strong>stream</strong> 或任何全局配置（例如所有服务的 <strong>server-http</strong> 或 <strong>server-stream</strong>）是不可能的：您需要为此挂载文件。</p>
</div>
<p>要使用的标签必须遵循 <code>bunkerweb.CUSTOM_CONF_&lt;TYPE&gt;_&lt;NAME&gt;</code> 的模式：</p>
<ul>
<li><code>&lt;TYPE&gt;</code>：配置的类型，可接受的值为 <code>SERVER_HTTP</code>、<code>MODSEC</code>、<code>MODSEC_CRS</code>、<code>CRS_PLUGINS_BEFORE</code>、<code>CRS_PLUGINS_AFTER</code> 和 <code>SERVER_STREAM</code></li>
<li><code>&lt;NAME&gt;</code>：不带 .conf 后缀的配置名称</li>
</ul>
<p>这是一个使用 docker-compose 文件的示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">myapp</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginxdemos/nginx-hello</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">bunkerweb.CUSTOM_CONF_SERVER_HTTP_hello-world=</span>
<span class="w">      </span><span class="no">location /hello {</span>
<span class="w">        </span><span class="no">default_type &#39;text/plain&#39;;</span>
<span class="w">        </span><span class="no">content_by_lua_block {</span>
<span class="w">            </span><span class="no">ngx.say(&#39;world&#39;)</span>
<span class="w">        </span><span class="no">}</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<p><strong>使用文件</strong></p>
<p>首先要做的是创建文件夹：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>./bw-data/configs/server-http
</code></pre></div>
<p>现在您可以编写您的配置了：</p>
<div class="highlight"><pre><span></span><code><span class="k">echo</span><span class="w"> </span><span class="s">&quot;location</span><span class="w"> </span><span class="s">/hello</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">default_type</span><span class="w"> </span><span class="s">&#39;text/plain&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kn">content_by_lua_block</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">ngx.say(&#39;world&#39;)</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span><span class="s">&quot;</span><span class="w"> </span><span class="s">&gt;</span><span class="w"> </span><span class="s">./bw-data/configs/server-http/hello-world.conf</span>
</code></pre></div>
<p>因为调度程序以 UID 和 GID 101 的非特权用户运行，您需要编辑权限：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span>root:101<span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span>-R<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-data
</code></pre></div>
<p>启动调度程序容器时，您需要将文件夹挂载到 /data 上：</p>
<div class="highlight"><pre><span></span><code><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./bw-data:/data</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>当使用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>时，自定义配置是使用 <a href="https://kubernetes.io/docs/concepts/configuration/configmap/">ConfigMap</a> 管理的。</p>
<p>为了简单起见，您甚至不需要将 ConfigMap 与 Pod 一起使用（例如作为环境变量或卷）：autoconf Pod 正在监听 ConfigMap 事件，并会在需要时更新自定义配置。</p>
<p>创建 ConfigMap 时，您需要添加特殊的标签：</p>
<ul>
<li><strong>bunkerweb.io/CONFIG_TYPE</strong>：必须设置为有效的自定义配置类型（http、server-http、default-server-http、modsec、modsec-crs、crs-plugins-before、crs-plugins-after、stream 或 server-stream）</li>
<li><strong>bunkerweb.io/CONFIG_SITE</strong>：设置为服务器名称以将配置应用于该特定服务器（可选，如果未设置则将全局应用）</li>
</ul>
<p>这是一个示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cfg-bunkerweb-all-server-http</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bunkerweb.io/CONFIG_TYPE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;server-http&quot;</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">myconf</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">location /hello {</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">default_type &#39;text/plain&#39;;</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">content_by_lua_block {</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">ngx.say(&#39;world&#39;)</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span>
<span class="w">  </span><span class="err">}</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">自定义额外配置</p>
<p>自 <code>1.6.0</code> 版本起，您可以使用 <code>bunkerweb.io/CONFIG_TYPE=settings</code> 注解来添加/覆盖设置。这是一个示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cfg-bunkerweb-extra-settings</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bunkerweb.io/CONFIG_TYPE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;settings&quot;</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">USE_ANTIBOT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;captcha&quot;</span><span class="w"> </span><span class="c1"># 多站点设置，将应用于所有未覆盖它的服务</span>
<span class="w">  </span><span class="nt">USE_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="c1"># 全局设置，将全局应用</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
<p><strong>更多信息可以在 <a href="#zh-integrations-swarm">Swarm 集成文档</a>中找到。</strong></p>
</div>
<p>当使用 <a href="#zh-integrations-swarm">Swarm 集成</a>时，自定义配置是使用 <a href="https://docs.docker.com/engine/swarm/configs/">Docker Configs</a> 管理的。</p>
<p>为了简单起见，您甚至不需要将配置附加到服务上：autoconf 服务正在监听配置事件，并会在需要时更新自定义配置。</p>
<p>创建配置时，您需要添加特殊的标签：</p>
<ul>
<li><strong>bunkerweb.CONFIG_TYPE</strong>：必须设置为有效的自定义配置类型（http、server-http、default-server-http、modsec、modsec-crs、crs-plugins-before、crs-plugins-after、stream 或 server-stream）</li>
<li><strong>bunkerweb.CONFIG_SITE</strong>：设置为服务器名称以将配置应用于该特定服务器（可选，如果未设置则将全局应用）</li>
</ul>
<p>这是一个示例：</p>
<div class="highlight"><pre><span></span><code><span class="k">echo</span><span class="w"> </span><span class="s">&quot;location</span><span class="w"> </span><span class="s">/hello</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">default_type</span><span class="w"> </span><span class="s">&#39;text/plain&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kn">content_by_lua_block</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">ngx.say(&#39;world&#39;)</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span><span class="s">&quot;</span><span class="w"> </span><span class="s">|</span><span class="w"> </span><span class="s">docker</span><span class="w"> </span><span class="s">config</span><span class="w"> </span><span class="s">create</span><span class="w"> </span><span class="s">-l</span><span class="w"> </span><span class="s">bunkerweb.CONFIG_TYPE=server-http</span><span class="w"> </span><span class="s">my-config</span><span class="w"> </span><span class="s">-</span>
</code></pre></div>
<p>没有更新机制：替代方法是使用 <code>docker config rm</code> 删除现有配置，然后重新创建它。</p>
</div>
</div>
</div>
<h3 id="zh-advanced-_5">在生产环境中运行大量服务</h3>
<h4 id="zh-advanced-crs">全局 CRS</h4>
<div class="admonition warning">
<p class="admonition-title">CRS 插件</p>
<p>当 CRS 全局加载时，<strong>不支持 CRS 插件</strong>。如果您需要使用它们，则需要为每个服务加载 CRS。</p>
</div>
<p>如果您在生产环境中使用 BunkerWeb 并有大量服务，并且您全局启用了带有 CRS 规则的 <strong>ModSecurity 功能</strong>，那么加载 BunkerWeb 配置所需的时间可能会变得过长，从而可能导致超时。</p>
<p>解决方法是全局加载 CRS 规则，而不是按服务加载。出于向后兼容性的原因，此行为默认未启用，并且因为它有一个缺点：如果您启用全局 CRS 规则加载，<strong>将不再可能按服务定义 modsec-crs 规则</strong>（在 CRS 规则之前执行）。然而，这个限制可以通过编写如下所示的全局 <code>modsec-crs</code> 排除规则来绕过：</p>
<div class="highlight"><pre><span></span><code>SecRule REQUEST_FILENAME &quot;@rx ^/somewhere$&quot; &quot;nolog,phase:4,allow,id:1010,chain&quot;
SecRule REQUEST_HEADERS:Host &quot;@rx ^app1\.example\.com$&quot; &quot;nolog&quot;
</code></pre></div>
<p>您可以通过将 <code>USE_MODSECURITY_GLOBAL_CRS</code> 设置为 <code>yes</code> 来启用全局 CRS 加载。</p>
<h4 id="zh-advanced-mariadbmysql-max_allowed_packet">为 MariaDB/MySQL 调整 max_allowed_packet</h4>
<p>在使用 BunkerWeb 并有大量服务时，MariaDB 和 MySQL 数据库服务器中 <code>max_allowed_packet</code> 参数的默认值似乎不足。</p>
<p>如果您遇到这样的错误，尤其是在调度程序上：</p>
<div class="highlight"><pre><span></span><code>[Warning] Aborted connection 5 to db: &#39;db&#39; user: &#39;bunkerweb&#39; host: &#39;172.20.0.4&#39; (Got a packet bigger than &#39;max_allowed_packet&#39; bytes)
</code></pre></div>
<p>您需要在您的数据库服务器上增加 <code>max_allowed_packet</code> 的值。</p>
<h3 id="zh-advanced-_6">封禁和报告的持久化</h3>
<p>默认情况下，BunkerWeb 将封禁和报告存储在本地的 Lua 数据存储中。虽然这种设置简单高效，但意味着当实例重启时数据会丢失。为了确保封禁和报告在重启后仍然存在，您可以将 BunkerWeb 配置为使用远程的 <a href="https://redis.io/">Redis</a> 或 <a href="https://valkey.io/">Valkey</a> 服务器。</p>
<p><strong>为什么使用 Redis/Valkey？</strong></p>
<p>Redis 和 Valkey 是功能强大的内存数据存储，通常用作数据库、缓存和消息代理。它们具有高度可扩展性，并支持多种数据结构，包括：</p>
<ul>
<li><strong>字符串</strong>：基本的键值对。</li>
<li><strong>哈希</strong>：单个键内的字段-值对。</li>
<li><strong>列表</strong>：有序的字符串集合。</li>
<li><strong>集合</strong>：无序的唯一字符串集合。</li>
<li><strong>有序集合</strong>：带有分数的有序集合。</li>
</ul>
<p>通过利用 Redis 或 Valkey，BunkerWeb 可以持久地存储封禁、报告和缓存数据，确保其持久性和可扩展性。</p>
<p><strong>启用 Redis/Valkey 支持</strong></p>
<p>要启用 Redis 或 Valkey 支持，请在您的 BunkerWeb 配置文件中配置以下设置：</p>
<div class="highlight"><pre><span></span><code># 启用 Redis/Valkey 支持
USE_REDIS=yes

# Redis/Valkey 服务器主机名或 IP 地址
REDIS_HOST=&lt;hostname&gt;

# Redis/Valkey 服务器端口号（默认：6379）
REDIS_PORT=6379

# Redis/Valkey 数据库编号（默认：0）
REDIS_DATABASE=0
</code></pre></div>
<ul>
<li><strong><code>USE_REDIS</code></strong>：设置为 <code>yes</code> 以启用 Redis/Valkey 集成。</li>
<li><strong><code>REDIS_HOST</code></strong>：指定 Redis/Valkey 服务器的主机名或 IP 地址。</li>
<li><strong><code>REDIS_PORT</code></strong>：指定 Redis/Valkey 服务器的端口号。默认为 <code>6379</code>。</li>
<li><strong><code>REDIS_DATABASE</code></strong>：指定要使用的 Redis/Valkey 数据库编号。默认为 <code>0</code>。</li>
</ul>
<p>如果您需要更高级的设置，例如身份验证、SSL/TLS 支持或 Sentinel 模式，请参阅 <a href="#zh-features-redis">Redis 插件设置文档</a>以获取详细指导。</p>
<h3 id="zh-advanced-udptcp">保护 UDP/TCP 应用程序</h3>
<div class="admonition example">
<p class="admonition-title">实验性功能</p>
<p>此功能尚未准备好用于生产。欢迎您进行测试，并通过 GitHub 仓库中的 <a href="https://github.com/bunkerity/bunkerweb/issues">issues</a> 向我们报告任何错误。</p>
</div>
<p>BunkerWeb 能够作为<strong>通用的 UDP/TCP 反向代理</strong>，让您可以保护任何至少在 OSI 模型第 4 层运行的网络应用程序。BunkerWeb 并未使用“传统”的 HTTP 模块，而是利用了 NGINX 的 <a href="https://nginx.org/en/docs/stream/ngx_stream_core_module.html">stream 模块</a>。</p>
<p>需要注意的是，<strong>在使用 stream 模块时，并非所有设置和安全功能都可用</strong>。有关此方面的更多信息，可以在文档的<a href="#zh-features">功能</a>部分找到。</p>
<p>配置一个基本的反向代理与 HTTP 设置非常相似，因为它涉及使用相同的设置：<code>USE_REVERSE_PROXY=yes</code> 和 <code>REVERSE_PROXY_HOST=myapp:9000</code>。即使当 BunkerWeb 位于负载均衡器之后时，设置也保持不变（由于显而易见的原因，支持的选项是<strong>PROXY 协议</strong>）。</p>
<p>除此之外，还使用了以下特定设置：</p>
<ul>
<li><code>SERVER_TYPE=stream</code>：激活 <code>stream</code> 模式（通用 UDP/TCP）而不是 <code>http</code> 模式（默认）</li>
<li><code>LISTEN_STREAM_PORT=4242</code>：BunkerWeb 将监听的“普通”（无 SSL/TLS）端口</li>
<li><code>LISTEN_STREAM_PORT_SSL=4343</code>：BunkerWeb 将监听的“ssl/tls”端口</li>
<li><code>USE_UDP=no</code>：监听并转发 UDP 数据包而不是 TCP</li>
</ul>
<p>有关 <code>stream</code> 模式的完整设置列表，请参阅文档的<a href="#zh-features">功能</a>部分。</p>
<div class="admonition tip">
<p class="admonition-title">多个监听端口</p>
<p>自 <code>1.6.0</code> 版本起，BunkerWeb 支持 <code>stream</code> 模式的多个监听端口。您可以使用 <code>LISTEN_STREAM_PORT</code> 和 <code>LISTEN_STREAM_PORT_SSL</code> 设置来指定它们。</p>
<p>这是一个示例：</p>
<div class="highlight"><pre><span></span><code>...
LISTEN_STREAM_PORT=4242
LISTEN_STREAM_PORT_SSL=4343
LISTEN_STREAM_PORT_1=4244
LISTEN_STREAM_PORT_SSL_1=4344
...
</code></pre></div>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="9:6"><input checked="checked" id="zh-advanced-__tabbed_9_1" name="zh-advanced-__tabbed_9" type="radio" /><input id="zh-advanced-__tabbed_9_2" name="zh-advanced-__tabbed_9" type="radio" /><input id="zh-advanced-__tabbed_9_3" name="zh-advanced-__tabbed_9" type="radio" /><input id="zh-advanced-__tabbed_9_4" name="zh-advanced-__tabbed_9" type="radio" /><input id="zh-advanced-__tabbed_9_5" name="zh-advanced-__tabbed_9" type="radio" /><input id="zh-advanced-__tabbed_9_6" name="zh-advanced-__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_9_1">All-in-one</label><label for="zh-advanced-__tabbed_9_2">Docker</label><label for="zh-advanced-__tabbed_9_3">Docker autoconf</label><label for="zh-advanced-__tabbed_9_4">Kubernetes</label><label for="zh-advanced-__tabbed_9_5">Linux</label><label for="zh-advanced-__tabbed_9_6">Swarm</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>在运行 All-in-one 容器时，您需要将设置添加到环境变量中。您还需要暴露流端口。</p>
<p>此示例将 BunkerWeb 配置为代理两个基于流的应用程序 <code>app1.example.com</code> 和 <code>app2.example.com</code>。</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">SERVICE_UI</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">SERVER_NAME</span><span class="o">=</span><span class="s2">&quot;app1.example.com app2.example.com&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">MULTISITE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">USE_REVERSE_PROXY</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">SERVER_TYPE</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span>app1.example.com_REVERSE_PROXY_HOST<span class="o">=</span><span class="s2">&quot;myapp1:9000&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span>app1.example.com_LISTEN_STREAM_PORT<span class="o">=</span><span class="s2">&quot;10000&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span>app2.example.com_REVERSE_PROXY_HOST<span class="o">=</span><span class="s2">&quot;myapp2:9000&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span>app2.example.com_LISTEN_STREAM_PORT<span class="o">=</span><span class="s2">&quot;20000&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">10000</span>:10000/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">20000</span>:20000/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>bunkerity/bunkerweb-all-in-one:testing
</code></pre></div>
<p>请注意，如果您的容器已经创建，您需要删除并重新创建它，以便应用新的环境变量。</p>
<p>您的应用程序（<code>myapp1</code>, <code>myapp2</code>）应该在单独的容器中运行（或以其他方式可访问），并且它们的主机名/IP（例如，在 <code>_REVERSE_PROXY_HOST</code> 中使用的 <code>myapp1</code>, <code>myapp2</code>）必须可以从 <code>bunkerweb-aio</code> 容器解析和访问。这通常涉及将它们连接到共享的 Docker 网络。</p>
<div class="admonition note">
<p class="admonition-title">停用 UI 服务</p>
<p>建议停用 UI 服务（例如，通过设置环境变量 <code>SERVICE_UI=no</code>），因为 Web UI 与 <code>SERVER_TYPE=stream</code> 不兼容。</p>
</div>
</div>
<div class="tabbed-block">
<p>当使用 Docker 集成时，保护现有网络应用程序的最简单方法是将服务添加到 <code>bw-services</code> 网络中：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-api-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-api-env</span>
<span class="w">  </span><span class="c1"># 我们使用锚点来避免为所有服务重复相同的设置</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">  </span><span class="c1"># 可选的 API 令牌，用于经过身份验证的 API 调用</span>
<span class="w">  </span><span class="nt">API_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080&quot;</span><span class="w"> </span><span class="c1"># 如果您想在使用 http 挑战类型时使用 Let&#39;s Encrypt 自动化，请保留此项</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;10000:10000&quot;</span><span class="w"> </span><span class="c1"># app1</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;20000:20000&quot;</span><span class="w"> </span><span class="c1"># app2</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.INSTANCE=yes&quot;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span><span class="w"> </span><span class="c1"># 此设置是指定 BunkerWeb 实例所必需的</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;app1.example.com</span><span class="nv"> </span><span class="s">app2.example.com&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">USE_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="c1"># 将应用于所有服务</span>
<span class="w">      </span><span class="nt">SERVER_TYPE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;stream&quot;</span><span class="w"> </span><span class="c1"># 将应用于所有服务</span>
<span class="w">      </span><span class="nt">app1.example.com_REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;myapp1:9000&quot;</span>
<span class="w">      </span><span class="nt">app1.example.com_LISTEN_STREAM_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10000&quot;</span>
<span class="w">      </span><span class="nt">app2.example.com_REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;myapp2:9000&quot;</span>
<span class="w">      </span><span class="nt">app2.example.com_LISTEN_STREAM_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;20000&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>

<span class="w">  </span><span class="nt">myapp1</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio/tcp-echo-server:1.3</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;9000&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;app1&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">myapp2</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio/tcp-echo-server:1.3</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;9000&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;app2&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>在您的机器上运行 <a href="#zh-integrations-docker-autoconf">Docker autoconf 集成</a>堆栈之前，您需要编辑端口：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080&quot;</span><span class="w"> </span><span class="c1"># 如果您想在使用 http 挑战类型时使用 Let&#39;s Encrypt 自动化，请保留此项</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;10000:10000&quot;</span><span class="w"> </span><span class="c1"># app1</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;20000:20000&quot;</span><span class="w"> </span><span class="c1"># app2</span>
<span class="nn">...</span>
</code></pre></div>
<p>一旦堆栈运行，您可以将现有应用程序连接到 <code>bw-services</code> 网络，并使用标签配置 BunkerWeb：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">myapp1</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio/tcp-echo-server:1.3</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;9000&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;app1&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=app1.example.com&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_TYPE=stream&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_REVERSE_PROXY=yes&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_HOST=myapp1:9000&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.LISTEN_STREAM_PORT=10000&quot;</span>

<span class="w">  </span><span class="nt">myapp2</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio/tcp-echo-server:1.3</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;9000&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;app2&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=app2.example.com&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_TYPE=stream&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_REVERSE_PROXY=yes&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_HOST=myapp2:9000&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.LISTEN_STREAM_PORT=20000&quot;</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">实验性功能</p>
<p>目前，<a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingresses</a> 不支持 <code>stream</code> 模式。<strong>我们在这里所做的是一个使其工作的变通方法。</strong></p>
<p>欢迎您进行测试，并通过 GitHub 仓库中的 <a href="https://github.com/bunkerity/bunkerweb/issues">issues</a> 向我们报告任何错误。</p>
</div>
<p>在您的机器上运行 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>堆栈之前，您需要在您的负载均衡器上打开端口：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lb</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span><span class="w"> </span><span class="c1"># 如果您想在使用 http 挑战类型时使用 Let&#39;s Encrypt 自动化，请保留此项</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app1</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app2</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20000</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20000</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb</span>
</code></pre></div>
<p>一旦堆栈运行，您可以创建您的 ingress 资源：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">services</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bunkerweb.io/SERVER_TYPE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;stream&quot;</span><span class="w"> </span><span class="c1"># 将应用于所有服务</span>
<span class="w">    </span><span class="nt">bunkerweb.io/app1.example.com_LISTEN_STREAM_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10000&quot;</span>
<span class="w">    </span><span class="nt">bunkerweb.io/app2.example.com_LISTEN_STREAM_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;20000&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app1.example.com</span>
<span class="w">      </span><span class="nt">http</span><span class="p">:</span>
<span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span><span class="w"> </span><span class="c1"># 在 stream 模式下不使用，但必须填写</span>
<span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">              </span><span class="nt">service</span><span class="p">:</span>
<span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc-app1</span>
<span class="w">                </span><span class="nt">port</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app2.example.com</span>
<span class="w">      </span><span class="nt">http</span><span class="p">:</span>
<span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span><span class="w"> </span><span class="c1"># 在 stream 模式下不使用，但必须填写</span>
<span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">              </span><span class="nt">service</span><span class="p">:</span>
<span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc-app2</span>
<span class="w">                </span><span class="nt">port</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app1</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">services</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app1</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app1</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app1</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app1</span>
<span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio/tcp-echo-server:1.3</span>
<span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;9000&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;app1&quot;</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc-app1</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">services</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app1</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app2</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">services</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app2</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app2</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app2</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app2</span>
<span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio/tcp-echo-server:1.3</span>
<span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;9000&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;app2&quot;</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc-app2</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">services</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app2</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>您需要将设置添加到 <code>/etc/bunkerweb/variables.env</code> 文件中：</p>
<div class="highlight"><pre><span></span><code>...
SERVER_NAME=app1.example.com app2.example.com
MULTISITE=yes
USE_REVERSE_PROXY=yes
SERVER_TYPE=stream
app1.example.com_REVERSE_PROXY_HOST=myapp1.domain.or.ip:9000
app1.example.com_LISTEN_STREAM_PORT=10000
app2.example.com_REVERSE_PROXY_HOST=myapp2.domain.or.ip:9000
app2.example.com_LISTEN_STREAM_PORT=20000
...
</code></pre></div>
<p>现在让我们检查调度程序的状态：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>status<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
<p>如果它们已经在运行，我们可以重新加载它：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>reload<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
<p>否则，我们需要启动它：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
<p><strong>更多信息可以在 <a href="#zh-integrations-swarm">Swarm 集成文档</a>中找到。</strong></p>
</div>
<p>在您的机器上运行 <a href="#zh-integrations-swarm">Swarm 集成</a>堆栈之前，您需要编辑端口：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># 如果您想在使用 http 挑战类型时使用 Let&#39;s Encrypt 自动化，请保留此项</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp</span>
<span class="w">      </span><span class="c1"># app1</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp</span>
<span class="w">      </span><span class="c1"># app2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20000</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20000</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp</span>
<span class="nn">...</span>
</code></pre></div>
<p>一旦堆栈运行，您可以将现有应用程序连接到 <code>bw-services</code> 网络，并使用标签配置 BunkerWeb：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>

<span class="w">  </span><span class="nt">myapp1</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio/tcp-echo-server:1.3</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;9000&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;app1&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role==worker&quot;</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=app1.example.com&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_TYPE=stream&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_REVERSE_PROXY=yes&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_HOST=myapp1:9000&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.LISTEN_STREAM_PORT=10000&quot;</span>

<span class="w">  </span><span class="nt">myapp2</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">istio/tcp-echo-server:1.3</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;9000&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;app2&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role==worker&quot;</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=app2.example.com&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_TYPE=stream&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_REVERSE_PROXY=yes&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_HOST=myapp2:9000&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.LISTEN_STREAM_PORT=20000&quot;</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="zh-advanced-php">PHP</h3>
<div class="admonition example">
<p class="admonition-title">实验性功能</p>
<p>目前，BunkerWeb 对 PHP 的支持仍处于测试阶段，我们建议您如果可以的话，使用反向代理架构。顺便说一句，对于某些集成（如 Kubernetes），PHP 完全不受支持。</p>
</div>
<p>BunkerWeb 支持使用外部或远程的 <a href="https://www.php.net/manual/en/install.fpm.php">PHP-FPM</a> 实例。我们将假设您已经熟悉管理此类服务。</p>
<p>可以使用以下设置：</p>
<ul>
<li><code>REMOTE_PHP</code>：远程 PHP-FPM 实例的主机名。</li>
<li><code>REMOTE_PHP_PATH</code>：远程 PHP-FPM 实例中包含文件的根文件夹。</li>
<li><code>REMOTE_PHP_PORT</code>：远程 PHP-FPM 实例的端口（<em>默认为 9000</em>）。</li>
<li><code>LOCAL_PHP</code>：本地 PHP-FPM 实例的套接字文件路径。</li>
<li><code>LOCAL_PHP_PATH</code>：本地 PHP-FPM 实例中包含文件的根文件夹。</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="10:6"><input checked="checked" id="zh-advanced-__tabbed_10_1" name="zh-advanced-__tabbed_10" type="radio" /><input id="zh-advanced-__tabbed_10_2" name="zh-advanced-__tabbed_10" type="radio" /><input id="zh-advanced-__tabbed_10_3" name="zh-advanced-__tabbed_10" type="radio" /><input id="zh-advanced-__tabbed_10_4" name="zh-advanced-__tabbed_10" type="radio" /><input id="zh-advanced-__tabbed_10_5" name="zh-advanced-__tabbed_10" type="radio" /><input id="zh-advanced-__tabbed_10_6" name="zh-advanced-__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_10_1">All-in-one</label><label for="zh-advanced-__tabbed_10_2">Docker</label><label for="zh-advanced-__tabbed_10_3">Docker autoconf</label><label for="zh-advanced-__tabbed_10_4">Kubernetes</label><label for="zh-advanced-__tabbed_10_5">Linux</label><label for="zh-advanced-__tabbed_10_6">Swarm</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>当使用 <a href="#zh-integrations-all-in-one-aio-image">All-in-one 镜像</a>时，要支持 PHP 应用程序，您需要：</p>
<ul>
<li>将您的 PHP 文件挂载到 BunkerWeb 的 <code>/var/www/html</code> 文件夹中。</li>
<li>为您的应用程序设置一个 PHP-FPM 容器，并挂载包含 PHP 文件的文件夹。</li>
<li>在运行 BunkerWeb 时，使用特定的设置 <code>REMOTE_PHP</code> 和 <code>REMOTE_PHP_PATH</code> 作为环境变量。</li>
</ul>
<p>如果您启用<a href="#zh-concepts-multisite-mode">多站点模式</a>，您需要为每个应用程序创建单独的目录。每个子目录应使用 <code>SERVER_NAME</code> 的第一个值来命名。这是一个示例：</p>
<div class="highlight"><pre><span></span><code>www
├── app1.example.com
│   └── index.php
└── app2.example.com
    └── index.php

2 directories, 2 files
</code></pre></div>
<p>我们将假设您的 PHP 应用程序位于名为 <code>www</code> 的文件夹中。请注意，您需要修复权限，以便 BunkerWeb (UID/GID 101) 至少可以读取文件和列出文件夹，而 PHP-FPM (UID/GID 33，如果您使用 <code>php:fpm</code> 镜像) 是文件和文件夹的所有者：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">33</span>:101<span class="w"> </span>./www<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
find<span class="w"> </span>./www<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-exec<span class="w"> </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
find<span class="w"> </span>./www<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-exec<span class="w"> </span>chmod<span class="w"> </span><span class="m">0750</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span>
</code></pre></div>
<p>现在您可以运行 BunkerWeb，为您的 PHP 应用程序配置它，并运行 PHP 应用程序。您需要创建一个自定义的 Docker 网络，以允许 BunkerWeb 与您的 PHP-FPM 容器通信。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建一个自定义网络</span>
docker<span class="w"> </span>network<span class="w"> </span>create<span class="w"> </span>php-network

<span class="c1"># 运行 PHP-FPM 容器</span>
docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--name<span class="w"> </span>myapp1-php<span class="w"> </span>--network<span class="w"> </span>php-network<span class="w"> </span>-v<span class="w"> </span>./www/app1.example.com:/app<span class="w"> </span>php:fpm
docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--name<span class="w"> </span>myapp2-php<span class="w"> </span>--network<span class="w"> </span>php-network<span class="w"> </span>-v<span class="w"> </span>./www/app2.example.com:/app<span class="w"> </span>php:fpm

<span class="c1"># 运行 BunkerWeb All-in-one</span>
docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--network<span class="w"> </span>php-network<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>./www:/var/www/html<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>bw-storage:/data<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">SERVER_NAME</span><span class="o">=</span><span class="s2">&quot;app1.example.com app2.example.com&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">MULTISITE</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span><span class="nv">REMOTE_PHP_PATH</span><span class="o">=</span><span class="s2">&quot;/app&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span>app1.example.com_REMOTE_PHP<span class="o">=</span><span class="s2">&quot;myapp1-php&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-e<span class="w"> </span>app2.example.com_REMOTE_PHP<span class="o">=</span><span class="s2">&quot;myapp2-php&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>bunkerity/bunkerweb-all-in-one:testing
</code></pre></div>
<p>请注意，如果您的容器已经创建，您需要删除并重新创建它，以便应用新的环境变量。</p>
</div>
<div class="tabbed-block">
<p>当使用 <a href="#zh-integrations-docker">Docker 集成</a>时，要支持 PHP 应用程序，您需要：</p>
<ul>
<li>将您的 PHP 文件挂载到 BunkerWeb 的 <code>/var/www/html</code> 文件夹中</li>
<li>为您的应用程序设置一个 PHP-FPM 容器，并挂载包含 PHP 文件的文件夹</li>
<li>在启动 BunkerWeb 时，使用特定的设置 <code>REMOTE_PHP</code> 和 <code>REMOTE_PHP_PATH</code> 作为环境变量</li>
</ul>
<p>如果您启用<a href="#zh-concepts-multisite-mode">多站点模式</a>，您需要为每个应用程序创建单独的目录。每个子目录应使用 <code>SERVER_NAME</code> 的第一个值来命名。这是一个示例：</p>
<div class="highlight"><pre><span></span><code>www
├── app1.example.com
│   └── index.php
├── app2.example.com
│   └── index.php
└── app3.example.com
    └── index.php

3 directories, 3 files
</code></pre></div>
<p>我们将假设您的 PHP 应用程序位于名为 <code>www</code> 的文件夹中。请注意，您需要修复权限，以便 BunkerWeb (UID/GID 101) 至少可以读取文件和列出文件夹，而 PHP-FPM (UID/GID 33，如果您使用 <code>php:fpm</code> 镜像) 是文件和文件夹的所有者：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">33</span>:101<span class="w"> </span>./www<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
find<span class="w"> </span>./www<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-exec<span class="w"> </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
find<span class="w"> </span>./www<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-exec<span class="w"> </span>chmod<span class="w"> </span><span class="m">0750</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span>
</code></pre></div>
<p>现在您可以运行 BunkerWeb，为您的 PHP 应用程序配置它，并运行 PHP 应用程序：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-api-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-api-env</span>
<span class="w">  </span><span class="c1"># 我们使用锚点来避免为所有服务重复相同的设置</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w"> </span><span class="c1"># QUIC</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./www:/var/www/html</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span><span class="w"> </span><span class="c1"># 此设置是指定 BunkerWeb 实例所必需的</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;app1.example.com</span><span class="nv"> </span><span class="s">app2.example.com&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">REMOTE_PHP_PATH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/app&quot;</span><span class="w"> </span><span class="c1"># 由于 MULTISITE 设置，将应用于所有服务</span>
<span class="w">      </span><span class="nt">app1.example.com_REMOTE_PHP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;myapp1&quot;</span>
<span class="w">      </span><span class="nt">app2.example.com_REMOTE_PHP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;myapp2&quot;</span>
<span class="w">      </span><span class="nt">app3.example.com_REMOTE_PHP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;myapp3&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>

<span class="w">  </span><span class="nt">myapp1</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">php:fpm</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./www/app1.example.com:/app</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">myapp2</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">php:fpm</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./www/app2.example.com:/app</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">myapp3</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">php:fpm</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./www/app3.example.com:/app</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition info">
<p class="admonition-title">已启用多站点模式</p>
<p><a href="#zh-integrations-docker-autoconf">Docker autoconf 集成</a>意味着使用多站点模式：保护一个 PHP 应用程序与保护多个应用程序相同。</p>
</div>
<p>当使用 <a href="#zh-integrations-docker-autoconf">Docker autoconf 集成</a>时，要支持 PHP 应用程序，您需要：</p>
<ul>
<li>将您的 PHP 文件挂载到 BunkerWeb 的 <code>/var/www/html</code> 文件夹中</li>
<li>为您的应用程序设置 PHP-FPM 容器，并挂载包含 PHP 应用程序的文件夹</li>
<li>使用特定的设置 <code>REMOTE_PHP</code> 和 <code>REMOTE_PHP_PATH</code> 作为您的 PHP-FPM 容器的标签</li>
</ul>
<p>由于 Docker autoconf 意味着使用<a href="#zh-concepts-multisite-mode">多站点模式</a>，您需要为每个应用程序创建单独的目录。每个子目录应使用 <code>SERVER_NAME</code> 的第一个值来命名。这是一个示例：</p>
<div class="highlight"><pre><span></span><code>www
├── app1.example.com
│   └── index.php
├── app2.example.com
│   └── index.php
└── app3.example.com
    └── index.php

3 directories, 3 files
</code></pre></div>
<p>创建文件夹后，复制您的文件并修复权限，以便 BunkerWeb (UID/GID 101) 至少可以读取文件和列出文件夹，而 PHP-FPM (UID/GID 33，如果您使用 <code>php:fpm</code> 镜像) 是文件和文件夹的所有者：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">33</span>:101<span class="w"> </span>./www<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
find<span class="w"> </span>./www<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-exec<span class="w"> </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
find<span class="w"> </span>./www<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-exec<span class="w"> </span>chmod<span class="w"> </span><span class="m">0750</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span>
</code></pre></div>
<p>当您启动 BunkerWeb autoconf 堆栈时，将 <code>www</code> 文件夹挂载到 <strong>Scheduler</strong> 容器的 <code>/var/www/html</code> 中：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-api-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-api-env</span>
<span class="w">  </span><span class="c1"># 我们使用锚点来避免为所有服务重复相同的设置</span>
<span class="w">  </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.INSTANCE=yes&quot;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./www:/var/www/html</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-api-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 我们不需要在这里指定 BunkerWeb 实例，因为它们由 autoconf 服务自动检测</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 服务器名称将由服务标签填充</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="c1"># autoconf 的强制设置</span>
<span class="w">      </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:testing</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置更强的密码</span>
<span class="w">      </span><span class="nt">DOCKER_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tcp://bw-docker:2375&quot;</span><span class="w"> </span><span class="c1"># Docker 套接字</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tecnativa/docker-socket-proxy:nightly</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock:ro</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CONTAINERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warning&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
</code></pre></div>
<p>现在您可以创建您的 PHP-FPM 容器，挂载正确的子文件夹并使用标签来配置 BunkerWeb：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">myapp1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">php:fpm</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./www/app1.example.com:/app</span>
<span class="w">      </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">        </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">            </span><span class="nt">aliases</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp1</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=app1.example.com&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP=myapp1&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP_PATH=/app&quot;</span>

<span class="w">  </span><span class="nt">myapp2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">php:fpm</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./www/app2.example.com:/app</span>
<span class="w">      </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">        </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">            </span><span class="nt">aliases</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp2</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=app2.example.com&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP=myapp2&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP_PATH=/app&quot;</span>

<span class="w">  </span><span class="nt">myapp3</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">php:fpm</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./www/app3.example.com:/app</span>
<span class="w">      </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">        </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">            </span><span class="nt">aliases</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp3</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=app3.example.com&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP=myapp3&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP_PATH=/app&quot;</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">Kubernetes 不支持 PHP</p>
<p>Kubernetes 集成允许通过 <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a> 进行配置，而 BunkerWeb 控制器目前仅支持 HTTP 应用程序。</p>
</div>
</div>
<div class="tabbed-block">
<p>我们将假设您已经在您的机器上运行了 <a href="#zh-integrations-linux">Linux 集成</a>堆栈。</p>
<p>默认情况下，BunkerWeb 将在 <code>/var/www/html</code> 文件夹内搜索 Web 文件。您可以用它来存储您的 PHP 应用程序。请注意，您需要配置您的 PHP-FPM 服务来获取或设置运行进程的用户/组以及用于与 BunkerWeb 通信的 UNIX 套接字文件。</p>
<p>首先，您需要确保您的 PHP-FPM 实例可以访问 <code>/var/www/html</code> 文件夹内的文件，并且 BunkerWeb 可以访问 UNIX 套接字文件以便与 PHP-FPM 通信。我们建议为 PHP-FPM 服务设置一个不同的用户，如 <code>www-data</code>，并给予 nginx 组访问 UNIX 套接字文件的权限。以下是相应的 PHP-FPM 配置：</p>
<div class="highlight"><pre><span></span><code><span class="na">...</span>
<span class="k">[www]</span>
<span class="na">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">www-data</span>
<span class="na">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">www-data</span>
<span class="na">listen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/run/php/php-fpm.sock</span>
<span class="na">listen.owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">www-data</span>
<span class="na">listen.group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">nginx</span>
<span class="na">listen.mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0660</span>
<span class="na">...</span>
</code></pre></div>
<p>不要忘记重启您的 PHP-FPM 服务：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>restart<span class="w"> </span>php-fpm
</code></pre></div>
<p>如果您启用<a href="#zh-concepts-multisite-mode">多站点模式</a>，您需要为每个应用程序创建单独的目录。每个子目录应使用 <code>SERVER_NAME</code> 的第一个值来命名。这是一个示例：</p>
<div class="highlight"><pre><span></span><code>/var/www/html
├── app1.example.com
│   └── index.php
├── app2.example.com
│   └── index.php
└── app3.example.com
    └── index.php

3 directories, 3 files
</code></pre></div>
<p>请注意，您需要修复权限，以便 BunkerWeb（<code>nginx</code> 组）至少可以读取文件和列出文件夹，而 PHP-FPM（<code>www-data</code> 用户，但这可能因您的系统而异）是文件和文件夹的所有者：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span>www-data:nginx<span class="w"> </span>/var/www/html<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
find<span class="w"> </span>/var/www/html<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-exec<span class="w"> </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
find<span class="w"> </span>/var/www/html<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-exec<span class="w"> </span>chmod<span class="w"> </span><span class="m">0750</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span>
</code></pre></div>
<p>现在您可以编辑 <code>/etc/bunkerweb/variable.env</code> 文件：</p>
<div class="highlight"><pre><span></span><code>HTTP_PORT=80
HTTPS_PORT=443
DNS_RESOLVERS=9.9.9.9 8.8.8.8 8.8.4.4
API_LISTEN_IP=127.0.0.1
MULTISITE=yes
SERVER_NAME=app1.example.com app2.example.com app3.example.com
app1.example.com_LOCAL_PHP=/run/php/php-fpm.sock
app1.example.com_LOCAL_PHP_PATH=/var/www/html/app1.example.com
app2.example.com_LOCAL_PHP=/run/php/php-fpm.sock
app2.example.com_LOCAL_PHP_PATH=/var/www/html/app2.example.com
app3.example.com_LOCAL_PHP=/run/php/php-fpm.sock
app3.example.com_LOCAL_PHP_PATH=/var/www/html/app3.example.com
</code></pre></div>
<p>现在让我们检查调度程序的状态：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>status<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
<p>如果它们已经在运行，我们可以重新加载它：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>reload<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
<p>否则，我们需要启动它：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
<p><strong>更多信息可以在 <a href="#zh-integrations-swarm">Swarm 集成文档</a>中找到。</strong></p>
</div>
<div class="admonition info">
<p class="admonition-title">已启用多站点模式</p>
<p><a href="#zh-integrations-docker-autoconf">Swarm 集成</a>意味着使用多站点模式：保护一个 PHP 应用程序与保护多个应用程序相同。</p>
</div>
<div class="admonition info">
<p class="admonition-title">共享卷</p>
<p>在 Docker Swarm 集成中使用 PHP 需要在所有 BunkerWeb 和 PHP-FPM 实例之间共享一个卷，这不在本文档的讨论范围之内。</p>
</div>
<p>当使用 <a href="#zh-integrations-swarm">Swarm</a>时，要支持 PHP 应用程序，您需要：</p>
<ul>
<li>将您的 PHP 文件挂载到 BunkerWeb 的 <code>/var/www/html</code> 文件夹中</li>
<li>为您的应用程序设置 PHP-FPM 容器，并挂载包含 PHP 应用程序的文件夹</li>
<li>使用特定的设置 <code>REMOTE_PHP</code> 和 <code>REMOTE_PHP_PATH</code> 作为您的 PHP-FPM 容器的标签</li>
</ul>
<p>由于 Swarm 集成意味着使用<a href="#zh-concepts-multisite-mode">多站点模式</a>，您需要为每个应用程序创建单独的目录。每个子目录应使用 <code>SERVER_NAME</code> 的第一个值来命名。这是一个示例：</p>
<div class="highlight"><pre><span></span><code>www
├── app1.example.com
│   └── index.php
├── app2.example.com
│   └── index.php
└── app3.example.com
    └── index.php

3 directories, 3 files
</code></pre></div>
<p>作为一个例子，我们将假设您有一个共享文件夹挂载在您的工作节点上的 <code>/shared</code> 端点。</p>
<p>创建文件夹后，复制您的文件并修复权限，以便 BunkerWeb (UID/GID 101) 至少可以读取文件和列出文件夹，而 PHP-FPM (UID/GID 33，如果您使用 <code>php:fpm</code> 镜像) 是文件和文件夹的所有者：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">33</span>:101<span class="w"> </span>/shared/www<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
find<span class="w"> </span>/shared/www<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-exec<span class="w"> </span>chmod<span class="w"> </span><span class="m">0640</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
find<span class="w"> </span>/shared/www<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-exec<span class="w"> </span>chmod<span class="w"> </span><span class="m">0750</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span>
</code></pre></div>
<p>当您启动 BunkerWeb 堆栈时，将 <code>/shared/www</code> 文件夹挂载到 <strong>Scheduler</strong> 容器的 <code>/var/www/html</code> 中：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/shared/www:/var/www/html</span>
<span class="nn">...</span>
</code></pre></div>
<p>现在您可以创建您的 PHP-FPM 服务，挂载正确的子文件夹并使用标签来配置 BunkerWeb：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">myapp1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">php:fpm</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./www/app1.example.com:/app</span>
<span class="w">      </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">        </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">            </span><span class="nt">aliases</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp1</span>
<span class="w">      </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">        </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">          </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role==worker&quot;</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=app1.example.com&quot;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP=myapp1&quot;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP_PATH=/app&quot;</span>

<span class="w">  </span><span class="nt">myapp2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">php:fpm</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./www/app2.example.com:/app</span>
<span class="w">      </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">        </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">            </span><span class="nt">aliases</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp2</span>
<span class="w">      </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">        </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">          </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role==worker&quot;</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=app2.example.com&quot;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP=myapp2&quot;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP_PATH=/app&quot;</span>

<span class="w">  </span><span class="nt">myapp3</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">php:fpm</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./www/app3.example.com:/app</span>
<span class="w">      </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">        </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">            </span><span class="nt">aliases</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp3</span>
<span class="w">      </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">        </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">          </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role==worker&quot;</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=app3.example.com&quot;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP=myapp3&quot;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REMOTE_PHP_PATH=/app&quot;</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="zh-advanced-ipv6">IPv6</h3>
<div class="admonition example">
<p class="admonition-title">实验性功能</p>
<p>此功能尚未准备好用于生产。欢迎您进行测试，并通过 GitHub 仓库中的 <a href="https://github.com/bunkerity/bunkerweb/issues">issues</a> 向我们报告任何错误。</p>
</div>
<p>默认情况下，BunkerWeb 只会监听 IPv4 地址，不会使用 IPv6 进行网络通信。如果您想启用 IPv6 支持，需要将 <code>USE_IPV6=yes</code>。请注意，您的网络和环境的 IPv6 配置超出了本文档的范围。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="11:2"><input checked="checked" id="zh-advanced-__tabbed_11_1" name="zh-advanced-__tabbed_11" type="radio" /><input id="zh-advanced-__tabbed_11_2" name="zh-advanced-__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_11_1">Docker / Autoconf / Swarm</label><label for="zh-advanced-__tabbed_11_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>首先，您需要配置您的 Docker 守护进程以启用容器的 IPv6 支持，并在需要时使用 ip6tables。这是您 <code>/etc/docker/daemon.json</code> 文件的示例配置：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;experimental&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;ipv6&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;ip6tables&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;fixed-cidr-v6&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;fd00:dead:beef::/48&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>现在您可以重启 Docker 服务以应用更改：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>restart<span class="w"> </span>docker
</code></pre></div>
<p>一旦 Docker 设置好支持 IPv6，您就可以添加 <code>USE_IPV6</code> 设置并为 <code>bw-services</code> 配置 IPv6：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">USE_IPv6</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>

<span class="nn">...</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">enable_ipv6</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fd00:13:37::/48</span>
<span class="w">          </span><span class="nt">gateway</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fd00:13:37::1</span>

<span class="nn">...</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>您需要将设置添加到 <code>/etc/bunkerweb/variables.env</code> 文件中：</p>
<div class="highlight"><pre><span></span><code>...
USE_IPV6=yes
...
</code></pre></div>
<p>让我们检查 BunkerWeb 的状态：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>status<span class="w"> </span>bunkerweb
</code></pre></div>
<p>如果它们已经在运行，我们可以重启它：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>restart<span class="w"> </span>bunkerweb
</code></pre></div>
<p>否则，我们需要启动它：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-advanced-_7">安全性调整</h2>
<p>BunkerWeb 提供了许多安全功能，您可以通过<a href="#zh-features">功能</a>进行配置。尽管设置的默认值确保了最低限度的“默认安全”，我们强烈建议您对它们进行调整。这样做，您不仅能够确保您所选择的安全级别，还能管理误报。</p>
<div class="admonition tip">
<p class="admonition-title">其他功能</p>
<p>本节仅关注安全调整，有关其他设置，请参阅文档的<a href="#zh-features">功能</a>部分。</p>
</div>
<figure>
<p><img align="center" alt="概述" src="../assets/img/core-order.svg" />
  </p>
<figcaption>核心安全插件的概述和顺序</figcaption>
</figure>
<h2 id="zh-advanced-crowdsec">CrowdSec 控制台集成</h2>
<p>如果您还不熟悉 CrowdSec 控制台集成，<a href="https://www.crowdsec.net/?utm_campaign=bunkerweb&amp;utm_source=doc">CrowdSec</a> 利用众包情报来对抗网络威胁。可以把它想象成“网络安全界的 Waze”——当一台服务器受到攻击时，全球其他系统都会收到警报，并受到保护，免受同一攻击者的侵害。您可以在<a href="https://www.crowdsec.net/about?utm_campaign=bunkerweb&amp;utm_source=blog">这里</a>了解更多信息。</p>
<p><strong>恭喜，您的 BunkerWeb 实例现已注册到您的 CrowdSec 控制台！</strong></p>
<p>专业提示：查看警报时，点击“列”选项并勾选“上下文”复选框，以访问 BunkerWeb 特定的数据。</p>
<figure>
<p><img align="center" alt="概述" src="../assets/img/crowdity4.png" />
  </p>
<figcaption>在上下文列中显示的 BunkerWeb 数据</figcaption>
</figure>
<h2 id="zh-advanced-_8">监控和报告</h2>
<h4 id="zh-advanced-pro">监控 <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style="transform : translateY(3px);"> (PRO)</h4>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>监控插件让您可以收集和检索关于 BunkerWeb 的指标。启用它后，您的实例将开始收集与攻击、请求和性能相关的各种数据。然后，您可以通过定期调用 <code>/monitoring</code> API 端点或使用其他插件（如 Prometheus 导出器）来检索它们。</p>
<p><strong>功能列表</strong></p>
<ul>
<li>启用各种 BunkerWeb 指标的收集</li>
<li>从 API 检索指标</li>
<li>与其他插件结合使用（例如 Prometheus 导出器）</li>
<li>专用 UI 页面监控您的实例</li>
</ul>
<p><strong>设置列表</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_MONITORING</code></td>
<td><code>yes</code></td>
<td>全局</td>
<td>否</td>
<td>启用 BunkerWeb 的监控。</td>
</tr>
<tr>
<td><code>MONITORING_METRICS_DICT_SIZE</code></td>
<td><code>10M</code></td>
<td>全局</td>
<td>否</td>
<td>用于存储监控指标的字典大小。</td>
</tr>
</tbody>
</table>
<h4 id="zh-advanced-prometheus-pro">Prometheus 导出器 <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style="transform : translateY(3px);"> (PRO)</h4>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p>Prometheus 导出器插件在您的 BunkerWeb 实例上添加了一个 <a href="https://prometheus.io/docs/instrumenting/exporters/">Prometheus 导出器</a>。启用后，您可以配置您的 Prometheus 实例来抓取 BunkerWeb 上的特定端点并收集内部指标。</p>
<p>我们还提供了一个 <a href="https://grafana.com/grafana/dashboards/20755-bunkerweb/">Grafana 仪表板</a>，您可以将其导入到自己的实例中，并连接到您自己的 Prometheus 数据源。</p>
<p><strong>请注意，使用 Prometheus 导出器插件需要启用监控插件 (<code>USE_MONITORING=yes</code>)</strong></p>
<p><strong>功能列表</strong></p>
<ul>
<li>提供内部 BunkerWeb 指标的 Prometheus 导出器</li>
<li>专用且可配置的端口、监听 IP 和 URL</li>
<li>白名单 IP/网络以实现最高安全性</li>
</ul>
<p><strong>设置列表</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_PROMETHEUS_EXPORTER</code></td>
<td><code>no</code></td>
<td>全局</td>
<td>否</td>
<td>启用 Prometheus 导出。</td>
</tr>
<tr>
<td><code>PROMETHEUS_EXPORTER_IP</code></td>
<td><code>0.0.0.0</code></td>
<td>全局</td>
<td>否</td>
<td>Prometheus 导出器的监听 IP。</td>
</tr>
<tr>
<td><code>PROMETHEUS_EXPORTER_PORT</code></td>
<td><code>9113</code></td>
<td>全局</td>
<td>否</td>
<td>Prometheus 导出器的监听端口。</td>
</tr>
<tr>
<td><code>PROMETHEUS_EXPORTER_URL</code></td>
<td><code>/metrics</code></td>
<td>全局</td>
<td>否</td>
<td>Prometheus 导出器的 HTTP URL。</td>
</tr>
<tr>
<td><code>PROMETHEUS_EXPORTER_ALLOW_IP</code></td>
<td><code>127.0.0.0/8 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16</code></td>
<td>全局</td>
<td>否</td>
<td>允许联系 Prometheus 导出器端点的 IP/网络列表。</td>
</tr>
</tbody>
</table>
<h4 id="zh-advanced-pro_1">报告 <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style="transform : translateY(3px);"> (PRO)</h4>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<div class="admonition warning">
<p class="admonition-title">需要监控插件</p>
<p>此插件需要安装并启用监控专业版插件，并且 <code>USE_MONITORING</code> 设置为 <code>yes</code>。</p>
</div>
<p>报告插件提供了一个全面的解决方案，用于定期报告 BunkerWeb 的重要数据，包括全局统计、攻击、封禁、请求、原因和 AS 信息。它提供了广泛的功能，包括自动报告创建、自定义选项以及与监控专业版插件的无缝集成。使用报告插件，您可以轻松生成和管理报告，以监控应用程序的性能和安全性。</p>
<p><strong>功能列表</strong></p>
<ul>
<li>定期报告 BunkerWeb 的重要数据，包括全局统计、攻击、封禁、请求、原因和 AS 信息。</li>
<li>与监控专业版插件集成，实现无缝集成和增强的报告功能。</li>
<li>支持 webhooks（经典、Discord 和 Slack）以进行实时通知。</li>
<li>支持 SMTP 以进行电子邮件通知。</li>
<li>用于自定义和灵活性的配置选项。</li>
</ul>
<p><strong>设置列表</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认</th>
<th>上下文</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_REPORTING_SMTP</code></td>
<td><code>no</code></td>
<td>全局</td>
<td>启用通过电子邮件发送报告。</td>
</tr>
<tr>
<td><code>USE_REPORTING_WEBHOOK</code></td>
<td><code>no</code></td>
<td>全局</td>
<td>启用通过 webhook 发送报告。</td>
</tr>
<tr>
<td><code>REPORTING_SCHEDULE</code></td>
<td><code>weekly</code></td>
<td>全局</td>
<td>发送报告的频率。</td>
</tr>
<tr>
<td><code>REPORTING_WEBHOOK_URLS</code></td>
<td></td>
<td>全局</td>
<td>用于接收 Markdown 格式报告的 webhook URL 列表（以空格分隔）。</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_EMAILS</code></td>
<td></td>
<td>全局</td>
<td>用于接收 HTML 格式报告的电子邮件地址列表（以空格分隔）。</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_HOST</code></td>
<td></td>
<td>全局</td>
<td>用于 SMTP 发送的主机服务器。</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_PORT</code></td>
<td><code>465</code></td>
<td>全局</td>
<td>用于 SMTP 的端口。请注意，根据连接类型有不同的标准（SSL = 465，TLS = 587）。</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_FROM_EMAIL</code></td>
<td></td>
<td>全局</td>
<td>用作发件人的电子邮件地址。请注意，此电子邮件地址必须禁用 2FA。</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_FROM_USER</code></td>
<td></td>
<td>全局</td>
<td>通过发件人电子邮件地址发送的用户身份验证值。</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_FROM_PASSWORD</code></td>
<td></td>
<td>全局</td>
<td>通过发件人电子邮件地址发送的密码身份验证值。</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_SSL</code></td>
<td><code>SSL</code></td>
<td>全局</td>
<td>确定是否为 SMTP 使用安全连接。</td>
</tr>
<tr>
<td><code>REPORTING_SMTP_SUBJECT</code></td>
<td><code>BunkerWeb Report</code></td>
<td>全局</td>
<td>电子邮件的主题行。</td>
</tr>
</tbody>
</table>
<div class="admonition info">
<p class="admonition-title">信息和行为</p>
<ul>
<li>如果 <code>USE_REPORTING_SMTP</code> 设置为 <code>yes</code>，则必须设置 <code>REPORTING_SMTP_EMAILS</code>。</li>
<li>如果 <code>USE_REPORTING_WEBHOOK</code> 设置为 <code>yes</code>，则必须设置 <code>REPORTING_WEBHOOK_URLS</code>。</li>
<li><code>REPORTING_SCHEDULE</code> 接受的值为 <code>daily</code>、<code>weekly</code> 和 <code>monthly</code>。</li>
<li>如果未设置 <code>REPORTING_SMTP_FROM_USER</code> 和 <code>REPORTING_SMTP_FROM_PASSWORD</code>，插件将尝试在没有身份验证的情况下发送电子邮件。</li>
<li>如果未设置 <code>REPORTING_SMTP_FROM_USER</code> 但设置了 <code>REPORTING_SMTP_FROM_PASSWORD</code>，插件将使用 <code>REPORTING_SMTP_FROM_EMAIL</code> 作为用户名。</li>
<li>如果作业失败，插件将在下一次执行中重试发送报告。</li>
</ul>
</div>
<h3 id="zh-advanced-_9">备份和恢复</h3>
<h4 id="zh-advanced-s3-pro">S3 备份 <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style="transform : translateY(3px);"> (PRO)</h4>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>S3 备份工具可以无缝地自动化数据保护，类似于社区备份插件。然而，它的突出之处在于将备份直接安全地存储在 S3 存储桶中。</p>
<p>通过激活此功能，您正在主动保护您的<strong>数据完整性</strong>。将备份<strong>远程</strong>存储可以保护关键信息免受<strong>硬件故障</strong>、<strong>网络攻击</strong>或<strong>自然灾害</strong>等威胁。这确保了<strong>安全</strong>和<strong>可用性</strong>，能够在<strong>意外事件</strong>期间快速恢复，维护<strong>运营连续性</strong>，并确保<strong>高枕无忧</strong>。</p>
<details class="warning">
<summary>给红帽企业 Linux (RHEL) 8.9 用户的信息</summary>
<p>如果您正在使用 <strong>RHEL 8.9</strong> 并计划使用<strong>外部数据库</strong>，您需要安装 <code>mysql-community-client</code> 包以确保 <code>mysqldump</code> 命令可用。您可以通过执行以下命令来安装该包：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="12:2"><input checked="checked" id="zh-advanced-__tabbed_12_1" name="zh-advanced-__tabbed_12" type="radio" /><input id="zh-advanced-__tabbed_12_2" name="zh-advanced-__tabbed_12" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_12_1">MySQL/MariaDB</label><label for="zh-advanced-__tabbed_12_2">PostgreSQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>
<p><strong>安装 MySQL 仓库配置包</strong></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>https://dev.mysql.com/get/mysql80-community-release-el8-9.noarch.rpm
</code></pre></div>
</li>
<li>
<p><strong>启用 MySQL 仓库</strong></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>config-manager<span class="w"> </span>--enable<span class="w"> </span>mysql80-community
</code></pre></div>
</li>
<li>
<p><strong>安装 MySQL 客户端</strong></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>mysql-community-client
</code></pre></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>安装 PostgreSQL 仓库配置包</strong></p>
<div class="highlight"><pre><span></span><code>dnf<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-</span><span class="k">$(</span>uname<span class="w"> </span>-m<span class="k">)</span><span class="s2">/pgdg-redhat-repo-latest.noarch.rpm&quot;</span>
</code></pre></div>
</li>
<li>
<p><strong>安装 PostgreSQL 客户端</strong></p>
<div class="highlight"><pre><span></span><code>dnf<span class="w"> </span>install<span class="w"> </span>postgresql&lt;version&gt;
</code></pre></div>
</li>
</ol>
</div>
</div>
</div>
</details>
<p><strong>功能列表</strong></p>
<ul>
<li>自动将数据备份到 S3 存储桶</li>
<li>灵活的调度选项：每日、每周或每月</li>
<li>轮换管理，用于控制要保留的备份数量</li>
<li>可自定义的备份文件压缩级别</li>
</ul>
<p><strong>设置列表</strong></p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认</th>
<th>上下文</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_BACKUP_S3</code></td>
<td><code>no</code></td>
<td>全局</td>
<td>启用或禁用 S3 备份功能</td>
</tr>
<tr>
<td><code>BACKUP_S3_SCHEDULE</code></td>
<td><code>daily</code></td>
<td>全局</td>
<td>备份频率</td>
</tr>
<tr>
<td><code>BACKUP_S3_ROTATION</code></td>
<td><code>7</code></td>
<td>全局</td>
<td>要保留的备份数量</td>
</tr>
<tr>
<td><code>BACKUP_S3_ENDPOINT</code></td>
<td></td>
<td>全局</td>
<td>S3 端点</td>
</tr>
<tr>
<td><code>BACKUP_S3_BUCKET</code></td>
<td></td>
<td>全局</td>
<td>S3 存储桶</td>
</tr>
<tr>
<td><code>BACKUP_S3_DIR</code></td>
<td></td>
<td>全局</td>
<td>S3 目录</td>
</tr>
<tr>
<td><code>BACKUP_S3_REGION</code></td>
<td></td>
<td>全局</td>
<td>S3 区域</td>
</tr>
<tr>
<td><code>BACKUP_S3_ACCESS_KEY_ID</code></td>
<td></td>
<td>全局</td>
<td>S3 访问密钥 ID</td>
</tr>
<tr>
<td><code>BACKUP_S3_ACCESS_KEY_SECRET</code></td>
<td></td>
<td>全局</td>
<td>S3 访问密钥 Secret</td>
</tr>
<tr>
<td><code>BACKUP_S3_COMP_LEVEL</code></td>
<td><code>6</code></td>
<td>全局</td>
<td>备份 zip 文件的压缩级别</td>
</tr>
</tbody>
</table>
<h5 id="zh-advanced-_10">手动备份</h5>
<p>要手动启动备份，请执行以下命令：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="13:2"><input checked="checked" id="zh-advanced-__tabbed_13_1" name="zh-advanced-__tabbed_13" type="radio" /><input id="zh-advanced-__tabbed_13_2" name="zh-advanced-__tabbed_13" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_13_1">Linux</label><label for="zh-advanced-__tabbed_13_2">Docker</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup_s3<span class="w"> </span>save
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup_s3<span class="w"> </span>save
</code></pre></div>
</div>
</div>
</div>
<p>此命令将创建您的数据库备份，并将其存储在 <code>BACKUP_S3_BUCKET</code> 设置中指定的 S3 存储桶中。</p>
<p>您还可以在执行命令时通过提供 <code>BACKUP_S3_BUCKET</code> 环境变量来为备份指定自定义 S3 存储桶：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="14:2"><input checked="checked" id="zh-advanced-__tabbed_14_1" name="zh-advanced-__tabbed_14" type="radio" /><input id="zh-advanced-__tabbed_14_2" name="zh-advanced-__tabbed_14" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_14_1">Linux</label><label for="zh-advanced-__tabbed_14_2">Docker</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nv">BACKUP_S3_BUCKET</span><span class="o">=</span>your-bucket-name<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup_s3<span class="w"> </span>save
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>-e<span class="w"> </span><span class="nv">BACKUP_S3_BUCKET</span><span class="o">=</span>your-bucket-name<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup_s3<span class="w"> </span>save
</code></pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">MariaDB/MySQL 的特别说明</p>
<p>如果您正在使用 MariaDB/MySQL，在尝试备份数据库时可能会遇到以下错误：</p>
<div class="highlight"><pre><span></span><code>caching_sha2_password<span class="w"> </span>could<span class="w"> </span>not<span class="w"> </span>be<span class="w"> </span>loaded:<span class="w"> </span>Error<span class="w"> </span>loading<span class="w"> </span>shared<span class="w"> </span>library<span class="w"> </span>/usr/lib/mariadb/plugin/caching_sha2_password.so
</code></pre></div>
<p>要解决此问题，您可以执行以下命令将身份验证插件更改为 <code>mysql_native_password</code>：</p>
<div class="highlight"><pre><span></span><code><span class="k">ALTER</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="s1">&#39;yourusername&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span><span class="w"> </span><span class="n">IDENTIFIED</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">mysql_native_password</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;youpassword&#39;</span><span class="p">;</span>
</code></pre></div>
<p>如果您正在使用 Docker 集成，可以将以下命令添加到 <code>docker-compose.yml</code> 文件中，以自动更改身份验证插件：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="15:2"><input checked="checked" id="zh-advanced-__tabbed_15_1" name="zh-advanced-__tabbed_15" type="radio" /><input id="zh-advanced-__tabbed_15_2" name="zh-advanced-__tabbed_15" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_15_1">MariaDB</label><label for="zh-advanced-__tabbed_15_2">MySQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:&lt;version&gt;</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--default-authentication-plugin=mysql_native_password</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql:&lt;version&gt;</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--default-authentication-plugin=mysql_native_password</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
</div>
</div>
</div>
</div>
<h5 id="zh-advanced-_11">手动恢复</h5>
<p>要手动启动恢复，请执行以下命令：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="16:2"><input checked="checked" id="zh-advanced-__tabbed_16_1" name="zh-advanced-__tabbed_16" type="radio" /><input id="zh-advanced-__tabbed_16_2" name="zh-advanced-__tabbed_16" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_16_1">Linux</label><label for="zh-advanced-__tabbed_16_2">Docker</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup_s3<span class="w"> </span>restore
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup_s3<span class="w"> </span>restore
</code></pre></div>
</div>
</div>
</div>
<p>此命令将在 <code>BACKUP_S3_BUCKET</code> 设置中指定的 S3 存储桶中创建您数据库的临时备份，并将您的数据库恢复到存储桶中可用的最新备份。</p>
<p>您还可以在执行命令时通过提供备份文件的路径作为参数来为恢复指定自定义备份文件：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="17:2"><input checked="checked" id="zh-advanced-__tabbed_17_1" name="zh-advanced-__tabbed_17" type="radio" /><input id="zh-advanced-__tabbed_17_2" name="zh-advanced-__tabbed_17" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_17_1">Linux</label><label for="zh-advanced-__tabbed_17_2">Docker</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup_s3<span class="w"> </span>restore<span class="w"> </span>s3_backup_file.zip
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup<span class="w"> </span>restore<span class="w"> </span>s3_backup_file.zip
</code></pre></div>
</div>
</div>
</div>
<div class="admonition example">
<p class="admonition-title">如果失败</p>
<p>如果恢复失败，请不要担心，您可以随时通过再次执行命令将数据库恢复到先前的状态，因为在恢复之前会创建一个备份：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="18:2"><input checked="checked" id="zh-advanced-__tabbed_18_1" name="zh-advanced-__tabbed_18" type="radio" /><input id="zh-advanced-__tabbed_18_2" name="zh-advanced-__tabbed_18" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_18_1">Linux</label><label for="zh-advanced-__tabbed_18_2">Docker</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup_s3<span class="w"> </span>restore
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup_s3<span class="w"> </span>restore
</code></pre></div>
</div>
</div>
</div>
</div>
<h3 id="zh-advanced-pro_2">迁移 <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style="transform : translateY(3px);"> (PRO)</h3>
<p>STREAM 支持 <img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /></p>
<p>迁移插件通过其<strong>用户友好的 Web 界面</strong>，彻底改变了 BunkerWeb 实例之间的配置传输，简化了整个迁移过程。无论您是升级系统、扩展基础设施还是转换环境，此工具都能让您轻松自信地传输<strong>设置、首选项和数据</strong>。告别繁琐的手动流程，迎接<strong>无缝、无忧的迁移体验</strong>。</p>
<p><strong>功能列表</strong></p>
<ul>
<li>
<p><strong>轻松迁移：</strong> 轻松在实例之间传输 BunkerWeb 配置，无需复杂的手动操作。</p>
</li>
<li>
<p><strong>直观的 Web 界面：</strong> 通过为直观操作设计的用户友好 Web 界面，轻松导航迁移过程。</p>
</li>
<li>
<p><strong>跨数据库兼容性：</strong> 在各种数据库平台之间实现无缝迁移，包括 SQLite、MySQL、MariaDB 和 PostgreSQL，确保与您首选的数据库环境兼容。</p>
</li>
</ul>
<h4 id="zh-advanced-_12">创建迁移文件</h4>
<p>要手动创建迁移文件，请执行以下命令：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="19:2"><input checked="checked" id="zh-advanced-__tabbed_19_1" name="zh-advanced-__tabbed_19" type="radio" /><input id="zh-advanced-__tabbed_19_2" name="zh-advanced-__tabbed_19" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_19_1">Linux</label><label for="zh-advanced-__tabbed_19_2">Docker</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>bwcli<span class="w"> </span>plugin<span class="w"> </span>migration<span class="w"> </span>create<span class="w"> </span>/path/to/migration/file
</code></pre></div>
</div>
<div class="tabbed-block">
<ol>
<li>
<p>创建迁移文件：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>migration<span class="w"> </span>create<span class="w"> </span>/path/to/migration/file
</code></pre></div>
</li>
<li>
<p>将迁移文件复制到您的本地计算机：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>cp<span class="w"> </span>&lt;scheduler_container&gt;:/path/to/migration/file<span class="w"> </span>/path/to/migration/file
</code></pre></div>
</li>
</ol>
</div>
</div>
</div>
<p>此命令将创建您的数据库备份，并将其存储在命令中指定的备份目录中。</p>
<div class="admonition note">
<p class="admonition-title">MariaDB/MySQL 的特别说明</p>
<p>如果您正在使用 MariaDB/MySQL，在尝试备份数据库时可能会遇到以下错误：</p>
<div class="highlight"><pre><span></span><code>caching_sha2_password<span class="w"> </span>could<span class="w"> </span>not<span class="w"> </span>be<span class="w"> </span>loaded:<span class="w"> </span>Error<span class="w"> </span>loading<span class="w"> </span>shared<span class="w"> </span>library<span class="w"> </span>/usr/lib/mariadb/plugin/caching_sha2_password.so
</code></pre></div>
<p>要解决此问题，您可以执行以下命令将身份验证插件更改为 <code>mysql_native_password</code>：</p>
<div class="highlight"><pre><span></span><code><span class="k">ALTER</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="s1">&#39;yourusername&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span><span class="w"> </span><span class="n">IDENTIFIED</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">mysql_native_password</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;youpassword&#39;</span><span class="p">;</span>
</code></pre></div>
<p>如果您正在使用 Docker 集成，可以将以下命令添加到 <code>docker-compose.yml</code> 文件中，以自动更改身份验证插件：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="20:2"><input checked="checked" id="zh-advanced-__tabbed_20_1" name="zh-advanced-__tabbed_20" type="radio" /><input id="zh-advanced-__tabbed_20_2" name="zh-advanced-__tabbed_20" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_20_1">MariaDB</label><label for="zh-advanced-__tabbed_20_2">MySQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:&lt;version&gt;</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--default-authentication-plugin=mysql_native_password</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql:&lt;version&gt;</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--default-authentication-plugin=mysql_native_password</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
</div>
</div>
</div>
</div>
<h4 id="zh-advanced-_13">初始化迁移</h4>
<p>要手动初始化迁移，请执行以下命令：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="21:3"><input checked="checked" id="zh-advanced-__tabbed_21_1" name="zh-advanced-__tabbed_21" type="radio" /><input id="zh-advanced-__tabbed_21_2" name="zh-advanced-__tabbed_21" type="radio" /><input id="zh-advanced-__tabbed_21_3" name="zh-advanced-__tabbed_21" type="radio" /><div class="tabbed-labels"><label for="zh-advanced-__tabbed_21_1">Linux</label><label for="zh-advanced-__tabbed_21_2">Docker</label><label for="zh-advanced-__tabbed_21_3">All-in-one</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>bwcli<span class="w"> </span>plugin<span class="w"> </span>migration<span class="w"> </span>migrate<span class="w"> </span>/path/to/migration/file
</code></pre></div>
</div>
<div class="tabbed-block">
<ol>
<li>
<p>将迁移文件复制到容器中：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>cp<span class="w"> </span>/path/to/migration/file<span class="w"> </span>&lt;scheduler_container&gt;:/path/to/migration/file
</code></pre></div>
</li>
<li>
<p>初始化迁移：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>migration<span class="w"> </span>migrate<span class="w"> </span>/path/to/migration/file
</code></pre></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>
<p>将迁移文件复制到容器中：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>cp<span class="w"> </span>/path/to/migration/file<span class="w"> </span>bunkerweb-aio:/path/to/migration/file
</code></pre></div>
</li>
<li>
<p>初始化迁移：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>bunkerweb-aio<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>migration<span class="w"> </span>migrate<span class="w"> </span>/path/to/migration/file
</code></pre></div>
</li>
</ol>
</div>
</div>
</div>
<p>此命令将您的 BunkerWeb 数据无缝迁移，以精确匹配迁移文件中概述的配置。</p>
<h2 id="zh-advanced-anti-ddos-pro">Anti DDoS <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style="transform : translateY(3px);"> (PRO)</h2>
<p>STREAM 支持 <img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /></p>
<p><strong>Anti DDoS</strong> 插件通过实时监控、分析和过滤可疑流量，提供针对分布式拒绝服务 (DDoS) 攻击的高级保护。</p>
<p>通过采用<strong>滑动窗口机制</strong>，该插件在内存中维护一个请求时间戳字典，以检测来自单个 IP 地址的异常流量峰值。根据配置的安全模式，它可以阻止违规连接或记录可疑活动以供进一步审查。</p>
<h4 id="zh-advanced-_14">功能</h4>
<ul>
<li><strong>实时流量分析：</strong> 持续监控传入请求以检测潜在的 DDoS 攻击。</li>
<li><strong>滑动窗口机制：</strong> 在可配置的时间窗口内跟踪最近的请求活动。</li>
<li><strong>可配置的阈值：</strong> 允许您定义每个 IP 的最大可疑请求数。</li>
<li><strong>高级阻止逻辑：</strong> 评估每个 IP 的请求计数和超过阈值的不同 IP 数量。</li>
<li><strong>灵活的安全模式：</strong> 在立即阻止连接或仅检测（记录）模式之间进行选择。</li>
<li><strong>优化的内存数据存储：</strong> 确保高速查找和高效的指标跟踪。</li>
<li><strong>自动清理：</strong> 定期清除过时数据以保持最佳性能。</li>
</ul>
<h4 id="zh-advanced-_15">配置</h4>
<p>使用以下设置自定义插件行为：</p>
<table>
<thead>
<tr>
<th>设置</th>
<th>默认</th>
<th>上下文</th>
<th>多个</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>USE_ANTIDDOS</code></td>
<td><code>no</code></td>
<td>全局</td>
<td>否</td>
<td>启用或禁用 Anti DDoS 保护。设置为 <code>"yes"</code> 以激活插件。</td>
</tr>
<tr>
<td><code>ANTIDDOS_METRICS_DICT_SIZE</code></td>
<td><code>10M</code></td>
<td>全局</td>
<td>否</td>
<td>用于跟踪 DDoS 指标的内存数据存储的大小（例如，<code>10M</code>, <code>500k</code>）。</td>
</tr>
<tr>
<td><code>ANTIDDOS_THRESHOLD</code></td>
<td><code>100</code></td>
<td>全局</td>
<td>否</td>
<td>在定义的时间窗口内，每个 IP 允许的最大可疑请求数。</td>
</tr>
<tr>
<td><code>ANTIDDOS_WINDOW_TIME</code></td>
<td><code>10</code></td>
<td>全局</td>
<td>否</td>
<td>统计可疑请求的时间窗口（秒）。</td>
</tr>
<tr>
<td><code>ANTIDDOS_STATUS_CODES</code></td>
<td><code>429 403 444</code></td>
<td>全局</td>
<td>否</td>
<td>被认为是可疑并用于触发反 DDoS 操作的 HTTP 状态码。</td>
</tr>
<tr>
<td><code>ANTIDDOS_DISTINCT_IP</code></td>
<td><code>5</code></td>
<td>全局</td>
<td>否</td>
<td>在强制执行阻止模式之前，必须超过阈值的最少不同 IP 数量。</td>
</tr>
</tbody>
</table>
<h4 id="zh-advanced-_16">最佳实践</h4>
<ul>
<li><strong>阈值调整：</strong> 根据您的典型流量模式调整 <code>ANTIDDOS_THRESHOLD</code> 和 <code>ANTIDDOS_WINDOW_TIME</code>。</li>
<li><strong>状态码审查：</strong> 定期更新 <code>ANTIDDOS_STATUS_CODES</code> 以捕获新的或不断演变的可疑行为。</li>
<li><strong>监控：</strong> 定期分析日志和指标以微调设置并提高整体保护。</li>
</ul>
<h2 id="zh-advanced-pro_3">用户管理器 <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style="transform : translateY(3px);"> (PRO)</h2>
<p>用户管理插件提供了一个强大的界面，用于管理系统内的用户帐户。</p>
<p>借助此插件，管理员可以轻松创建、更新和禁用用户帐户，管理用户角色，切换双因素身份验证 (2FA)，并查看详细的用户信息，例如上次登录时间戳和帐户状态（活动或非活动）。该插件在设计时考虑了安全性和易用性，简化了常规的用户管理任务，同时确保了合规性和可审计性。</p>
<h4 id="zh-advanced-_17">功能</h4>
<ul>
<li><strong>用户帐户操作：</strong> 支持以 CSV/XSLX 格式导入，轻松创建、编辑和删除用户帐户。</li>
<li><strong>基于角色的访问控制：</strong> 分配和修改用户角色以管理权限和访问级别。</li>
<li><strong>2FA 管理：</strong> 根据管理决策禁用双因素身份验证。</li>
<li><strong>全面的用户洞察：</strong> 监控关键用户数据，包括上次登录时间、帐户创建日期以及活动/非活动状态。</li>
<li><strong>审计日志记录：</strong> 维护所有用户管理操作的审计跟踪，以增强安全性和合规性。</li>
</ul>
<figure>
<p><img align="center" alt="概述" src="../assets/img/user-manager.png" />
  </p>
<figcaption>用户管理器页面</figcaption>
</figure>
<figure>
<p><img align="center" alt="创建用户表单" src="../assets/img/user-manager-create.png" />
  </p>
<figcaption>用户管理器 - 创建用户表单</figcaption>
</figure>
<figure>
<p><img align="center" alt="活动页面" src="../assets/img/user-manager-activities.png" />
  </p>
<figcaption>用户管理器 - 活动页面</figcaption>
</figure>
<h2 id="zh-advanced-pro_4">轻松解决 <img src='../assets/img/pro-icon.svg' alt='crow pro icon' height='24px' width='24px' style="transform : translateY(3px);"> (PRO)</h2>
<p>轻松解决插件让您可以直接从报告页面快速修复误报和重复出现的问题。它将引导式的“解决”操作转化为安全、范围受限的配置更新——无需手动编辑。</p>
<h4 id="zh-advanced-_18">功能</h4>
<ul>
<li>从报告和报告详情中一键操作。</li>
<li>针对 ModSecurity、黑名单和 DNSBL 的上下文感知建议。</li>
<li>生成安全的 ModSecurity 排除规则或更新忽略列表。</li>
<li>在服务或全局范围内应用更改，并进行权限检查。</li>
<li>应用后可选择自动打开相关配置页面。</li>
</ul>
<figure>
<p><img align="center" alt="概述" src="../assets/img/easy-resolve.png" />
  </p>
<figcaption>报告页面 - 带有轻松解决功能</figcaption>
</figure>
<div class="grid grid-2">
<figure>
<p><img alt="ModSecurity 解决" src="../assets/img/easy-resolve-modsecurity.png" width="100%" />
  </p>
<figcaption>ModSecurity 解决</figcaption>
</figure>
<figure>
<p><img alt="DNSBL 解决" src="../assets/img/easy-resolve-dnsbl.png" width="100%" />
  </p>
<figcaption>DNSBL 解决</figcaption>
</figure>
</div>
<div class="grid grid-5">
<figure>
<p><img alt="黑名单解决 - IP" src="../assets/img/easy-resolve-blacklist-ip.png" width="100%" />
  </p>
<figcaption>黑名单 - IP</figcaption>
</figure>
<figure>
<p><img alt="黑名单解决 - User-Agent" src="../assets/img/easy-resolve-blacklist-ua.png" width="100%" />
  </p>
<figcaption>黑名单 - User-Agent</figcaption>
</figure>
<figure>
<p><img alt="黑名单解决 - rDNS" src="../assets/img/easy-resolve-blacklist-rdns.png" width="100%" />
  </p>
<figcaption>黑名单 - rDNS</figcaption>
</figure>
<figure>
<p><img alt="黑名单解决 - ASN" src="../assets/img/easy-resolve-blacklist-asn.png" width="100%" />
  </p>
<figcaption>黑名单 - ASN</figcaption>
</figure>
<figure>
<p><img alt="黑名单解决 - URI" src="../assets/img/easy-resolve-blacklist-uri.png" width="100%" />
  </p>
<figcaption>黑名单 - URI</figcaption>
</figure>
</div></section><section class="print-page" id="zh-web-ui" heading-number="7"><h1 id="zh-web-ui-web-ui">Web UI</h1>
<h2 id="zh-web-ui-_1">概述</h2>
<p align="center">
    <iframe style="display: block;" width="560" height="315" data-src="https://www.youtube-nocookie.com/embed/tGS3pzquEjY" title="BunkerWeb Web UI" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>

<p>“Web UI”是一个 Web 应用程序，帮助您使用用户友好的界面来管理您的 BunkerWeb 实例，而不是仅仅依赖于命令行。</p>
<p>以下是 Web UI 提供的功能列表：</p>
<ul>
<li>全面了解被阻止的攻击</li>
<li>启动、停止、重启和重新加载您的 BunkerWeb 实例</li>
<li>为您的 Web 应用程序添加、编辑和删除设置</li>
<li>为 NGINX 和 ModSecurity 添加、编辑和删除自定义配置</li>
<li>安装和卸载外部插件</li>
<li>浏览缓存的文件</li>
<li>监控作业执行并根据需要重新启动它们</li>
<li>查看日志并搜索模式</li>
</ul>
<h2 id="zh-web-ui-_2">先决条件</h2>
<p>由于 Web UI 是一个 Web 应用程序，推荐的架构是在其前面运行 BunkerWeb 作为反向代理。推荐的安装过程是使用设置向导，它将按照<a href="#zh-quickstart-guide">快速入门指南</a>中的描述一步一步地指导您。</p>
<div class="admonition warning">
<p class="admonition-title">安全注意事项</p>
<p>Web UI 的安全性极其重要。如果未经授权的人员获得了对该应用程序的访问权限，他们不仅能够编辑您的配置，还可能在 BunkerWeb 的上下文中执行代码（例如，通过包含 LUA 代码的自定义配置）。我们强烈建议您遵循最低限度的安全最佳实践，例如：</p>
<ul>
<li>为登录选择一个强密码（<strong>至少 8 个字符，包括 1 个小写字母、1 个大写字母、1 个数字和 1 个特殊字符</strong>）</li>
<li>将 Web UI 放置在一个“难以猜测”的 URI 下</li>
<li>启用双因素身份验证 (2FA)</li>
<li>不要在没有额外限制的情况下将 Web UI 暴露在互联网上</li>
<li>根据您的用例，应用文档的<a href="#zh-advanced-security-tuning">高级用法部分</a>中列出的最佳实践</li>
</ul>
</div>
<h2 id="zh-web-ui-pro">升级到 PRO</h2>
<div class="admonition tip">
<p class="admonition-title">BunkerWeb PRO 免费试用</p>
<p>想要快速试用 BunkerWeb PRO 一个月吗？在 <a href="https://panel.bunkerweb.io/store/bunkerweb-pro?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板</a>下单时使用代码 <code>freetrial</code>，或者点击<a href="https://panel.bunkerweb.io/cart.php?a=add&amp;pid=19&amp;promocode=freetrial&amp;utm_campaign=self&amp;utm_source=doc">这里</a>直接应用促销代码（将在结账时生效）。</p>
</div>
<p>一旦您从 <a href="https://panel.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板</a>获得了您的 PRO 许可证密钥，您可以将其粘贴到 Web UI 的 PRO 页面中。</p>
<figure>
<p><img align="center," alt="PRO 升级" src="../assets/img/pro-ui-upgrade.png" width="700" />
  </p>
<figcaption>从 Web UI 升级到 PRO</figcaption>
</figure>
<div class="admonition warning">
<p class="admonition-title">升级时间</p>
<p>PRO 版本由调度器在后台下载，升级可能需要一些时间。</p>
</div>
<p>当您的 BunkerWeb 实例升级到 PRO 版本后，您将看到您的许可证到期日期和您可以保护的最大服务数量。</p>
<figure>
<p><img align="center," alt="PRO 升级" src="../assets/img/ui-pro.png" width="700" />
  </p>
<figcaption>PRO 许可证信息</figcaption>
</figure>
<h2 id="zh-web-ui-_3">访问日志</h2>
<p>从 <code>1.6</code> 版本开始，访问日志的方法发生了变化。此更新特别影响基于容器的集成：Web UI 现在将从 <code>/var/log/bunkerweb</code> 目录读取日志文件。</p>
<p>为了使日志可以从 Web UI 访问，我们建议您使用一个 syslog 服务器，例如 <code>syslog-ng</code>，来读取日志并在 <code>/var/log/bunkerweb</code> 目录中创建相应的文件。</p>
<div class="admonition warning">
<p class="admonition-title">为日志使用本地文件夹</p>
<p>出于安全原因，Web UI 在容器内以<strong>UID 101 和 GID 101 的非特权用户</strong>身份运行：万一漏洞被利用，攻击者将不会拥有完全的 root (UID/GID 0) 权限。</p>
<p>但是，有一个缺点：如果您为日志使用<strong>本地文件夹</strong>，您必须<strong>设置正确的权限</strong>，以便非特权用户可以读取日志文件。例如：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>bw-logs<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chown<span class="w"> </span>root:101<span class="w"> </span>bw-logs<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-logs
</code></pre></div>
<p>或者，如果文件夹已经存在：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span>root:101<span class="w"> </span>bw-logs<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span>-R<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-logs
</code></pre></div>
<p>如果您正在使用<a href="https://docs.docker.com/engine/security/rootless">无根模式的 Docker</a> 或 <a href="https://podman.io/">podman</a>，容器中的 UID 和 GID 将映射到主机上不同的 UID 和 GID。您首先需要检查您的初始 subuid 和 subgid：</p>
<div class="highlight"><pre><span></span><code>grep<span class="w"> </span>^<span class="k">$(</span>whoami<span class="k">)</span>:<span class="w"> </span>/etc/subuid<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
grep<span class="w"> </span>^<span class="k">$(</span>whoami<span class="k">)</span>:<span class="w"> </span>/etc/subgid
</code></pre></div>
<p>例如，如果您的值为 <strong>100000</strong>，则映射的 UID/GID 将为 <strong>100100</strong> (100000 + 100)：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>bw-logs<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>chgrp<span class="w"> </span><span class="m">100100</span><span class="w"> </span>bw-logs<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-logs
</code></pre></div>
<p>或者如果文件夹已经存在：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>chgrp<span class="w"> </span>-R<span class="w"> </span><span class="m">100100</span><span class="w"> </span>bw-logs<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>chmod<span class="w"> </span>-R<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-logs
</code></pre></div>
</div>
<h3 id="zh-web-ui-compose">Compose 样板文件</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="zh-web-ui-__tabbed_1_1" name="zh-web-ui-__tabbed_1" type="radio" /><input id="zh-web-ui-__tabbed_1_2" name="zh-web-ui-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="zh-web-ui-__tabbed_1_1">Docker</label><label for="zh-web-ui-__tabbed_1_2">Docker Autoconf</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>要将日志正确转发到 Docker 集成的 <code>/var/log/bunkerweb</code> 目录，您需要使用 <code>syslog-ng</code> 将日志流式传输到文件中。这是一个如何执行此操作的示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-env</span>
<span class="w">  </span><span class="c1"># 我们锚定环境变量以避免重复</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/24</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">  </span><span class="c1"># 可选的 API 令牌，用于保护 API 访问</span>
<span class="w">  </span><span class="nt">API_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w"> </span><span class="c1"># QUIC</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">logging</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syslog</span>
<span class="w">      </span><span class="nt">options</span><span class="p">:</span>
<span class="w">        </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span><span class="w"> </span><span class="c1"># 这将是 syslog-ng 用来创建日志文件的标签</span>
<span class="w">        </span><span class="nt">syslog-address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;udp://10.20.30.254:514&quot;</span><span class="w"> </span><span class="c1"># 这是 syslog-ng 容器的地址</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span><span class="w"> </span><span class="c1"># 确保设置正确的实例名称</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;www.example.com&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">      </span><span class="nt">SERVE_FILES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
<span class="w">      </span><span class="nt">DISABLE_DEFAULT_SERVER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">USE_CLIENT_CACHE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">USE_GZIP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">www.example.com_USE_TEMPLATE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ui&quot;</span>
<span class="w">      </span><span class="nt">www.example.com_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">www.example.com_REVERSE_PROXY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/changeme&quot;</span><span class="w"> </span><span class="c1"># 将其更改为一个难以猜测的 URI</span>
<span class="w">      </span><span class="nt">www.example.com_REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://bw-ui:7000&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">logging</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syslog</span>
<span class="w">      </span><span class="nt">options</span><span class="p">:</span>
<span class="w">        </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bw-scheduler&quot;</span><span class="w"> </span><span class="c1"># 这将是 syslog-ng 用来创建日志文件的标签</span>
<span class="w">        </span><span class="nt">syslog-address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;udp://10.20.30.254:514&quot;</span><span class="w"> </span><span class="c1"># 这是 syslog-ng 容器的地址</span>

<span class="w">  </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">      </span><span class="nt">ADMIN_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span>
<span class="w">      </span><span class="nt">ADMIN_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为管理员用户设置一个更强的密码</span>
<span class="w">      </span><span class="nt">TOTP_ENCRYPTION_KEYS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mysecret&quot;</span><span class="w"> </span><span class="c1"># 记得设置一个更强的密钥（请参阅先决条件部分）</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-logs:/var/log/bunkerweb</span><span class="w"> </span><span class="c1"># 这是用于存储日志的卷</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">logging</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syslog</span>
<span class="w">      </span><span class="nt">options</span><span class="p">:</span>
<span class="w">        </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bw-ui&quot;</span><span class="w"> </span><span class="c1"># 这将是 syslog-ng 用来创建日志文件的标签</span>
<span class="w">        </span><span class="nt">syslog-address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;udp://10.20.30.254:514&quot;</span><span class="w"> </span><span class="c1"># 这是 syslog-ng 容器的地址</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-syslog</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">balabit/syslog-ng:4.9.0</span>
<span class="w">    </span><span class="nt">cap_add</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_BIND_SERVICE</span><span class="w">  </span><span class="c1"># 绑定到低端口</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_BROADCAST</span><span class="w">  </span><span class="c1"># 发送广播</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_RAW</span><span class="w">  </span><span class="c1"># 使用原始套接字</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DAC_READ_SEARCH</span><span class="w">  </span><span class="c1"># 绕过权限读取文件</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DAC_OVERRIDE</span><span class="w">  </span><span class="c1"># 覆盖文件权限</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CHOWN</span><span class="w">  </span><span class="c1"># 更改所有权</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SYSLOG</span><span class="w">  </span><span class="c1"># 写入系统日志</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-logs:/var/log/bunkerweb</span><span class="w"> </span><span class="c1"># 这是用于存储日志的卷</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./syslog-ng.conf:/etc/syslog-ng/syslog-ng.conf</span><span class="w"> </span><span class="c1"># 这是 syslog-ng 配置文件</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">        </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.254</span><span class="w"> </span><span class="c1"># 确保设置正确的 IP 地址</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-logs</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>要将日志正确转发到 Autoconf 集成的 <code>/var/log/bunkerweb</code> 目录，您需要使用 <code>syslog-ng</code> 将日志流式传输到文件中。这是一个如何执行此操作的示例：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-ui-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-ui-env</span>
<span class="w">  </span><span class="c1"># 我们锚定环境变量以避免重复</span>
<span class="w">  </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">  </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w"> </span><span class="c1"># QUIC</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/24</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">logging</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syslog</span>
<span class="w">      </span><span class="nt">options</span><span class="p">:</span>
<span class="w">        </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span><span class="w"> </span><span class="c1"># 这将是 syslog-ng 用来创建日志文件的标签</span>
<span class="w">        </span><span class="nt">syslog-address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;udp://10.20.30.254:514&quot;</span><span class="w"> </span><span class="c1"># 这是 syslog-ng 容器的地址</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-ui-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 我们不需要在这里指定 BunkerWeb 实例，因为它们由 autoconf 服务自动检测</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 服务器名称将由服务标签填充</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="c1"># autoconf / ui 的强制设置</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/24</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">logging</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syslog</span>
<span class="w">      </span><span class="nt">options</span><span class="p">:</span>
<span class="w">        </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bw-scheduler&quot;</span><span class="w"> </span><span class="c1"># 这将是 syslog-ng 用来创建日志文件的标签</span>
<span class="w">        </span><span class="nt">syslog-address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;udp://10.20.30.254:514&quot;</span><span class="w"> </span><span class="c1"># 这是 syslog-ng 容器的地址</span>

<span class="w">  </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:testing</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-ui-env</span>
<span class="w">      </span><span class="nt">DOCKER_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tcp://bw-docker:2375&quot;</span><span class="w"> </span><span class="c1"># 这是 Docker 套接字地址</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">logging</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syslog</span>
<span class="w">      </span><span class="nt">options</span><span class="p">:</span>
<span class="w">        </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bw-autoconf&quot;</span><span class="w"> </span><span class="c1"># 这将是 syslog-ng 用来创建日志文件的标签</span>
<span class="w">        </span><span class="nt">syslog-address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;udp://10.20.30.254:514&quot;</span><span class="w"> </span><span class="c1"># 这是 syslog-ng 容器的地址</span>

<span class="w">  </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-ui-env</span>
<span class="w">      </span><span class="nt">ADMIN_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span>
<span class="w">      </span><span class="nt">ADMIN_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为管理员用户设置一个更强的密码</span>
<span class="w">      </span><span class="nt">TOTP_ENCRYPTION_KEYS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mysecret&quot;</span><span class="w"> </span><span class="c1"># 记得设置一个更强的密钥（请参阅先决条件部分）</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-logs:/var/log/bunkerweb</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=www.example.com&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_TEMPLATE=ui&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_REVERSE_PROXY=yes&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_URL=/changeme&quot;</span><span class="w"> </span><span class="c1"># 将其更改为一个难以猜测的 URI</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_HOST=http://bw-ui:7000&quot;</span>
<span class="w">    </span><span class="nt">logging</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syslog</span>
<span class="w">      </span><span class="nt">options</span><span class="p">:</span>
<span class="w">        </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bw-ui&quot;</span><span class="w"> </span><span class="c1"># 这将是 syslog-ng 用来创建日志文件的标签</span>
<span class="w">        </span><span class="nt">syslog-address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;udp://10.20.30.254:514&quot;</span><span class="w"> </span><span class="c1"># 这是 syslog-ng 容器的地址</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tecnativa/docker-socket-proxy:nightly</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CONTAINERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warning&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock:ro</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;unless-stopped&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>

<span class="w">  </span><span class="nt">bw-syslog</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">balabit/syslog-ng:4.9.0</span>
<span class="w">    </span><span class="nt">cap_add</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_BIND_SERVICE</span><span class="w">  </span><span class="c1"># 绑定到低端口</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_BROADCAST</span><span class="w">  </span><span class="c1"># 发送广播</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NET_RAW</span><span class="w">  </span><span class="c1"># 使用原始套接字</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DAC_READ_SEARCH</span><span class="w">  </span><span class="c1"># 绕过权限读取文件</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DAC_OVERRIDE</span><span class="w">  </span><span class="c1"># 覆盖文件权限</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CHOWN</span><span class="w">  </span><span class="c1"># 更改所有权</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SYSLOG</span><span class="w">  </span><span class="c1"># 写入系统日志</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-logs:/var/log/bunkerweb</span><span class="w"> </span><span class="c1"># 这是用于存储日志的卷</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./syslog-ng.conf:/etc/syslog-ng/syslog-ng.conf</span><span class="w"> </span><span class="c1"># 这是 syslog-ng 配置文件</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">        </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.254</span><span class="w"> </span><span class="c1"># 确保设置正确的 IP 地址</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-logs</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="zh-web-ui-syslog-ng">Syslog-ng 配置</h3>
<p>这是一个 <code>syslog-ng.conf</code> 文件的示例，您可以使用它将日志转发到文件中：</p>
<div class="highlight"><pre><span></span><code>@version: 4.8

# 用于从 Docker 容器接收日志的源配置
source s_net {
  udp(
    ip(&quot;0.0.0.0&quot;)
  );
};

# 用于格式化日志消息的模板
template t_imp {
  template(&quot;$MSG\n&quot;);
  template_escape(no);
};

# 用于将日志写入动态命名文件的目标配置
destination d_dyna_file {
  file(
    &quot;/var/log/bunkerweb/${PROGRAM}.log&quot;
    template(t_imp)
    owner(&quot;101&quot;)
    group(&quot;101&quot;)
    dir_owner(&quot;root&quot;)
    dir_group(&quot;101&quot;)
    perm(0440)
    dir_perm(0770)
    create_dirs(yes)
  );
};

# 将日志定向到动态命名文件的日志路径
log {
  source(s_net);
  destination(d_dyna_file);
};
</code></pre></div>
<h2 id="zh-web-ui-_4">帐户管理</h2>
<p>您可以通过点击右上角的个人资料图片来访问帐户管理页面：</p>
<figure>
<p><img align="center," alt="概述" src="../assets/img/manage-account.png" width="400" />
  </p>
<figcaption>从右上角访问帐户页面</figcaption>
</figure>
<h3 id="zh-web-ui-_5">用户名/密码</h3>
<div class="admonition warning">
<p class="admonition-title">忘记密码/用户名</p>
<p>如果您忘记了 UI 凭据，您可以按照<a href="#zh-troubleshooting-web-ui">故障排除部分中描述的步骤</a>从 CLI 重置它们。</p>
</div>
<p>您可以通过填写<strong>安全</strong>选项卡中的专用表单来更新您的用户名或密码。出于安全原因，即使您已连接，也需要输入您当前的密码。</p>
<p>请注意，当您的用户名或密码更新后，您将从 Web UI 注销，以便再次登录。</p>
<figure>
<p><img align="center" alt="概述" src="../assets/img/profile-username-password.png" />
  </p>
<figcaption>用户名/密码表单</figcaption>
</figure>
<h3 id="zh-web-ui-_6">双因素认证</h3>
<div class="admonition tip">
<p class="admonition-title">强制性加密密钥</p>
<p>当启用 2FA 时，您必须提供至少一个加密密钥。此密钥将用于加密您的 TOTP 密钥。</p>
<p>生成有效密钥的推荐方法是使用 <code>passlib</code> 包：</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from passlib import totp; print(totp.generate_secret())&quot;</span>
</code></pre></div>
<p>在 Web UI 的 <code>TOTP_ENCRYPTION_KEYS</code> 环境变量中设置生成的密钥。您还可以设置多个以空格分隔的密钥或一个字典（为了向后兼容）。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">丢失密钥</p>
<p>如果您丢失了您的密钥，有两个可用的选项：</p>
<ul>
<li>您可以使用启用 2FA 时提供的恢复码之一来恢复您的帐户（一个恢复码只能使用一次）。</li>
<li>您可以按照<a href="#zh-troubleshooting-web-ui">故障排除部分中描述的步骤</a>从 CLI 禁用 2FA。</li>
</ul>
</div>
<p>您可以通过为您的帐户添加<strong>双因素身份验证 (2FA)</strong> 来增强您的登录安全性。这样做之后，除了您的密码之外，还需要一个额外的代码。</p>
<p>Web UI 使用<a href="https://en.wikipedia.org/wiki/Time-based_one-time_password">基于时间的一次性密码 (TOTP)</a> 作为 2FA 实现：使用<strong>密钥</strong>，该算法将生成<strong>仅在短时间内有效的一次性密码</strong>。</p>
<p>任何 TOTP 客户端，例如 Google Authenticator、Authy、FreeOTP 等，都可以用来存储密钥并生成代码。请注意，一旦启用 TOTP，<strong>您将无法从 Web UI 中检索它</strong>。</p>
<p>从 Web UI 启用 TOTP 功能需要以下步骤：</p>
<ul>
<li>将密钥复制或使用二维码扫描到您的身份验证器应用程序中</li>
<li>在 2FA 输入框中输入当前的 TOTP 代码</li>
<li>输入您当前的密码</li>
</ul>
<div class="admonition info">
<p class="admonition-title">密钥刷新</p>
<p>每次您访问页面或提交表单时都会<strong>生成一个新的密钥</strong>。如果出现问题（例如：TOTP 代码过期），您需要将新的密钥复制到您的身份验证器应用程序中，直到成功启用 2FA。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">恢复码</p>
<p>当您启用 2FA 时，您将获得 <strong>5 个恢复码</strong>。如果您丢失了您的 TOTP 密钥，这些代码可用于恢复您的帐户。每个代码只能使用一次。<strong>这些代码只会显示一次，因此请务必将它们存储在安全的地方</strong>。</p>
<p>如果您丢失了您的恢复码，<strong>您可以通过帐户管理页面的 TOTP 部分刷新它们</strong>。请注意，旧的恢复码将失效。</p>
</div>
<p>您可以在<strong>安全</strong>选项卡中启用或禁用 2FA，并刷新恢复码：</p>
<figure>
<p><img align="center" alt="概述" src="../assets/img/profile-totp.png" />
  </p>
<figcaption>TOTP 启用/禁用/刷新恢复码表单</figcaption>
</figure>
<p>成功登录/密码组合后，您将被提示输入您的 TOTP 代码：</p>
<figure>
<p><img align="center," alt="概述" src="../assets/img/profile-2fa.png" width="400" />
  </p>
<figcaption>登录页面上的 2FA</figcaption>
</figure>
<h3 id="zh-web-ui-_7">当前会话</h3>
<p>在<strong>会话</strong>选项卡中，您将能够列出和撤销当前会话：</p>
<figure>
<p><img align="center" alt="概述" src="../assets/img/sessions.png" />
  </p>
<figcaption>管理会话</figcaption>
</figure>
<h2 id="zh-web-ui-_8">高级安装</h2>
<p>Web UI 可以不通过设置向导过程进行部署和配置：配置是通过环境变量完成的，这些变量可以直接添加到容器中，或者在 Linux 集成的情况下添加到 <code>/etc/bunkerweb/ui.env</code> 文件中。</p>
<div class="admonition tip">
<p class="admonition-title">Web UI 特定环境变量</p>
<p>Web UI 使用以下环境变量：</p>
<ul>
<li><code>OVERRIDE_ADMIN_CREDS</code>：将其设置为 <code>yes</code> 以启用覆盖，即使管理员凭据已设置（默认为 <code>no</code>）。</li>
<li><code>ADMIN_USERNAME</code>：访问 Web UI 的用户名。</li>
<li><code>ADMIN_PASSWORD</code>：访问 Web UI 的密码。</li>
<li><code>FLASK_SECRET</code>：用于加密会话 cookie 的密钥（如果未设置，将生成一个随机密钥）。</li>
<li><code>TOTP_ENCRYPTION_KEYS</code> (或 <code>TOTP_SECRETS</code>)：以空格分隔的 TOTP 加密密钥列表或一个字典（例如：<code>{"1": "mysecretkey"}</code> 或 <code>mysecretkey</code> 或 <code>mysecretkey mysecretkey1</code>）。<strong>如果您想使用 2FA，我们强烈建议您设置此变量，因为它将用于加密 TOTP 密钥</strong>（如果未设置，将生成一个随机数量的密钥）。有关更多信息，请查看 <a href="https://passlib.readthedocs.io/en/stable/narr/totp-tutorial.html#application-secrets">passlib 文档</a>。</li>
<li><code>UI_LISTEN_ADDR</code> (首选)：Web UI 将监听的地址（<strong>Docker 镜像</strong>中默认为 <code>0.0.0.0</code>，<strong>Linux 安装</strong>中默认为 <code>127.0.0.1</code>）。如果未设置，则回退到 <code>LISTEN_ADDR</code>。</li>
<li><code>UI_LISTEN_PORT</code> (首选)：Web UI 将监听的端口（默认为 <code>7000</code>）。如果未设置，则回退到 <code>LISTEN_PORT</code>。</li>
<li><code>MAX_WORKERS</code>：Web UI 使用的工作进程数（默认为 CPU 数量）。</li>
<li><code>MAX_THREADS</code>：Web UI 使用的线程数（默认为 <code>MAX_WORKERS</code> * 2）。</li>
<li><code>FORWARDED_ALLOW_IPS</code>：允许在 <code>X-Forwarded-For</code> 标头中使用的 IP 地址或网络列表（<strong>Docker 镜像</strong>中默认为 <code>*</code>，<strong>Linux 安装</strong>中默认为 <code>127.0.0.1</code>）。</li>
<li><code>CHECK_PRIVATE_IP</code>：将其设置为 <code>yes</code>，以便在会话期间 IP 地址发生更改但位于私有网络中的用户不会断开连接（默认为 <code>yes</code>）。（非私有 IP 地址总是会被检查）。</li>
<li><code>ENABLE_HEALTHCHECK</code>：将其设置为 <code>yes</code> 以启用 <code>/healthcheck</code> 端点，该端点返回一个包含状态信息的简单 JSON 响应（默认为 <code>no</code>）。</li>
</ul>
<p>Web UI 将使用这些变量来验证您的身份并处理 2FA 功能。</p>
</div>
<div class="admonition example">
<p class="admonition-title">生成推荐的密钥</p>
<p>要生成一个有效的 <strong>ADMIN_PASSWORD</strong>，我们建议您<strong>使用密码管理器</strong>或<strong>密码生成器</strong>。</p>
<p>您可以使用以下命令生成一个有效的 <strong>FLASK_SECRET</strong>：</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import secrets; print(secrets.token_hex(64))&quot;</span>
</code></pre></div>
<p>您可以使用以下命令生成有效的以空格分隔的 <strong>TOTP_ENCRYPTION_KEYS</strong>（您将需要 <code>passlib</code> 包）：</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from passlib import totp; print(totp.generate_secret())&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="2:5"><input checked="checked" id="zh-web-ui-__tabbed_2_1" name="zh-web-ui-__tabbed_2" type="radio" /><input id="zh-web-ui-__tabbed_2_2" name="zh-web-ui-__tabbed_2" type="radio" /><input id="zh-web-ui-__tabbed_2_3" name="zh-web-ui-__tabbed_2" type="radio" /><input id="zh-web-ui-__tabbed_2_4" name="zh-web-ui-__tabbed_2" type="radio" /><input id="zh-web-ui-__tabbed_2_5" name="zh-web-ui-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="zh-web-ui-__tabbed_2_1">Linux</label><label for="zh-web-ui-__tabbed_2_2">Docker</label><label for="zh-web-ui-__tabbed_2_3">Docker autoconf</label><label for="zh-web-ui-__tabbed_2_4">Kubernetes</label><label for="zh-web-ui-__tabbed_2_5">Swarm</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>使用<a href="#zh-integrations-linux">Linux 集成</a>安装 Web UI 非常简单，因为它与 BunkerWeb 一起安装。</p>
<p>Web UI 作为名为 <code>bunkerweb-ui</code> 的 systemd 服务提供，请确保它已启用：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>bunkerweb-ui<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>bunkerweb-ui
</code></pre></div>
<p>位于 <code>/etc/bunkerweb/ui.env</code> 的专用环境文件用于配置 Web UI：</p>
<div class="highlight"><pre><span></span><code>ADMIN_USERNAME=changeme
ADMIN_PASSWORD=changeme
TOTP_ENCRYPTION_KEYS=mysecret
</code></pre></div>
<p>将 <code>changeme</code> 数据替换为您自己的值。</p>
<p>记得为 <code>TOTP_ENCRYPTION_KEYS</code> 设置一个更强的密钥。</p>
<p>每次编辑 <code>/etc/bunkerweb/ui.env</code> 文件后，您都需要重启该服务：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>restart<span class="w"> </span>bunkerweb-ui
</code></pre></div>
<p>通过 BunkerWeb 访问 Web UI 是一个经典的<a href="#zh-quickstart-guide">反向代理设置</a>。请注意，Web UI 在 <code>7000</code> 端口上监听，并且只在环回接口上。</p>
<p>这是您可以使用的 <code>/etc/bunkerweb/variables.env</code> 样板：</p>
<div class="highlight"><pre><span></span><code>HTTP_PORT=80
HTTPS_PORT=443
DNS_RESOLVERS=9.9.9.9 8.8.8.8 8.8.4.4
API_LISTEN_IP=127.0.0.1
SERVER_NAME=www.example.com
MULTISITE=yes
www.example.com_USE_TEMPLATE=ui
www.example.com_USE_REVERSE_PROXY=yes
www.example.com_REVERSE_PROXY_URL=/changeme
www.example.com_REVERSE_PROXY_HOST=http://127.0.0.1:7000
</code></pre></div>
<p>不要忘记重新加载 <code>bunkerweb</code> 服务：</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>reload<span class="w"> </span>bunkerweb
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Web UI 可以使用一个专用的容器来部署，该容器可在 <a href="https://hub.docker.com/r/bunkerity/bunkerweb-ui">Docker Hub</a> 上找到：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>pull<span class="w"> </span>bunkerity/bunkerweb-ui
</code></pre></div>
<p>或者，您也可以自己构建它：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/bunkerity/bunkerweb.git<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">cd</span><span class="w"> </span>bunkerweb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>my-bunkerweb-ui<span class="w"> </span>-f<span class="w"> </span>src/ui/Dockerfile<span class="w"> </span>.
</code></pre></div>
<p>通过 BunkerWeb 访问 Web UI 是一个经典的反向代理设置](quickstart-guide.md)。我们建议您使用一个专用网络（例如也由调度器使用的 <code>bw-universe</code>）连接 BunkerWeb 和 Web UI，这样它就不会与您的 Web 服务在同一个网络上，出于明显的安全原因。请注意，Web UI 容器在 <code>7000</code> 端口上监听。</p>
<div class="admonition info">
<p class="admonition-title">数据库后端</p>
<p>如果您想要一个除 MariaDB 之外的数据库后端，请参阅仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/vtesting/misc/integrations">misc/integrations 文件夹</a>中的 docker-compose 文件。</p>
</div>
<p>这是您可以使用的 docker-compose 样板（不要忘记编辑 <code>changeme</code> 数据）：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-ui-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;ui-env</span>
<span class="w">  </span><span class="c1"># 我们锚定环境变量以避免重复</span>
<span class="w">  </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w"> </span><span class="c1"># 用于 QUIC / HTTP3 支持</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span><span class="w"> </span><span class="c1"># 确保设置正确的 IP 范围，以便调度器可以将配置发送到实例</span>
<span class="w">      </span><span class="nt">API_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 如果使用，镜像 API_TOKEN</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*ui-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span><span class="w"> </span><span class="c1"># 确保设置正确的实例名称</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;www.example.com&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span><span class="w"> </span><span class="c1"># 我们从 bunkerweb 服务镜像 API_WHITELIST_IP</span>
<span class="w">      </span><span class="nt">API_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># 如果使用，镜像 API_TOKEN</span>
<span class="w">      </span><span class="nt">SERVE_FILES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>
<span class="w">      </span><span class="nt">DISABLE_DEFAULT_SERVER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">USE_CLIENT_CACHE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">USE_GZIP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">www.example.com_USE_TEMPLATE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ui&quot;</span>
<span class="w">      </span><span class="nt">www.example.com_USE_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">www.example.com_REVERSE_PROXY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/changeme&quot;</span><span class="w"> </span><span class="c1"># 记得设置一个更强的 URI</span>
<span class="w">      </span><span class="nt">www.example.com_REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://bw-ui:7000&quot;</span><span class="w"> </span><span class="c1"># Web UI 容器默认在 7000 端口监听</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*ui-env</span>
<span class="w">      </span><span class="nt">ADMIN_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span>
<span class="w">      </span><span class="nt">ADMIN_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为 changeme 用户设置一个更强的密码</span>
<span class="w">      </span><span class="nt">TOTP_ENCRYPTION_KEYS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mysecret&quot;</span><span class="w"> </span><span class="c1"># 记得设置一个更强的密钥（请参阅先决条件部分）</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Web UI 可以使用一个专用的容器来部署，该容器可在 <a href="https://hub.docker.com/r/bunkerity/bunkerweb-ui">Docker Hub</a> 上找到：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>pull<span class="w"> </span>bunkerity/bunkerweb-ui
</code></pre></div>
<p>或者，您也可以自己构建它：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/bunkerity/bunkerweb.git<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">cd</span><span class="w"> </span>bunkerweb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>my-bunkerweb-ui<span class="w"> </span>-f<span class="w"> </span>src/ui/Dockerfile<span class="w"> </span>.
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">环境变量</p>
<p>请阅读<a href="#zh-web-ui-prerequisites">先决条件</a>部分，查看所有可以设置来自定义 Web UI 的环境变量。</p>
</div>
<p>通过 BunkerWeb 访问 Web UI 是一个经典的反向代理设置](quickstart-guide.md)。我们建议您使用一个专用网络（例如也由调度器和 autoconf 使用的 <code>bw-universe</code>）连接 BunkerWeb 和 Web UI，这样它就不会与您的 Web 服务在同一个网络上，出于明显的安全原因。请注意，Web UI 容器在 <code>7000</code> 端口上监听。</p>
<div class="admonition info">
<p class="admonition-title">数据库后端</p>
<p>如果您想要一个除 MariaDB 之外的数据库后端，请参阅仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/vtesting/misc/integrations">misc/integrations 文件夹</a>中的 docker-compose 文件。</p>
</div>
<p>这是您可以使用的 docker-compose 样板（不要忘记编辑 <code>changeme</code> 数据）：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-ui-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;ui-env</span>
<span class="w">  </span><span class="c1"># 我们锚定环境变量以避免重复</span>
<span class="w">  </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">  </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w"> </span><span class="c1"># 用于 QUIC / HTTP3 支持</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.INSTANCE=yes&quot;</span><span class="w"> </span><span class="c1"># 我们设置实例标签以允许 autoconf 检测实例</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*ui-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:testing</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*ui-env</span>
<span class="w">      </span><span class="nt">DOCKER_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tcp://bw-docker:2375&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tecnativa/docker-socket-proxy:nightly</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock:ro</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CONTAINERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warning&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*ui-env</span>
<span class="w">      </span><span class="nt">ADMIN_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span>
<span class="w">      </span><span class="nt">ADMIN_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为 changeme 用户设置一个更强的密码</span>
<span class="w">      </span><span class="nt">TOTP_ENCRYPTION_KEYS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mysecret&quot;</span><span class="w"> </span><span class="c1"># 记得设置一个更强的密钥（请参阅先决条件部分）</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=www.example.com&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_TEMPLATE=ui&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_REVERSE_PROXY=yes&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_URL=/changeme&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_HOST=http://bw-ui:7000&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Web UI 可以使用一个专用的容器来部署，该容器可在 <a href="https://hub.docker.com/r/bunkerity/bunkerweb-ui">Docker Hub</a> 上找到，您可以将其作为标准的 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a> 进行部署。</p>
<p>通过 BunkerWeb 访问 Web UI 是一个经典的反向代理设置](quickstart-guide.md)。本文档不涉及 Web UI 和 Web 服务之间的网络分段。请注意，Web UI 容器在 <code>7000</code> 端口上监听。</p>
<div class="admonition info">
<p class="admonition-title">数据库后端</p>
<p>如果您想要一个除 MariaDB 之外的数据库后端，请参阅仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/vtesting/misc/integrations">misc/integrations 文件夹</a>中的 yaml 文件。</p>
</div>
<p>这是您可以使用的 values.yaml 文件的相应部分：</p>
<div class="highlight"><pre><span></span><code><span class="nt">settings</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 使用一个名为 bunkerweb 的现有 secret，其中包含以下值：</span>
<span class="w">  </span><span class="c1"># - admin-username</span>
<span class="w">  </span><span class="c1"># - admin-password</span>
<span class="w">  </span><span class="c1"># - flask-secret</span>
<span class="w">  </span><span class="c1"># - totp-secrets</span>
<span class="w">  </span><span class="nt">existingSecret</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;secret-bunkerweb&quot;</span>
<span class="nt">ui</span><span class="p">:</span>
<span class="w">  </span><span class="nt">wizard</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">ingress</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">serverName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;www.example.com&quot;</span>
<span class="w">    </span><span class="nt">serverPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/admin&quot;</span>
<span class="w">  </span><span class="nt">overrideAdminCreds</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
<p><strong>更多信息可以在 <a href="#zh-integrations-swarm">Swarm 集成文档</a>中找到。</strong></p>
</div>
<p>Web UI 可以使用一个专用的容器来部署，该容器可在 <a href="https://hub.docker.com/r/bunkerity/bunkerweb-ui">Docker Hub</a> 上找到：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>pull<span class="w"> </span>bunkerity/bunkerweb-ui
</code></pre></div>
<p>或者，您也可以自己构建它：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/bunkerity/bunkerweb.git<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">cd</span><span class="w"> </span>bunkerweb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>my-bunkerweb-ui<span class="w"> </span>-f<span class="w"> </span>src/ui/Dockerfile<span class="w"> </span>.
</code></pre></div>
<p>通过 BunkerWeb 访问 Web UI 是一个经典的反向代理设置](quickstart-guide.md)。我们建议您使用一个专用网络（例如也由调度器和 autoconf 使用的 <code>bw-universe</code>）连接 BunkerWeb 和 Web UI，这样它就不会与您的 Web 服务在同一个网络上，出于明显的安全原因。请注意，Web UI 容器在 <code>7000</code> 端口上监听。</p>
<div class="admonition info">
<p class="admonition-title">数据库后端</p>
<p>如果您想要一个除 MariaDB 之外的数据库后端，请参阅仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/vtesting/misc/integrations">misc/integrations 文件夹</a>中的堆栈文件。</p>
</div>
<p>这是您可以使用的堆栈样板（不要忘记编辑 <code>changeme</code> 数据）：</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-ui-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;ui-env</span>
<span class="w">  </span><span class="c1"># 我们锚定环境变量以避免重复</span>
<span class="w">  </span><span class="nt">SWARM_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">  </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">published</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span>
<span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">udp</span><span class="w"> </span><span class="c1"># 用于 QUIC / HTTP3 支持</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">SWARM_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">global</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">worker&quot;</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.INSTANCE=yes&quot;</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*ui-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">USE_REDIS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bw-redis&quot;</span>
<span class="w">      </span><span class="nt">UI_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://bw-ui:7000&quot;</span><span class="w"> </span><span class="c1"># 如果需要，请更改它</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span><span class="w"> </span><span class="c1"># 用于持久化缓存和备份等其他数据</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*ui-env</span>
<span class="w">      </span><span class="nt">DOCKER_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tcp://bw-docker:2375&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tecnativa/docker-socket-proxy:nightly</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock:ro</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CONFIGS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">CONTAINERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">SERVICES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">SWARM</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">TASKS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warning&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;node.role</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">manager&quot;</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 我们设置了最大允许的数据包大小以避免大查询的问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为数据库设置一个更强的密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-redis</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:7-alpine</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>

<span class="w">  </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*ui-env</span>
<span class="w">      </span><span class="nt">ADMIN_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span>
<span class="w">      </span><span class="nt">ADMIN_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w"> </span><span class="c1"># 记得为 changeme 用户设置一个更强的密码</span>
<span class="w">      </span><span class="nt">TOTP_ENCRYPTION_KEYS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mysecret&quot;</span><span class="w"> </span><span class="c1"># 记得设置一个更强的密钥（请参阅先决条件部分）</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=www.example.com&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_TEMPLATE=ui&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_REVERSE_PROXY=yes&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_URL=/changeme&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_HOST=http://bw-ui:7000&quot;</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">    </span><span class="nt">attachable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-web-ui-_9">语言支持与本地化</h2>
<p>BunkerWeb UI 支持多种语言。翻译文件在 <code>src/ui/app/static/locales</code> 目录中管理。目前支持以下语言：</p>
<ul>
<li>英语 (en)</li>
<li>法语 (fr)</li>
<li>阿拉伯语 (ar)</li>
<li>孟加拉语 (bn)</li>
<li>西班牙语 (es)</li>
<li>印地语 (hi)</li>
<li>葡萄牙语 (pt)</li>
<li>俄语 (ru)</li>
<li>乌尔都语 (ur)</li>
<li>中文 (zh)</li>
<li>德语 (de)</li>
<li>意大利语 (it)</li>
</ul>
<p>有关翻译来源和审核状态的详细信息，请参阅 <a href="https://github.com/bunkerity/bunkerweb/raw/vtesting/src/ui/app/static/locales/README.md">locales/README.md</a>。</p>
<h3 id="zh-web-ui-_10">贡献翻译</h3>
<p>我们欢迎您为改进或添加新的语言文件做出贡献！</p>
<p><strong>如何贡献翻译：</strong></p>
<ol>
<li>编辑 <code>src/ui/app/lang_config.py</code> 文件以添加您的语言（代码、名称、国旗、英文名称）。</li>
<li>将 <code>en.json</code> 复制为 <code>src/ui/app/static/locales/</code> 中的模板，并将其重命名为您的语言代码（例如，德语为 <code>de.json</code>）。</li>
<li>在新文件中翻译值。</li>
<li>更新 <code>locales/README.md</code> 中的表格，添加您的语言并注明创建者/审阅者。</li>
<li>提交一个拉取请求。</li>
</ol>
<p>对于更新，请编辑相关文件并根据需要更新来源表。</p>
<p>有关完整指南，请参阅 <a href="https://github.com/bunkerity/bunkerweb/raw/vtesting/src/ui/app/static/locales/README.md">locales/README.md</a>。</p></section><section class="print-page" id="zh-api" heading-number="8"><h1 id="zh-api-api">API</h1>
<h2 id="zh-api-_1">概述</h2>
<p>BunkerWeb API 是用于以编程方式管理 BunkerWeb 实例的控制平面：列出和管理实例、重新加载/停止、处理封禁、插件、作业、配置等。它公开了一个有文档记录的 FastAPI 应用程序，具有强大的身份验证、授权和速率限制功能。</p>
<p>在 <code>/docs</code>（如果设置了 <code>API_ROOT_PATH</code>，则为 <code>&lt;root_path&gt;/docs</code>）打开交互式文档。OpenAPI 模式可在 <code>/openapi.json</code> 获取。</p>
<div class="admonition warning">
<p class="admonition-title">安全</p>
<p>API 是一个特权控制平面。不要在没有额外保护的情况下将其暴露在公共互联网上。</p>
<p>至少，限制源 IP (<code>API_WHITELIST_IPS</code>)，启用身份验证（<code>API_TOKEN</code> 或 API 用户 + Biscuit），并考虑将其置于 BunkerWeb 之后，使用一个难以猜测的路径和额外的访问控制。</p>
</div>
<h2 id="zh-api-_2">先决条件</h2>
<p>API 服务需要访问 BunkerWeb 数据库 (<code>DATABASE_URI</code>)。它通常与调度器和可选的 Web UI 一起部署。推荐的设置是在前端运行 BunkerWeb 作为反向代理，并将 API 隔离在内部网络上。</p>
<p>请参阅<a href="#zh-quickstart-guide">快速入门指南</a>中的快速入门向导和架构指导。</p>
<h2 id="zh-api-_3">亮点</h2>
<ul>
<li>实例感知：将操作性动作广播到已发现的实例。</li>
<li>强身份验证：管理员的基本认证、Bearer 管理员覆盖或用于细粒度权限的 Biscuit ACL。</li>
<li>IP 允许列表和灵活的按路由速率限制。</li>
<li>标准的健康/就绪信号和启动安全检查。</li>
</ul>
<h2 id="zh-api-compose">Compose 样板文件</h2>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="zh-api-__tabbed_1_1" name="zh-api-__tabbed_1" type="radio" /><input id="zh-api-__tabbed_1_2" name="zh-api-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="zh-api-__tabbed_1_1">Docker</label><label for="zh-api-__tabbed_1_2">Docker Autoconf</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>使用 BunkerWeb 将 API 反向代理到 <code>/api</code> 下。</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-bw-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;bw-env</span>
<span class="w">  </span><span class="c1"># BunkerWeb/Scheduler 的共享实例控制平面允许列表</span>
<span class="w">  </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w">  </span><span class="c1"># QUIC</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*bw-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span><span class="w">  </span><span class="c1"># 匹配实例服务名称</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;www.example.com&quot;</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span>
<span class="w">      </span><span class="nt">DISABLE_DEFAULT_SERVER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="c1"># 在 /api 上反向代理 API</span>
<span class="w">      </span><span class="nt">www.example.com_USE_REVERSE_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">www.example.com_REVERSE_PROXY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/api&quot;</span>
<span class="w">      </span><span class="nt">www.example.com_REVERSE_PROXY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://bw-api:8888&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-api</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-api:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w">  </span><span class="c1"># 使用强密码</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span><span class="w">                      </span><span class="c1"># API 允许列表</span>
<span class="w">      </span><span class="nt">API_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;secret&quot;</span><span class="w">                                                 </span><span class="c1"># 可选的管理员覆盖令牌</span>
<span class="w">      </span><span class="nt">API_ROOT_PATH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/api&quot;</span><span class="w">                                               </span><span class="c1"># 匹配反向代理路径</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="c1"># 避免大查询出现问题</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span><span class="w">  </span><span class="c1"># 使用强密码</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>与上面相同，但利用 Autoconf 服务自动发现和配置服务。API 通过在 API 容器上使用标签暴露在 <code>/api</code> 下。</p>
<div class="highlight"><pre><span></span><code><span class="nt">x-api-env</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;api-env</span>
<span class="w">  </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">  </span><span class="nt">DATABASE_URI</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@bw-db:3306/db&quot;</span><span class="w">  </span><span class="c1"># 使用强密码</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:8080/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/tcp&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:8443/udp&quot;</span><span class="w">  </span><span class="c1"># QUIC</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">AUTOCONF_MODE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>

<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*api-env</span>
<span class="w">      </span><span class="nt">BUNKERWEB_INSTANCES</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w">    </span><span class="c1"># 由 Autoconf 发现</span>
<span class="w">      </span><span class="nt">SERVER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w">            </span><span class="c1"># 通过标签填充</span>
<span class="w">      </span><span class="nt">MULTISITE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w">           </span><span class="c1"># Autoconf 必需</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IP</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-storage:/data</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:testing</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*api-env</span>
<span class="w">      </span><span class="nt">DOCKER_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tcp://bw-docker:2375&quot;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-api</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-api:testing</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*api-env</span>
<span class="w">      </span><span class="nt">API_WHITELIST_IPS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;127.0.0.0/8</span><span class="nv"> </span><span class="s">10.20.30.0/24&quot;</span>
<span class="w">      </span><span class="nt">API_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;secret&quot;</span>
<span class="w">      </span><span class="nt">API_ROOT_PATH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/api&quot;</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.SERVER_NAME=www.example.com&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.USE_REVERSE_PROXY=yes&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_URL=/api&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;bunkerweb.REVERSE_PROXY_HOST=http://bw-api:8888&quot;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-allowed-packet=67108864</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;db&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bunkerweb&quot;</span>
<span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;changeme&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-data:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>

<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tecnativa/docker-socket-proxy:nightly</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CONTAINERS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">      </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warning&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock:ro</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-storage</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bw-universe</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-universe</span>
<span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.20.30.0/24</span>
<span class="w">  </span><span class="nt">bw-services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-services</span>
<span class="w">  </span><span class="nt">bw-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-db</span>
<span class="w">  </span><span class="nt">bw-docker</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bw-docker</span>
</code></pre></div>
</div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">反向代理路径</p>
<p>保持 API 路径难以猜测，并与 API 允许列表和身份验证结合使用。</p>
<p>如果您已经在同一服务器名称上使用模板（例如 <code>USE_TEMPLATE</code>）公开了另一个应用程序，请为 API 使用一个独立的主机名以避免冲突。</p>
</div>
<h3 id="zh-api-all-in-one">一体化 (All-In-One)</h3>
<p>如果您使用一体化镜像，可以通过设置 <code>SERVICE_API=yes</code> 来启用 API：</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>bunkerweb-aio<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">SERVICE_API</span><span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-e<span class="w"> </span><span class="nv">API_WHITELIST_IPS</span><span class="o">=</span><span class="s2">&quot;127.0.0.0/8&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="m">80</span>:8080/tcp<span class="w"> </span>-p<span class="w"> </span><span class="m">443</span>:8443/tcp<span class="w"> </span>-p<span class="w"> </span><span class="m">443</span>:8443/udp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>bunkerity/bunkerweb-all-in-one:testing
</code></pre></div>
<h2 id="zh-api-_4">身份验证</h2>
<p>支持的请求身份验证方式：</p>
<ul>
<li>基本管理员认证：当凭据属于管理员 API 用户时，受保护的端点接受 <code>Authorization: Basic &lt;base64(username:password)&gt;</code>。</li>
<li>管理员 Bearer 覆盖：如果配置了 <code>API_TOKEN</code>，<code>Authorization: Bearer &lt;API_TOKEN&gt;</code> 将授予完全访问权限。</li>
<li>Biscuit 令牌（推荐）：使用基本凭据或包含 <code>username</code> 和 <code>password</code> 的 JSON/表单体从 <code>POST /auth</code> 获取令牌。在后续调用中将返回的令牌用作 <code>Authorization: Bearer &lt;token&gt;</code>。</li>
</ul>
<p>示例：获取一个 Biscuit，列出实例，然后重新加载所有实例。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1) 使用管理员凭据获取一个 Biscuit 令牌</span>
<span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>-s<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-u<span class="w"> </span>admin:changeme<span class="w"> </span>http://api.example.com/auth<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span>.token<span class="k">)</span>

<span class="c1"># 2) 列出实例</span>
curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">&quot;</span><span class="w"> </span>http://api.example.com/instances

<span class="c1"># 3) 重新加载所有实例的配置（无测试）</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span><span class="s2">&quot;http://api.example.com/instances/reload?test=no&quot;</span>
</code></pre></div>
<h3 id="zh-api-biscuit">Biscuit 事实和检查</h3>
<p>令牌嵌入了诸如 <code>user(&lt;username&gt;)</code>、<code>client_ip(&lt;ip&gt;)</code>、<code>domain(&lt;host&gt;)</code> 等事实，以及从数据库权限派生的粗粒度角色 <code>role("api_user", ["read", "write"])</code>。管理员包含 <code>admin(true)</code>，而非管理员则携带细粒度的事实，如 <code>api_perm(&lt;resource_type&gt;, &lt;resource_id|*&gt;, &lt;permission&gt;)</code>。</p>
<p>授权将路由/方法映射到所需的权限；<code>admin(true)</code> 总是通过。当缺少细粒度事实时，守卫会回退到粗粒度角色：GET/HEAD/OPTIONS 需要 <code>read</code>；写入动词需要 <code>write</code>。</p>
<p>密钥存储在 <code>/var/lib/bunkerweb/.api_biscuit_private_key</code> 和 <code>/var/lib/bunkerweb/.api_biscuit_public_key</code>。您还可以通过环境变量提供 <code>BISCUIT_PUBLIC_KEY</code>/<code>BISCUIT_PRIVATE_KEY</code>；如果文件和环境变量都未设置，API 会在启动时生成一个密钥对并安全地持久化它。</p>
<h2 id="zh-api-acl">权限 (ACL)</h2>
<p>此 API 支持两个授权层：</p>
<ul>
<li>粗粒度角色：令牌携带 <code>role("api_user", ["read"[, "write"]])</code> 用于没有细粒度映射的端点。Read 映射到 GET/HEAD/OPTIONS；write 映射到 POST/PUT/PATCH/DELETE。</li>
<li>细粒度 ACL：令牌嵌入 <code>api_perm(&lt;resource_type&gt;, &lt;resource_id|*&gt;, &lt;permission&gt;)</code>，并且路由声明它们需要什么。<code>admin(true)</code> 绕过所有检查。</li>
</ul>
<p>支持的资源类型：<code>instances</code>、<code>global_config</code>、<code>services</code>、<code>configs</code>、<code>plugins</code>、<code>cache</code>、<code>bans</code>、<code>jobs</code>。</p>
<p>按资源类型划分的权限名称：</p>
<ul>
<li>instances: <code>instances_read</code>、<code>instances_update</code>、<code>instances_delete</code>、<code>instances_create</code>、<code>instances_execute</code></li>
<li>global_config: <code>global_config_read</code>、<code>global_config_update</code></li>
<li>services: <code>service_read</code>、<code>service_create</code>、<code>service_update</code>、<code>service_delete</code>、<code>service_convert</code>、<code>service_export</code></li>
<li>configs: <code>configs_read</code>、<code>config_read</code>、<code>config_create</code>、<code>config_update</code>、<code>config_delete</code></li>
<li>plugins: <code>plugin_read</code>、<code>plugin_create</code>、<code>plugin_delete</code></li>
<li>cache: <code>cache_read</code>、<code>cache_delete</code></li>
<li>bans: <code>ban_read</code>、<code>ban_update</code>、<code>ban_delete</code>、<code>ban_created</code></li>
<li>jobs: <code>job_read</code>、<code>job_run</code></li>
</ul>
<p>资源 ID：对于细粒度检查，当有意义时，第二个路径段被视为 <code>resource_id</code>。示例：<code>/services/{service}</code> -&gt; <code>{service}</code>；<code>/configs/{service}/...</code> -&gt; <code>{service}</code>。使用 <code>"*"</code>（或省略）为资源类型全局授予权限。</p>
<p>用户和 ACL 配置：</p>
<ul>
<li>管理员用户：设置 <code>API_USERNAME</code> 和 <code>API_PASSWORD</code> 以在启动时创建第一个管理员。要稍后轮换凭据，请设置 <code>OVERRIDE_API_CREDS=yes</code>（或确保管理员是使用 <code>manual</code> 方法创建的）。只存在一个管理员；额外的尝试会回退到非管理员创建。</li>
<li>非管理员用户和授权：提供指向 JSON 文件的 <code>API_ACL_BOOTSTRAP_FILE</code>，或挂载 <code>/var/lib/bunkerweb/api_acl_bootstrap.json</code>。API 在启动时读取它以创建/更新用户和权限。</li>
<li>ACL 缓存文件：一个只读的摘要在启动时写入 <code>/var/lib/bunkerweb/api_acl.json</code> 以供内省；授权评估嵌入在 Biscuit 令牌中的数据库支持的授权。</li>
</ul>
<p>引导 JSON 示例（两种形式都支持）：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;users&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;ci&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;admin&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Str0ng&amp;P@ss!&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;permissions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;services&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;*&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;service_read&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">          </span><span class="nt">&quot;app-frontend&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;service_update&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;service_delete&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;configs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;app-frontend&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;config_read&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;config_update&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;ops&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;admin&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;password_hash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$2b$13$...bcrypt-hash...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;permissions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;instances&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;*&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;instances_execute&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;jobs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;*&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;job_run&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>或列表形式：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;users&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ci&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Str0ng&amp;P@ss!&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;permissions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;resource_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;services&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;resource_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;permission&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;service_read&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;resource_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;services&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;resource_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app-frontend&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;permission&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;service_update&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>注意：</p>
<ul>
<li>密码可以是明文（<code>password</code>）或 bcrypt（<code>password_hash</code> / <code>password_bcrypt</code>）。在非调试版本中，弱明文密码会被拒绝；如果缺少，会生成一个随机密码并记录警告。</li>
<li><code>resource_id: "*"</code>（或 null/空）在该资源类型上全局授予权限。</li>
<li>现有用户可以通过引导更新密码并应用额外的授权。</li>
</ul>
<h2 id="zh-api-_5">功能参考</h2>
<p>API 按资源聚焦的路由器组织。使用以下部分作为功能地图；<code>/docs</code> 处的交互式模式详细记录了请求/响应模型。</p>
<h3 id="zh-api-_6">核心和身份验证</h3>
<ul>
<li><code>GET /ping</code>、<code>GET /health</code>：API 服务本身的轻量级存活探针。</li>
<li><code>POST /auth</code>：用基本凭据（或管理员覆盖令牌）交换 Biscuit。接受 JSON、表单或 <code>Authorization</code> 标头。管理员如果需要，也可以直接在受保护的路由上继续使用 HTTP 基本认证。</li>
</ul>
<h3 id="zh-api-_7">实例控制平面</h3>
<ul>
<li><code>GET /instances</code>：列出注册的实例，包括创建/最后一次看到的时间戳、注册方法和元数据。</li>
<li><code>POST /instances</code>：注册一个新的 API 管理的实例（主机名、可选端口、服务器名称、友好名称、方法）。</li>
<li><code>GET /instances/{hostname}</code> / <code>PATCH /instances/{hostname}</code> / <code>DELETE /instances/{hostname}</code>：检查、更新可变字段或删除 API 管理的实例。</li>
<li><code>DELETE /instances</code>：批量删除；跳过非 API 实例并在 <code>skipped</code> 中报告它们。</li>
<li><code>GET /instances/ping</code> 和 <code>GET /instances/{hostname}/ping</code>：对所有或单个实例进行健康检查。</li>
<li><code>POST /instances/reload?test=yes|no</code>、<code>POST /instances/{hostname}/reload</code>：触发配置重新加载（测试模式执行空跑验证）。</li>
<li><code>POST /instances/stop</code>、<code>POST /instances/{hostname}/stop</code>：向实例中继停止命令。</li>
</ul>
<h3 id="zh-api-_8">全局配置</h3>
<ul>
<li><code>GET /global_config</code>：获取非默认设置（使用 <code>full=true</code> 获取完整配置，<code>methods=true</code> 包含来源信息）。</li>
<li><code>PATCH /global_config</code>：更新或插入 API 拥有的（<code>method="api"</code>）全局设置；验证错误会指出未知或只读的键。</li>
</ul>
<h3 id="zh-api-_9">服务生命周期</h3>
<ul>
<li><code>GET /services</code>：枚举服务及其元数据，包括草稿状态和时间戳。</li>
<li><code>GET /services/{service}</code>：检索服务的非默认覆盖层（<code>full=false</code>）或完整配置快照（<code>full=true</code>）。</li>
<li><code>POST /services</code>：创建服务，可选择作为草稿，并设定带前缀的变量（<code>{service}_{KEY}</code>）。原子地更新 <code>SERVER_NAME</code> 名册。</li>
<li><code>PATCH /services/{service}</code>：重命名服务、切换草稿标志并更新带前缀的变量。为安全起见，忽略对 <code>variables</code> 内 <code>SERVER_NAME</code> 的直接编辑。</li>
<li><code>DELETE /services/{service}</code>：删除一个服务及其派生的配置键。</li>
<li><code>POST /services/{service}/convert?convert_to=online|draft</code>：快速切换草稿/在线状态，而不更改其他变量。</li>
</ul>
<h3 id="zh-api-_10">自定义配置片段</h3>
<ul>
<li><code>GET /configs</code>：列出服务的自定义配置片段（HTTP/服务器/流/ModSecurity/CRS 挂钩）（默认为 <code>service=global</code>）。<code>with_data=true</code> 在可打印时嵌入 UTF-8 内容。</li>
<li><code>POST /configs</code> 和 <code>POST /configs/upload</code>：从 JSON 负载或上传的文件创建新片段。接受的类型包括 <code>http</code>、<code>server_http</code>、<code>default_server_http</code>、<code>modsec</code>、<code>modsec_crs</code>、<code>stream</code>、<code>server_stream</code> 和 CRS 插件挂钩。名称必须匹配 <code>^[\w_-]{1,64}$</code>。</li>
<li><code>GET /configs/{service}/{type}/{name}</code>：检索带有可选内容的片段（<code>with_data=true</code>）。</li>
<li><code>PATCH /configs/{service}/{type}/{name}</code> 和 <code>PATCH .../upload</code>：更新或移动 API 管理的片段；模板或文件管理的条目保持只读。</li>
<li><code>DELETE /configs</code> 和 <code>DELETE /configs/{service}/{type}/{name}</code>：修剪 API 管理的片段，同时保留模板管理的片段，并为被忽略的条目返回一个 <code>skipped</code> 列表。</li>
</ul>
<h3 id="zh-api-_11">封禁编排</h3>
<ul>
<li><code>GET /bans</code>：聚合所有实例报告的活动封禁。</li>
<li><code>POST /bans</code> 或 <code>POST /bans/ban</code>：应用一个或多个封禁。负载可以是 JSON 对象、数组或字符串化的 JSON。<code>service</code> 是可选的；省略时封禁是全局的。</li>
<li><code>POST /bans/unban</code> 或 <code>DELETE /bans</code>：使用同样灵活的负载全局或按服务删除封禁。</li>
</ul>
<h3 id="zh-api-_12">插件管理</h3>
<ul>
<li><code>GET /plugins?type=all|external|ui|pro</code>：列出带有元数据的插件；<code>with_data=true</code> 在可用时包含打包的字节。</li>
<li><code>POST /plugins/upload</code>：从 <code>.zip</code>、<code>.tar.gz</code> 或 <code>.tar.xz</code> 存档安装 UI 插件。存档可以捆绑多个插件，只要每个插件都包含一个 <code>plugin.json</code>。</li>
<li><code>DELETE /plugins/{id}</code>：按 ID (<code>^[\w.-]{4,64}$</code>) 删除 UI 插件。</li>
</ul>
<h3 id="zh-api-_13">作业缓存和执行</h3>
<ul>
<li><code>GET /cache</code>：列出由调度器作业产生的缓存工件，按服务、插件 ID 或作业名称过滤。<code>with_data=true</code> 包含可打印的文件内容。</li>
<li><code>GET /cache/{service}/{plugin}/{job}/{file}</code>：获取特定的缓存文件（<code>download=true</code> 以附件形式流式传输）。</li>
<li><code>DELETE /cache</code> 或 <code>DELETE /cache/{service}/{plugin}/{job}/{file}</code>：删除缓存文件并通知调度器受影响的插件。</li>
<li><code>GET /jobs</code>：检查已知的作业、它们的调度元数据和缓存摘要。</li>
<li><code>POST /jobs/run</code>：通过将关联的插件标记为已更改来请求作业执行。</li>
</ul>
<h3 id="zh-api-_14">操作说明</h3>
<ul>
<li>写入端点持久化到共享数据库；实例通过调度器同步或在 <code>/instances/reload</code> 后获取更改。</li>
<li>错误被规范化为 <code>{ "status": "error", "message": "..." }</code>，并带有适当的 HTTP 状态码（422 验证，404 未找到，403 ACL，5xx 上游故障）。</li>
</ul>
<h2 id="zh-api-_15">速率限制</h2>
<p>客户端的速率限制由 SlowAPI 处理。通过环境变量或 <code>/etc/bunkerweb/api.yml</code> 启用/禁用它并调整限制。</p>
<ul>
<li><code>API_RATE_LIMIT_ENABLED</code> (默认: <code>yes</code>)</li>
<li>默认限制: <code>API_RATE_LIMIT_TIMES</code> 每 <code>API_RATE_LIMIT_SECONDS</code> (例如 <code>100</code> 每 <code>60</code>)</li>
<li><code>API_RATE_LIMIT_RULES</code>: 内联 JSON/CSV，或指向包含按路由规则的 YAML/JSON 文件的路径</li>
<li>存储后端: 内存或当 <code>USE_REDIS=yes</code> 且提供了 <code>REDIS_*</code> 变量时使用 Redis/Valkey (支持 Sentinel)</li>
<li>标头: <code>API_RATE_LIMIT_HEADERS_ENABLED</code> (默认: <code>yes</code>)</li>
</ul>
<p>示例 YAML (挂载在 <code>/etc/bunkerweb/api.yml</code>):</p>
<p><code>yaml
API_RATE_LIMIT_ENABLED: yes
API_RATE_LIMIT_DEFAULTS: ["200/minute"]
API_RATE_LIMIT_RULES:
  - path: "/auth"
    methods: "POST"
    times: 10
    seconds: 60
  - path: "/instances*"
    methods: "GET|POST"
    times: 100
    seconds: 60</code></p>
<h2 id="zh-api-_16">配置</h2>
<p>您可以通过环境变量、Docker secrets 以及可选的 <code>/etc/bunkerweb/api.yml</code> 或 <code>/etc/bunkerweb/api.env</code> 文件来配置 API。关键设置：</p>
<ul>
<li>文档和模式: <code>API_DOCS_URL</code>, <code>API_REDOC_URL</code>, <code>API_OPENAPI_URL</code>, <code>API_ROOT_PATH</code>。</li>
<li>认证基础: <code>API_TOKEN</code> (管理员覆盖 Bearer), <code>API_USERNAME</code>/<code>API_PASSWORD</code> (创建/更新管理员), <code>OVERRIDE_API_CREDS</code>。</li>
<li>ACL 和用户: <code>API_ACL_BOOTSTRAP_FILE</code> (JSON 路径)。</li>
<li>Biscuit 策略: <code>API_BISCUIT_TTL_SECONDS</code> (0/关闭禁用 TTL), <code>CHECK_PRIVATE_IP</code> (将令牌绑定到客户端 IP，除非是私有 IP)。</li>
<li>IP 允许列表: <code>API_WHITELIST_ENABLED</code>, <code>API_WHITELIST_IPS</code>。</li>
<li>速率限制 (核心): <code>API_RATE_LIMIT_ENABLED</code>, <code>API_RATE_LIMIT_TIMES</code>, <code>API_RATE_LIMIT_SECONDS</code>, <code>API_RATE_LIMIT_HEADERS_ENABLED</code>。</li>
<li>速率限制 (高级): <code>API_RATE_LIMIT_AUTH_TIMES</code>, <code>API_RATE_LIMIT_AUTH_SECONDS</code>, <code>API_RATE_LIMIT_RULES</code>, <code>API_RATE_LIMIT_DEFAULTS</code>, <code>API_RATE_LIMIT_APPLICATION_LIMITS</code>, <code>API_RATE_LIMIT_STRATEGY</code>, <code>API_RATE_LIMIT_KEY</code>, <code>API_RATE_LIMIT_EXEMPT_IPS</code>, <code>API_RATE_LIMIT_STORAGE_OPTIONS</code>。</li>
<li>速率限制存储: 内存或当 <code>USE_REDIS=yes</code> 且设置了 Redis 相关变量时使用 Redis/Valkey，如 <code>REDIS_HOST</code>, <code>REDIS_PORT</code>, <code>REDIS_PASSWORD</code>, <code>REDIS_DATABASE</code>, <code>REDIS_SSL</code> 或 Sentinel 变量。请参阅 <code>docs/features.md</code> 中的 Redis 设置表。</li>
<li>网络/TLS: <code>API_LISTEN_ADDR</code>, <code>API_LISTEN_PORT</code>, <code>API_FORWARDED_ALLOW_IPS</code>, <code>API_SSL_ENABLED</code>, <code>API_SSL_CERTFILE</code>, <code>API_SSL_KEYFILE</code>, <code>API_SSL_CA_CERTS</code>。</li>
</ul>
<h3 id="zh-api-_17">配置加载方式</h3>
<p>优先级从高到低：</p>
<ul>
<li>环境变量 (例如容器 <code>environment:</code> 或导出的 shell 变量)</li>
<li><code>/run/secrets</code> 下的 Secrets 文件 (Docker/K8s secrets; 文件名匹配变量名)</li>
<li><code>/etc/bunkerweb/api.yml</code> 处的 YAML 文件</li>
<li><code>/etc/bunkerweb/api.env</code> 处的 Env 文件 (key=value 行)</li>
<li>内置默认值</li>
</ul>
<p>注意：</p>
<ul>
<li>YAML 支持使用 <code>&lt;file:relative/path&gt;</code> 内联 secret 文件；路径相对于 <code>/run/secrets</code> 解析。</li>
<li>将文档 URL 设置为 <code>off</code>/<code>disabled</code>/<code>none</code> 以禁用端点 (例如 <code>API_DOCS_URL=off</code>)。</li>
<li>如果 <code>API_SSL_ENABLED=yes</code>，您还必须设置 <code>API_SSL_CERTFILE</code> 和 <code>API_SSL_KEYFILE</code>。</li>
<li>如果启用了 Redis (<code>USE_REDIS=yes</code>)，请提供 Redis 详细信息；请参阅 <code>docs/features.md</code> 中的 Redis 部分。</li>
</ul>
<h3 id="zh-api-_18">身份验证和用户</h3>
<ul>
<li>管理员引导：设置 <code>API_USERNAME</code> 和 <code>API_PASSWORD</code> 以创建第一个管理员。要稍后重新应用，请设置 <code>OVERRIDE_API_CREDS=yes</code>。</li>
<li>非管理员和权限：提供 <code>API_ACL_BOOTSTRAP_FILE</code> 并指定一个 JSON 路径（或挂载到 <code>/var/lib/bunkerweb/api_acl_bootstrap.json</code>）。该文件可以列出用户和细粒度的授权。</li>
<li>Biscuit 密钥：可以设置 <code>BISCUIT_PUBLIC_KEY</code>/<code>BISCUIT_PRIVATE_KEY</code>，或在 <code>/var/lib/bunkerweb/.api_biscuit_public_key</code> 和 <code>/var/lib/bunkerweb/.api_biscuit_private_key</code> 处挂载文件。如果均未提供，API 将在启动时生成并持久化一个密钥对。</li>
</ul>
<h3 id="zh-api-tls">TLS 和网络</h3>
<ul>
<li>绑定地址/端口：<code>API_LISTEN_ADDR</code> (默认 <code>0.0.0.0</code>)，<code>API_LISTEN_PORT</code> (默认 <code>8888</code>)。</li>
<li>反向代理：将 <code>API_FORWARDED_ALLOW_IPS</code> 设置为代理 IP，以便 Gunicorn 信任 <code>X-Forwarded-*</code> 标头。</li>
<li>API 中的 TLS 终止：<code>API_SSL_ENABLED=yes</code> 加上 <code>API_SSL_CERTFILE</code> 和 <code>API_SSL_KEYFILE</code>；可选的 <code>API_SSL_CA_CERTS</code>。</li>
</ul>
<h3 id="zh-api-_19">速率限制快速配方</h3>
<ul>
<li>全局禁用：<code>API_RATE_LIMIT_ENABLED=no</code></li>
<li>设置一个简单的全局限制：<code>API_RATE_LIMIT_TIMES=100</code>，<code>API_RATE_LIMIT_SECONDS=60</code></li>
<li>按路由规则：将 <code>API_RATE_LIMIT_RULES</code> 设置为 JSON/YAML 文件路径或在 <code>/etc/bunkerweb/api.yml</code> 中内联 YAML。</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">启动安全</p>
<p>如果未配置身份验证路径（没有 Biscuit 密钥，没有管理员用户，也没有 <code>API_TOKEN</code>），API 将退出。请确保在启动前至少设置一种方法。</p>
</div>
<p>启动安全：如果没有任何身份验证路径可用（没有 Biscuit 密钥、没有管理员 API 用户、也没有 <code>API_TOKEN</code>），API 将退出。确保至少配置了一种。</p>
<div class="admonition info">
<p class="admonition-title">根路径和代理</p>
<p>如果您将 API 部署在 BunkerWeb 后面的子路径上，请将 <code>API_ROOT_PATH</code> 设置为该路径，以便 <code>/docs</code> 和相对路由在代理时能正常工作。</p>
</div>
<h2 id="zh-api-_20">操作</h2>
<ul>
<li>健康状况：当服务正常时，<code>GET /health</code> 返回 <code>{"status":"ok"}</code>。</li>
<li>Linux 服务：打包了一个名为 <code>bunkerweb-api.service</code> 的 <code>systemd</code> 单元。通过 <code>/etc/bunkerweb/api.env</code> 进行自定义，并使用 <code>systemctl</code> 进行管理。</li>
<li>启动安全：当没有可用的身份验证路径时（没有 Biscuit 密钥、没有管理员用户、没有 <code>API_TOKEN</code>），API 会快速失败。错误会写入 <code>/var/tmp/bunkerweb/api.error</code>。</li>
</ul></section><section class="print-page" id="zh-upgrading" heading-number="9"><h1 id="zh-upgrading-_1">升级</h1>
<h2 id="zh-upgrading-16x">从 1.6.X 升级</h2>
<h3 id="zh-upgrading-_2">步骤</h3>
<h4 id="zh-upgrading-docker">Docker</h4>
<ol>
<li>
<p><strong>备份数据库</strong>：</p>
<ul>
<li>在进行数据库升级之前，请确保对数据库的当前状态进行完整备份。</li>
<li>使用适当的工具备份整个数据库，包括数据、模式和配置。</li>
</ul>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>-e<span class="w"> </span><span class="nv">BACKUP_DIRECTORY</span><span class="o">=</span>/path/to/backup/directory<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup<span class="w"> </span>save
</code></pre></div>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>cp<span class="w"> </span>&lt;scheduler_container&gt;:/path/to/backup/directory<span class="w"> </span>/path/to/backup/directory
</code></pre></div>
</li>
<li>
<p><strong>升级 BunkerWeb</strong>：</p>
<ul>
<li>
<p>将 BunkerWeb 升级到最新版本。</p>
<ol>
<li>
<p><strong>更新 Docker Compose 文件</strong>：更新 Docker Compose 文件以使用新版本的 BunkerWeb 镜像。
    <div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:testing</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:testing</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div></p>
</li>
<li>
<p><strong>重启容器</strong>：重启容器以应用更改。
    <div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>down
docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div></p>
</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>检查日志</strong>：检查调度器服务的日志以确保迁移成功。</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>logs<span class="w"> </span>&lt;scheduler_container&gt;
</code></pre></div>
</li>
<li>
<p><strong>验证数据库</strong>：通过检查新数据库容器中的数据和配置来验证数据库升级是否成功。</p>
</li>
</ol>
<h4 id="zh-upgrading-linux">Linux</h4>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="zh-upgrading-__tabbed_1_1" name="zh-upgrading-__tabbed_1" type="radio" /><input id="zh-upgrading-__tabbed_1_2" name="zh-upgrading-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_1_1">使用安装脚本轻松升级</label><label for="zh-upgrading-__tabbed_1_2">手动</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ul>
<li>
<p><strong>快速开始</strong>：</p>
<p>要开始使用，请下载安装脚本及其校验和，然后在运行前验证脚本的完整性。</p>
<div class="highlight"><pre><span></span><code><span class="nv">LATEST_VERSION</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>-s<span class="w"> </span>https://api.github.com/repos/bunkerity/bunkerweb/releases/latest<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span>.tag_name<span class="k">)</span>

<span class="c1"># 下载脚本及其校验和</span>
wget<span class="w"> </span>https://github.com/bunkerity/bunkerweb/releases/download/<span class="si">${</span><span class="nv">LATEST_VERSION</span><span class="si">}</span>/install-bunkerweb.sh
wget<span class="w"> </span>https://github.com/bunkerity/bunkerweb/releases/download/<span class="si">${</span><span class="nv">LATEST_VERSION</span><span class="si">}</span>/install-bunkerweb.sh.sha256

<span class="c1"># 验证校验和</span>
sha256sum<span class="w"> </span>-c<span class="w"> </span>install-bunkerweb.sh.sha256

<span class="c1"># 如果检查成功，则运行脚本</span>
chmod<span class="w"> </span>+x<span class="w"> </span>install-bunkerweb.sh
sudo<span class="w"> </span>./install-bunkerweb.sh
</code></pre></div>
<div class="admonition danger">
<p class="admonition-title">安全提示</p>
<p><strong>在运行安装脚本之前，请务必验证其完整性。</strong></p>
<p>下载校验和文件，并使用像 <code>sha256sum</code> 这样的工具来确认脚本没有被更改或篡改。</p>
<p>如果校验和验证失败，<strong>请不要执行该脚本</strong>——它可能不安全。</p>
</div>
</li>
<li>
<p><strong>工作原理</strong>：</p>
<p>用于全新安装的多功能安装脚本也可以执行原地升级。当它检测到现有安装和不同的目标版本时，它会切换到升级模式并应用以下工作流程：</p>
<ol>
<li>检测与验证<ul>
<li>检测操作系统/版本并确认支持矩阵。</li>
<li>从 <code>/usr/share/bunkerweb/VERSION</code> 读取当前安装的 BunkerWeb 版本。</li>
</ul>
</li>
<li>升级场景决策<ul>
<li>如果请求的版本与已安装的版本相同，则中止（除非您明确重新运行以获取状态）。</li>
<li>如果版本不同，则标记为升级。</li>
</ul>
</li>
<li>（可选）自动升级前备份<ul>
<li>如果 <code>bwcli</code> 和调度器可用且启用了自动备份，它会通过内置的备份插件创建一个备份。</li>
<li>目的地：您使用 <code>--backup-dir</code> 提供的目录或生成的路径，如 <code>/var/tmp/bunkerweb-backup-YYYYmmdd-HHMMSS</code>。</li>
<li>您可以使用 <code>--no-auto-backup</code> 禁用此功能（然后手动备份就成了您的责任）。</li>
</ul>
</li>
<li>服务静默<ul>
<li>停止 <code>bunkerweb</code>、<code>bunkerweb-ui</code> 和 <code>bunkerweb-scheduler</code> 以确保一致的升级（与手动过程建议相符）。</li>
</ul>
</li>
<li>移除软件包锁定<ul>
<li>临时移除 <code>bunkerweb</code> 和 <code>nginx</code> 上的 <code>apt-mark hold</code> / <code>dnf versionlock</code>，以便可以安装目标版本。</li>
</ul>
</li>
<li>执行升级<ul>
<li>仅安装新的 BunkerWeb 软件包版本（在升级模式下，除非 NGINX 缺失，否则不会重新安装——这避免了触及正确固定的 NGINX）。</li>
<li>重新应用锁定/版本锁定以冻结升级后的版本。</li>
</ul>
</li>
<li>完成与状态<ul>
<li>显示核心服务的 systemd 状态和后续步骤。</li>
<li>保留您的配置和数据库不变——只更新应用程序代码和受管理的文件。</li>
</ul>
</li>
</ol>
<p>关键行为/说明：</p>
<ul>
<li>该脚本不会修改您的 <code>/etc/bunkerweb/variables.env</code> 或数据库内容。</li>
<li>如果自动备份失败（或被禁用），您仍然可以使用下面的回滚部分进行手动恢复。</li>
<li>升级模式有意避免在已存在的受支持固定版本之外重新安装或降级 NGINX。</li>
<li>用于故障排除的日志保留在 <code>/var/log/bunkerweb/</code> 中。</li>
</ul>
<p>回滚摘要：</p>
<ul>
<li>使用生成的备份目录（或您的手动备份）+ 回滚部分中的步骤来恢复数据库，然后重新安装以前的镜像/软件包版本并重新锁定软件包。</li>
</ul>
</li>
<li>
<p><strong>命令行选项</strong>：</p>
<p>您可以使用与安装相同的标志来驱动无人值守升级。与升级最相关的选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>目的</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-v, --version &lt;X.Y.Z&gt;</code></td>
<td>要升级到的目标 BunkerWeb 版本。</td>
</tr>
<tr>
<td><code>-y, --yes</code></td>
<td>非交互式（假定升级确认并启用自动备份，除非使用 <code>--no-auto-backup</code>）。</td>
</tr>
<tr>
<td><code>--backup-dir &lt;PATH&gt;</code></td>
<td>自动升级前备份的目的地。如果不存在则创建。</td>
</tr>
<tr>
<td><code>--no-auto-backup</code></td>
<td>跳过自动备份（不推荐）。您必须有手动备份。</td>
</tr>
<tr>
<td><code>-q, --quiet</code></td>
<td>抑制输出（与日志记录/监控结合使用）。</td>
</tr>
<tr>
<td><code>-f, --force</code></td>
<td>在不受支持的操作系统版本上继续。</td>
</tr>
<tr>
<td><code>--dry-run</code></td>
<td>显示检测到的环境、预期的操作，然后退出而不做任何更改。</td>
</tr>
</tbody>
</table>
<p>示例：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 交互式升级到 testing（会提示备份）</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>--version<span class="w"> </span>testing

<span class="c1"># 使用自动备份到自定义目录的非交互式升级</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>-v<span class="w"> </span>testing<span class="w"> </span>--backup-dir<span class="w"> </span>/var/backups/bw-2025-01<span class="w"> </span>-y

<span class="c1"># 静默无人值守升级（抑制日志）– 依赖默认的自动备份</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>-v<span class="w"> </span>testing<span class="w"> </span>-y<span class="w"> </span>-q

<span class="c1"># 执行一次空运行（计划）而不应用更改</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>-v<span class="w"> </span>testing<span class="w"> </span>--dry-run

<span class="c1"># 跳过自动备份进行升级（不推荐）</span>
sudo<span class="w"> </span>./install-bunkerweb.sh<span class="w"> </span>-v<span class="w"> </span>testing<span class="w"> </span>--no-auto-backup<span class="w"> </span>-y
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">跳过备份</p>
<p>使用 <code>--no-auto-backup</code> 而没有经过验证的手动备份，可能会在升级遇到问题时导致不可逆转的数据丢失。请始终保留至少一个最近的、经过测试的备份。</p>
</div>
</li>
</ul>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>备份数据库</strong>：</p>
<ul>
<li>在进行数据库升级之前，请确保对数据库的当前状态进行完整备份。</li>
<li>使用适当的工具备份整个数据库，包括数据、模式和配置。</li>
</ul>
<details class="warning">
<summary>给红帽企业 Linux (RHEL) 8.10 用户的信息</summary>
<p>如果您正在使用 <strong>RHEL 8.10</strong> 并计划使用<strong>外部数据库</strong>，您需要安装 <code>mysql-community-client</code> 包以确保 <code>mysqldump</code> 命令可用。您可以通过执行以下命令来安装该包：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="zh-upgrading-__tabbed_2_1" name="zh-upgrading-__tabbed_2" type="radio" /><input id="zh-upgrading-__tabbed_2_2" name="zh-upgrading-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_2_1">MySQL/MariaDB</label><label for="zh-upgrading-__tabbed_2_2">PostgreSQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>
<p><strong>安装 MySQL 仓库配置包</strong></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>https://dev.mysql.com/get/mysql80-community-release-el8-9.noarch.rpm
</code></pre></div>
</li>
<li>
<p><strong>启用 MySQL 仓库</strong></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>config-manager<span class="w"> </span>--enable<span class="w"> </span>mysql80-community
</code></pre></div>
</li>
<li>
<p><strong>安装 MySQL 客户端</strong></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>mysql-community-client
</code></pre></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>安装 PostgreSQL 仓库配置包</strong></p>
<div class="highlight"><pre><span></span><code>dnf<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-</span><span class="k">$(</span>uname<span class="w"> </span>-m<span class="k">)</span><span class="s2">/pgdg-redhat-repo-latest.noarch.rpm&quot;</span>
</code></pre></div>
</li>
<li>
<p><strong>安装 PostgreSQL 客户端</strong></p>
<div class="highlight"><pre><span></span><code>dnf<span class="w"> </span>install<span class="w"> </span>postgresql&lt;version&gt;
</code></pre></div>
</li>
</ol>
</div>
</div>
</div>
</details>
<div class="highlight"><pre><span></span><code><span class="nv">BACKUP_DIRECTORY</span><span class="o">=</span>/path/to/backup/directory<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup<span class="w"> </span>save
</code></pre></div>
</li>
<li>
<p><strong>升级 BunkerWeb</strong>：</p>
<ul>
<li>
<p>将 BunkerWeb 升级到最新版本。</p>
<ol>
<li>
<p><strong>停止服务</strong>：
    <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>bunkerweb
sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>bunkerweb-ui
sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>bunkerweb-scheduler
</code></pre></div></p>
</li>
<li>
<p><strong>更新 BunkerWeb</strong>：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="zh-upgrading-__tabbed_3_1" name="zh-upgrading-__tabbed_3" type="radio" /><input id="zh-upgrading-__tabbed_3_2" name="zh-upgrading-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_3_1">Debian/Ubuntu</label><label for="zh-upgrading-__tabbed_3_2">Fedora/RedHat</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>首先，如果您之前锁定了 BunkerWeb 软件包，请解锁它：</p>
<p>您可以使用 <code>apt-mark showhold</code> 打印锁定的软件包列表</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-mark<span class="w"> </span>unhold<span class="w"> </span>bunkerweb<span class="w"> </span>nginx
</code></pre></div>
<p>然后，您可以更新 BunkerWeb 软件包：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--allow-downgrades<span class="w"> </span><span class="nv">bunkerweb</span><span class="o">=</span>testing
</code></pre></div>
<p>为了防止在执行 <code>apt upgrade</code> 时升级 BunkerWeb 软件包，您可以使用以下命令：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-mark<span class="w"> </span>hold<span class="w"> </span>bunkerweb<span class="w"> </span>nginx
</code></pre></div>
<p>更多详细信息请参阅<a href="#zh-integrations-__tabbed_1_1">Linux 集成页面</a>。</p>
</div>
<div class="tabbed-block">
<p>首先，如果您之前锁定了 BunkerWeb 软件包，请解锁它：</p>
<p>您可以使用 <code>dnf versionlock list</code> 打印锁定的软件包列表</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>delete<span class="w"> </span>package<span class="w"> </span>bunkerweb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>delete<span class="w"> </span>package<span class="w"> </span>nginx
</code></pre></div>
<p>然后，您可以更新 BunkerWeb 软件包：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>makecache<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--allowerasing<span class="w"> </span>bunkerweb-testing
</code></pre></div>
<p>为了防止在执行 <code>dnf upgrade</code> 时升级 BunkerWeb 软件包，您可以使用以下命令：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>add<span class="w"> </span>bunkerweb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>add<span class="w"> </span>nginx
</code></pre></div>
<p>更多详细信息请参阅<a href="#zh-integrations-__tabbed_1_3">Linux 集成页面</a>。</p>
</div>
</div>
</div>
</li>
<li>
<p><strong>启动服务</strong>：
        <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb-ui
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
        或者重启系统：
        <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>reboot
</code></pre></div></p>
</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>检查日志</strong>：检查调度器服务的日志以确保迁移成功。</p>
<div class="highlight"><pre><span></span><code>journalctl<span class="w"> </span>-u<span class="w"> </span>bunkerweb<span class="w"> </span>--no-pager
</code></pre></div>
</li>
<li>
<p><strong>验证数据库</strong>：通过检查新数据库容器中的数据和配置来验证数据库升级是否成功。</p>
</li>
</ol>
</div>
</div>
</div>
<h3 id="zh-upgrading-_3">回滚</h3>
<div class="admonition failure">
<p class="admonition-title">如果出现问题</p>
<p>如果您在升级过程中遇到任何问题，您可以通过恢复在<a href="#zh-upgrading-__tabbed_1_1">步骤 1</a>中创建的备份来回滚到数据库的先前版本。</p>
<p>获取支持和更多信息：</p>
<ul>
<li><a href="https://panel.bunkerweb.io/?utm_source=doc&amp;utm_campaign=self">订购专业支持</a></li>
<li><a href="https://github.com/bunkerity/bunkerweb/issues">在 GitHub 上创建问题</a></li>
<li><a href="https://discord.bunkerity.com">加入 BunkerWeb Discord 服务器</a></li>
</ul>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="zh-upgrading-__tabbed_4_1" name="zh-upgrading-__tabbed_4" type="radio" /><input id="zh-upgrading-__tabbed_4_2" name="zh-upgrading-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_4_1">Docker</label><label for="zh-upgrading-__tabbed_4_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>
<p><strong>如果备份是 zip 文件，请先解压</strong>。</p>
<p>首先解压备份 zip 文件：</p>
<div class="highlight"><pre><span></span><code>unzip<span class="w"> </span>/path/to/backup/directory/backup.zip<span class="w"> </span>-d<span class="w"> </span>/path/to/backup/directory/
</code></pre></div>
</li>
<li>
<p><strong>恢复备份</strong>。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="zh-upgrading-__tabbed_5_1" name="zh-upgrading-__tabbed_5" type="radio" /><input id="zh-upgrading-__tabbed_5_2" name="zh-upgrading-__tabbed_5" type="radio" /><input id="zh-upgrading-__tabbed_5_3" name="zh-upgrading-__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_5_1">SQLite</label><label for="zh-upgrading-__tabbed_5_2">MySQL/MariaDB</label><label for="zh-upgrading-__tabbed_5_3">PostgreSQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>
<p><strong>删除现有的数据库文件。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>-i<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
</code></pre></div>
</li>
<li>
<p><strong>恢复备份。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-i<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>sqlite3<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</li>
<li>
<p><strong>修复权限。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>-i<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>chown<span class="w"> </span>root:nginx<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>-i<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
</code></pre></div>
</li>
<li>
<p><strong>停止堆栈。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>down
</code></pre></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>恢复备份。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-e<span class="w"> </span><span class="nv">MYSQL_PWD</span><span class="o">=</span>&lt;your_password&gt;<span class="w"> </span>-i<span class="w"> </span>&lt;database_container&gt;<span class="w"> </span>mysql<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</li>
<li>
<p><strong>停止堆栈。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>down
</code></pre></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>删除现有的数据库。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-i<span class="w"> </span>&lt;database_container&gt;<span class="w"> </span>dropdb<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>--force<span class="w"> </span>&lt;database_name&gt;
</code></pre></div>
</li>
<li>
<p><strong>重新创建数据库。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-i<span class="w"> </span>&lt;database_container&gt;<span class="w"> </span>createdb<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>&lt;database_name&gt;
</code></pre></div>
</li>
<li>
<p><strong>恢复备份。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-i<span class="w"> </span>&lt;database_container&gt;<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</li>
<li>
<p><strong>停止堆栈。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>down
</code></pre></div>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p><strong>降级 BunkerWeb</strong>。</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:&lt;old_version&gt;</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:&lt;old_version&gt;</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:&lt;old_version&gt;</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:&lt;old_version&gt;</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
</li>
<li>
<p><strong>启动容器</strong>。</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>如果备份是 zip 文件，请先解压</strong>。</p>
<p>首先解压备份 zip 文件：</p>
<div class="highlight"><pre><span></span><code>unzip<span class="w"> </span>/path/to/backup/directory/backup.zip<span class="w"> </span>-d<span class="w"> </span>/path/to/backup/directory/
</code></pre></div>
</li>
<li>
<p><strong>停止服务</strong>。</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>bunkerweb<span class="w"> </span>bunkerweb-ui<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</li>
<li>
<p><strong>恢复备份</strong>。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:3"><input checked="checked" id="zh-upgrading-__tabbed_6_1" name="zh-upgrading-__tabbed_6" type="radio" /><input id="zh-upgrading-__tabbed_6_2" name="zh-upgrading-__tabbed_6" type="radio" /><input id="zh-upgrading-__tabbed_6_3" name="zh-upgrading-__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_6_1">SQLite</label><label for="zh-upgrading-__tabbed_6_2">MySQL/MariaDB</label><label for="zh-upgrading-__tabbed_6_3">PostgreSQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
sudo<span class="w"> </span>sqlite3<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
sudo<span class="w"> </span>chown<span class="w"> </span>root:nginx<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>mysql<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>删除现有的数据库。</strong></p>
<div class="highlight"><pre><span></span><code>dropdb<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>--force<span class="w"> </span>&lt;database_name&gt;
</code></pre></div>
</li>
<li>
<p><strong>重新创建数据库。</strong></p>
<div class="highlight"><pre><span></span><code>createdb<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>&lt;database_name&gt;
</code></pre></div>
</li>
<li>
<p><strong>恢复备份。</strong></p>
<div class="highlight"><pre><span></span><code>psql<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p><strong>启动服务</strong>。</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb<span class="w"> </span>bunkerweb-ui<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</li>
<li>
<p><strong>降级 BunkerWeb</strong>。</p>
<ul>
<li>按照<a href="#zh-integrations-linux">Linux 集成页面</a>中升级 BunkerWeb 的相同步骤，将 BunkerWeb 降级到以前的版本。</li>
</ul>
</li>
</ol>
</div>
</div>
</div>
<h2 id="zh-upgrading-15x">从 1.5.X 升级</h2>
<h3 id="zh-upgrading-_4">有什么变化？</h3>
<h4 id="zh-upgrading-_5">调度器</h4>
<p>与 1.5.X 版本不同，调度器服务<strong>不再使用<em>docker 套接字代理</em>来获取 BunkerWeb 的实例</strong>。相反，它使用了新的 <code>BUNKERWEB_INSTANCES</code> 环境变量。</p>
<div class="admonition info">
<p class="admonition-title">关于 <code>BUNKERWEB_INSTANCES</code> 环境变量</p>
<p>这个新变量是一个以空格分隔的 BunkerWeb 实例列表，格式如下：<code>http://bunkerweb:5000 bunkerweb1:5000 bunkerweb2:5000 ...</code>。然后调度器将使用此列表来获取实例的配置并将配置发送给它们。</p>
<ul>
<li><code>http://</code> 前缀是可选的。</li>
<li>端口是可选的，默认为 <code>API_HTTP_PORT</code> 环境变量的值。</li>
<li><code>BUNKERWEB_INSTANCES</code> 环境变量的默认值是 <code>127.0.0.1</code>。</li>
</ul>
</div>
<p>换句话说，新系统是完全不可知和通用的：调度器负责管理一个 BunkerWeb 实例列表，并且不需要关心环境。</p>
<div class="admonition tip">
<p class="admonition-title">Autoconf/Kubernetes/Swarm 集成</p>
<p>如果您正在使用 <code>Autoconf</code>、<code>Kubernetes</code> 或 <code>Swarm</code> 集成，您可以将 <code>BUNKERWEB_INSTANCES</code> 环境变量设置为空字符串（这样它就不会尝试将配置发送到默认的 <code>127.0.0.1</code>）。</p>
<p><strong>实例将由控制器自动获取</strong>。您还可以向列表中添加自定义实例，这些实例可能不会被控制器选中。</p>
</div>
<p>自 <code>1.6</code> 版本起，调度器还拥有一个新的<a href="#zh-concepts">内置健康检查系统</a>，它将检查实例的健康状况。如果一个实例变得不健康，调度器将停止向其发送配置。如果该实例恢复健康，调度器将再次开始向其发送配置。</p>
<h4 id="zh-upgrading-bunkerweb">BunkerWeb 容器</h4>
<p>另一个重要的变化是，以前在 BunkerWeb 容器上声明的<strong>设置</strong>现在在调度器上声明。这意味着您必须将您的设置从 BunkerWeb 容器移动到调度器容器。</p>
<p>虽然设置现在在调度器容器上声明，但<strong>您仍然需要在 BunkerWeb 容器上声明与 API 相关的强制性设置</strong>，例如 <code>API_WHITELIST_IP</code> 设置，它用于将调度器的 IP 地址列入白名单，以便它可以将配置发送到实例。如果您使用 <code>API_TOKEN</code>，您还必须在 BunkerWeb 容器上设置它（并在调度器上镜像它）以允许经过身份验证的 API 调用。</p>
<div class="admonition warning">
<p class="admonition-title">BunkerWeb 的容器设置</p>
<p>您在 BunkerWeb 容器上声明的每个与 API 相关的设置<strong>都必须在调度器容器上镜像</strong>，以便它能继续工作，因为配置将被调度器生成的配置覆盖。</p>
</div>
<h4 id="zh-upgrading-_6">默认值和新设置</h4>
<p>我们尽力不更改默认值，但我们添加了许多其他设置。强烈建议阅读文档的<a href="#zh-advanced-security-tuning">安全调整</a>和<a href="#zh-features">设置</a>部分。</p>
<h4 id="zh-upgrading-_7">模板</h4>
<p>我们添加了一个名为<strong>模板</strong>的新功能。模板提供了一种结构化和标准化的方法来定义设置和自定义配置，有关更多信息，请查看<a href="#zh-concepts-templates">概念/模板</a>部分。</p>
<h4 id="zh-upgrading-autoconf">Autoconf 命名空间</h4>
<p>我们向自动配置集成添加了<strong>命名空间</strong>功能。命名空间允许您对实例进行分组，并仅对它们应用设置。根据您的集成，查看以下部分以获取更多信息：</p>
<ul>
<li><a href="#zh-integrations-namespaces">Autoconf/namespaces</a></li>
<li><a href="#zh-integrations-namespaces_1">Kubernetes/namespaces</a></li>
<li><a href="#zh-integrations-namespaces_2">Swarm/namespaces</a></li>
</ul>
<h3 id="zh-upgrading-_8">步骤</h3>
<ol>
<li>
<p><strong>备份数据库</strong>：</p>
<ul>
<li>在进行数据库升级之前，请确保对数据库的当前状态进行完整备份。</li>
<li>使用适当的工具备份整个数据库，包括数据、模式和配置。</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="zh-upgrading-__tabbed_7_1" name="zh-upgrading-__tabbed_7" type="radio" /><input id="zh-upgrading-__tabbed_7_2" name="zh-upgrading-__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_7_1">1.5.7 及更高版本</label><label for="zh-upgrading-__tabbed_7_2">1.5.6 及更早版本</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="tabbed-set tabbed-alternate" data-tabs="8:2"><input checked="checked" id="zh-upgrading-__tabbed_8_1" name="zh-upgrading-__tabbed_8" type="radio" /><input id="zh-upgrading-__tabbed_8_2" name="zh-upgrading-__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_8_1">Docker</label><label for="zh-upgrading-__tabbed_8_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>-e<span class="w"> </span><span class="nv">BACKUP_DIRECTORY</span><span class="o">=</span>/path/to/backup/directory<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup<span class="w"> </span>save
</code></pre></div>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>cp<span class="w"> </span>&lt;scheduler_container&gt;:/path/to/backup/directory<span class="w"> </span>/path/to/backup/directory
</code></pre></div>
</div>
<div class="tabbed-block">
<details class="warning">
<summary>给红帽企业 Linux (RHEL) 8.10 用户的信息</summary>
<p>如果您正在使用 <strong>RHEL 8.10</strong> 并计划使用<strong>外部数据库</strong>，您需要安装 <code>mysql-community-client</code> 包以确保 <code>mysqldump</code> 命令可用。您可以通过执行以下命令来安装该包：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:2"><input checked="checked" id="zh-upgrading-__tabbed_9_1" name="zh-upgrading-__tabbed_9" type="radio" /><input id="zh-upgrading-__tabbed_9_2" name="zh-upgrading-__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_9_1">MySQL/MariaDB</label><label for="zh-upgrading-__tabbed_9_2">PostgreSQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>
<p><strong>安装 MySQL 仓库配置包</strong></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>https://dev.mysql.com/get/mysql80-community-release-el8-9.noarch.rpm
</code></pre></div>
</li>
<li>
<p><strong>启用 MySQL 仓库</strong></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>config-manager<span class="w"> </span>--enable<span class="w"> </span>mysql80-community
</code></pre></div>
</li>
<li>
<p><strong>安装 MySQL 客户端</strong></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>mysql-community-client
</code></pre></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>安装 PostgreSQL 仓库配置包</strong></p>
<div class="highlight"><pre><span></span><code>dnf<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-</span><span class="k">$(</span>uname<span class="w"> </span>-m<span class="k">)</span><span class="s2">/pgdg-redhat-repo-latest.noarch.rpm&quot;</span>
</code></pre></div>
</li>
<li>
<p><strong>安装 PostgreSQL 客户端</strong></p>
<div class="highlight"><pre><span></span><code>dnf<span class="w"> </span>install<span class="w"> </span>postgresql&lt;version&gt;
</code></pre></div>
</li>
</ol>
</div>
</div>
</div>
</details>
<div class="highlight"><pre><span></span><code><span class="nv">BACKUP_DIRECTORY</span><span class="o">=</span>/path/to/backup/directory<span class="w"> </span>bwcli<span class="w"> </span>plugin<span class="w"> </span>backup<span class="w"> </span>save
</code></pre></div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<div class="tabbed-set tabbed-alternate" data-tabs="10:4"><input checked="checked" id="zh-upgrading-__tabbed_10_1" name="zh-upgrading-__tabbed_10" type="radio" /><input id="zh-upgrading-__tabbed_10_2" name="zh-upgrading-__tabbed_10" type="radio" /><input id="zh-upgrading-__tabbed_10_3" name="zh-upgrading-__tabbed_10" type="radio" /><input id="zh-upgrading-__tabbed_10_4" name="zh-upgrading-__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_10_1">SQLite</label><label for="zh-upgrading-__tabbed_10_2">MariaDB</label><label for="zh-upgrading-__tabbed_10_3">MySQL</label><label for="zh-upgrading-__tabbed_10_4">PostgreSQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="tabbed-set tabbed-alternate" data-tabs="11:2"><input checked="checked" id="zh-upgrading-__tabbed_11_1" name="zh-upgrading-__tabbed_11" type="radio" /><input id="zh-upgrading-__tabbed_11_2" name="zh-upgrading-__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_11_1">Docker</label><label for="zh-upgrading-__tabbed_11_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>我们首先需要在容器中安装 <code>sqlite</code> 包。</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>-it<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>sqlite
</code></pre></div>
<p>然后，备份数据库。</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>sqlite3<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3<span class="w"> </span><span class="s2">&quot;.dump&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>sqlite3<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3<span class="w"> </span><span class="s2">&quot;.dump&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<div class="tabbed-set tabbed-alternate" data-tabs="12:2"><input checked="checked" id="zh-upgrading-__tabbed_12_1" name="zh-upgrading-__tabbed_12" type="radio" /><input id="zh-upgrading-__tabbed_12_2" name="zh-upgrading-__tabbed_12" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_12_1">Docker</label><label for="zh-upgrading-__tabbed_12_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>-e<span class="w"> </span><span class="nv">MYSQL_PWD</span><span class="o">=</span>&lt;database_password&gt;<span class="w"> </span>&lt;database_container&gt;<span class="w"> </span>mariadb-dump<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&gt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nv">MYSQL_PWD</span><span class="o">=</span>&lt;database_password&gt;<span class="w"> </span>mariadb-dump<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&gt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<div class="tabbed-set tabbed-alternate" data-tabs="13:2"><input checked="checked" id="zh-upgrading-__tabbed_13_1" name="zh-upgrading-__tabbed_13" type="radio" /><input id="zh-upgrading-__tabbed_13_2" name="zh-upgrading-__tabbed_13" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_13_1">Docker</label><label for="zh-upgrading-__tabbed_13_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>-e<span class="w"> </span><span class="nv">MYSQL_PWD</span><span class="o">=</span>&lt;database_password&gt;<span class="w"> </span>&lt;database_container&gt;<span class="w"> </span>mysqldump<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&gt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nv">MYSQL_PWD</span><span class="o">=</span>&lt;database_password&gt;<span class="w"> </span>mysqldump<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&gt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<div class="tabbed-set tabbed-alternate" data-tabs="14:2"><input checked="checked" id="zh-upgrading-__tabbed_14_1" name="zh-upgrading-__tabbed_14" type="radio" /><input id="zh-upgrading-__tabbed_14_2" name="zh-upgrading-__tabbed_14" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_14_1">Docker</label><label for="zh-upgrading-__tabbed_14_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>-e<span class="w"> </span><span class="nv">PGPASSWORD</span><span class="o">=</span>&lt;database_password&gt;<span class="w"> </span>&lt;database_container&gt;<span class="w"> </span>pg_dump<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&gt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="nv">PGPASSWORD</span><span class="o">=</span>&lt;database_password&gt;<span class="w"> </span>pg_dump<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&gt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>升级 BunkerWeb</strong>：</p>
<ul>
<li>
<p>将 BunkerWeb 升级到最新版本。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="15:2"><input checked="checked" id="zh-upgrading-__tabbed_15_1" name="zh-upgrading-__tabbed_15" type="radio" /><input id="zh-upgrading-__tabbed_15_2" name="zh-upgrading-__tabbed_15" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_15_1">Docker</label><label for="zh-upgrading-__tabbed_15_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>
<p><strong>更新 Docker Compose 文件</strong>：更新 Docker Compose 文件以使用新版本的 BunkerWeb 镜像。
    <div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:testing</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:testing</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:testing</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div></p>
</li>
<li>
<p><strong>重启容器</strong>：重启容器以应用更改。
    <div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>down
docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div></p>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>停止服务</strong>：
    <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>bunkerweb
sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>bunkerweb-ui
sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>bunkerweb-scheduler
</code></pre></div></p>
</li>
<li>
<p><strong>更新 BunkerWeb</strong>：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="16:2"><input checked="checked" id="zh-upgrading-__tabbed_16_1" name="zh-upgrading-__tabbed_16" type="radio" /><input id="zh-upgrading-__tabbed_16_2" name="zh-upgrading-__tabbed_16" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_16_1">Debian/Ubuntu</label><label for="zh-upgrading-__tabbed_16_2">Fedora/RedHat</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>首先，如果您之前锁定了 BunkerWeb 软件包，请解锁它：</p>
<p>您可以使用 <code>apt-mark showhold</code> 打印锁定的软件包列表</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-mark<span class="w"> </span>unhold<span class="w"> </span>bunkerweb<span class="w"> </span>nginx
</code></pre></div>
<p>然后，您可以更新 BunkerWeb 软件包：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--allow-downgrades<span class="w"> </span><span class="nv">bunkerweb</span><span class="o">=</span>testing
</code></pre></div>
<p>为了防止在执行 <code>apt upgrade</code> 时升级 BunkerWeb 软件包，您可以使用以下命令：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-mark<span class="w"> </span>hold<span class="w"> </span>bunkerweb<span class="w"> </span>nginx
</code></pre></div>
<p>更多详细信息请参阅<a href="#zh-integrations-__tabbed_1_1">Linux 集成页面</a>。</p>
</div>
<div class="tabbed-block">
<p>首先，如果您之前锁定了 BunkerWeb 软件包，请解锁它：</p>
<p>您可以使用 <code>dnf versionlock list</code> 打印锁定的软件包列表</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>delete<span class="w"> </span>package<span class="w"> </span>bunkerweb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>delete<span class="w"> </span>package<span class="w"> </span>nginx
</code></pre></div>
<p>然后，您可以更新 BunkerWeb 软件包：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>makecache<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--allowerasing<span class="w"> </span>bunkerweb-testing
</code></pre></div>
<p>为了防止在执行 <code>dnf upgrade</code> 时升级 BunkerWeb 软件包，您可以使用以下命令：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>add<span class="w"> </span>bunkerweb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>dnf<span class="w"> </span>versionlock<span class="w"> </span>add<span class="w"> </span>nginx
</code></pre></div>
<p>更多详细信息请参阅<a href="#zh-integrations-__tabbed_1_3">Linux 集成页面</a>。</p>
</div>
</div>
</div>
</li>
<li>
<p><strong>启动服务</strong>：
        <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb-ui
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
        或者重启系统：
        <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>reboot
</code></pre></div></p>
</li>
</ol>
</div>
</div>
</div>
</li>
</ul>
</li>
<li>
<p><strong>检查日志</strong>：检查调度器服务的日志以确保迁移成功。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="17:2"><input checked="checked" id="zh-upgrading-__tabbed_17_1" name="zh-upgrading-__tabbed_17" type="radio" /><input id="zh-upgrading-__tabbed_17_2" name="zh-upgrading-__tabbed_17" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_17_1">Docker</label><label for="zh-upgrading-__tabbed_17_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>logs<span class="w"> </span>&lt;scheduler_container&gt;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>journalctl<span class="w"> </span>-u<span class="w"> </span>bunkerweb<span class="w"> </span>--no-pager
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p><strong>验证数据库</strong>：通过检查新数据库容器中的数据和配置来验证数据库升级是否成功。</p>
</li>
</ol>
<h3 id="zh-upgrading-_9">回滚</h3>
<div class="admonition failure">
<p class="admonition-title">如果出现问题</p>
<p>如果您在升级过程中遇到任何问题，您可以通过恢复在<a href="#zh-upgrading-__tabbed_1_1">步骤 1</a>中创建的备份来回滚到数据库的先前版本。</p>
<p>获取支持和更多信息：</p>
<ul>
<li><a href="https://panel.bunkerweb.io/?utm_source=doc&amp;utm_campaign=self">订购专业支持</a></li>
<li><a href="https://github.com/bunkerity/bunkerweb/issues">在 GitHub 上创建问题</a></li>
<li><a href="https://discord.bunkerity.com">加入 BunkerWeb Discord 服务器</a></li>
</ul>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="18:2"><input checked="checked" id="zh-upgrading-__tabbed_18_1" name="zh-upgrading-__tabbed_18" type="radio" /><input id="zh-upgrading-__tabbed_18_2" name="zh-upgrading-__tabbed_18" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_18_1">Docker</label><label for="zh-upgrading-__tabbed_18_2">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>
<p><strong>如果备份是 zip 文件，请先解压</strong>。</p>
<p>首先解压备份 zip 文件：</p>
<div class="highlight"><pre><span></span><code>unzip<span class="w"> </span>/path/to/backup/directory/backup.zip<span class="w"> </span>-d<span class="w"> </span>/path/to/backup/directory/
</code></pre></div>
</li>
<li>
<p><strong>恢复备份</strong>。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="19:3"><input checked="checked" id="zh-upgrading-__tabbed_19_1" name="zh-upgrading-__tabbed_19" type="radio" /><input id="zh-upgrading-__tabbed_19_2" name="zh-upgrading-__tabbed_19" type="radio" /><input id="zh-upgrading-__tabbed_19_3" name="zh-upgrading-__tabbed_19" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_19_1">SQLite</label><label for="zh-upgrading-__tabbed_19_2">MySQL/MariaDB</label><label for="zh-upgrading-__tabbed_19_3">PostgreSQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>
<p><strong>删除现有的数据库文件。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>-i<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
</code></pre></div>
</li>
<li>
<p><strong>恢复备份。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-i<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>sqlite3<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</li>
<li>
<p><strong>修复权限。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>-i<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>chown<span class="w"> </span>root:nginx<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>-i<span class="w"> </span>&lt;scheduler_container&gt;<span class="w"> </span>chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
</code></pre></div>
</li>
<li>
<p><strong>停止堆栈。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>down
</code></pre></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>恢复备份。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-e<span class="w"> </span><span class="nv">MYSQL_PWD</span><span class="o">=</span>&lt;your_password&gt;<span class="w"> </span>-i<span class="w"> </span>&lt;database_container&gt;<span class="w"> </span>mysql<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</li>
<li>
<p><strong>停止堆栈。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>down
</code></pre></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>删除现有的数据库。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-i<span class="w"> </span>&lt;database_container&gt;<span class="w"> </span>dropdb<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>--force<span class="w"> </span>&lt;database_name&gt;
</code></pre></div>
</li>
<li>
<p><strong>重新创建数据库。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-i<span class="w"> </span>&lt;database_container&gt;<span class="w"> </span>createdb<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>&lt;database_name&gt;
</code></pre></div>
</li>
<li>
<p><strong>恢复备份。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-i<span class="w"> </span>&lt;database_container&gt;<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</li>
<li>
<p><strong>停止堆栈。</strong></p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>down
</code></pre></div>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p><strong>降级 BunkerWeb</strong>。</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bunkerweb</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb:&lt;old_version&gt;</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:&lt;old_version&gt;</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-autoconf</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-autoconf:&lt;old_version&gt;</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">bw-ui</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-ui:&lt;old_version&gt;</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
</li>
<li>
<p><strong>启动容器</strong>。</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>如果备份是 zip 文件，请先解压</strong>。</p>
<p>首先解压备份 zip 文件：</p>
<div class="highlight"><pre><span></span><code>unzip<span class="w"> </span>/path/to/backup/directory/backup.zip<span class="w"> </span>-d<span class="w"> </span>/path/to/backup/directory/
</code></pre></div>
</li>
<li>
<p><strong>停止服务</strong>。</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>bunkerweb<span class="w"> </span>bunkerweb-ui<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</li>
<li>
<p><strong>恢复备份</strong>。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="20:3"><input checked="checked" id="zh-upgrading-__tabbed_20_1" name="zh-upgrading-__tabbed_20" type="radio" /><input id="zh-upgrading-__tabbed_20_2" name="zh-upgrading-__tabbed_20" type="radio" /><input id="zh-upgrading-__tabbed_20_3" name="zh-upgrading-__tabbed_20" type="radio" /><div class="tabbed-labels"><label for="zh-upgrading-__tabbed_20_1">SQLite</label><label for="zh-upgrading-__tabbed_20_2">MySQL/MariaDB</label><label for="zh-upgrading-__tabbed_20_3">PostgreSQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
sudo<span class="w"> </span>sqlite3<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
sudo<span class="w"> </span>chown<span class="w"> </span>root:nginx<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>mysql<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</div>
<div class="tabbed-block">
<ol>
<li>
<p><strong>删除现有的数据库。</strong></p>
<div class="highlight"><pre><span></span><code>dropdb<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>--force<span class="w"> </span>&lt;database_name&gt;
</code></pre></div>
</li>
<li>
<p><strong>重新创建数据库。</strong></p>
<div class="highlight"><pre><span></span><code>createdb<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>&lt;database_name&gt;
</code></pre></div>
</li>
<li>
<p><strong>恢复备份。</strong></p>
<div class="highlight"><pre><span></span><code>psql<span class="w"> </span>-U<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;database_name&gt;<span class="w"> </span>&lt;<span class="w"> </span>/path/to/backup/directory/backup.sql
</code></pre></div>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p><strong>启动服务</strong>。</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>bunkerweb<span class="w"> </span>bunkerweb-ui<span class="w"> </span>bunkerweb-scheduler
</code></pre></div>
</li>
<li>
<p><strong>降级 BunkerWeb</strong>。</p>
<ul>
<li>按照<a href="#zh-integrations-linux">Linux 集成页面</a>中升级 BunkerWeb 的相同步骤，将 BunkerWeb 降级到以前的版本。</li>
</ul>
</li>
</ol>
</div>
</div>
</div></section><section class="print-page" id="zh-troubleshooting" heading-number="10"><h1 id="zh-troubleshooting-_1">故障排除</h1>
<div class="admonition info">
<p class="admonition-title">BunkerWeb 面板</p>
<p>如果您无法解决您的问题，您可以通过我们的面板<a href="https://panel.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc">直接联系我们</a>。这里集中了与 BunkerWeb 解决方案相关的所有请求。</p>
</div>
<h2 id="zh-troubleshooting-_2">日志</h2>
<p>在进行故障排除时，日志是您最好的朋友。我们尽力提供用户友好的日志，以帮助您了解正在发生的事情。</p>
<p>请注意，您可以将 <code>LOG_LEVEL</code> 设置为 <code>info</code>（默认值为 <code>notice</code>），以增加 BunkerWeb 的详细程度。</p>
<p>根据您的集成方式，以下是如何访问日志的方法：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:6"><input checked="checked" id="zh-troubleshooting-__tabbed_1_1" name="zh-troubleshooting-__tabbed_1" type="radio" /><input id="zh-troubleshooting-__tabbed_1_2" name="zh-troubleshooting-__tabbed_1" type="radio" /><input id="zh-troubleshooting-__tabbed_1_3" name="zh-troubleshooting-__tabbed_1" type="radio" /><input id="zh-troubleshooting-__tabbed_1_4" name="zh-troubleshooting-__tabbed_1" type="radio" /><input id="zh-troubleshooting-__tabbed_1_5" name="zh-troubleshooting-__tabbed_1" type="radio" /><input id="zh-troubleshooting-__tabbed_1_6" name="zh-troubleshooting-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="zh-troubleshooting-__tabbed_1_1">Docker</label><label for="zh-troubleshooting-__tabbed_1_2">Docker autoconf</label><label for="zh-troubleshooting-__tabbed_1_3">All-in-one</label><label for="zh-troubleshooting-__tabbed_1_4">Swarm</label><label for="zh-troubleshooting-__tabbed_1_5">Kubernetes</label><label for="zh-troubleshooting-__tabbed_1_6">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">列出容器</p>
<p>要列出正在运行的容器，您可以使用以下命令：
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>ps
</code></pre></div></p>
</div>
<p>您可以使用 <code>docker logs</code> 命令（将 <code>bunkerweb</code> 替换为您的容器名称）：
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>logs<span class="w"> </span>bunkerweb
</code></pre></div></p>
<p>这是 docker-compose 的等效命令（将 <code>bunkerweb</code> 替换为 docker-compose.yml 文件中声明的服务名称）：
<div class="highlight"><pre><span></span><code>docker-compose<span class="w"> </span>logs<span class="w"> </span>bunkerweb
</code></pre></div></p>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">列出容器</p>
<p>要列出正在运行的容器，您可以使用以下命令：
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>ps
</code></pre></div></p>
</div>
<p>您可以使用 <code>docker logs</code> 命令（将 <code>bunkerweb</code> 和 <code>bw-autoconf</code> 替换为您的容器名称）：
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>logs<span class="w"> </span>bunkerweb
docker<span class="w"> </span>logs<span class="w"> </span>bw-autoconf
</code></pre></div></p>
<p>这是 docker-compose 的等效命令（将 <code>bunkerweb</code> 和 <code>bw-autoconf</code> 替换为 docker-compose.yml 文件中声明的服务名称）：
<div class="highlight"><pre><span></span><code>docker-compose<span class="w"> </span>logs<span class="w"> </span>bunkerweb
docker-compose<span class="w"> </span>logs<span class="w"> </span>bw-autoconf
</code></pre></div></p>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">容器名称</p>
<p>一体化镜像的默认容器名称是 <code>bunkerweb-aio</code>。如果您使用了不同的名称，请相应地调整命令。</p>
</div>
<p>您可以使用 <code>docker logs</code> 命令：
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>logs<span class="w"> </span>bunkerweb-aio
</code></pre></div></p>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
<p><strong>更多信息可以在 <a href="#zh-integrations-swarm">Swarm 集成文档</a>中找到。</strong></p>
</div>
<div class="admonition tip">
<p class="admonition-title">列出服务</p>
<p>要列出服务，您可以使用以下命令：
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>service<span class="w"> </span>ls
</code></pre></div></p>
</div>
<p>您可以使用 <code>docker service logs</code> 命令（将 <code>bunkerweb</code> 和 <code>bw-autoconf</code> 替换为您的服务名称）：
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>service<span class="w"> </span>logs<span class="w"> </span>bunkerweb
docker<span class="w"> </span>service<span class="w"> </span>logs<span class="w"> </span>bw-autoconf
</code></pre></div></p>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">列出 Pod</p>
<p>要列出 Pod，您可以使用以下命令：
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>get<span class="w"> </span>pods
</code></pre></div></p>
</div>
<p>您可以使用 <code>kubectl logs</code> 命令（将 <code>bunkerweb</code> 和 <code>bunkerweb-controler</code> 替换为您的 Pod 名称）：
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>logs<span class="w"> </span>bunkerweb
kubectl<span class="w"> </span>logs<span class="w"> </span>bunkerweb-controler
</code></pre></div></p>
</div>
<div class="tabbed-block">
<p>对于与 BunkerWeb 服务相关的错误（例如，无法启动），您可以使用 <code>journalctl</code>：
<div class="highlight"><pre><span></span><code>journalctl<span class="w"> </span>-u<span class="w"> </span>bunkerweb<span class="w"> </span>--no-pager
</code></pre></div></p>
<p>通用日志位于 <code>/var/log/bunkerweb</code> 目录中：
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span>/var/log/bunkerweb/error.log
cat<span class="w"> </span>/var/log/bunkerweb/access.log
</code></pre></div></p>
</div>
</div>
</div>
<h2 id="zh-troubleshooting-_3">权限</h2>
<p>不要忘记，出于明显的安全原因，BunkerWeb 是以非特权用户身份运行的。请仔细检查 BunkerWeb 使用的文件和文件夹的权限，特别是如果您使用自定义配置（更多信息请参见<a href="#zh-advanced-custom-configurations">此处</a>）。您需要为文件设置至少 <strong><em>RW</em></strong> 权限，为文件夹设置 <strong><em>RWX</em></strong> 权限。</p>
<h2 id="zh-troubleshooting-ip">IP 解封</h2>
<p>您可以手动解封一个 IP，这在进行测试时很有用，这样您就可以联系 BunkerWeb 的内部 API（将 <code>1.2.3.4</code> 替换为要解封的 IP 地址）：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:5"><input checked="checked" id="zh-troubleshooting-__tabbed_2_1" name="zh-troubleshooting-__tabbed_2" type="radio" /><input id="zh-troubleshooting-__tabbed_2_2" name="zh-troubleshooting-__tabbed_2" type="radio" /><input id="zh-troubleshooting-__tabbed_2_3" name="zh-troubleshooting-__tabbed_2" type="radio" /><input id="zh-troubleshooting-__tabbed_2_4" name="zh-troubleshooting-__tabbed_2" type="radio" /><input id="zh-troubleshooting-__tabbed_2_5" name="zh-troubleshooting-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="zh-troubleshooting-__tabbed_2_1">Docker / Docker Autoconf</label><label for="zh-troubleshooting-__tabbed_2_2">All-in-one</label><label for="zh-troubleshooting-__tabbed_2_3">Swarm</label><label for="zh-troubleshooting-__tabbed_2_4">Kubernetes</label><label for="zh-troubleshooting-__tabbed_2_5">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>您可以使用 <code>docker exec</code> 命令（将 <code>bw-scheduler</code> 替换为您的容器名称）：
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>bw-scheduler<span class="w"> </span>bwcli<span class="w"> </span>unban<span class="w"> </span><span class="m">1</span>.2.3.4
</code></pre></div></p>
<p>这是 docker-compose 的等效命令（将 <code>bw-scheduler</code> 替换为 docker-compose.yml 文件中声明的服务名称）：
<div class="highlight"><pre><span></span><code>docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>bw-scheduler<span class="w"> </span>bwcli<span class="w"> </span>unban<span class="w"> </span><span class="m">1</span>.2.3.4
</code></pre></div></p>
</div>
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">容器名称</p>
<p>一体化镜像的默认容器名称是 <code>bunkerweb-aio</code>。如果您使用了不同的名称，请相应地调整命令。</p>
</div>
<p>您可以使用 <code>docker exec</code> 命令：
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>bunkerweb-aio<span class="w"> </span>bwcli<span class="w"> </span>unban<span class="w"> </span><span class="m">1</span>.2.3.4
</code></pre></div></p>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
<p><strong>更多信息可以在 <a href="#zh-integrations-swarm">Swarm 集成文档</a>中找到。</strong></p>
</div>
<p>您可以使用 <code>docker exec</code> 命令（将 <code>bw-scheduler</code> 替换为您的服务名称）：
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="k">$(</span>docker<span class="w"> </span>ps<span class="w"> </span>-q<span class="w"> </span>-f<span class="w"> </span><span class="nv">name</span><span class="o">=</span>bw-scheduler<span class="k">)</span><span class="w"> </span>bwcli<span class="w"> </span>unban<span class="w"> </span><span class="m">1</span>.2.3.4
</code></pre></div></p>
</div>
<div class="tabbed-block">
<p>您可以使用 <code>kubectl exec</code> 命令（将 <code>bunkerweb-scheduler</code> 替换为您的 Pod 名称）：
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>bunkerweb-scheduler<span class="w"> </span>bwcli<span class="w"> </span>unban<span class="w"> </span><span class="m">1</span>.2.3.4
</code></pre></div></p>
</div>
<div class="tabbed-block">
<p>您可以使用 <code>bwcli</code> 命令（以 root 身份）：
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>bwcli<span class="w"> </span>unban<span class="w"> </span><span class="m">1</span>.2.3.4
</code></pre></div></p>
</div>
</div>
</div>
<h2 id="zh-troubleshooting-_4">误报</h2>
<h3 id="zh-troubleshooting-_5">仅检测模式</h3>
<p>为了进行调试/测试，您可以将 BunkerWeb 设置为<a href="#zh-features-security-modes">仅检测模式</a>，这样它就不会阻止请求，而是像一个经典的反向代理一样工作。</p>
<h3 id="zh-troubleshooting-modsecurity">ModSecurity</h3>
<p>BunkerWeb 中 ModSecurity 的默认配置是以异常评分模式加载核心规则集，偏执级别 (PL) 为 1：</p>
<ul>
<li>每条匹配的规则都会增加一个异常分数（因此许多规则可以匹配单个请求）</li>
<li>PL1 包含误报率较低的规则（但安全性低于 PL4）</li>
<li>请求的异常分数默认阈值为 5，响应为 4</li>
</ul>
<p>让我们以以下使用默认配置的 ModSecurity 检测日志为例（为了更好的可读性进行了格式化）：</p>
<div class="highlight"><pre><span></span><code>2022/04/26 12:01:10 [warn] 85#85: *11 ModSecurity: Warning. Matched &quot;Operator `PmFromFile&#39; with parameter `lfi-os-files.data&#39; against variable `ARGS:id&#39; (Value: `/etc/passwd&#39; )
    [file &quot;/usr/share/bunkerweb/core/modsecurity/files/coreruleset/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf&quot;]
    [line &quot;78&quot;]
    [id &quot;930120&quot;]
    [rev &quot;&quot;]
    [msg &quot;OS File Access Attempt&quot;]
    [data &quot;Matched Data: etc/passwd found within ARGS:id: /etc/passwd&quot;]
    [severity &quot;2&quot;]
    [ver &quot;OWASP_CRS/3.3.2&quot;]
    [maturity &quot;0&quot;]
    [accuracy &quot;0&quot;]
    [tag &quot;application-multi&quot;]
    [tag &quot;language-multi&quot;]
    [tag &quot;platform-multi&quot;]
    [tag &quot;attack-lfi&quot;]
    [tag &quot;paranoia-level/1&quot;]
    [tag &quot;OWASP_CRS&quot;]
    [tag &quot;capec/1000/255/153/126&quot;]
    [tag &quot;PCI/6.5.4&quot;]
    [hostname &quot;172.17.0.2&quot;]
    [uri &quot;/&quot;]
    [unique_id &quot;165097447014.179282&quot;]
    [ref &quot;o1,10v9,11t:utf8toUnicode,t:urlDecodeUni,t:normalizePathWin,t:lowercase&quot;],
    client: 172.17.0.1, server: localhost, request: &quot;GET /?id=/etc/passwd HTTP/1.1&quot;, host: &quot;localhost&quot;
2022/04/26 12:01:10 [warn] 85#85: *11 ModSecurity: Warning. Matched &quot;Operator `PmFromFile&#39; with parameter `unix-shell.data&#39; against variable `ARGS:id&#39; (Value: `/etc/passwd&#39; )
    [file &quot;/usr/share/bunkerweb/core/modsecurity/files/coreruleset/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf&quot;]
    [line &quot;480&quot;]
    [id &quot;932160&quot;]
    [rev &quot;&quot;]
    [msg &quot;Remote Command Execution: Unix Shell Code Found&quot;]
    [data &quot;Matched Data: etc/passwd found within ARGS:id: /etc/passwd&quot;]
    [severity &quot;2&quot;]
    [ver &quot;OWASP_CRS/3.3.2&quot;]
    [maturity &quot;0&quot;]
    [accuracy &quot;0&quot;]
    [tag &quot;application-multi&quot;]
    [tag &quot;language-shell&quot;]
    [tag &quot;platform-unix&quot;]
    [tag &quot;attack-rce&quot;]
    [tag &quot;paranoia-level/1&quot;]
    [tag &quot;OWASP_CRS&quot;]
    [tag &quot;capec/1000/152/248/88&quot;]
    [tag &quot;PCI/6.5.2&quot;]
    [hostname &quot;172.17.0.2&quot;]
    [uri &quot;/&quot;]
    [unique_id &quot;165097447014.179282&quot;]
    [ref &quot;o1,10v9,11t:urlDecodeUni,t:cmdLine,t:normalizePath,t:lowercase&quot;],
    client: 172.17.0.1, server: localhost, request: &quot;GET /?id=/etc/passwd HTTP/1.1&quot;, host: &quot;localhost&quot;
2022/04/26 12:01:10 [error] 85#85: *11 [client 172.17.0.1] ModSecurity: Access denied with code 403 (phase 2). Matched &quot;Operator `Ge&#39; with parameter `5&#39; against variable `TX:ANOMALY_SCORE&#39; (Value: `10&#39; )
    [file &quot;/usr/share/bunkerweb/core/modsecurity/files/coreruleset/rules/REQUEST-949-BLOCKING-EVALUATION.conf&quot;]
    [line &quot;80&quot;]
    [id &quot;949110&quot;]
    [rev &quot;&quot;]
    [msg &quot;Inbound Anomaly Score Exceeded (Total Score: 10)&quot;]
    [data &quot;&quot;]
    [severity &quot;2&quot;]
    [ver &quot;OWASP_CRS/3.3.2&quot;]
    [maturity &quot;0&quot;]
    [accuracy &quot;0&quot;]
    [tag &quot;application-multi&quot;]
    [tag &quot;language-multi&quot;]
    [tag &quot;platform-multi&quot;]
    [tag &quot;attack-generic&quot;]
    [hostname &quot;172.17.0.2&quot;]
    [uri &quot;/&quot;]
    [unique_id &quot;165097447014.179282&quot;]
    [ref &quot;&quot;],
    client: 172.17.0.1, server: localhost, request: &quot;GET /?id=/etc/passwd HTTP/1.1&quot;, host: &quot;localhost&quot;
</code></pre></div>
<p>正如我们所见，有 3 条不同的日志：</p>
<ol>
<li>规则 <strong>930120</strong> 匹配</li>
<li>规则 <strong>932160</strong> 匹配</li>
<li>访问被拒绝（规则 <strong>949110</strong>）</li>
</ol>
<p>需要理解的一个重要事项是，规则 <strong>949110</strong> 并不是一个“真正”的规则：它是因为异常阈值达到（在本例中为 <strong>10</strong>）而拒绝请求的规则。您永远不应该删除 <strong>949110</strong> 规则！</p>
<p>如果是误报，您应该关注 <strong>930120</strong> 和 <strong>932160</strong> 规则。ModSecurity 和/或 CRS 的调整超出了本文档的范围，但不要忘记您可以在 CRS 加载前后应用自定义配置（更多信息请参见<a href="#zh-advanced-custom-configurations">此处</a>）。</p>
<h3 id="zh-troubleshooting-_6">不良行为</h3>
<p>一个常见的误报情况是由于“不良行为”功能导致客户端被封禁，这意味着在一段时间内产生了过多的可疑 HTTP 状态码（更多信息请参见<a href="#zh-features-bad-behavior">此处</a>）。您应该首先查看设置，然后根据您的 Web 应用程序进行编辑，例如删除可疑的 HTTP 代码、减少计数时间、增加阈值等。</p>
<h3 id="zh-troubleshooting-_7">白名单</h3>
<p>如果您有需要访问您网站的机器人（或管理员），推荐的方法是使用<a href="#zh-features-whitelist">白名单功能</a>将它们列入白名单，以避免任何误报。我们不建议使用 <code>WHITELIST_URI*</code> 或 <code>WHITELIST_USER_AGENT*</code> 设置，除非它们被设置为秘密且不可预测的值。常见的用例是：</p>
<ul>
<li>健康检查/状态机器人</li>
<li>回调，如 IPN 或 webhook</li>
<li>社交媒体爬虫</li>
</ul>
<h2 id="zh-troubleshooting-_8">常见错误</h2>
<h3 id="zh-troubleshooting-_9">上游发送了过大的标头</h3>
<p>如果您在日志中看到以下错误 <code>upstream sent too big header while reading response header from upstream</code>，您将需要使用以下设置来调整各种代理缓冲区大小：</p>
<ul>
<li><code>PROXY_BUFFERS</code></li>
<li><code>PROXY_BUFFER_SIZE</code></li>
<li><code>PROXY_BUSY_BUFFERS_SIZE</code></li>
</ul>
<h3 id="zh-troubleshooting-server_names_hash">无法构建 server_names_hash</h3>
<p>如果您在日志中看到以下错误 <code>could not build server_names_hash, you should increase server_names_hash_bucket_size</code>，您将需要调整 <code>SERVER_NAMES_HASH_BUCKET_SIZE</code> 设置。</p>
<h2 id="zh-troubleshooting-_10">时区</h2>
<p>当使用基于容器的集成时，容器的时区可能与主机的时区不匹配。要解决此问题，您可以在您的容器上将 <code>TZ</code> 环境变量设置为您选择的时区（例如 <code>TZ=Europe/Paris</code>）。您可以在<a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones#List">此处</a>找到时区标识符的列表。</p>
<h2 id="zh-troubleshooting-web-ui">Web UI</h2>
<p>如果您忘记了 UI 凭据或遇到 2FA 问题，您可以连接到数据库以重新获得访问权限。</p>
<h3 id="zh-troubleshooting-_11">访问数据库</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="3:3"><input checked="checked" id="zh-troubleshooting-__tabbed_3_1" name="zh-troubleshooting-__tabbed_3" type="radio" /><input id="zh-troubleshooting-__tabbed_3_2" name="zh-troubleshooting-__tabbed_3" type="radio" /><input id="zh-troubleshooting-__tabbed_3_3" name="zh-troubleshooting-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="zh-troubleshooting-__tabbed_3_1">SQLite</label><label for="zh-troubleshooting-__tabbed_3_2">MariaDB / MySQL</label><label for="zh-troubleshooting-__tabbed_3_3">PostgreSQL</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="tabbed-set tabbed-alternate" data-tabs="4:3"><input checked="checked" id="zh-troubleshooting-__tabbed_4_1" name="zh-troubleshooting-__tabbed_4" type="radio" /><input id="zh-troubleshooting-__tabbed_4_2" name="zh-troubleshooting-__tabbed_4" type="radio" /><input id="zh-troubleshooting-__tabbed_4_3" name="zh-troubleshooting-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="zh-troubleshooting-__tabbed_4_1">Linux</label><label for="zh-troubleshooting-__tabbed_4_2">Docker</label><label for="zh-troubleshooting-__tabbed_4_3">All-in-one</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>安装 SQLite (Debian/Ubuntu)：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>sqlite3
</code></pre></div>
<p>安装 SQLite (Fedora/RedHat)：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>sqlite
</code></pre></div>
</div>
<div class="tabbed-block">
<p>进入您的调度器容器的 shell：</p>
<div class="admonition note">
<p class="admonition-title">Docker 参数</p>
<ul>
<li><code>-u 0</code> 选项用于以 root 身份运行命令（强制）</li>
<li><code>-it</code> 选项用于以交互方式运行命令（强制）</li>
<li><code>&lt;bunkerweb_scheduler_container&gt;</code>：您的调度器容器的名称或 ID</li>
</ul>
</div>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>-it<span class="w"> </span>&lt;bunkerweb_scheduler_container&gt;<span class="w"> </span>bash
</code></pre></div>
<p>安装 SQLite：</p>
<div class="highlight"><pre><span></span><code>apk<span class="w"> </span>add<span class="w"> </span>sqlite
</code></pre></div>
</div>
<div class="tabbed-block">
<p>进入您的 All-in-one 容器的 shell：</p>
<div class="admonition note">
<p class="admonition-title">Docker 参数</p>
<ul>
<li><code>-u 0</code> 选项用于以 root 身份运行命令（强制）。</li>
<li><code>-it</code> 选项用于以交互方式运行命令（强制）。</li>
<li><code>bunkerweb-aio</code> 是默认的容器名称；如果您使用了自定义名称，请进行调整。</li>
</ul>
</div>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>-it<span class="w"> </span>bunkerweb-aio<span class="w"> </span>bash
</code></pre></div>
</div>
</div>
</div>
<p>访问您的数据库：</p>
<div class="admonition note">
<p class="admonition-title">数据库路径</p>
<p>我们假设您正在使用默认的数据库路径。如果您正在使用自定义路径，您需要调整该命令。
对于 All-in-one，我们假设数据库是位于持久化 <code>/data</code> 卷中的 <code>db.sqlite3</code> (<code>/data/db.sqlite3</code>)。</p>
</div>
<div class="highlight"><pre><span></span><code>sqlite3<span class="w"> </span>/var/lib/bunkerweb/db.sqlite3
</code></pre></div>
<p>您应该会看到类似这样的内容：</p>
<div class="highlight"><pre><span></span><code>SQLite version &lt;VER&gt; &lt;DATE&gt;
Enter &quot;.help&quot; for usage hints.
sqlite&gt;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition note">
<p class="admonition-title">仅限 MariaDB / MySQL</p>
<p>以下步骤仅适用于 MariaDB / MySQL 数据库。如果您正在使用其他数据库，请参阅您数据库的文档。</p>
</div>
<div class="admonition note">
<p class="admonition-title">凭据和数据库名称</p>
<p>您将需要使用 <code>DATABASE_URI</code> 设置中使用的相同凭据和数据库名称。</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="zh-troubleshooting-__tabbed_5_1" name="zh-troubleshooting-__tabbed_5" type="radio" /><input id="zh-troubleshooting-__tabbed_5_2" name="zh-troubleshooting-__tabbed_5" type="radio" /><input id="zh-troubleshooting-__tabbed_5_3" name="zh-troubleshooting-__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="zh-troubleshooting-__tabbed_5_1">Linux</label><label for="zh-troubleshooting-__tabbed_5_2">Docker</label><label for="zh-troubleshooting-__tabbed_5_3">All-in-one</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>访问您的本地数据库：</p>
<div class="highlight"><pre><span></span><code>mysql<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;database&gt;
</code></pre></div>
<p>然后输入数据库用户的密码，您就应该能够访问您的数据库了。</p>
</div>
<div class="tabbed-block">
<p>访问您的数据库容器：</p>
<div class="admonition note">
<p class="admonition-title">Docker 参数</p>
<ul>
<li><code>-u 0</code> 选项用于以 root 身份运行命令（强制）</li>
<li><code>-it</code> 选项用于以交互方式运行命令（强制）</li>
<li><code>&lt;bunkerweb_db_container&gt;</code>：您的数据库容器的名称或 ID</li>
<li><code>&lt;user&gt;</code>：数据库用户</li>
<li><code>&lt;database&gt;</code>：数据库名称</li>
</ul>
</div>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>-it<span class="w"> </span>&lt;bunkerweb_db_container&gt;<span class="w"> </span>mysql<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;database&gt;
</code></pre></div>
<p>然后输入数据库用户的密码，您就应该能够访问您的数据库了。</p>
</div>
<div class="tabbed-block">
<p>一体化镜像不包含 MariaDB/MySQL 服务器。如果您已将 AIO 配置为使用外部 MariaDB/MySQL 数据库（通过设置 <code>DATABASE_URI</code> 环境变量），您应使用标准的 MySQL 客户端工具直接连接到该数据库。</p>
<p>连接方法将类似于“Linux”选项卡（如果从运行 AIO 的主机或另一台机器连接），或者如果愿意，可以在一个单独的 Docker 容器中运行 MySQL 客户端，并指定您的外部数据库的主机和凭据。</p>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition note">
<p class="admonition-title">仅限 PostgreSQL</p>
<p>以下步骤仅适用于 PostgreSQL 数据库。如果您正在使用其他数据库，请参阅您数据库的文档。</p>
</div>
<div class="admonition note">
<p class="admonition-title">凭据、主机和数据库名称</p>
<p>您将需要使用 <code>DATABASE_URI</code> 设置中使用的相同凭据（用户/密码）、主机和数据库名称。</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="6:3"><input checked="checked" id="zh-troubleshooting-__tabbed_6_1" name="zh-troubleshooting-__tabbed_6" type="radio" /><input id="zh-troubleshooting-__tabbed_6_2" name="zh-troubleshooting-__tabbed_6" type="radio" /><input id="zh-troubleshooting-__tabbed_6_3" name="zh-troubleshooting-__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="zh-troubleshooting-__tabbed_6_1">Linux</label><label for="zh-troubleshooting-__tabbed_6_2">Docker</label><label for="zh-troubleshooting-__tabbed_6_3">All-in-one</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>访问您的本地数据库：</p>
<div class="highlight"><pre><span></span><code>psql<span class="w"> </span>-U<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;database&gt;
</code></pre></div>
<p>如果您的数据库在另一台主机上，请包含主机名/IP 和端口：</p>
<div class="highlight"><pre><span></span><code>psql<span class="w"> </span>-h<span class="w"> </span>&lt;host&gt;<span class="w"> </span>-p<span class="w"> </span><span class="m">5432</span><span class="w"> </span>-U<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;database&gt;
</code></pre></div>
<p>然后输入数据库用户的密码，您就应该能够访问您的数据库了。</p>
</div>
<div class="tabbed-block">
<p>访问您的数据库容器：</p>
<div class="admonition note">
<p class="admonition-title">Docker 参数</p>
<ul>
<li><code>-u 0</code> 选项用于以 root 身份运行命令（强制）</li>
<li><code>-it</code> 选项用于以交互方式运行命令（强制）</li>
<li><code>&lt;bunkerweb_db_container&gt;</code>：您的数据库容器的名称或 ID</li>
<li><code>&lt;user&gt;</code>：数据库用户</li>
<li><code>&lt;database&gt;</code>：数据库名称</li>
</ul>
</div>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>-it<span class="w"> </span>&lt;bunkerweb_db_container&gt;<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;database&gt;
</code></pre></div>
<p>如果数据库托管在其他地方，请相应地添加 <code>-h &lt;host&gt;</code> 和 <code>-p 5432</code> 选项。</p>
</div>
<div class="tabbed-block">
<p>一体化镜像不包含 PostgreSQL 服务器。如果您已将 AIO 配置为使用外部 PostgreSQL 数据库（通过设置 <code>DATABASE_URI</code> 环境变量），您应使用标准的 PostgreSQL 客户端工具直接连接到该数据库。</p>
<p>连接方法将类似于“Linux”选项卡（如果从运行 AIO 的主机或另一台机器连接），或者如果愿意，可以在一个单独的 Docker 容器中运行 PostgreSQL 客户端，并指定您的外部数据库的主机和凭据。</p>
</div>
</div>
</div>
</div>
</div>
</div>
<h3 id="zh-troubleshooting-_12">故障排除操作</h3>
<div class="admonition info">
<p class="admonition-title">表模式</p>
<p><code>bw_ui_users</code> 表的模式如下：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>空</th>
<th>键</th>
<th>默认</th>
<th>额外</th>
</tr>
</thead>
<tbody>
<tr>
<td>username</td>
<td>varchar(256)</td>
<td>NO</td>
<td>PRI</td>
<td>NULL</td>
<td></td>
</tr>
<tr>
<td>email</td>
<td>varchar(256)</td>
<td>YES</td>
<td>UNI</td>
<td>NULL</td>
<td></td>
</tr>
<tr>
<td>password</td>
<td>varchar(60)</td>
<td>NO</td>
<td></td>
<td>NULL</td>
<td></td>
</tr>
<tr>
<td>method</td>
<td>enum('ui','scheduler','autoconf','manual','wizard')</td>
<td>NO</td>
<td></td>
<td>NULL</td>
<td></td>
</tr>
<tr>
<td>admin</td>
<td>tinyint(1)</td>
<td>NO</td>
<td></td>
<td>NULL</td>
<td></td>
</tr>
<tr>
<td>theme</td>
<td>enum('light','dark')</td>
<td>NO</td>
<td></td>
<td>NULL</td>
<td></td>
</tr>
<tr>
<td>language</td>
<td>varchar(2)</td>
<td>NO</td>
<td></td>
<td>NULL</td>
<td></td>
</tr>
<tr>
<td>totp_secret</td>
<td>varchar(256)</td>
<td>YES</td>
<td></td>
<td>NULL</td>
<td></td>
</tr>
<tr>
<td>creation_date</td>
<td>datetime</td>
<td>NO</td>
<td></td>
<td>NULL</td>
<td></td>
</tr>
<tr>
<td>update_date</td>
<td>datetime</td>
<td>NO</td>
<td></td>
<td>NULL</td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="7:5"><input checked="checked" id="zh-troubleshooting-__tabbed_7_1" name="zh-troubleshooting-__tabbed_7" type="radio" /><input id="zh-troubleshooting-__tabbed_7_2" name="zh-troubleshooting-__tabbed_7" type="radio" /><input id="zh-troubleshooting-__tabbed_7_3" name="zh-troubleshooting-__tabbed_7" type="radio" /><input id="zh-troubleshooting-__tabbed_7_4" name="zh-troubleshooting-__tabbed_7" type="radio" /><input id="zh-troubleshooting-__tabbed_7_5" name="zh-troubleshooting-__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="zh-troubleshooting-__tabbed_7_1">检索用户名</label><label for="zh-troubleshooting-__tabbed_7_2">更新管理员用户密码</label><label for="zh-troubleshooting-__tabbed_7_3">为管理员用户禁用 2FA 认证</label><label for="zh-troubleshooting-__tabbed_7_4">刷新 2FA 恢复码</label><label for="zh-troubleshooting-__tabbed_7_5">导出配置和匿名日志</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>执行以下命令从 <code>bw_ui_users</code> 表中提取数据：</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">bw_ui_users</span><span class="p">;</span>
</code></pre></div>
<p>您应该会看到类似这样的内容：</p>
<table>
<thead>
<tr>
<th>用户名</th>
<th>电子邮件</th>
<th>密码</th>
<th>方法</th>
<th>管理员</th>
<th>主题</th>
<th>totp_secret</th>
<th>创建日期</th>
<th>更新日期</th>
</tr>
</thead>
<tbody>
<tr>
<td>***</td>
<td>***</td>
<td>***</td>
<td>manual</td>
<td>1</td>
<td>light</td>
<td>***</td>
<td>***</td>
<td>***</td>
</tr>
</tbody>
</table>
</div>
<div class="tabbed-block">
<p>您首先需要使用 bcrypt 算法对新密码进行哈希处理。</p>
<p>安装 Python bcrypt 库：</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>bcrypt
</code></pre></div>
<p>生成您的哈希值（将 <code>mypassword</code> 替换为您自己的密码）：</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;from bcrypt import hashpw, gensalt ; print(hashpw(b&quot;&quot;&quot;mypassword&quot;&quot;&quot;, gensalt(rounds=10)).decode(&quot;utf-8&quot;))&#39;</span>
</code></pre></div>
<p>您可以通过执行此命令来更新您的用户名/密码：</p>
<div class="highlight"><pre><span></span><code><span class="k">UPDATE</span><span class="w"> </span><span class="n">bw_ui_users</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&lt;password_hash&gt;&#39;</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>如果您在此命令之后再次检查您的 <code>bw_ui_users</code> 表：</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">bw_ui_users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>您应该会看到类似这样的内容：</p>
<table>
<thead>
<tr>
<th>用户名</th>
<th>电子邮件</th>
<th>密码</th>
<th>方法</th>
<th>管理员</th>
<th>主题</th>
<th>totp_secret</th>
<th>创建日期</th>
<th>更新日期</th>
</tr>
</thead>
<tbody>
<tr>
<td>***</td>
<td>***</td>
<td>***</td>
<td>manual</td>
<td>1</td>
<td>light</td>
<td>***</td>
<td>***</td>
<td>***</td>
</tr>
</tbody>
</table>
<p>您现在应该能够使用新凭据登录到 Web UI。</p>
</div>
<div class="tabbed-block">
<p>您可以通过执行此命令来停用 2FA：</p>
<div class="highlight"><pre><span></span><code><span class="k">UPDATE</span><span class="w"> </span><span class="n">bw_ui_users</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">totp_secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>如果您在此命令之后再次检查您的 <code>bw_ui_users</code> 表：</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">bw_ui_users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</code></pre></div>
<p>您应该会看到类似这样的内容：</p>
<table>
<thead>
<tr>
<th>用户名</th>
<th>电子邮件</th>
<th>密码</th>
<th>方法</th>
<th>管理员</th>
<th>主题</th>
<th>totp_secret</th>
<th>创建日期</th>
<th>更新日期</th>
</tr>
</thead>
<tbody>
<tr>
<td>***</td>
<td>***</td>
<td>***</td>
<td>manual</td>
<td>1</td>
<td>light</td>
<td>NULL</td>
<td>***</td>
<td>***</td>
</tr>
</tbody>
</table>
<p>您现在应该能够仅使用您的用户名和密码登录 Web UI，而无需 2FA。</p>
</div>
<div class="tabbed-block">
<p>恢复码可以在 Web UI 的<strong>个人资料页面</strong>的 <code>安全</code> 选项卡下刷新。</p>
</div>
<div class="tabbed-block">
<p>使用 Web UI 中的<strong>支持页面</strong>来快速收集配置和日志以进行故障排除。</p>
<ul>
<li>打开 Web UI 并转到支持页面。</li>
<li>选择范围：导出全局配置或选择特定服务。</li>
<li>点击下载所选范围的配置存档。</li>
<li>可选地下载日志：导出的日志会自动匿名化（所有 IP 地址和域名都被屏蔽）。</li>
</ul>
</div>
</div>
</div>
<h3 id="zh-troubleshooting-_13">上传插件</h3>
<p>在某些情况下，可能无法从 UI 上传插件：</p>
<ul>
<li>您的集成缺少管理压缩文件的软件包，在这种情况下，您需要添加必要的软件包</li>
<li>Safari 浏览器：'安全模式'可能会阻止您添加插件。您需要在您的机器上进行必要的更改</li>
</ul></section><section class="print-page" id="zh-plugins" heading-number="11"><h1 id="zh-plugins-_1">插件</h1>
<p>BunkerWeb 附带一个插件系统，可以轻松添加新功能。安装插件后，您可以使用插件定义的其他设置来管理它。</p>
<h2 id="zh-plugins-_2">官方插件</h2>
<p>以下是我们维护的“官方”插件列表（更多信息请参阅 <a href="https://github.com/bunkerity/bunkerweb-plugins">bunkerweb-plugins</a> 仓库）：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">名称</th>
<th style="text-align: center;">版本</th>
<th style="text-align: left;">描述</th>
<th style="text-align: center;">链接</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>ClamAV</strong></td>
<td style="text-align: center;">1.9</td>
<td style="text-align: left;">使用 ClamAV 杀毒引擎自动扫描上传的文件，并在检测到文件为恶意时拒绝请求。</td>
<td style="text-align: center;"><a href="https://github.com/bunkerity/bunkerweb-plugins/tree/main/clamav">bunkerweb-plugins/clamav</a></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Coraza</strong></td>
<td style="text-align: center;">1.9</td>
<td style="text-align: left;">使用 Coraza WAF（ModSecurity 的替代品）检查请求。</td>
<td style="text-align: center;"><a href="https://github.com/bunkerity/bunkerweb-plugins/tree/main/coraza">bunkerweb-plugins/coraza</a></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Discord</strong></td>
<td style="text-align: center;">1.9</td>
<td style="text-align: left;">使用 Webhook 将安全通知发送到 Discord 频道。</td>
<td style="text-align: center;"><a href="https://github.com/bunkerity/bunkerweb-plugins/tree/main/discord">bunkerweb-plugins/discord</a></td>
</tr>
<tr>
<td style="text-align: center;"><strong>Slack</strong></td>
<td style="text-align: center;">1.9</td>
<td style="text-align: left;">使用 Webhook 将安全通知发送到 Slack 频道。</td>
<td style="text-align: center;"><a href="https://github.com/bunkerity/bunkerweb-plugins/tree/main/slack">bunkerweb-plugins/slack</a></td>
</tr>
<tr>
<td style="text-align: center;"><strong>VirusTotal</strong></td>
<td style="text-align: center;">1.9</td>
<td style="text-align: left;">使用 VirusTotal API 自动扫描上传的文件，并在检测到文件为恶意时拒绝请求。</td>
<td style="text-align: center;"><a href="https://github.com/bunkerity/bunkerweb-plugins/tree/main/virustotal">bunkerweb-plugins/virustotal</a></td>
</tr>
<tr>
<td style="text-align: center;"><strong>WebHook</strong></td>
<td style="text-align: center;">1.9</td>
<td style="text-align: left;">使用 Webhook 将安全通知发送到自定义 HTTP 端点。</td>
<td style="text-align: center;"><a href="https://github.com/bunkerity/bunkerweb-plugins/tree/main/webhook">bunkerweb-plugins/webhook</a></td>
</tr>
</tbody>
</table>
<h2 id="zh-plugins-_3">如何使用插件</h2>
<h3 id="zh-plugins-_4">自动</h3>
<p>如果您想快速安装外部插件，可以使用 <code>EXTERNAL_PLUGIN_URLS</code> 设置。它接受一个以空格分隔的 URL 列表，每个 URL 指向一个包含一个或多个插件的压缩（zip 格式）存档。</p>
<p>如果您想自动安装官方插件，可以使用以下值：<code>EXTERNAL_PLUGIN_URLS=https://github.com/bunkerity/bunkerweb-plugins/archive/refs/tags/v1.9.zip</code></p>
<h3 id="zh-plugins-_5">手动</h3>
<p>第一步是通过将其文件放置在相应的 <code>plugins</code> 数据文件夹中来安装插件。该过程取决于您的集成：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:5"><input checked="checked" id="zh-plugins-__tabbed_1_1" name="zh-plugins-__tabbed_1" type="radio" /><input id="zh-plugins-__tabbed_1_2" name="zh-plugins-__tabbed_1" type="radio" /><input id="zh-plugins-__tabbed_1_3" name="zh-plugins-__tabbed_1" type="radio" /><input id="zh-plugins-__tabbed_1_4" name="zh-plugins-__tabbed_1" type="radio" /><input id="zh-plugins-__tabbed_1_5" name="zh-plugins-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="zh-plugins-__tabbed_1_1">Docker</label><label for="zh-plugins-__tabbed_1_2">Docker autoconf</label><label for="zh-plugins-__tabbed_1_3">Swarm</label><label for="zh-plugins-__tabbed_1_4">Kubernetes</label><label for="zh-plugins-__tabbed_1_5">Linux</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>当使用 <a href="#zh-integrations-docker">Docker 集成</a>时，插件必须放置在调度器容器中挂载在 <code>/data/plugins</code> 的卷中。</p>
<p>首先要做的是创建 plugins 文件夹：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>./bw-data/plugins
</code></pre></div>
<p>然后，您可以将您选择的插件放入该文件夹中：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/bunkerity/bunkerweb-plugins<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
cp<span class="w"> </span>-rp<span class="w"> </span>./bunkerweb-plugins/*<span class="w"> </span>./bw-data/plugins
</code></pre></div>
<details class="warning">
<summary>为持久化数据使用本地文件夹</summary>
<p>调度器在容器内以<strong>UID 101 和 GID 101 的非特权用户</strong>身份运行。这背后的原因是安全性：万一漏洞被利用，攻击者将不会拥有完全的 root (UID/GID 0) 权限。
但有一个缺点：如果您为持久化数据使用<strong>本地文件夹</strong>，您将需要<strong>设置正确的权限</strong>，以便非特权用户可以向其中写入数据。类似这样的操作应该可以解决问题：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chown<span class="w"> </span>root:101<span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-data
</code></pre></div>
<p>或者，如果文件夹已经存在：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span>root:101<span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span>-R<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-data
</code></pre></div>
<p>如果您正在使用<a href="https://docs.docker.com/engine/security/rootless">无根模式的 Docker</a> 或 <a href="https://podman.io/">podman</a>，容器中的 UID 和 GID 将映射到主机上不同的 UID 和 GID。您首先需要检查您的初始 subuid 和 subgid：</p>
<div class="highlight"><pre><span></span><code>grep<span class="w"> </span>^<span class="k">$(</span>whoami<span class="k">)</span>:<span class="w"> </span>/etc/subuid<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
grep<span class="w"> </span>^<span class="k">$(</span>whoami<span class="k">)</span>:<span class="w"> </span>/etc/subgid
</code></pre></div>
<p>例如，如果您的值为 <strong>100000</strong>，则映射的 UID/GID 将为 <strong>100100</strong> (100000 + 100)：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>chgrp<span class="w"> </span><span class="m">100100</span><span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chmod<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-data
</code></pre></div>
<p>或者如果文件夹已经存在：</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>chgrp<span class="w"> </span>-R<span class="w"> </span><span class="m">100100</span><span class="w"> </span>bw-data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>chmod<span class="w"> </span>-R<span class="w"> </span><span class="m">770</span><span class="w"> </span>bw-data
</code></pre></div>
</details>
<p>然后，您可以在启动 Docker 堆栈时挂载该卷：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="nn">...</span>
<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./bw-data:/data</span>
<span class="nn">...</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>当使用 <a href="#zh-integrations-docker-autoconf">Docker autoconf 集成</a>时，插件必须放置在调度器容器中挂载在 <code>/data/plugins</code> 的卷中。</p>
<p>首先要做的是创建 plugins 文件夹：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>./bw-data/plugins
</code></pre></div>
<p>然后，您可以将您选择的插件放入该文件夹中：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/bunkerity/bunkerweb-plugins<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
cp<span class="w"> </span>-rp<span class="w"> </span>./bunkerweb-plugins/*<span class="w"> </span>./bw-data/plugins
</code></pre></div>
<p>因为调度器以 UID 和 GID 101 的非特权用户运行，您需要编辑权限：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">101</span>:101<span class="w"> </span>./bw-data
</code></pre></div>
<p>然后您可以在启动 Docker 堆栈时挂载该卷：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="nn">...</span>
<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./bw-data:/data</span>
<span class="nn">...</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="admonition warning">
<p class="admonition-title">已弃用</p>
<p>Swarm 集成已弃用，并将在未来版本中删除。请考虑改用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>。</p>
<p><strong>更多信息可以在 <a href="#zh-integrations-swarm">Swarm 集成文档</a>中找到。</strong></p>
</div>
<p>当使用 <a href="#zh-integrations-swarm">Swarm 集成</a>时，插件必须放置在调度器容器中挂载在 <code>/data/plugins</code> 的卷中。</p>
<div class="admonition info">
<p class="admonition-title">Swarm 卷</p>
<p>本文档不涉及配置一个当调度器服务在不同节点上运行时将持久化的 Swarm 卷。我们将假设您在所有节点上都有一个挂载在 <code>/shared</code> 的共享文件夹。</p>
</div>
<p>首先要做的是创建 plugins 文件夹：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>/shared/bw-plugins
</code></pre></div>
<p>然后，您可以将您选择的插件放入该文件夹中：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/bunkerity/bunkerweb-plugins<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
cp<span class="w"> </span>-rp<span class="w"> </span>./bunkerweb-plugins/*<span class="w"> </span>/shared/bw-plugins
</code></pre></div>
<p>因为调度器以 UID 和 GID 101 的非特权用户运行，您需要编辑权限：</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">101</span>:101<span class="w"> </span>/shared/bw-plugins
</code></pre></div>
<p>然后您可以在启动 Swarm 堆栈时挂载该卷：</p>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="nn">...</span>
<span class="w">  </span><span class="nt">bw-scheduler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/shared/bw-plugins:/data/plugins</span>
<span class="nn">...</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>当使用 <a href="#zh-integrations-kubernetes">Kubernetes 集成</a>时，插件必须放置在调度器容器中挂载在 <code>/data/plugins</code> 的卷中。</p>
<p>首先要做的是声明一个将包含我们插件数据的 <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">PersistentVolumeClaim</a>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pvc-bunkerweb-plugins</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<span class="nt">resources</span><span class="p">:</span>
<span class="w">  </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5Gi</span>
</code></pre></div>
<p>您现在可以添加卷挂载和一个 init 容器来自动配置该卷：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb-scheduler</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Recreate</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb-scheduler</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb-scheduler</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sa-bunkerweb</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb-scheduler</span>
<span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerity/bunkerweb-scheduler:testing</span>
<span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">          </span><span class="nt">env</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KUBERNETES_MODE</span>
<span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DATABASE_URI&quot;</span>
<span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;mariadb+pymysql://bunkerweb:changeme@svc-bunkerweb-db:3306/db&quot;</span>
<span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/data/plugins&quot;</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vol-plugins</span>
<span class="w">      </span><span class="nt">initContainers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bunkerweb-scheduler-init</span>
<span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alpine/git</span>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;git</span><span class="nv"> </span><span class="s">clone</span><span class="nv"> </span><span class="s">https://github.com/bunkerity/bunkerweb-plugins</span><span class="nv"> </span><span class="s">/data/plugins</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">chown</span><span class="nv"> </span><span class="s">-R</span><span class="nv"> </span><span class="s">101:101</span><span class="nv"> </span><span class="s">/data/plugins&quot;</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/data/plugins&quot;</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vol-plugins</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vol-plugins</span>
<span class="w">          </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
<span class="w">            </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pvc-bunkerweb-plugins</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>当使用 <a href="#zh-integrations-linux">Linux 集成</a>时，插件必须写入 <code>/etc/bunkerweb/plugins</code> 文件夹：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/bunkerity/bunkerweb-plugins<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
cp<span class="w"> </span>-rp<span class="w"> </span>./bunkerweb-plugins/*<span class="w"> </span>/etc/bunkerweb/plugins<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
chown<span class="w"> </span>-R<span class="w"> </span>nginx:nginx<span class="w"> </span>/etc/bunkerweb/plugins
</code></pre></div>
</div>
</div>
</div>
<h2 id="zh-plugins-_6">编写插件</h2>
<h3 id="zh-plugins-_7">结构</h3>
<div class="admonition tip">
<p class="admonition-title">现有插件</p>
<p>如果文档不够，您可以查看<a href="https://github.com/bunkerity/bunkerweb-plugins">官方插件</a>和<a href="https://github.com/bunkerity/bunkerweb/tree/vtesting/src/common/core">核心插件</a>的现有源代码（已包含在 BunkerWeb 中，但从技术上讲它们是插件）。</p>
</div>
<p>插件结构如下所示：
<div class="highlight"><pre><span></span><code>plugin /
    confs / conf_type / conf_name.conf
    ui / actions.py
         hooks.py
         template.html
         blueprints / &lt;blueprint_file(s)&gt;
              templates / &lt;blueprint_template(s)&gt;
    jobs / my-job.py
    templates / my-template.json
          my-template / configs / conf_type / conf_name.conf
    plugin.lua
    plugin.json
</code></pre></div></p>
<ul>
<li>
<p><strong>conf_name.conf</strong>：添加<a href="#zh-advanced-custom-configurations">自定义 NGINX 配置</a>（作为 Jinja2 模板）。</p>
</li>
<li>
<p><strong>actions.py</strong>：在 Flask 服务器上执行的脚本。此脚本在 Flask 上下文中运行，使您可以访问 <code>jinja2</code> 和 <code>requests</code> 等库和实用程序。</p>
</li>
<li>
<p><strong>hooks.py</strong>：包含 flask 钩子的自定义 Python 文件，将在加载插件时执行。</p>
</li>
<li>
<p><strong>template.html</strong>：通过 UI 访问的自定义插件页面。</p>
</li>
<li>
<p><strong>blueprints 文件夹（在 ui 内）</strong>：
  此文件夹用于覆盖现有的 Flask 蓝图或创建新的蓝图。在内部，您可以包含蓝图文件和一个可选的 <strong>templates</strong> 子文件夹，用于蓝图特定的模板。</p>
</li>
<li>
<p><strong>jobs py 文件</strong>：由调度器作为作业执行的自定义 Python 文件。</p>
</li>
<li>
<p><strong>my-template.json</strong>：添加<a href="#zh-concepts-templates">自定义模板</a>以覆盖设置的默认值并轻松应用自定义配置。</p>
</li>
<li>
<p><strong>plugin.lua</strong>：使用 <a href="https://github.com/openresty/lua-nginx-module">NGINX LUA 模块</a>在 NGINX 上执行的代码。</p>
</li>
<li>
<p><strong>plugin.json</strong>：您的插件的元数据、设置和作业定义。</p>
</li>
</ul>
<h3 id="zh-plugins-_8">开始</h3>
<p>第一步是创建一个将包含插件的文件夹：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>myplugin<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">cd</span><span class="w"> </span>myplugin
</code></pre></div>
<h3 id="zh-plugins-_9">元数据</h3>
<p>一个名为 <strong>plugin.json</strong> 的文件，写在插件文件夹的根目录下，必须包含有关插件的元数据。这是一个示例：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;myplugin&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;My Plugin&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Just an example plugin.&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;stream&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;partial&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;settings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;DUMMY_SETTING&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;context&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;multisite&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;default&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1234&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;help&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Here is the help of the setting.&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dummy-id&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Dummy setting&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;regex&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^.*$&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;jobs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my-job&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my-job.py&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;every&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;hour&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>以下是字段的详细信息：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">字段</th>
<th style="text-align: center;">强制</th>
<th style="text-align: center;">类型</th>
<th style="text-align: left;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>id</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">插件的内部 ID：必须在其他插件（包括“核心”插件）中唯一，并且只包含小写字符。</td>
</tr>
<tr>
<td style="text-align: center;"><code>name</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">您的插件的名称。</td>
</tr>
<tr>
<td style="text-align: center;"><code>description</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">您的插件的描述。</td>
</tr>
<tr>
<td style="text-align: center;"><code>version</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">您的插件的版本。</td>
</tr>
<tr>
<td style="text-align: center;"><code>stream</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">关于流支持的信息：<code>no</code>、<code>yes</code> 或 <code>partial</code>。</td>
</tr>
<tr>
<td style="text-align: center;"><code>settings</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字典</td>
<td style="text-align: left;">您的插件的设置列表。</td>
</tr>
<tr>
<td style="text-align: center;"><code>jobs</code></td>
<td style="text-align: center;">否</td>
<td style="text-align: center;">列表</td>
<td style="text-align: left;">您的插件的作业列表。</td>
</tr>
</tbody>
</table>
<p>每个设置都有以下字段（键是在配置中使用的设置的 ID）：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">字段</th>
<th style="text-align: center;">强制</th>
<th style="text-align: center;">类型</th>
<th style="text-align: left;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>context</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">设置的上下文：<code>multisite</code> 或 <code>global</code>。</td>
</tr>
<tr>
<td style="text-align: center;"><code>default</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">设置的默认值。</td>
</tr>
<tr>
<td style="text-align: center;"><code>help</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">关于插件的帮助文本（在 Web UI 中显示）。</td>
</tr>
<tr>
<td style="text-align: center;"><code>id</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">Web UI 用于 HTML 元素的内部 ID。</td>
</tr>
<tr>
<td style="text-align: center;"><code>label</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">Web UI 显示的标签。</td>
</tr>
<tr>
<td style="text-align: center;"><code>regex</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">用于验证用户提供的值的正则表达式。</td>
</tr>
<tr>
<td style="text-align: center;"><code>type</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">字段的类型：<code>text</code>、<code>check</code>、<code>select</code> 或 <code>password</code>。</td>
</tr>
<tr>
<td style="text-align: center;"><code>multiple</code></td>
<td style="text-align: center;">否</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">用于将多个带有数字后缀的设置分组的唯一 ID。</td>
</tr>
<tr>
<td style="text-align: center;"><code>select</code></td>
<td style="text-align: center;">否</td>
<td style="text-align: center;">列表</td>
<td style="text-align: left;">当 <code>type</code> 为 <code>select</code> 时，可能的字符串值列表。</td>
</tr>
</tbody>
</table>
<p>每个作业都有以下字段：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">字段</th>
<th style="text-align: center;">强制</th>
<th style="text-align: center;">类型</th>
<th style="text-align: left;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>name</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">作业的名称。</td>
</tr>
<tr>
<td style="text-align: center;"><code>file</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">作业文件夹内的文件名。</td>
</tr>
<tr>
<td style="text-align: center;"><code>every</code></td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
<td style="text-align: left;">作业调度频率：<code>minute</code>、<code>hour</code>、<code>day</code>、<code>week</code> 或 <code>once</code>（无频率，仅在（重新）生成配置之前一次）。</td>
</tr>
</tbody>
</table>
<h3 id="zh-plugins-_10">配置</h3>
<p>您可以通过添加一个名为 <strong>confs</strong> 的文件夹来添加自定义 NGINX 配置，其内容类似于<a href="#zh-advanced-custom-configurations">自定义配置</a>。<strong>confs</strong> 内的每个子文件夹将包含 <a href="https://jinja.palletsprojects.com">jinja2</a> 模板，这些模板将在相应的上下文（<code>http</code>、<code>server-http</code>、<code>default-server-http</code>、<code>stream</code>、<code>server-stream</code>、<code>modsec</code>、<code>modsec-crs</code>、<code>crs-plugins-before</code> 和 <code>crs-plugins-after</code>）下生成和加载。</p>
<p>这是一个名为 <strong>example.conf</strong> 的 <strong>confs/server-http</strong> 文件夹内的配置模板文件示例：</p>
<div class="highlight"><pre><span></span><code><span class="k">location</span><span class="w"> </span><span class="s">/setting</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">default_type</span><span class="w"> </span><span class="s">&#39;text/plain&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kn">content_by_lua_block</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kn">ngx.say(&#39;{{</span><span class="w"> </span><span class="s">DUMMY_SETTING</span><span class="w"> </span><span class="err">}}</span><span class="s">&#39;)</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</code></pre></div>
<p><code>{{ DUMMY_SETTING }}</code> 将被插件用户选择的 <code>DUMMY_SETTING</code> 的值替换。</p>
<h3 id="zh-plugins-_11">模板</h3>
<p>有关更多信息，请查看<a href="#zh-concepts-templates">模板文档</a>。</p>
<h3 id="zh-plugins-lua">LUA</h3>
<h4 id="zh-plugins-_12">主脚本</h4>
<p>在底层，BunkerWeb 使用 <a href="https://github.com/openresty/lua-nginx-module">NGINX LUA 模块</a>在 NGINX 内部执行代码。需要执行代码的插件必须在插件文件夹的根目录下提供一个 lua 文件，使用 <strong>plugin.json</strong> 的 <code>id</code> 值作为其名称。这是一个名为 <strong>myplugin.lua</strong> 的示例：</p>
<div class="highlight"><pre><span></span><code><span class="kd">local</span><span class="w"> </span><span class="nv">class</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nb">require</span><span class="w"> </span><span class="s2">&quot;middleclass&quot;</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">plugin</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nb">require</span><span class="w"> </span><span class="s2">&quot;bunkerweb.plugin&quot;</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">utils</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nb">require</span><span class="w"> </span><span class="s2">&quot;bunkerweb.utils&quot;</span>


<span class="kd">local</span><span class="w"> </span><span class="nv">myplugin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">class</span><span class="p">(</span><span class="s2">&quot;myplugin&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">plugin</span><span class="p">)</span>


<span class="kr">function</span><span class="w"> </span><span class="nc">myplugin</span><span class="p">:</span><span class="nf">initialize</span><span class="p">(</span><span class="nv">ctx</span><span class="p">)</span>
<span class="w">    </span><span class="nv">plugin</span><span class="p">.</span><span class="nf">initialize</span><span class="p">(</span><span class="nv">self</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;myplugin&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">dummy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dummy&quot;</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">myplugin</span><span class="p">:</span><span class="nf">init</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">NOTICE</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;init called&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">ret</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">myplugin</span><span class="p">:</span><span class="nf">set</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">NOTICE</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;set called&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">ret</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">myplugin</span><span class="p">:</span><span class="nf">access</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">NOTICE</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;access called&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">ret</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">myplugin</span><span class="p">:</span><span class="nf">log</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">NOTICE</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;log called&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">ret</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">myplugin</span><span class="p">:</span><span class="nf">log_default</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">NOTICE</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;log_default called&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">ret</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">myplugin</span><span class="p">:</span><span class="nf">preread</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">NOTICE</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;preread called&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">ret</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span><span class="w"> </span><span class="nc">myplugin</span><span class="p">:</span><span class="nf">log_stream</span><span class="p">()</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">NOTICE</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;log_stream called&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">self</span><span class="p">:</span><span class="nf">ret</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">return</span><span class="w"> </span><span class="nv">myplugin</span>
</code></pre></div>
<p>声明的函数会在特定的上下文中自动调用。以下是每个函数的详细信息：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">函数</th>
<th style="text-align: center;">上下文</th>
<th style="text-align: left;">描述</th>
<th style="text-align: left;">返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>init</code></td>
<td style="text-align: center;"><a href="https://github.com/openresty/lua-nginx-module#init_by_lua">init_by_lua</a></td>
<td style="text-align: left;">当 NGINX 刚启动或收到重新加载命令时调用。典型的用例是准备插件将使用的任何数据。</td>
<td style="text-align: left;"><code>ret</code>, <code>msg</code><ul><li><code>ret</code> (布尔值)：如果没有错误则为 true，否则为 false</li><li><code>msg</code> (字符串)：成功或错误消息</li></ul></td>
</tr>
<tr>
<td style="text-align: center;"><code>set</code></td>
<td style="text-align: center;"><a href="https://github.com/openresty/lua-nginx-module#set_by_lua">set_by_lua</a></td>
<td style="text-align: left;">在服务器接收到每个请求之前调用。典型的用例是在访问阶段之前进行计算。</td>
<td style="text-align: left;"><code>ret</code>, <code>msg</code><ul><li><code>ret</code> (布尔值)：如果没有错误则为 true，否则为 false</li><li><code>msg</code> (字符串)：成功或错误消息</li></ul></td>
</tr>
<tr>
<td style="text-align: center;"><code>access</code></td>
<td style="text-align: center;"><a href="https://github.com/openresty/lua-nginx-module#access_by_lua">access_by_lua</a></td>
<td style="text-align: left;">在服务器接收到每个请求时调用。典型的用例是在这里进行安全检查，并在需要时拒绝请求。</td>
<td style="text-align: left;"><code>ret</code>, <code>msg</code>,<code>status</code>,<code>redirect</code><ul><li><code>ret</code> (布尔值)：如果没有错误则为 true，否则为 false</li><li><code>msg</code> (字符串)：成功或错误消息</li><li><code>status</code> (数字)：中断当前进程并返回 <a href="https://github.com/openresty/lua-nginx-module#http-status-constants">HTTP 状态</a></li><li><code>redirect</code> (URL)：如果设置，将重定向到给定的 URL</li></ul></td>
</tr>
<tr>
<td style="text-align: center;"><code>log</code></td>
<td style="text-align: center;"><a href="https://github.com/openresty/lua-nginx-module#log_by_lua">log_by_lua</a></td>
<td style="text-align: left;">当请求完成时（在它被记录到访问日志之前）调用。典型的用例是例如进行统计或计算计数器。</td>
<td style="text-align: left;"><code>ret</code>, <code>msg</code><ul><li><code>ret</code> (布尔值)：如果没有错误则为 true，否则为 false</li><li><code>msg</code> (字符串)：成功或错误消息</li></ul></td>
</tr>
<tr>
<td style="text-align: center;"><code>log_default</code></td>
<td style="text-align: center;"><a href="https://github.com/openresty/lua-nginx-module#log_by_lua">log_by_lua</a></td>
<td style="text-align: left;">与 <code>log</code> 相同，但仅在默认服务器上调用。</td>
<td style="text-align: left;"><code>ret</code>, <code>msg</code><ul><li><code>ret</code> (布尔值)：如果没有错误则为 true，否则为 false</li><li><code>msg</code> (字符串)：成功或错误消息</li></ul></td>
</tr>
<tr>
<td style="text-align: center;"><code>preread</code></td>
<td style="text-align: center;"><a href="https://github.com/openresty/stream-lua-nginx-module#preread_by_lua_block">preread_by_lua</a></td>
<td style="text-align: left;">与 <code>access</code> 函数类似，但用于流模式。</td>
<td style="text-align: left;"><code>ret</code>, <code>msg</code>,<code>status</code><ul><li><code>ret</code> (布尔值)：如果没有错误则为 true，否则为 false</li><li><code>msg</code> (字符串)：成功或错误消息</li><li><code>status</code> (数字)：中断当前进程并返回 <a href="https://github.com/openresty/lua-nginx-module#http-status-constants">status</a></li></ul></td>
</tr>
<tr>
<td style="text-align: center;"><code>log_stream</code></td>
<td style="text-align: center;"><a href="https://github.com/openresty/stream-lua-nginx-module#log_by_lua_block">log_by_lua</a></td>
<td style="text-align: left;">与 <code>log</code> 函数类似，但用于流模式。</td>
<td style="text-align: left;"><code>ret</code>, <code>msg</code><ul><li><code>ret</code> (布尔值)：如果没有错误则为 true，否则为 false</li><li><code>msg</code> (字符串)：成功或错误消息</li></ul></td>
</tr>
</tbody>
</table>
<h4 id="zh-plugins-_13">库</h4>
<p><a href="https://github.com/openresty/lua-nginx-module">NGINX LUA 模块</a>和 <a href="https://github.com/openresty/stream-lua-nginx-module">NGINX stream LUA 模块</a>的所有指令都可用。此外，您可以使用 BunkerWeb 中包含的 LUA 库：有关完整列表，请参见<a href="https://github.com/bunkerity/bunkerweb/blobsrc/deps/clone.sh">此脚本</a>。</p>
<p>如果您需要其他库，可以将它们放在插件的根文件夹中，并通过在它们前面加上您的插件 ID 来访问它们。这是一个名为 <strong>mylibrary.lua</strong> 的示例文件：</p>
<div class="highlight"><pre><span></span><code><span class="kd">local</span><span class="w"> </span><span class="nv">_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="nv">_M</span><span class="p">.</span><span class="py">dummy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;dummy&quot;</span>
<span class="kr">end</span>

<span class="kr">return</span><span class="w"> </span><span class="nv">_M</span>
</code></pre></div>
<p>这是您如何从 <strong>myplugin.lua</strong> 文件中使用它的方法：</p>
<div class="highlight"><pre><span></span><code><span class="kd">local</span><span class="w"> </span><span class="nv">mylibrary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">require</span><span class="w"> </span><span class="s2">&quot;myplugin.mylibrary&quot;</span>

<span class="p">...</span>

<span class="nv">mylibrary</span><span class="p">.</span><span class="nf">dummy</span><span class="p">()</span>

<span class="p">...</span>
</code></pre></div>
<h4 id="zh-plugins-_14">助手</h4>
<p>一些助手模块提供了常见的有用助手：</p>
<ul>
<li><code>self.variables</code>：允许访问和存储插件的属性</li>
<li><code>self.logger</code>：打印日志</li>
<li><code>bunkerweb.utils</code>：各种有用的函数</li>
<li><code>bunkerweb.datastore</code>：访问一个实例上的全局共享数据（键/值存储）</li>
<li><code>bunkerweb.clusterstore</code>：访问 BunkerWeb 实例之间共享的 Redis 数据存储（键/值存储）</li>
</ul>
<p>要访问这些函数，您首先需要<strong>引用</strong>这些模块：</p>
<div class="highlight"><pre><span></span><code><span class="kd">local</span><span class="w"> </span><span class="nv">utils</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nb">require</span><span class="w"> </span><span class="s2">&quot;bunkerweb.utils&quot;</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">datastore</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nb">require</span><span class="w"> </span><span class="s2">&quot;bunkerweb.datastore&quot;</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">clustestore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">require</span><span class="w"> </span><span class="s2">&quot;bunkerweb.clustertore&quot;</span>
</code></pre></div>
<p>检索一个设置值：</p>
<div class="highlight"><pre><span></span><code><span class="kd">local</span><span class="w"> </span><span class="nv">myvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">variables</span><span class="p">[</span><span class="s2">&quot;DUMMY_SETTING&quot;</span><span class="p">]</span>
<span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">myvar</span><span class="w"> </span><span class="kr">then</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">ERR</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;can&#39;t retrieve setting DUMMY_SETTING&quot;</span><span class="p">)</span>
<span class="kr">else</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">NOTICE</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DUMMY_SETTING = &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">value</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></div>
<p>在本地缓存中存储一些东西：</p>
<div class="highlight"><pre><span></span><code><span class="kd">local</span><span class="w"> </span><span class="nv">ok</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">datastore</span><span class="p">:</span><span class="nf">set</span><span class="p">(</span><span class="s2">&quot;plugin_myplugin_something&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;somevalue&quot;</span><span class="p">)</span>
<span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ok</span><span class="w"> </span><span class="kr">then</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">ERR</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;can&#39;t save plugin_myplugin_something into datastore : &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">err</span><span class="p">)</span>
<span class="kr">else</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">NOTICE</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;successfully saved plugin_myplugin_something into datastore&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></div>
<p>检查一个 IP 地址是否是全局的：</p>
<div class="highlight"><pre><span></span><code><span class="kd">local</span><span class="w"> </span><span class="nv">ret</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">utils</span><span class="p">.</span><span class="nf">ip_is_global</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">ctx</span><span class="p">.</span><span class="py">bw</span><span class="p">.</span><span class="py">remote_addr</span><span class="p">)</span>
<span class="kr">if</span><span class="w"> </span><span class="nv">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="kr">then</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">ERR</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;error while checking if IP &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ngx</span><span class="p">.</span><span class="py">ctx</span><span class="p">.</span><span class="py">bw</span><span class="p">.</span><span class="py">remote_addr</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; is global or not : &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">err</span><span class="p">)</span>
<span class="kr">elseif</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">ret</span><span class="w"> </span><span class="kr">then</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">NOTICE</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;IP &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ngx</span><span class="p">.</span><span class="py">ctx</span><span class="p">.</span><span class="py">bw</span><span class="p">.</span><span class="py">remote_addr</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; is not global&quot;</span><span class="p">)</span>
<span class="kr">else</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">logger</span><span class="p">:</span><span class="nf">log</span><span class="p">(</span><span class="nv">ngx</span><span class="p">.</span><span class="py">NOTICE</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;IP &quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">ngx</span><span class="p">.</span><span class="py">ctx</span><span class="p">.</span><span class="py">bw</span><span class="p">.</span><span class="py">remote_addr</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot; is global&quot;</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">更多示例</p>
<p>如果您想查看可用函数的完整列表，可以查看仓库的 <a href="https://github.com/bunkerity/bunkerweb/tree/vtesting/src/bw/lua/bunkerweb">lua 目录</a>中存在的文件。</p>
</div>
<h3 id="zh-plugins-_15">作业</h3>
<p>BunkerWeb 使用内部作业调度器来执行定期任务，例如使用 certbot 续订证书、下载黑名单、下载 MMDB 文件等。您可以通过将任务放入名为 <strong>jobs</strong> 的子文件夹中，并在 <strong>plugin.json</strong> 元数据文件中列出它们来添加您选择的任务。不要忘记为每个人添加执行权限，以避免用户克隆和安装您的插件时出现任何问题。</p>
<h3 id="zh-plugins-_16">插件页面</h3>
<p>与 Web UI 相关的所有内容都位于 <strong>ui</strong> 子文件夹中，正如我们在<a href="#zh-plugins-structure">之前的结构部分</a>中看到的那样。</p>
<h4 id="zh-plugins-_17">先决条件</h4>
<p>当您想要创建一个插件页面时，您需要两个文件：</p>
<ul>
<li>
<p><strong>template.html</strong>，可以通过 <strong>GET /plugins/&lt;<em>plugin_id</em>&gt;</strong> 访问。</p>
</li>
<li>
<p><strong>actions.py</strong>，您可以在其中添加一些脚本和逻辑，通过 <strong>POST /plugins/&lt;<em>plugin_id</em>&gt;</strong> 访问。请注意，此文件<strong>需要一个与插件同名的函数</strong>才能工作。即使该函数为空，也需要此文件。</p>
</li>
</ul>
<h4 id="zh-plugins-_18">基本示例</h4>
<div class="admonition info">
<p class="admonition-title">Jinja 2 模板</p>
<p><strong>template.html</strong> 文件是一个 Jinja2 模板，如果需要，请参阅 <a href="https://jinja.palletsprojects.com">Jinja2 文档</a>。</p>
</div>
<p>我们可以先不考虑 <strong>actions.py</strong> 文件，<strong>只在 GET 情况下使用模板</strong>。模板可以访问应用程序上下文和库，因此您可以使用 Jinja、请求或 flask 实用程序。</p>
<p>例如，您可以在模板中像这样获取请求参数：</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>请求参数 : {{ request.args.get() }}.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>```

#### Actions.py

!!! warning &quot;CSRF 令牌&quot;

    请注意，每个表单提交都受到 CSRF 令牌的保护，您需要在您的表单中包含以下代码片段：
    ```html
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;csrf_token&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;{{ csrf_token() }}&quot;</span> <span class="p">/&gt;</span>
    ```

当发送 **POST /plugins/<span class="err">&lt;</span>*plugin_id*&gt;** 时，您可以使用 **actions.py** 文件为您的插件页面添加额外的脚本。

在 **actions.py** 中，您默认有两个函数：

**pre_render 函数**

这允许您在 **GET** 模板时检索数据，并使用 Jinja 中可用的 pre_render 变量来更动态地显示内容。

```python
def pre_render(**kwargs)
  return <span class="p">&lt;</span><span class="nt">pre_render_data</span><span class="p">&gt;</span>
</code></pre></div>
<p>BunkerWeb 会给您发送这种类型的响应：</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok|ko&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span> <span class="p">:</span> <span class="n">XXX</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">pre_render_data</span><span class="o">&gt;</span><span class="p">}),</span> <span class="mi">200</span>
</code></pre></div>
<p><strong>&lt;<em>plugin_id</em>&gt; 函数</strong></p>
<p>这允许您在从模板端点进行 <strong>POST</strong> 时检索数据，该端点必须在 AJAX 中使用。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">myplugin</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="n">plugin_id_data</span><span class="o">&gt;</span>
</code></pre></div>
<p>BunkerWeb 会给你发送这种类型的响应：</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">plugin_id_data</span><span class="o">&gt;</span><span class="p">}),</span> <span class="mi">200</span>
</code></pre></div>
<p><strong>您可以从 action.py 访问什么</strong></p>
<p>以下是在 action.py 函数上传递和访问的参数：</p>
<div class="highlight"><pre><span></span><code><span class="n">function</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">可用的 Python 库</p>
<p>BunkerWeb 的 Web UI 包含一组预安装的 Python 库，您可以在插件的 <code>actions.py</code> 或其他与 UI 相关的脚本中使用。这些库开箱即用，无需额外安装。</p>
<p>以下是包含的库的完整列表：</p>
<ul>
<li><strong>bcrypt</strong> - 密码哈希库</li>
<li><strong>biscuit-python</strong> - Biscuit 认证令牌</li>
<li><strong>certbot</strong> - 用于 Let's Encrypt 的 ACME 客户端</li>
<li><strong>Flask</strong> - Web 框架</li>
<li><strong>Flask-Login</strong> - 用户会话管理</li>
<li><strong>Flask-Session[cachelib]</strong> - 服务器端会话存储</li>
<li><strong>Flask-WTF</strong> - 表单处理和 CSRF 保护</li>
<li><strong>gunicorn[gthread]</strong> - WSGI HTTP 服务器</li>
<li><strong>pillow</strong> - 图像处理</li>
<li><strong>psutil</strong> - 系统和进程实用程序</li>
<li><strong>python_dateutil</strong> - 日期和时间实用程序</li>
<li><strong>qrcode</strong> - 二维码生成</li>
<li><strong>regex</strong> - 高级正则表达式</li>
<li><strong>urllib3</strong> - HTTP 客户端</li>
<li><strong>user_agents</strong> - 用户代理解析</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">在您的插件中使用库</p>
<p>要在您的 <code>actions.py</code> 文件中导入和使用这些库，只需使用标准的 Python <code>import</code> 语句。例如：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bcrypt</span>
</code></pre></div>
</div>
<details class="warning">
<summary>外部库</summary>
<p>如果您需要上面未列出的库，请将它们安装在您插件的 <code>ui</code> 文件夹中，并使用经典的 <code>import</code> 指令导入它们。请确保与现有环境兼容以避免冲突。</p>
</details>
</div>
<p><strong>一些例子</strong></p>
<ul>
<li>检索表单提交的数据</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span>

<span class="k">def</span><span class="w"> </span><span class="nf">myplugin</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">my_form_value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;my_form_input&quot;</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">my_form_value</span>
</code></pre></div>
<ul>
<li>访问应用程序配置</li>
</ul>
<p><strong>action.py</strong>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pre_render</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;app&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;CONFIG&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">config</span>
</code></pre></div></p>
<p><strong>模板</strong>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- 元数据 + 配置 --&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>{{ pre_render }}<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div></p>
<h3 id="zh-plugins-hookspy">Hooks.py</h3>
<p>本文档概述了用于管理应用程序内请求不同阶段的生命周期钩子。每个钩子都与一个特定的阶段相关联。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:4"><input checked="checked" id="zh-plugins-__tabbed_2_1" name="zh-plugins-__tabbed_2" type="radio" /><input id="zh-plugins-__tabbed_2_2" name="zh-plugins-__tabbed_2" type="radio" /><input id="zh-plugins-__tabbed_2_3" name="zh-plugins-__tabbed_2" type="radio" /><input id="zh-plugins-__tabbed_2_4" name="zh-plugins-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="zh-plugins-__tabbed_2_1">before_request</label><label for="zh-plugins-__tabbed_2_2">after_request</label><label for="zh-plugins-__tabbed_2_3">teardown_request</label><label for="zh-plugins-__tabbed_2_4">context_processor</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>这些钩子在处理传入请求<strong>之前</strong>执行。它们通常用于预处理任务，例如身份验证、验证或日志记录。</p>
<p>如果钩子返回一个响应对象，Flask 将跳过请求处理并直接返回该响应。这对于短路请求处理管道很有用。</p>
<p><strong>示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">Response</span>

<span class="k">def</span><span class="w"> </span><span class="nf">before_request</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Before-request: Validating request...&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 在此处执行身份验证、验证或日志记录</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="c1"># 我们在应用程序上下文中</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;Invalid request!&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">is_valid_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># 虚拟验证逻辑</span>
    <span class="k">return</span> <span class="s2">&quot;user&quot;</span> <span class="ow">in</span> <span class="n">request</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>这些钩子在请求处理<strong>之后</strong>运行。它们非常适合后处理任务，例如清理、额外的日志记录或在发送回响应之前对其进行修改。</p>
<p>它们接收响应对象作为参数，并可以在返回之前对其进行修改。第一个返回响应的 after_request 钩子将用作最终响应。</p>
<p><strong>示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span>

<span class="k">def</span><span class="w"> </span><span class="nf">after_request</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;After-request: Logging response...&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 在此处执行日志记录、清理或响应修改</span>
    <span class="n">log_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span><span class="w"> </span><span class="nf">log_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="c1"># 虚拟日志记录逻辑</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Response logged:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>当请求上下文被拆除时，会调用这些钩子。这些钩子用于释放资源或处理请求生命周期中发生的错误。</p>
<p><strong>示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">teardown_request</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Teardown-request: Cleaning up resources...&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 在此处执行清理、释放资源或处理错误</span>
    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="n">cleanup_resources</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="c1"># 虚拟错误处理逻辑</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error encountered:&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cleanup_resources</span><span class="p">():</span>
    <span class="c1"># 虚拟资源清理逻辑</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resources have been cleaned up.&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>这些钩子用于向模板或视图注入额外的上下文。它们通过将通用数据（如用户信息或配置设置）传递给模板来丰富运行时上下文。</p>
<p>如果上下文处理器返回一个字典，则键和值将添加到所有模板的上下文中。这允许您在多个视图或模板之间共享数据。</p>
<p><strong>示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">context_processor</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Context-processor: Injecting context data...&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 返回一个包含模板/视图上下文数据的字典</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;current_user&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;app_version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;feature_flags&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;new_ui&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>这种生命周期钩子设计为管理请求生命周期的各个方面提供了一种模块化和系统化的方法：</p>
<ul>
<li><strong>模块化：</strong> 每个钩子都负责一个独特的阶段，确保了关注点的分离。</li>
<li><strong>可维护性：</strong> 开发人员可以轻松地添加、修改或删除钩子实现，而不会影响请求生命周期的其他部分。</li>
<li><strong>可扩展性：</strong> 该框架是灵活的，允许随着应用程序需求的发展添加额外的钩子或增强功能。</li>
</ul>
<p>通过明确定义每个钩子的职责及其相关的日志记录前缀，系统确保了请求处理的每个阶段都是透明和可管理的。</p>
<h3 id="zh-plugins-_19">蓝图</h3>
<p>在 Flask 中，<strong>蓝图</strong>是一种模块化的方式，用于组织应用程序中的相关组件——例如视图、模板和静态文件。它们允许您逻辑地对功能进行分组，并可用于创建应用程序的新部分或覆盖现有部分。</p>
<h4 id="zh-plugins-_20">创建一个蓝图</h4>
<p>要定义一个蓝图，您需要创建一个 <code>Blueprint</code> 类的实例，并指定其名称和导入路径。然后，您可以定义与此蓝图关联的路由和视图。</p>
<p><strong>示例：定义一个新的蓝图</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">dirname</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">render_template</span>

<span class="c1"># 定义蓝图</span>
<span class="n">my_blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;my_blueprint&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">,</span> <span class="n">template_folder</span><span class="o">=</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/templates&#39;</span><span class="p">)</span> <span class="c1"># 设置 template_folder 是为了避免与原始蓝图冲突</span>

<span class="c1"># 在蓝图内定义一个路由</span>
<span class="nd">@my_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/my_blueprint&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_blueprint_page</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;my_blueprint.html&#39;</span><span class="p">)</span>
</code></pre></div>
<p>在此示例中，创建了一个名为 <code>my_blueprint</code> 的蓝图，并在其中定义了一个路由 <code>/my_blueprint</code>。</p>
<h4 id="zh-plugins-_21">覆盖现有蓝图</h4>
<p>蓝图也可以覆盖现有的蓝图以修改或扩展功能。为此，请确保新蓝图的名称与您要覆盖的蓝图相同，并在原始蓝图之后注册它。</p>
<p><strong>示例：覆盖现有蓝图</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">dirname</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">Blueprint</span>

<span class="c1"># 原始蓝图</span>
<span class="n">instances</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;instances&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">,</span> <span class="n">template_folder</span><span class="o">=</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/templates&#39;</span><span class="p">)</span> <span class="c1"># 设置 template_folder 是为了避免与原始蓝图冲突</span>

<span class="nd">@instances</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/instances&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">override_instances</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;我的新实例页面&quot;</span>
</code></pre></div>
<p>在这种情况下，访问 URL <code>/instances</code> 将显示“我的新实例页面”，因为最后注册的 <code>instances</code> 蓝图覆盖了原始的 <code>instances</code> 蓝图。</p>
<div class="admonition warning">
<p class="admonition-title">关于覆盖</p>
<p>在覆盖现有蓝图时要小心，因为它可能会影响应用程序的行为。确保更改与应用程序的要求一致，并且不会引入意外的副作用。</p>
<p>所有现有的路由都将从原始蓝图中移除，因此如果需要，您需要重新实现它们。</p>
</div>
<h4 id="zh-plugins-_22">命名约定</h4>
<div class="admonition danger">
<p class="admonition-title">重要</p>
<p>确保蓝图的名称与蓝图变量名称匹配，否则它将不被视为有效的蓝图，也不会被注册。</p>
</div>
<p>为了保持一致性和清晰度，建议遵循以下命名约定：</p>
<ul>
<li>
<p><strong>蓝图名称</strong>：使用简短的全小写名称。可以使用下划线来提高可读性，例如 <code>user_auth</code>。</p>
</li>
<li>
<p><strong>文件名</strong>：将文件名与蓝图名称匹配，确保其全小写并根据需要使用下划线，例如 <code>user_auth.py</code>。</p>
</li>
</ul>
<p>这种做法与 Python 的模块命名约定一致，有助于维护清晰的项目结构。</p>
<p><strong>示例：蓝图和文件名命名</strong></p>
<div class="highlight"><pre><span></span><code>plugin /
    ui / blueprints / user_auth.py
                      templates / user_auth.html
</code></pre></div>
<p>在这种结构中，<code>user_auth.py</code> 包含 <code>user_auth</code> 蓝图，而 <code>user_auth.html</code> 是相关的模板，遵循了推荐的命名约定。</p></section><section class="print-page" id="zh-professional-services" heading-number="12"><h1 id="zh-professional-services-_1">专业服务</h1>
<h2 id="zh-professional-services-_2">为什么我应该选择专业服务？</h2>
<p>由于 BunkerWeb 是一个自由（如言论自由）软件，只要您遵守 <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">AGPLv3 许可证</a>，您就有权自由使用它。</p>
<p>您也可以随时将 BunkerWeb 升级到 PRO 版本。这样做，您将获得增强的体验，以协助您保障 Web 服务的安全。我们的目标是帮助您专注于您的业务需求。PRO 版本会定期更新，我们尽力收集企业的反馈，以包含所需的功能。</p>
<p>但是，根据您的业务优先级，投入时间到一项特定技术上可能并不容易。更不用说，网络安全是一个复杂的领域，不建议既当法官又当陪审团。</p>
<p>在开源或 PRO 版本的基础上获得专业服务是满足您业务需求的理想解决方案。您可以专注于您的首要任务，并在 Web 安全方面依赖一个值得信赖的合作伙伴。</p>
<p>请注意，专业服务由维护 BunkerWeb 项目的公司 <a href="https://www.bunkerity.com/?utm_campaign=self&amp;utm_source=doc">Bunkerity</a> 通过我们的 <a href="https://panel.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc">BunkerWeb Panel</a> 在线平台直接提供。</p>
<h2 id="zh-professional-services-_3">你们提供哪些专业服务？</h2>
<p>我们提供围绕 BunkerWeb 解决方案的技术支持和咨询。通过使用此服务，我们将协助您解决技术问题（安装、配置、误报等）。我们还可以根据您的需求提供定制的 SLA。</p>
<p>根据您的需求，您可以选择“一次性”和订阅服务。</p>
<h2 id="zh-professional-services-_4">我如何获取更多信息？</h2>
<p>您可以通过访问我们专为专业服务设立的平台 <a href="https://panel.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc">BunkerWeb Panel</a> 找到更多信息。</p>
<p>如果您有任何疑问，请随时<a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">联系我们</a>，我们将非常乐意满足您的需求。</p></section><section class="print-page" id="zh-about" heading-number="13"><h1 id="zh-about-_1">关于</h1>
<h2 id="zh-about-bunkerweb">谁在维护 BunkerWeb？</h2>
<p>BunkerWeb 由 <a href="https://www.bunkerity.com/?utm_campaign=self&amp;utm_source=doc">Bunkerity</a> 维护，这是一家专注于网络安全 🛡️ 的法国 🇫🇷 公司。</p>
<h2 id="zh-about-_2">你们有专业版吗？</h2>
<div class="admonition tip">
<p class="admonition-title">BunkerWeb PRO 免费试用</p>
<p>想要快速测试 BunkerWeb PRO 一个月吗？在 <a href="https://panel.bunkerweb.io/store/bunkerweb-pro?utm_campaign=self&amp;utm_source=doc">BunkerWeb 面板</a>下订单时使用代码 <code>freetrial</code>，或点击<a href="https://panel.bunkerweb.io/cart.php?a=add&amp;pid=19&amp;promocode=freetrial&amp;utm_campaign=self&amp;utm_source=doc">此处</a>直接应用优惠码（将在结账时生效）。</p>
</div>
<p>是的，我们提供名为“BunkerWeb PRO”的专业版本，其中包含额外的功能和（可选的）技术支持。</p>
<p>如果您有任何疑问，请随时<a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">联系我们</a>，我们将非常乐意满足您的需求。</p>
<h2 id="zh-about-_3">你们提供专业服务吗？</h2>
<p>是的，我们提供与 BunkerWeb 相关的专业服务。</p>
<p>您可以通过以下任何方式与我们联系：</p>
<ul>
<li>咨询</li>
<li>支持</li>
<li>定制开发</li>
<li>合作伙伴</li>
</ul>
<p>我们有一个<a href="https://panel.bunkerweb.io/?utm_campaign=self&amp;utm_source=doc">专门的面板</a>来集中处理所有专业请求。</p>
<p>如果您有兴趣，也可以<a href="https://panel.bunkerweb.io/contact.php?utm_campaign=self&amp;utm_source=doc">联系我们</a>。</p>
<h2 id="zh-about-_4">在哪里可以获得社区支持？</h2>
<p>要获得免费的社区支持，您可以使用以下媒介：</p>
<ul>
<li><a href="https://discord.com/invite/fTf46FmtyD">Discord 服务器</a>中的 BunkerWeb 的 #help 频道</li>
<li><a href="https://github.com/bunkerity/bunkerweb/discussions">GitHub discussions</a> 的帮助类别</li>
<li><a href="https://www.reddit.com/r/BunkerWeb">/r/BunkerWeb</a> subreddit</li>
<li><a href="https://serverfault.com/">Server Fault</a> 和 <a href="https://superuser.com/">Super User</a> 论坛</li>
</ul>
<p>请不要使用 <a href="https://github.com/bunkerity/bunkerweb/issues">GitHub issues</a> 来寻求帮助，它仅用于错误报告和功能请求。</p>
<h2 id="zh-about-_5">我如何做出贡献？</h2>
<p>以下是您可以做的一些事情（非详尽列表）：</p>
<ul>
<li>加入 <a href="https://discord.com/invite/fTf46FmtyD">Discord 服务器</a>、<a href="https://www.reddit.com/r/BunkerWeb">/r/BunkerWeb</a> subreddit 和 <a href="https://github.com/bunkerity/bunkerweb/discussions">GitHub discussions</a> 讨论项目并帮助他人</li>
<li>在 <a href="https://www.linkedin.com/company/bunkerity/">LinkedIn</a>、<a href="https://x.com/bunkerity">X (曾用名 Twitter)</a> 和 <a href="https://github.com/bunkerity">GitHub</a> 上关注我们</li>
<li>使用 <a href="https://github.com/bunkerity/bunkerweb/issues">issues</a> 报告错误和提出新功能</li>
<li>使用 <a href="https://github.com/bunkerity/bunkerweb/pulls">pull requests</a> 贡献代码</li>
<li>编写一个很棒的<a href="#zh-plugins">插件</a></li>
<li>向您的朋友/同事、在社交媒体、您的博客等上面谈论 BunkerWeb...</li>
</ul>
<h2 id="zh-about-_6">如何报告安全问题？</h2>
<p>请通过 <a href="mailto:security@bunkerity.com">security@bunkerity.com</a> 联系我们。</p></section></div><style>.print-site-enumerate-headings #zh > h1:before { content: '1 ' }

                .print-site-enumerate-headings #zh h2:before { content: '1.' counter(counter-zh-2) ' ' }
                .print-site-enumerate-headings #zh h2 {  counter-reset: counter-zh-3 ;  counter-increment: counter-zh-2 }
            
                .print-site-enumerate-headings #zh h3:before { content: '1.' counter(counter-zh-2) '.' counter(counter-zh-3) ' ' }
                .print-site-enumerate-headings #zh h3 {  counter-increment: counter-zh-3 }
            
.print-site-enumerate-headings #zh-concepts > h1:before { content: '2 ' }

                .print-site-enumerate-headings #zh-concepts h2:before { content: '2.' counter(counter-zh-concepts-2) ' ' }
                .print-site-enumerate-headings #zh-concepts h2 {  counter-reset: counter-zh-concepts-3 ;  counter-increment: counter-zh-concepts-2 }
            
                .print-site-enumerate-headings #zh-concepts h3:before { content: '2.' counter(counter-zh-concepts-2) '.' counter(counter-zh-concepts-3) ' ' }
                .print-site-enumerate-headings #zh-concepts h3 {  counter-increment: counter-zh-concepts-3 }
            
.print-site-enumerate-headings #zh-integrations > h1:before { content: '3 ' }

                .print-site-enumerate-headings #zh-integrations h2:before { content: '3.' counter(counter-zh-integrations-2) ' ' }
                .print-site-enumerate-headings #zh-integrations h2 {  counter-reset: counter-zh-integrations-3 ;  counter-increment: counter-zh-integrations-2 }
            
                .print-site-enumerate-headings #zh-integrations h3:before { content: '3.' counter(counter-zh-integrations-2) '.' counter(counter-zh-integrations-3) ' ' }
                .print-site-enumerate-headings #zh-integrations h3 {  counter-increment: counter-zh-integrations-3 }
            
.print-site-enumerate-headings #zh-quickstart-guide > h1:before { content: '4 ' }

                .print-site-enumerate-headings #zh-quickstart-guide h2:before { content: '4.' counter(counter-zh-quickstart-guide-2) ' ' }
                .print-site-enumerate-headings #zh-quickstart-guide h2 {  counter-reset: counter-zh-quickstart-guide-3 ;  counter-increment: counter-zh-quickstart-guide-2 }
            
                .print-site-enumerate-headings #zh-quickstart-guide h3:before { content: '4.' counter(counter-zh-quickstart-guide-2) '.' counter(counter-zh-quickstart-guide-3) ' ' }
                .print-site-enumerate-headings #zh-quickstart-guide h3 {  counter-increment: counter-zh-quickstart-guide-3 }
            
.print-site-enumerate-headings #zh-features > h1:before { content: '5 ' }

                .print-site-enumerate-headings #zh-features h2:before { content: '5.' counter(counter-zh-features-2) ' ' }
                .print-site-enumerate-headings #zh-features h2 {  counter-reset: counter-zh-features-3 ;  counter-increment: counter-zh-features-2 }
            
                .print-site-enumerate-headings #zh-features h3:before { content: '5.' counter(counter-zh-features-2) '.' counter(counter-zh-features-3) ' ' }
                .print-site-enumerate-headings #zh-features h3 {  counter-increment: counter-zh-features-3 }
            
.print-site-enumerate-headings #zh-advanced > h1:before { content: '6 ' }

                .print-site-enumerate-headings #zh-advanced h2:before { content: '6.' counter(counter-zh-advanced-2) ' ' }
                .print-site-enumerate-headings #zh-advanced h2 {  counter-reset: counter-zh-advanced-3 ;  counter-increment: counter-zh-advanced-2 }
            
                .print-site-enumerate-headings #zh-advanced h3:before { content: '6.' counter(counter-zh-advanced-2) '.' counter(counter-zh-advanced-3) ' ' }
                .print-site-enumerate-headings #zh-advanced h3 {  counter-increment: counter-zh-advanced-3 }
            
.print-site-enumerate-headings #zh-web-ui > h1:before { content: '7 ' }

                .print-site-enumerate-headings #zh-web-ui h2:before { content: '7.' counter(counter-zh-web-ui-2) ' ' }
                .print-site-enumerate-headings #zh-web-ui h2 {  counter-reset: counter-zh-web-ui-3 ;  counter-increment: counter-zh-web-ui-2 }
            
                .print-site-enumerate-headings #zh-web-ui h3:before { content: '7.' counter(counter-zh-web-ui-2) '.' counter(counter-zh-web-ui-3) ' ' }
                .print-site-enumerate-headings #zh-web-ui h3 {  counter-increment: counter-zh-web-ui-3 }
            
.print-site-enumerate-headings #zh-api > h1:before { content: '8 ' }

                .print-site-enumerate-headings #zh-api h2:before { content: '8.' counter(counter-zh-api-2) ' ' }
                .print-site-enumerate-headings #zh-api h2 {  counter-reset: counter-zh-api-3 ;  counter-increment: counter-zh-api-2 }
            
                .print-site-enumerate-headings #zh-api h3:before { content: '8.' counter(counter-zh-api-2) '.' counter(counter-zh-api-3) ' ' }
                .print-site-enumerate-headings #zh-api h3 {  counter-increment: counter-zh-api-3 }
            
.print-site-enumerate-headings #zh-upgrading > h1:before { content: '9 ' }

                .print-site-enumerate-headings #zh-upgrading h2:before { content: '9.' counter(counter-zh-upgrading-2) ' ' }
                .print-site-enumerate-headings #zh-upgrading h2 {  counter-reset: counter-zh-upgrading-3 ;  counter-increment: counter-zh-upgrading-2 }
            
                .print-site-enumerate-headings #zh-upgrading h3:before { content: '9.' counter(counter-zh-upgrading-2) '.' counter(counter-zh-upgrading-3) ' ' }
                .print-site-enumerate-headings #zh-upgrading h3 {  counter-increment: counter-zh-upgrading-3 }
            
.print-site-enumerate-headings #zh-troubleshooting > h1:before { content: '10 ' }

                .print-site-enumerate-headings #zh-troubleshooting h2:before { content: '10.' counter(counter-zh-troubleshooting-2) ' ' }
                .print-site-enumerate-headings #zh-troubleshooting h2 {  counter-reset: counter-zh-troubleshooting-3 ;  counter-increment: counter-zh-troubleshooting-2 }
            
                .print-site-enumerate-headings #zh-troubleshooting h3:before { content: '10.' counter(counter-zh-troubleshooting-2) '.' counter(counter-zh-troubleshooting-3) ' ' }
                .print-site-enumerate-headings #zh-troubleshooting h3 {  counter-increment: counter-zh-troubleshooting-3 }
            
.print-site-enumerate-headings #zh-plugins > h1:before { content: '11 ' }

                .print-site-enumerate-headings #zh-plugins h2:before { content: '11.' counter(counter-zh-plugins-2) ' ' }
                .print-site-enumerate-headings #zh-plugins h2 {  counter-reset: counter-zh-plugins-3 ;  counter-increment: counter-zh-plugins-2 }
            
                .print-site-enumerate-headings #zh-plugins h3:before { content: '11.' counter(counter-zh-plugins-2) '.' counter(counter-zh-plugins-3) ' ' }
                .print-site-enumerate-headings #zh-plugins h3 {  counter-increment: counter-zh-plugins-3 }
            
.print-site-enumerate-headings #zh-professional-services > h1:before { content: '12 ' }

                .print-site-enumerate-headings #zh-professional-services h2:before { content: '12.' counter(counter-zh-professional-services-2) ' ' }
                .print-site-enumerate-headings #zh-professional-services h2 {  counter-reset: counter-zh-professional-services-3 ;  counter-increment: counter-zh-professional-services-2 }
            
                .print-site-enumerate-headings #zh-professional-services h3:before { content: '12.' counter(counter-zh-professional-services-2) '.' counter(counter-zh-professional-services-3) ' ' }
                .print-site-enumerate-headings #zh-professional-services h3 {  counter-increment: counter-zh-professional-services-3 }
            
.print-site-enumerate-headings #zh-about > h1:before { content: '13 ' }

                .print-site-enumerate-headings #zh-about h2:before { content: '13.' counter(counter-zh-about-2) ' ' }
                .print-site-enumerate-headings #zh-about h2 {  counter-reset: counter-zh-about-3 ;  counter-increment: counter-zh-about-2 }
            
                .print-site-enumerate-headings #zh-about h3:before { content: '13.' counter(counter-zh-about-2) '.' counter(counter-zh-about-3) ' ' }
                .print-site-enumerate-headings #zh-about h3 {  counter-increment: counter-zh-about-3 }
            </style>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; <script>document.write(new Date().getFullYear())</script> Bunkerity
    </div>
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://discord.com/invite/fTf46FmtyD" target="_blank" rel="noopener" title="discord.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/bunkerity" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/company/bunkerity/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.reddit.com/r/BunkerWeb/" target="_blank" rel="noopener" title="www.reddit.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M0 256C0 114.6 114.6 0 256 0s256 114.6 256 256-114.6 256-256 256H37.1c-13.7 0-20.5-16.5-10.9-26.2L75 437C28.7 390.7 0 326.7 0 256m349.6-102.4c23.6 0 42.7-19.1 42.7-42.7s-19.1-42.7-42.7-42.7c-20.6 0-37.8 14.6-41.8 34-34.5 3.7-61.4 33-61.4 68.4v.2c-37.5 1.6-71.8 12.3-99 29.1-10.1-7.8-22.8-12.5-36.5-12.5-33 0-59.8 26.8-59.8 59.8 0 24 14.1 44.6 34.4 54.1 2 69.4 77.6 125.2 170.6 125.2s168.7-55.9 170.6-125.3c20.2-9.6 34.1-30.2 34.1-54 0-33-26.8-59.8-59.8-59.8-13.7 0-26.3 4.6-36.4 12.4-27.4-17-62.1-27.7-100-29.1v-.2c0-25.4 18.9-46.5 43.4-49.9 4.4 18.8 21.3 32.8 41.5 32.8zm-172.5 93.3c16.7 0 29.5 17.6 28.5 39.3s-13.5 29.6-30.3 29.6-31.4-8.8-30.4-30.5S160.3 247 177 247zm190.1 38.3c1 21.7-13.7 30.5-30.4 30.5s-29.3-7.9-30.3-29.6 11.8-39.3 28.5-39.3 31.2 16.6 32.1 38.3zm-48.1 56.7c-10.3 24.6-34.6 41.9-63 41.9s-52.7-17.3-63-41.9c-1.2-2.9.8-6.2 3.9-6.5 18.4-1.9 38.3-2.9 59.1-2.9s40.7 1 59.1 2.9c3.1.3 5.1 3.6 3.9 6.5"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.instagram.com/bunkerweb/" target="_blank" rel="noopener" title="www.instagram.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M224.3 141a115 115 0 1 0-.6 230 115 115 0 1 0 .6-230m-.6 40.4a74.6 74.6 0 1 1 .6 149.2 74.6 74.6 0 1 1-.6-149.2m93.4-45.1a26.8 26.8 0 1 1 53.6 0 26.8 26.8 0 1 1-53.6 0m129.7 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8M399 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://x.com/bunkerity" target="_blank" rel="noopener" title="x.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "/latest", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "toc.integrate", "content.code.copy"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": {"provider": "mike", "version": "latest"}}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
        <script src="../js/print-site.js"></script>
      
        <script src="../js/print-site.js"></script>
      
        <script src="../js/print-site.js"></script>
      
        <script src="../js/print-site.js"></script>
      
        <script src="../assets/extra.js"></script>
      
        <script src="https://chatbot.bunkerweb.io/static/js/chatbot.js"></script>
      
        <script src="../assets/preserve-version-on-language-switch.js"></script>
      
    
  </body>
</html>