不良行为插件通过自动检测并封禁在指定时间段内产生过多错误或“不良”HTTP 状态码的 IP 地址来保护您的网站。这有助于防御暴力破解攻击、网络爬虫、漏洞扫描器以及其他可能产生大量错误响应的恶意活动。

攻击者在探测或利用漏洞时，通常会产生“可疑”的 HTTP 状态码——这些代码是普通用户在给定时间范围内不太可能触发的。通过检测这种行为，BunkerWeb 可以自动封禁违规的 IP 地址，迫使攻击者使用新的 IP 地址才能继续尝试。

**工作原理：**

1.  该插件会监控您网站的 HTTP 响应。
2.  当访问者收到一个“不良”的 HTTP 状态码（例如 400、401、403、404 等）时，该 IP 地址的计数器会增加。
3.  如果一个 IP 地址在指定的时间段内超过了配置的不良状态码阈值，该 IP 将被自动封禁。
4.  根据您的配置，被封禁的 IP 可以在服务级别（仅针对特定站点）或全局级别（跨所有站点）被阻止。
5.  封禁会在配置的封禁持续时间后自动过期，或者如果配置为 `0` 则永久有效。

!!! success "主要优点"

      1. **自动保护：** 自动检测并阻止潜在的恶意客户端，无需人工干预。
      2. **可定制的规则：** 根据您的具体需求，微调构成“不良行为”的定义。
      3. **资源节约：** 防止恶意行为者通过重复的无效请求消耗服务器资源。
      4. **灵活的范围：** 选择封禁是仅适用于当前服务还是全局适用于所有服务。
      5. **封禁持续时间控制：** 设置临时封禁，在配置的持续时间后自动过期，或设置永久封禁，直到手动移除。

### 如何使用

请按照以下步骤配置和使用“不良行为”功能：

1.  **启用该功能：** “不良行为”功能默认启用。如果需要，您可以使用 `USE_BAD_BEHAVIOR` 设置来控制此功能。
2.  **配置状态码：** 使用 `BAD_BEHAVIOR_STATUS_CODES` 设置定义哪些 HTTP 状态码应被视为“不良”。
3.  **设置阈值：** 使用 `BAD_BEHAVIOR_THRESHOLD` 设置确定多少次“不良”响应会触发封禁。
4.  **配置时间段：** 使用 `BAD_BEHAVIOR_COUNT_TIME` 和 `BAD_BEHAVIOR_BAN_TIME` 设置指定计算不良响应的持续时间和封禁持续时间。
5.  **选择封禁范围：** 使用 `BAD_BEHAVIOR_BAN_SCOPE` 设置决定封禁是仅适用于当前服务还是全局适用于所有服务。

!!! tip "流模式"
    在**流模式**下，只有 `444` 状态码被视为“不良”并会触发此行为。

### 配置设置

| 设置                        | 默认值                        | 上下文    | 多个 | 描述                                                                                                                               |
| --------------------------- | ----------------------------- | --------- | ---- | ---------------------------------------------------------------------------------------------------------------------------------- |
| `USE_BAD_BEHAVIOR`          | `yes`                         | multisite | 否   | **启用不良行为检测：** 设置为 `yes` 以启用不良行为检测和封禁功能。                                                                 |
| `BAD_BEHAVIOR_STATUS_CODES` | `400 401 403 404 405 429 444` | multisite | 否   | **不良状态码：** 当返回给客户端时，将被计为“不良”行为的 HTTP 状态码列表。                                                          |
| `BAD_BEHAVIOR_THRESHOLD`    | `10`                          | multisite | 否   | **阈值：** 一个 IP 在计数周期内可以生成的“不良”状态码的数量，超过该数量将被封禁。                                                  |
| `BAD_BEHAVIOR_COUNT_TIME`   | `60`                          | multisite | 否   | **计数周期：** 计算不良状态码以达到阈值的时间窗口（以秒为单位）。                                                                  |
| `BAD_BEHAVIOR_BAN_TIME`     | `86400`                       | multisite | 否   | **封禁持续时间：** 一个 IP 超过阈值后将被封禁的时间（以秒为单位）。默认为 24 小时（86400 秒）。设置为 `0` 表示永不解封的永久封禁。 |
| `BAD_BEHAVIOR_BAN_SCOPE`    | `service`                     | global    | 否   | **封禁范围：** 决定封禁是仅适用于当前服务 (`service`) 还是所有服务 (`global`)。                                                    |

!!! warning "误报"
    在设置阈值和计数时间时要小心。将这些值设置得太低可能会无意中封禁在浏览您网站时遇到错误的合法用户。

!!! tip "调整您的配置"
    从保守的设置开始（更高的阈值，更短的封禁时间），并根据您的具体需求和流量模式进行调整。监控您的日志以确保合法用户不会被错误地封禁。

### 示例配置

=== "默认配置"

    默认配置提供了一种适用于大多数网站的平衡方法：

    ```yaml
    USE_BAD_BEHAVIOR: "yes"
    BAD_BEHAVIOR_STATUS_CODES: "400 401 403 404 405 429 444"
    BAD_BEHAVIOR_THRESHOLD: "10"
    BAD_BEHAVIOR_COUNT_TIME: "60"
    BAD_BEHAVIOR_BAN_TIME: "86400"
    BAD_BEHAVIOR_BAN_SCOPE: "service"
    ```

=== "严格配置"

    对于高安全性应用程序，您希望更积极地封禁潜在威胁：

    ```yaml
    USE_BAD_BEHAVIOR: "yes"
    BAD_BEHAVIOR_STATUS_CODES: "400 401 403 404 405 429 444 500 502 503"
    BAD_BEHAVIOR_THRESHOLD: "5"
    BAD_BEHAVIOR_COUNT_TIME: "120"
    BAD_BEHAVIOR_BAN_TIME: "604800"  # 7 天
    BAD_BEHAVIOR_BAN_SCOPE: "global" # 在所有服务中封禁
    ```

=== "宽松配置"

    对于具有高合法流量且您希望避免误报的网站：

    ```yaml
    USE_BAD_BEHAVIOR: "yes"
    BAD_BEHAVIOR_STATUS_CODES: "401 403 429"  # 仅计算未经授权、禁止和速率受限的请求
    BAD_BEHAVIOR_THRESHOLD: "20"
    BAD_BEHAVIOR_COUNT_TIME: "30"
    BAD_BEHAVIOR_BAN_TIME: "3600"  # 1 小时
    BAD_BEHAVIOR_BAN_SCOPE: "service"
    ```

=== "永久封禁配置"

    对于您希望检测到的攻击者被永久封禁，直到手动解封的情况：

    ```yaml
    USE_BAD_BEHAVIOR: "yes"
    BAD_BEHAVIOR_STATUS_CODES: "400 401 403 404 405 429 444"
    BAD_BEHAVIOR_THRESHOLD: "10"
    BAD_BEHAVIOR_COUNT_TIME: "60"
    BAD_BEHAVIOR_BAN_TIME: "0"  # 永久封禁（永不失效）
    BAD_BEHAVIOR_BAN_SCOPE: "global" # 在所有服务中封禁
    ```
