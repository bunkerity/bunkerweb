杂项插件提供了**必要的基准设置**，有助于维护您网站的安全性和功能性。这个核心组件提供了全面的控制，包括：

- **服务器行为** - 配置您的服务器如何响应各种请求
- **HTTP 设置** - 管理方法、请求大小和协议选项
- **文件管理** - 控制静态文件的提供并优化交付
- **协议支持** - 启用现代 HTTP 协议以获得更好的性能
- **系统配置** - 扩展功能并提高安全性

无论您是需要限制 HTTP 方法、管理请求大小、优化文件缓存，还是控制服务器如何响应各种请求，此插件都为您提供了**微调 Web 服务行为**的工具，同时优化了性能和安全性。

### 主要功能

| 功能类别           | 描述                                                                  |
| ------------------ | --------------------------------------------------------------------- |
| **HTTP 方法控制**  | 定义您的应用程序可接受哪些 HTTP 方法                                  |
| **默认服务器保护** | 防止通过主机名不匹配进行未经授权的访问，并强制使用 SNI 以确保安全连接 |
| **请求大小管理**   | 为客户端请求体和文件上传设置限制                                      |
| **静态文件服务**   | 配置和优化从自定义根文件夹交付静态内容                                |
| **文件缓存**       | 通过具有可自定义设置的高级文件描述符缓存机制提高性能                  |
| **协议支持**       | 配置现代 HTTP 协议选项 (HTTP2/HTTP3) 和 Alt-Svc 端口设置              |
| **匿名报告**       | 可选的使用统计报告，以帮助改进 BunkerWeb                              |
| **外部插件支持**   | 通过 URL 集成外部插件来扩展功能                                       |
| **HTTP 状态控制**  | 配置您的服务器在拒绝请求时的响应方式（包括终止连接）                  |

### 配置指南

=== "默认服务器安全"

    **默认服务器控制**

    在 HTTP 中，`Host` 标头指定目标服务器，但它可能缺失或未知，这通常是由于机器人扫描漏洞造成的。

    要阻止此类请求：

    -   将 `DISABLE_DEFAULT_SERVER` 设置为 `yes`，以使用 [NGINX 的 `444` 状态码](https://http.dev/444) 静默拒绝此类请求。
    -   为了更严格的安全性，启用 `DISABLE_DEFAULT_SERVER_STRICT_SNI` 以拒绝没有有效 SNI 的 SSL/TLS 连接。

    !!! success "安全优势"
        - 阻止 Host 标头操纵和虚拟主机扫描
        - 减轻 HTTP 请求走私风险
        - 移除默认服务器作为攻击媒介

    | 设置                                | 默认值 | 上下文 | 多选 | 描述                                                                                   |
    | ----------------------------------- | ------ | ------ | ---- | -------------------------------------------------------------------------------------- |
    | `DISABLE_DEFAULT_SERVER`            | `no`   | global | no   | **默认服务器：** 设置为 `yes` 以在没有主机名与请求匹配时禁用默认服务器。               |
    | `DISABLE_DEFAULT_SERVER_STRICT_SNI` | `no`   | global | no   | **严格 SNI：** 当设置为 `yes` 时，要求 HTTPS 连接使用 SNI，并拒绝没有有效 SNI 的连接。 |

    !!! warning "SNI 强制执行"
        启用严格的 SNI 验证可提供更强的安全性，但如果 BunkerWeb 位于一个转发 HTTPS 请求但未保留 SNI 信息的反向代理之后，可能会导致问题。在生产环境中启用之前请进行彻底测试。

=== "拒绝 HTTP 状态"

    **HTTP 状态控制**

    处理被拒绝的客户端访问的第一步是定义适当的操作。这可以使用 `DENY_HTTP_STATUS` 设置进行配置。当 BunkerWeb 拒绝一个请求时，您可以使用此设置控制其响应。默认情况下，它返回一个 `403 Forbidden` 状态，并向客户端显示一个网页或自定义内容。

    或者，将其设置为 `444` 会立即关闭连接而不发送任何响应。这个[非标准状态码](https://http.dev/444)，特定于 NGINX，对于静默丢弃不需要的请求很有用。

    | 设置               | 默认值 | 上下文 | 多选 | 描述                                                                                     |
    | ------------------ | ------ | ------ | ---- | ---------------------------------------------------------------------------------------- |
    | `DENY_HTTP_STATUS` | `403`  | global | no   | **拒绝 HTTP 状态：** 请求被拒绝时发送的 HTTP 状态码（403 或 444）。代码 444 会关闭连接。 |

    !!! warning "444 状态码的注意事项"
        由于客户端收不到任何反馈，故障排查可能会更具挑战性。只有在您已彻底解决误报问题、对 BunkerWeb 有丰富经验并需要更高安全级别时，才建议设置为 `444`。

    !!! info "流模式"
        在**流模式**下，此设置始终强制为 `444`，这意味着无论配置的值如何，连接都将被关闭。

=== "HTTP 方法"

    **HTTP 方法控制**

    将 HTTP 方法限制为应用程序所需的那些方法，是遵循最小权限原则的一项基本安全措施。通过明确定义可接受的 HTTP 方法，您可以最大限度地降低通过未使用或危险的方法被利用的风险。

    此功能使用 `ALLOWED_METHODS` 设置进行配置，其中方法用 `|` 分隔（默认值：`GET|POST|HEAD`）。如果客户端尝试使用未列出的方法，服务器将以 **405 - Method Not Allowed** 状态响应。

    对于大多数网站，默认的 `GET|POST|HEAD` 就足够了。如果您的应用程序使用 RESTful API，您可能需要包含 `PUT` 和 `DELETE` 等方法。

    !!! success "安全优势"
        - 防止利用未使用或不必要的 HTTP 方法
        - 通过禁用可能有害的方法来减少攻击面
        - 阻止攻击者使用的 HTTP 方法枚举技术

    | 设置              | 默认值            | 上下文    | 多选 | 描述                                                   |
    | ----------------- | ----------------- | --------- | ---- | ------------------------------------------------------ |
    | `ALLOWED_METHODS` | `GET\|POST\|HEAD` | multisite | no   | **HTTP 方法：** 允许的 HTTP 方法列表，用竖线字符分隔。 |

    !!! abstract "CORS 和预检请求"
        如果您的应用程序支持[跨源资源共享 (CORS)](#cors)，您应该在 `ALLOWED_METHODS` 设置中包含 `OPTIONS` 方法以处理预检请求。这确保了浏览器发出跨源请求时的正常功能。

    !!! danger "安全注意事项"
        - **避免启用 `TRACE` 或 `CONNECT`：** 这些方法很少需要，并且可能引入重大的安全风险，例如启用跨站跟踪 (XST) 或隧道攻击。
        - **定期审查允许的方法：** 定期审核 `ALLOWED_METHODS` 设置，以确保其与您应用程序的当前要求保持一致。
        - **部署前进行彻底测试：** 对 HTTP 方法限制的更改可能会影响应用程序功能。在将其应用于生产环境之前，请在预演环境中验证您的配置。

=== "请求大小限制"

    **请求大小限制**

    最大请求体大小可以使用 `MAX_CLIENT_SIZE` 设置进行控制（默认值：`10m`）。接受的值遵循[此处](https://nginx.org/en/docs/syntax.html)描述的语法。

    !!! success "安全优势"
        - 防止由过大负载大小引起的拒绝服务攻击
        - 减轻缓冲区溢出漏洞
        - 防止文件上传攻击
        - 降低服务器资源耗尽的风险

    | 设置              | 默认值 | 上下文    | 多选 | 描述                                                            |
    | ----------------- | ------ | --------- | ---- | --------------------------------------------------------------- |
    | `MAX_CLIENT_SIZE` | `10m`  | multisite | no   | **最大请求大小：** 客户端请求体（例如文件上传）允许的最大大小。 |

    !!! tip "请求大小配置最佳实践"
        如果您需要允许无限大小的请求体，可以将 `MAX_CLIENT_SIZE` 的值设置为 `0`。但是，由于潜在的安全和性能风险，**不推荐**这样做。

        **最佳实践：**

        - 始终将 `MAX_CLIENT_SIZE` 配置为满足您应用程序合法要求的最小值。
        - 定期审查和调整此设置，以适应您应用程序不断变化的需求。
        - 除非绝对必要，否则避免设置为 `0`，因为它可能使您的服务器面临拒绝服务攻击和资源耗尽的风险。

        通过仔细管理此设置，您可以确保应用程序的最佳安全性和性能。

=== "协议支持"

    **HTTP 协议设置**

    像 HTTP/2 和 HTTP/3 这样的现代 HTTP 协议可以提高性能和安全性。BunkerWeb 允许轻松配置这些协议。

    !!! success "安全和性能优势"
        - **安全优势：** 像 HTTP/2 和 HTTP/3 这样的现代协议默认强制使用 TLS/HTTPS，减少了对某些攻击的易感性，并通过加密头（HTTP/3）提高了隐私性。
        - **性能优势：** 多路复用、头部压缩、服务器推送和二进制数据传输等功能提高了速度和效率。

    | 设置                 | 默认值 | 上下文    | 多选 | 描述                                                           |
    | -------------------- | ------ | --------- | ---- | -------------------------------------------------------------- |
    | `LISTEN_HTTP`        | `yes`  | multisite | no   | **HTTP 监听：** 当设置为 `yes` 时，响应（不安全的）HTTP 请求。 |
    | `HTTP2`              | `yes`  | multisite | no   | **HTTP2：** 当启用 HTTPS 时，支持 HTTP2 协议。                 |
    | `HTTP3`              | `yes`  | multisite | no   | **HTTP3：** 当启用 HTTPS 时，支持 HTTP3 协议。                 |
    | `HTTP3_ALT_SVC_PORT` | `443`  | multisite | no   | **HTTP3 Alt-Svc 端口：** 在 Alt-Svc 标头中用于 HTTP3 的端口。  |

    !!! example "关于 HTTP/3"
        HTTP/3 是超文本传输协议的最新版本，它使用 QUIC over UDP 而不是 TCP，解决了诸如队头阻塞等问题，以实现更快、更可靠的连接。

        NGINX 从 1.25.0 版本开始引入了对 HTTP/3 和 QUIC 的实验性支持。但是，此功能仍处于实验阶段，建议在生产中使用时保持谨慎。更多详情，请参阅 [NGINX 的官方文档](https://nginx.org/en/docs/quic.html)。

        建议在生产环境中启用 HTTP/3 之前进行彻底测试。

=== "静态文件服务"

    **文件服务配置**

    BunkerWeb 可以直接提供静态文件，也可以作为应用程序服务器的反向代理。默认情况下，文件从 `/var/www/html/{server_name}` 提供。

    | 设置          | 默认值                        | 上下文    | 多选 | 描述                                                                         |
    | ------------- | ----------------------------- | --------- | ---- | ---------------------------------------------------------------------------- |
    | `SERVE_FILES` | `yes`                         | multisite | no   | **提供文件：** 当设置为 `yes` 时，BunkerWeb 将从配置的根文件夹提供静态文件。 |
    | `ROOT_FOLDER` | `/var/www/html/{server_name}` | multisite | no   | **根文件夹：** 提供静态文件的目录。为空表示使用默认位置。                    |

    !!! tip "静态文件服务最佳实践"
        - **直接服务：** 当 BunkerWeb 负责直接提供静态文件时，启用文件服务 (`SERVE_FILES=yes`)。
        - **反向代理：** 如果 BunkerWeb 作为反向代理，**停用文件服务** (`SERVE_FILES=no`) 以减少攻击面并避免暴露不必要的目录。
        - **权限：** 确保正确的文件权限和路径配置，以防止未经授权的访问。
        - **安全：** 避免因配置不当而暴露敏感目录或文件。

        通过仔细管理静态文件服务，您可以在保持安全环境的同时优化性能。

=== "系统设置"

    **插件和系统管理**

    这些设置管理 BunkerWeb 与外部系统的交互，并通过可选的匿名使用统计信息为改进产品做出贡献。

    **匿名报告**

    匿名报告为 BunkerWeb 团队提供了有关软件使用情况的见解。这有助于确定需要改进的领域并优先开发功能。报告严格是统计性的，不包含任何敏感或个人可识别信息。它们涵盖：

    - 启用的功能
    - 通用配置模式

    如果您愿意，可以通过将 `SEND_ANONYMOUS_REPORT` 设置为 `no` 来禁用此功能。

    **外部插件**

    外部插件使您能够通过集成第三方模块来扩展 BunkerWeb 的功能。这允许进行额外的定制和高级用例。

    !!! danger "外部插件安全"
        **如果未经适当审查，外部插件可能会引入安全风险。** 请遵循以下最佳实践以最大限度地减少潜在威胁：

        - 仅使用来自可信来源的插件。
        - 在可用时使用校验和验证插件的完整性。
        - 定期审查和更新插件以确保安全性和兼容性。

        更多详情，请参阅[插件文档](plugins.md)。

    | 设置                    | 默认值 | 上下文 | 多选 | 描述                                                  |
    | ----------------------- | ------ | ------ | ---- | ----------------------------------------------------- |
    | `SEND_ANONYMOUS_REPORT` | `yes`  | global | no   | **匿名报告：** 向 BunkerWeb 维护者发送匿名使用报告。  |
    | `EXTERNAL_PLUGIN_URLS`  |        | global | no   | **外部插件：** 用于下载外部插件的 URL（以空格分隔）。 |

=== "文件缓存"

    **文件缓存优化**

    打开文件缓存通过在内存中存储文件描述符和元数据来提高性能，减少了重复文件系统操作的需求。

    !!! success "文件缓存的好处"
        - **性能：** 减少文件系统 I/O，降低延迟，并降低文件操作的 CPU 使用率。
        - **安全：** 通过缓存错误响应来减轻时序攻击，并减少针对文件系统的 DoS 攻击的影响。

    | 设置                       | 默认值                  | 上下文    | 多选 | 描述                                                              |
    | -------------------------- | ----------------------- | --------- | ---- | ----------------------------------------------------------------- |
    | `USE_OPEN_FILE_CACHE`      | `no`                    | multisite | no   | **启用缓存：** 启用文件描述符和元数据的缓存以提高性能。           |
    | `OPEN_FILE_CACHE`          | `max=1000 inactive=20s` | multisite | no   | **缓存配置：** 配置打开文件缓存（例如，最大条目数和非活动超时）。 |
    | `OPEN_FILE_CACHE_ERRORS`   | `yes`                   | multisite | no   | **缓存错误：** 缓存文件描述符查找错误以及成功查找。               |
    | `OPEN_FILE_CACHE_MIN_USES` | `2`                     | multisite | no   | **最少使用次数：** 在非活动期间，文件保持缓存所需的最少访问次数。 |
    | `OPEN_FILE_CACHE_VALID`    | `30s`                   | multisite | no   | **缓存有效期：** 缓存元素重新验证的时间。                         |

    **配置指南**

    要启用和配置文件缓存：
    1.  将 `USE_OPEN_FILE_CACHE` 设置为 `yes` 以激活该功能。
    2.  调整 `OPEN_FILE_CACHE` 参数以定义缓存条目的最大数量及其非活动超时。
    3.  使用 `OPEN_FILE_CACHE_ERRORS` 缓存成功和失败的查找，以减少重复的文件系统操作。
    4.  设置 `OPEN_FILE_CACHE_MIN_USES` 以指定文件保持缓存所需的最少访问次数。
    5.  使用 `OPEN_FILE_CACHE_VALID` 定义缓存有效期，以控制缓存元素的重新验证频率。

    !!! tip "最佳实践"
        - 为具有大量静态文件的网站启用文件缓存以提高性能。
        - 定期审查和微调缓存设置，以平衡性能和资源使用。
        - 在文件频繁更改的动态环境中，考虑缩短缓存有效期或禁用该功能以确保内容新鲜度。

### 配置示例

=== "默认服务器安全"

    禁用默认服务器并强制执行严格 SNI 的示例配置：

    ```yaml
    DISABLE_DEFAULT_SERVER: "yes"
    DISABLE_DEFAULT_SERVER_STRICT_SNI: "yes"
    ```

=== "拒绝 HTTP 状态"

    静默丢弃不需要的请求的示例配置：

    ```yaml
    DENY_HTTP_STATUS: "444"
    ```

=== "HTTP 方法"

    将 HTTP 方法限制为 RESTful API 所需方法的示例配置：

    ```yaml
    ALLOWED_METHODS: "GET|POST|PUT|DELETE"
    ```

=== "请求大小限制"

    限制最大请求体大小的示例配置：

    ```yaml
    MAX_CLIENT_SIZE: "5m"
    ```

=== "协议支持"

    启用 HTTP/2 和 HTTP/3 并使用自定义 Alt-Svc 端口的示例配置：

    ```yaml
    HTTP2: "yes"
    HTTP3: "yes"
    HTTP3_ALT_SVC_PORT: "443"
    ```

=== "静态文件服务"

    从自定义根文件夹提供静态文件的示例配置：

    ```yaml
    SERVE_FILES: "yes"
    ROOT_FOLDER: "/var/www/custom-folder"
    ```

=== "文件缓存"

    启用和优化文件缓存的示例配置：

    ```yaml
    USE_OPEN_FILE_CACHE: "yes"
    OPEN_FILE_CACHE: "max=2000 inactive=30s"
    OPEN_FILE_CACHE_ERRORS: "yes"
    OPEN_FILE_CACHE_MIN_USES: "3"
    OPEN_FILE_CACHE_VALID: "60s"
    ```
