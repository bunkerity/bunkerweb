{% if USE_MTLS == "yes" %}
	{%- set pathlib = import("pathlib") -%}
	{%- set ns = namespace(enable=true, ca_loaded=false) -%}
	{%- set verify_mode = MTLS_VERIFY_CLIENT -%}
	{%- set ca_bundle_value = MTLS_CA_CERTIFICATE | trim -%}
	{% if ca_bundle_value != "" %}
		{% with ca_bundle_path = pathlib.Path(ca_bundle_value) %}
			{% if ca_bundle_path.is_file() %}
ssl_client_certificate {{ ca_bundle_value }};
ssl_trusted_certificate {{ ca_bundle_value }};
				{% set ns.ca_loaded = true %}
			{% else %}
# mTLS disabled for this server: CA bundle not found at {{ ca_bundle_value }}.
				{% if verify_mode != "optional_no_ca" %}
					{% set ns.enable = false %}
				{% endif %}
			{% endif %}
		{% endwith %}
	{% elif verify_mode != "optional_no_ca" %}
# mTLS disabled for this server: CA bundle path is required when verify mode is {{ verify_mode }}.
		{% set ns.enable = false %}
	{% endif %}

	{%- set crl_value = MTLS_CRL | trim -%}
	{% if ns.ca_loaded and crl_value != "" %}
		{% with crl_path = pathlib.Path(crl_value) %}
			{% if crl_path.is_file() %}
ssl_crl {{ crl_value }};
			{% else %}
# Ignoring MTLS_CRL because file not found at {{ crl_value }}.
			{% endif %}
		{% endwith %}
	{% endif %}

	{% if ns.enable %}
ssl_verify_client {{ verify_mode }};
ssl_verify_depth {{ MTLS_VERIFY_DEPTH }};
	{% endif %}
{% endif %}
